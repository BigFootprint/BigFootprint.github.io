<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[AIDL åŸç†åˆ†æ]]></title>
      <url>http://www.timebridge.space/2017/10/30/AIDL-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[App å¯åŠ¨è¿‡ç¨‹]]></title>
      <url>http://www.timebridge.space/2017/10/30/App-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[PMS è§£æ]]></title>
      <url>http://www.timebridge.space/2017/10/29/PMS-%E8%A7%A3%E6%9E%90/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[WindowManagerService è§£æ]]></title>
      <url>http://www.timebridge.space/2017/10/29/WMS-%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>åœ¨å¦å¤–ä¸€ç¯‡æ–‡ç«  <a href="http://timebridge.space/2016/09/21/Android-view-display/" target="_blank" rel="noopener">Android View ç»˜åˆ¶è¿‡ç¨‹</a> ä¸­å·²ç»æåˆ°ä¸€ä¸ªå…³äº Window çš„æ¦‚å¿µäº†â€”â€” PhoneWindowï¼Œåªä¸è¿‡è¿™ç¯‡ç€é‡æ˜¯ä» PhoneWindow å¾€ View æ–¹å‘è®²ï¼Œå…³äº PhoneWindow æœ¬èº«å…³æ³¨çš„å¾ˆå°‘ï¼Œè¿™ä¸€ç¯‡å°±æ¢ç©¶ä¸€ä¸‹ Window ä»¥åŠ WindowManagerServiceã€‚</p>
<p>åœ¨ Android é‡Œé¢ï¼ŒWindow æ˜¯ä¸€ä¸ªéå¸¸é‡è¦ä½†å…¶å®å¹³æ—¶å¼€å‘åˆä¸å¸¸ç”¨çš„æ¦‚å¿µã€‚å¤§éƒ¨åˆ†çœ‹åˆ°å®ƒæ—¶å¯èƒ½æ˜¯æˆ‘ä»¬è¦ä¿®æ”¹ Dialog çš„æ ·å¼çš„æ—¶å€™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mDialog = <span class="keyword">new</span> Dialog(getActivity(), R.style.IsDelDialog);<span class="comment">//è‡ªå®šä¹‰çš„æ ·å¼ï¼Œæ²¡æœ‰è´´å‡ºä»£ç æ¥</span></span><br><span class="line">mDialog.setContentView(view);</span><br><span class="line">mDialog.show();</span><br><span class="line">Window dialogWindow = mDialog.getWindow();</span><br><span class="line">WindowManager m = getActivity().getWindowManager();</span><br><span class="line">Display d = m.getDefaultDisplay(); <span class="comment">// è·å–å±å¹•å®½ã€é«˜åº¦</span></span><br><span class="line">WindowManager.LayoutParams p = dialogWindow.getAttributes(); <span class="comment">// è·å–å¯¹è¯æ¡†å½“å‰çš„å‚æ•°å€¼</span></span><br><span class="line">        p.height = (<span class="keyword">int</span>) (d.getHeight() * <span class="number">0.8</span>); <span class="comment">// é«˜åº¦è®¾ç½®ä¸ºå±å¹•çš„0.6ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´</span></span><br><span class="line">p.width = (<span class="keyword">int</span>) (d.getWidth() * <span class="number">0.8</span>); <span class="comment">// å®½åº¦è®¾ç½®ä¸ºå±å¹•çš„0.65ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´</span></span><br><span class="line">dialogWindow.setAttributes(p);</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ Window æœ¬è´¨ä¸Šåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ Activity çš„åº•å±‚ä»¥åŠ Dialog éƒ½ä¸å®ƒç›¸å…³ï¼Ÿ</p>
<h2 id="Window-æ¦‚è§ˆ"><a href="#Window-æ¦‚è§ˆ" class="headerlink" title="Window æ¦‚è§ˆ"></a>Window æ¦‚è§ˆ</h2><p>Window çš„ä»£ç å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Abstract base class for a top-level window look and behavior policy.  An</span></span><br><span class="line"><span class="comment"> * instance of this class should be used as the top-level view added to the</span></span><br><span class="line"><span class="comment"> * window manager. It provides standard UI policies such as a background, title</span></span><br><span class="line"><span class="comment"> * area, default key processing, etc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The only existing implementation of this abstract class is</span></span><br><span class="line"><span class="comment"> * android.view.PhoneWindow, which you should instantiate when needing a</span></span><br><span class="line"><span class="comment"> * Window.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä»¥ä¸Šä»£ç å¯ä»¥å¾—å‡ºä»¥ä¸‹å‡ ä¸ªç»“è®ºï¼š</p>
<p>1ï¼‰Window è´Ÿè´£ä¸€äº›æ ‡å‡†çš„å±•ç¤ºä»¥åŠäº‹ä»¶å¤„ç†ï¼Œæœ€ç»ˆçš„ç”¨æ³•æ˜¯æ·»åŠ åˆ° WindowManagerï¼›</p>
<p>2ï¼‰å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œå°±æ˜¯ PhoneWindowï¼›</p>
<p>å…³äº PhoneWindow åœ¨åšäº›å•¥ï¼Œ<a href="http://timebridge.space/2016/09/21/Android-view-display/" target="_blank" rel="noopener">Android View ç»˜åˆ¶è¿‡ç¨‹</a> å·²ç»æœ‰è®²è¿°ï¼Œæˆ‘ä»¬å»çœ‹çœ‹ WindowManagerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The interface that apps use to talk to the window manager.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Use &lt;code&gt;Context.getSystemService(Context.WINDOW_SERVICE)&lt;/code&gt; to get one of these.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Each window manager instance is bound to a particular &#123;<span class="doctag">@link</span> Display&#125;.</span></span><br><span class="line"><span class="comment"> * To obtain a &#123;<span class="doctag">@link</span> WindowManager&#125; for a different display, use</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Context#createDisplayContext&#125; to obtain a &#123;<span class="doctag">@link</span> Context&#125; for that</span></span><br><span class="line"><span class="comment"> * display, then use &lt;code&gt;Context.getSystemService(Context.WINDOW_SERVICE)&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * to get the WindowManager.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The simplest way to show a window on another display is to create a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Presentation&#125;.  The presentation will automatically obtain a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> WindowManager&#125; and &#123;<span class="doctag">@link</span> Context&#125; for that display.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> android.content.Context#getSystemService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> android.content.Context#WINDOW_SERVICE</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WindowManager</span> <span class="keyword">extends</span> <span class="title">ViewManager</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WindowManager å¯ä»¥é€šè¿‡ <code>getSystemService(Context.WINDOW_SERVICE)</code> æ¥è·å–ï¼Œæ¯ä¸€ä¸ª WindowMagaer éƒ½è¢«ç»‘å®šåˆ°ä¸€ä¸ªç‰¹æ€§çš„ <code>Display</code> å®ä¾‹ã€‚</p>
<blockquote>
<p>è¿™é‡Œæ¶‰åŠåˆ° Context çš„è§£æï¼Œå¾…è¡¥å……ã€‚</p>
</blockquote>
<p><code>WindowManager</code>æ¥å£ç»§æ‰¿äº<code>ViewManager</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£åªæœ‰ä¸‰ä¸ªç®€å•çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸‰ä¸ªæ–¹æ³•ä»£è¡¨äº†å¯¹ View çš„åŸºæœ¬æ“ä½œï¼ŒæŸ¥çœ‹è¿™ä¸ªæ¥å£çš„å®ç°ï¼Œè¯»è€…ä¼šå‘ç°é™¤äº† WindowManagerï¼Œè¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å®ç°ç±»ï¼šViewGroupã€‚è¿™ä¼¼ä¹æš—ç¤ºäº† WindowManager å’Œ ViewGroup ä¹‹é—´æ˜¯æœ‰ä¸€äº›è”ç³»çš„ã€‚</p>
<h2 id="Dialog-ä¸-Window"><a href="#Dialog-ä¸-Window" class="headerlink" title="Dialog ä¸ Window"></a>Dialog ä¸ Window</h2><p>ä¸ºäº†ææ¸…æ¥š Window ç›¸å…³æ¦‚å¿µçš„å…³ç³»ï¼Œæˆ‘ä»¬é€‰æ‹©ä» Dialog å…¥æ‰‹ï¼Œçœ‹çœ‹ Window æ˜¯å¦‚ä½•å±•ç¤ºä¸€ä¸ª Dialog çš„ã€‚Dialog çš„ç”¨æ³•ä¸€èˆ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">AlertDialog ad = <span class="keyword">new</span> AlertDialog.Builder(MainActivity.<span class="keyword">this</span>).create();  </span><br><span class="line">ad.setTitle(<span class="string">"æ ‡é¢˜1"</span>);  </span><br><span class="line">ad.setIcon(R.drawable.ic_launcher);  </span><br><span class="line">ad.setMessage(<span class="string">"æˆ‘æ˜¯æ¶ˆæ¯å†…å®¹"</span>);  </span><br><span class="line">ad.setButton(<span class="string">"ç¡®å®š"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123; </span><br><span class="line">	<span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123; </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);  </span><br><span class="line">ad.setButton2(<span class="string">"å–æ¶ˆ"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;    </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);  </span><br><span class="line">ad.show();</span><br></pre></td></tr></table></figure>
<p>æœ€å…³é”®çš„æ–¹æ³•å°±æ˜¯ <code>show()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mShowing) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDecor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mWindow.hasFeature(Window.FEATURE_ACTION_BAR)) &#123;</span><br><span class="line">                mWindow.invalidatePanelMenu(Window.FEATURE_ACTION_BAR);</span><br><span class="line">            &#125;</span><br><span class="line">            mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCanceled = <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!mCreated) &#123;</span><br><span class="line">        dispatchOnCreate(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onStart();</span><br><span class="line">    mDecor = mWindow.getDecorView(); <span class="comment">// mDecor çš„æ¥æº</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mWindowManager.addView(mDecor, l);</span><br><span class="line">        mShowing = <span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line">        sendShowMessage();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆçš„å±•ç¤ºæ˜¯é€šè¿‡<code>mWindowManager.addView(mDecor, l);</code>æ¥å®Œæˆçš„ï¼Œè¿™ä¸€å¥åˆ°åº•åšäº†å•¥å‘¢ï¼Ÿåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€äº›ç†Ÿæ‚‰çš„é¢å­”ï¼šmWindowï¼ŒmWindowManagerï¼ŒmDecorï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒä»¬çš„æ¥æºã€‚mDecor æ˜¯ä» mWindow ä¸­æ‹¿å‡ºæ¥çš„ï¼ŒmWindow å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Dialog(<span class="meta">@NonNull</span> Context context, <span class="meta">@StyleRes</span> <span class="keyword">int</span> themeResId, <span class="keyword">boolean</span> createContextThemeWrapper) &#123;</span><br><span class="line">    <span class="keyword">if</span> (createContextThemeWrapper) &#123;</span><br><span class="line">        <span class="keyword">if</span> (themeResId == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> TypedValue outValue = <span class="keyword">new</span> TypedValue();</span><br><span class="line">            context.getTheme().resolveAttribute(R.attr.dialogTheme, outValue, <span class="keyword">true</span>);</span><br><span class="line">            themeResId = outValue.resourceId;</span><br><span class="line">        &#125;</span><br><span class="line">        mContext = <span class="keyword">new</span> ContextThemeWrapper(context, themeResId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE); <span class="comment">// mWindow </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Window w = <span class="keyword">new</span> PhoneWindow(mContext);</span><br><span class="line">    mWindow = w;</span><br><span class="line">    w.setCallback(<span class="keyword">this</span>);</span><br><span class="line">    w.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">    w.setWindowManager(mWindowManager, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    w.setGravity(Gravity.CENTER);</span><br><span class="line"></span><br><span class="line">    mListenersHandler = <span class="keyword">new</span> ListenersHandler(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Dialog çš„æ„é€ æ–¹æ³•é‡Œé¢ï¼Œè¿™ä¸¤ä¸ªå˜é‡è¢«å®ä¾‹åŒ–ï¼Œé¦–å…ˆæ˜¯æ ¹æ® context è·å– WindowManagerï¼Œè€Œ mWindow å®é™…å°±æ˜¯ PhoneWindow çš„å®ä¾‹ã€‚é‚£ä¹ˆ <code>WindowManager</code> åˆæ˜¯å¦‚ä½•æ·»åŠ  view çš„å‘¢ï¼Œå³ <code>mWindowManager.addView(mDecor, l);</code> æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Ÿ</p>
<p>mWindowManager çš„å®ç°ç±»æ˜¯è°å‘¢ï¼Ÿå®ƒæ˜¯é€šè¿‡ <code>context.getSystemService()</code>è·å–çš„ï¼Œå®ƒçš„æ³¨å†Œæ˜¯åœ¨<code>android.app.SystemServiceRegistry#registerService</code>ä¸­è¿›è¡Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">registerService(Context.WINDOW_SERVICE, WindowManager.class,</span><br><span class="line">                <span class="keyword">new</span> CachedServiceFetcher&lt;WindowManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> WindowManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(ctx.getDisplay());</span><br><span class="line">&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p>å› æ­¤è¿™é‡Œçš„å®ç°ç±»æ˜¯<code>WindowManagerImpl</code>ï¼Œå¹¶ä¸”åœ¨åˆ›å»ºçš„æ—¶å€™æ˜¯é€šè¿‡ context è·å–åˆ°äº† displayã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ç±» <code>WindowManagerImpl</code> çš„ <code>addView</code> æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">     applyDefaultToken(params);</span><br><span class="line">     mGlobal.addView(view, params, mDisplay, mParentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•è¢«ä»£ç†åˆ°äº† <code>WindowManagerGlobal</code> ç±»é‡Œé¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//... å‚æ•°æ£€æŸ¥ &amp; è°ƒæ•´</span></span><br><span class="line"></span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// do this last because it fires off messages to start doing things</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        root.setView(view, wparams, panelParentView);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„æ ¸å¿ƒæ–¹æ³•è¢«ä»£ç†åˆ°äº† <code>ViewRootImpl#setView()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * view æ˜¯å‰é¢ Window çš„ decorView</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mView = view;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> res; <span class="comment">/* = WindowManagerImpl.ADD_OKAY; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Schedule the first layout -before- adding to the window</span></span><br><span class="line">    <span class="comment">// manager, to make sure we do the relayout before receiving</span></span><br><span class="line">    <span class="comment">// any other events from the system.</span></span><br><span class="line">    requestLayout();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•ç”¨äºæ·»åŠ å±•ç¤ºï¼Œæ³¨æ„ mDisplay å°±æ˜¯ activity çš„ display</span></span><br><span class="line">    res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                            getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                            mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                            mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">    ...                             </span><br><span class="line">    <span class="keyword">if</span> (res &lt; WindowManagerGlobal.ADD_OKAY) &#123;</span><br><span class="line">        mAttachInfo.mRootView = <span class="keyword">null</span>;</span><br><span class="line">        mAdded = <span class="keyword">false</span>;</span><br><span class="line">        mFallbackEventHandler.setView(<span class="keyword">null</span>);</span><br><span class="line">        unscheduleTraversals();</span><br><span class="line">        setAccessibilityFocus(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">switch</span> (res) &#123;</span><br><span class="line">            <span class="keyword">case</span> WindowManagerGlobal.ADD_BAD_APP_TOKEN:</span><br><span class="line">            <span class="keyword">case</span> WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                        <span class="string">"Unable to add window -- token "</span> + attrs.token</span><br><span class="line">                        + <span class="string">" is not valid; is your activity running?"</span>);</span><br><span class="line">            <span class="keyword">case</span> WindowManagerGlobal.ADD_NOT_APP_TOKEN:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                        <span class="string">"Unable to add window -- token "</span> + attrs.token</span><br><span class="line">                        + <span class="string">" is not for an application"</span>);   </span><br><span class="line">            .....</span><br><span class="line">          &#125;                          </span><br><span class="line">     ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†å¾€ä¸‹å¾ˆé‡è¦çš„å°±æ˜¯ mWindowSession å˜é‡çš„æ¥æºäº†ï¼Œå®ƒæ¥è‡ª<code>WindowManagerGlobal#getWindowSession()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title">getWindowSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                InputMethodManager imm = InputMethodManager.getInstance();</span><br><span class="line">                IWindowManager windowManager = getWindowManagerService();</span><br><span class="line">                sWindowSession = windowManager.openSession(</span><br><span class="line">                        <span class="keyword">new</span> IWindowSessionCallback.Stub() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimatorScaleChanged</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">                                ValueAnimator.setDurationScale(scale);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        imm.getClient(), imm.getInputContext());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"Failed to open window session"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowSession;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowManager <span class="title">getWindowManagerService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWindowManagerService == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sWindowManagerService = IWindowManager.Stub.asInterface(</span><br><span class="line">                    ServiceManager.getService(<span class="string">"window"</span>));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sWindowManagerService = getWindowManagerService();</span><br><span class="line">                ValueAnimator.setDurationScale(sWindowManagerService.getCurrentAnimatorScale());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"Failed to get WindowManagerService, cannot set animator scale"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWindowManagerService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†å¾€ä¸‹èµ°å°±æ˜¯<code>WindowManagerService</code> ç›¸å…³çš„äº†ã€‚</p>
<h2 id="WindowManagerService"><a href="#WindowManagerService" class="headerlink" title="WindowManagerService"></a>WindowManagerService</h2>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[AMS è§£æ]]></title>
      <url>http://www.timebridge.space/2017/10/29/AMS-%E8%A7%A3%E6%9E%90/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[The-Good-Wife]]></title>
      <url>http://www.timebridge.space/2017/09/10/The-Good-Wife/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[é»‘å¸†]]></title>
      <url>http://www.timebridge.space/2017/09/10/Black-Sails/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hello World]]></title>
      <url>http://www.timebridge.space/2017/06/29/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[XCode 8.2.1 ClangFormat æ’ä»¶å®‰è£…]]></title>
      <url>http://www.timebridge.space/2017/03/23/XCode-8-2-1-ClangFormat-%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<p>ä¹‹å‰å¼€å‘ Android ï¼ŒAndroid Studio æœ‰æ¯”è¾ƒå¼ºå¤§çš„ Format å·¥å…·ï¼Œä¹ æƒ¯æ€§çš„å†™å®Œä»£ç é¡ºæ‰‹ Format ä¸€ä¸‹ã€‚ç„¶ XCode æœ¬èº«å¹¶ä¸æ”¯æŒ Formatï¼Œéœ€è¦æ‰‹åŠ¨è°ƒæ•´ï¼Œè¿™è®©æˆ‘ç—›è‹¦æ— æ¯”è€Œä¸”è§‰å¾—æµªè´¹æ—¶é—´ï¼Œå› æ­¤æœåˆ°äº† <a href="https://github.com/travisjeffery/ClangFormat-Xcode" target="_blank" rel="noopener">ClangFormat-Xcode</a>ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦è®°å½•å®‰è£…è¿‡ç¨‹ï¼Œå…·ä½“çš„ä½¿ç”¨æ•™ç¨‹å¯ä»¥å‚è€ƒï¼š<a href="http://ios.jobbole.com/89104/" target="_blank" rel="noopener">è¶…è¯¦ç»†çš„Xcodeä»£ç æ ¼å¼åŒ–æ•™ç¨‹ï¼Œå¯è‡ªå®šä¹‰æ ·å¼</a>ã€‚</p>
<p>å®˜ç½‘ä¸Šæä¾›äº†ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ Alcatraz åŒ…ç®¡ç†å·¥å…·ï¼Œä¸€ç§æ˜¯ clone ä»£ç ä¸‹æ¥åˆ° XCode ä¸­è¿è¡Œä¸€ä¸‹ã€‚è¿™é‡Œä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼š<a id="more"></a></p>
<p>1ï¼‰clone é¡¹ç›®ï¼Œå¯¼å…¥åˆ° XCode ä¸­è¿è¡Œï¼›</p>
<p>2ï¼‰ä¹‹åå¯ä»¥åœ¨æ–‡ä»¶å¤¹ <code>~/Library/Application Support/Developer/Shared/Xcode/Plug-ins/</code> ä¸‹é¢å‘ç°ä¸€ä¸ªæ–‡ä»¶ <strong>ClangFormat.xcplugin</strong>ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢å­˜æ”¾çš„éƒ½æ˜¯ XCode ä¸Šå®‰è£…çš„æ’ä»¶ï¼Œåˆ é™¤æ’ä»¶åªè¦æŠŠè¿™ä¸ªç›®å½•ä¸‹å¯¹åº”çš„æ’ä»¶æ–‡ä»¶åˆ é™¤å³å¯ï¼›</p>
<p>3ï¼‰åœ¨å‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ï¼š<code>sudo gem install update_xcode_plugins</code>ï¼›</p>
<p>4ï¼‰åœ¨å‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ï¼š<code>update_xcode_plugins</code>ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">19</span>:<span class="number">49</span>:<span class="number">41.254</span> mdfind[<span class="number">15638</span>:<span class="number">271887</span>] Metadata.framework [Error]: couldn<span class="string">'t get the client port</span></span><br><span class="line"><span class="string">Found:</span></span><br><span class="line"><span class="string">- Xcode (8.2.1) [E0A62D1F-3C18-4D74-BFE5-A4167D643966]: /Applications/Xcode.app</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Plugins:</span></span><br><span class="line"><span class="string">- ClangFormat (1.0)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Updating...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Finished! ğŸ‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">It seems that you have Xcode 8+ installed!</span></span><br><span class="line"><span class="string">Some plugins might not work on recent versions of Xcode because of library validation.</span></span><br><span class="line"><span class="string">See https://github.com/alcatraz/Alcatraz/issues/475</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Run `update_xcode_plugins --unsign` to fix this.</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šåˆ—å‡ºä½ å®‰è£…çš„æ’ä»¶ï¼Œå¹¶ä¸”æç¤ºä½ æœ‰äº›æ’ä»¶ä¸èƒ½ä½¿ç”¨ï¼Œå»ºè®®æ‰§è¡Œå‘½ä»¤ï¼š<code>update_xcode_plugins --unsign</code> è¿›è¡Œä¿®å¤ï¼›</p>
<p>5ï¼‰åœ¨å‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ï¼š<code>update_xcode_plugins --unsign</code>ï¼›</p>
<p>6ï¼‰å®Œå…¨é€€å‡º XCodeï¼Œé‡æ–°æ‰“å¼€ï¼Œä¼šæœ‰ä¸€ä¸ªå¼¹çª—å‡ºç°ï¼Œè­¦å‘Šä½ æœ‰ â€œUnexpected code bundlesâ€ï¼Œé€‰æ‹© <strong>Load Bundles</strong>ã€‚</p>
<p>ä¹‹ååœ¨ Edit èœå•é€‰é¡¹ä¸­å°±å¯ä»¥çœ‹åˆ° Clang Format é€‰é¡¹äº†ï¼Œå®‰è£…å®Œæˆï¼è·Ÿç€å‰é¢æ¨èçš„æ–‡ç« é…ç½®å§ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[SourceTree åˆ†æ”¯å›¾è°±]]></title>
      <url>http://www.timebridge.space/2017/03/07/SourceTree-%E5%88%86%E6%94%AF%E5%9B%BE%E8%B0%B1/</url>
      <content type="html"><![CDATA[<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/sourcetree_rgb_blue.png" alt="åˆ†æ”¯æŸ¥çœ‹" height="48"></div>

<p>ç”¨ <a href="https://www.sourcetreeapp.com/" target="_blank" rel="noopener">SourceTree</a> ä¸€æ®µæ—¶é—´äº†ï¼Œä¸€èˆ¬ç”¨æ¥åšä¸€ä¸‹æäº¤æ–‡ä»¶çš„ reviewï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æ€ä¹ˆå…³æ³¨è¿‡å…¶ä»–åŠŸèƒ½ã€‚å› ä¸ºå·¥ä½œéœ€è¦ä»Šå¤©æ¥çœ‹ä¸€ä¸‹å®ƒçš„åˆ†æ”¯å›¾è°±åŠŸèƒ½ï¼šå®ƒç”¨äºå±•ç¤ºä¸€ä¸ª Git ä»“åº“ä¸­åˆ†æ”¯çš„æäº¤å’Œæ“ä½œæƒ…å†µã€‚å®é™…ä¸Š Git æœ¬èº«å°±æœ‰è¿™æ ·çš„åŠŸèƒ½ï¼Œæ‰§è¡Œå‘½ä»¤<code>git log --graph --decorate --oneline --simplify-by-decoration --all</code>å³å¯ï¼Œæˆ–è€…ä½¿ç”¨ git æä¾›çš„å›¾å½¢åŒ–å·¥å…·å°±å¥½ã€‚é‚£ä¹ˆ SourceTree æ˜¯æ€ä¹ˆç©çš„å‘¢ï¼Ÿ<a id="more"></a></p>
<p>åˆå§‹åˆ†æ”¯æƒ…å†µå¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-1.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p>å¦‚ä¸Šå›¾ï¼Œæ˜¾ç¤ºçš„æ˜¯æ‰€æœ‰åˆ†æ”¯çš„æäº¤æƒ…å†µï¼Œæ˜¯ç»è¿‡ä»¥ä¸‹æäº¤è®°å½•ä¹‹åçš„å›¾è°±ï¼š</p>
<p>1ï¼‰æ–°å»ºä»“åº“ï¼Œåœ¨ <code>master</code> ä¸Šæäº¤ <code>master_a</code>ã€<code>master_b</code>è®°å½•ï¼›</p>
<p>2ï¼‰åˆ‡å‡º <code>branchA</code> åˆ†æ”¯ï¼Œå¹¶æäº¤ <code>branchA_c</code>è®°å½•ï¼›</p>
<p>3ï¼‰åˆ‡åˆ° <code>master</code> åˆ†æ”¯ï¼Œæäº¤ <code>master_d</code>è®°å½•ï¼›</p>
<p>4ï¼‰åˆ‡å‡º <code>branchB</code> åˆ†æ”¯ï¼Œæäº¤ <code>branchB_e</code> è®°å½•ï¼›</p>
<p>5ï¼‰åˆ‡åˆ° <code>branchA</code> åˆ†æ”¯ï¼Œæäº¤ <code>branchA_f</code> è®°å½•ï¼›</p>
<p>6ï¼‰åˆ‡åˆ° <code>master</code> åˆ†æ”¯ï¼Œæäº¤ <code>master_g</code> è®°å½•ï¼›</p>
<p>æäº¤è®°å½•ä»¥ <strong>åˆ†æ”¯å + ä¸‹åˆ’çº¿ + é¡ºåºå­—æ¯</strong> æ¥è¡¨ç¤ºï¼Œå¯ä»¥çœ‹å‡ºå…·ä½“æäº¤åœ¨å“ªä¸ªåˆ†æ”¯ä¸Šä»¥åŠæäº¤çš„é¡ºåºã€‚</p>
<p>æŠŠåˆ†æ”¯åˆ‡åˆ° <code>branchB</code>ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-2.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªå›¾è°±çº¿æ¡å¹¶æ²¡æœ‰å˜åŒ–ï¼Œåªæ˜¯é«˜äº®ç‚¹ä»åŸå…ˆ <code>master_g</code> è®°å½•åˆ‡æ¢åˆ°äº† <code>branchB_e</code> è®°å½•ã€‚</p>
<p>æŠŠåˆ†æ”¯åˆ‡æ¢åˆ°åˆ†æ”¯ <code>branchB</code>ï¼Œå¹¶æäº¤è®°å½• <code>branchB_g</code>ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-3.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p>å›¾è°±å˜åŒ–ï¼Œé«˜äº®ç‚¹åˆå›åˆ°æœ€å·¦è¾¹ç«–çº¿çš„é¡¶éƒ¨ã€‚ç”±æ­¤å¯è§ï¼š<strong>æ•´ä¸ªå›¾è°±çš„ç‚¹ä»ä¸‹å¾€ä¸Šæ˜¯æŒ‰ç…§æäº¤è®°å½•çš„æ—¶é—´æ¥æ’åˆ—çš„ï¼Œæœ€å·¦è¾¹çš„çº¿ä»£è¡¨ç€æœ€è¿‘æœ‰æ´»åŠ¨çš„åˆ†æ”¯</strong>ã€‚</p>
<p>åœ¨ <code>master</code> åˆ†æ”¯ä¸Šå¯¹ <code>branchA</code> æ‰§è¡Œ merge æ“ä½œï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-4.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p>è¿™é‡Œæœ‰ä¸¤ç‚¹å˜åŒ–ï¼š</p>
<ol>
<li>å› ä¸ºæ˜¯åœ¨ <code>master</code> åˆ†æ”¯ä¸Šæ‰§è¡Œçš„æ“ä½œï¼Œå› æ­¤æœ€è¿‘æœ‰å˜åŒ–çš„åˆ†æ”¯å°±å˜æˆ <code>master</code>ï¼Œæœ€å·¦è¾¹çš„çº¿è‡ªç„¶å˜æˆ <code>master</code> åˆ†æ”¯ï¼Œè¿™ä¹Ÿå°è¯äº†å‰é¢çš„ç»“è®ºï¼›</li>
<li>ç²‰çº¢è‰²çš„çº¿å¹¶å…¥ <code>master</code> åˆ†æ”¯ï¼Œä½†æ˜¯æ ‡è®°æœ‰ <code>branchA</code> çš„ç²‰çº¢è‰²è‰²å—å¹¶æ²¡æœ‰å’Œæ ‡è®°æœ‰ <code>master</code> çš„è“è‰²è‰²å—æ”¾åˆ°ä¸€å—å»ï¼›</li>
</ol>
<p>åˆ‡åˆ° <code>branchA</code> åˆ†æ”¯ï¼Œæäº¤ <code>branchA_i</code> è®°å½•ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-5.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p>é¦–å…ˆæœ€å·¦è¾¹å˜æˆäº†åˆ†æ”¯ <code>branchA</code>ï¼Œå…¶æ¬¡ <code>branchA</code> åˆ†æ”¯çš„çº¿åˆ†å‰äº†ï¼Œä¸€éƒ¨åˆ†è¿æ¥åˆ°æœ€é¡¶éƒ¨çš„é«˜äº®ç‚¹ï¼Œä¸€éƒ¨åˆ†è¿æ¥åˆ°è¡¨ç¤º <code>master</code> åˆ†æ”¯çš„ç²‰è‰²çº¿ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„æ“ä½œè®°å½•ã€‚</p>
<p>åˆ‡åˆ° <code>master</code> åˆ†æ”¯ï¼Œå¹¶æäº¤ <code>master_j</code> æ“ä½œï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-7.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p><code>master</code> åˆ†æ”¯åˆè·‘åˆ°äº†æœ€å·¦è¾¹ï¼Œèƒ½æ¸…æ™°çš„çœ‹åˆ°å¦‚ä¸‹å˜åŒ–ï¼š<code>branchA</code> ï¼ˆç²‰è‰²çº¿ï¼‰åœ¨è®°å½• <code>branchA_f</code> ä¹‹ååˆå¹¶äº†ä¸€æ¬¡åˆ° <code>master</code> åˆ†æ”¯ï¼Œä¹‹åç»§ç»­æäº¤äº† <code>branchA_i</code> è®°å½•ã€‚</p>
<p>åˆ‡åˆ° <code>branchB</code>ï¼Œå¯¹ <code>master</code> åˆ†æ”¯æ‰§è¡Œ rebase æ“ä½œï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-8.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶é»„è‰²çš„çº¿æ¶ˆå¤±äº†ï¼Œä¼¼ä¹åªæœ‰ä¸¤ä¸ªåˆ†æ”¯äº†ï¼Œä½†å®é™…ä¸æ˜¯ã€‚æ³¨æ„çœ‹æœ€å·¦è¾¹çš„çº¿ï¼Œæ­¤æ—¶å˜æˆäº† <code>branchB</code>ï¼Œ<code>master</code> åˆ†æ”¯ä¹Ÿåœ¨è¿™æ¡çº¿ä¸Šï¼Œæ³¨æ„çœ‹ç°è‰²é‚£è¡Œã€‚</p>
<p>åˆ‡åˆ° <code>master</code>  åˆ†æ”¯ï¼Œåˆ‡å‡ºæ–°çš„åˆ†æ”¯ <code>branchC</code>ã€<code>branchD</code>ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åˆ†æ”¯æŸ¥çœ‹-9.png" alt="åˆ†æ”¯æŸ¥çœ‹"></div>

<p>å¯ä»¥çœ‹åˆ°ç°è‰²é‚£è¡Œï¼ŒåŸå…ˆä»£è¡¨ <code>master</code> åˆ†æ”¯çš„æœ€æ–°èŠ‚ç‚¹ï¼Œå³è¾¹åªæœ‰ä¸€ä¸ªæ ‡æœ‰ <code>master</code> çš„è“è‰²è‰²å—ï¼Œç°åœ¨æœ‰ä¸‰ä¸ªè‰²å—äº†ï¼ŒåŠ äº† <code>branchC</code>ã€<code>branchD</code> ä¸¤ä¸ªã€‚</p>
<p>é’ˆå¯¹ <strong>å…¨éƒ¨åˆ†æ”¯</strong> æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>æ¯ä¸€æ¡çº¿ä»£è¡¨ä¸€ä¸ªåˆ†æ”¯ï¼Œåˆ†æ”¯ä¸Šçš„ç‚¹ä»£è¡¨ç€ä¸€æ¬¡æäº¤ï¼Œæœ€æ–°çš„æäº¤è®°å½•å³ä¾§ä¼šå¸¦æœ‰ä¸€ä¸ªè‰²å—ï¼Œæ ‡è®°è¿™æ¡çº¿ä»£è¡¨å“ªä¸ªåˆ†æ”¯ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªç‚¹ä¼šä»£è¡¨å¤šä¸ªåˆ†æ”¯ï¼Œå› æ­¤ä¼šæœ‰å¤šä¸ªè‰²å—ï¼›</li>
<li>æ•´ä¸ªå›¾è°±çš„ç‚¹ä»ä¸‹å¾€ä¸Šæ˜¯æŒ‰ç…§æäº¤è®°å½•çš„æ—¶é—´æ¥æ’åˆ—çš„ï¼Œæœ€å·¦è¾¹çš„çº¿ä»£è¡¨ç€æœ€è¿‘æœ‰æ´»åŠ¨çš„åˆ†æ”¯ï¼›</li>
<li>çº¿äº¤æ±‡ä»£è¡¨åˆ†æ”¯åˆå¹¶ï¼Œåˆ†å‰ä»£è¡¨åˆ‡å‡ºæ–°åˆ†æ”¯ï¼›</li>
</ol>
<p>ä»¥ä¸ŠåŸºæœ¬å°±æ˜¯çœ‹æ‡‚åˆ†æ”¯å›¾è°±æ‰€éœ€è¦çš„çŸ¥è¯†ã€‚é™¤äº†â€å…¨éƒ¨åˆ†æ”¯â€ è§†å›¾ï¼Œè¿˜å¯ä»¥ä»»æ„åˆ‡æ¢åˆ°æŸä¸ªåˆ†æ”¯ï¼ŒæŸ¥çœ‹è¿™ä¸ªåˆ†æ”¯çš„è§†å›¾ï¼Œä¸¤ç§è§†å›¾å”¯ä¸€çš„ä¸åŒå°±æ˜¯åˆ†æ”¯è§†å›¾ä¸‹æœ€å·¦è¾¹çš„çº¿ä»£è¡¨é€‰ä¸­çš„åˆ†æ”¯ï¼ˆå…¶å®ä¹Ÿæ˜¯æœ€è¿‘æœ‰æ´»åŠ¨çš„åˆ†æ”¯ï¼Œåªä¸è¿‡ä¸Šä¸‹æ–‡ä¸ä¸€æ ·ï¼‰ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[iOS ç½‘ç»œå­¦ä¹ ï¼ˆä¸€ï¼‰â€”â€” URLConnection]]></title>
      <url>http://www.timebridge.space/2017/02/15/iOS-%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<blockquote>
<p>å…³äº Http ç›¸å…³çŸ¥è¯†ï¼Œæ¨èä¹¦ç±ï¼šã€ŠHTTP : The Definitive Guideã€‹ã€‚</p>
</blockquote>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><a href="https://developer.apple.com/reference/foundation/nsurlconnection" target="_blank" rel="noopener"><code>NSURLConnection</code></a> ç”¨äºå‘æœåŠ¡ç«¯å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå®ƒæš´éœ²çš„æ¥å£éå¸¸å°‘ï¼Œåªèƒ½æ§åˆ¶å‘èµ·å’Œå–æ¶ˆè¯·æ±‚ï¼Œå¤§éƒ¨åˆ†çš„é…ç½®æ˜¯åœ¨ <code>NSURLRequest</code> ä¸Šè¿›è¡Œã€‚æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„ NSURLConnection æ›´å¤šçš„æ˜¯æŒ‡ä»¥ <code>NSURLConnection</code> ç±»ä¸ºæ ¸å¿ƒçš„ä¸€å¥—ç½‘ç»œè¯·æ±‚è§£å†³æ–¹æ¡ˆï¼Œå®ƒåŒ…æ‹¬ï¼š</p>
<ol>
<li><a href="https://developer.apple.com/reference/foundation/nsurl" target="_blank" rel="noopener">NSURL</a>ï¼šè¯·æ±‚åœ°å€ï¼›</li>
<li><a href="https://developer.apple.com/reference/foundation/nsurlrequest" target="_blank" rel="noopener">NSURLRequest</a>ï¼šå°è£…ä¸€ä¸ªè¯·æ±‚ï¼Œä¿å­˜å‘ç»™æœåŠ¡å™¨çš„å…¨éƒ¨æ•°æ®ï¼ŒåŒ…æ‹¬ä¸€ä¸ªNSURLå¯¹è±¡ï¼Œè¯·æ±‚æ–¹æ³•ã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ç­‰ï¼›</li>
<li><a href="https://developer.apple.com/reference/foundation/NSMutableURLRequest" target="_blank" rel="noopener">NSMutableURLRequest</a>ï¼šNSURLRequestçš„å­ç±»ï¼›</li>
<li><a href="https://developer.apple.com/reference/foundation/nsurlconnection" target="_blank" rel="noopener">NSURLConnection</a>ï¼šè´Ÿè´£å‘é€è¯·æ±‚ï¼Œå»ºç«‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„è¿æ¥ã€‚å‘é€NSURLRequestçš„æ•°æ®ç»™æœåŠ¡å™¨ï¼Œå¹¶æ”¶é›†æ¥è‡ªæœåŠ¡å™¨çš„å“åº”æ•°æ®ï¼›</li>
</ol>
<a id="more"></a>NSURLConnection çš„å­¦ä¹ æ¯”è¾ƒç®€å•ï¼Œæ ¸å¿ƒåŒ…æ‹¬ä¸¤å—ï¼š<br><br>1. åŒæ­¥ / å¼‚æ­¥è¯·æ±‚ï¼›<br>2. ä½¿ç”¨ Block / Delegate æ¥æ”¶è¿”å›æ•°æ®ï¼›<br><br>ä¸‹é¢å›´ç»•è¿™ä¸¤ä¸ªç‚¹è¿›è¡Œå­¦ä¹ ï¼Œå¹¶è¡¥å……ä¸€äº›å¸¸è§çš„è®¾ç½®å’Œç›¸å…³çŸ¥è¯†ã€‚<br><br>&gt; è¿™é‡Œæ¨èä¸€ä¸ªç½‘ç«™ï¼Œç”¨äºå¿«é€Ÿå®éªŒç½‘ç»œåŠŸèƒ½ï¼š<a href="http://httpbin.org/ã€‚è¿™ä¸ªç½‘ç«™åˆ—ä¸¾äº†å¾ˆå¤šå¼€æ”¾çš„æ¥å£ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡è°ƒç”¨è¿™äº›æ¥å£æ¥æµ‹è¯•è‡ªå·±çš„ç½‘ç»œè¯·æ±‚ï¼Œéå¸¸æ–¹ä¾¿ã€‚æ¯”å¦‚è¯·æ±‚æ¥å£" target="_blank" rel="noopener">http://httpbin.org/ã€‚è¿™ä¸ªç½‘ç«™åˆ—ä¸¾äº†å¾ˆå¤šå¼€æ”¾çš„æ¥å£ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡è°ƒç”¨è¿™äº›æ¥å£æ¥æµ‹è¯•è‡ªå·±çš„ç½‘ç»œè¯·æ±‚ï¼Œéå¸¸æ–¹ä¾¿ã€‚æ¯”å¦‚è¯·æ±‚æ¥å£</a> <a href="http://httpbin.org/ipï¼Œè¿”å›çš„æ•°æ®å°±æ˜¯ï¼š" target="_blank" rel="noopener">http://httpbin.org/ipï¼Œè¿”å›çš„æ•°æ®å°±æ˜¯ï¼š</a><br>&gt;<br>&gt; <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt;   "origin": "103.39.140.10"</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<h2 id="åŒæ­¥-å¼‚æ­¥è¯·æ±‚"><a href="#åŒæ­¥-å¼‚æ­¥è¯·æ±‚" class="headerlink" title="åŒæ­¥ / å¼‚æ­¥è¯·æ±‚"></a>åŒæ­¥ / å¼‚æ­¥è¯·æ±‚</h2><p>NSURLConnection åŒæ—¶æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚çš„å‘é€ï¼Œä½†å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯ä½¿ç”¨å¼‚æ­¥è¯·æ±‚ï¼Œå› æ­¤ä¸‹é¢çš„ä¾‹å­å…ˆä»å¼‚æ­¥è¯·æ±‚å¼€å§‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NSURL *url = [NSURL URLWithString:@&quot;åè®®://ä¸»æœºåœ°å€/è·¯å¾„?å‚æ•°&amp;å‚æ•°&quot;];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:15.0];</span><br><span class="line">// å‘Šè¯‰æœåŠ¡å™¨æ•°æ®ä¸ºjsonç±»å‹</span><br><span class="line">[request setValue:@&quot;application/json&quot; forHTTPHeaderField:@&quot;Content-Type&quot;]; </span><br><span class="line">// è®¾ç½®è¯·æ±‚ä½“(jsonç±»å‹)</span><br><span class="line">NSData *jsonData = [NSJSONSerialization dataWithJSONObject:@&#123;@&quot;userid&quot;:@&quot;123456&quot;&#125; options:NSJSONWritingPrettyPrinted error:nil];</span><br><span class="line">request.HTTPBody = jsonData; </span><br><span class="line">[NSURLConnection sendAsynchronousRequest:request queue:[[NSOperationQueue alloc] init] completionHandler:^(NSURLResponse *response, NSData *data, NSError *connectionError) &#123;</span><br><span class="line">    // æœ‰çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨è®¿é—®æ­£å¸¸ï¼Œä½†æ˜¯ä¼šæ²¡æœ‰æ•°æ®ï¼</span><br><span class="line">    // ä»¥ä¸‹çš„ if æ˜¯æ¯”è¾ƒæ ‡å‡†çš„é”™è¯¯ å¤„ç†ä»£ç ï¼</span><br><span class="line">    if (connectionError != nil || data == nil) &#123;</span><br><span class="line">        //ç»™ç”¨æˆ·çš„æç¤ºä¿¡æ¯</span><br><span class="line">        NSLog(@&quot;ç½‘ç»œä¸ç»™åŠ›&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p><code>NSURL</code> ç”¨äºæŒ‡å‘ä¸€ä¸ªèµ„æºåœ°å€ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æŒ‡å‘çš„æ˜¯æœåŠ¡å™¨ç«¯çš„èµ„æºã€‚å…³äºä»£ç ä¸­ç»™å‡ºçš„æ ¼å¼ï¼Œå¦‚æœ‰ä¸æ‡‚å¯ä»¥ç›´æ¥å‚è€ƒ<a href="https://developer.apple.com/reference/foundation/nsurl" target="_blank" rel="noopener">å¼€å‘æ–‡æ¡£</a> æˆ–è€…ç¿»é˜…æœ¬æ–‡å¼€å¤´æ¨èçš„ä¹¦ç±ã€‚å®ƒçš„å¸¸è§ç”¨æ³•å°±æ˜¯é€šè¿‡ä¸€ä¸ªè¡¨è¾¾ url çš„ <code>NSString</code> ç”Ÿæˆ <code>NSURL</code> å¯¹è±¡ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSURL *url = [NSURL URLWithString:@&quot;http://httpbin.org/ip&quot;];</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œå¯ä»¥ä½¿ç”¨ <code>NSURL</code> ç”ŸæˆåŸºæœ¬çš„ <code>NSURLRequest</code> å¯¹è±¡ï¼Œ<code>NSURL</code> å®šä¹‰çš„æ˜¯èµ„æºçš„åœ°å€ï¼Œ<code>NSURLRequest</code> é¡¾åæ€ä¹‰ï¼Œå®šä¹‰çš„å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œè¯·æ±‚ã€‚<code>NSURLRequest</code> çš„å®ä¾‹åŒ–åŸºæœ¬åˆ†ä¸ºä¸¤ç§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ requestWithURL:</span><br><span class="line">+ requestWithURL:cachePolicy:timeoutInterval:</span><br></pre></td></tr></table></figure>
<p>ä¸€ç§æ˜¯åªéœ€è¦æä¾› <code>NSURL</code> å³å¯ï¼Œå…¶ä½™çš„é…ç½®å…¨éƒ¨é»˜è®¤ã€‚å¦å¤–ä¸€ç§æ˜¯å¯ä»¥é…ç½®ç¼“å­˜ç­–ç•¥ä»¥åŠè¶…æ—¶æ—¶é—´ã€‚ä½†æ˜¯æ— è®ºå“ªç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°èƒ½é…ç½®çš„é¡¹å®åœ¨å¤ªå°‘ï¼Œè‡³å°‘æˆ‘ä»¬æœ‰ä¸€äº›å¸¸è§çš„éœ€æ±‚è¿™æ ·æ˜¯æ— æ³•æ»¡è¶³çš„ï¼Œæ¯”å¦‚æ›´æ”¹è¯·æ±‚æ–¹æ³•ä¸º POST è¯·æ±‚ï¼Œæ·»åŠ è¯·æ±‚ Header ç­‰ã€‚å› æ­¤å¾ˆè‡ªç„¶åœ°å°±å‡ºç°äº† <code>NSMutableURLRequest</code> ç±»ï¼Œè¯¥ç±»æä¾›äº†è¾ƒä¸ºä¸°å¯Œçš„é…ç½®é€‰é¡¹ã€‚å°±åƒä¾‹å­ä¸­çœ‹åˆ°çš„ä¸€æ ·ï¼Œè¿˜å¯ä»¥è®¾ç½®æ¶ˆæ¯ä½“ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹æä¸€ä¸‹ç¼“å­˜ç­–ç•¥ï¼Œå³<code>cachePolicy</code>å‚æ•°ã€‚è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹â€”â€”<a href="https://developer.apple.com/reference/foundation/NSURLRequestCachePolicy" target="_blank" rel="noopener"><code>NSURLRequestCachePolicy</code></a>ï¼Œå®ƒçš„å–å€¼æ˜¯æ ¹æ® Http å®šä¹‰çš„ç¼“å­˜åè®®æ¥çš„ï¼Œå…·ä½“å¯ä»¥æŸ¥è¯¢æœ¬æ–‡å¼€å¤´æ¨èçš„ä¹¦ç±ï¼Œæˆ–è€…ç¿»çœ‹ <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13" target="_blank" rel="noopener">RFC2616</a>ï¼Œå› ä¸ºè¿™ä¸ªç‚¹å¯ä»¥ä¸“é—¨å¼€ä¸€ç¯‡æ–‡ç« è¿›è¡Œæè¿°ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚Http ç¼“å­˜æœºåˆ¶å¯ä»¥æ»¡è¶³ä»¥ä¸‹çš„é€»è¾‘è·¯å¾„ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/http_caching.png" height="420" alt="One Piece"></div>

<p>è¯¥æšä¸¾æœ‰ä»¥ä¸‹å€¼å¯ä»¥é€‰æ‹©ï¼š</p>
<ol>
<li><code>NSURLRequestUseProtocolCachePolicy</code> è¡¨ç¤ºä½¿ç”¨åè®®å®šä¹‰çš„æ ‡å‡†ç¼“å­˜é€»è¾‘ï¼Œå®ƒæ˜¯è¯·æ±‚é»˜è®¤ä½¿ç”¨çš„ç¼“å­˜åè®®ã€‚</li>
<li><code>[NSURLRequestReloadIgnoringLocalCacheData]</code> è¡¨ç¤ºå¿½ç•¥æœ¬åœ°ç¼“å­˜ï¼Œä»æºåœ°å€åŠ è½½èµ„æºã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ Http/Https åè®®å¹¶è¯·æ±‚çš„æ˜¯èµ„æºçš„éƒ¨åˆ†æ•°æ®ï¼ŒåŠ¡å¿…ä½¿ç”¨è¯¥é€‰é¡¹ï¼›</li>
<li><code>NSURLRequestReloadIgnoringLocalAndRemoteCacheData</code> è¡¨ç¤ºä¸ä»…å¿½ç•¥æœ¬åœ°ç¼“å­˜ï¼Œä¹Ÿè¦å¿½ç•¥ä»»ä½•ä¸­é—´èŠ‚ç‚¹çš„ç¼“å­˜ï¼Œå¿…é¡»ä»æºåœ°å€åŠ è½½æ•°æ®ï¼›</li>
<li><code>NSURLRequestReloadRevalidatingCacheData</code> è¡¨ç¤ºåœ¨ä½¿ç”¨ç¼“å­˜ä¹‹å‰å¿…é¡»ç”±æœåŠ¡ç«¯éªŒè¯ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸåˆ™ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™ä»æœåŠ¡ç«¯æ‹‰å–æœ€æ–°æ•°æ®ï¼ˆå¯¹åº”åˆ°ä¸Šå›¾ä¸­ï¼Œèµ°çš„æ˜¯ <strong>Issue a HEAD request</strong> è·¯å¾„ï¼‰ï¼›</li>
</ol>
<p>è¯·æ±‚å®šä¹‰å¥½ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡<code>NSURLConnection</code>æ¥å‘é€è¯·æ±‚äº†ã€‚å‘é€è¯·æ±‚æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ sendSynchronousRequest:returningResponse:error:  // å‘é€åŒæ­¥è¯·æ±‚</span><br><span class="line">+ sendAsynchronousRequest:queue:completionHandler:  // å‘é€å¼‚æ­¥è¯·æ±‚</span><br></pre></td></tr></table></figure>
<p>è¯»è€…å¦‚æœè¿™ä¸ªæ—¶å€™å»æŸ¥çœ‹<a href="https://developer.apple.com/reference/foundation/nsurlconnection?language=objc" target="_blank" rel="noopener">å¼€å‘æ–‡æ¡£</a>ï¼Œä¼šå‘ç°è¿™ä¸¤ä¸ªæ–¹æ³•å·²ç»è¢«åºŸå¼ƒäº†ï¼Œè¿™æ˜¯å› ä¸º Apple å‘å¸ƒäº†æ›´ä¸ºä¼˜ç§€çš„è¯·æ±‚å·¥å…· <code>NSURLSession</code>ï¼Œä¸å†æ¨èä½¿ç”¨<code>NSURLConnection</code>ï¼Œç„¶è€Œå› ä¸ºæŸäº›åº“æˆ–è€…é—ç•™ä»£ç è¿˜åœ¨ä½¿ç”¨ <code>NSURLConnection</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œå­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p>ä¾‹å­ä¸­ä½¿ç”¨çš„æ˜¯å¼‚æ­¥æ–¹æ³•ï¼Œå¼‚æ­¥æ–¹æ³•éœ€è¦è®¾ç½®å›è°ƒæ¥è¿›è¡Œç›‘å¬æ•°æ®çš„æ¥æ”¶å¤„ç†ï¼ŒiOS ä¸€èˆ¬ä½¿ç”¨ Block æˆ–è€… Delegate æ¥å®ç°å›è°ƒï¼Œ<code>NSURLConnection</code>ä¸¤ç§éƒ½æ”¯æŒï¼Œä¾‹å­ä¸­ä½¿ç”¨çš„æ˜¯ Blockã€‚ä¸¤è€…çš„åŒºåˆ«ä¸‹é¢å†è¯´ã€‚</p>
<p>ä½¿ç”¨åŒæ­¥æ–¹æ³•çš„ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// å‘é€åŒæ­¥è¯·æ±‚, data å°±æ˜¯è¿”å›çš„æ•°æ®</span><br><span class="line">NSError *error = nil;</span><br><span class="line">NSData *data = [NSURLConnection sendSynchronousRequest:request returningResponse:nil error:&amp;error];</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¿”å›å€¼ä¸º nilï¼Œåˆ™è¡¨ç¤ºè¿æ¥åˆ›å»ºå¤±è´¥ï¼Œæˆ–è€…æ•°æ®åŠ è½½å¤±è´¥ï¼Œç®€è€Œè¨€ä¹‹ï¼Œè¯·æ±‚å¤±è´¥ã€‚ä½¿ç”¨åŒæ­¥è¯·æ±‚ä¼šé˜»å¡å½“å‰è°ƒç”¨çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸å»ºè®®åœ¨ UI çº¿ç¨‹è°ƒç”¨ã€‚</p>
<h2 id="ä½¿ç”¨-Block-Delegate-æ¥æ”¶è¿”å›æ•°æ®"><a href="#ä½¿ç”¨-Block-Delegate-æ¥æ”¶è¿”å›æ•°æ®" class="headerlink" title="ä½¿ç”¨ Block / Delegate æ¥æ”¶è¿”å›æ•°æ®"></a>ä½¿ç”¨ Block / Delegate æ¥æ”¶è¿”å›æ•°æ®</h2><p>ä¸Šä¸€èŠ‚çš„ä¾‹å­ä¸­å·²ç»å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Block æ¥æ”¶æ•°æ®ï¼ŒBlock ä½œä¸ºå›è°ƒçš„ç¼ºé™·æ˜¯åªèƒ½åœ¨è¯·æ±‚ç»“æŸåå¯¹è¿”å›æ•°æ®è¿›è¡Œæ“ä½œï¼Œå¦‚æœé‡åˆ°åƒ <a href="http://timebridge.space/2017/02/10/SDWebImage-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" target="_blank" rel="noopener">SDWebImage</a> åº“é‚£æ ·çš„éœ€æ±‚ï¼Œéœ€è¦åœ¨æ•°æ®åŠ è½½å¼€å§‹å’ŒåŠ è½½ä¸­è¿›è¡Œå¤„ç†ï¼ŒBlock å°±ä¸èƒ½èƒœä»»ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨ Delegateã€‚ä½¿ç”¨ Delegate éœ€è¦å®ç°åè®® <code>NSURLConnectionDataDelegate</code>ï¼Œè¿™ä¸ªåè®®ç»§æ‰¿äº<code>NSURLConnectionDelegate</code>åè®®å¹¶æ·»åŠ äº†ä¸ƒä¸ªæ–°çš„æ¥å£ï¼Œæ¶‰åŠåˆ°æ•°æ®åŠ è½½ä¸åŒé˜¶æ®µã€é‡å®šå‘ã€ç¼“å­˜ç­‰æ–¹é¢ï¼Œå…¶ä¸­å››ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark- NSURLConnectionDataDelegateä»£ç†æ–¹æ³•</span><br><span class="line"></span><br><span class="line">//å½“æ¥æ”¶åˆ°æœåŠ¡å™¨çš„å“åº”ï¼ˆè¿é€šäº†æœåŠ¡å™¨ï¼‰æ—¶ä¼šè°ƒç”¨</span><br><span class="line">-(void)connection:(NSURLConnection *)connection didReceiveResponse:(NSURLResponse *)response</span><br><span class="line"></span><br><span class="line">//å½“æ¥æ”¶åˆ°æœåŠ¡å™¨çš„æ•°æ®æ—¶ä¼šè°ƒç”¨ï¼ˆå¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œæ¯æ¬¡åªä¼ é€’éƒ¨åˆ†æ•°æ®ï¼‰</span><br><span class="line">-(void)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data</span><br><span class="line"></span><br><span class="line">//å½“æœåŠ¡å™¨çš„æ•°æ®åŠ è½½å®Œæ¯•æ—¶å°±ä¼šè°ƒç”¨</span><br><span class="line">-(void)connectionDidFinishLoading:(NSURLConnection *)connection</span><br><span class="line"></span><br><span class="line">//è¯·æ±‚é”™è¯¯ï¼ˆå¤±è´¥ï¼‰çš„æ—¶å€™è°ƒç”¨ï¼ˆè¯·æ±‚è¶…æ—¶\æ–­ç½‘\æ²¡æœ‰ç½‘\ï¼Œä¸€èˆ¬æŒ‡å®¢æˆ·ç«¯é”™è¯¯ï¼‰</span><br><span class="line">-(void)connection:(NSURLConnection *)connection didFailWithError:(NSError *)error</span><br></pre></td></tr></table></figure>
<p>å®ç°ä¹‹åï¼Œä»£ç†çš„è®¾ç½®å’Œè¯·æ±‚å‘é€ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSURLConnection *conn = [NSURLConnection connectionWithRequest:request delegate:self];</span><br><span class="line">[conn start];</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Delegate ä¸‹è½½æ–‡ä»¶çš„ä¾‹å­ï¼Œä»¥ä¾›è¯»è€…å‚è€ƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">-(void)sendAFNetworingRequest:(id)button&#123;</span><br><span class="line">    NSURL *url = [NSURL URLWithString:@&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1487163449810&amp;di=c69d81b7530c246d5d3ab7c157f5463c&amp;imgtype=0&amp;src=http%3A%2F%2Fimg2.78dm.net%2Fforum%2F201409%2F14%2F144254ed19ejda61z5aw5n.jpg&quot;];</span><br><span class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:15.0];</span><br><span class="line">    NSURLConnection *conn = [NSURLConnection connectionWithRequest:request delegate:self];</span><br><span class="line">    [conn start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(NSString *)getDownloadFilePath &#123;</span><br><span class="line">    NSString *path = NSTemporaryDirectory();</span><br><span class="line">    return [path stringByAppendingString:@&quot;onepiece.jpeg&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)connection:(NSURLConnection *)connection didReceiveResponse:(NSURLResponse *)response &#123;</span><br><span class="line">    NSLog(@&quot;ä¸‹è½½å¼€å§‹&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data &#123;</span><br><span class="line">    NSFileHandle *fileHandle = [NSFileHandle fileHandleForWritingAtPath:self.downloadFilePath];</span><br><span class="line">    fileSize += (unsigned long)data.length;</span><br><span class="line">    NSLog(@&quot;æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š%lu&quot;, (unsigned long)data.length);</span><br><span class="line">    if (fileHandle) &#123;</span><br><span class="line">        [fileHandle seekToEndOfFile];</span><br><span class="line">        [fileHandle writeData:data];</span><br><span class="line">        [fileHandle closeFile];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [data writeToFile:self.downloadFilePath atomically:YES];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)connectionDidFinishLoading:(NSURLConnection *)connection &#123;</span><br><span class="line">    NSLog(@&quot;ä¸‹è½½å®Œæˆï¼Œæ€»æ•°æ®é‡ï¼š%lu&quot;, fileSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½çš„èµ„æºæ˜¯ç™¾åº¦ä¸Šçš„ä¸€å¼ å›¾ç‰‡ï¼Œå¤§å°æ˜¾ç¤ºä¸º 158 KBï¼Œä¸‹é¢æ˜¯æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2017-02-15 18:14:47.632 MyP[47339:12735852] ä¸‹è½½å¼€å§‹</span><br><span class="line">2017-02-15 18:14:47.633 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š18413</span><br><span class="line">2017-02-15 18:14:47.944 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š1336</span><br><span class="line">2017-02-15 18:14:47.944 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š6856</span><br><span class="line">2017-02-15 18:14:48.246 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š9624</span><br><span class="line">2017-02-15 18:14:48.246 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š36864</span><br><span class="line">2017-02-15 18:14:48.400 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š1328</span><br><span class="line">2017-02-15 18:14:48.401 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š13624</span><br><span class="line">2017-02-15 18:14:48.453 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š1336</span><br><span class="line">2017-02-15 18:14:48.459 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š96</span><br><span class="line">2017-02-15 18:14:48.463 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š23144</span><br><span class="line">2017-02-15 18:14:48.473 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š1336</span><br><span class="line">2017-02-15 18:14:48.474 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š96</span><br><span class="line">2017-02-15 18:14:48.476 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š2664</span><br><span class="line">2017-02-15 18:14:48.790 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š1432</span><br><span class="line">2017-02-15 18:14:49.355 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š23144</span><br><span class="line">2017-02-15 18:14:49.589 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š1432</span><br><span class="line">2017-02-15 18:14:49.609 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š1328</span><br><span class="line">2017-02-15 18:14:49.609 MyP[47339:12735852] æ•°æ®ä¸‹è½½ä¸­ï¼Œæ–°æ¥æ”¶æ•°æ®é‡ï¼š13528</span><br><span class="line">2017-02-15 18:14:49.610 MyP[47339:12735852] ä¸‹è½½å®Œæˆï¼Œæ€»æ•°æ®é‡ï¼š157581</span><br></pre></td></tr></table></figure>
<p>ä»è¿™ä¸ªä¾‹å­è¿˜å¯ä»¥çœ‹å‡ºä½¿ç”¨ Delegate çš„å¦å¤–ä¸€ä¸ªå¥½å¤„ï¼šå› ä¸ºå¯ä»¥æŒç»­å¤„ç†æ•°æ®è€Œä¸ç”¨ç­‰åˆ°æ•°æ®å…¨éƒ¨åŠ è½½å®Œæˆåå†å¤„ç†ï¼Œå› æ­¤å¯ä»¥é¿å…å°†åŠ è½½çš„èµ„æºå…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥å°†æ•°æ®æŒç»­åŒæ­¥åˆ°ç£ç›˜ä¸Šï¼Œè¿™æ˜¯ Block æ— æ³•åšåˆ°çš„ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯å…³äº NSURLConnction çš„ä¸€äº›åŸºæœ¬çŸ¥è¯†ã€‚</p>
<p>åœ¨ 2013 å¹´è‹¹æœå…¨çƒå¼€å‘è€…å¤§ä¼šï¼ˆWWDC 2013ï¼‰ä¸Š Apple å‘å¸ƒäº†æ–°çš„ç½‘ç»œè¯·æ±‚ç±» NSURLSessionï¼Œä» iOS9.0 å¼€å§‹ï¼ŒNSURLConnection å‘é€è¯·æ±‚çš„ä¸¤ä¸ªæ–¹æ³•ä»¥åŠåˆå§‹åŒ–ç½‘ç»œè¿æ¥çš„æ–¹æ³•éƒ½è¢«ç½®ä¸ºè¿‡æœŸï¼ŒApple æ¨èä½¿ç”¨ NSURLSession ç±»æ¥æ›¿ä»£ NSURLConnectionï¼Œè¿™æ„å‘³ç€ NSURLConnection å³å°†æ¨å‡ºå†å²èˆå°ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†å­¦ä¹  NSURLSessionã€‚</p>
<p>ã€å‚è€ƒæ–‡ç« ã€‘</p>
<p>1ï¼‰<a href="http://www.cnblogs.com/wendingding/p/3813572.html" target="_blank" rel="noopener">iOSå¼€å‘ç½‘ç»œç¯‡â€”NSURLConnectionåŸºæœ¬ä½¿ç”¨</a></p>
<p>2ï¼‰<a href="http://www.cnblogs.com/mddblog/p/5134783.html" target="_blank" rel="noopener">iOSç½‘ç»œ1â€”â€”NSURLConnectionä½¿ç”¨è¯¦è§£</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[iOS ç½‘ç»œå­¦ä¹ ï¼ˆäºŒï¼‰â€”â€” NSURLSession]]></title>
      <url>http://www.timebridge.space/2017/02/15/iOS-%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>2013 å¹´ WWDC ä¸Šï¼ŒApple å‘å¸ƒäº† NSURLConnection çš„ç»§ä»»è€… <a href="https://developer.apple.com/reference/foundation/urlsession" target="_blank" rel="noopener">NSURLSession</a>ï¼Œæ”¯æŒ iOS7.0+ï¼Œè€Œ NSURLCOnnection åœ¨ iOS9 è¢«å®£å¸ƒå¼ƒç”¨ã€‚</p>
<h2 id="URL-åŠ è½½ç³»ç»Ÿ"><a href="#URL-åŠ è½½ç³»ç»Ÿ" class="headerlink" title="URL åŠ è½½ç³»ç»Ÿ"></a>URL åŠ è½½ç³»ç»Ÿ</h2><p>åœ¨å­¦ä¹  NSURLSession ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ URL åŠ è½½ç³»ç»Ÿï¼ˆURL Loading Systemï¼‰ã€‚</p>
<blockquote>
<p>è¿™ä¸ªç³»ç»Ÿæœ¬æ¥åº”è¯¥åœ¨ <a href="http://timebridge.space/2017/02/15/iOS-%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/" target="_blank" rel="noopener">iOS ç½‘ç»œå­¦ä¹ ï¼ˆä¸€ï¼‰â€”â€” URLConnection</a> æåŠï¼Œä½† NSURLConnection æœ¬èº«æ¯”è¾ƒç®€å•ï¼Œè€Œä¸”å·²ç»è¢«åºŸå¼ƒï¼ŒNSURLSession å°†ä¼šæ˜¯åé¢ç½‘ç»œè¯·æ±‚çš„æ ¸å¿ƒï¼Œå› æ­¤åœ¨è¿™é‡Œç³»ç»Ÿäº†è§£ä¸€ä¸‹ã€‚</p>
</blockquote>
<p>URL åŠ è½½ç³»ç»Ÿï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æ ¹æ® URL ä»æŸä¸ªåœ°æ–¹åŠ è½½èµ„æºï¼Œè¿™ä¸ªâ€œåŠ è½½â€æ˜¯å¹¿ä¹‰çš„ï¼Œæ—¢åŒ…æ‹¬ä»æœåŠ¡ç«¯ä¸‹è½½èµ„æºï¼Œä¹ŸåŒ…æ‹¬ä¸Šä¼ èµ„æºã€‚å®ƒæ”¯æŒ httpã€httpsã€ftpã€fileã€data èµ„æºä¼ è¾“åè®®ä»¥åŠè‡ªå®šä¹‰æ‰©å……åè®®ï¼Œç”±ä¸€ç»„è¾…åŠ©ç±»ä»¥åŠ Protocol ç»„æˆï¼Œä¸»è¦åˆ†ä¸ºäº”ä¸ªéƒ¨åˆ†ï¼š<a id="more"></a></p>
<ol>
<li>é…ç½®ç®¡ç†</li>
<li>ç¼“å­˜ç®¡ç†</li>
<li>cookie å­˜å‚¨</li>
<li>è®¤è¯å’Œè¯ä¹¦</li>
<li>è‡ªå®šä¹‰åè®®æ”¯æŒ</li>
</ol>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/NSURLSession-Family.png" height="320" alt="One Piece"></div>

<p>å®é™…ä¸Šæˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„ NSURLSession æŒ‡çš„å°±æ˜¯ä¸Šé¢ä¸€ç»„ç±»ï¼Œè€Œå¹¶ä¸å•å•æ˜¯æŒ‡ NSURLSession ç±»æœ¬èº«ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡å¯¹ NSURLSession ç”¨æ³•çš„å­¦ä¹ æ¥äº†è§£ä¸€ä¸‹è¿™äº”ä¸ªéƒ¨åˆ†ã€‚</p>
<blockquote>
<p>å›¾ä¸­å°† NSURLConnection ä¹Ÿåˆ—åœ¨å…¶ä¸­ï¼Œå®ƒä¹Ÿå±äº URL åŠ è½½ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚</p>
</blockquote>
<h2 id="ä½¿ç”¨-NSURLSession"><a href="#ä½¿ç”¨-NSURLSession" class="headerlink" title="ä½¿ç”¨ NSURLSession"></a>ä½¿ç”¨ NSURLSession</h2><p>NSURLSession ä»¥åŠç›¸å…³ç±»ä¸º Http è¯·æ±‚æä¾›äº†ç›¸å…³æ¥å£ï¼Œä¸ºäº†ä½¿ç”¨ NSURLSessionï¼Œéœ€è¦æˆ‘ä»¬åˆ›å»ºä¸€ç»„ session å¯¹è±¡ï¼Œæ¯ä¸€ä¸ª session å¯¹è±¡è´Ÿè´£æ‰§è¡Œä¸€ç»„æ•°æ®ä¼ è¾“ä»»åŠ¡ã€‚ä¸¾ä¸ªæ —å­ï¼Œå¦‚æœä½ åœ¨å¼€å‘ä¸€ä¸ªç½‘é¡µæµè§ˆå™¨ï¼Œä½ å¯èƒ½ä¼šä¸ºæ¯ä¸€ä¸ª Tab æˆ–è€… Window åˆ›å»ºä¸€ä¸ª sessionï¼Œæ¯ä¸ª session ä¼šè´Ÿè´£ä¸€ç»„ä¼ è¾“ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡ä»£è¡¨ç€å¯¹ä¸€ä¸ªç‰¹å®š URL æŒ‡å‘çš„èµ„æºçš„è¯·æ±‚ã€‚</p>
<p>å’Œ NSURLConnection ä¸€æ ·ï¼ŒNSURLSession å¯ä»¥é€šè¿‡ Block æˆ–è€… Delegate æ¥æ¥æ”¶å¤„ç†è¯·æ±‚è¿”å›çš„ç»“æœæ•°æ®ã€‚Block è¢«è®¾è®¡ä¸º Delegate çš„æ›¿æ¢é€‰æ‹©ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡è®¾ç½®äº† Blockï¼Œé‚£ä¹ˆ Delegate å°±ä¸ä¼šè¢«å›è°ƒã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒNSURLSession è¿˜æä¾›äº†å–æ¶ˆã€æš‚åœã€å”¤é†’ä»»åŠ¡çš„æ¥å£ã€‚</p>
<h3 id="URL-Session-ç›¸å…³æ¦‚å¿µ"><a href="#URL-Session-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="URL Session ç›¸å…³æ¦‚å¿µ"></a>URL Session ç›¸å…³æ¦‚å¿µ</h3><p>session ä¸­ä»»åŠ¡çš„è¡Œä¸ºå–å†³äºä¸‰ä¸ªå› ç´ ï¼š1ï¼‰session çš„ç±»å‹ï¼ˆå–å†³äºåˆ›å»ºæ—¶å€™çš„é…ç½®ï¼‰ï¼›2ï¼‰ä»»åŠ¡çš„ç±»å‹ï¼›3ï¼‰ä»»åŠ¡åˆ›å»ºçš„æ—¶å€™åº”ç”¨æ˜¯å¦å¤„äºå‰å°ã€‚</p>
<h4 id="session-ç±»å‹"><a href="#session-ç±»å‹" class="headerlink" title="session ç±»å‹"></a>session ç±»å‹</h4><p>NSURLSession æ”¯æŒä¸‰ç§ç±»å‹çš„ sessionï¼Œç”±åˆ›å»ºæ—¶å€™çš„é…ç½®å†³å®šï¼š</p>
<ul>
<li><strong>Default Session</strong> é»˜è®¤ session ä¸ Foundation ä¸­å…¶ä»–ä¸‹è½½ URL èµ„æºçš„æ–¹æ³•ç±»ä¼¼ï¼Œä½¿ç”¨åŸºäºç£ç›˜çš„ç¼“å­˜ï¼Œå¹¶å°†è¯ä¹¦å­˜å‚¨åœ¨ keychain ä¸­ï¼›</li>
<li><strong>Ephemeral Session</strong> è¿™ç§ç±»å‹çš„ session ä¸ä¼šåœ¨ç£ç›˜ä¸Šå­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œæ‰€æœ‰çš„ç¼“å­˜ã€è¯ä¹¦å­˜å‚¨ä»¥åŠå…¶ä»–æ•°æ®éƒ½ä¼šè¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä»…é™äºå½“å‰ session å¯ç”¨ï¼Œå› æ­¤å½“ä½ çš„åº”ç”¨å…³é—­è¿™ä¸ª sessionï¼Œç›¸å…³æ•°æ®ä¼šè‡ªåŠ¨è¢«æ¸…é™¤ï¼›</li>
<li><strong>Background Session</strong> å’Œ Default Session ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒæ˜¯åœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­è¿›è¡Œæ•°æ®ä¼ è¾“çš„ï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€äº›é¢å¤–çš„é™åˆ¶ï¼Œåé¢ä¼šç»†è¯´ã€‚</li>
</ul>
<h4 id="ä»»åŠ¡ç±»å‹"><a href="#ä»»åŠ¡ç±»å‹" class="headerlink" title="ä»»åŠ¡ç±»å‹"></a>ä»»åŠ¡ç±»å‹</h4><p>åœ¨ä¸€ä¸ª session é‡Œé¢ï¼ŒNSURLSession æ”¯æŒä¸‰ç§ç±»å‹çš„ä»»åŠ¡ï¼šæ•°æ®ä»»åŠ¡ï¼Œä¸‹è½½ä»»åŠ¡å’Œä¸Šä¼ ä»»åŠ¡ã€‚</p>
<ul>
<li><strong>æ•°æ®ä»»åŠ¡</strong> ä½¿ç”¨ NSData å‘é€å’Œæ¥å—æ•°æ®ï¼Œé€‚ç”¨äºæ¯”è¾ƒä¿¡æ¯é‡è¾ƒå°‘çš„æœåŠ¡ç«¯è¯·æ±‚ï¼Œæ•°æ®ä»»åŠ¡å¯ä»¥å°†æœåŠ¡ç«¯è¿”å›çš„æ•°æ®åˆ†æ‰¹äº¤ç»™åº”ç”¨ï¼Œåˆæˆ–è€…åœ¨å…¨éƒ¨æ¥æ”¶å®Œæˆä¹‹åé€šè¿‡ Block ä¸€æ¬¡æ€§è¿”å›ï¼›</li>
<li><strong>ä¸‹è½½ä»»åŠ¡</strong> ä»¥æ–‡ä»¶å½¢å¼æ¥æ”¶æ•°æ®ï¼Œå¹¶ä¸”æ”¯æŒå½“ App ä¸è¿è¡Œçš„æ—¶å€™åå°ä¸‹è½½ï¼›</li>
<li><strong>ä¸Šä¼ ä»»åŠ¡</strong> ä»¥æ–‡ä»¶å½¢å¼å‘é€æ•°æ®ï¼Œå¹¶ä¸”æ”¯æŒå½“ App ä¸è¿è¡Œçš„æ—¶å€™åå°ä¸Šä¼ ï¼›</li>
</ul>
<h4 id="åå°æ•°æ®ä¼ è¾“è€ƒé‡"><a href="#åå°æ•°æ®ä¼ è¾“è€ƒé‡" class="headerlink" title="åå°æ•°æ®ä¼ è¾“è€ƒé‡"></a>åå°æ•°æ®ä¼ è¾“è€ƒé‡</h4><p>NSURLSession æ”¯æŒå½“åº”ç”¨æŒ‚èµ·çš„æ—¶å€™åœ¨åå°è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œåå°ä¼ è¾“ä»…åœ¨ä½¿ç”¨ Background Session é…ç½®çš„æ—¶å€™èµ·ä½œç”¨ã€‚ç”±äºä½¿ç”¨ Background Session çš„æ—¶å€™ä¸‹è½½ä»»åŠ¡æ˜¯åœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­è¿›è¡Œçš„ï¼Œä¸”é‡å¯ä½ çš„ App æœ‰æ¯”è¾ƒå¤§çš„ä»£ä»·ï¼Œå› æ­¤ä½¿ç”¨è¿™ç§æ¨¡å¼æœ‰ä¸€äº›é™åˆ¶ï¼š</p>
<p>// TODO</p>
<h4 id="ç”Ÿå‘½å‘¨æœŸå’Œ-Delegate-äº¤äº’"><a href="#ç”Ÿå‘½å‘¨æœŸå’Œ-Delegate-äº¤äº’" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸå’Œ Delegate äº¤äº’"></a>ç”Ÿå‘½å‘¨æœŸå’Œ Delegate äº¤äº’</h4><p>ç†è§£è¿™ä¸ªç‚¹å–å†³äºä½ ä½¿ç”¨ NSURLSession ç±»æ¥å¹²ä»€ä¹ˆï¼Œæœ‰å¯èƒ½éœ€è¦ç†è§£ session ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ session å¦‚ä½•ä¸delegate äº¤äº’ï¼Œ delegate æ¥å£çš„è°ƒç”¨é¡ºåºï¼ŒæœåŠ¡ç«¯é‡å®šå‘èµ„æºåä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå½“ App é‡å¯ä¸€ä¸ªå¤±è´¥çš„ä¸‹è½½åä¼šå‘ç”Ÿä»€ä¹ˆï¼Œç­‰ç­‰ã€‚åé¢ä¼šè¯¦è¿°ã€‚</p>
<h4 id="NSCoping-è¡Œä¸º"><a href="#NSCoping-è¡Œä¸º" class="headerlink" title="NSCoping è¡Œä¸º"></a>NSCoping è¡Œä¸º</h4><p>Session å’Œä»»åŠ¡å¯¹è±¡éµä» NSCopying åè®®ï¼Œå¹¶æœ‰å¦‚ä¸‹å®ç°ï¼š</p>
<ul>
<li>æ‹·è´ session å’Œä»»åŠ¡å¯¹è±¡ï¼Œä¼šå¾—åˆ°ç›¸åŒçš„å¯¹è±¡ï¼›</li>
<li>æ‹·è´é…ç½®å¯¹è±¡ï¼Œä¼šå¾—åˆ°æ–°çš„å¯¹è±¡ï¼Œå¯ä»¥ç‹¬ç«‹ä¿®æ”¹ï¼›</li>
</ul>
<h3 id="åˆ›å»ºå¹¶é…ç½®-Session"><a href="#åˆ›å»ºå¹¶é…ç½®-Session" class="headerlink" title="åˆ›å»ºå¹¶é…ç½® Session"></a>åˆ›å»ºå¹¶é…ç½® Session</h3><p>NSURLSession æä¾›äº†ä¸°å¯Œçš„é…ç½®é¡¹ï¼š</p>
<ul>
<li>å•ä¸ª session ç‰¹æœ‰çš„å­˜å‚¨é…ç½®ï¼ŒåŒ…æ‹¬ç¼“å­˜ã€cookieã€è¯ä¹¦ï¼Œä»¥åŠåè®®ï¼›</li>
<li>ç»‘å®šåˆ°å•ä¸ªä»»åŠ¡æˆ–è€… session çš„èº«ä»½è®¤è¯ä¿¡æ¯ï¼›</li>
<li>ä¸Šä¼ å’Œä¸‹è½½ä»»åŠ¡ï¼Œå¹¶æ”¯æŒåˆ†ç¦»æ•°æ®ï¼ˆæ–‡ä»¶å†…å®¹ï¼‰å’Œå…ƒæ•°æ®ï¼ˆURL å’Œ è®¾ç½®ï¼‰ï¼›</li>
<li>é…ç½®åˆ°æ¯ä¸ª Host çš„æœ€å¤§è¿æ¥æ•°ï¼›</li>
<li>å¦‚æœæ•´ä¸ªèµ„æºä¸èƒ½åœ¨æŸä¸ªæ—¶é—´å†…è¢«ä¸‹è½½ä¸‹æ¥ï¼Œé‚£ä¹ˆæ¯ä¸ªç»„æˆèµ„æºéƒ½ä¼šè¢«å¤„ç½šè¶…æ—¶ï¼›</li>
<li>æ”¯æŒçš„ TLS ç‰ˆæœ¬èŒƒå›´è®¾ç½®ï¼›</li>
<li>è‡ªå®šä¹‰ä»£ç†å­—å…¸ï¼›</li>
<li>ç¼“å­˜ç­–ç•¥ï¼›</li>
<li>Http ç®¡é“è¡Œä¸ºæ§åˆ¶ï¼›</li>
</ul>
<p>å› ä¸ºå¤§éƒ¨åˆ†çš„é…ç½®é¡¹éƒ½åŒ…å«åœ¨ä¸€ä¸ªå•ç‹¬çš„é…ç½®é…ç½®é¡¹ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é‡ç”¨é€šç”¨çš„è®¾ç½®ï¼Œå½“ä¸€ä¸ª session å¯¹è±¡è¢«åˆå§‹åŒ–ä¹‹åï¼Œéœ€è¦å®Œæˆï¼š</p>
<ul>
<li>ä¸€ä¸ªæ§åˆ¶ session å’Œ session å†…ä»»åŠ¡è¡Œä¸ºçš„é…ç½®ç‹¬äº«ï¼›</li>
<li>ä¸€ä¸ªç”¨äºå¤„ç†åŠ è½½æ•°æ®å’Œäº‹ä»¶çš„ delegateï¼Œè¿›è¡ŒæœåŠ¡ç«¯èº«ä»½è®¤è¯ï¼Œå†³å®šä¸€ä¸ªèµ„æºåŠ è½½æ˜¯å¦éœ€è¦è¢«è½¬åŒ–ä¸ºä¸‹è½½ç­‰å·¥ä½œï¼Œè¿™æ˜¯å¯é€‰çš„ï¼›</li>
</ul>
<p>å¦‚æœå¼€å‘è€…ä¸æä¾›è‡ªå®šä¹‰ delegateï¼Œ NSURLSession ä¼šä½¿ç”¨ç³»ç»Ÿæä¾›çš„ delegateã€‚ä½†æ˜¯å¦‚æœä½ è¦è¿›è¡Œåå°æ•°æ®ä¼ è¾“ä»»åŠ¡ï¼Œå°±å¿…é¡»æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„ delegateã€‚</p>
<p>å½“ä¸€ä¸ª session åˆå§‹åŒ–å®Œæ¯•ä¹‹åï¼Œå¼€å‘è€…å°±æ— æ³•å†æ›´æ”¹é…ç½®å¯¹è±¡æˆ–è€…ä»£ç†äº†ï¼Œé™¤éåˆ›å»ºä¸€ä¸ªæ–°çš„ sessionã€‚</p>
<p>ä¸‹é¢ä»£ç å±•ç¤ºäº†å¦‚ä½•ä¸‰ç§ç±»å‹çš„ sessionï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// Creating session configurations</span><br><span class="line">NSURLSessionConfiguration *defaultConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</span><br><span class="line">NSURLSessionConfiguration *ephemeralConfiguration = [NSURLSessionConfiguration ephemeralSessionConfiguration];</span><br><span class="line">NSURLSessionConfiguration *backgroundConfiguration = [NSURLSessionConfiguration backgroundSessionConfigurationWithIdentifier: @&quot;com.myapp.networking.background&quot;];</span><br><span class="line"> </span><br><span class="line">// Configuring caching behavior for the default session</span><br><span class="line">NSString *cachesDirectory = NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES).firstObject;</span><br><span class="line">NSString *cachePath = [cachesDirectory stringByAppendingPathComponent:@&quot;MyCache&quot;];</span><br><span class="line"> </span><br><span class="line">/* Note:</span><br><span class="line"> iOS requires the cache path to be</span><br><span class="line"> a path relative to the ~/Library/Caches directory,</span><br><span class="line"> but OS X expects an absolute path.</span><br><span class="line"> */</span><br><span class="line">#if TARGET_OS_OSX</span><br><span class="line">cachePath = [cachePath stringByStandardizingPath];</span><br><span class="line">#endif</span><br><span class="line"> </span><br><span class="line">NSURLCache *cache = [[NSURLCache alloc] initWithMemoryCapacity:16384 diskCapacity:268435456 diskPath:cachePath];</span><br><span class="line">defaultConfiguration.URLCache = cache;</span><br><span class="line">defaultConfiguration.requestCachePolicy = NSURLRequestUseProtocolCachePolicy;</span><br><span class="line"> </span><br><span class="line">// Creating sessions</span><br><span class="line">id &lt;NSURLSessionDelegate&gt; delegate = [[MySessionDelegate alloc] init];</span><br><span class="line">NSOperationQueue *operationQueue = [NSOperationQueue mainQueue];</span><br><span class="line"> </span><br><span class="line">NSURLSession *defaultSession = [NSURLSession sessionWithConfiguration:defaultConfiguration delegate:delegate operationQueue:operationQueue];</span><br><span class="line">NSURLSession *ephemeralSession = [NSURLSession sessionWithConfiguration:ephemeralConfiguration delegate:delegate delegateQueue:operationQueue];</span><br><span class="line">NSURLSession *backgroundSession = [NSURLSession sessionWithConfiguration:backgroundConfiguration delegate:delegate delegateQueue:operationQueue];</span><br></pre></td></tr></table></figure>
<p>é™¤äº† Background Session çš„é…ç½®ï¼Œå¼€å‘è€…å¯ä»¥å¤ç”¨é…ç½®å¯¹è±¡åˆ›å»ºä»»æ„çš„ sessionï¼ˆBackground session çš„é…ç½®å¯¹è±¡ä¹‹æ‰€ä»¥ä¸èƒ½å¤ç”¨ï¼Œæ˜¯å› ä¸ºå¦‚æœä¸¤ä¸ª Background Session çš„ identifier ä¸€æ ·ï¼Œä¼šå‘ç”Ÿä¸å¯é¢„çŸ¥çš„è¡Œä¸ºï¼‰ã€‚</p>
<p>å¼€å‘è€…ä»‹æ„åœ¨ä»»ä½•æ—¶å€™ä¿®æ”¹é…ç½®ï¼Œå› ä¸ºå½“ä½ åˆ›å»ºä¸€ä¸ª session çš„æ—¶å€™ï¼Œé…ç½®å¯¹è±¡å°±ä¼šè¢«æ·±åº¦æ‹·è´ï¼Œå› æ­¤ä¿®æ”¹é…ç½®ä¸ä¼šå½±å“å·²ç»åˆ›å»ºçš„ sessionã€‚ä¸¾ä¸ªæ —å­ï¼Œä½ æˆ–è®¸ä¼šåˆ›å»ºæ–°çš„ sessionï¼Œå¹¶è¦æ±‚åªèƒ½åœ¨é“¾æ¥ wifi çš„æƒ…å†µä¸‹ä¸‹è½½èµ„æºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ephemeralConfiguration.allowsCellularAccess = NO;</span><br><span class="line">NSURLSession *ephemeralSessionWiFiOnly = [NSURLSession sessionWithConfiguration:ephemeralConfiguration delegate:delegate delegateQueue:operationQueue];</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨ç³»ç»Ÿæä¾›çš„-Delegate-æ‹‰å–èµ„æº"><a href="#ä½¿ç”¨ç³»ç»Ÿæä¾›çš„-Delegate-æ‹‰å–èµ„æº" class="headerlink" title="ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ Delegate æ‹‰å–èµ„æº"></a>ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ Delegate æ‹‰å–èµ„æº</h3><p>ä½¿ç”¨ NSURLSession æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ Delegate æ¥è¯·æ±‚èµ„æºï¼Œå¼€å‘è€…åªéœ€è¦æä¾›ä¸¤æ®µä»£ç æ¥å®ç°è¿™ç§æ–¹å¼çš„ä½¿ç”¨ï¼š</p>
<ul>
<li>ä¸€æ®µä»£ç åˆ›å»ºé…ç½®å¯¹è±¡ä»¥åŠåŸºäºé…ç½®å¯¹è±¡çš„ sessionï¼›</li>
<li>åœ¨æ•°æ®å…¨éƒ¨æ¥æ”¶å®Œæˆåå¤„ç†æ•°æ®çš„ Blockï¼›</li>
</ul>
<p>ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ Delegateï¼Œæ¯ä¸ªèµ„æºè¯·æ±‚åªéœ€è¦ä¸€è¡Œä»£ç å°±å¯ä»¥æå®šï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NSURLSession *sessionWithoutADelegate = [NSURLSession sessionWithConfiguration:defaultConfiguration];</span><br><span class="line">NSURL *url = [NSURL URLWithString:@&quot;https://www.example.com/&quot;];</span><br><span class="line"> </span><br><span class="line">[[sessionWithoutADelegate dataTaskWithURL:url completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;Got response %@ with error %@.\n&quot;, response, error);</span><br><span class="line">    NSLog(@&quot;DATA:\n%@\nEND DATA\n&quot;, [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span><br><span class="line">&#125;] resume];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç³»ç»Ÿæä¾›çš„ delegate åªå®šä¹‰äº†æœ‰é™çš„ç½‘ç»œè¡Œä¸ºï¼Œå¦‚æœ App æœ‰ç‰¹æ®Šçš„éœ€è¦ï¼Œæ¯”å¦‚è‡ªå®šä¹‰çš„è®¤è¯æˆ–è€…åå°ä¸‹è½½ï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸åˆé€‚çš„ã€‚</p>
</blockquote>
<h3 id="ä½¿ç”¨è‡ªå®šä¹‰çš„-Delegate-æ‹‰å–æ•°æ®"><a href="#ä½¿ç”¨è‡ªå®šä¹‰çš„-Delegate-æ‹‰å–æ•°æ®" class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰çš„ Delegate æ‹‰å–æ•°æ®"></a>ä½¿ç”¨è‡ªå®šä¹‰çš„ Delegate æ‹‰å–æ•°æ®</h3><p>å¦‚æœä½ ä½¿ç”¨è‡ªå®šä¹‰çš„ Delegate æ‹‰å–æ•°æ®ï¼ŒDelegate å¿…é¡»å®ç°è‡³å°‘å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>URLSession:dataTask:didReceiveData:</code> ä¼šåˆ†æ‰¹åå‡ºæœåŠ¡ç«¯è¿”å›çš„æ•°æ®ã€‚</li>
<li><code>URLSession:task:didCompleteWithError:</code> ä¼šå‘Šè¯‰ App æ•°æ®å…¨éƒ¨æ¥æ”¶å®Œæ¯•ã€‚</li>
</ul>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ App éœ€è¦ä½¿ç”¨å®Œæ•´çš„æ•°æ®ï¼Œå°±éœ€è¦è‡ªå·±å­˜å‚¨æ•°æ®ã€‚ä¸¾ä¸ªæ —å­ï¼Œç½‘é¡µæµè§ˆå™¨å¯èƒ½éœ€è¦æ¸²æŸ“å½“å‰æ¥æ”¶åˆ°çš„æ•°æ®å’Œä¹‹å‰æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œå› æ­¤ï¼Œå®ƒå¯èƒ½éœ€è¦ <code>appendData:</code> æ¥ä¸åœçš„å°†æ–°æ”¶åˆ°çš„æ•°æ®ä¿å­˜ä¸‹æ¥ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºå’Œå¯åŠ¨ä¸€ä¸ªæ•°æ®ä»»åŠ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSURL *url = [NSURL URLWithString: @&quot;https://www.example.com/&quot;];</span><br><span class="line">NSURLSessionDataTask *dataTask = [defaultSession dataTaskWithURL:url];</span><br><span class="line">[dataTask resume];</span><br></pre></td></tr></table></figure>
<h3 id="ä¸‹è½½æ–‡ä»¶"><a href="#ä¸‹è½½æ–‡ä»¶" class="headerlink" title="ä¸‹è½½æ–‡ä»¶"></a>ä¸‹è½½æ–‡ä»¶</h3><p>æ–‡ä»¶ä¸‹è½½å…¶å®å’Œæ‹‰å–æ•°æ®ç±»ä¼¼ï¼Œä½¿ç”¨çš„æ—¶å€™åº”è¯¥è¦å®ç°ä»¥ä¸‹ deleggate æ–¹æ³•ï¼š</p>
<ul>
<li><p><code>URLSession:downloadTask:didFinishDownloadingToURL:</code> å‘ŠçŸ¥ App æŒ‡å‘ä¸‹è½½å†…å®¹ä¸´æ—¶å­˜å‚¨æ–‡ä»¶çš„ URLï¼›</p>
<blockquote>
<p>è¿™ä¸ªæ–¹æ³•è¿”å›ä¹‹å‰ï¼Œå®ƒå¿…é¡»æ‰“å¼€æ–‡ä»¶è¯»å–å…¶ä¸­çš„æ•°æ®æˆ–è€…å°†æ–‡ä»¶ç§»åŠ¨åˆ°ä¸€ä¸ªæ°¸ä¹…çš„åœ°å€ï¼Œå› ä¸ºå½“è¿™ä¸ªæ–¹æ³•è¿”å›åï¼Œä¸´æ—¶æ–‡ä»¶å°±ä¼šè¢«åˆ é™¤ã€‚</p>
</blockquote>
</li>
<li><p><code>URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesExpectedToWrite:</code> å‘ŠçŸ¥ App ä¸‹è½½è¿›åº¦ï¼›</p>
</li>
<li><p><code>URLSession:downloadTask:didResumeAtOffset:expectedTotalBytes:</code> å‘ŠçŸ¥ App å®ƒæˆåŠŸé‡å¯äº†ä¸€ä¸ªå¤±è´¥çš„ä¸‹è½½ï¼›</p>
</li>
<li><p><code>URLSession:task:didCompleteWithError:</code> å‘ŠçŸ¥ App ä¸‹è½½å¤±è´¥äº†ï¼›</p>
</li>
</ul>
<p>å¦‚æœä½ åœ¨ä¸€ä¸ª Background Session ä¸­è°ƒåº¦ä¸‹è½½ä»»åŠ¡ï¼Œå³ä½¿ App ä¸è¿è¡Œäº†ï¼Œä¸‹è½½ä»»åŠ¡ä¾ç„¶ä¼šè¿è¡Œï¼›å¦‚æœæ˜¯åœ¨ Default / Ephemeral Session ä¸­è°ƒåº¦ä¸‹è½½ä»»åŠ¡ï¼Œåº”ç”¨é‡å¯ä¹‹åå¿…é¡»é‡æ–°å¼€å¯ä¸‹è½½ä»»åŠ¡ã€‚</p>
<p>å½“ä»æœåŠ¡ç«¯æ‹‰å–æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœç”¨æˆ·é€‰æ‹©æš‚åœä¸‹è½½ï¼ŒApp å¯ä»¥é€šè¿‡è°ƒç”¨<code>cancelByProducingResumeData:</code> æ–¹æ³•æ¥å–æ¶ˆä»»åŠ¡ï¼Œä¹‹åï¼ŒApp å¯ä»¥é€šè¿‡å°†å·²ç»ä¸‹è½½çš„æ•°æ®ä¼ é€’ç»™<code>downloadTaskWithResumeData:</code> æˆ–è€… <code>downloadTaskWithResumeData:</code> æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡ç»§ç»­ä¸‹è½½ã€‚</p>
<p>å¦‚æœæ•°æ®ä¼ è¾“å¤±è´¥ï¼Œdelegate çš„ <code>URLSession:task:didCompleteWithError:</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ä¸‹è½½ä¸€ä¸ªä¸­ç­‰å¤§å°æ–‡ä»¶çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSURL *url = [NSURL URLWithString:@&quot;https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/ObjC_classic/FoundationObjC.pdf&quot;];</span><br><span class="line">NSURLSessionDownloadTask *downloadTask = [backgroundSession downloadTaskWithURL:url];</span><br><span class="line">[downloadTask resume];</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ delegate å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSession:(NSURLSession *)session</span><br><span class="line">      downloadTask:(NSURLSessionDownloadTask *)downloadTask</span><br><span class="line">      didWriteData:(int64_t)bytesWritten</span><br><span class="line"> totalBytesWritten:(int64_t)totalBytesWritten</span><br><span class="line">totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;Session %@ download task %@ wrote an additional %lld bytes (total %lld bytes) out of an expected %lld bytes.\n&quot;, session, downloadTask, bytesWritten, totalBytesWritten, totalBytesExpectedToWrite);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (void)URLSession:(NSURLSession *)session</span><br><span class="line">      downloadTask:(NSURLSessionDownloadTask *)downloadTask</span><br><span class="line"> didResumeAtOffset:(int64_t)fileOffset</span><br><span class="line">expectedTotalBytes:(int64_t)expectedTotalBytes</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;Session %@ download task %@ resumed at offset %lld bytes out of an expected %lld bytes.\n&quot;, session, downloadTask, fileOffset, expectedTotalBytes);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (void)URLSession:(NSURLSession *)session</span><br><span class="line">      downloadTask:(NSURLSessionDownloadTask *)downloadTask</span><br><span class="line">didFinishDownloadingToURL:(NSURL *)location</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;Session %@ download task %@ finished downloading to URL %@\n&quot;, session, downloadTask, location);</span><br><span class="line"> </span><br><span class="line">    // Perform the completion handler for the current session</span><br><span class="line">    self.completionHandlers[session.configuration.identifier]();</span><br><span class="line"> </span><br><span class="line">   // Open the downloaded file for reading</span><br><span class="line">    NSError *readError = nil;</span><br><span class="line">    NSFileHandle *fileHandle = [NSFileHandle fileHandleForReadingFromURL:location error:readError];</span><br><span class="line">    // ...</span><br><span class="line"> </span><br><span class="line">   // Move the file to a new URL</span><br><span class="line">    NSFileManager *fileManager = [NSFileManager defaultManager];</span><br><span class="line">    NSURL *cacheDirectory = [[fileManager URLsForDirectory:NSCachesDirectory inDomains:NSUserDomainMask] firstObject];</span><br><span class="line">    NSError *moveError = nil;</span><br><span class="line">    if ([fileManager moveItemAtURL:location toURL:cacheDirectory error:moveError]) &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸Šä¼ æ¶ˆæ¯ä½“å†…å®¹"><a href="#ä¸Šä¼ æ¶ˆæ¯ä½“å†…å®¹" class="headerlink" title="ä¸Šä¼ æ¶ˆæ¯ä½“å†…å®¹"></a>ä¸Šä¼ æ¶ˆæ¯ä½“å†…å®¹</h3><p>App å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼ä¸º HTTP POST æ¶ˆæ¯æä¾›æ¶ˆæ¯ä½“ï¼šNSDataã€æ–‡ä»¶æˆ–è€…æµã€‚æ€»çš„æ¥è¯´ï¼Œä½ çš„ App åº”è¯¥ï¼š</p>
<ul>
<li>å¦‚æœå†…å­˜ä¸­å·²ç»å­˜åœ¨ä¸€ä¸ª NSData å¯¹è±¡å¹¶ä¸”æ²¡æœ‰ç†ç”±åºŸå¼ƒå®ƒï¼ˆæ¯”å¦‚å†…å­˜é—®é¢˜ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒï¼›</li>
<li>å¦‚æœä¸Šä¼ å†…å®¹æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜åœ¨äºç£ç›˜ä¸Šçš„ï¼Œæˆ–è€…ä½ æ˜¯åœ¨è¿›è¡Œåå°ä¼ è¾“ä»»åŠ¡ï¼Œåˆæˆ–è€… App æœ‰å¿…è¦å°†æ•°æ®å†™åˆ°ç£ç›˜ä¸Šæ¥é‡Šæ”¾é‚£éƒ¨åˆ†æ•°æ®å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œé‚£ä¹ˆä½¿ç”¨æ–‡ä»¶å³å¯ï¼›</li>
<li>å¦‚æœä½ æ˜¯ä»ç½‘ç»œä¸Šæ¥æ”¶æ•°æ®ï¼Œé‚£ä¹ˆä½¿ç”¨æµï¼›</li>
</ul>
<p>ä¸ç®¡ä½ é€‰æ‹©ä½•ç§æ–¹å¼ä¸Šä¼ ï¼Œå¦‚æœä½ çš„ App è‡ªå®šä¹‰äº† session delegateï¼Œå®ƒéƒ½åº”è¯¥å®ç° <code>URLSession:task:didSendBodyData:totalBytesSent:totalBytesExpectedToSend:</code> æ–¹æ³•æ¥è·å–ä¸Šä¼ è¿›åº¦ä¿¡æ¯ï¼›</p>
<p>å¦å¤–ï¼Œå¦‚æœä½ çš„ App æ˜¯é€šè¿‡æµçš„å½¢å¼æä¾›æ¶ˆæ¯ä½“çš„ï¼Œå®ƒå¿…é¡»æä¾›è‡ªå®šä¹‰çš„ session delegate å¹¶å®ç° <code>URLSession:task:needNewBodyStream:</code> æ–¹æ³•ï¼Œä¸‹é¢ä¼šè¯¦ç»†è§£é‡Šã€‚</p>
<h4 id="ä½¿ç”¨-NSData-ä¸Šä¼ æ•°æ®"><a href="#ä½¿ç”¨-NSData-ä¸Šä¼ æ•°æ®" class="headerlink" title="ä½¿ç”¨ NSData ä¸Šä¼ æ•°æ®"></a>ä½¿ç”¨ NSData ä¸Šä¼ æ•°æ®</h4><p>ä½¿ç”¨ NSData è¿›è¡Œä¸Šä¼ ï¼ŒApp å¿…é¡»é€šè¿‡è°ƒç”¨ <code>uploadTaskWithRequest:fromData:</code> æˆ–è€… <code>uploadTaskWithRequest:fromData:completionHandler:</code> æ–¹æ³•æ¥åˆ›å»ºä¸Šä¼ ä»»åŠ¡ï¼Œå¹¶åœ¨ <code>fromData:</code> å‚æ•°ä¸­ä¼ å…¥æ•°æ®å¯¹è±¡ã€‚session å¯¹è±¡ä¼šæ ¹æ® NSData å¯¹è±¡è®¡ç®— <code>Content-Length</code> Header çš„å€¼ï¼ŒæœåŠ¡å™¨éœ€è¦çš„å…¶ä½™å‚æ•°éœ€è¦å¼€å‘è€…æ‰‹åŠ¨æä¾›ï¼Œæ¯”å¦‚ <code>Content-Type</code>ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ NSData è¿›è¡Œæ•°æ®ä¸Šä¼ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NSURL *textFileURL = [NSURL fileURLWithPath:@&quot;/path/to/file.txt&quot;];</span><br><span class="line">NSData *data = [NSData dataWithContentsOfURL:textFileURL];</span><br><span class="line"> </span><br><span class="line">NSURL *url = [NSURL URLWithString:@&quot;https://www.example.com/&quot;];</span><br><span class="line">NSMutableURLRequest *mutableRequest = [NSMutableURLRequest requestWithURL:url];</span><br><span class="line">mutableRequest.HTTPMethod = @&quot;POST&quot;;</span><br><span class="line">[mutableRequest setValue:[NSString stringWithFormat:@&quot;%lld&quot;, data.length] forHTTPHeaderField:@&quot;Content-Length&quot;];</span><br><span class="line">[mutableRequest setValue:@&quot;text/plain&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line"> </span><br><span class="line">NSURLSessionUploadTask *uploadTask = [defaultSession uploadTaskWithRequest:mutableRequest fromData:data];</span><br><span class="line">[uploadTask resume];</span><br></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ•°æ®"><a href="#ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ•°æ®" class="headerlink" title="ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ•°æ®"></a>ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ•°æ®</h4><p>ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ•°æ®ï¼ŒApp å¿…é¡»é€šè¿‡è°ƒç”¨ <code>uploadTaskWithRequest:fromFile:</code> æˆ–è€… <code>uploadTaskWithRequest:fromFile:completionHandler:</code> æ–¹æ³•æ¥åˆ›å»ºä¸Šä¼ ä»»åŠ¡ï¼Œå¹¶ä¸”æä¾›æ–‡ä»¶çš„ URL ä»¥ä¾›ä»»åŠ¡è¯»å–ä¸Šä¼ æ•°æ®ã€‚session å¯¹è±¡ä¼šæ ¹æ®æ–‡ä»¶å¯¹è±¡è®¡ç®— <code>Content-Length</code> Header çš„å€¼ï¼Œå¦‚æœ App æ²¡æœ‰è®¾ç½® <code>Content-Type</code>  Headerï¼Œsession ä¹Ÿä¼šæä¾›ä¸€ä¸ªã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡æ–‡ä»¶è¿›è¡Œæ•°æ®ä¸Šä¼ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NSURL *textFileURL = [NSURL fileURLWithPath:@&quot;/path/to/file.txt&quot;];</span><br><span class="line"> </span><br><span class="line">NSURL *url = [NSURL URLWithString:@&quot;https://www.example.com/&quot;];</span><br><span class="line">NSMutableURLRequest *mutableRequest = [NSMutableURLRequest requestWithURL:url];</span><br><span class="line">mutableRequest.HTTPMethod = @&quot;POST&quot;;</span><br><span class="line"> </span><br><span class="line">NSURLSessionUploadTask *uploadTask = [defaultSession uploadTaskWithRequest:mutableRequest fromFile:textFileURL];</span><br><span class="line">[uploadTask resume];</span><br></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨æµä¸Šä¼ æ•°æ®"><a href="#ä½¿ç”¨æµä¸Šä¼ æ•°æ®" class="headerlink" title="ä½¿ç”¨æµä¸Šä¼ æ•°æ®"></a>ä½¿ç”¨æµä¸Šä¼ æ•°æ®</h4><p>ä½¿ç”¨æµä¸Šä¼ æ•°æ®ï¼Œå¿…é¡»é€šè¿‡è°ƒç”¨ <code>uploadTaskWithStreamedRequest:</code> æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªä¸Šä¼ ä»»åŠ¡ï¼ŒApp å¿…é¡»ä¸ºè¿™ä¸ªæ–¹æ³•æä¾›ä¸€ä¸ªä¸Šä¼ æ•°æ®å¯¹è±¡çš„å…³è”æµã€‚App åŒæ—¶å¿…é¡»æä¾›ä¸€äº›æœåŠ¡å™¨éœ€è¦çš„ Header å­—æ®µï¼Œæ¯”å¦‚ <code>Content-Type</code> å’Œ <code>Content-Length</code>ã€‚</p>
<p>å¦å¤–ï¼Œsession å¦‚æœé‡åˆ°å¿…é¡»é‡æ–°å°è¯•ä¸€ä¸ªè¯·æ±‚çš„æƒ…å†µï¼Œæ¯”å¦‚å¦‚æœèº«ä»½éªŒè¯å¤±è´¥ï¼Œå°±å¿…é¡»é‡æ–°è¯»å–æµï¼Œä½†æ˜¯æµä¸ä¸€å®šèƒ½å¤Ÿå€’å›å»é‡æ–°è¯»å–ï¼Œè¿™ä¸ªæ—¶å€™ App å°±å¿…é¡»è´Ÿè´£é‡æ–°æä¾›ä¸€ä¸ªæ–°çš„æµã€‚å› æ­¤ï¼ŒApp éœ€è¦å®ç° <code>URLSession:task:needNewBodyStream:</code> æ–¹æ³•ï¼Œå½“è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼ŒApp åº”è¯¥å°½é‡æä¾›ä¸€ä¸ªæ–°çš„æµï¼Œç„¶åä»¥ æ–°çš„æµä¸ºå‚æ•°è°ƒç”¨ completion handler blockã€‚</p>
<blockquote>
<p>è¿™ç§æŠ€æœ¯ä¸èƒ½å’Œç³»ç»Ÿæä¾›çš„ delegate å…¼å®¹ã€‚</p>
</blockquote>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡æµè¿›è¡Œæ•°æ®ä¸Šä¼ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NSURL *textFileURL = [NSURL fileURLWithPath:@&quot;/path/to/file.txt&quot;];</span><br><span class="line"> </span><br><span class="line">NSURL *url = [NSURL URLWithString:@&quot;https://www.example.com/&quot;];</span><br><span class="line">NSMutableURLRequest *mutableRequest = [NSMutableURLRequest requestWithURL:url];</span><br><span class="line">mutableRequest.HTTPMethod = @&quot;POST&quot;;</span><br><span class="line">mutableRequest.HTTPBodyStream = [NSInputStream inputStreamWithFileAtPath:textFileURL.path];</span><br><span class="line">[mutableRequest setValue:@&quot;text/plain&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line">[mutableRequest setValue:[NSString stringWithFormat:@&quot;%lld&quot;, data.length] forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line"> </span><br><span class="line">NSURLSessionUploadTask *uploadTask = [defaultSession uploadTaskWithStreamedRequest:mutableRequest];</span><br><span class="line">[uploadTask resume];</span><br></pre></td></tr></table></figure>
<h2 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h2><p>URL åŠ è½½ç³»ç»Ÿä¸ºè¯·æ±‚å’Œå“åº”æä¾›äº†ç£ç›˜ç¼“å­˜å’Œå†…å­˜ç¼“å­˜ï¼Œè¿™ä¸ªè®¾è®¡è®©åº”ç”¨ä»‹ç»äº†å¯¹ç½‘ç»œçš„ä¾èµ–ï¼Œæé«˜äº†æ€§èƒ½ã€‚</p>
<h3 id="ç¼“å­˜ç­–ç•¥"><a href="#ç¼“å­˜ç­–ç•¥" class="headerlink" title="ç¼“å­˜ç­–ç•¥"></a>ç¼“å­˜ç­–ç•¥</h3><p>NSURLRequest é€šè¿‡è®¾ç½®ç¼“å­˜ç­–ç•¥æ¥æŒ‡å®šå¦‚ä½•ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œç¼“å­˜ç­–ç•¥çš„å€¼æ˜¯ç”±æšä¸¾ <code>NSURLRequestCachePolicy</code> æŒ‡å®šçš„ï¼ŒåŒ…æ‹¬ï¼š<code>NSURLRequestUseProtocolCachePolicy</code>, <code>NSURLRequestReloadIgnoringCacheData</code>, <code>NSURLRequestReturnCacheDataElseLoad</code>, å’Œ <code>NSURLRequestReturnCacheDataDontLoad</code>ã€‚<code>NSURLRequestUseProtocolCachePolicy</code> æ˜¯é»˜è®¤çš„ç¼“å­˜ç­–ç•¥ï¼Œå®ƒæ˜¯æ ¹æ®åè®®è§„èŒƒå®ç°çš„ï¼› <code>NSURLRequestReloadIgnoringCacheData</code> è¡¨ç¤ºå®Œå…¨å¿½ç•¥æœ¬åœ°ç¼“å­˜ï¼›<code>NSURLRequestReturnCacheDataElseLoad</code> è¡¨ç¤ºåªè¦æœ‰ç¼“å­˜ï¼Œä¸è®ºæ˜¯å¦è¿‡æœŸç›´æ¥ä½¿ç”¨ï¼Œæ²¡æœ‰ç¼“å­˜æ‰ä»è¿œç«¯åŠ è½½ï¼›<code>NSURLRequestReturnCacheDataDontLoad</code> è¡¨ç¤ºåªä»ç¼“å­˜åŠ è½½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ç¦»çº¿æ¨¡å¼ã€‚</p>
<blockquote>
<p>Http çš„æ ‡å‡†ç¼“å­˜æœºåˆ¶å¯è§ï¼š<a href="[http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13](http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13">RFC 2616, Section 13</a>)ã€‚</p>
</blockquote>
<h3 id="ç¼“å­˜æ§åˆ¶"><a href="#ç¼“å­˜æ§åˆ¶" class="headerlink" title="ç¼“å­˜æ§åˆ¶"></a>ç¼“å­˜æ§åˆ¶</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¯·æ±‚ä¼šåŸºäºç¼“å­˜ç­–ç•¥è¿›è¡Œç¼“å­˜ã€‚å¦‚æœå¼€å‘è€…éœ€è¦æ›´åŠ ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥é€šè¿‡å®ç° delegate æ–¹æ³•æ¥å†³å®šæ¯ä¸ªè¯·æ±‚çš„å“åº”å¦‚ä½•è¿›è¡Œç¼“å­˜ã€‚å¯¹äº NSURLSession çš„æ•°æ®ä»»åŠ¡å’Œä¸Šä¼ ä»»åŠ¡ï¼Œéœ€è¦å®ç° <code>URLSession:dataTask:willCacheResponse:completionHandler:</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨æ‰§è¡Œæ•°æ®ä»»åŠ¡å’Œä¸Šä¼ ä»»åŠ¡çš„æ—¶å€™æ‰ä¼šè¢«è°ƒç”¨ã€‚ä¸‹è½½ä»»åŠ¡çš„ç¼“å­˜åªèƒ½ç”±è®¾ç½®çš„ç¼“å­˜ç­–ç•¥æ§åˆ¶ã€‚</p>
<p>delegate æ–¹æ³•é€šè¿‡è°ƒç”¨ completion handler æ¥å‘ŠçŸ¥ session åº”è¯¥å¦‚ä½•åšç¼“å­˜ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>ç›´æ¥è¿”å›æä¾›çš„å“åº”ï¼›</li>
<li>ä¿®æ”¹æä¾›çš„å“åº”å¹¶è¿”å›ä¸€ä¸ªæ–°çš„å“åº”ï¼›</li>
<li>è¿”å› nil æ‹’ç»ç¼“å­˜ï¼›</li>
</ul>
<p>delegate æ–¹æ³•ä¹Ÿå¯ä»¥å‘ NSCacheURLResponse å¯¹è±¡çš„ <code>userInfo</code> å­—å…¸ä¸­æ’å…¥å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ä¹Ÿä¼šéšç€å“åº”ä¸€èµ·è¢«ç¼“å­˜ã€‚</p>
<p>ä»¥ä¸‹çš„ä¾‹å­å°±æ˜¯æ‹’ç»åœ¨ç£ç›˜ä¸Šç¼“å­˜ HTTPS å“åº”ï¼Œå¹¶ä¸”åœ¨ userInfo å­—å…¸ä¸­æ·»åŠ äº†å½“å‰æ—¥æœŸï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSession:(NSURLSession *)session dataTask:(NSURLSessionDataTask *)dataTask</span><br><span class="line"> willCacheResponse:(NSCachedURLResponse *)proposedResponse</span><br><span class="line"> completionHandler:(void (^)(NSCachedURLResponse * __nullable cachedResponse))completionHandler &#123;</span><br><span class="line">    NSCachedURLResponse *newCachedResponse = proposedResponse;</span><br><span class="line">    NSDictionary *newUserInfo;</span><br><span class="line">    newUserInfo = [NSDictionary dictionaryWithObject:[NSDate date]</span><br><span class="line">                                              forKey:@&quot;Cached Date&quot;];</span><br><span class="line">    if ([proposedResponse.response.URL.scheme isEqualToString:@&quot;https&quot;]) &#123;</span><br><span class="line">#if ALLOW_IN_MEMORY_CACHING</span><br><span class="line">        newCachedResponse = [[NSCachedURLResponse alloc]</span><br><span class="line">                             initWithResponse:proposedResponse.response</span><br><span class="line">                             data:proposedResponse.data</span><br><span class="line">                             userInfo:newUserInfo</span><br><span class="line">                             storagePolicy:NSURLCacheStorageAllowedInMemoryOnly];</span><br><span class="line">#else // !ALLOW_IN_MEMORY_CACHING</span><br><span class="line">        newCachedResponse = nil;</span><br><span class="line">#endif // ALLOW_IN_MEMORY_CACHING</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        newCachedResponse = [[NSCachedURLResponse alloc]</span><br><span class="line">                             initWithResponse:[proposedResponse response]</span><br><span class="line">                             data:[proposedResponse data]</span><br><span class="line">                             userInfo:newUserInfo</span><br><span class="line">                             storagePolicy:[proposedResponse storagePolicy]];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    completionHandler(newCachedResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Cookie-å­˜å‚¨"><a href="#Cookie-å­˜å‚¨" class="headerlink" title="Cookie å­˜å‚¨"></a>Cookie å­˜å‚¨</h2><p>ç”±äº Http åè®®æ— çŠ¶æ€çš„å¤©ç„¶ç‰¹æ€§ï¼Œå®¢æˆ·ç«¯é€šå¸¸ä½¿ç”¨ cookie æ¥ç»´æŠ¤çŠ¶æ€ã€‚URL åŠ è½½ç³»ç»Ÿä¸ºåˆ›å»ºå’Œç®¡ç† cookie æä¾›äº†æ¥å£ï¼Œå¹¶å°† cookie ä½œä¸ºè¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ï¼Œä¼šåœ¨æœåŠ¡å™¨å“åº”è¿”å›çš„æ—¶å€™æ¥æ”¶ cookieã€‚</p>
<p>NSHTTPCookie ç±»å°è£…äº†ä¸€ä¸ª cookie å¹¶å¯¹å¾ˆå¤šçš„å¸¸è§ cookie å±æ€§æä¾›äº†è¯»å†™æ–¹æ³•ã€‚NSHTTPCookieStorage ç±»åˆ™æä¾›äº†æ‰€æœ‰ App å…±äº«çš„ NSHTTPCookie å¯¹è±¡çš„æ¥å£ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šiOS ä¸Šçš„åº”ç”¨ä¹‹é—´ä¸å…±äº« Cookieã€‚</p>
</blockquote>
<p>NSHTTPCookieStorage å…è®¸ App æŒ‡å®š Cookie è®¾ç½®ç­–ç•¥ï¼Œå¯ä»¥è®¾ç½® Cookie æ°¸ä¹…å¯è®¾ç½®ï¼Œæ°¸ä¹…ä¸å¯è®¾ç½®æˆ–è€…åªæœ‰æ¥è‡ªç›¸åŒåŸŸåçš„è¯·æ±‚æ‰å¯ä»¥è®¾ç½®ã€‚</p>
<h2 id="å¤„ç†èº«ä»½è®¤è¯å’Œ-TLS-é“¾è®¤è¯"><a href="#å¤„ç†èº«ä»½è®¤è¯å’Œ-TLS-é“¾è®¤è¯" class="headerlink" title="å¤„ç†èº«ä»½è®¤è¯å’Œ TLS é“¾è®¤è¯"></a>å¤„ç†èº«ä»½è®¤è¯å’Œ TLS é“¾è®¤è¯</h2><p>å¦‚æœè¿œç¨‹æœåŠ¡è¿”å›çš„çŠ¶æ€ç è¦æ±‚è¿›è¡Œèº«ä»½è®¤è¯ï¼Œåˆæˆ–è€…è®¤è¯éœ€è¦åœ¨è¿æ¥å»ºç«‹çš„æ—¶å€™è¿›è¡Œï¼ˆæ¯”å¦‚éœ€è¦ä¸€ä¸ª SSL å®¢æˆ·ç«¯è¯ä¹¦ï¼‰ï¼ŒNSURLSession ä¼šè°ƒç”¨ä¸€ä¸ª delegate æ–¹æ³•ï¼š</p>
<p>// TODO</p>
<h2 id="åè®®æ”¯æŒ"><a href="#åè®®æ”¯æŒ" class="headerlink" title="åè®®æ”¯æŒ"></a>åè®®æ”¯æŒ</h2><p>URL åŠ è½½ç³»ç»Ÿå…è®¸åº”ç”¨æ‰©å±•åè®®æ¥æ”¯æŒæ•°æ®ä¼ è¾“ã€‚å¼€å‘è€…å¯ä»¥ç»§æ‰¿ NSURLProtocol åè®®å®ç°è‡ªå·±çš„åè®®ç±»ï¼Œé€šè¿‡ NSURLProtocol çš„ç±»æ–¹æ³• <code>registerClass:</code> è¿›è¡Œæ³¨å†Œï¼Œå½“ NSURLSession å¯¹è±¡ä¸ºä¸€ä¸ª NSURLRequest åˆå§‹åŒ–é“¾æ¥çš„æ—¶å€™ï¼ŒURL åŠ è½½ç³»ç»Ÿä¼šé€šè¿‡ NSURLProtocol ç±»æ¥å€’å™éå†æ‰€æœ‰çš„æ³¨å†Œåè®®ç±»ï¼Œç¬¬ä¸€ä¸ªåœ¨æ–¹æ³• <code>canInitWithRequest:</code> ä¸­è¿”å› <code>YES</code> çš„åè®®ç±»è¢«ç”¨äºå¤„è¯·æ±‚ã€‚</p>
<p>å¦‚æœä½ è‡ªå®šä¹‰çš„åè®®éœ€è¦åœ¨è¯·æ±‚æˆ–è€…å“åº”ä¸­æ·»åŠ æ–°çš„å±æ€§ï¼Œå¯ä»¥é€šè¿‡ Caterogry åœ¨ NSURLRequestã€NSMutableURLRequest å’Œ NSURLResponse ç±»ä¸­ä¸ºè¿™äº›å±æ€§æä¾›è¯»å†™æ–¹æ³•ã€‚</p>
<p>URL åŠ è½½ç³»ç»Ÿè´Ÿè´£åœ¨è¿æ¥å»ºç«‹çš„æ—¶å€™åˆ›å»º NSURLProtocol å®ä¾‹ï¼Œåœ¨è¯·æ±‚å®Œæˆä¹‹åé‡Šæ”¾å®ä¾‹ï¼Œå› æ­¤å¼€å‘è€…æ°¸è¿œä¸åº”è¯¥è‡ªå·±å»åˆ›å»º NSURLProtocol çš„å®ä¾‹ã€‚</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="å¤„ç†é‡å®šå‘å’Œå…¶ä»–è¯·æ±‚å˜åŒ–"><a href="#å¤„ç†é‡å®šå‘å’Œå…¶ä»–è¯·æ±‚å˜åŒ–" class="headerlink" title="å¤„ç†é‡å®šå‘å’Œå…¶ä»–è¯·æ±‚å˜åŒ–"></a>å¤„ç†é‡å®šå‘å’Œå…¶ä»–è¯·æ±‚å˜åŒ–</h3><p>é‡å®šå‘å‘ç”Ÿåœ¨æœåŠ¡ç«¯å‘Šè¯‰å®¢æˆ·ç«¯éœ€è¦å¯¹ä¸€ä¸ªæ–°çš„  URL å‘èµ·è¯·æ±‚æ‰èƒ½è·å–èµ„æºçš„æ—¶å€™ï¼Œ NSURLSession é‡åˆ°è¿™ç§æƒ…å†µä¼šé€šè¿‡ delegate å‘ŠçŸ¥ Appã€‚ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼Œdelegate å¿…é¡»å®ç° <code>URLSession:task:willPerformHTTPRedirection:newRequest:completionHandler:</code> æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å¯ä»¥è·å–åˆ°å¼•èµ·é‡å®šå‘çš„ responseï¼Œå¹¶é€šè¿‡ comletionHandler è¿”å›ä¸€ä¸ªæ–°çš„è¯·æ±‚ã€‚delegate å¯ä»¥åšä»¥ä¸‹äº‹æƒ…ï¼š</p>
<ul>
<li>ç®€å•çš„è¿”å›è·å–çš„ request ä»¥å…è®¸é‡å®šå‘ï¼›</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„ request æŒ‡å‘ä¸€ä¸ªä¸åŒçš„ URLï¼Œå¹¶è¿”å› requestï¼›</li>
<li>é€šè¿‡è¿”å› nilï¼Œæ‹’ç»é‡å®šå‘ï¼›</li>
</ul>
<p>å¦å¤–ï¼Œdelegate å¯ä»¥åŒæ—¶å–æ¶ˆé‡å®šå‘å’Œè¿æ¥ï¼Œåªéœ€è¦è°ƒç”¨ task å¯¹è±¡çš„ <code>cancel</code> æ–¹æ³•å³å¯ã€‚</p>
<p>å¦‚æœå¤„ç†è¯·æ±‚çš„ NSURLProtocol çš„å­ç±»ä¸ºäº†æ ‡å‡†åŒ–è¯·æ±‚çš„æ ¼å¼ï¼Œæ›´æ”¹äº† NSRequest çš„å†…å®¹ï¼Œæ¯”å¦‚æŠŠè¯·æ±‚ URL çš„åœ°å€ä» <a href="http://www.apple.com" target="_blank" rel="noopener">http://www.apple.com</a> æ”¹ä¸º <a href="http://www.apple.com/" target="_blank" rel="noopener">http://www.apple.com/</a> ï¼Œdelegate ä¹Ÿä¼šæ”¶åˆ° <code>URLSession:task:willPerformHTTPRedirection:newRequest:completionHandler:</code>  æ¶ˆæ¯ï¼Œåœ¨è¿™ç§ç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œresponse å‚æ•°ä¼šä¸º nilï¼Œdelegate åº”è¯¥ç›´æ¥è¿”å›æ”¶åˆ°çš„ request å¯¹è±¡ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å±•ç°äº†<code>URLSession:task:willPerformHTTPRedirection:newRequest:completionHandler:</code> çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSession:(NSURLSession *)session</span><br><span class="line">        task:(NSURLSessionTask *)task</span><br><span class="line">        willPerformHTTPRedirection:(NSHTTPURLResponse *)redirectResponse</span><br><span class="line">        newRequest:(NSURLRequest *)request</span><br><span class="line">        completionHandler:(void (^)(NSURLRequest *))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    NSURLRequest *newRequest = request;</span><br><span class="line">    if (redirectResponse) &#123;</span><br><span class="line">        newRequest = nil;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    completionHandler(newRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å…è®¸è¯·æ±‚ä¸Šå› ä¸ºæ ‡å‡†åŒ–è€Œå‘ç”Ÿçš„ä»»ä½•å˜åŒ–ï¼Œæ‹’ç»äº†æ‰€æœ‰æœåŠ¡ç«¯çš„é‡å®šå‘è¦æ±‚ã€‚</p>
<h3 id="å¤„ç†-iOS-åå°æ´»åŠ¨"><a href="#å¤„ç†-iOS-åå°æ´»åŠ¨" class="headerlink" title="å¤„ç† iOS åå°æ´»åŠ¨"></a>å¤„ç† iOS åå°æ´»åŠ¨</h3><p>å¦‚æœä½ ä½¿ç”¨ NSURLSessionï¼Œä½ çš„ App ä¼šåœ¨ä¸‹è½½ä»»åŠ¡å®Œæˆåè‡ªåŠ¨é‡æ–°å¯åŠ¨ï¼ŒApp çš„<code>application:handleEventsForBackgroundURLSession:completionHandler:</code> delegate æ–¹æ³•è´Ÿè´£é‡æ–°åˆ›å»ºåˆé€‚çš„ sessionï¼Œæä¾› completion handlerï¼Œå¹¶åœ¨ session è°ƒç”¨ delegate çš„ <code>URLSessionDidFinishEventsForBackgroundURLSession:</code> æ–¹æ³•çš„æ—¶å€™è°ƒç”¨è¿™ä¸ª handlerã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨åå°åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SURL *url = [NSURL URLWithString:@&quot;https://www.example.com/&quot;];</span><br><span class="line"> </span><br><span class="line">NSURLSessionDownloadTask *backgroundDownloadTask = [backgroundSession downloadTaskWithURL:url];</span><br><span class="line">[backgroundDownloadTask resume];</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº† session çš„ä»£ç†æ–¹æ³•å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSessionDidFinishEventsForBackgroundURLSession:(NSURLSession *)session &#123;</span><br><span class="line">    AppDelegate *appDelegate = (AppDelegate *)[[[UIApplication sharedApplication] delegate];</span><br><span class="line">    if (appDelegate.backgroundSessionCompletionHandler) &#123;</span><br><span class="line">        CompletionHandler completionHandler = appDelegate.backgroundSessionCompletionHandler;</span><br><span class="line">        appDelegate.backgroundSessionCompletionHandler = nil;</span><br><span class="line">        completionHandler();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    NSLog(@&quot;All tasks are finished&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº† AppDelegate çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@interface AppDelegate : UIResponder &lt;UIApplicationDelegate&gt;</span><br><span class="line">@property (strong, nonatomic) UIWindow *window;</span><br><span class="line">@property (copy) CompletionHandler backgroundSessionCompletionHandler;</span><br><span class="line"> </span><br><span class="line">@end</span><br><span class="line"> </span><br><span class="line">@implementation AppDelegate</span><br><span class="line"> </span><br><span class="line">- (void)application:(UIApplication *)application</span><br><span class="line">handleEventsForBackgroundURLSession:(NSString *)identifier</span><br><span class="line">  completionHandler:(void (^)())completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    self.backgroundSessionCompletionHandler = completionHandler;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ã€å‚è€ƒèµ„æ–™ã€‘</p>
<p>1ï¼‰<a href="https://objccn.io/issue-5-4/" target="_blank" rel="noopener">ä» NSURLConnection åˆ° NSURLSession</a></p>
<p>2ï¼‰<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html#//apple_ref/doc/uid/10000165i" target="_blank" rel="noopener">URL Session Programming Guide</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[SDWebImage æºç è§£æ]]></title>
      <url>http://www.timebridge.space/2017/02/10/SDWebImage-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<blockquote>
<p>åˆ†æç‰ˆæœ¬ï¼š3.7.4</p>
</blockquote>
<p><a href="https://github.com/rs/SDWebImage" target="_blank" rel="noopener">SDWebImage</a> æ˜¯ iOS ä¸Šä½¿ç”¨èŒƒå›´æœ€å¹¿çš„ç½‘ç»œå›¾ç‰‡åŠ è½½åº“ï¼Œåœ¨ Github ä¸Šæœ‰é«˜è¾¾è¿‘ 17K çš„ Star æ•°é‡ã€‚å®ƒæä¾›çš„åŠŸèƒ½ä¸»è¦å¦‚ä¸‹ï¼š</p>
<ol>
<li>åŠ è½½æ™®é€šå›¾ç‰‡ï¼ŒåŒ…æ‹¬ pngã€jpegã€gifã€WebPç­‰ï¼Œæ”¯æŒçš„ç»„ä»¶æœ‰ UIImageViewã€UIButton å’Œ MKAnnotationViewï¼›</li>
<li>ä¸º UIImageVew åŠ è½½å¤šå¸§å›¾ç‰‡ï¼›</li>
<li>é¢„åŠ è½½å›¾ç‰‡ï¼›</li>
</ol>
<p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[imageView sd_setImageWithURL:[NSURL URLWithString:@&quot;http://www.domain.com/path/to/image.jpg&quot;]</span><br><span class="line">             placeholderImage:[UIImage imageNamed:@&quot;placeholder.png&quot;]];</span><br></pre></td></tr></table></figure>
<p>ç®€å•çš„æƒ…å†µä¸‹åªéœ€è¦å‘Šè¯‰å®ƒå›¾ç‰‡çš„ URL ä»¥åŠå ä½å›¾ç‰‡å°±å¯ä»¥è½»æ¾å®Œæˆç½‘ç»œå›¾ç‰‡çš„åŠ è½½ã€‚çŸ¥å…¶ç„¶æ›´è¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œä¸‹é¢ä»æºç è§’åº¦åˆ†æä¸€ä¸‹ SDWebImage æ˜¯å¦‚ä½•å®Œæˆå›¾ç‰‡åŠ è½½çš„ã€‚</p>
<a id="more"></a>
<h2 id="åŠ è½½æµç¨‹"><a href="#åŠ è½½æµç¨‹" class="headerlink" title="åŠ è½½æµç¨‹"></a>åŠ è½½æµç¨‹</h2><p>åœ¨è¯¦ç»†çœ‹ä»£ç ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹å›¾ç‰‡åŠ è½½çš„æµç¨‹ï¼ˆæ¥è‡ªé¡¹ç›®çš„ Wikiï¼‰ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/SDWebImageSequenceDiagram.png" alt="SDWebImage å›¾ç‰‡åŠ è½½æµç¨‹å›¾"></div>

<p>æ–‡å­—æè¿°å¦‚ä¸‹ï¼š</p>
<ol>
<li>å‘èµ·å›¾ç‰‡åŠ è½½è¯·æ±‚ï¼›</li>
<li>å°è¯•ä»ç¼“å­˜ä¸­è¯»å–å›¾ç‰‡ï¼›</li>
<li>ç¼“å­˜è¯»å–æˆåŠŸåˆ™è¿”å›å›¾ç‰‡ï¼Œè¯»å–å¤±è´¥åˆ™ä»ç½‘ç»œä¸‹è½½ï¼›</li>
<li>ä¸‹è½½æˆåŠŸåæ·»åŠ åˆ°ç¼“å­˜å¹¶è¿”å›å›¾ç‰‡ï¼›</li>
</ol>
<p>å›¾ç‰‡åŠ è½½çš„æµç¨‹å¹¶ä¸å¤æ‚ï¼Œå¤§éƒ¨åˆ†å›¾ç‰‡åŠ è½½åº“çš„æµç¨‹éƒ½å¤§åŒå°å¼‚ï¼Œåªä¸è¿‡æ¯ä¸ªåº“åœ¨å®ç°çš„æ—¶å€™åœ¨ç­–ç•¥æ§åˆ¶ä»¥åŠç»†èŠ‚å®ç°ä¸Šæœ‰æ‰€å·®åˆ«ã€‚åœ¨ç†è§£å¤§è‡´æµç¨‹çš„åŸºç¡€ä¸Šï¼Œä¸‹é¢åˆ†ææ¯ä¸€æ­¥çš„å®ç°ã€‚</p>
<h2 id="ä»»åŠ¡åˆ›å»ºä¸è°ƒåº¦"><a href="#ä»»åŠ¡åˆ›å»ºä¸è°ƒåº¦" class="headerlink" title="ä»»åŠ¡åˆ›å»ºä¸è°ƒåº¦"></a>ä»»åŠ¡åˆ›å»ºä¸è°ƒåº¦</h2><h3 id="ä»»åŠ¡åˆ›å»º"><a href="#ä»»åŠ¡åˆ›å»º" class="headerlink" title="ä»»åŠ¡åˆ›å»º"></a>ä»»åŠ¡åˆ›å»º</h3><p>æˆ‘ä»¬ä»ä¸Šé¢çš„ç¤ºä¾‹ä»£ç åˆ‡å…¥ï¼Œå³æ–¹æ³•<code>- (void)sd_setImageWithURL:(NSURL *)url placeholderImage:(UIImage *)placeholder;</code>ã€‚è¿™ä¸ªæ–¹æ³•æ¥è‡ªäº<code>UIImageView+WebCache.h</code>ï¼Œæœ‰å¾ˆå¤šçš„é‡è½½æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">- (void)sd_setImageWithURL:(NSURL *)url placeholderImage:(UIImage *)placeholder options:(SDWebImageOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageCompletionBlock)completedBlock &#123;</span><br><span class="line">    // 1. å–æ¶ˆä»»åŠ¡</span><br><span class="line">    [self sd_cancelCurrentImageLoad];</span><br><span class="line">    // 2. è®°å½•è¦åŠ è½½çš„ URL</span><br><span class="line">    objc_setAssociatedObject(self, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line"></span><br><span class="line">    // 3. è®¾ç½®å ä½å›¾</span><br><span class="line">    if (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            self.image = placeholder;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 4. å¦‚æœ URL å­˜åœ¨ï¼Œåˆ™åŠ è½½å›¾ç‰‡ï¼Œå¦åˆ™æŠ¥é”™ï¼Œç›´æ¥å›è°ƒ</span><br><span class="line">    if (url) &#123;</span><br><span class="line">        // 5. æ˜¾ç¤ºåŠ è½½èŠèŠ±</span><br><span class="line">        // check if activityView is enabled or not</span><br><span class="line">        if ([self showActivityIndicatorView]) &#123;</span><br><span class="line">            [self addActivityIndicator];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 6. åˆ›å»ºåŠ è½½ä»»åŠ¡</span><br><span class="line">        __weak __typeof(self)wself = self;</span><br><span class="line">        id &lt;SDWebImageOperation&gt; operation = [SDWebImageManager.sharedManager downloadImageWithURL:url options:options progress:progressBlock completed:^(UIImage *image, NSError *error, SDImageCacheType cacheType, BOOL finished, NSURL *imageURL) &#123;</span><br><span class="line">            [wself removeActivityIndicator];</span><br><span class="line">            if (!wself) return;</span><br><span class="line">            dispatch_main_sync_safe(^&#123;// è°ƒåº¦åˆ°ä¸»çº¿ç¨‹</span><br><span class="line">                if (!wself) return;</span><br><span class="line">                // å¦‚æœåŠ è½½é€‰é¡¹è®¾ç½®ä¸ºä¸è‡ªåŠ¨è®¾ç½®å›¾ç‰‡ï¼Œå¹¶ä¸”æœ‰å›è°ƒ Blockï¼Œåˆ™è°ƒç”¨å›è°ƒ Block</span><br><span class="line">                if (image &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage) &amp;&amp; completedBlock)</span><br><span class="line">                &#123;</span><br><span class="line">                    completedBlock(image, error, cacheType, url);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (image) &#123;// å¦åˆ™ç›´æ¥è®¾ç½®å›¾ç‰‡</span><br><span class="line">                    wself.image = image;</span><br><span class="line">                    [wself setNeedsLayout];</span><br><span class="line">                &#125; else &#123;// å¦‚æœåŠ è½½å¤±è´¥ï¼Œåœ¨æ­¤å¤„è®¾ç½®ä¸ºå ä½ç¬¦ï¼ˆå…³äº SDWebImageDelayPlaceholder å¯ä»¥æŸ¥çœ‹è¯¥æšä¸¾çš„è¯´æ˜ï¼‰</span><br><span class="line">                    if ((options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">                        wself.image = placeholder;</span><br><span class="line">                        [wself setNeedsLayout];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // å›è°ƒ</span><br><span class="line">                if (completedBlock &amp;&amp; finished) &#123;</span><br><span class="line">                    completedBlock(image, error, cacheType, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;];</span><br><span class="line">        // 7. å°†è¯¥ä»»åŠ¡è®°å½•ä¸º &quot;UIImageViewImageLoad&quot; å¯¹åº”çš„ä»»åŠ¡ã€‚ä¸€ä¸ªç»„ä»¶æœ‰ä¸¤ç§ä»»åŠ¡ï¼Œå¦å¤–ä¸€ç§æ˜¯ &quot;UIImageViewAnimationImages&quot;</span><br><span class="line">        // åŠ è½½çš„æ˜¯ Gif åŠ¨æ€å›¾ï¼Œæ¯ç§ç±»å‹çš„ä»»åŠ¡åŒæ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œè¯¥æ–¹æ³•è°ƒç”¨æ˜¯ä¼šé»˜è®¤æ£€æµ‹å¹¶å–æ¶ˆæ—§æœ‰çš„ä»»åŠ¡</span><br><span class="line">        [self sd_setImageLoadOperation:operation forKey:@&quot;UIImageViewImageLoad&quot;];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // URL éæ³•ï¼Œç›´æ¥æŠ¥é”™å›è°ƒ</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            [self removeActivityIndicator];</span><br><span class="line">            NSError *error = [NSError errorWithDomain:SDWebImageErrorDomain code:-1 userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Trying to load a nil url&quot;&#125;];</span><br><span class="line">            if (completedBlock) &#123;</span><br><span class="line">                completedBlock(nil, error, SDImageCacheTypeNone, url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯å‡†å¤‡åŠ è½½ç¯å¢ƒï¼Œåˆ›å»ºåŠ è½½ä»»åŠ¡ã€‚ç›¸å…³æ³¨é‡Šéƒ½å·²ç»æ ‡è®°åœ¨ä»£ç ä¸Šï¼Œä¸‹é¢è¯´ä¸€äº›ç»†èŠ‚ã€‚</p>
<p>é¦–å…ˆæ˜¯<code>dispatch_main_async_safe</code>å’Œ<code>dispatch_main_sync_safe</code>ä¸¤ä¸ªå®ï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define dispatch_main_sync_safe(block)\</span><br><span class="line">    if ([NSThread isMainThread]) &#123;\</span><br><span class="line">        block();\</span><br><span class="line">    &#125; else &#123;\</span><br><span class="line">        dispatch_sync(dispatch_get_main_queue(), block);\</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">#define dispatch_main_async_safe(block)\</span><br><span class="line">    if ([NSThread isMainThread]) &#123;\</span><br><span class="line">        block();\</span><br><span class="line">    &#125; else &#123;\</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), block);\</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªå®è™½ç„¶ç®€åŒ–äº†ä¸€äº›å†™æ³•ï¼Œä½†æ˜¯å®šä¹‰å¾ˆç³Ÿç³•ï¼š</p>
<ol>
<li>æ‰€è°“<code>safe</code>ï¼Œå¹¶ä¸èƒ½å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œå”¯ä¸€åŠ å¼ºå®‰å…¨çš„åœ°æ–¹å°±æ˜¯<code>dispatch_main_sync_safe</code>é˜²æ­¢äº†åœ¨ä¸»çº¿ç¨‹ä¸Šè°ƒç”¨<code>dispatch_sync(dispatch_get_main_queue(), block)</code>äº§ç”Ÿæ­»é”ï¼Œè€Œ<code>async</code>å®Œå…¨çœ‹ä¸å‡ºæ¥ï¼›</li>
<li><code>dispatch_main_async_safe</code>å¦‚æœæ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šï¼Œå®é™…æ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸ä¸åå­—æ‰€åæ˜ çš„ä¸€æ ·ï¼Œä½¿ç”¨çš„æ—¶å€™åŠ¡å¿…è¦æ³¨æ„ï¼›</li>
</ol>
<p>å…¶æ¬¡æ˜¯ä»»åŠ¡çš„å–æ¶ˆã€‚åœ¨æ–¹æ³•çš„ä¸€å¼€å§‹å³ 1 å¤„å°±è°ƒç”¨äº†å–æ¶ˆä»»åŠ¡çš„æ–¹æ³•ï¼Œå›¾ç‰‡åŠ è½½ä»»åŠ¡åˆ›å»ºçš„æœ€åï¼Œä¹Ÿå°±æ˜¯ 7 å¤„å°†ä»»åŠ¡è®°å½•ä¸ºä¸€ä¸ªå˜é‡ï¼ŒåæœŸä¼šé€šè¿‡è¿™ä¸ªå˜é‡æ“ä½œä»»åŠ¡ã€‚<code>sd_setImageLoadOperation</code>æ–¹æ³•çš„è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// æ¥è‡ª UIImageView+WebCache.h</span><br><span class="line">- (void)sd_cancelCurrentImageLoad &#123;</span><br><span class="line">    [self sd_cancelImageLoadOperationWithKey:@&quot;UIImageViewImageLoad&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ¥è‡ª UIView+WebCacheOperation.h</span><br><span class="line">- (void)sd_setImageLoadOperation:(id)operation forKey:(NSString *)key &#123;</span><br><span class="line">    [self sd_cancelImageLoadOperationWithKey:key];</span><br><span class="line">    NSMutableDictionary *operationDictionary = [self operationDictionary];</span><br><span class="line">    [operationDictionary setObject:operation forKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ¥è‡ª UIView+WebCacheOperation.h</span><br><span class="line">- (void)sd_cancelImageLoadOperationWithKey:(NSString *)key &#123;</span><br><span class="line">    // Cancel in progress downloader from queue</span><br><span class="line">    NSMutableDictionary *operationDictionary = [self operationDictionary];</span><br><span class="line">    id operations = [operationDictionary objectForKey:key];</span><br><span class="line">    if (operations) &#123;</span><br><span class="line">        if ([operations isKindOfClass:[NSArray class]]) &#123;</span><br><span class="line">            for (id &lt;SDWebImageOperation&gt; operation in operations) &#123;</span><br><span class="line">                if (operation) &#123;</span><br><span class="line">                    [operation cancel];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if ([operations conformsToProtocol:@protocol(SDWebImageOperation)])&#123;</span><br><span class="line">            [(id&lt;SDWebImageOperation&gt;) operations cancel];</span><br><span class="line">        &#125;</span><br><span class="line">        [operationDictionary removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ UIView å†…éƒ¨ï¼Œé€šè¿‡ Category åˆ›å»ºäº†ä¸€ä¸ª Dictionaryï¼Œç”¨äºè®°å½•å½“å‰åœ¨è¯¥ View ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ‰€æœ‰ä»»åŠ¡ï¼Œåœ¨æ³¨é‡Š 7 å¤„æˆ‘è¯´äº†è¿™ä¸ª Dictionary ä¸­è®°å½•çš„ä»»åŠ¡æœ‰ä¸¤ç§ keyï¼š</p>
<ol>
<li><strong>â€œUIImageViewImageLoadâ€</strong>å¯¹åº”çš„æ˜¯å•ä¸ª<code>SDWebImageOperation</code>ï¼Œç”¨äºä¸‹è½½å•å¼ æ™®é€šå›¾ç‰‡ï¼›</li>
<li><strong>â€œUIImageViewAnimationImagesâ€</strong>å¯¹åº”çš„æ˜¯<code>SDWebImageOperation</code>æ•°ç»„ï¼Œç”¨äºä¸‹è½½ä¸€ç»„å›¾ç‰‡å±•ç°å¸§åŠ¨ç”»ã€‚</li>
</ol>
<p><code>SDWebImageOperation</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ª<code>cancel()</code>æ–¹æ³•ï¼Œå–æ¶ˆä»»åŠ¡è°ƒç”¨å®ƒå³å¯ã€‚</p>
<blockquote>
<p>è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åŠ è½½ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œå¹¶æ²¡æœ‰ä¸»åŠ¨ä»å­—å…¸ä¸­åˆ é™¤å¯¹åº”ä»»åŠ¡ã€‚</p>
</blockquote>
<p>æœ€åæœ‰ä¸€ä¸ªç–‘é—®æ²¡æœ‰å¾—åˆ°è§£ç­”ï¼šä¸‹è½½å®Œæˆçš„å›è°ƒ Block ä¸­ä¸ºä»€ä¹ˆè¦<code>dispatch_main_sync_safe</code>æ–¹æ³•è¿›è¡Œå›¾ç‰‡æœ€åçš„æ˜¾ç¤ºå¤„ç†ï¼Ÿè¿™é‡Œä½¿ç”¨<code>dispatch_main_async_safe</code>æ˜æ˜¾å¯ä»¥æ›´å¿«åœ°é‡Šæ”¾åŠ è½½çº¿ç¨‹ï¼Œè€Œä¸”å®ç°æ•ˆæœä¸€è‡´ã€‚</p>
<h3 id="åŠ è½½ä»»åŠ¡çš„æ‰§è¡Œ"><a href="#åŠ è½½ä»»åŠ¡çš„æ‰§è¡Œ" class="headerlink" title="åŠ è½½ä»»åŠ¡çš„æ‰§è¡Œ"></a>åŠ è½½ä»»åŠ¡çš„æ‰§è¡Œ</h3><p>æ³¨é‡Š 6 å¤„å·²ç»åˆ›å»ºäº†åŠ è½½ä»»åŠ¡ï¼Œæˆ‘ä»¬æ¥ä»”ç»†çœ‹çœ‹åŠ è½½ä»»åŠ¡åˆ°åº•åšäº†ä»€ä¹ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">// æ¥è‡ª SDWebImageManager.h</span><br><span class="line">- (id &lt;SDWebImageOperation&gt;)downloadImageWithURL:(NSURL *)url</span><br><span class="line">                                         options:(SDWebImageOptions)options</span><br><span class="line">                                        progress:(SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                       completed:(SDWebImageCompletionWithFinishedBlock)completedBlock &#123;</span><br><span class="line">    // 1. å‚æ•°æ£€æµ‹</span><br><span class="line">    // Invoking this method without a completedBlock is pointless</span><br><span class="line">    NSAssert(completedBlock != nil, @&quot;If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead&quot;);</span><br><span class="line"></span><br><span class="line">    // Very common mistake is to send the URL using NSString object instead of NSURL. For some strange reason, XCode won&apos;t</span><br><span class="line">    // throw any warning for this type mismatch. Here we failsafe this error by allowing URLs to be passed as NSString.</span><br><span class="line">    if ([url isKindOfClass:NSString.class]) &#123;</span><br><span class="line">        url = [NSURL URLWithString:(NSString *)url];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Prevents app crashing on argument type error like sending NSNull instead of NSURL</span><br><span class="line">    if (![url isKindOfClass:NSURL.class]) &#123;</span><br><span class="line">        url = nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. åˆ›å»ºçœŸæ­£çš„ Operation</span><br><span class="line">    __block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];</span><br><span class="line">    __weak SDWebImageCombinedOperation *weakOperation = operation;</span><br><span class="line"></span><br><span class="line">    // 3. åˆ¤æ–­è¿™ä¸ª URL ä¹‹å‰æœ‰æ²¡æœ‰åŠ è½½å¤±è´¥è¿‡</span><br><span class="line">    BOOL isFailedUrl = NO;</span><br><span class="line">    @synchronized (self.failedURLs) &#123;</span><br><span class="line">        isFailedUrl = [self.failedURLs containsObject:url];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å¦‚æœ URL ä¸ºç©ºï¼Œæˆ–è€…è¿™ä¸ª URL åŠ è½½å¤±è´¥è¿‡ä½†æ˜¯å¼€å‘è€…ä¸è¦æ±‚é‡è¯•å¤±è´¥çš„ URLï¼Œåˆ™ç›´æ¥å›è°ƒ</span><br><span class="line">    if (url.absoluteString.length == 0 || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</span><br><span class="line">        dispatch_main_sync_safe(^&#123;</span><br><span class="line">            NSError *error = [NSError errorWithDomain:NSURLErrorDomain code:NSURLErrorFileDoesNotExist userInfo:nil];</span><br><span class="line">            completedBlock(nil, error, SDImageCacheTypeNone, YES, url);</span><br><span class="line">        &#125;);</span><br><span class="line">        return operation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 4. è®°å½•è¿™ä¸ª Operation</span><br><span class="line">    @synchronized (self.runningOperations) &#123;</span><br><span class="line">        [self.runningOperations addObject:operation];</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *key = [self cacheKeyForURL:url];</span><br><span class="line"></span><br><span class="line">    // 5. &amp;&amp;&amp; ä¸ºä»»åŠ¡åˆ›å»ºç¼“å­˜ä»»åŠ¡ï¼Œå…ˆä»ç£ç›˜è¯»å–ä»»åŠ¡ï¼Œæ ¹æ®è¯»å–çš„ç»“æœè¿›è¡Œæ“ä½œï¼Œæ ¹æ®åé¢çš„åˆ†æï¼Œè¿™ä¸ª Block çš„æ‰§è¡Œæ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„</span><br><span class="line">    operation.cacheOperation = [self.imageCache queryDiskCacheForKey:key done:^(UIImage *image, SDImageCacheType cacheType) &#123;</span><br><span class="line">        if (operation.isCancelled) &#123;</span><br><span class="line">            @synchronized (self.runningOperations) &#123;</span><br><span class="line">                [self.runningOperations removeObject:operation];</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 6. @@@ å¦‚æœå›¾ç‰‡æ²¡æœ‰ä»ç¼“å­˜è·å–åˆ°/å¼€å‘è€…è¦æ±‚åˆ·æ–°ç¼“å­˜å›¾ç‰‡ï¼ˆæ¢å¥è¯è¯´ï¼Œè·å–åˆ°çš„å›¾ç‰‡ä¸èƒ½ç”¨ï¼Œéœ€è¦ä¸‹è½½ï¼‰ï¼Œå¹¶ä¸”ä»£ç†åé¦ˆéœ€è¦æ ¹æ® URL ä¸‹è½½å›¾ç‰‡</span><br><span class="line">        if ((!image || options &amp; SDWebImageRefreshCached) &amp;&amp; (![self.delegate respondsToSelector:@selector(imageManager:shouldDownloadImageForURL:)] || [self.delegate imageManager:self shouldDownloadImageForURL:url])) &#123;</span><br><span class="line">            // å¦‚æœä»ç¼“å­˜ä¸­è·å–äº†å›¾ç‰‡ï¼Œä½†æ˜¯å¼€å‘è€…è®¾ç½®ä¸ºå¿…é¡»åˆ·æ–°ç¼“å­˜</span><br><span class="line">            if (image &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</span><br><span class="line">                dispatch_main_sync_safe(^&#123;</span><br><span class="line">                    // If image was found in the cache but SDWebImageRefreshCached is provided, notify about the cached image</span><br><span class="line">                    // AND try to re-download it in order to let a chance to NSURLCache to refresh it from server.</span><br><span class="line">                    // å…ˆå›è°ƒå†é‡æ–°ä¸‹è½½</span><br><span class="line">                    completedBlock(image, nil, cacheType, YES, url);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // download if no image or requested to refresh anyway, and download allowed by delegate</span><br><span class="line">            SDWebImageDownloaderOptions downloaderOptions = 0;</span><br><span class="line">            if (options &amp; SDWebImageLowPriority) downloaderOptions |= SDWebImageDownloaderLowPriority;</span><br><span class="line">            if (options &amp; SDWebImageProgressiveDownload) downloaderOptions |= SDWebImageDownloaderProgressiveDownload;</span><br><span class="line">            if (options &amp; SDWebImageRefreshCached) downloaderOptions |= SDWebImageDownloaderUseNSURLCache;</span><br><span class="line">            if (options &amp; SDWebImageContinueInBackground) downloaderOptions |= SDWebImageDownloaderContinueInBackground;</span><br><span class="line">            if (options &amp; SDWebImageHandleCookies) downloaderOptions |= SDWebImageDownloaderHandleCookies;</span><br><span class="line">            if (options &amp; SDWebImageAllowInvalidSSLCertificates) downloaderOptions |= SDWebImageDownloaderAllowInvalidSSLCertificates;</span><br><span class="line">            if (options &amp; SDWebImageHighPriority) downloaderOptions |= SDWebImageDownloaderHighPriority;</span><br><span class="line">            // å¦‚æœæ˜¯è®¾ç½®ä¸ºåˆ·æ–°ç¼“å­˜å¹¶ä¸”è·å–åˆ°äº†å›¾ç‰‡ï¼Œåˆ™å–æ¶ˆæ¸è¿›å¼åŠ è½½ï¼Œå¹¶æ·»åŠ å¿½ç•¥ç¼“å­˜å“åº”é€‰é¡¹</span><br><span class="line">            if (image &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</span><br><span class="line">                // force progressive off if image already cached but forced refreshing</span><br><span class="line">                downloaderOptions &amp;= ~SDWebImageDownloaderProgressiveDownload;</span><br><span class="line">                // ignore image read from NSURLCache if image if cached but force refreshing</span><br><span class="line">                downloaderOptions |= SDWebImageDownloaderIgnoreCachedResponse;</span><br><span class="line">            &#125;</span><br><span class="line">            // 7. åˆ›å»ºä¸‹è½½ä»»åŠ¡</span><br><span class="line">            id &lt;SDWebImageOperation&gt; subOperation = [self.imageDownloader downloadImageWithURL:url options:downloaderOptions progress:progressBlock completed:^(UIImage *downloadedImage, NSData *data, NSError *error, BOOL finished) &#123;</span><br><span class="line">                __strong __typeof(weakOperation) strongOperation = weakOperation;</span><br><span class="line">                if (!strongOperation || strongOperation.isCancelled) &#123; // å¦‚æœä»»åŠ¡å–æ¶ˆ</span><br><span class="line">                    // Do nothing if the operation was cancelled</span><br><span class="line">                    // See #699 for more details</span><br><span class="line">                    // if we would call the completedBlock, there could be a race condition between this block and another completedBlock for the same object, so if this one is called second, we will overwrite the new data</span><br><span class="line">                &#125;</span><br><span class="line">                else if (error) &#123; // å¦‚æœä¸‹è½½å¤±è´¥</span><br><span class="line">                    dispatch_main_sync_safe(^&#123; </span><br><span class="line">                        if (strongOperation &amp;&amp; !strongOperation.isCancelled) &#123;</span><br><span class="line">                            completedBlock(nil, error, SDImageCacheTypeNone, finished, url);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    // å¦‚æœä¸æ˜¯å› ä¸ºä»¥ä¸‹åŸå› ä¸‹è½½å¤±è´¥ï¼Œåˆ™è®°å½•ä¸ºå¤±è´¥çš„ URL</span><br><span class="line">                    if (   error.code != NSURLErrorNotConnectedToInternet</span><br><span class="line">                        &amp;&amp; error.code != NSURLErrorCancelled</span><br><span class="line">                        &amp;&amp; error.code != NSURLErrorTimedOut</span><br><span class="line">                        &amp;&amp; error.code != NSURLErrorInternationalRoamingOff</span><br><span class="line">                        &amp;&amp; error.code != NSURLErrorDataNotAllowed</span><br><span class="line">                        &amp;&amp; error.code != NSURLErrorCannotFindHost</span><br><span class="line">                        &amp;&amp; error.code != NSURLErrorCannotConnectToHost) &#123;</span><br><span class="line">                        @synchronized (self.failedURLs) &#123;</span><br><span class="line">                            [self.failedURLs addObject:url];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123; // å¦‚æœä¸‹è½½æˆåŠŸ</span><br><span class="line">                    if ((options &amp; SDWebImageRetryFailed)) &#123;</span><br><span class="line">                        @synchronized (self.failedURLs) &#123;</span><br><span class="line">                            [self.failedURLs removeObject:url];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    // åˆ¤æ–­æ˜¯å¦è¦ç¼“å­˜åˆ°ç£ç›˜ä¸Š</span><br><span class="line">                    BOOL cacheOnDisk = !(options &amp; SDWebImageCacheMemoryOnly);</span><br><span class="line"></span><br><span class="line">                    // å¦‚æœè¦æ±‚åˆ·æ–°ç¼“å­˜ä½†æ˜¯ä¸‹è½½å›¾ç‰‡ä¸å­˜åœ¨</span><br><span class="line">                    if (options &amp; SDWebImageRefreshCached &amp;&amp; image &amp;&amp; !downloadedImage) &#123;</span><br><span class="line">                        // Image refresh hit the NSURLCache cache, do not call the completion block</span><br><span class="line">                    &#125;</span><br><span class="line">                    // å¦‚æœä¸‹è½½çš„æ˜¯å¤šå›¾ï¼Œè¿›è¡Œè½¬æ¢</span><br><span class="line">                    else if (downloadedImage &amp;&amp; (!downloadedImage.images || (options &amp; SDWebImageTransformAnimatedImage)) &amp;&amp; [self.delegate respondsToSelector:@selector(imageManager:transformDownloadedImage:withURL:)]) &#123;</span><br><span class="line">                        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">                            UIImage *transformedImage = [self.delegate imageManager:self transformDownloadedImage:downloadedImage withURL:url];</span><br><span class="line"></span><br><span class="line">                            if (transformedImage &amp;&amp; finished) &#123;</span><br><span class="line">                                BOOL imageWasTransformed = ![transformedImage isEqual:downloadedImage];</span><br><span class="line">                                // å­˜å‚¨å›¾ç‰‡</span><br><span class="line">                                [self.imageCache storeImage:transformedImage recalculateFromImage:imageWasTransformed imageData:(imageWasTransformed ? nil : data) forKey:key toDisk:cacheOnDisk];</span><br><span class="line">                            &#125;</span><br><span class="line">                            // å›è°ƒ</span><br><span class="line">                            dispatch_main_sync_safe(^&#123;</span><br><span class="line">                                if (strongOperation &amp;&amp; !strongOperation.isCancelled) &#123;</span><br><span class="line">                                    completedBlock(transformedImage, nil, SDImageCacheTypeNone, finished, url);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123; // å¦‚æœä¸‹è½½çš„æ˜¯æ™®é€šå›¾ç‰‡</span><br><span class="line">                        if (downloadedImage &amp;&amp; finished) &#123;</span><br><span class="line">                            // å­˜å‚¨å›¾ç‰‡</span><br><span class="line">                            [self.imageCache storeImage:downloadedImage recalculateFromImage:NO imageData:data forKey:key toDisk:cacheOnDisk];</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        // å›è°ƒ</span><br><span class="line">                        dispatch_main_sync_safe(^&#123;</span><br><span class="line">                            if (strongOperation &amp;&amp; !strongOperation.isCancelled) &#123;</span><br><span class="line">                                completedBlock(downloadedImage, nil, SDImageCacheTypeNone, finished, url);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (finished) &#123;</span><br><span class="line">                    @synchronized (self.runningOperations) &#123;</span><br><span class="line">                        if (strongOperation) &#123;</span><br><span class="line">                            [self.runningOperations removeObject:strongOperation];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">            </span><br><span class="line">            // å–æ¶ˆå›è°ƒ</span><br><span class="line">            operation.cancelBlock = ^&#123;</span><br><span class="line">                [subOperation cancel];</span><br><span class="line">                </span><br><span class="line">                @synchronized (self.runningOperations) &#123;</span><br><span class="line">                    __strong __typeof(weakOperation) strongOperation = weakOperation;</span><br><span class="line">                    if (strongOperation) &#123;</span><br><span class="line">                        [self.runningOperations removeObject:strongOperation];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (image) &#123; // è·å–ç¼“å­˜æˆåŠŸ</span><br><span class="line">            dispatch_main_sync_safe(^&#123;</span><br><span class="line">                __strong __typeof(weakOperation) strongOperation = weakOperation;</span><br><span class="line">                if (strongOperation &amp;&amp; !strongOperation.isCancelled) &#123;</span><br><span class="line">                    completedBlock(image, nil, cacheType, YES, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            @synchronized (self.runningOperations) &#123;</span><br><span class="line">                [self.runningOperations removeObject:operation];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123; // å¼€å‘è€…æƒ³ â€œåªä»ç¼“å­˜è·å–å›¾ç‰‡â€ å¤±è´¥</span><br><span class="line">            // Image not in cache and download disallowed by delegate</span><br><span class="line">            dispatch_main_sync_safe(^&#123;</span><br><span class="line">                __strong __typeof(weakOperation) strongOperation = weakOperation;</span><br><span class="line">                if (strongOperation &amp;&amp; !weakOperation.isCancelled) &#123;</span><br><span class="line">                    completedBlock(nil, nil, SDImageCacheTypeNone, YES, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            @synchronized (self.runningOperations) &#123;</span><br><span class="line">                [self.runningOperations removeObject:operation];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    return operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›¸å…³æµç¨‹å…³é”®ç‚¹éƒ½æ ‡è®°åœ¨ä»£ç ä¸­ï¼Œè¿™è¾¹æœ‰äº›åœ°æ–¹ä¸èƒ½è§£é‡Šçš„å¾ˆæ¸…æ¥šï¼Œæ¯”å¦‚ä¸‹è½½ä»»åŠ¡å›è°ƒ Block ä¸­çš„ finished å‚æ•°ï¼ˆ7 å¤„ï¼‰åˆ°åº•æŒ‡ä»€ä¹ˆï¼Ÿè¿™ä¸ªå‚æ•°æ˜¯ä»æœ€ç»ˆçš„ä¸‹è½½ä»»åŠ¡ä¸­ä¼ é€’å‡ºæ¥çš„ï¼Œåé¢å†è§£é‡Šã€‚è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ–¹æ³•åŒ…å«ç€å›¾ç‰‡åŠ è½½çš„æ ¸å¿ƒæµç¨‹ï¼š<strong>å…ˆå°è¯•ä»ç¼“å­˜è·å–ï¼ˆ5 å¤„ï¼‰ï¼Œæ ¹æ®è·å–ç»“æœå†å†³å®šæ˜¯å¦è¦ä»ç½‘ç»œè·å–ï¼ˆ6 å¤„ï¼‰ã€‚</strong>æ ¹æ®ç¼“å­˜è·å–ç»“æœä»¥åŠå¼€å‘è€…è®¾ç½®çš„é€‰é¡¹ï¼Œåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>å¦‚æœä»ç¼“å­˜è·å–å›¾ç‰‡å¤±è´¥ï¼Œæˆ–è€…å¼€å‘è€…è¦æ±‚åˆ·æ–°ç¼“å­˜å›¾ç‰‡ï¼Œå¹¶ä¸”æ ¹æ®è®¾ç½®çš„ delegate å¼€å‘è€…è¦æ±‚é‡æ–°ä¸‹è½½å›¾ç‰‡ï¼ˆæ²¡æœ‰è®¾ç½® delegate åˆ™é»˜è®¤ä¸‹è½½ï¼‰ï¼Œåˆ™é‡æ–°ä»ç½‘ç»œåŠ è½½å›¾ç‰‡ï¼›</li>
<li>å¦‚æœä»ç¼“å­˜è·å–å›¾ç‰‡æˆåŠŸï¼Œåˆ™ç›´æ¥å›è°ƒ Blockï¼Œå›ä¼ å›¾ç‰‡ï¼›</li>
<li>å¦‚æœä»ç¼“å­˜è·å–å¤±è´¥ï¼Œå¹¶ä¸”æ ¹æ®è®¾ç½®çš„ä»£ç†ï¼Œå¼€å‘è€…ç¦æ­¢ä»ç½‘ç»œä¸‹è½½ï¼Œåˆ™ç›´æ¥è°ƒç”¨å›è°ƒ Blockï¼›</li>
</ol>
<p>æ¥ä¸‹æ¥å°±æ¥è¯¦ç»†çœ‹çœ‹ç¼“å­˜è·å–å’Œä¸‹è½½æµç¨‹ã€‚</p>
<h4 id="ç¼“å­˜è·å–"><a href="#ç¼“å­˜è·å–" class="headerlink" title="ç¼“å­˜è·å–"></a>ç¼“å­˜è·å–</h4><p>ä»ç¼“å­˜è·å–å›¾ç‰‡æ˜¯é€šè¿‡ä¸‹é¢æ–¹æ³•è¿›è¡Œçš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// æ¥è‡ª SDImageCache.h</span><br><span class="line">- (NSOperation *)queryDiskCacheForKey:(NSString *)key done:(SDWebImageQueryCompletedBlock)doneBlock &#123;</span><br><span class="line">    //1. å‚æ•°æ£€æµ‹</span><br><span class="line">    if (!doneBlock) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!key) &#123;</span><br><span class="line">        doneBlock(nil, SDImageCacheTypeNone);</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. é¦–å…ˆä»å†…å­˜æ¢å–è¯»å–</span><br><span class="line">    // First check the in-memory cache...</span><br><span class="line">    UIImage *image = [self imageFromMemoryCacheForKey:key];</span><br><span class="line">    if (image) &#123;</span><br><span class="line">        doneBlock(image, SDImageCacheTypeMemory);</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 3. è°ƒåº¦åˆ° IO çº¿ç¨‹ï¼Œä»ç£ç›˜è¯»å–</span><br><span class="line">    NSOperation *operation = [NSOperation new];</span><br><span class="line">    dispatch_async(self.ioQueue, ^&#123;</span><br><span class="line">        if (operation.isCancelled) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @autoreleasepool &#123;</span><br><span class="line">            UIImage *diskImage = [self diskImageForKey:key];</span><br><span class="line">            if (diskImage &amp;&amp; self.shouldCacheImagesInMemory) &#123;</span><br><span class="line">                NSUInteger cost = SDCacheCostForImage(diskImage);</span><br><span class="line">                [self.memCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                doneBlock(diskImage, SDImageCacheTypeDisk);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SDImageCache ä¸“é—¨è´Ÿè´£è¿›è¡Œå›¾ç‰‡ç¼“å­˜ï¼Œå¹¶ä¾èµ– AutoPurgeCache è¿›è¡Œå†…å­˜ç¼“å­˜ï¼Œå®ƒæ˜¯<strong>å•ä¾‹</strong>çš„ã€‚è¿™é‡Œçš„ç­–ç•¥æ˜¯ï¼š</p>
<ol>
<li>é¦–å…ˆä»å†…å­˜ç¼“å­˜ä¸­è¯»å–ï¼Œè¯»å–åˆ°åˆ™å›è°ƒè¿”å›ï¼›</li>
<li>è¯»å–ä¸åˆ°è°ƒåº¦åˆ°å¼‚æ­¥çº¿ç¨‹ä»ç£ç›˜è¯»å–ï¼Œè¯»å–åˆ°äº†åˆ™å°è¯•æ·»åŠ åˆ°å†…å­˜ç¼“å­˜ï¼›</li>
<li>è°ƒåº¦åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œå›è°ƒ blockï¼›</li>
</ol>
<p>AutoPurgeCache ç»§æ‰¿äº NSCacheï¼Œæ·»åŠ äº†å†…å­˜å›æ”¶ç›¸å…³åŠŸèƒ½ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@interface AutoPurgeCache : NSCache</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation AutoPurgeCache</span><br><span class="line"></span><br><span class="line">- (id)init</span><br><span class="line">&#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(removeAllObjects) name:UIApplicationDidReceiveMemoryWarningNotification object:nil];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc</span><br><span class="line">&#123;</span><br><span class="line">    [[NSNotificationCenter defaultCenter] removeObserver:self name:UIApplicationDidReceiveMemoryWarningNotification object:nil];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨æ”¶åˆ° App å†…å­˜è­¦å‘Šä»¥åŠè¢«é”€æ¯çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰å†…å­˜ç¼“å­˜çš„å›¾ç‰‡ã€‚NSCache æœ¬èº«æä¾›é€šè¿‡æ•°æ®æ•°é‡ä»¥åŠæ•°æ®ä½“ç§¯æ¥é™åˆ¶ç¼“å­˜çš„åŠŸèƒ½ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½ä¹Ÿé€šè¿‡æ¥å£æš´éœ²ç»™äº†å¤–éƒ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)setMaxMemoryCost:(NSUInteger)maxMemoryCost &#123;</span><br><span class="line">    self.memCache.totalCostLimit = maxMemoryCost;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setMaxMemoryCountLimit:(NSUInteger)maxCountLimit &#123;</span><br><span class="line">    self.memCache.countLimit = maxCountLimit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨å¤–éƒ¨æ ¹æ® App å®é™…æƒ…å†µè®¾ç½®å†…å­˜ç¼“å­˜å¤§å°ã€‚ç£ç›˜ç¼“å­˜çš„æ§åˆ¶æ¸…ç†éœ€è¦æ‰‹åŠ¨è°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)cleanDisk &#123;</span><br><span class="line">    [self cleanDiskWithCompletionBlock:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)cleanDiskWithCompletionBlock:(SDWebImageNoParamsBlock)completionBlock &#123;</span><br><span class="line">	// å®é™…æ¸…ç†æ“ä½œ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä»£ç ï¼Œå®é™…çš„æ¸…ç†æ“ä½œæµç¨‹ä¸æ—¶é—´å’Œç¼“å­˜æ–‡ä»¶å¤§å°ç›¸å…³ï¼Œç­–ç•¥å¦‚ä¸‹ï¼š</p>
<ol>
<li>éå†ç¼“å­˜æ–‡ä»¶å¤¹ï¼Œå…ˆåˆ é™¤è¿‡æœŸçš„æ–‡ä»¶ï¼ŒæœŸé™æ—¶é•¿é»˜è®¤è®¾ç½®ä¸ºä¸€å‘¨ï¼Œå³é»˜è®¤åˆ é™¤ä¸€å‘¨å‰çš„æ–‡ä»¶ï¼Œæ—¶é•¿å¯è®¾ç½®ï¼›</li>
<li>éå†è¿‡ç¨‹ä¸­ä¼šé¡ºä¾¿è®¡ç®—ç»è¿‡ æ­¥éª¤ 1 æ¸…ç†ä¹‹åæ€»çš„ç¼“å­˜æ–‡ä»¶å¤§å°ï¼›</li>
<li>å¦‚æœå¼€å‘è€…è®¾ç½®äº†ç¼“å­˜æ–‡ä»¶å¤§å°ä¸Šé™ï¼Œæ£€æµ‹å‰©ä½™ç¼“å­˜æ–‡ä»¶æ˜¯å¦è¶…é™ï¼Œä¸Šé™å€¼é»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºæœªè®¾é™åˆ¶ï¼›</li>
<li>å¦‚æœè¶…é™ï¼Œæ€»ä½“ç§¯ä¸º Mï¼Œåˆ™å°†ç†æƒ³å°ºå¯¸è®¾ç½®ä¸º M/2ï¼Œå°†å‰©ä½™æ–‡ä»¶æ ¹æ®ä¿®æ”¹æ—¶é—´æ’åºï¼Œä»æœ€æ—§çš„æ–‡ä»¶å¼€å§‹åˆ é™¤ï¼Œç›´åˆ°ä½“ç§¯å°äº M/2ï¼›</li>
</ol>
<p>ç›¸ä¼¼çš„è¿˜æœ‰ä¸€ä¸ª clear æ“ä½œï¼Œå®ƒä¼šæ¸…é™¤æ‰€æœ‰ç¼“å­˜ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯ SDWebImage å®ç°çš„ä¸¤çº§ç¼“å­˜ï¼Œæ—¢ä¿è¯äº†å›¾ç‰‡çš„åŠ è½½é€Ÿåº¦ï¼Œåˆä¿è¯äº†ä¸ä¼šå ç”¨å¤ªå¤šçš„è®¾å¤‡èµ„æºã€‚</p>
<p>å›åˆ°ç¼“å­˜è·å–è¿”å›å¤„ï¼Œå³å‰é¢æ³¨é‡Šçš„ä»£ç  5 å¤„ï¼ˆè¯»è€…å¯ä»¥ç›´æ¥æœ â€œ&amp;&amp;&amp;â€ è·³è½¬ï¼‰ã€‚ä»ç¼“å­˜è¿”å›ä¹‹åï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š1ï¼‰è¿”å›çš„å›¾ç‰‡å¯¹è±¡å¯ç”¨ï¼›2ï¼‰è¿”å›çš„å›¾ç‰‡å¯¹è±¡ä¸å¯ç”¨ã€‚ä¸å¯ç”¨çš„æƒ…å†µåŒæ ·åˆ†ä¸ºä¸¤ç§ï¼š1ï¼‰ç¼“å­˜æœªå‘½ä¸­ï¼Œæ²¡æœ‰è·å–åˆ°ç¼“å­˜å›¾ç‰‡ï¼›2ï¼‰å¼€å‘è€…è¦æ±‚åˆ·æ–°ç¼“å­˜ï¼Œä»ç¼“å­˜ä¸­è·å–çš„å›¾ç‰‡å¿…é¡»ç»è¿‡æœåŠ¡ç«¯éªŒè¯ã€‚ä¸å¯ç”¨çš„æƒ…å†µå¿…é¡»å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œè¿™å°±æ˜¯æ³¨é‡Š 7 å¤„ï¼ˆç”¨æˆ·å¯ä»¥ç›´æ¥æœ â€œ@@@â€ è·³è½¬ï¼‰çš„ç›®çš„ã€‚</p>
<h4 id="å›¾ç‰‡ä¸‹è½½"><a href="#å›¾ç‰‡ä¸‹è½½" class="headerlink" title="å›¾ç‰‡ä¸‹è½½"></a>å›¾ç‰‡ä¸‹è½½</h4><p>å¦‚æœä»ç¼“å­˜è·å–çš„å›¾ç‰‡ä¸å¯ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»ç½‘ç»œè¿›è¡Œä¸‹è½½ï¼Œå®ƒè°ƒç”¨çš„æ˜¯<code>SDWebImageDownloader</code>çš„æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (id &lt;SDWebImageOperation&gt;)downloadImageWithURL:(NSURL *)url options:(SDWebImageDownloaderOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageDownloaderCompletedBlock)completedBlock &#123;</span><br><span class="line">    // SDWebImageDownloaderOperation çœŸæ­£çš„ä»»åŠ¡ä¸‹è½½ç±»ï¼Œç»§æ‰¿è‡ª NSOperation</span><br><span class="line">    __block SDWebImageDownloaderOperation *operation;</span><br><span class="line">    __weak __typeof(self)wself = self;</span><br><span class="line"></span><br><span class="line">    // è¯¥æ–¹æ³•å°†åˆ›å»ºä»»åŠ¡ä¸‹è½½ç±»å®ä¾‹ &amp; æ‰§è¡Œè¯·æ±‚</span><br><span class="line">    [self addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^&#123;</span><br><span class="line">        // æ‰§è¡Œè¯·æ±‚</span><br><span class="line">        ...</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    return operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (void)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock forURL:(NSURL *)url createCallback:(SDWebImageNoParamsBlock)createCallback &#123;</span><br><span class="line">    // The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</span><br><span class="line">    if (url == nil) &#123;</span><br><span class="line">        if (completedBlock != nil) &#123;</span><br><span class="line">            completedBlock(nil, nil, nil, NO);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">	// ç»å…¸ç”¨æ³•</span><br><span class="line">    dispatch_barrier_sync(self.barrierQueue, ^&#123;</span><br><span class="line">        BOOL first = NO;</span><br><span class="line">        if (!self.URLCallbacks[url]) &#123;</span><br><span class="line">            self.URLCallbacks[url] = [NSMutableArray new];</span><br><span class="line">            first = YES;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Handle single download of simultaneous download request for the same URL</span><br><span class="line">        NSMutableArray *callbacksForURL = self.URLCallbacks[url];</span><br><span class="line">        NSMutableDictionary *callbacks = [NSMutableDictionary new];</span><br><span class="line">        if (progressBlock) callbacks[kProgressCallbackKey] = [progressBlock copy];</span><br><span class="line">        if (completedBlock) callbacks[kCompletedCallbackKey] = [completedBlock copy];</span><br><span class="line">        [callbacksForURL addObject:callbacks];</span><br><span class="line">        self.URLCallbacks[url] = callbacksForURL;</span><br><span class="line"></span><br><span class="line">        if (first) &#123;</span><br><span class="line">            createCallback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ¯”è¾ƒæœ‰è¶£ï¼Œé¦–å…ˆæ¥äº†è§£ä¸€ä¸‹è®¾è®¡åœºæ™¯ï¼ŒSDWebImage è€ƒè™‘åˆ°ä¸€ä¸ª App å¯èƒ½åŒæ—¶å‘èµ·å¯¹ä¸€å¼ å›¾ç‰‡çš„å¤šä¸ªè¯·æ±‚è¿™ç§åœºæ™¯ï¼Œå› æ­¤å½“ä¸€ä¸ªå›¾ç‰‡ç½‘ç»œè¯·æ±‚æ‰§è¡Œå‰ï¼Œå®ƒä¼šå…ˆå»æ£€æµ‹æ˜¯å¦å·²ç»æœ‰ä¸€ä¸ªåŒæ ·çš„è¯·æ±‚åœ¨æ‰§è¡Œäº†ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åªæ˜¯åœ¨å¯¹åº”çš„è¯·æ±‚æµç¨‹ä¸Šæ·»åŠ å›è°ƒï¼Œè€Œä¸æ˜¯ç›´æ¥å‘èµ·è¯·æ±‚ã€‚</p>
<p>åœ¨<code>SDWebImageDownloader</code>å†…éƒ¨ï¼Œç»´æŠ¤ç€ä¸€ä¸ªç§°ä¸º<code>URLCallbacks</code>çš„å­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„ key å°±æ˜¯è¯·æ±‚çš„ URLï¼Œvalue æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸€ä¸ªæ•°ç»„åˆåŒ…å«ä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå­—æ®µå­˜å‚¨ç€ä¸¤ä¸ª Blockï¼Œä¸€ä¸ªæ˜¯ä¸‹è½½è¿›åº¦å›è°ƒ Blockï¼Œä¸€ä¸ªæ˜¯ä¸‹è½½å®Œæˆå›è°ƒ Blockï¼Œæ•°ç»„é‡Œé¢å¯èƒ½æœ‰å¤šä¸ªå…ƒç´ ï¼Œæ¯ä¸€ä¸ªå…ƒç´ ä»£è¡¨ç€ä¸€ç»„è¿™æ ·çš„å›è°ƒã€‚</p>
<p>å¦‚æœä»¥è¯¥ URL ä¸º key çš„å›è°ƒç»„ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ²¡æœ‰å®ƒçš„ä¸‹è½½ä»»åŠ¡å­˜åœ¨ï¼Œè¿™æ—¶å€™è¿™ä¸ªæ–¹æ³•å°±ä¼šå›è°ƒ<code>createCallback</code> Blockã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">// è¯¥æ–¹æ³•å°†åˆ›å»ºä»»åŠ¡ä¸‹è½½ç±»å®ä¾‹ &amp; æ‰§è¡Œè¯·æ±‚</span><br><span class="line">[self addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^&#123;</span><br><span class="line">    NSTimeInterval timeoutInterval = wself.downloadTimeout;</span><br><span class="line">    if (timeoutInterval == 0.0) &#123;</span><br><span class="line">        timeoutInterval = 15.0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 1. åˆ›å»ºè¯·æ±‚ &amp; è®¾ç½®å‚æ•°</span><br><span class="line">    // In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise</span><br><span class="line">    NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:(options &amp; SDWebImageDownloaderUseNSURLCache ? NSURLRequestUseProtocolCachePolicy : NSURLRequestReloadIgnoringLocalCacheData) timeoutInterval:timeoutInterval];</span><br><span class="line">    request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);</span><br><span class="line">    request.HTTPShouldUsePipelining = YES;</span><br><span class="line">    if (wself.headersFilter) &#123;</span><br><span class="line">        request.allHTTPHeaderFields = wself.headersFilter(url, [wself.HTTPHeaders copy]);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        request.allHTTPHeaderFields = wself.HTTPHeaders;</span><br><span class="line">    &#125;</span><br><span class="line">    // 2. åˆå§‹åŒ–ä»»åŠ¡ï¼Œæ·»åŠ  Block å›è°ƒç›‘å¬</span><br><span class="line">    operation = [[wself.operationClass alloc] initWithRequest:request</span><br><span class="line">                                                      options:options</span><br><span class="line">                                                     progress:^(NSInteger receivedSize, NSInteger expectedSize) &#123;</span><br><span class="line">                                                         SDWebImageDownloader *sself = wself;</span><br><span class="line">                                                         if (!sself) return;</span><br><span class="line">                                                         __block NSArray *callbacksForURL;</span><br><span class="line">                                                         // å›è°ƒæ‰€æœ‰çš„ä¸‹è½½è¿›åº¦ç›‘å¬</span><br><span class="line">                                                         dispatch_sync(sself.barrierQueue, ^&#123;</span><br><span class="line">                                                             callbacksForURL = [sself.URLCallbacks[url] copy];</span><br><span class="line">                                                         &#125;);</span><br><span class="line">                                                         for (NSDictionary *callbacks in callbacksForURL) &#123;</span><br><span class="line">                                                             dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                                                                 SDWebImageDownloaderProgressBlock callback = callbacks[kProgressCallbackKey];</span><br><span class="line">                                                                 if (callback) callback(receivedSize, expectedSize);</span><br><span class="line">                                                             &#125;);</span><br><span class="line">                                                             &#125;</span><br><span class="line">                                                     &#125;</span><br><span class="line">                                                    completed:^(UIImage *image, NSData *data, NSError *error, BOOL finished) &#123;</span><br><span class="line">                                                        SDWebImageDownloader *sself = wself;</span><br><span class="line">                                                        if (!sself) return;</span><br><span class="line">                                                        __block NSArray *callbacksForURL;</span><br><span class="line">                                                        // å›è°ƒæ‰€æœ‰çš„ä¸‹è½½å®Œæˆç›‘å¬</span><br><span class="line">                                                        dispatch_barrier_sync(sself.barrierQueue, ^&#123;</span><br><span class="line">                                                            callbacksForURL = [sself.URLCallbacks[url] copy];</span><br><span class="line">                                                            if (finished) &#123;</span><br><span class="line">                                                                [sself.URLCallbacks removeObjectForKey:url]; // è¦ç§»é™¤å›è°ƒç›‘å¬</span><br><span class="line">                                                            &#125;</span><br><span class="line">                                                        &#125;);</span><br><span class="line">                                                        for (NSDictionary *callbacks in callbacksForURL) &#123;</span><br><span class="line">                                                            SDWebImageDownloaderCompletedBlock callback = callbacks[kCompletedCallbackKey];</span><br><span class="line">                                                            if (callback) callback(image, data, error, finished);</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                    cancelled:^&#123;</span><br><span class="line">                                                        // è¢«å–æ¶ˆåˆ™ç§»é™¤æ‰€æœ‰çš„ç›‘å¬</span><br><span class="line">                                                        SDWebImageDownloader *sself = wself;</span><br><span class="line">                                                        if (!sself) return;</span><br><span class="line">                                                        dispatch_barrier_async(sself.barrierQueue, ^&#123;</span><br><span class="line">                                                            [sself.URLCallbacks removeObjectForKey:url];</span><br><span class="line">                                                        &#125;);</span><br><span class="line">                                                    &#125;];</span><br><span class="line">    operation.shouldDecompressImages = wself.shouldDecompressImages;</span><br><span class="line">    </span><br><span class="line">    // è®¾ç½®è®¤è¯ä¿¡æ¯(å…·ä½“å¯çœ‹ Http StatusCode - 401)</span><br><span class="line">    if (wself.urlCredential) &#123;</span><br><span class="line">        operation.credential = wself.urlCredential;</span><br><span class="line">    &#125; else if (wself.username &amp;&amp; wself.password) &#123;</span><br><span class="line">        operation.credential = [NSURLCredential credentialWithUser:wself.username password:wself.password persistence:NSURLCredentialPersistenceForSession];</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    // è®¾ç½®ä¼˜å…ˆçº§</span><br><span class="line">    if (options &amp; SDWebImageDownloaderHighPriority) &#123;</span><br><span class="line">        operation.queuePriority = NSOperationQueuePriorityHigh;</span><br><span class="line">    &#125; else if (options &amp; SDWebImageDownloaderLowPriority) &#123;</span><br><span class="line">        operation.queuePriority = NSOperationQueuePriorityLow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 3. æ·»åŠ å¹¶æ‰§è¡Œä»»åŠ¡</span><br><span class="line">    [wself.downloadQueue addOperation:operation];</span><br><span class="line">    // æ¨¡ä»¿å®ç° LIFO ä»»åŠ¡</span><br><span class="line">    if (wself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;</span><br><span class="line">        // Emulate LIFO execution order by systematically adding new operations as last operation&apos;s dependency</span><br><span class="line">        [wself.lastAddedOperation addDependency:operation];</span><br><span class="line">        wself.lastAddedOperation = operation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­åŒæ ·åœ¨å…³é”®ç‚¹è¿›è¡Œäº†æ ‡æ³¨ï¼Œè¿™é‡Œå®é™…åªèƒ½çœ‹åˆ°ä¸€ä¸ªå‘èµ·è¯·æ±‚çš„è¿‡ç¨‹å’Œè¯·æ±‚ç»“æœçš„å›è°ƒï¼Œè€Œå®é™…çš„ä¸‹è½½æ“ä½œåœ¨<code>SDWebImageDownloaderOperation</code>ç±»ä¸­ï¼Œè¿™ä¸ªç±»æ˜¯ä½¿ç”¨ URLConnection  å‘é€è¯·æ±‚çš„ï¼Œä¸‹é¢ä¸€ä¸ªä¸»é¢˜å°†è¿›è¡Œåˆ†æã€‚</p>
<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹å‰é¢æåˆ°çš„ä¸€ä¸ªå‚æ•°ï¼Œå³åŠ è½½å®Œæˆå›è°ƒ Block ä¸­çš„ finish å‚æ•°ï¼šSDWebImage å¯ä»¥é€‰æ‹©é‡‡ç”¨æ¸è¿›å¼å›¾ç‰‡åŠ è½½æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä¸‹è½½å¤šå°‘æ˜¾ç¤ºå¤šå°‘ï¼Œåªéœ€è¦åœ¨ä¸‹è½½çš„æ—¶å€™è®¾ç½®å‚æ•° <code>SDWebImageDownloaderProgressiveDownload</code>å³å¯ï¼Œfinish å‚æ•°æ˜¯ç”¨äºè¡¨ç¤ºä¸‹è½½æ˜¯å¦å·²ç»å®Œå…¨ç»“æŸã€‚</p>
<p>å¦å¤–å†å…³æ³¨ä¸€ä¸‹<code>downloadQueue</code>çš„åˆå§‹åŒ–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_downloadQueue = [NSOperationQueue new];</span><br><span class="line">_downloadQueue.maxConcurrentOperationCount = 6;</span><br></pre></td></tr></table></figure>
<p>æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®ä¸º 6ã€‚ä¹Ÿå°±æ˜¯æœ€å¤šå¯ä»¥åŒæ—¶è¿›è¡Œ 6 ä¸ªä¸‹è½½ä»»åŠ¡ã€‚</p>
<h2 id="ä¸‹è½½-amp-è§£ç "><a href="#ä¸‹è½½-amp-è§£ç " class="headerlink" title="ä¸‹è½½ &amp; è§£ç "></a>ä¸‹è½½ &amp; è§£ç </h2><p>SDWebImage ä¸‹è½½çš„çœŸæ­£å®ç°ç±»æ˜¯<code>SDWebImageDownloaderOperation</code>ï¼Œè¿™ä¸ªç±»ç»§æ‰¿è‡ª<strong>NSOperation</strong>ï¼Œå®ç°<code>NSURLConnectionDataDelegate</code>åè®®ï¼Œå°†ç½‘ç»œä¸‹è½½ç›¸å…³æ“ä½œå’Œä¸‹è½½å›¾ç‰‡è§£ç æ“ä½œå°è£…åœ¨å†…éƒ¨ã€‚</p>
<blockquote>
<p>é˜…è¯»ä»£ç ä¹‹å‰æœ€å¥½äº†è§£ä¸€ä¸‹å¦‚ä½•è‡ªå®šä¹‰ NSOperation å’Œ RunLoop ç›¸å…³çŸ¥è¯†ã€‚</p>
<p>RunLoop çŸ¥è¯†å¯ä»¥å‚è€ƒï¼š<a href="http://blog.ibireme.com/2015/05/18/runloop/#base" target="_blank" rel="noopener">æ·±å…¥ç†è§£RunLoop</a></p>
</blockquote>
<h3 id="å…³é”®æ–¹æ³•start"><a href="#å…³é”®æ–¹æ³•start" class="headerlink" title="å…³é”®æ–¹æ³•start"></a>å…³é”®æ–¹æ³•<code>start</code></h3><p><code>SDWebImageDownloaderOperation</code>çš„<code>start</code>æ–¹æ³•å®ç°å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">- (void)start &#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        if (self.isCancelled) &#123;</span><br><span class="line">            self.finished = YES;</span><br><span class="line">            [self reset];</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ....</span><br><span class="line"></span><br><span class="line">        self.executing = YES;</span><br><span class="line">        self.connection = [[NSURLConnection alloc] initWithRequest:self.request delegate:self startImmediately:NO];</span><br><span class="line">        self.thread = [NSThread currentThread];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [self.connection start];</span><br><span class="line"></span><br><span class="line">    if (self.connection) &#123;// 1. connection åˆå§‹åŒ–æˆåŠŸ</span><br><span class="line">        if (self.progressBlock) &#123;</span><br><span class="line">            self.progressBlock(0, NSURLResponseUnknownLength);</span><br><span class="line">        &#125;</span><br><span class="line">        // 2. å‘é€é€šçŸ¥</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadStartNotification object:self];</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 3. å¯åŠ¨ RunLoop</span><br><span class="line">        if (floor(NSFoundationVersionNumber) &lt;= NSFoundationVersionNumber_iOS_5_1) &#123;</span><br><span class="line">            // Make sure to run the runloop in our background thread so it can process downloaded data</span><br><span class="line">            // Note: we use a timeout to work around an issue with NSURLConnection cancel under iOS 5</span><br><span class="line">            //       not waking up the runloop, leading to dead threads (see https://github.com/rs/SDWebImage/issues/466)</span><br><span class="line">            CFRunLoopRunInMode(kCFRunLoopDefaultMode, 10, false);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            CFRunLoopRun();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 4. æ‰§è¡Œå–æ¶ˆæ¸…ç†å·¥ä½œ</span><br><span class="line">        if (!self.isFinished) &#123;</span><br><span class="line">            [self.connection cancel];</span><br><span class="line">            [self connection:self.connection didFailWithError:[NSError errorWithDomain:NSURLErrorDomain code:NSURLErrorTimedOut userInfo:@&#123;NSURLErrorFailingURLErrorKey : self.request.URL&#125;]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123; // 5. connnection åˆå§‹åŒ–å¤±è´¥</span><br><span class="line">        if (self.completedBlock) &#123;</span><br><span class="line">            self.completedBlock(nil, nil, [NSError errorWithDomain:NSURLErrorDomain code:0 userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Connection can&apos;t be initialized&quot;&#125;], YES);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯”è¾ƒéš¾ç†è§£çš„æ˜¯ RunLoop çš„å¯åŠ¨ã€‚åœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€äº›èµ„æ–™ï¼Œæœ‰çš„äººè®¤ä¸ºè¿™é‡Œå¯åŠ¨ RunLoop æ˜¯ä¸ºäº†ä¿è¯æ•°æ®åŠ è½½çš„æµç•…æ€§ï¼Œåœ¨æ»‘åŠ¨çš„æ—¶å€™ä¸å»åŠ è½½æ•°æ®ã€‚</p>
<p>ä½†æˆ‘çš„ç†è§£å¹¶ä¸æ˜¯è¿™æ ·ï¼Œè¿™ä¸ªä¸‹è½½ä»»åŠ¡æ‰§è¡Œæ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹é‡Œé¢ï¼Œä¸ä¸»çº¿ç¨‹æ¯«æ— å…³ç³»ï¼Œä¸å­˜åœ¨é¡µé¢æµç•…ä¸æµç•…çš„é—®é¢˜ï¼Œå¦‚æœè¦åšåˆ°æµç•…ï¼Œä¹Ÿåº”è¯¥æ˜¯åœ¨æœ€åè°ƒåº¦åˆ°ä¸»çº¿ç¨‹çš„æ—¶å€™æ§åˆ¶ã€‚å†çœ‹æ³¨é‡Šé‡Œé¢æœ‰ä¸€å¥ â€œMake sure to run the runloop in our background thread so it can process downloaded dataâ€ï¼Œè¿™å¥è¯çš„æ„æ€æ˜¯è¯´å¿…é¡»è¦å¯åŠ¨ RunLoop ä»¥ä¿è¯å®ƒèƒ½å¤Ÿå¤„ç†ä¸‹è½½çš„æ•°æ®ï¼Œè€Œä¸‹è½½çš„çš„æ•°æ®æ˜¯åœ¨ delegate ä¸­è¿›è¡Œå›è°ƒå¤„ç†çš„ã€‚æ‰€ä»¥æˆ‘è®¤ä¸ºï¼š<strong><code>SDWebImageDownloaderOperation</code>å®ç°äº†<code>NSURLConnectionDataDelegate</code>åè®®å¹¶æŠŠè‡ªå·±è®¾ç½®ä¸º connection çš„ delegateï¼Œè¿™é‡Œä¹‹æ‰€ä»¥å¯åŠ¨ RunLoopï¼Œæ˜¯ä¸ºäº†ä¿è¯<code>SDWebImageDownloaderOperation</code>è¿è¡Œåœ¨<code>start</code>æ–¹æ³•ä¸­ä¸é€€å‡ºï¼Œä»è€Œè¯¥å¯¹è±¡ä¸ä¼šè¢«å›æ”¶ï¼Œå¦åˆ™ä¸€æ—¦<code>start</code>æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œconnection å°±å¤±å»ä»£ç†æ— æ³•å¤„ç†æ•°æ®äº†ã€‚</strong></p>
<h3 id="ä»£ç†å®ç°"><a href="#ä»£ç†å®ç°" class="headerlink" title="ä»£ç†å®ç°"></a>ä»£ç†å®ç°</h3><p>å†æ¥çœ‹ä»£ç†ï¼Œä»£ç†æœ‰ä¸‰ä¸ªå…³é”®æ—¶é—´èŠ‚ç‚¹ï¼š</p>
<ol>
<li>åˆæ¬¡è·å¾—å“åº”ï¼Œä¹Ÿå°±æ˜¯è¿é€šæœåŠ¡å™¨çš„æ—¶å€™ï¼›</li>
<li>æ¥æ”¶æ•°æ®çš„è¿‡ç¨‹ï¼›</li>
<li>æ•°æ®æ¥æ”¶å®Œæˆï¼›</li>
</ol>
<p>è¿™éƒ¨åˆ†ä¸»è¦æ˜¯ç½‘ç»œç›¸å…³çš„å†…å®¹ï¼Œåœ¨æ•°æ®æ¥æ”¶ä¸Šæ²¡æœ‰ä»€ä¹ˆå¤§é—®é¢˜ï¼Œå…³é”®æ˜¯çœ‹æ•°æ®çš„å¤„ç†ã€‚ä¸‹é¢ä¸€ä¸€åˆ†æã€‚</p>
<h4 id="è¿æ¥æ‰“é€š"><a href="#è¿æ¥æ‰“é€š" class="headerlink" title="è¿æ¥æ‰“é€š"></a>è¿æ¥æ‰“é€š</h4><p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (void)connection:(NSURLConnection *)connection didReceiveResponse:(NSURLResponse *)response &#123;</span><br><span class="line">    //&apos;304 Not Modified&apos; is an exceptional one</span><br><span class="line">    if (![response respondsToSelector:@selector(statusCode)] || ([((NSHTTPURLResponse *)response) statusCode] &lt; 400 &amp;&amp; [((NSHTTPURLResponse *)response) statusCode] != 304)) &#123;</span><br><span class="line">        NSInteger expected = response.expectedContentLength &gt; 0 ? (NSInteger)response.expectedContentLength : 0;</span><br><span class="line">        self.expectedSize = expected;</span><br><span class="line">        if (self.progressBlock) &#123;</span><br><span class="line">            self.progressBlock(0, expected);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        self.imageData = [[NSMutableData alloc] initWithCapacity:expected];</span><br><span class="line">        self.response = response;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadReceiveResponseNotification object:self];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        NSUInteger code = [((NSHTTPURLResponse *)response) statusCode];</span><br><span class="line">        //This is the case when server returns &apos;304 Not Modified&apos;. It means that remote image is not changed.</span><br><span class="line">        //In case of 304 we need just cancel the operation and return cached image from the cache.</span><br><span class="line">        if (code == 304) &#123;</span><br><span class="line">            [self cancelInternal];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            [self.connection cancel];</span><br><span class="line">        &#125;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadStopNotification object:self];</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        if (self.completedBlock) &#123;</span><br><span class="line">            self.completedBlock(nil, nil, [NSError errorWithDomain:NSURLErrorDomain code:[((NSHTTPURLResponse *)response) statusCode] userInfo:nil], YES);</span><br><span class="line">        &#125;</span><br><span class="line">        CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">        [self done];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå“åº”æ­£å¸¸ï¼Œå³ statusCode &lt; 400ï¼Œå¹¶ä¸”ä¸æ˜¯ 304ï¼Œé‚£ä¹ˆæ­£å¸¸æ¥æ”¶æ•°æ®ï¼Œå¦åˆ™ cancel æ‰è¿æ¥ã€‚å…³äº 304 çš„å®ç°ï¼Œå…¶å®å¹¶æ²¡çœ‹å¤ªæ˜ç™½ã€‚åœ¨<code>SDWebImageDownloader.m</code>ä¸­åˆå§‹åŒ–ä¸‹è½½ request çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise</span><br><span class="line">NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:(options &amp; SDWebImageDownloaderUseNSURLCache ? NSURLRequestUseProtocolCachePolicy : NSURLRequestReloadIgnoringLocalCacheData) timeoutInterval:timeoutInterval];</span><br><span class="line">request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);</span><br><span class="line">request.HTTPShouldUsePipelining = YES;</span><br></pre></td></tr></table></figure>
<p>é™¤éå¼€å‘è€…æ‰‹åŠ¨è®¾ç½®<code>SDWebImageDownloaderUseNSURLCache</code>é€‰é¡¹ï¼Œå¦åˆ™ä¸ä¼šä½¿ç”¨<code>NSURLRequestUseProtocolCachePolicy</code>ç¼“å­˜ç­–ç•¥ï¼Œå¦åˆ™ä¼šç›´æ¥ä»æœåŠ¡ç«¯åŠ è½½ï¼Œç³»ç»Ÿæ˜¯ä¸ä¼šå¸®å¿™åšç¼“å­˜çš„ï¼Œè€Œåœ¨ä»£ç é‡Œé¢æ˜¯æ²¡æœ‰çœ‹åˆ°æ‰‹åŠ¨è§£æä¿å­˜è¯·æ±‚çš„ Header çš„åœ°æ–¹çš„ï¼Œå› æ­¤å¦‚æœä¸ç”¨ç³»ç»Ÿç¼“å­˜ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨<code>NSURLRequestReloadRevalidatingCacheData</code>ç¼“å­˜ç­–ç•¥ï¼Œé‚£ 304 å°±ä¸å¯èƒ½å‡ºç°ï¼Œæ‰€ä»¥è¿™é‡Œ 304 åˆ°åº•æ˜¯ä»€ä¹ˆæ•ˆæœï¼Œéœ€è¦å®é™…è°ƒè¯•ä¸€æŠŠæ‰èƒ½å¼„æ¸…æ¥šã€‚</p>
<blockquote>
<p>iOS ç¼“å­˜å¯ä»¥å‚è€ƒï¼š<a href="http://nshipster.cn/nsurlcache/" target="_blank" rel="noopener">NSURLCache</a></p>
<p>PSï¼šä¸€èˆ¬å›¾ç‰‡å˜åŒ–å URL éƒ½ä¼šéšä¹‹å˜åŒ–ï¼Œè¯·æ±‚å›¾ç‰‡è¦æ±‚æœåŠ¡ç«¯è¿›è¡Œç¼“å­˜éªŒè¯çš„æƒ…å†µå¹¶ä¸å¤šè§ã€‚</p>
</blockquote>
<h4 id="æ¥æ”¶æ•°æ®"><a href="#æ¥æ”¶æ•°æ®" class="headerlink" title="æ¥æ”¶æ•°æ®"></a>æ¥æ”¶æ•°æ®</h4><p>è°ƒç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å°±ä¸è´´å‡ºæ¥äº†ï¼Œé‡ç‚¹åœ¨äºæ¥æ”¶æ•°æ®çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ ImageIO å®ç°æ¸è¿›å¼å›¾ç‰‡åŠ è½½ï¼Œå…³äº ImageIOï¼Œå¯ä»¥å‚è€ƒæ–‡æ¡£ <a href="https://developer.apple.com/library/content/documentation/GraphicsImaging/Conceptual/ImageIOGuide/imageio_basics/ikpg_basics.html" target="_blank" rel="noopener">Image I/O Programming Guide</a>ã€‚ä»£ç æ³¨é‡Šä½œè€…è¡¨æ˜ä»£ç æ˜¯æ¥è‡ªç½‘ç«™ <a href="http://www.cocoaintheshell.com/" target="_blank" rel="noopener">http://www.cocoaintheshell.com/</a> çš„ï¼Œä½†è²Œä¼¼è¿™ä¸ªç½‘ç«™ä¸å­˜åœ¨äº†ã€‚</p>
<p>è¿™æ®µä»£ç æœ‰ä¸€ä¸ªå°å°çš„ç»†èŠ‚ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯ä¸‹è½½ä¸‹æ¥çš„å›¾ç‰‡ä¼šé€šè¿‡ä¸‹é¢çš„æ–¹æ³•è¿›è¡Œæ‹‰ä¼¸å˜åŒ–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SDWebImageCompat.m</span><br><span class="line">inline UIImage *SDScaledImageForKey(NSString *key, UIImage *image) &#123;</span><br><span class="line">    if (!image) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if ([image.images count] &gt; 0) &#123;</span><br><span class="line">        NSMutableArray *scaledImages = [NSMutableArray array];</span><br><span class="line"></span><br><span class="line">        for (UIImage *tempImage in image.images) &#123;</span><br><span class="line">            [scaledImages addObject:SDScaledImageForKey(key, tempImage)];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return [UIImage animatedImageWithImages:scaledImages duration:image.duration];</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if ([[UIScreen mainScreen] respondsToSelector:@selector(scale)]) &#123;</span><br><span class="line">            CGFloat scale = [UIScreen mainScreen].scale;</span><br><span class="line">            if (key.length &gt;= 8) &#123;</span><br><span class="line">                NSRange range = [key rangeOfString:@&quot;@2x.&quot;];</span><br><span class="line">                if (range.location != NSNotFound) &#123;</span><br><span class="line">                    scale = 2.0;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                range = [key rangeOfString:@&quot;@3x.&quot;];</span><br><span class="line">                if (range.location != NSNotFound) &#123;</span><br><span class="line">                    scale = 3.0;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            UIImage *scaledImage = [[UIImage alloc] initWithCGImage:image.CGImage scale:scale orientation:image.imageOrientation];</span><br><span class="line">            image = scaledImage;</span><br><span class="line">        &#125;</span><br><span class="line">        return image;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å³ä¼šæ ¹æ®å±å¹•åˆ†è¾¨ç‡ä»¥åŠå›¾ç‰‡ URL ä¸­çš„ç‰¹å®šå­—ç¬¦â€@2x.â€å’Œâ€@3x.â€æ¥è¿›è¡Œå›¾ç‰‡çš„æ¯”ä¾‹ç¼©æ”¾ã€‚</p>
<h4 id="æ¥æ”¶å®Œæˆ"><a href="#æ¥æ”¶å®Œæˆ" class="headerlink" title="æ¥æ”¶å®Œæˆ"></a>æ¥æ”¶å®Œæˆ</h4><p>è°ƒç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">- (void)connectionDidFinishLoading:(NSURLConnection *)aConnection &#123;</span><br><span class="line">    SDWebImageDownloaderCompletedBlock completionBlock = self.completedBlock;</span><br><span class="line">    @synchronized(self) &#123;</span><br><span class="line">        // åœæ‰ Loop</span><br><span class="line">        CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">        self.thread = nil;</span><br><span class="line">        self.connection = nil;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadStopNotification object:self];</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadFinishNotification object:self];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // åˆ¤æ–­å“åº”æ˜¯å¦æ¥è‡ªç¼“å­˜</span><br><span class="line">    if (![[NSURLCache sharedURLCache] cachedResponseForRequest:_request]) &#123;</span><br><span class="line">        responseFromCached = NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (completionBlock) &#123;</span><br><span class="line">        // å¦‚æœå“åº”æ˜¯æ¥è‡ªç¼“å­˜ï¼Œä½†æ˜¯å¼€å‘è€…åˆè®¾ç½®äº†å¿½ç•¥ç¼“å­˜å“åº”çš„é€‰é¡¹ï¼Œåˆ™å›è°ƒæ— å›¾ç‰‡</span><br><span class="line">        if (self.options &amp; SDWebImageDownloaderIgnoreCachedResponse &amp;&amp; responseFromCached) &#123;</span><br><span class="line">            completionBlock(nil, nil, nil, YES);</span><br><span class="line">        &#125; else if (self.imageData) &#123;</span><br><span class="line">            UIImage *image = [UIImage sd_imageWithData:self.imageData];</span><br><span class="line">            NSString *key = [[SDWebImageManager sharedManager] cacheKeyForURL:self.request.URL];</span><br><span class="line">            image = [self scaledImageForKey:key image:image];</span><br><span class="line">            </span><br><span class="line">            // è§£ç å›¾ç‰‡</span><br><span class="line">            // Do not force decoding animated GIFs</span><br><span class="line">            if (!image.images) &#123;</span><br><span class="line">                if (self.shouldDecompressImages) &#123;</span><br><span class="line">                    image = [UIImage decodedImageWithImage:image];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (CGSizeEqualToSize(image.size, CGSizeZero)) &#123;</span><br><span class="line">                completionBlock(nil, nil, [NSError errorWithDomain:SDWebImageErrorDomain code:0 userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Downloaded image has 0 pixels&quot;&#125;], YES);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                completionBlock(image, self.imageData, nil, YES);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            completionBlock(nil, nil, [NSError errorWithDomain:SDWebImageErrorDomain code:0 userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Image data is nil&quot;&#125;], YES);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    self.completionBlock = nil;</span><br><span class="line">    [self done];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æœ¬èº«æ²¡æœ‰ä»€ä¹ˆéš¾æ‡‚çš„åœ°æ–¹ï¼Œä½†è¿™é‡Œé¢æ¶‰åŠåˆ°ä¸€ä¸ªæœ‰ç”¨çš„åŸºæœ¬çŸ¥è¯†â€”â€”<strong>å›¾ç‰‡ç±»å‹åˆ¤æ–­</strong>ï¼Œè®°å½•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+ (NSString *)sd_contentTypeForImageData:(NSData *)data &#123;</span><br><span class="line">    uint8_t c;</span><br><span class="line">    [data getBytes:&amp;c length:1];</span><br><span class="line">    switch (c) &#123;</span><br><span class="line">        case 0xFF:</span><br><span class="line">            return @&quot;image/jpeg&quot;;</span><br><span class="line">        case 0x89:</span><br><span class="line">            return @&quot;image/png&quot;;</span><br><span class="line">        case 0x47:</span><br><span class="line">            return @&quot;image/gif&quot;;</span><br><span class="line">        case 0x49:</span><br><span class="line">        case 0x4D:</span><br><span class="line">            return @&quot;image/tiff&quot;;</span><br><span class="line">        case 0x52:</span><br><span class="line">            // R as RIFF for WEBP</span><br><span class="line">            if ([data length] &lt; 12) &#123;</span><br><span class="line">                return nil;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            NSString *testString = [[NSString alloc] initWithData:[data subdataWithRange:NSMakeRange(0, 12)] encoding:NSASCIIStringEncoding];</span><br><span class="line">            if ([testString hasPrefix:@&quot;RIFF&quot;] &amp;&amp; [testString hasSuffix:@&quot;WEBP&quot;]) &#123;</span><br><span class="line">                return @&quot;image/webp&quot;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥å‰è™½ç„¶çœ‹è¿‡ä¸€äº›å›¾ç‰‡åŠ è½½åº“å¹¶å¯¹æ¯”è¿‡ä¸åŒæ ¼å¼çš„å›¾ç‰‡çš„å‚æ•°ï¼Œä½†æ²¡æœ‰æ•´ç†è¿‡æ¯ç§å›¾ç‰‡æ ¼å¼å¼€å¤´çš„é­”æ³•æ•°å­—ï¼Œè¿™ä¸ªå‡½æ•°è¡¨è¾¾çš„å¾ˆæ¸…æ™°ï¼Œä»¥åå¦‚æœæœ‰ç›¸å…³éœ€æ±‚å¯ä»¥æ‹¿æ¥ç›´æ¥ä½¿ç”¨ã€‚</p>
<blockquote>
<p>åœ¨ SDWebImage åº“ä¸­ï¼Œæ˜¯éœ€è¦æ ¹æ®ä¸åŒçš„ç±»å‹ä½¿ç”¨ä¸åŒçš„è§£ç æ–¹å¼ç”Ÿæˆå›¾ç‰‡çš„ï¼Œè¯»è€…æœ‰å…´è¶£ä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹è¿™éƒ¨åˆ†ä»£ç ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šå†…å®¹å¯¹ SDWebImage åŠ è½½å›¾ç‰‡çš„ç»†èŠ‚åšäº†ç®€å•çš„åˆ†ææè¿°ã€‚ä¸‹é¢é€šè¿‡ç±»å›¾æ¥å¤§è‡´æ•´ç†ä¸€ä¸‹å‰é¢æåˆ°çš„å‡½æ•°å’ŒåŠŸèƒ½å®ç°ä½ç½®ï¼ˆåŒæ ·æ¥è‡ªé¡¹ç›® Wikiï¼‰ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/SDWebImage ç±»å…³ç³»å›¾.png" alt="SDWebImage SDWebImage ç±»å…³ç³»å›¾"></div>

<p>ç»è¿‡å‰é¢çš„åˆ†æï¼Œå¯ä»¥ç³»ç»Ÿçœ‹ä¸€ä¸‹ SDWebImage çš„æ ¸å¿ƒæ¨¡å—ï¼š</p>
<ol>
<li><strong>UIView æ¨¡å—</strong> å¤„äºä¸Šå›¾çš„å·¦ä¸Šè§’éƒ¨åˆ†ï¼Œé€šè¿‡ Category ä¸º UIViewã€UIImageView å’Œ UIButton æ·»åŠ æ–¹æ³•ï¼Œè¡”æ¥ SDWebImage çš„åŠŸèƒ½ï¼›</li>
<li><strong>SDWebImageManager</strong> å¤„äºä¸Šå›¾çš„ä¸­å¿ƒï¼Œå®ƒæ˜¯è·å–å›¾ç‰‡æµç¨‹çš„åˆ¶å®šè€…ï¼Œè´Ÿè´£è°ƒåº¦ç¼“å­˜è·å–å’Œç½‘ç»œä¸‹è½½ä¸¤ç§å›¾ç‰‡è·å–æ–¹å¼ï¼›</li>
<li><strong>SDImageCache</strong> å¤„äºä¸Šå›¾å·¦ä¸‹è§’ï¼Œè´Ÿè´£å›¾ç‰‡çš„å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ï¼›</li>
<li><strong>ä¸‹è½½æ¨¡å—</strong> å¤„äºä¸Šå›¾çš„å³è¾¹éƒ¨åˆ†ï¼Œè´Ÿè´£å›¾ç‰‡çš„ä¸‹è½½ï¼›</li>
</ol>
<p>ä»¥ä¸Šå››ä¸ªæ¨¡å—é…åˆå‰é¢æ‰€è¯´çš„æµç¨‹ï¼Œå®Œæˆå›¾ç‰‡çš„åŠ è½½ã€è§£ç ä»¥åŠæ˜¾ç¤ºã€‚</p>
<p>æœ€åï¼ŒSDWebImage æ˜¯æˆ‘å­¦ä¹  iOS ä»¥æ¥åˆ†æçš„ç¬¬ä¸€ä¸ªæµè¡Œå¼€æºåº“ï¼Œå› ä¸ºä¹‹å‰ç ”ç©¶è¿‡ Andorid ä¸Šçš„ä¸€äº›å›¾ç‰‡åŠ è½½åº“ï¼Œæ¯”å¦‚ UILï¼ŒPicasso ç­‰ï¼Œå› æ­¤è§‰å¾—åˆ†æè¿™æ ·ä¸€ä¸ªåº“ä¼šæ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ï¼Œä¹Ÿç›¸å¯¹æœ‰ä¸ªå‚è€ƒï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å­¦ä¹ æœºä¼šï¼Œåˆ†æå®Œæˆä¹‹åï¼Œå¯¹äº GCDï¼ŒNSOperationï¼ŒBlockï¼ŒRunLoop ç­‰è¿™æ ·çš„åŸºç¡€æ¦‚å¿µæœ‰äº†æ›´å¤šçš„è®¤è¯†ï¼Œä¹Ÿç®—è¾¾åˆ°äº†æˆ‘çš„ç›®çš„ğŸ˜ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ã€è¯‘ã€‘ReactiveCocoa å…¥é—¨æ•™ç¨‹ï¼ˆä¸‹åŠéƒ¨åˆ†ï¼‰]]></title>
      <url>http://www.timebridge.space/2017/01/17/RAC%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>ç¿»è¯‘è‡ªï¼š<a href="https://www.raywenderlich.com/62796/reactivecocoa-tutorial-pt2" target="_blank" rel="noopener">ReactiveCocoa Tutorial â€“ The Definitive Introduction: Part 2/2</a></p>
<p>RAC æ˜¯ iOS ä¸Šä¸€ä¸ªå‡½æ•°å“åº”å¼ç¼–ç¨‹æ¡†æ¶ã€‚é€šè¿‡æœ¬æ•™ç¨‹çš„ä¸ŠåŠéƒ¨åˆ†å­¦ä¹ ï¼Œä½ åº”è¯¥çŸ¥é“å¦‚ä½•å°†åº”ç”¨ä¸­çš„æ ‡å‡† Action ä»¥åŠäº‹ä»¶å¤„ç†é€»è¾‘æ›¿æ¢æˆå¯ä»¥å‘é€äº‹ä»¶çš„ä¿¡å·ï¼Œä¹Ÿå­¦ä¼šäº†å¦‚ä½•è½¬æ¢ã€åˆ†å‰²ã€ç»„åˆè¿™äº›ä¿¡å·ã€‚åœ¨ä¸‹åŠéƒ¨åˆ†æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä¸€äº› RAC çš„é«˜çº§ä¸»é¢˜ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>å¦å¤–ä¸¤ç§äº‹ä»¶ç±»å‹ï¼šerror å’Œ completed</li>
<li>Throttling</li>
<li>Threading</li>
<li>Continuations</li>
<li>æ›´å¤šå…¶ä»–çš„â€¦</li>
</ul>
<p>Letâ€™s go!</p>
<h2 id="Twitter-Instant"><a href="#Twitter-Instant" class="headerlink" title="Twitter Instant"></a>Twitter Instant</h2><p>åœ¨ä¸‹åŠéƒ¨åˆ†æ•™ç¨‹ä¸­ï¼Œä½ è¦å¼€å‘çš„æ˜¯ä¸€ä¸ªå«åš Twitter Instantï¼ˆæ¥è‡ª Google Instant æ¦‚å¿µï¼‰çš„åº”ç”¨ï¼šä¸€ä¸ª Twitter å³æ—¶æœç´¢åº”ç”¨ã€‚<a id="more"></a></p>
<p><a href="https://koenig-media.raywenderlich.com/uploads/2014/01/TwitterInstant-Starter2.zip" target="_blank" rel="noopener">åˆå§‹é¡¹ç›®</a>ä¸­åŒ…å«äº†ä¸€äº›åŸºç¡€çš„ UI ç•Œé¢ä»¥åŠä¸€äº›å¿…é¡»çš„ä»£ç ã€‚åœ¨æ•™ç¨‹çš„ä¸Šç­éƒ¨åˆ†ä¸­ï¼Œéœ€è¦ä½¿ç”¨ CocoaPods æ¥è·å– RAC æ¡†æ¶å¹¶é›†æˆè¿›é¡¹ç›®ï¼Œè¿™ä¸ªåˆå§‹é¡¹ç›®å·²ç»åŒ…å«å¿…é¡»çš„ Podfileï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ‰“å¼€å‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘è¿™é‡Œç¼–è¯‘æ‰“å¼€åˆå§‹é¡¹ç›®çš„è¿‡ç¨‹ç•¥å»ä¸è¯‘ã€‚</p>
</blockquote>
<p>ç¼–è¯‘è¿è¡Œåå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/TwitterInstantStarter.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>ä½ å¯ä»¥èŠ±ä¸€ç‚¹æ—¶é—´ç†Ÿæ‚‰ä¸€ä¸‹åº”ç”¨ä»£ç ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åŸºäº UISplitViewController çš„åº”ç”¨ï¼Œå·¦è¾¹æ˜¯ <strong>RWSearchFormViewController</strong>ï¼Œæ·»åŠ äº†å°‘é‡çš„ UIControlsï¼ŒåŒ…æ‹¬ä¸€ä¸ªæœç´¢æ¡†ï¼›å³è¾¹æ˜¯ <strong>RWSearchResultsViewController</strong>ï¼Œç»§æ‰¿äº <strong>UITableViewController</strong>ã€‚</p>
<p>æ‰“å¼€ <strong>RWSearchResultsViewController.h</strong> æ–‡ä»¶ï¼Œä½ ä¼šçœ‹åˆ°<code>viewDidLoad</code>æ–¹æ³•å°†å³è¾¹å±•ç¤ºæœç´¢ç»“æœçš„ ViewController èµ‹å€¼ç»™äº†ç§æœ‰å±æ€§ <strong>resultsViewController</strong>ï¼Œåº”ç”¨çš„å¤§éƒ¨åˆ†é€»è¾‘éƒ½åœ¨ <strong>RWSearchResultsViewController</strong> ä¸­ï¼Œè¿™ä¸ªå±æ€§ä¼šå°†æœç´¢ç»“æœä¼ é€’ç»™ <strong>RWSearchResultsViewController</strong> ã€‚</p>
<h2 id="Validating-the-Search-Text"><a href="#Validating-the-Search-Text" class="headerlink" title="Validating the Search Text"></a>Validating the Search Text</h2><p>æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯éªŒè¯æœç´¢è¾“å…¥æ¡†çš„å†…å®¹ç¡®ä¿è¾“å…¥çš„å†…å®¹é•¿åº¦å¤§äº 2ï¼Œè¿™å¯¹äºä¸ŠåŠéƒ¨åˆ†çš„å­¦ä¹ æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤ä¹ ã€‚åœ¨<strong>RWSearchFormViewController.m</strong> çš„<code>viewDidLoad</code>æ–¹æ³•ä¹‹åæ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)isValidSearchText:(NSString *)text &#123;</span><br><span class="line">  return text.length &gt; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨<code>viewDidLoad</code>æ–¹æ³•çš„æœ€åæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[self.searchText.rac_textSignal</span><br><span class="line">  map:^id(NSString *text) &#123;</span><br><span class="line">    return [self isValidSearchText:text] ?</span><br><span class="line">      [UIColor whiteColor] : [UIColor yellowColor];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(UIColor *color) &#123;</span><br><span class="line">    self.searchText.backgroundColor = color;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>æ¥æƒ³æƒ³è¿™æ®µä»£ç åœ¨åšä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>è·å–è¾“å…¥æ¡†çš„å†…å®¹ä¿¡å·</li>
<li>æ ¹æ®å†…å®¹æ˜¯å¦åˆæ³•å°†è¿™ä¸ªä¿¡å·å¯¹åº”çš„èƒŒæ™¯é¢œè‰²å€¼</li>
<li>å°†èƒŒæ™¯é¢œè‰²å€¼é€šè¿‡<code>subscribeNext:</code>çš„ block è®¾ç½®ä¸ºæœç´¢è¾“å…¥æ¡†çš„èƒŒæ™¯ï¼›</li>
</ul>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œå°±å¯ä»¥çœ‹åˆ°å½“è¾“å…¥è¿‡çŸ­çš„æ—¶å€™ï¼Œè¾“å…¥æ¡†çš„é¢œè‰²æ˜¯é»„è‰²çš„ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/ValidatedTextField.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>ä»¥ä¸Šé€»è¾‘ç”¨å›¾ç‰‡è¡¨è¾¾ä¸ºï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/TextValidationPipeline.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p><code>rac_textSignal</code>ä¿¡å·åœ¨æ¯æ¬¡è¾“å…¥æ¡†å†…å®¹å˜åŒ–çš„æ—¶å€™é‡Šæ”¾æºå¸¦å½“å‰æœç´¢è¾“å…¥æ¡†è¾“å…¥å†…å®¹çš„ next äº‹ä»¶ï¼Œ<code>map</code>åˆ™å°†è¾“å…¥å†…å®¹è½¬æ¢ä¸ºé¢œè‰²ï¼Œæœ€ç»ˆç”±<code>subscribeNext:</code>æ–¹æ³•å°†é¢œè‰²å€¼è®¾ç½®ä¸ºè¾“å…¥æ¡†çš„èƒŒæ™¯é¢œè‰²ã€‚</p>
<p>å½“ç„¶ï¼Œçœ‹è¿‡ä¸ŠåŠéƒ¨åˆ†æ•™ç¨‹ä¹‹åä½ è‚¯å®šè¿˜è®°å¾—è¿™äº›ï¼Œå¦‚æœä¸è®°å¾—äº†ï¼Œæœ€å¥½å›è¿‡å¤´å»å¥½å¥½çœ‹çœ‹ä¸ŠåŠéƒ¨åˆ†æ•™ç¨‹ã€‚</p>
<p>åœ¨æ·»åŠ  Twitter æœç´¢é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè®¨è®ºä¸€äº›æœ‰æ„æ€çš„ä¸»é¢˜ã€‚</p>
<h2 id="Formatting-of-Pipelines"><a href="#Formatting-of-Pipelines" class="headerlink" title="Formatting of Pipelines"></a>Formatting of Pipelines</h2><p>å½“æˆ‘ä»¬æƒ³è¦æ ¼å¼åŒ– RAC ä»£ç çš„æ—¶å€™ï¼Œæ™®éçš„çº¦å®šæ˜¯æ¯ä¸€ä¸ªæ“ä½œéƒ½æ–°èµ·ä¸€è¡Œï¼Œç„¶åæ¯ä¸€æ­¥éƒ½å‚ç›´å¯¹é½ï¼Œä¸‹é¢å°±æ˜¯ä¹‹å‰ç¤ºä¾‹çš„ä¸€ä¸ªæ ¼å¼åŒ–å±•ç¤ºï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/PipelineFormatting.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>è¿™æ ·è¿™ä¸ªç®¡é“æ˜¯ç”±å“ªäº›æ­¥éª¤ç»„æˆçš„å°±ä¸€ç›®äº†ç„¶ã€‚åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œæ¯ä¸ª block ä¸­çš„ä»£ç éƒ½è¦å°½é‡å°‘ï¼Œè¶…è¿‡ä¸€å®šè¡Œæ•°ä¹‹åæœ€å¥½ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„æ–¹æ³•å»è¡¨è¾¾ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘å¦‚æœ block å†…å®¹è¿‡é•¿ï¼Œä¼šå¯¼è‡´ RAC ä»£ç çš„å¯é˜…è¯»æ€§å¤§å¤§é™ä½ã€‚</p>
</blockquote>
<p>ä¸å¹¸çš„æ˜¯ Xcode å¹¶ä¸æ”¯æŒè¿™ç§é£æ ¼çš„æ ¼å¼åŒ–ï¼Œæ‰€ä»¥å¾—å¼€å‘è€…è‡ªå·±ç»´æŠ¤è¿™æ ·çš„ç¼©è¿›ã€‚</p>
<h2 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h2><p>å›è¿‡å¤´æ¥çœ‹çœ‹æˆ‘ä»¬æ·»åŠ åˆ° <strong>TwitterInstant</strong> åº”ç”¨ä¸­çš„ä»£ç ï¼Œä½ æ˜¯å¦ä¼šå¥½å¥‡ä½ åˆšåˆšåˆ›å»ºçš„ç®¡é“æ˜¯å¦‚ä½•è¢«ç»´æŒåœ¨å†…å­˜ä¸­çš„å‘¢ï¼Ÿå®ƒæ—¢æ²¡æœ‰è¢«èµ‹å€¼ç»™ä¸€ä¸ªæœ¬åœ°å˜é‡ï¼Œä¹Ÿæ²¡æœ‰èµ‹å€¼ç»™ä¸€ä¸ªå±æ€§ï¼Œæ˜¯ä¸æ˜¯å®ƒçš„å¼•ç”¨è®¡æ•°ä¸ä¼šè¢«å¢åŠ ï¼Œä¸€å®šä¼šè¢«å›æ”¶æ‰ï¼Ÿ</p>
<p>å®é™…ä¸Š RAC çš„è®¾è®¡ç›®æ ‡ä¹‹ä¸€å°±æ˜¯å…è®¸åˆ›å»ºåŒ¿åç®¡é“è¿™æ ·çš„ç¼–ç æ–¹å¼ï¼Œåœ¨å‰é¢æˆ‘ä»¬å†™è¿‡çš„æ‰€æœ‰ RAC ä»£ç ä¸­ï¼Œè¿™ä¸ªç‰¹æ€§æ˜¾å¾—è‡ªç„¶ç›´è§‚ã€‚</p>
<p>ä¸ºäº†æ”¯æŒè¿™ä¸ªæ¨¡å‹ï¼ŒRAC ç»´æŠ¤è¿™è‡ªå·±çš„ä¿¡å·å…¨å±€é›†åˆã€‚å¦‚æœä¸€ä¸ªä¿¡å·æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªè®¢é˜…è€…ï¼Œåˆ™ä¿¡å·æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰è®¢é˜…è€…ï¼Œåˆ™ä¿¡å·ä¼šè¢«å›æ”¶æ‰ã€‚è¿™å°±å¼•èµ·äº†å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬å¦‚ä½•å–æ¶ˆè®¢é˜…ä¸€ä¸ªä¿¡å·ï¼Ÿåœ¨ä¿¡å·å‘é€ error/completed äº‹ä»¶ä¹‹åï¼Œè®¢é˜…å…³ç³»ä¼šè¢«è‡ªåŠ¨ç§»é™¤æ‰ï¼ˆåé¢ä¼šé©¬ä¸Šè¯´åˆ°ï¼‰ï¼Œè€Œæ‰‹åŠ¨çš„å–æ¶ˆè®¢é˜…åˆ™å¯ä»¥é€šè¿‡<code>RACDisposable</code>æ¥è¿›è¡Œã€‚</p>
<p>è®¢é˜…<code>RACSignal</code>çš„æ—¶å€™éƒ½ä¼šè¿”å›ä¸€ä¸ª<code>RACDisposable</code>å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å°±å…è®¸å¼€å‘è€…æ‰‹åŠ¨è§£é™¤è®¢é˜…å…³ç³»ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *backgroundColorSignal =</span><br><span class="line">  [self.searchText.rac_textSignal</span><br><span class="line">    map:^id(NSString *text) &#123;</span><br><span class="line">      return [self isValidSearchText:text] ?</span><br><span class="line">        [UIColor whiteColor] : [UIColor yellowColor];</span><br><span class="line">    &#125;];</span><br><span class="line"> </span><br><span class="line">RACDisposable *subscription =</span><br><span class="line">  [backgroundColorSignal</span><br><span class="line">    subscribeNext:^(UIColor *color) &#123;</span><br><span class="line">      self.searchText.backgroundColor = color;</span><br><span class="line">    &#125;];</span><br><span class="line"> </span><br><span class="line">// at some point in the future ...</span><br><span class="line">[subscription dispose];</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°ä½ å¾ˆå°‘å»åšè¿™ä»¶äº‹æƒ…ï¼Œä½†æ˜¯åº”è¯¥è¦çŸ¥é“è¿™ç§æ“ä½œçš„å­˜åœ¨ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>ç”±æ­¤æ¨å‡ºï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªç®¡é“ä½†æ˜¯ä¸å»è®¢é˜…å®ƒï¼Œé‚£è¿™ä¸ªç®¡é“å°±æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼ŒåŒ…æ‹¬<code>doNext:</code>è¿™æ ·çš„ side-effect blockã€‚</p>
</blockquote>
<h2 id="Avoiding-Retain-Cycles"><a href="#Avoiding-Retain-Cycles" class="headerlink" title="Avoiding Retain Cycles"></a>Avoiding Retain Cycles</h2><p>RAC è™½ç„¶ä¸ºæ­¤åšäº†å¾ˆå¤šå¹•åå·¥ä½œï¼Œè®©å¼€å‘è€…ä¸å¿…æ‹…å¿ƒæœ‰å…³ä¿¡å·çš„å†…å­˜ç®¡ç†ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸€ç§æƒ…å†µéœ€è¦å¼€å‘è€…æ³¨æ„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å‰é¢æ·»åŠ çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[self.searchText.rac_textSignal</span><br><span class="line">  map:^id(NSString *text) &#123;</span><br><span class="line">    return [self isValidSearchText:text] ?</span><br><span class="line">      [UIColor whiteColor] : [UIColor yellowColor];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(UIColor *color) &#123;</span><br><span class="line">    self.searchText.backgroundColor = color;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p><code>subscribeNext:</code> block åœ¨å†…éƒ¨ä½¿ç”¨äº† self æ¥å¼•ç”¨å¤–éƒ¨çš„è¾“å…¥æ¡†ï¼Œblock æŒæœ‰å¯¹ self çš„å¼ºå¼•ç”¨ï¼Œå› æ­¤å¦‚æœ self å¯¹ block ä¹Ÿæœ‰å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå½¢æˆä¸€ä¸ªå¾ªç¯å¼•ç”¨ã€‚è¿™ä¸ªæ˜¯å¦ä¼šå¼•èµ·é—®é¢˜å–å†³äº self å¯¹è±¡æœ¬èº«ï¼Œå¦‚æœ self è´¯ç©¿åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°±å¦‚ä¸Šé¢çš„ä¾‹å­æ‰€ç¤ºï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜å°±æ²¡é‚£ä¹ˆä¸¥é‡ï¼Œä½†æ˜¯åœ¨æ›´ä¸ºå¤æ‚çš„æƒ…å†µä¸‹ï¼Œææ€•å°±ä¸æ˜¯è¿™æ ·çš„äº†ã€‚</p>
<p>ä¸ºäº†é¿å…æ½œåœ¨çš„å¾ªç¯å¼•ç”¨ï¼Œè‹¹æœå®˜æ–¹çš„æ–‡æ¡£ <a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/ProgrammingWithObjectiveC/WorkingwithBlocks/WorkingwithBlocks.html#//apple_ref/doc/uid/TP40011210-CH8-SW16" target="_blank" rel="noopener">Working With Blocks</a> å»ºè®®åœ¨ block ä¸­å¼•ç”¨ self çš„å¼±å¼•ç”¨ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__weak RWSearchFormViewController *bself = self; // Capture the weak reference</span><br><span class="line"> </span><br><span class="line">[[self.searchText.rac_textSignal</span><br><span class="line">  map:^id(NSString *text) &#123;</span><br><span class="line">    return [self isValidSearchText:text] ?</span><br><span class="line">      [UIColor whiteColor] : [UIColor yellowColor];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(UIColor *color) &#123;</span><br><span class="line">    bself.searchText.backgroundColor = color;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>bself æ˜¯æŒ‡å‘ self çš„ä½¿ç”¨ __weak ä¿®é¥°çš„å˜é‡ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘ self çš„å¼±å¼•ç”¨ï¼Œè€Œåœ¨<code>subscribeNext:</code> block å—ä¸­ï¼Œæˆ‘ä»¬æŠŠ self æ›¿æ¢æˆ bselfï¼Œè¿™æ ·å°±æ‰“ç ´äº†å¾ªç¯å¼•ç”¨ã€‚ä¸è¿‡è¿™çœ‹ä¸Šå»å¹¶ä¸é‚£ä¹ˆä¼˜é›…ã€‚</p>
<p>RAC æ¡†æ¶åœ¨è¿™é‡Œç©äº†ä¸€ç‚¹å°æŠŠæˆï¼Œæˆ‘ä»¬å¯ä»¥å¯¼å…¥ä»¥ä¸‹å¤´æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;RACEXTScope.h&quot;</span><br></pre></td></tr></table></figure>
<p>ç„¶åç”¨ä¸‹é¢çš„ä»£ç å®ç°ç­‰åŒçš„æ•ˆæœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@weakify(self)</span><br><span class="line">[[self.searchText.rac_textSignal</span><br><span class="line">  map:^id(NSString *text) &#123;</span><br><span class="line">    return [self isValidSearchText:text] ?</span><br><span class="line">      [UIColor whiteColor] : [UIColor yellowColor];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(UIColor *color) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    self.searchText.backgroundColor = color;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p><code>@weakify</code>å’Œ<code>@strongify</code>è¯­å¥æ˜¯å®šä¹‰åœ¨ <a href="https://github.com/jspahrsummers/libextobjc" target="_blank" rel="noopener">Extended Objective-C </a>ä¸­çš„å®ï¼Œå®ƒä»¬ä¹Ÿè¢«åŒ…å«åœ¨äº† RAC æ¡†æ¶ä¸­ï¼Œ<code>@weakify</code>å®å…è®¸ä½ åˆ›å»ºå¼±å¼•ç”¨å˜é‡ï¼ˆå¦‚æœæœ‰éœ€è¦ï¼Œè¿˜å¯ä»¥ä¼ å…¥å¤šä¸ªå˜é‡ä½œä¸ºå‚æ•°ï¼‰ï¼Œ<code>@strongify</code>å®åˆ™å…è®¸ä½ æ ¹æ®ä¹‹å‰ä¼ å…¥<code>@weakify</code>çš„å‚æ•°åˆ›å»ºå¼ºå¼•ç”¨ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>å¦‚æœä½ å¯¹è¿™ä¸¤ä¸ªå®çš„å…·ä½“å®ç°æ„Ÿå…´è¶£ï¼Œå¯ä»¥åœ¨ Xcode ä¸­é€‰æ‹© <strong>Product-&gt;Perform Action-&gt;Preprocess â€œRWSearchForViewControllerâ€.</strong> è¿™ä¼šé¢„å¤„ç†ä¸€éå½“å‰çš„ view controllerï¼Œå±•å¼€æ‰€æœ‰çš„å®ï¼Œå¼€å‘è€…å°†å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„è¾“å‡ºã€‚</p>
</blockquote>
<p>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ block å†…éƒ¨ä½¿ç”¨å®ä¾‹å˜é‡ä¹Ÿä¼šé€ æˆ block æŒæœ‰å¯¹ self çš„å¼ºå¼•ç”¨ï¼Œä½ å¯ä»¥æ‰“å¼€ç¼–è¯‘å™¨çš„å‘Šè­¦å¼€å…³ï¼Œåœ¨ä»£ç å‡ºç°è¿™ç§é—®é¢˜çš„æ—¶å€™è­¦å‘Šä½ ï¼Œåœ¨é¡¹ç›®çš„ build settings ä¸­æœç´¢ retain å°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªé€‰é¡¹ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/AvoidRetainSelf.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>å¥½äº†ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡è¿™ä¸ªè¦ç‚¹äº†ï¼Œæ­å–œï¼ç°åœ¨ä½ å¯ä»¥ç»§ç»­å­¦ä¹ å‰©ä¸‹çš„æœ‰è¶£éƒ¨åˆ†äº†ï¼šä¸ºä½ çš„åº”ç”¨æ·»åŠ ä¸€äº›çœŸæ­£çš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>çœ¼å°–çš„è¯»è€…è‚¯å®šæ³¨æ„åˆ°è¿™é‡Œå®é™…ä¸å¿…ä½¿ç”¨<code>subscribeNext:</code>æ–¹æ³•ï¼Œä½¿ç”¨ RAC æ›¿ä»£å³å¯ï¼Œå¦‚æœä½ å‘ç°äº†è¿™ç‚¹ï¼Œè¯·æ”¹æ‰å®ƒï¼Œå¹¶å¥–åŠ±ç»™è‡ªå·±ä¸€ä¸ªäº®é—ªé—ªçš„âœ¨ã€‚</p>
</blockquote>
<h2 id="Requesting-Access-to-Twitter"><a href="#Requesting-Access-to-Twitter" class="headerlink" title="Requesting Access to Twitter"></a>Requesting Access to Twitter</h2><p>æ¥ä¸‹æ¥ä½ å°†è¦ä½¿ç”¨ <strong>Social Framework</strong> è®© TwitterInstant åº”ç”¨æœç´¢ Tweetsï¼Œä½¿ç”¨ <strong>Accounts Framework</strong> æ¥æˆæƒè®¿é—® Twitterã€‚ä¸ºäº†æ›´å¥½çš„äº†è§£ <strong>Social Framework</strong>ï¼Œå¯ä»¥æŸ¥çœ‹ä¸“é—¨ä¸ºæ­¤å‡†å¤‡çš„ç« èŠ‚ï¼š<a href="https://www.raywenderlich.com/?page_id=19968" target="_blank" rel="noopener">iOS 6 by Tutorials</a>ã€‚</p>
<p>åœ¨ä½ æ·»åŠ è¿™æ®µä»£ç ä¹‹å‰ï¼Œä½ éœ€è¦å°† Twitter è®¤è¯ä¿¡æ¯æ·»åŠ åˆ°æ¨¡æ‹Ÿå™¨æˆ–è€…è¿è¡Œåº”ç”¨çš„è®¾å¤‡ä¸Šã€‚æ‰“å¼€<strong>è®¾ç½®</strong>åº”ç”¨ç„¶åé€‰æ‹©<strong>Twitter</strong>èœå•é€‰é¡¹ï¼Œæ·»åŠ ä½ çš„èº«ä»½ä¿¡æ¯ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/TwitterCredentials.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>åˆå§‹é¡¹ç›®å·²ç»åŒ…å«æ‰€éœ€è¦çš„ Frameworkï¼Œæ‰€ä»¥ä½ åªéœ€è¦å¯¼å…¥ header å°±å¥½ã€‚åœ¨<code>RWSearchFormViewController.m</code>æ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹è¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Accounts/Accounts.h&gt;</span><br><span class="line">#import &lt;Social/Social.h&gt;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>import</code>è¯­å¥ä¸‹é¢æ·»åŠ å¦‚ä¸‹æšä¸¾ç±»å‹å’Œå¸¸é‡å€¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSInteger, RWTwitterInstantError) &#123;</span><br><span class="line">    RWTwitterInstantErrorAccessDenied,</span><br><span class="line">    RWTwitterInstantErrorNoTwitterAccounts,</span><br><span class="line">    RWTwitterInstantErrorInvalidResponse</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">static NSString * const RWTwitterInstantDomain = @&quot;TwitterInstant&quot;;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹å»ä½ ä¼šç”¨è¿™äº›æšä¸¾ç±»å‹æ¥å®šä¹‰ä¸€äº›é”™è¯¯ã€‚æ¥ç€æ·»åŠ å¦‚ä¸‹å±æ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@property (strong, nonatomic) ACAccountStore *accountStore;</span><br><span class="line">@property (strong, nonatomic) ACAccountType *twitterAccountType;</span><br></pre></td></tr></table></figure>
<p><code>ACAccountStore</code>ç±»å¯ä»¥å¸®åŠ©é“¾æ¥å„ç§ç¤¾äº¤åª’ä½“è´¦å·ï¼Œ<code>ACAccountType</code>ç±»ä»£è¡¨ä¸€ç§ç‰¹å®šç±»å‹çš„è´¦å·ã€‚</p>
<p>æ¥ç€åœ¨<code>viewDidLoad</code>æ–¹æ³•æœ«å°¾æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.accountStore = [[ACAccountStore alloc] init];</span><br><span class="line">self.twitterAccountType = [self.accountStore </span><br><span class="line">  accountTypeWithAccountTypeIdentifier:ACAccountTypeIdentifierTwitter];</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç åˆ›å»ºäº† account store ä»¥åŠ Twitter è´¦å·æ ‡è®°ã€‚</p>
<p>å½“ä¸€ä¸ª App æƒ³è¦è®¿é—®ä¸€ä¸ªç¤¾äº¤åª’ä½“è´¦å·ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ä¸€ä¸ªå¼¹çª—ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå› æ­¤å°†å®ƒåŒ…è£¹åœ¨ä¿¡å·ä¸­ï¼Œæ˜¯å®ƒå˜æˆå“åº”å¼æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚æˆ‘ä»¬åœ¨ä»£ç ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)requestAccessToTwitterSignal &#123;</span><br><span class="line"> </span><br><span class="line">  // 1 - define an error</span><br><span class="line">  NSError *accessError = [NSError errorWithDomain:RWTwitterInstantDomain</span><br><span class="line">                                             code:RWTwitterInstantErrorAccessDenied</span><br><span class="line">                                         userInfo:nil];</span><br><span class="line"> </span><br><span class="line">  // 2 - create the signal</span><br><span class="line">  @weakify(self)</span><br><span class="line">  return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    // 3 - request access to twitter</span><br><span class="line">    @strongify(self)</span><br><span class="line">    [self.accountStore</span><br><span class="line">       requestAccessToAccountsWithType:self.twitterAccountType</span><br><span class="line">         options:nil</span><br><span class="line">      completion:^(BOOL granted, NSError *error) &#123;</span><br><span class="line">          // 4 - handle the response</span><br><span class="line">          if (!granted) &#123;</span><br><span class="line">            [subscriber sendError:accessError];</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            [subscriber sendNext:nil];</span><br><span class="line">            [subscriber sendCompleted];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    return nil;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p>
<ol>
<li>å®šä¹‰äº†ä¸€ä¸ª errorï¼Œå¦‚æœç”¨æˆ·æ‹’ç» App è®¿é—®è´¦å·ï¼Œè¿™ä¸ªé”™è¯¯ä¼šè¢«è¿”å›ï¼›</li>
<li>å’Œä¸ŠåŠéƒ¨åˆ†æ•™ç¨‹ä¸€æ ·ï¼Œæ–¹æ³•<code>createSignal</code>è¿”å›äº†<code>RACSignal</code>ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼›</li>
<li>è®¿é—® Twitter çš„è¯·æ±‚æ˜¯é€šè¿‡ account store å‘å‡ºçš„ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ä¸€ä¸ªå¼¹çª—æ¥è¯·æ±‚ç”¨æˆ·æˆäºˆæƒé™ï¼›</li>
<li>å½“ç”¨æˆ·æˆäºˆ / æ‹’ç»è®¿é—®æƒé™ä¹‹åï¼Œä¿¡å·å°±ä¼šè¢«å‘é€ã€‚å¦‚æœæˆäºˆäº†æƒé™ï¼Œnext äº‹ä»¶ä¹‹åä¼šå‘é€ completed äº‹ä»¶ï¼Œå¦‚æœè¯·æ±‚è¢«æ‹’ç»ï¼Œerror äº‹ä»¶ä¼šè¢«å‘é€ï¼›</li>
</ol>
<p>å¦‚æœä½ è¿˜è®°å¾—ä¸ŠåŠéƒ¨åˆ†æ•™ç¨‹ï¼Œå…¶ä¸­æåˆ°è¿‡ä¿¡å·å¯ä»¥å‘é€ä¸‰ç§ç±»å‹çš„äº‹ä»¶ï¼šnextã€completed å’Œ errorã€‚åœ¨ä¸€ä¸ªä¿¡å·çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå®ƒå¯ä»¥ä¸å‘é€ä»»ä½•äº‹ä»¶ï¼Œå‘é€ä¸€ä¸ªæˆ–è€…å¤šä¸ª next äº‹ä»¶å¹¶ä»¥ä¸€ä¸ª completed / error äº‹ä»¶ç»“æŸã€‚</p>
<p>æœ€åï¼Œä¸ºäº†ä½¿ç”¨è¿™ä¸ªä¿¡å·ï¼Œå°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°<code>viewDidLoad</code>æ–¹æ³•åé¢ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[[self requestAccessToTwitterSignal]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;Access granted&quot;);</span><br><span class="line">  &#125; error:^(NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;An error occurred: %@&quot;, error);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œå°†ä¼šçœ‹åˆ°ä»¥ä¸‹å¼¹çª—ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/RequestAccessToTwitter.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>å¦‚æœä½ ç‚¹å‡» <strong>OK</strong>ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºï¼šAccess grantedï¼›ç‚¹å‡» <strong>Donâ€™t Allow</strong>ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºï¼šAn error occurred:xxxã€‚</p>
<p>Accounts Framework ä¼šè®°ä½ä½ çš„é€‰æ‹©ï¼Œå› æ­¤å¦‚æœéœ€è¦æµ‹è¯•ä¸¤ç§æƒ…å†µï¼Œéœ€è¦é‡ç½® <strong>iOS Simulator -&gt; Reset Contents and Settings</strong> èœå•é€‰é¡¹ï¼Œè¿™ä¼šæœ‰ç‚¹éº»çƒ¦ï¼Œå› ä¸ºä½ å¿…é¡»å†è¾“å…¥ä¸€éä½ çš„ Twitter è´¦å·ã€‚</p>
<h2 id="Chaining-Signals"><a href="#Chaining-Signals" class="headerlink" title="Chaining Signals"></a>Chaining Signals</h2><p>ä¸€æ—¦ç”¨æˆ·æˆäºˆ Twitter è´¦å·æƒé™ï¼Œåº”ç”¨å°±éœ€è¦æŒç»­çš„ç›‘å¬æœç´¢è¾“å…¥æ¡†çš„å˜åŒ–ï¼ŒåŠæ—¶æœç´¢ Twitterã€‚åœ¨ <code>viewDidLoad</code>æ–¹æ³•æœ€åæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[[self requestAccessToTwitterSignal]</span><br><span class="line">  then:^RACSignal *&#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return self.searchText.rac_textSignal;</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125; error:^(NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;An error occurred: %@&quot;, error);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p><code>then</code>æ–¹æ³•ä¼šåœ¨æ”¶åˆ° completed äº‹ä»¶ä¹‹åï¼Œç«‹åˆ»è®¢é˜…ç”±<code>then</code>è¿”å›çš„ä¿¡å·ï¼Œç”¨äºé«˜æ•ˆçš„ä»è®¢é˜…ä¸€ä¸ªä¿¡å·è½¬ç§»åˆ°è®¢é˜…å¦å¤–ä¸€ä¸ªã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>å‰é¢å·²ç»å£°æ˜äº†ä¸€ä¸ª@weakify(self)ï¼Œè¿™é‡Œä¸ç”¨é‡å¤å£°æ˜ã€‚</p>
</blockquote>
<p>error äº‹ä»¶ä¼šç©¿è¿‡<code>then</code>æ–¹æ³•ï¼Œå› æ­¤åé¢çš„<code>subscribeNext:error:</code>  block ä¾ç„¶èƒ½å¤Ÿæ¥æ”¶åˆ°å‰é¢æƒé™è¯·æ±‚æ‰€å‘å‡ºçš„ error äº‹ä»¶ã€‚</p>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œç„¶åæˆäºˆæƒé™ã€‚åœ¨è¾“å…¥æœç´¢å†…å®¹çš„åŒæ—¶ï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°çš„å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2014-01-04 08:16:11.444 TwitterInstant[39118:a0b] m</span><br><span class="line">2014-01-04 08:16:12.276 TwitterInstant[39118:a0b] ma</span><br><span class="line">2014-01-04 08:16:12.413 TwitterInstant[39118:a0b] mag</span><br><span class="line">2014-01-04 08:16:12.548 TwitterInstant[39118:a0b] magi</span><br><span class="line">2014-01-04 08:16:12.628 TwitterInstant[39118:a0b] magic</span><br><span class="line">2014-01-04 08:16:13.172 TwitterInstant[39118:a0b] magic!</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œå¯ä»¥ä¸ºç®¡é“æ·»åŠ è¿‡æ»¤å™¨ï¼Œè¿‡æ»¤éæ³•çš„æœç´¢å…³é”®å­—ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å®šä¹‰æœç´¢å­—ç¬¦æ•°å°‘äº3ä¸ªå³ä¸ºéæ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[[[[self requestAccessToTwitterSignal]</span><br><span class="line">  then:^RACSignal *&#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return self.searchText.rac_textSignal;</span><br><span class="line">  &#125;]</span><br><span class="line">  filter:^BOOL(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self isValidSearchText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125; error:^(NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;An error occurred: %@&quot;, error);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾å±•ç¤ºäº†å½“å‰çš„ç®¡é“é€»è¾‘ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/PipelineWithThen.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>åº”ç”¨ç¨‹åºç®¡é“ç”±<code>requestAccessToTwitterSignal</code>å¼€å§‹ï¼Œç„¶ååˆ‡æ¢åˆ°<code>rac_textSignal</code>ä¿¡å·ï¼ŒåŒæ—¶ï¼Œnext ç±»å‹äº‹ä»¶ç»è¿‡<code>filter</code>æ–¹æ³•è¿‡æ»¤ï¼Œæœ€ç»ˆåˆ°è¾¾è®¢é˜… blockï¼Œä½ å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ­¥è§¦å‘çš„ error äº‹ä»¶è¿˜æ˜¯ä¼šè¢«æœ€åçš„<code>subscribeNext:error:</code> block æ¶ˆè´¹ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘error äº‹ä»¶çš„è¿™ç§ç‰¹æ€§ä½¿å¾—ç®¡é“å¯ä»¥åœ¨ä¸€ä¸ªç»Ÿä¸€çš„åœ°æ–¹å¤„ç†é”™è¯¯ã€‚</p>
</blockquote>
<p>æ—¢ç„¶å·²ç»æœ‰äº†ä¸€ä¸ªä¿¡å·ç”¨äºé€šçŸ¥æœç´¢å†…å®¹çš„å˜åŒ–ï¼Œé‚£æ¥ä¸‹æ¥æ˜¯æ—¶å€™ç”¨å®ƒæ¥æœç´¢ Twitter äº†ï¼ä½ è§‰å¾—æœ‰è¶£å—ï¼Ÿæˆ‘è§‰å¾—åº”è¯¥æ˜¯è§‰å¾—æœ‰è¶£çš„ï¼Œå› ä¸ºä½ å·²ç»çœŸæ­£äº†è§£ä¸€äº›ä¸œè¥¿äº†ã€‚</p>
<h2 id="Searching-Twitter"><a href="#Searching-Twitter" class="headerlink" title="Searching Twitter"></a>Searching Twitter</h2><p><strong>Social Framework</strong> æ˜¯è·å– Twitter æœç´¢ API çš„ä¸€ç§æ¸ é“ã€‚ç„¶è€Œ <strong>Social Framework</strong> å¹¶ä¸æ˜¯å“åº”å¼çš„ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ç”¨ä¿¡å·å»åŒ…è£¹è¿™äº› APIã€‚ä½ ç°åœ¨åº”è¯¥å»æŒæ¡è¿™æ ·åšçš„çªé—¨äº†ï¼</p>
<p>åœ¨<code>RWSearchFormViewController.m</code>å†…éƒ¨ï¼Œæ·»åŠ å¦‚ä¸‹çš„æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (SLRequest *)requestforTwitterSearchWithText:(NSString *)text &#123;</span><br><span class="line">  NSURL *url = [NSURL URLWithString:@&quot;https://api.twitter.com/1.1/search/tweets.json&quot;];</span><br><span class="line">  NSDictionary *params = @&#123;@&quot;q&quot; : text&#125;;</span><br><span class="line"> </span><br><span class="line">  SLRequest *request =  [SLRequest requestForServiceType:SLServiceTypeTwitter</span><br><span class="line">                                           requestMethod:SLRequestMethodGET</span><br><span class="line">                                                     URL:url</span><br><span class="line">                                              parameters:params];</span><br><span class="line">  return request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä½¿ç”¨ <a href="https://dev.twitter.com/docs/api/1.1" target="_blank" rel="noopener">v1.1 REST API</a> åˆ›å»ºäº†ä¸€ä¸ªæœç´¢ Twitter çš„è¯·æ±‚ï¼Œä»¥ä¸Šä»£ç ä½¿ç”¨ <strong>q</strong> å…³é”®å­—æ¥æœç´¢åŒ…å«è¾“å…¥å†…å®¹çš„ Twitterï¼Œä½ å¯ä»¥ä»  <a href="https://dev.twitter.com/docs/api/1.1/get/search/tweets" target="_blank" rel="noopener">Twitter API docs</a> ä¸­äº†è§£æ›´å¤šå…³äºæœç´¢ API çš„ç»†èŠ‚ã€‚</p>
<p>ä¸‹é¢ä¸€æ­¥å°±æ˜¯åŸºäºè¿™ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªä¿¡å·ï¼Œæ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)signalForSearchWithText:(NSString *)text &#123;</span><br><span class="line"> </span><br><span class="line">  // 1 - define the errors</span><br><span class="line">  NSError *noAccountsError = [NSError errorWithDomain:RWTwitterInstantDomain</span><br><span class="line">                                                 code:RWTwitterInstantErrorNoTwitterAccounts</span><br><span class="line">                                             userInfo:nil];</span><br><span class="line"> </span><br><span class="line">  NSError *invalidResponseError = [NSError errorWithDomain:RWTwitterInstantDomain</span><br><span class="line">                                                      code:RWTwitterInstantErrorInvalidResponse</span><br><span class="line">                                                  userInfo:nil];</span><br><span class="line"> </span><br><span class="line">  // 2 - create the signal block</span><br><span class="line">  @weakify(self)</span><br><span class="line">  return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    @strongify(self);</span><br><span class="line"> </span><br><span class="line">    // 3 - create the request</span><br><span class="line">    SLRequest *request = [self requestforTwitterSearchWithText:text];</span><br><span class="line"> </span><br><span class="line">    // 4 - supply a twitter account</span><br><span class="line">    NSArray *twitterAccounts = [self.accountStore</span><br><span class="line">      accountsWithAccountType:self.twitterAccountType];</span><br><span class="line">    if (twitterAccounts.count == 0) &#123;</span><br><span class="line">      [subscriber sendError:noAccountsError];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      [request setAccount:[twitterAccounts lastObject]];</span><br><span class="line"> </span><br><span class="line">      // 5 - perform the request</span><br><span class="line">      [request performRequestWithHandler: ^(NSData *responseData,</span><br><span class="line">                                          NSHTTPURLResponse *urlResponse, NSError *error) &#123;</span><br><span class="line">        if (urlResponse.statusCode == 200) &#123;</span><br><span class="line"> </span><br><span class="line">          // 6 - on success, parse the response</span><br><span class="line">          NSDictionary *timelineData =</span><br><span class="line">             [NSJSONSerialization JSONObjectWithData:responseData</span><br><span class="line">                                             options:NSJSONReadingAllowFragments</span><br><span class="line">                                               error:nil];</span><br><span class="line">          [subscriber sendNext:timelineData];</span><br><span class="line">          [subscriber sendCompleted];</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">          // 7 - send an error on failure</span><br><span class="line">          [subscriber sendError:invalidResponseError];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    return nil;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ‰§è¡Œçš„åŠŸèƒ½æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆå®šä¹‰äº†ä¸€äº›ä¸åŒçš„ errorï¼Œä¸€ä¸ªç”¨äºè¡¨ç¤ºç”¨æˆ·æ²¡æœ‰æ·»åŠ ä»»ä½•çš„ Twitter è´¦å·ï¼Œä¸€ä¸ªç”¨äºè¡¨ç¤ºæŸ¥è¯¢å‡ºé”™ï¼›</li>
<li>åˆ›å»ºä¿¡å·ï¼›</li>
<li>åˆ©ç”¨å‰é¢æ·»åŠ çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªè¯·æ±‚ï¼›</li>
<li>æŸ¥è¯¢ account store çš„ç¬¬ä¸€ä¸ªè´¦å·ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•è´¦å·å¯æŸ¥è¯¢ï¼ŒæŠ¥é”™ï¼›</li>
<li>æ‰§è¡Œè¯·æ±‚ï¼›</li>
<li>å¦‚æœè¯·æ±‚æ­£ç¡®è¿”å›ï¼ˆHttp Status Code ä¸º 200ï¼‰ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ï¼Œå‘é€ next äº‹ä»¶å’Œ completed äº‹ä»¶ï¼›</li>
<li>å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå‘é€ error äº‹ä»¶ï¼›</li>
</ol>
<p>ç°åœ¨æˆ‘ä»¬æ¥ä½¿ç”¨è¿™ä¸ªæ–°åˆ›å»ºçš„ä¿¡å·ã€‚åœ¨æœ¬æ•™ç¨‹çš„ä¸ŠåŠéƒ¨åˆ†ï¼Œä½ å­¦ä¼šäº†ä½¿ç”¨<code>flattenMap</code>æ–¹æ³•æ¥â€æ‰å¹³åŒ–â€ä¿¡å·ï¼Œç°åœ¨åˆåˆ°äº†è¿™ä¸ªæ–¹æ³•æ–½å±•èº«æ‰‹çš„æ—¶å€™ï¼Œåœ¨<code>viewDidLoad</code>æ–¹æ³•çš„ç»“å°¾ï¼Œæ·»åŠ <code>flattenMap</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[[[[[self requestAccessToTwitterSignal]</span><br><span class="line">  then:^RACSignal *&#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return self.searchText.rac_textSignal;</span><br><span class="line">  &#125;]</span><br><span class="line">  filter:^BOOL(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self isValidSearchText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  flattenMap:^RACStream *(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self signalForSearchWithText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125; error:^(NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;An error occurred: %@&quot;, error);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œåœ¨æœç´¢æ¡†ä¸­è¾“å…¥æœç´¢å†…å®¹ï¼Œä¸€æ—¦å­—ç¬¦é•¿åº¦å¤§äºç­‰äº 3 ä¸ªï¼Œä½ å°±å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ° Twitter çš„æœç´¢è¿”å›ç»“æœï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">2014-01-05 07:42:27.697 TwitterInstant[40308:5403] &#123;</span><br><span class="line">    "search_metadata" =     &#123;</span><br><span class="line">        "completed_in" = "0.019";</span><br><span class="line">        count = 15;</span><br><span class="line">        "max_id" = 419735546840117248;</span><br><span class="line">        "max_id_str" = 419735546840117248;</span><br><span class="line">        "next_results" = "?max_id=419734921599787007&amp;q=asd&amp;include_entities=1";</span><br><span class="line">        query = asd;</span><br><span class="line">        "refresh_url" = "?since_id=419735546840117248&amp;q=asd&amp;include_entities=1";</span><br><span class="line">        "since_id" = 0;</span><br><span class="line">        "since_id_str" = 0;</span><br><span class="line">    &#125;;</span><br><span class="line">    statuses =     (</span><br><span class="line">                &#123;</span><br><span class="line">            contributors = "<span class="tag">&lt;<span class="name">null</span>&gt;</span>";</span><br><span class="line">            coordinates = "<span class="tag">&lt;<span class="name">null</span>&gt;</span>";</span><br><span class="line">            "created_at" = "Sun Jan 05 07:42:07 +0000 2014";</span><br><span class="line">            entities =             &#123;</span><br><span class="line">                hashtags = ...</span><br></pre></td></tr></table></figure>
<h2 id="Threading"><a href="#Threading" class="headerlink" title="Threading"></a>Threading</h2><p>æˆ‘æƒ³ä½ ä¸€å®šéå¸¸è¿«åˆ‡çš„æƒ³è¦åœ¨ UI ä¸Šå±•ç¤ºæœæœå¾—åˆ°çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨æ­¤ä¹‹å‰ä½ è¿˜æœ‰ä¸€ä»¶äº‹æƒ…è¦åšï¼Œæƒ³çŸ¥é“è¦åšä»€ä¹ˆï¼Œæˆ‘ä»¬å¾—åšç‚¹å°å®éªŒã€‚</p>
<p>åœ¨<code>subscribeNext:error:</code>çš„ block ä¸­æ·»åŠ æ–­ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/BreakpointLocation.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>é‡æ–°è¿è¡Œç¨‹åºï¼Œå¦‚æœæœ‰å¿…è¦é‡æ–°è¾“å…¥ Twitter çš„è®¤è¯ä¿¡æ¯ï¼Œè¾“å…¥ä¸€äº›æœç´¢å†…å®¹ï¼Œç„¶åå°±è¿è¡Œåˆ°æ–­ç”µå¤„äº†ï¼Œç±»ä¼¼ä¸‹é¢ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/BreakpointResult.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>æˆ‘ä»¬è§‚å¯Ÿåˆ°è¿™æ®µä»£ç å¹¶æ²¡æœ‰è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼ˆThread 1ï¼‰ä¸Šï¼Œè€Œæˆ‘ä»¬é¦–å…ˆåº”å½“è®°ä½çš„å°±æ˜¯åªèƒ½åœ¨ä¸»çº¿ç¨‹æ›´æ–° UIï¼Œå› æ­¤å¦‚æœä½ è¦å±•ç¤ºæ•°æ®ï¼Œå°±å¿…é¡»åˆ‡æ¢çº¿ç¨‹ã€‚</p>
<p>è¿™é‡Œå¼•å‡ºäº† RAC æ¡†æ¶çš„ä¸€ä¸ªå…³é”®ç‚¹ï¼šä»¥ä¸Šçš„ä»£ç è¿è¡Œåœ¨äº‹ä»¶å‘é€çš„çº¿ç¨‹ä¸Šã€‚å¯ä»¥å°è¯•åœ¨ç®¡é“çš„å…¶ä½™æ­¥éª¤ä¸Šè®®æ¡ˆå®¶æ–­ç‚¹ï¼šä½ ä¼šå‘ç°å®ƒä»¬è¿è¡Œåœ¨ä¸æ­¢ä¸€æ¡çº¿ç¨‹ä¸Šã€‚</p>
<p>æ‰€ä»¥ä½ è¯¥å¦‚ä½•æ›´æ–° UI å‘¢ï¼Ÿç»å…¸åšæ³•å°±æ˜¯ä½¿ç”¨ Operation Queueï¼ˆå‚è§æ•™ç¨‹ <a href="https://www.raywenderlich.com/?p=19788" target="_blank" rel="noopener">How To Use NSOperations and NSOperationQueues</a>ï¼‰ï¼Œä½†æ˜¯ RAC æœ¬èº«æä¾›äº†æ›´ä¸ºç®€å•çš„æ–¹æ³• â€”â€” <code>deliverOn:</code>ï¼Œæ›´æ–°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[[[[[[self requestAccessToTwitterSignal]</span><br><span class="line">  then:^RACSignal *&#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return self.searchText.rac_textSignal;</span><br><span class="line">  &#125;]</span><br><span class="line">  filter:^BOOL(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self isValidSearchText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  flattenMap:^RACStream *(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self signalForSearchWithText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  deliverOn:[RACScheduler mainThreadScheduler]]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125; error:^(NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;An error occurred: %@&quot;, error);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å†è¿è¡Œç¨‹åºï¼Œå°±å¯ä»¥çœ‹åˆ°æ–­ç‚¹å¤„æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œäº†ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/BreakpointNowOnUIThread.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>çº³å°¼ï¼Ÿè°ƒåº¦åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¤„ç†äº‹ä»¶æµå°±è¿™ä¹ˆç®€å•ï¼Ÿä¸å¯æ€è®®ï¼ç°åœ¨ä½ å¯ä»¥æ”¾å¿ƒçš„åˆ·æ–°ä½ çš„ UI äº†ï¼</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>è¯»è€…å¯ä»¥å»è¯¦ç»†äº†è§£ä¸€ä¸‹ RACScheduler ç±»ã€‚</p>
</blockquote>
<p>ç°åœ¨æ˜¯æ—¶å€™å±•ç¤º tweets äº†ã€‚</p>
<h2 id="Updating-the-UI"><a href="#Updating-the-UI" class="headerlink" title="Updating  the UI"></a>Updating  the UI</h2><p>æ‰“å¼€<code>RWSearchResultsViewController.h</code>æ–‡ä»¶ä½ ä¼šå‘ç°è¿™é‡Œå·²ç»æœ‰ä¸€ä¸ª<code>displayTweets:</code>æ–¹æ³•äº†ï¼Œå®ƒä¼šè®©å³è¾¹çš„ View Controller å»æ˜¾ç¤ºç›¸åº”çš„ tweet æ•°ç»„ã€‚å®ç°éå¸¸ç®€å•ï¼Œåªæ˜¯å¡«å……ä¸€ä¸ª UITableView çš„æ•°æ®æºã€‚è¯¥æ–¹æ³•æœŸæœ›çš„å‚æ•°æ˜¯ä¸€ä¸ª<code>RWTweet</code>æ•°ç»„ï¼Œè¿™ä¸ªç±»ä¹Ÿå·²ç»åœ¨é¡¹ç›®ä¸­æä¾›å¥½äº†ã€‚</p>
<p>ç°åœ¨åˆ°è¾¾<code>subscibeNext:error:</code>è¿™ä¸€æ­¥çš„æ•°æ®æ˜¯ä¸€ä¸ª NSDictionaryï¼Œæ‰€ä»¥ä½ è¦æ€ä¹ˆè§£æå®ƒçš„å†…å®¹å‘¢ï¼Ÿ</p>
<p>å¦‚æœä½ å»çœ‹ <a href="https://dev.twitter.com/docs/api/1.1/get/search/tweets" target="_blank" rel="noopener">Twitter API documentation</a>ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªç»“æœå“åº”ç¤ºä¾‹ï¼šå®ƒå°±å±•ç¤ºäº† NSDictionary çš„ç»“æ„ï¼Œæ‰€ä»¥ä½ å¯ä»¥å‘ç°å®ƒæœ‰ä¸€ä¸ª key å«åš statusesï¼Œå…¶ä¸­åŒ…å«ç€ tweet æ•°ç»„ï¼Œæ•°ç»„çš„å†…å®¹ä¹Ÿæ˜¯ä¸€ä¸ªä¸ª NSDictionary å®ä¾‹ã€‚è€Œ <code>RWTweet</code>ç±»å·²ç»åŒ…å«è§£æè¿™ä¸ª NSDictionary çš„è¿‡ç¨‹äº†ï¼Œå› æ­¤ä½ è¦åšçš„å°±æ˜¯å†™ä¸€ä¸ªå¾ªç¯ï¼Œå°†è¿”å›æ¶ˆæ¯é‡Œé¢çš„ statuses æ•°ç»„è½¬æ¢ä¸º RWTweet æ•°ç»„ã€‚</p>
<p>ä½†æ˜¯ä½ ç”šè‡³è¿è¿™ä¸ªéƒ½ä¸ç”¨åšï¼Œæˆ‘ä»¬è¿˜æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚æœ¬æ•™ç¨‹æ˜¯æœ‰å…³ RAC ä»¥åŠ å‡½æ•°å¼ç¼–ç¨‹çš„ï¼Œé€šè¿‡å‡½æ•°å¼ API å°†æ•°æ®ä»ä¸€ç§ç±»å‹è½¬åŒ–ä¸ºå¦å¤–ä¸€ç§ç±»å‹ä¼šæ›´åŠ ä¼˜é›…ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <a href="https://github.com/ColinEberhardt/LinqToObjectiveC" target="_blank" rel="noopener">LinqToObjectiveC</a> æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘å…·ä½“æ€ä¹ˆå¼•å…¥è¿™ä¸ªåº“è¿™é‡Œå°±ç•¥è¿‡ä¸è¯‘äº†ã€‚</p>
</blockquote>
<p>åœ¨<code>RWSearchFormViewController.m</code>æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹æ–‡ä»¶å¼•å…¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;RWTweet.h&quot;</span><br><span class="line">#import &quot;NSArray+LinqExtensions.h&quot;</span><br></pre></td></tr></table></figure>
<p><code>NSArray+LinqExtensions.h</code>å¤´æ–‡ä»¶æ¥è‡ª <strong>LinqToObjectiveC</strong>ï¼Œå®ƒå¾€ NSArray ä¸­æ·»åŠ äº†ä¸€äº›æ–¹æ³•è®©ä½ å¯ä»¥å˜æ¢ã€æ’åºã€åˆ†æã€è¿‡æ»¤æ•°ç»„ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯é“¾å¼çš„ï¼ç°åœ¨æˆ‘ä»¬å°±æ¥ä½¿ç”¨è¿™ä¸ª APIï¼Œæ›´æ¢<code>viewDidLoad</code>æ–¹æ³•æœ€åçš„ç®¡é“ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[[[[[[self requestAccessToTwitterSignal]</span><br><span class="line">  then:^RACSignal *&#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return self.searchText.rac_textSignal;</span><br><span class="line">  &#125;]</span><br><span class="line">  filter:^BOOL(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self isValidSearchText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  flattenMap:^RACStream *(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self signalForSearchWithText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  deliverOn:[RACScheduler mainThreadScheduler]]</span><br><span class="line">  subscribeNext:^(NSDictionary *jsonSearchResult) &#123;</span><br><span class="line">    NSArray *statuses = jsonSearchResult[@&quot;statuses&quot;];</span><br><span class="line">    NSArray *tweets = [statuses linq_select:^id(id tweet) &#123;</span><br><span class="line">      return [RWTweet tweetWithStatus:tweet];</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.resultsViewController displayTweets:tweets];</span><br><span class="line">  &#125; error:^(NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;An error occurred: %@&quot;, error);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬ä¼˜é›…åœ°å°†åŸå§‹çš„ NSDictionary æ•°æ®è½¬æ¢æˆäº† RWTweet å¯¹è±¡ã€‚ä¸€æ—¦è½¬å˜å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ result view controller ä¸Šå±•ç¤ºå¯¹åº”çš„æ•°æ®äº†ã€‚</p>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œæœç´¢ä¹‹åå°±å¯ä»¥çœ‹åˆ°ç±»ä¼¼çš„ UIï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/FinallyWeSeeTweets.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<blockquote>
<p><strong>æ³¨æ„ï¼š</strong> RAC å’Œ LinqToObjectiveC æœ‰ç€ç›¸ä¼¼çš„æ€æƒ³ã€‚</p>
</blockquote>
<h2 id="Asynchronous-Loading-of-Images"><a href="#Asynchronous-Loading-of-Images" class="headerlink" title="Asynchronous Loading of Images"></a>Asynchronous Loading of Images</h2><p>ä½ æˆ–è®¸å·²ç»å‘ç°æ¯ä¸€è°ƒ tweet çš„å·¦ä¾§æœ‰ä¸€å—å¾ˆå¤§çš„ç©ºç™½ï¼Œè¿™å—åœ°æ–¹å®é™…æ˜¯ç”¨äºå±•ç¤º Twitter çš„ç”¨æˆ·å¤´åƒçš„ã€‚RWTweet ç±»ä¸­å®é™…å·²ç»æœ‰ä¸€ä¸ª<code>profileImageUrl</code>å±æ€§ç”¨äºè®°å½•è·å–å¤´åƒçš„ URL äº†ï¼Œä¸ºäº†èƒ½å¤Ÿè®© UITableView æµç•…çš„æ»šåŠ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯å¤´åƒè·å–çš„ä»£ç ä¸åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè¿™å¯ä»¥ä½¿ç”¨ GCD æˆ–è€… NSOperationQueue æ¥è¾¾åˆ°ç›®çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ RAC å‘¢ï¼Ÿ</p>
<p>æ‰“å¼€ <strong>RWSearchResultsViewController.m</strong> æ–‡ä»¶ï¼Œåœ¨æœ€åæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-(RACSignal *)signalForLoadingImage:(NSString *)imageUrl &#123;</span><br><span class="line"> </span><br><span class="line">  RACScheduler *scheduler = [RACScheduler</span><br><span class="line">                         schedulerWithPriority:RACSchedulerPriorityBackground];</span><br><span class="line"> </span><br><span class="line">  return [[RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    NSData *data = [NSData dataWithContentsOfURL:[NSURL URLWithString:imageUrl]];</span><br><span class="line">    UIImage *image = [UIImage imageWithData:data];</span><br><span class="line">    [subscriber sendNext:image];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    return nil;</span><br><span class="line">  &#125;] subscribeOn:scheduler];</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹è¿™ç§æ¨¡å¼ï¼Œä½ åº”è¯¥éå¸¸ç†Ÿæ‚‰äº†ã€‚ä»¥ä¸Šä»£ç è·å–åˆ°äº†ä¸€ä¸ªåå°è°ƒåº¦å™¨ç”¨äºè°ƒåº¦ä¿¡å·æ‰§è¡Œçš„çº¿ç¨‹ï¼Œè®©å®ƒä¸è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œæ¥ç€å®ƒåˆ›å»ºäº†ä¸€ä¸ªä¿¡å·ç”¨äºä¸‹è½½å›¾åƒæ•°æ®å¹¶åˆ›å»º UIImageï¼Œæœ€åæ˜¯è°ƒç”¨<code>subscribeOn:</code>æ–¹æ³•ï¼Œç”¨äºä¿è¯ä¿¡å·æ˜¯æ‰§è¡Œåœ¨æŒ‡å®šçš„è°ƒåº¦å™¨ä¸Šçš„ã€‚</p>
<p>ç°åœ¨åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ›´æ–°<code>tableView:cellForRowAtIndex:</code>æ–¹æ³•ï¼Œåœ¨<code>return</code>è¯­å¥ä¹‹å‰æ·»åŠ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cell.twitterAvatarView.image = nil;</span><br><span class="line"> </span><br><span class="line">[[[self signalForLoadingImage:tweet.profileImageUrl]</span><br><span class="line">  deliverOn:[RACScheduler mainThreadScheduler]]</span><br><span class="line">  subscribeNext:^(UIImage *image) &#123;</span><br><span class="line">   cell.twitterAvatarView.image = image;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç é¦–å…ˆé‡ç½®äº† cell çš„å›¾ç‰‡ï¼Œå› ä¸º cell ä¼šè¢«é‡ç”¨ï¼Œå¾ˆæœ‰å¯èƒ½æºå¸¦è€…è¿‡æœŸçš„æ•°æ®ï¼Œç„¶åå®ƒåˆ›å»ºäº†å¯¹åº”çš„ä¿¡å·æ¥è·å–æ•°æ®ï¼Œ<code>deliverOn:</code>ç®¡é“æ­¥éª¤ç”¨äºå°†<code>subscriberNext:</code>çš„ block è°ƒåº¦åˆ°ä¸»çº¿ç¨‹è¿›è¡Œã€‚</p>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„å±•ç¤ºï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/AvatarsAtAlast.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<h2 id="Throttling"><a href="#Throttling" class="headerlink" title="Throttling"></a>Throttling</h2><p>ä½ æˆ–è®¸å·²ç»å‘ç°æ¯æ¬¡è¾“å…¥ä¸€ä¸ªæ–°å­—ç¬¦ï¼Œåº”ç”¨éƒ½ä¼šç†è§£å‘èµ·ä¸€ä¸ª Twitter æœç´¢ã€‚å¦‚æœä½ æ˜¯ä¸€ä¸ªå¿«é€Ÿè¾“å…¥è€…ï¼ˆæˆ–è€…åªæ˜¯é•¿æŒ‰ç€åˆ é™¤é”®ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´åº”ç”¨åœ¨çŸ­æ—¶é—´å†…å‘èµ·å¤§é‡è¯·æ±‚ï¼Œè¿™å¹¶ä¸æ˜¯åˆç†çš„ï¼šé¦–å…ˆï¼Œè¿™ä¼šå¯¹ Twitter çš„æœç´¢ API é€ æˆå‹åŠ›ï¼Œå¹¶ä¸”å¤§éƒ¨åˆ†çš„æœç´¢ç»“æœéƒ½è¢«ä¸¢å¼ƒäº†ï¼›å…¶æ¬¡ï¼Œé¢‘ç¹çš„æ›´æ–°ç•Œé¢å¯¹äºç”¨æˆ·æ¥è¯´ä¹Ÿæ˜¯å¾ˆçƒ¦äººçš„ä¸€ä»¶äº‹å„¿ã€‚</p>
<p>ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯åœ¨è¾“å…¥æ¡†çš„å†…å®¹ä¸€æ®µæ—¶é—´ä¸å˜åŒ–ä¹‹åå†å»å‘èµ·æœç´¢ï¼Œæ¯”å¦‚ï¼Œ500msã€‚å¦‚ä½ æ‰€æƒ³ï¼ŒRAC åˆä¸ºæ­¤æä¾›äº†ç®€å•çš„éš¾ä»¥ç½®ä¿¡çš„è§£å†³æ–¹æ¡ˆï¼</p>
<p>æ‰“å¼€<code>RWSearchFormViewController.m</code>ï¼Œæ›´æ–°å‰é¢çš„ç®¡é“ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[[[[[[[self requestAccessToTwitterSignal]</span><br><span class="line">  then:^RACSignal *&#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return self.searchText.rac_textSignal;</span><br><span class="line">  &#125;]</span><br><span class="line">  filter:^BOOL(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self isValidSearchText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  throttle:0.5]</span><br><span class="line">  flattenMap:^RACStream *(NSString *text) &#123;</span><br><span class="line">    @strongify(self)</span><br><span class="line">    return [self signalForSearchWithText:text];</span><br><span class="line">  &#125;]</span><br><span class="line">  deliverOn:[RACScheduler mainThreadScheduler]]</span><br><span class="line">  subscribeNext:^(NSDictionary *jsonSearchResult) &#123;</span><br><span class="line">    NSArray *statuses = jsonSearchResult[@&quot;statuses&quot;];</span><br><span class="line">    NSArray *tweets = [statuses linq_select:^id(id tweet) &#123;</span><br><span class="line">      return [RWTweet tweetWithStatus:tweet];</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.resultsViewController displayTweets:tweets];</span><br><span class="line">  &#125; error:^(NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;An error occurred: %@&quot;, error);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p><code>throttle</code>æ“ä½œåœ¨æ”¶åˆ°ä¸€ä¸ª next äº‹ä»¶ä¹‹åï¼Œå¦‚æœä¸€å®šæ—¶é—´å†…è¿˜æ²¡æœ‰æ”¶åˆ°ä¸‹ä¸€ä¸ª next äº‹ä»¶ï¼Œæ‰ä¼šå‘é€å½“å‰è¿™ä¸ª next äº‹ä»¶ã€‚è¿™çœŸçš„éå¸¸ç®€å•ã€‚</p>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æ•ˆæœï¼Œä½“éªŒå¥½å¤šäº†æ˜¯ä¸æ˜¯ï¼Ÿ</p>
<p>ç„¶åâ€¦åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº† Tweet Instant åº”ç”¨çš„å¼€å‘ï¼Œå›é¡¾ä¸€ä¸‹ç„¶åå°½æƒ…åœ°äº«å—å§ï¼åŒæ ·çš„ï¼Œå¦‚æœæœ‰å“ªæ¬¾åœ°æ–¹æœ‰æ‰€é—æ¼æˆ–è€…ä¸æ˜ç™½çš„ï¼Œå¯ä»¥ä¸‹è½½æœ€ç»ˆçš„ä»£ç ï¼š<a href="https://koenig-media.raywenderlich.com/uploads/2014/01/TwitterInstant-Final.zip" target="_blank" rel="noopener">final project</a>ï¼ˆè®°å¾—è¿è¡Œ<code>pod install</code>å‘½ä»¤ï¼‰ï¼Œæˆ–è€…ç›´æ¥ä» <a href="https://github.com/ColinEberhardt/RWTwitterInstant" target="_blank" rel="noopener">GitHub</a> cloneï¼Œæ¯ä¸€ä¸ª commit éƒ½å¯¹åº”ç€ä¸Šé¢çš„ä¸€ä¸ªæ­¥éª¤ã€‚</p>
<h2 id="Wrap-Up"><a href="#Wrap-Up" class="headerlink" title="Wrap Up"></a>Wrap Up</h2><p>åœ¨ç¦»å¼€ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦çœ‹ä¸€ä¸‹æœ€ç»ˆæ•´ä¸ªåº”ç”¨çš„ç®¡é“ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/CompletePipeline.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>è¿™ä¸ªæµç¨‹éå¸¸çš„å¤æ‚ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨ä¸€æ ¹å“åº”å¼ç®¡é“å°±è¡¨è¾¾æ¸…æ¥šäº†ï¼Œçœ‹èµ·æ¥éå¸¸æ¼‚äº®ï¼Œä¸æ˜¯å—ï¼Ÿä½ èƒ½æƒ³è±¡ä¸ç”¨ RAC è¿™ä¸ªåº”ç”¨ä¼šå˜å¾—å¤šä¹ˆå¤æ‚ä¹ˆï¼Œå®ƒçš„æµç¨‹åˆä¼šå˜å¾—å¤šä¹ˆéš¾ä»¥ç†æ¸…ï¼Ÿä½ ç°åœ¨å†ä¹Ÿä¸ç”¨ç»å†è¿™äº›äº†ï¼</p>
<p>ç°åœ¨ä½ åº”è¯¥çŸ¥é“ RAC æ˜¯å¤šä¹ˆçš„ä»¤äººæƒŠè®¶äº†ï¼</p>
<p>æœ€åä¸€ç‚¹ï¼ŒRAC ä½¿å¾— MVVMï¼ˆæ›´å¥½çš„åˆ†ç¦»åº”ç”¨é€»è¾‘å’Œè§†å›¾é€»è¾‘ï¼‰çš„åº”ç”¨æ›´ä¸ºç®€å•äº†ï¼Œå¦‚æœæœ‰äººå¸Œæœ›èƒ½çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ RAC æ¥å®ç° MVVMï¼Œè¯·åœ¨è¯„è®ºé‡Œè®©æˆ‘çŸ¥é“ï¼Œæˆ‘å¾ˆå¸Œæœ›å¬åˆ°ä½ ä»¬çš„æƒ³æ³•ä»¥åŠç»å†ï¼</p>
<h2 id="è¯‘è€…æ€»ç»“"><a href="#è¯‘è€…æ€»ç»“" class="headerlink" title="è¯‘è€…æ€»ç»“"></a>è¯‘è€…æ€»ç»“</h2><p>è¿™ä¸¤ç¯‡æ–‡ç« è™½ç„¶æ²¡æœ‰è®²å¤ªå¤šçš„ç†è®ºï¼Œä¹Ÿæ²¡æœ‰å¯¹æŸä¸ªå‡½æ•°åšæ·±å…¥çš„æ¢è®¨ï¼Œä½†æ˜¯ç¡®å®æ”¹å˜äº†æˆ‘å¯¹å“åº”å¼ç¼–ç¨‹çš„çœ‹æ³•ã€‚</p>
<p>å¦‚æœä½ å†™è¿‡ Androidï¼Œä¸º Button æ·»åŠ ç›‘å¬çš„ä»£ç ä¸€èˆ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ç‚¹å‡»äº‹ä»¶å‘ç”Ÿ</span></span><br><span class="line">		<span class="comment">// BLABLA...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹æ³•ç§°ä¸º <strong>Callback</strong>ã€‚å¦‚æœä½ å†™è¿‡ iOS ä»£ç ï¼Œé‚£ä¹ˆä¸º UIButton æ·»åŠ ç›‘å¬äº‹ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[button addTarget:self action:@selector(buttonClicked:) forControlEvents:UIControlEventTouchUpInside];</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶è¿˜è¦ä¸ºæ­¤å£°æ˜å¹¶å®ç°ä¸€ä¸ª<code>buttonClicked:</code>ç§æœ‰æ–¹æ³•ç”¨äºå¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œè¿™ç§æ–¹æ³•ç§°ä¸º <strong>Target-Action</strong>ã€‚</p>
<p>è¿™ä¸¤ç§æœºåˆ¶è™½ç„¶å«æ³•ä¸ä¸€æ ·ï¼Œä½†æˆ‘è®¤ä¸ºä¸¤è€…æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ï¼ˆä¸”ä¸è®¨è®ºæ–¹æ³•è°ƒç”¨å’Œæ¶ˆæ¯å‘é€ï¼‰ï¼Œå“åº”å¼ç¼–ç¨‹ä¹Ÿæ˜¯ä½¿ç”¨çš„åŒæ ·çš„æœºåˆ¶ â€”â€” å°±æ˜¯ <strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>ã€‚ä¸è§‰å¾—<code>subscribe</code>çš„è¿‡ç¨‹å°±æ˜¯<code>addListener</code>çš„è¿‡ç¨‹ä¹ˆï¼Ÿ</p>
<blockquote>
<p>PSï¼šè¿™é‡Œå¿½ç•¥æ‰€è°“çš„è§‚å¯Ÿè€…æ¨¡å¼å’Œç›‘å¬å›è°ƒæ¨¡å¼çš„åŒºåˆ«ï¼Œä¸ªäººè®¤ä¸ºåšè¿™ç§åŒºåˆ†æ¯«æ— æ„ä¹‰ã€‚</p>
</blockquote>
<p>è¿™ç§å…¸å‹çš„åšæ³•å·²ç»å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†çš„éœ€æ±‚äº†ï¼Œä½†æ˜¯åˆå­˜åœ¨ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<ul>
<li>ç›¸æ¯”è¾ƒäº Androidï¼ŒiOS çš„è¿™ç§æ–¹å¼æˆ‘æ˜¯æ¯”è¾ƒåæ„Ÿçš„ï¼Œæ¯æ¬¡å†™è¿™è¡Œä»£ç æˆ‘éƒ½å¾—å…ˆå»å£°æ˜ä¸€ä¸ªæ–¹æ³•ï¼ŒæŸ¥çœ‹ä»£ç çš„æ—¶å€™å¾—è·³è½¬åˆ°æ–¹æ³•ä½“ä¸­æŸ¥çœ‹æ–¹æ³•é€»è¾‘ç„¶åå†å›æ¥ç»§ç»­å¾€ä¸‹æŸ¥çœ‹ï¼ŒAndroid å°†ç»‘å®šè¿‡ç¨‹å’Œç»‘å®šçš„å†…å®¹æ”¾åœ¨ä¸€å—å„¿ï¼Œé˜…è¯»èµ·æ¥æ›´åŠ æ–¹ä¾¿ï¼›</li>
<li>å³ä½¿ Android èƒ½å¤Ÿä¸º â€œä¸º View æ·»åŠ ç›‘å¬äº‹ä»¶â€ è¿™æ ·çš„äº‹æƒ…æä¾›æ¯”è¾ƒä¼˜é›…çš„æ–¹æ¡ˆï¼Œä½†æ˜¯åœ¨ Android ä¸Šä»ç„¶å­˜åœ¨ä¸€äº›æ¶å¿ƒçš„é•¿æµç¨‹ï¼Œå½“ä½ æƒ³è¦å»äº†è§£è¿™ä¸ªæµç¨‹çš„æ—¶å€™ï¼Œéœ€è¦åˆ°å¤„è·³è½¬ä»£ç æŸ¥çœ‹ï¼›</li>
</ul>
<p>æ€»ç»“ä¸€ä¸‹ï¼š<strong>éå“åº”å¼ä»£ç çš„é€»è¾‘åˆ†æ•£ï¼Œä¸æ˜“é˜…è¯»</strong>ã€‚è¿™å°±æ˜¯å“åº”å¼ç¼–ç æ‰€è¦è§£å†³çš„é—®é¢˜ï¼<strong>å“åº”å¼ç¼–ç çš„ä»·å€¼åœ¨äºï¼š</strong></p>
<p>1ï¼‰é€šè¿‡å®šä¹‰ nextã€errorã€complete ä¸‰ç§ç±»å‹çš„äº‹ä»¶è§„èŒƒäº†äº‹ä»¶çš„è¡¨è¾¾ï¼›</p>
<p>2ï¼‰å»ºç«‹äº‹ä»¶æµæ¦‚å¿µï¼›</p>
<p>3ï¼‰åœ¨äº‹ä»¶æµåŸºç¡€ä¸Šå»ºç«‹äº†ä¸€ç³»åˆ—çš„å‡½æ•°ç”¨äºæ“ä½œäº‹ä»¶å’Œäº‹ä»¶æµï¼›</p>
<p>å“åº”å¼ç¼–ç ä¼šå®šä¹‰ä¸€ä¸ªäº‹ä»¶æºï¼Œæˆ–è€…ç§°ä¹‹ä¸º Signalï¼›äº‹ä»¶é™¤äº†ç±»å‹ä¹‹å¤–ï¼Œè¿˜ä¼šæºå¸¦ä»»æ„ç±»å‹çš„æ•°æ®ã€‚å½“äº‹ä»¶è¢«è§¦å‘ä¹‹åï¼ˆæ¯”å¦‚æŒ‰é’®è¢«ç‚¹å‡»ï¼‰ï¼Œäº‹ä»¶æºå°±ä¼šé€šè¿‡å‘é€äº‹ä»¶æ¥å‘Šè¯‰è®¢é˜…è€…ï¼Œè¿™ä¸€ç‚¹å’Œå‰é¢ Andorid çš„ç¤ºä¾‹å¹¶æ— åŒºåˆ«ï¼Œç”šè‡³å®ç°èµ·æ¥ä»£ç å½¢å¼éƒ½å·®ä¸å¤šã€‚ä½†æ˜¯å…³é”®åœ¨äºï¼š<strong>å“åº”å¼ç¼–ç å®šä¹‰çš„æ“ä½œæ˜¯å¯ä»¥å°†ä¸€ä¸ªä¿¡å·æºè½¬æ¢ä¸ºå¦å¤–ä¸€ç§ä¿¡å·æºï¼Œæ¢è¨€ä¹‹ï¼Œå®ƒå¯ä»¥å‘é€å®Œå…¨ä¸åŒçš„äº‹ä»¶å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥å°†äº‹ä»¶çš„æ•°æ®å¤„ç†æˆå¦å¤–ä¸€ç§æ ¼å¼çš„æ•°æ®å†è¿›è¡Œä¼ é€ã€‚</strong>å›é¡¾ä¸€å¼ <a href="http://timebridge.space/2017/01/16/RAC/" target="_blank" rel="noopener">ã€è¯‘ã€‘ReactiveCocoa å…¥é—¨æ•™ç¨‹ï¼ˆä¸ŠåŠéƒ¨åˆ†ï¼‰</a>ä¸­çš„å›¾ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/CombinePipeline.png" alt="RAC æ•°æ®æµå›¾"></div>

<p>å¦‚å›¾ï¼Œran_textSignal å°±æ˜¯äº‹ä»¶æºï¼Œå®ƒå‘é€çš„äº‹ä»¶æºå¸¦çš„æ•°æ®æ˜¯ NSString ç±»å‹çš„ï¼Œç»è¿‡<code>map</code>æ“ä½œä¹‹åä¼šå˜æˆ BOOL ç±»å‹ï¼Œå†ç»è¿‡ä¸€æ¬¡<code>map</code>æ“ä½œä¹‹åå°±ä¼šå˜æˆ UIColor ç±»å‹ã€‚ä»å›¾ä¸­è¿˜å¯ä»¥çœ‹å‡ºï¼šusername å’Œ password è¿™ä¸¤ä¸ªä¿¡å·æºå‘å‡ºçš„æ—¶äº‹ä»¶ç»è¿‡<code>combineLatest:reduce</code>æ“ä½œä¹‹åä¼šè¢«åˆå¹¶ä¸ºä¸€ä¸ªæºå¸¦ BOOL ç±»å‹æ•°æ®çš„äº‹ä»¶ã€‚è¿™ç§<strong>äº‹ä»¶/äº‹ä»¶æµçš„å˜æ¢æ“ä½œæ­£æ˜¯å“åº”å¼ç¼–ç¨‹çš„æ ¸å¿ƒèƒ½åŠ›</strong>ï¼é€šè¿‡è¿™ç§èƒ½åŠ›æ˜¯å¯ä»¥æ¯”è¾ƒä¼˜é›…çš„è§£å†³æ‰å‰é¢æåˆ°çš„é—®é¢˜çš„ï¼ˆä¹‹æ‰€ä»¥è¯´â€œæ¯”è¾ƒä¼˜é›…â€ï¼Œæ˜¯å› ä¸ºè¦ç†è§£å“åº”å¼ç¼–ç¨‹å®šä¹‰çš„å„ç§æ“ä½œå¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼‰ã€‚</p>
<p>ä»¥ä¸Šï¼Œæ˜¯æˆ‘ç†è§£çš„å“åº”å¼ç¼–ç¨‹çš„ç²¾é«“ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ã€è¯‘ã€‘ReactiveCocoa å…¥é—¨æ•™ç¨‹ï¼ˆä¸ŠåŠéƒ¨åˆ†ï¼‰]]></title>
      <url>http://www.timebridge.space/2017/01/16/RAC/</url>
      <content type="html"><![CDATA[<p>ç¿»è¯‘è‡ªï¼š<a href="https://www.raywenderlich.com/62699/reactivecocoa-tutorial-pt1" target="_blank" rel="noopener">ReactiveCocoa Tutorial â€“ The Definitive Introduction: Part 1/2</a></p>
<blockquote>
<p>åœ¨ç½‘ä¸Šçœ‹äº†å¾ˆå¤šçš„æ–‡ç« ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ä¾‹å­å †ç Œæˆ–è€…ç†è®ºå †ç Œï¼Œåªæœ‰è¿™ç¯‡æ–‡ç« ï¼Œè™½ç„¶æ²¡æœ‰ç†è®ºæè¿°ï¼Œä½†æ˜¯é€šè¿‡ä¸¤ä¸ª App çš„æ”¹é€ å’Œå¼€å‘è¿‡ç¨‹ï¼Œè¯¦ç»†çš„å±•ç¤ºäº† RAC çš„ä¼˜ç‚¹ä»¥åŠä½¿ç”¨åœºæ™¯ï¼Œå¨“å¨“é“æ¥ï¼Œç†è§£èµ·æ¥æ¯”è¾ƒå®¹æ˜“ã€‚</p>
</blockquote>
<p>ä½œä¸ºä¸€ä¸ª iOS å¼€å‘è€…ï¼Œä½ å†™çš„æ¯è¡Œä»£ç å‡ ä¹éƒ½æ˜¯ç”¨äºå“åº”æŸä¸ªæ—¶é—´ï¼šä¸€ä¸ªæŒ‰é’®ç‚¹å‡»äº‹ä»¶ã€ä¸€ä¸ªç½‘ç»œå›å¤çš„æ¶ˆæ¯ã€ä¸€ä¸ªå±æ€§å˜åŒ–äº‹ä»¶ï¼ˆKVOï¼‰æˆ–è€…æ˜¯å› ä¸ºä½ç½®å˜åŒ–è€Œæ”¶åˆ°çš„ç³»ç»Ÿé€šçŸ¥ï¼Œè¿™äº›éƒ½æ˜¯å¾ˆå¥½çš„ä¾‹å­ã€‚ç„¶è€Œï¼Œè¿™äº›äº‹ä»¶çš„é€šçŸ¥éƒ½è¢«åŒ…è£…ç§¤ä¸åŒçš„æ–¹å¼è¿›è¡Œï¼šActionã€delegateã€KVO ä»¥åŠ callback ç­‰ç­‰ã€‚<a href="https://github.com/ReactiveCocoa/ReactiveCocoa" target="_blank" rel="noopener">ReactiveCocoa </a>ä¸ºäº‹ä»¶çš„å“åº”å®šä¹‰äº†ä¸€å¥—æ ‡å‡†çš„æ¥å£ï¼Œè¿™æ ·å¤„ç†/è¿‡æ»¤/ç»„åˆèµ·äº‹ä»¶æ¥ä¼šå˜å¾—æ›´åŠ ç®€å•ã€‚</p>
<p>å¬èµ·æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹è´¹è§£ï¼Ÿè¿˜æ˜¯æœ‰ç‚¹å¥½å¥‡ï¼Œæœ‰ç‚¹æ¿€åŠ¨ï¼Ÿé‚£å°±ç»§ç»­å¾€ä¸‹è¯»å§:-Dã€‚</p>
<p>ReactiveCocoa ç»„åˆäº†ä¸€äº›ç¼–ç é£æ ¼ï¼š</p>
<ul>
<li><strong><a href="http://en.wikipedia.org/wiki/Functional_programming" target="_blank" rel="noopener">Functional Programming</a></strong> ä½¿ç”¨äº†å…¶ä¸­çš„é«˜é˜¶å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä»¥å‡½æ•°ä½œä¸ºå‡½æ•°çš„å‚æ•°</li>
<li><strong><a href="http://en.wikipedia.org/wiki/Reactive_programming" target="_blank" rel="noopener">Reactive Programming</a></strong> å…³æ³¨æ•°æ®æµä»¥åŠå˜åŒ–çš„é€šçŸ¥<a id="more"></a></li>
</ul>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘å®é™…ä¸Šè¿œä¸æ­¢è¿™äº›ï¼Œè¦ç†è§£å¥½ RACï¼Œå¯ä»¥å¤šçœ‹çœ‹å‡½æ•°å¼ç¼–ç¨‹å’Œå“åº”å¼ç¼–ç¨‹è¿™ä¸¤ç§ç¼–ç æ€æƒ³ï¼Œè¿™é‡Œä½œè€…ç®€åŒ–äº†ç†è®ºæè¿°ã€‚</p>
</blockquote>
<p>å› ä¸ºèåˆäº†ä¸¤ç§ç¼–ç é£æ ¼çš„æ€æƒ³ï¼Œå› æ­¤ ReactiveCocoa åˆè¢«æè¿°ä¸º<strong>å‡½æ•°å“åº”å¼ç¼–ç¨‹ï¼ˆFunctional Reactive Programmingï¼Œç®€ç§° FRPï¼‰</strong>æ¡†æ¶ã€‚</p>
<p>å¥½äº†ï¼Œç›¸å…³ç†è®ºåˆ°æ­¤ä¸ºæ­¢ï¼Œè™½ç„¶ç¼–ç¨‹èŒƒå¼æ˜¯ä¸€ä¸ªéå¸¸æœ‰å¸å¼•åŠ›çš„ä¸»é¢˜ï¼Œä½†æ˜¯æ¥ä¸‹å»æœ¬æ•™ç¨‹ä¸»è¦å…³æ³¨å®è·µéƒ¨åˆ†ï¼Œä¼šä»¥ä¸€ä¸ªè´¯ç©¿å§‹ç»ˆçš„ä¾‹å­ä¸ºæ ¸å¿ƒè¿›è¡Œè®²è¿°ã€‚</p>
<h2 id="The-Reactive-Playground"><a href="#The-Reactive-Playground" class="headerlink" title="The Reactive Playground"></a>The Reactive Playground</h2><p>åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šä»ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åº â€”â€” ReactivePlayground å…¥æ‰‹æ¥äº†è§£å“åº”å¼ç¼–ç¨‹ã€‚å¼€å§‹ä¹‹å‰å¯ä»¥å…ˆä¸‹è½½è¿™ä¸ª<a href="https://koenig-media.raywenderlich.com/uploads/2014/01/ReactivePlayground-Starter.zip" target="_blank" rel="noopener">é¡¹ç›®</a>å¹¶ç¼–è¯‘è¿è¡Œä»¥ç¡®ä¿ä¸€åˆ‡å°±ç»ªã€‚</p>
<p>ReactivePlayground éå¸¸ç®€å•ï¼Œåªä¼šåœ¨å±å¹•ä¸Šå±•ç¤ºä¸€ä¸ªç™»é™†é¡µé¢ï¼Œæä¾›æ­£ç¡®çš„èº«ä»½ä¿¡æ¯ï¼šç”¨æˆ·åå’Œå¯†ç å°±å¯ä»¥çœ‹åˆ°ä¸€å¼ å¯çˆ±çš„å°çŒ«å’ªå›¾ç‰‡ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/ReactivePlaygroundStarter.jpg" width="320" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>çœ‹å‘ï¼Œå¤šä¹ˆå¯çˆ±ï¼</p>
<p>ç°åœ¨æ˜¯æ—¶å€™èŠ±ç‚¹æ—¶é—´æ¥æµè§ˆä¸€ä¸‹é¡¹ç›®çš„ä»£ç äº†ï¼Œå®ƒéå¸¸ç®€å•ï¼ŒèŠ±ä¸äº†å¤šé•¿æ—¶é—´ã€‚</p>
<p>æ‰“å¼€ <strong>RWViewController.m</strong> æ‰«ä¸€çœ¼ï¼Œä½ éœ€è¦èŠ±å¤šä¹…æ—¶é—´æ‰èƒ½çœ‹å‡ºæ¥ <strong>Sign In</strong> æŒ‰é’®è¢«æ¿€æ´»çš„æ¡ä»¶ï¼Ÿå±•ç°/éšè— <strong>signInFailure</strong> æ ‡ç­¾çš„è§„åˆ™åˆæ˜¯ä»€ä¹ˆï¼Ÿåœ¨è¿™ä¸ªç›¸å¯¹ç®€å•çš„ä¾‹å­ä¸­ï¼Œä½ å¯èƒ½éœ€è¦èŠ±ä¸€ä¸¤åˆ†é’Ÿçš„æ—¶é—´æ¥å›ç­”è¿™äº›é—®é¢˜ï¼Œåœ¨ä¸€ä¸ªæ›´ä¸ºå¤æ‚çš„åº”ç”¨ä¸­ï¼Œè¿™æ ·çš„åˆ†ææ— ç–‘ä¼šèŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘ä¸»è¦åŸå› æ˜¯é€»è¾‘å››ä¸‹åˆ†æ•£ï¼Œè¦å›ç­”è¿™äº›é—®é¢˜éœ€è¦æ¥å›åˆ‡æ¢ä»£ç ã€‚</p>
</blockquote>
<p>å¦‚æœå¼€å‘è€…ä½¿ç”¨ ReactiveCocoaï¼Œåº”ç”¨çš„é€»è¾‘å°±ä¼šå˜å¾—æ¸…æ™°å¾ˆå¤šï¼ŒSoï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘è¿™é‡Œçœç•¥ä¸€æ®µå¦‚ä½•æ·»åŠ  ReactiveCocoa æ¡†æ¶çš„ç« èŠ‚ä¸ä½œç¿»è¯‘ï¼Œäº†è§£ CocoaPods çš„ç«¥é‹å¹¶ä¸éš¾ã€‚å»ºè®®è¯»è€…ç›´æ¥å»çœ‹ Github ReadmeæŒ‡å¯¼ã€‚</p>
</blockquote>
<h2 id="Time-To-Play"><a href="#Time-To-Play" class="headerlink" title="Time To Play"></a>Time To Play</h2><p>æ­£å¦‚å‰é¢ä»‹ç»çš„ï¼ŒReactiveCocoa ä¸ºå¤„ç†åº”ç”¨ä¸­å‘ç”Ÿçš„å„ç§ä¸åŒçš„äº‹ä»¶æµæä¾›äº†ä¸€å¥—æ ‡å‡†çš„æ¥å£ï¼Œåœ¨ ReactiveCocoa æ¡†æ¶ä¸­ï¼Œè¿™äº›äº‹ä»¶è¢«ç§°ä¸º<strong>ä¿¡å·(signal)</strong>ï¼Œç”±ç±» RACSignal è¡¨ç¤ºã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘åé¢ ReactiveCocoa ç®€ç§° RACã€‚</p>
</blockquote>
<p>æ‰“å¼€åº”ç”¨çš„åˆå§‹ ViewController â€”â€” RWViewControllerï¼Œæ·»åŠ ä»¥ä¸‹è¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;ReactiveCocoa/ReactiveCocoa.h&gt;</span><br></pre></td></tr></table></figure>
<p>å°±å¯ä»¥å¯¼å…¥ RAC çš„å¤´æ–‡ä»¶ã€‚ä½ ç°åœ¨è¦åšçš„äº‹æƒ…ä¸æ˜¯å»æ›¿æ¢ä»»ä½•çš„ä»£ç ï¼Œè€Œæ˜¯å…ˆç©ç©å®ƒï¼Œåœ¨<code>viewDidLoad</code>æ–¹æ³•çš„æœ«å°¾æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[self.usernameTextField.rac_textSignal subscribeNext:^(id x) &#123;</span><br><span class="line">  NSLog(@&quot;%@&quot;, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºï¼Œåœ¨ç”¨æˆ·åè¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€äº›æ–‡å­—ï¼Œå¹¶æ³¨æ„è§‚å¯Ÿæ§åˆ¶å°çš„è¾“å‡ºï¼Œä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„ Log æ‰“å°å‡ºæ¥ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2013-12-24 14:48:50.359 RWReactivePlayground[9193:a0b] i</span><br><span class="line">2013-12-24 14:48:50.436 RWReactivePlayground[9193:a0b] is</span><br><span class="line">2013-12-24 14:48:50.541 RWReactivePlayground[9193:a0b] is </span><br><span class="line">2013-12-24 14:48:50.695 RWReactivePlayground[9193:a0b] is t</span><br><span class="line">2013-12-24 14:48:50.831 RWReactivePlayground[9193:a0b] is th</span><br><span class="line">2013-12-24 14:48:50.878 RWReactivePlayground[9193:a0b] is thi</span><br><span class="line">2013-12-24 14:48:50.901 RWReactivePlayground[9193:a0b] is this</span><br><span class="line">2013-12-24 14:48:51.009 RWReactivePlayground[9193:a0b] is this </span><br><span class="line">2013-12-24 14:48:51.142 RWReactivePlayground[9193:a0b] is this m</span><br><span class="line">2013-12-24 14:48:51.236 RWReactivePlayground[9193:a0b] is this ma</span><br><span class="line">2013-12-24 14:48:51.335 RWReactivePlayground[9193:a0b] is this mag</span><br><span class="line">2013-12-24 14:48:51.439 RWReactivePlayground[9193:a0b] is this magi</span><br><span class="line">2013-12-24 14:48:51.535 RWReactivePlayground[9193:a0b] is this magic</span><br><span class="line">2013-12-24 14:48:51.774 RWReactivePlayground[9193:a0b] is this magic?</span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡è¾“å…¥æ¡†ä¸­çš„æ–‡å­—å˜åŒ–ï¼Œblock ä¸­çš„ä»£ç å°±ä¼šè¢«æ‰§è¡Œï¼Œç„¶è€Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨ Target-Actionã€Delegate ç­‰æœºåˆ¶ï¼Œåªæœ‰ä¿¡å·å’Œ blockï¼Œå¤šä¹ˆä»¤äººå…´å¥‹å•Šï¼</p>
<p>RAC ä¿¡å·ï¼ˆç”± RACSignal ç±»è¡¨ç¤ºï¼‰ä¼šå‘å®ƒçš„è®¢é˜…è€…å‘é€äº‹ä»¶æµï¼Œ<strong>äº‹ä»¶åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼šnextã€error å’Œ completed</strong>ã€‚åœ¨ä¿¡å·å‘é€ error æˆ–è€… complete äº‹ä»¶ç»“æŸè‡ªå·±ä¹‹å‰ï¼Œå®ƒå¯ä»¥å‘é€ä»»æ„æ•°é‡çš„ next äº‹ä»¶ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­æˆ‘ä»¬ä¸»è¦å…³æ³¨ next äº‹ä»¶ï¼Œå…¶ä½™ä¸¤ç§äº‹ä»¶ä¼šåœ¨ç¬¬äºŒéƒ¨åˆ†è¯¦ç»†æè¿°ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘ç»è¿‡å‰é¢çš„ä»‹ç»ï¼Œå¦‚æœè¯»è€…å¯¹ <a href="http://reactivex.io/" target="_blank" rel="noopener">ReactiveX</a> ç†Ÿæ‚‰çš„è¯ï¼Œåº”è¯¥å·²ç»æ˜ç™½è¿™ä¸ªæ¡†æ¶åˆ°åº•è¦åšä»€ä¹ˆäº†ï¼Œä¸è¿‡èåˆäº†å“åº”å¼ç¼–ç¨‹ä¹‹åï¼ŒRAC æ›´ä¸ºå¼ºå¤§ã€‚</p>
</blockquote>
<p>RACSignal ç±»æœ‰ä¸€ç³»åˆ—æ–¹æ³•ç”¨äºæ³¨å†Œç›‘å¬ä¸åŒçš„äº‹ä»¶ç±»å‹ã€‚æ¯ä¸€ä¸ªæ–¹æ³•ä¼šè¦æ±‚ä¼ å…¥ä¸€ä¸ªæˆ–è€…å¤šä¸ª block å‚æ•°ï¼Œç”¨äºåœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½ å·²ç»çœ‹åˆ°ä½¿ç”¨ <code>subscribeNext</code>æ–¹æ³•æ¥ä¸ºæ¯ä¸€ä¸ª next äº‹ä»¶æ·»åŠ  block ç”¨äºæ‰§è¡Œçš„è¿‡ç¨‹äº†ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘RAC å°†äº‹ä»¶æºæŠ½è±¡æˆ RACSignalï¼Œæ¯”å¦‚ä¸€ä¸ª Buttonï¼Œä¸€ä¸ªå±æ€§ï¼›å°†åŸå…ˆçš„äº‹ä»¶æŠ½è±¡æˆäº‹ä»¶ï¼Œä¸è¿‡äº‹ä»¶æ²¡æœ‰åœ¨ RAC ä¸­æœ‰æ˜ç¡®è¡¨ç¤ºï¼ˆèµ·ç å‰é¢è¿˜æ²¡æåˆ°ï¼‰ï¼›ä¸€ä¸ªå®Œæ•´çš„äº‹ä»¶æµï¼ˆæ¯”å¦‚ Button çš„ç‚¹å‡»äº‹ä»¶ï¼‰ç”±è‹¥å¹²ä¸ª next äº‹ä»¶å’Œä¸€ä¸ª error/complete ç±»å‹äº‹ä»¶ç»„æˆã€‚</p>
</blockquote>
<p>RAC æ¡†æ¶ä½¿ç”¨ Category ä¸ºæ ‡å‡†çš„ UIKit Control ç±»æ·»åŠ äº†å¾ˆå¤šçš„ä¿¡å·ï¼Œä»¥ä¾¿äºå¼€å‘è€…å¯ä»¥è®¢é˜…è¿™äº›äº‹ä»¶ï¼Œè¿™å°±æ˜¯å‰é¢ä¾‹å­ä¸­<code>rac_textSignal</code>å±æ€§çš„ç”±æ¥ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®© RAC ä¸ºæˆ‘ä»¬åšç‚¹å„¿å®é™…çš„å·¥ä½œã€‚</p>
<p>RAC å®šä¹‰äº†å¾ˆå¤šçš„æ“ä½œç”¨äºå¤„ç†äº‹ä»¶æµã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ åªå¯¹è¶…è¿‡å­—ç¬¦é•¿åº¦è¶…è¿‡ 3 çš„ç”¨æˆ·åæ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>filter</code>æ“ä½œç¬¦ï¼Œæ›´æ–°å‰é¢çš„ä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[self.usernameTextField.rac_textSignal</span><br><span class="line">  filter:^BOOL(id value) &#123;</span><br><span class="line">    NSString *text = value;</span><br><span class="line">    return text.length &gt; 3;</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½ ç¼–è¯‘è¿è¡Œå¹¶åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œå°±ä¼šå‘ç°åªæœ‰åœ¨ç”¨æˆ·åé•¿åº¦å¤§äº3çš„æƒ…å†µä¸‹æ‰ä¼šæœ‰ Log è¾“å‡ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2013-12-26 08:17:51.335 RWReactivePlayground[9654:a0b] is t</span><br><span class="line">2013-12-26 08:17:51.478 RWReactivePlayground[9654:a0b] is th</span><br><span class="line">2013-12-26 08:17:51.526 RWReactivePlayground[9654:a0b] is thi</span><br><span class="line">2013-12-26 08:17:51.548 RWReactivePlayground[9654:a0b] is this</span><br><span class="line">2013-12-26 08:17:51.676 RWReactivePlayground[9654:a0b] is this </span><br><span class="line">2013-12-26 08:17:51.798 RWReactivePlayground[9654:a0b] is this m</span><br><span class="line">2013-12-26 08:17:51.926 RWReactivePlayground[9654:a0b] is this ma</span><br><span class="line">2013-12-26 08:17:51.987 RWReactivePlayground[9654:a0b] is this mag</span><br><span class="line">2013-12-26 08:17:52.141 RWReactivePlayground[9654:a0b] is this magi</span><br><span class="line">2013-12-26 08:17:52.229 RWReactivePlayground[9654:a0b] is this magic</span><br><span class="line">2013-12-26 08:17:52.486 RWReactivePlayground[9654:a0b] is this magic?</span><br></pre></td></tr></table></figure>
<p>ä½ åœ¨è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„<strong>ç®¡é“</strong>â€”â€”è¿™ä¸ªæ¦‚å¿µå¯¹äºå“åº”å¼ç¼–ç¨‹æ¥è¯´è‡³å…³é‡è¦ï¼šå°† App çš„åŠŸèƒ½è¡¨è¾¾æˆæ•°æ®æµå½¢å¼ã€‚ä¸‹é¢çš„å›¾å¯ä»¥å¸®ä½ ç†æ¸…æ¥šè¿™ä¸ªæµï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/FilterPipeline.png" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>åœ¨ä¸Šé¢çš„å›¾ç¤ºä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°<code>rac_textSignal</code>å°±æ˜¯äº‹ä»¶æºï¼Œæ•°æ®æµï¼ˆå…¶ä¸­åŒ…å«äº‹ä»¶ï¼‰æµç»<code>fliter</code>ï¼Œåªæœ‰è¾“å…¥å­—ç¬¦ä¸²é•¿åº¦å¤§äº 3 çš„äº‹ä»¶æ‰ä¼šç©¿è¿‡å»ï¼Œç®¡é“çš„æœ€åä¸€æ­¥æ˜¯<code>subscribeNext:</code>å‡½æ•°â€”â€”ä¹Ÿå°±æ˜¯æ‰“å°äº‹ä»¶å€¼çš„åœ°æ–¹ã€‚</p>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯<code>filter</code>æ“ä½œçš„è¾“å‡ºä¹Ÿæ˜¯ä¸€ä¸ª RACSingalï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„ä»£ç æ–¹å¼æ¥åˆ†ç¦»ç®¡é“çš„å¤„ç†æ­¥éª¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *usernameSourceSignal = </span><br><span class="line">    self.usernameTextField.rac_textSignal;</span><br><span class="line"> </span><br><span class="line">RACSignal *filteredUsername = [usernameSourceSignal  </span><br><span class="line">  filter:^BOOL(id value) &#123;</span><br><span class="line">    NSString *text = value;</span><br><span class="line">    return text.length &gt; 3;</span><br><span class="line">  &#125;];</span><br><span class="line"> </span><br><span class="line">[filteredUsername subscribeNext:^(id x) &#123;</span><br><span class="line">  NSLog(@&quot;%@&quot;, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>å› ä¸º RACSignal ä¸Šçš„æ¯ä¸€ä¸ªæ­¥éª¤éƒ½ä¼šè¿”å›ä¸€ä¸ª RACSignalï¼Œæ‰€ä»¥æ•´ä½“å½¢æˆäº†ä¸€ä¸ªé“¾å¼æ¥å£ï¼Œè¿™ä¸ªç‰¹æ€§ä½¿å¾—å¼€å‘è€…ä¸ç”¨ä¸ºæ¯ä¸€ä¸ªä¸­é—´æ“ä½œç”Ÿæˆä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>ReactiveCocoa é‡åº¦ä¾èµ– blockã€‚å¦‚æœä½ æ˜¯ block æ–°æ‰‹ï¼Œä½ åº”è¯¥å°è¯•è¯»ä¸€ä¸‹è‹¹æœçš„ <a href="https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/Blocks/Articles/00_Introduction.html" target="_blank" rel="noopener">Blocks Programming Topics </a>ã€‚å¦‚æœä½ å¾ˆç†Ÿæ‚‰ blockï¼Œä½†æ˜¯è§‰å¾—è¿™æ ·çš„è¯­æ³•éš¾ä»¥ç†è§£ï¼Œä¸å®¹æ˜“è®°ä½ï¼Œé‚£ <a href="http://fuckingblocksyntax.com/" target="_blank" rel="noopener">f<strong>*</strong>gblocksyntax.com</a> ç½‘ç«™å¯¹ä½ æˆ–è®¸å¾ˆæœ‰ç”¨ï¼ï¼ˆéƒ¨åˆ†å­—ç¬¦ç”¨ * éšè—ä»¥ä¿æŠ¤çº¯æ´çš„ç«¥é‹ï¼Œä½†æ˜¯é“¾æ¥æ˜¯æœ‰æ•ˆçš„ã€‚ï¼‰</p>
</blockquote>
<h2 id="å°å°çš„è½¬æ¢"><a href="#å°å°çš„è½¬æ¢" class="headerlink" title="å°å°çš„è½¬æ¢"></a>å°å°çš„è½¬æ¢</h2><p>å¦‚æœä½ æŠŠä½ çš„ä»£ç æ›´æ–°æˆå¤šä¸ª RACSignal ç»„ä»¶å¯¹è±¡ï¼Œç°åœ¨æ˜¯æ—¶å€™å°†å®ƒè¿˜åŸæˆé“¾å¼è°ƒç”¨äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[self.usernameTextField.rac_textSignal</span><br><span class="line">  filter:^BOOL(id value) &#123;</span><br><span class="line">    NSString *text = value; // implicit cast</span><br><span class="line">    return text.length &gt; 3;</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰ä¸ªæ˜¾å¼åœ°ä»<code>id</code>ç±»å‹è½¬æ¢ä¸º <code>NSString</code>çš„è¿‡ç¨‹ï¼Œè¿™è¡Œä»£ç çœ‹ä¸Šå»ä¸æ€ä¹ˆä¼˜é›…ã€‚å¹¸è¿çš„æ˜¯ï¼Œç”±äºå‘é€ç»™è¿™ä¸ª Block çš„æ•°æ®å§‹ç»ˆéƒ½ä¼šæ˜¯<code>NSString</code>ç±»å‹ï¼Œå› æ­¤å¼€å‘è€…å¯ä»¥è‡ªè¡Œæ›´æ”¹å‚æ•°ç±»å‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[[self.usernameTextField.rac_textSignal</span><br><span class="line">  filter:^BOOL(NSString *text) &#123;</span><br><span class="line">    return text.length &gt; 3;</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å¹¶è¿è¡Œï¼Œç¡®è®¤ç»“æœå¦‚é¢„æœŸã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯äº‹ä»¶ï¼ˆEventï¼‰ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯äº‹ä»¶ï¼ˆEventï¼‰ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯äº‹ä»¶ï¼ˆEventï¼‰ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯äº‹ä»¶ï¼ˆEventï¼‰ï¼Ÿ</h2><p>è¿„ä»Šä¸ºæ­¢æœ¬æ•™ç¨‹å·²ç»æè¿°äº†ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å»è¯¦è¿°è¿™äº›äº‹ä»¶çš„ç»“æ„ï¼Œæœ‰è¶£çš„æ˜¯äº‹ä»¶å¯ä»¥åŒ…å«ä»»ä½•ä¸œè¥¿ï¼</p>
<p>ä¸ºäº†å¼„æ¸…æ¥šè¿™ç‚¹ï¼Œæˆ‘ä»¬å°†åœ¨ç®¡é“ä¸­å†æ·»åŠ ä¸€ä¸ªæ“ä½œï¼Œæ›´æ–°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[[self.usernameTextField.rac_textSignal</span><br><span class="line">  map:^id(NSString *text) &#123;</span><br><span class="line">    return @(text.length);</span><br><span class="line">  &#125;]</span><br><span class="line">  filter:^BOOL(NSNumber *length) &#123;</span><br><span class="line">    return [length integerValue] &gt; 3;</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, x);</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œè¿™æ®µä»£ç å°±ä¼šå‘ç°æ§åˆ¶å°è¾“å‡ºçš„ä¸å†æ˜¯è¾“å…¥æ¡†ä¸­çš„å†…å®¹ï¼Œè€Œæ˜¯å®ƒçš„é•¿åº¦ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2013-12-26 12:06:54.566 RWReactivePlayground[10079:a0b] 4</span><br><span class="line">2013-12-26 12:06:54.725 RWReactivePlayground[10079:a0b] 5</span><br><span class="line">2013-12-26 12:06:54.853 RWReactivePlayground[10079:a0b] 6</span><br><span class="line">2013-12-26 12:06:55.061 RWReactivePlayground[10079:a0b] 7</span><br><span class="line">2013-12-26 12:06:55.197 RWReactivePlayground[10079:a0b] 8</span><br><span class="line">2013-12-26 12:06:55.300 RWReactivePlayground[10079:a0b] 9</span><br><span class="line">2013-12-26 12:06:55.462 RWReactivePlayground[10079:a0b] 10</span><br><span class="line">2013-12-26 12:06:55.558 RWReactivePlayground[10079:a0b] 11</span><br><span class="line">2013-12-26 12:06:55.646 RWReactivePlayground[10079:a0b] 12</span><br></pre></td></tr></table></figure>
<p>æ–°åŠ çš„ map æ“ä½œä½¿ç”¨æä¾›çš„ block æ¥å˜æ¢äº‹ä»¶çš„æ•°æ®ã€‚å¯¹äºæ¯ä¸€ä¸ªå®ƒæ¥æ”¶åˆ°çš„ next äº‹ä»¶ï¼ŒRAC éƒ½ä¼šè¿è¡Œæä¾›çš„ blockï¼Œå°†è¿”å›å€¼ä½œä¸ºä¸€ä¸ªæ–°çš„ next äº‹ä»¶æ”¾å‡ºã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œmap æ“ä½œä»¥ NSString ä¸ºè¾“å…¥ï¼Œè½¬æ¢æˆå†…å®¹é•¿åº¦åè¿”å›ã€‚ä¸‹é¢çš„å›¾æ›´å½¢è±¡çš„å±•ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/FilterAndMapPipeline.png" alt="RAC æ•°æ®æµå›¾"></div>

<p>å¦‚è¯»è€…ç¼©å‡ï¼Œmap æ“ä½œåçš„æ‰€æœ‰æ­¥éª¤æ¥æ”¶åˆ°çš„éƒ½æ˜¯ä¸€ä¸ª NSNumber å®ä¾‹ã€‚ä½ å¯ä»¥ä½¿ç”¨ map æ“ä½œå°†ä¼ å…¥çš„æ•°æ®è½¬æ¢æˆä»»æ„ä½ å–œæ¬¢çš„ä¸œè¥¿ï¼Œåªè¦å®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡å³å¯ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>text.length</code>å±æ€§è¿”å›çš„æ˜¯ NSUIntegerï¼Œæ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹ï¼Œä¸ºäº†å°†å®ƒç”¨ä½œäº‹ä»¶çš„æ•°æ®å†…å®¹ï¼Œå®ƒå¿…é¡»è¢«è£…ç®±ã€‚åº†å¹¸çš„æ˜¯ï¼Œåœ¨ OC é‡Œé¢ä½¿ç”¨å­—é¢é‡è¯­æ³•å¯ä»¥å¾ˆä¼˜é›…çš„è¿›è¡Œè½¬æ¢ã€‚</p>
</blockquote>
<p>ç°åœ¨æ˜¯æ—¶å€™ç”¨å‰é¢å­¦åˆ°çš„æ¦‚å¿µæ¥æ›´æ–°ä¸€ä¸‹ ReactivePlayground åº”ç”¨äº†ï¼Œä½ å¯ä»¥å°†å‰é¢æ·»åŠ çš„å—²å—å…¨éƒ¨ç§»é™¤æ‰ã€‚</p>
<h2 id="Creating-Valid-State-Signals"><a href="#Creating-Valid-State-Signals" class="headerlink" title="Creating Valid State Signals"></a>Creating Valid State Signals</h2><p>ç¬¬ä¸€ä»¶è¦åšçš„äº‹æƒ…å°±æ˜¯åˆ›å»ºä¸€äº›ä¿¡å·æ¥åæ˜ è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ â€”â€” åœ¨<strong>RMViewController.m</strong>çš„<code>viewDidLoad</code>æ–¹æ³•æœ€åæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *validUsernameSignal =</span><br><span class="line">  [self.usernameTextField.rac_textSignal</span><br><span class="line">    map:^id(NSString *text) &#123;</span><br><span class="line">      return @([self isValidUsername:text]);</span><br><span class="line">    &#125;];</span><br><span class="line"> </span><br><span class="line">RACSignal *validPasswordSignal =</span><br><span class="line">  [self.passwordTextField.rac_textSignal</span><br><span class="line">    map:^id(NSString *text) &#123;</span><br><span class="line">      return @([self isValidPassword:text]);</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç é€šè¿‡ map æ“ä½œå°†è¾“å…¥è½¬æ¢æˆ boolean è¾“å‡ºï¼ŒåŒæ—¶è£…ç®±ä¸º NSNumber ç±»å‹ã€‚ä¸‹ä¸€æ­¥å°±æ˜¯è¿›ä¸€æ­¥è½¬æ¢è¿™ä¸¤ä¸ªä¿¡å·ï¼Œä»¥ä¾¿äºèƒ½ä¸ºè¾“å…¥æ¡†æä¾›åˆé€‚çš„èƒŒæ™¯é¢œè‰²ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯è®¢é˜…ä¿¡å·å¹¶ä½¿ç”¨è¾“å‡ºæ•°æ®æ¥æ›´æ–°èƒŒæ™¯é¢œè‰²å³å¯ï¼Œå…¶ä¸­ä¸€ç§å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[[validPasswordSignal</span><br><span class="line">  map:^id(NSNumber *passwordValid) &#123;</span><br><span class="line">    return [passwordValid boolValue] ? [UIColor clearColor] : [UIColor yellowColor];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(UIColor *color) &#123;</span><br><span class="line">    self.passwordTextField.backgroundColor = color;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç çœ‹ä¸Šå»éå¸¸è½å &amp; ä¸ä¼˜é›…ã€‚</p>
<blockquote>
<p>ä¸ºäº†å®ç°ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œæ‹†åˆ†å‡ºäº†å¾ˆå¤šçš„æ“ä½œï¼Œé˜…è¯»èµ·æ¥å¾ˆç´¯èµ˜ã€‚</p>
</blockquote>
<p>RAC ä¸ºè¿™ç§éœ€æ±‚æä¾›äº†å®ï¼Œå¯ä»¥ä¼˜é›…çš„å®ç°å®ƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RAC(self.passwordTextField, backgroundColor) =</span><br><span class="line">  [validPasswordSignal</span><br><span class="line">    map:^id(NSNumber *passwordValid) &#123;</span><br><span class="line">      return [passwordValid boolValue] ? [UIColor clearColor] : [UIColor yellowColor];</span><br><span class="line">    &#125;];</span><br><span class="line"> </span><br><span class="line">RAC(self.usernameTextField, backgroundColor) =</span><br><span class="line">  [validUsernameSignal</span><br><span class="line">    map:^id(NSNumber *passwordValid) &#123;</span><br><span class="line">     return [passwordValid boolValue] ? [UIColor clearColor] : [UIColor yellowColor];</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>
<p><strong><code>RAC</code></strong>å®å…è®¸å°†ä¿¡å·çš„è¾“å‡ºèµ‹å€¼ç»™å¯¹è±¡çš„å±æ€§ã€‚å®ƒéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯å±æ€§è®¾ç½®çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ˜¯å±æ€§åã€‚æ¯æ¬¡ä¿¡å·é‡Šæ”¾ä¸€ä¸ªäº‹ä»¶ï¼Œäº‹ä»¶çš„å€¼éƒ½ä¼šè¢«èµ‹å€¼ç»™å±æ€§ã€‚</p>
<p>è¿™ä¸ªå®ç°éå¸¸ä¼˜é›…ï¼Œä½ è§‰å¾—å‘¢ï¼Ÿ</p>
<p>åœ¨ç¼–è¯‘è¿è¡Œå‰ï¼Œè¿˜éœ€è¦æ‰¾åˆ°<code>upadteUIState</code>æ–¹æ³•ï¼Œç§»é™¤ä¸‹é¢ä¸¤è¡Œä»£ç æ¥æ¸…æ¥šéå“åº”å¼ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.usernameTextField.backgroundColor = self.usernameIsValid ? [UIColor clearColor] : [UIColor yellowColor];</span><br><span class="line">self.passwordTextField.backgroundColor = self.passwordIsValid ? [UIColor clearColor] : [UIColor yellowColor];</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œä»£ç ï¼Œä½ ä¼šå‘ç°è¾“å…¥æ¡†åœ¨è¾“å…¥éæ³•çš„æ—¶å€™é«˜äº®äº†ï¼Œè¾“å…¥åˆæ³•çš„æ—¶å€™é«˜äº®æ¶ˆå¤±ã€‚</p>
<p>ä¸‹é¢è¿™å¹…å›¾å±•ç°äº†å½“å‰çš„é€»è¾‘ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/TextFieldValidPipeline.png" alt="RAC æ•°æ®æµå›¾"></div>

<p>ä½ æ˜¯ä¸æ˜¯å¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆè¿™é‡Œè¦åˆ›å»ºä¸¤ä¸ªçš„<code>validPasswordSignal</code>å’Œ<code>validUsernameSignal</code>ä¿¡å·å˜é‡ï¼Œè¿™ä¸æˆ‘ä»¬ä¹‹å‰æåˆ°çš„é“¾å¼ç®¡é“ç›¸è¿èƒŒå‘€ï¼Ÿä¿æŒè€å¿ƒï¼Œåé¢ä¼šè¶Šæ¥è¶Šæ¸…æ™°ã€‚</p>
<h2 id="Combining-signals"><a href="#Combining-signals" class="headerlink" title="Combining signals"></a>Combining signals</h2><p>ç°åœ¨ App é‡Œé¢çš„<code>Sign In</code>æŒ‰é’®åªæœ‰åœ¨ç”¨æˆ·åå’Œå¯†ç è¾“å…¥æ¡†éƒ½æœ‰åˆæ³•è¾“å…¥çš„æƒ…å†µä¸‹æ‰ä¼šå¯ç‚¹å‡»ï¼Œåˆåˆ°äº†ä½¿ç”¨å“åº”å¼ç¼–ç¨‹é£æ ¼çš„æ—¶å€™äº†ï¼</p>
<p>ç°æœ‰çš„ä»£ç å·²ç»é€šè¿‡ä¿¡å·æ¥å‘é€ä¸€ä¸ªå¸ƒå°”å€¼åæ˜ ç”¨æˆ·åå’Œå¯†ç æ˜¯ä¸æ˜¯æœ‰æ•ˆçš„äº†ã€‚ä½ çš„ä»»åŠ¡å°±æ˜¯å°†è¿™ä¸¤ä¸ªä¿¡å·ç»„åˆèµ·æ¥æ¥ç¡®å®šæ˜¯å¦æ¿€æ´»ç™»é™†æŒ‰é’®ã€‚</p>
<p>åœ¨<code>viewDidLoad</code>æ–¹æ³•çš„æœ€åï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signUpActiveSignal =</span><br><span class="line">  [RACSignal combineLatest:@[validUsernameSignal, validPasswordSignal]</span><br><span class="line">                    reduce:^id(NSNumber *usernameValid, NSNumber *passwordValid) &#123;</span><br><span class="line">                      return @([usernameValid boolValue] &amp;&amp; [passwordValid boolValue]);</span><br><span class="line">                    &#125;];</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç ä½¿ç”¨<strong><code>combineLatest:reduce:</code> </strong>æ–¹æ³•æ¥ç»„åˆç”±<code>validUsernameSignal</code>å’Œ<code>validPasswordSignal</code>ä¿¡å·å‘å‡ºçš„æœ€æ–°å€¼ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ä¿¡å·ã€‚æ¯æ¬¡è¿™ä¸¤ä¸ªä¿¡å·ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘å‡ºæ–°çš„å€¼ï¼Œéƒ½ä¼šå¯¼è‡´<code>reduce</code> block æ‰§è¡Œã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>RACSignal ç»„åˆæ–¹æ³•å¯ä»¥ç»„åˆä»»æ„æ•°é‡çš„ä¿¡å·ï¼Œreduce block çš„å‚æ•°åˆ™å¯¹åº”ç€æ¯ä¸€ä¸ªæºä¿¡å·çš„è¾“å‡ºå€¼ã€‚RAC åœ¨åº•å±‚åšäº†å¾ˆå¤šçš„äº‹æƒ…ï¼ŒæŸ¥çœ‹å®ƒçš„å®ç°æ˜¯å¾ˆæœ‰ä»·å€¼çš„ã€‚</p>
</blockquote>
<p>æ—¢ç„¶å·²ç»ç”Ÿæˆäº†ä¸€ä¸ªåˆé€‚çš„ä¿¡å·ï¼Œå¯ä»¥æŠŠä¸‹é¢çš„ä»£ç æ·»åŠ åˆ°<code>viewDidLoad</code>æ–¹æ³•çš„æœ«å°¾ï¼Œå®ƒä¼šå»æ›´æ–°æŒ‰é’®çš„ enabled å±æ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[signUpActiveSignal subscribeNext:^(NSNumber *signupActive) &#123;</span><br><span class="line">   self.signInButton.enabled = [signupActive boolValue];</span><br><span class="line"> &#125;];</span><br></pre></td></tr></table></figure>
<p>åŒæ ·çš„ï¼Œç§»é™¤ä¸‹é¢çš„éå“åº”å®ç°ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic) BOOL passwordIsValid;</span><br><span class="line">@property (nonatomic) BOOL usernameIsValid;</span><br></pre></td></tr></table></figure>
<p>ä»¥åŠ<code>viewDidLoad</code>æ–¹æ³•ä¸­çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// handle text changes for both text fields</span><br><span class="line">[self.usernameTextField addTarget:self</span><br><span class="line">                           action:@selector(usernameTextFieldChanged)</span><br><span class="line">                 forControlEvents:UIControlEventEditingChanged];</span><br><span class="line">[self.passwordTextField addTarget:self </span><br><span class="line">                           action:@selector(passwordTextFieldChanged)</span><br><span class="line">                 forControlEvents:UIControlEventEditingChanged];</span><br></pre></td></tr></table></figure>
<p>ç„¶åç§»é™¤<code>updateUIState</code>ã€<code>usernameTextFieldChanged</code>å’Œ<code>passwordTextFieldChanged</code>æ–¹æ³•ï¼Œç§»é™¤è°ƒç”¨å®ƒä»¬çš„ä»£ç ã€‚ç„¶åç¼–è¯‘è¿è¡Œï¼Œ<strong>Sign In</strong> æŒ‰é’®å°±ä¼šåœ¨ç”¨æˆ·åå¯†ç åˆæ³•çš„æƒ…å†µä¸‹è¢«æ¿€æ´»ï¼Œé€»è¾‘å±•ç¤ºå¦‚ä¸‹å›¾ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/CombinePipeline.png" alt="RAC æ•°æ®æµå›¾"></div>

<p>ä¸Šå›¾å±•ç°äº†ä¸€äº›é‡è¦çš„æ¦‚å¿µï¼Œç†è§£è¿™äº›æ¦‚å¿µæœ‰åŠ©äºä½ ä½¿ç”¨ RAC å®ç°ä¸€äº›å¼ºå¤§çš„åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>åˆ†å‰²</strong>  ä¿¡å·å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…ï¼Œå¯ä»¥æˆä¸ºå¤šä¸ªç®¡é“çš„ä¿¡å·æºã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œåæ˜ ç”¨æˆ·åå¯†ç æ˜¯å¦åˆæ³•çš„ boolean ä¿¡å·å°±è¢«ä¸¤ä¸ªç®¡é“æ¥æ”¶ç”¨äºä¸åŒçš„ç›®çš„ã€‚</li>
<li><strong>ç»„åˆ</strong>  å¤šä¸ªä¿¡å·å¯ä»¥è¢«ç»„åˆç”Ÿæˆæ–°çš„ä¿¡å·ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¸¤ä¸ª boolean ä¿¡å·å°±è¢«ç»„åˆäº†èµ·æ¥ã€‚ç»„åˆèµ·æ¥çš„ä¿¡å·å¯ä»¥ç”ŸæˆåŒ…å«ä»»ä½•ç±»å‹å€¼çš„æ–°ä¿¡å·ã€‚</li>
</ul>
<p>ä½¿ç”¨ RAC çš„ç»“æœå°±æ˜¯ç°åœ¨åº”ç”¨é‡Œé¢å†ä¹Ÿæ²¡æœ‰åæ˜ ä¸¤ä¸ªè¾“å…¥æ¡†è¾“å…¥å†…å®¹æ˜¯å¦åˆæ³•çš„å˜é‡ã€‚<strong>è¿™å°†æ˜¯ä½ é‡‡ç”¨å“åº”å¼ç¼–ç¨‹é£æ ¼çš„ä¸€ä¸ªå…³é”®åŸå› â€”â€”ä¸å†éœ€è¦ä½¿ç”¨å®ä¾‹å˜é‡æ¥è·Ÿè¸ªå¯å˜çŠ¶æ€ã€‚</strong></p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘è¿™æˆ–è®¸æ˜¯ä¸€ä¸ªåŸå› ï¼Œä½†æ˜¯è¿™ä¸ªä¾‹å­ä¸­å¹¶ä¸æ˜æ˜¾ï¼Œå› ä¸ºå³ä½¿ä¸ç”¨ RACï¼Œä¹Ÿå¯ä»¥ä¸ç”¨å˜é‡ä¿å­˜çŠ¶æ€å°±å®ç°ä¸Šé¢çš„åŠŸèƒ½ã€‚</p>
</blockquote>
<h2 id="Reactive-Sign-in"><a href="#Reactive-Sign-in" class="headerlink" title="Reactive Sign-in"></a>Reactive Sign-in</h2><p>ç¤ºä¾‹åº”ç”¨ç°åœ¨ä½¿ç”¨å“åº”å¼ç®¡é“æ¥ç®¡ç†è¾“å…¥æ¡†å’ŒæŒ‰é’®çš„çŠ¶æ€ã€‚ç„¶è€ŒæŒ‰é’®çš„ç‚¹å‡»å¤„ç†ä½¿ç”¨çš„è¿˜æ˜¯ actionï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±æ˜¯å°†è¿™å—ä¹Ÿæ”¹é€ æˆå“åº”å¼çš„ï¼</p>
<p><strong>Sign In</strong> æŒ‰é’®ä¸Šçš„ <strong>Touch Up Inside</strong> äº‹ä»¶ä¼šè§¦å‘<code>signInButtonTouched</code>äº‹ä»¶ã€‚æˆ‘ä»¬é¦–å…ˆç§»é™¤æ‰è¿™ä¸ªå…³ç³»ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘åŸæ–‡ä¸­è¿™ä¸ª Action çš„æ˜¯é€šè¿‡ Storyboard æ·»åŠ çš„ï¼Œè¿™é‡Œç§»é™¤çš„è¿‡ç¨‹å°±ä¸ä½œç¿»è¯‘äº†ã€‚</p>
</blockquote>
<p>å‰é¢å·²ç»å±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ RAC æ¡†æ¶ç»™æ ‡å‡†çš„ UIKit Control æ·»åŠ å±æ€§å’Œæ–¹æ³•äº†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»ä½¿ç”¨è¿‡<code>rac_textSignal</code> â€”â€” åœ¨æ–‡æœ¬å˜åŒ–çš„æ—¶å€™è§¦å‘äº‹ä»¶ã€‚ä¸ºäº†èƒ½å¤Ÿå¤„ç†äº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦å¤–ä¸€ä¸ªæ·»åŠ è¿›å»çš„æ–¹æ³•ï¼š<code>rac_signalForControlEvents</code>ã€‚</p>
<p>å›åˆ°<code>RWViewController.m</code>ï¼Œå°†ä¸‹é¢çš„ä»£ç æ·»åŠ åˆ°<code>viewDidLoad</code>æ–¹æ³•æœ«å°¾ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[self.signInButton</span><br><span class="line">   rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">   subscribeNext:^(id x) &#123;</span><br><span class="line">     NSLog(@&quot;button clicked&quot;);</span><br><span class="line">   &#125;];</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç ä»æŒ‰é’®çš„<code>UIControlEventTouchUpInside</code>äº‹ä»¶ä¸­åˆ›é€ å‡ºäº†ä¸€ä¸ªä¿¡å·ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ªè®¢é˜…ä¸Šå»ï¼šæ¯æ¬¡åœ¨äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œéƒ½æ‰“å°ä¸€æ¬¡æ—¥å¿—ã€‚</p>
<p>ç¼–è¯‘å¹¶è¿è¡Œä»¥ç¡®è®¤æ—¥å¿—å®é™…ä¼šæ‰“å°ã€‚è®°ä½æŒ‰é’®åªæœ‰åœ¨ç”¨æˆ·åå’Œå¯†ç éƒ½åˆæ³•çš„æƒ…å†µä¸‹æ‰å¯ç‚¹å‡»ï¼Œæ‰€ä»¥è¯·åœ¨ä¸¤ä¸ªè¾“å…¥æ¡†ä¸­è¾“å…¥åˆæ³•çš„å†…å®¹ï¼Œç‚¹å‡»ä¹‹åå°±å¯ä»¥çœ‹åˆ°æ§åˆ¶å°çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2013-12-28 08:05:10.816 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:11.675 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:12.605 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:12.766 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:12.917 RWReactivePlayground[18203:a0b] button clicked</span><br></pre></td></tr></table></figure>
<p>æ—¢ç„¶è¿™ä¸ªæŒ‰é’®æœ‰ä¸€ä¸ªä¸º Touch äº‹ä»¶è€Œç”Ÿçš„ä¿¡å·ï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥å°±æ˜¯å°†ä¿¡å·ç»‘å®šåˆ°ç™»é™†å¤„ç†ä¸Šã€‚æ‰“å¼€<code>RMDummySignInService.h</code>çœ‹ä¸€ä¸‹æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef void (^RWSignInResponse)(BOOL);</span><br><span class="line"> </span><br><span class="line">@interface RWDummySignInService : NSObject</span><br><span class="line"> </span><br><span class="line">- (void)signInWithUsername:(NSString *)username</span><br><span class="line">                  password:(NSString *)password </span><br><span class="line">                  complete:(RWSignInResponse)completeBlock;</span><br><span class="line"> </span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæœåŠ¡ä»¥ç”¨æˆ·åã€å¯†ç ä»¥åŠä¸€ä¸ª completion block ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ª block åœ¨ç™»é™†æˆåŠŸæˆ–è€…å¤±è´¥åªä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å‰é¢æ‰“å° log çš„åœ°æ–¹æ›¿æ¢ä¸Šå¯¹è¿™ä¸ªæ¥å£çš„è°ƒç”¨ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>ä¸ºäº†å®ç°ç®€å•ï¼Œè¿™ä¸ªæœåŠ¡æ˜¯ Mock çš„ï¼Œé‚£æ ·å°±ä¸ç”¨ä¾èµ–å…¶ä½™çš„å¤–éƒ¨ API äº†ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªçœŸæ­£çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¦‚ä½•å»åˆ©ç”¨æ²¡æœ‰ç”¨ä¿¡å·å½¢å¼è¡¨è¾¾è¿‡çš„ APIï¼Ÿ</p>
</blockquote>
<h2 id="Creating-Signals"><a href="#Creating-Signals" class="headerlink" title="Creating Signals"></a>Creating Signals</h2><p>å®é™…ä¸Šä½¿ç”¨ä¿¡å·æ¥é€‚é…ä¸€ä¸ªå¼‚æ­¥æ¥å£æ˜¯éå¸¸ç®€å•çš„ã€‚é¦–å…ˆï¼Œä»<code>RWViewController.m</code>ä¸­ç§»é™¤<code>signInButtonToouched</code>æ–¹æ³•ï¼Œåé¢ä¼šç”¨å“åº”å¼çš„ä»£ç æ›¿ä»£å®ƒã€‚åœ¨<code>RWViewController.m</code>ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-(RACSignal *)signInSignal &#123;</span><br><span class="line">  return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [self.signInService</span><br><span class="line">     signInWithUsername:self.usernameTextField.text</span><br><span class="line">     password:self.passwordTextField.text</span><br><span class="line">     complete:^(BOOL success) &#123;</span><br><span class="line">       [subscriber sendNext:@(success)];</span><br><span class="line">       [subscriber sendCompleted];</span><br><span class="line">     &#125;];</span><br><span class="line">    return nil;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ–¹æ³•è°ƒç”¨äº†<code>RACSignal</code>ç±»çš„<code>createSignal:</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªä»¥å½“å‰è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç™»é™†çš„ä¿¡å·ã€‚åˆ›å»ºä¿¡å·åªéœ€è¦ä¸€ä¸ª block ä½œä¸ºå‚æ•°ï¼Œå½“æœ‰è®¢é˜…è€…è®¢é˜…è¿™ä¸ªä¿¡å·ä¹‹åï¼Œblock é‡Œé¢çš„ä»£ç å°±ä¼šæ‰§è¡Œã€‚block æœ¬èº«ä¹Ÿåªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼š<code>subscriber</code>ï¼Œå®ƒå®ç°äº†<code>RACSubscriber</code>åè®®ï¼Œ è¿™ä¸ªåè®®æœ‰ä¸€äº›æ–¹æ³•ç”¨äºå‘é€äº‹ä»¶ï¼šä½ å¯ä»¥å‘é€ä»»æ„æ•°é‡çš„ next ç±»å‹äº‹ä»¶ï¼Œæœ€åå†å‘é€ä¸€ä¸ª error/complete ç±»å‹çš„äº‹ä»¶ä½œä¸ºç»“æŸã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå®ƒå‘é€äº†ä¸€ä¸ª next äº‹ä»¶æ¥åæ˜ ç™»é™†æ˜¯å¦æˆåŠŸï¼Œç„¶åå‘é€ä¸€ä¸ª complete ç±»å‹äº‹ä»¶ã€‚</p>
<p>block çš„è¿”å›å€¼ç±»å‹æ˜¯ä¸€ä¸ª<code>RACDisposable</code>å¯¹è±¡ï¼Œå®ƒå…è®¸ä½¿ç”¨è€…åœ¨ä¸€æ®µè®¢é˜…å…³ç³»éœ€è¦å–æ¶ˆæˆ–è€…åˆ é™¤çš„æ—¶å€™è¿›è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚è¿™ä¸ªä¿¡å·æ²¡æœ‰ä»»ä½•çš„æ¸…ç†éœ€æ±‚ï¼Œå› æ­¤è¿”å› nilã€‚</p>
<p>å¦‚ä½ æ‰€è§ï¼Œå°†ä¸€ä¸ªå¼‚æ­¥æ¥å£åŒ…è£¹åœ¨ä¿¡å·ä¸­æ˜¯å¤šä¹ˆçš„ç®€å•ï¼</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥åˆ©ç”¨ä¸€ä¸‹è¿™ä¸ªæ–°çš„ä¿¡å·ï¼Œæ›´æ–°ä¹‹å‰æ·»åŠ åˆ°<code>viewDidLoad</code>æ–¹æ³•ä¸­çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[[self.signInButton</span><br><span class="line">   rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">   map:^id(id x) &#123;</span><br><span class="line">     return [self signInSignal];</span><br><span class="line">   &#125;]</span><br><span class="line">   subscribeNext:^(id x) &#123;</span><br><span class="line">     NSLog(@&quot;Sign in result: %@&quot;, x);</span><br><span class="line">   &#125;];</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨äº†å‰é¢æåˆ°çš„<code>map</code>æ–¹æ³•å°†æŒ‰é’®ç‚¹å‡»ä¿¡å·è½¬æ¢ä¸ºç™»é™†ä¿¡å·ï¼Œè®¢é˜…è€…åªæ˜¯ç®€å•çš„æ‰“å°ç»“æœã€‚</p>
<p>ç°åœ¨ç¼–è¯‘è¿è¡Œä»£ç ï¼Œç„¶åç‚¹å‡» <strong>Sign In</strong> æŒ‰é’®ï¼Œå°±å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ Logï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2014-01-08 21:00:25.919 RWReactivePlayground[33818:a0b] Sign in result:</span><br><span class="line">                                   <span class="tag">&lt;<span class="name">RACDynamicSignal:</span> <span class="attr">0xa068a00</span>&gt;</span> name: +createSignal:</span><br></pre></td></tr></table></figure>
<p><code>subscribeNext:</code> blockæ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªä¿¡å·ï¼Œå³ç™»é™†ä¿¡å·æœ¬èº«ï¼Œè€Œä¸æ˜¯ç™»é™†ä¿¡å·çš„ç»“æœã€‚ä¸‹é¢çš„å›¾å±•ç¤ºäº†å‰é¢ä»£ç çš„é€»è¾‘ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/SignalOfSignals.png" alt="RAC æ•°æ®æµå›¾"></div>

<p>å½“ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™<code>rac_signalForControlEvents</code>ä¼šè§¦å‘ä¸€ä¸ª next äº‹ä»¶ï¼ˆäº‹ä»¶æ•°æ®å°±æ˜¯ UIButtonï¼‰ï¼Œmap åˆ™æŠŠè¿™ä¸ª next äº‹ä»¶è½¬åŒ–æˆäº†ä¸€ä¸ªç™»é™†ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯è¯´åç»­çš„å¤„ç†æ­¥éª¤ä¸­å°†æ¥æ”¶åˆ°ä¸€ä¸ª RACSignalï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨<code>subscribeNext:</code>æ–¹æ³•ä¸­è§‚å¯Ÿçš„å¯¹è±¡ã€‚</p>
<p>è®¢é˜…ç™»é™†ä¿¡å·æœ¬èº«å½“ç„¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ï¼Œè§£å†³åŠæ³•ç§°ä¸º<strong>ä¿¡å·çš„ä¿¡å·ï¼ˆsignal of signalsï¼‰</strong>ï¼Œæ¢å¥è¯è¯´ä¹Ÿå°±æ˜¯å¤–éƒ¨ä¿¡å·åŒ…å«ç€ä¸€ä¸ªå†…éƒ¨ä¿¡å·ã€‚å¦‚æœä½ ç¡®å®æœ‰éœ€è¦ï¼Œæ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨å¤–éƒ¨ä¿¡å·çš„<code>subscribeNext:</code>æ–¹æ³•æ¥è®¢é˜…å†…éƒ¨ä¿¡å·çš„ã€‚ç„¶è€Œè¿™æ ·ä¼šé€ æˆåµŒå¥—æ··ä¹±ï¼Œä½†åº†å¹¸çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªå¾ˆæ™®éçš„é—®é¢˜ï¼ŒRAC å·²ç»ä¸ºæ­¤å‡†å¤‡å¥½äº†è§£å†³æ–¹æ¡ˆã€‚</p>
<h2 id="Signal-of-Signals"><a href="#Signal-of-Signals" class="headerlink" title="Signal of Signals"></a>Signal of Signals</h2><p>é—®é¢˜çš„è§£å†³æ–¹æ¡ˆéå¸¸ç›´æ¥ï¼Œåªéœ€è¦å°†<code>map</code>å‡½æ•°æ¢æˆ<code>flattenMap</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[[self.signInButton</span><br><span class="line">   rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">   flattenMap:^id(id x) &#123;</span><br><span class="line">     return [self signInSignal];</span><br><span class="line">   &#125;]</span><br><span class="line">   subscribeNext:^(id x) &#123;</span><br><span class="line">     NSLog(@&quot;Sign in result: %@&quot;, x);</span><br><span class="line">   &#125;];</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·åŒæ ·ä¼šæŠŠæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶è½¬æ¢ä¸ºç™»é™†ä¿¡å·ï¼Œä½†æ˜¯ä¹Ÿä¼šæŠŠå†…éƒ¨ä¿¡å·çš„äº‹ä»¶é€ä¼ åˆ°å¤–éƒ¨ä¿¡å·ï¼Œä»è€Œè½¬åŒ–ä¸ºå¤–éƒ¨ä¿¡å·é‡çš„äº‹ä»¶ï¼Œè¿™å°±æ˜¯<strong><code>flatten</code>(æ‰å¹³åŒ–)</strong>ã€‚</p>
<p>ç¼–è¯‘å¹¶è¿è¡Œä»£ç ï¼Œæ§åˆ¶å°çš„è¾“å‡ºå°±ä¼šå˜æˆå¦‚ä¸‹æ ·å­ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2013-12-28 18:20:08.156 RWReactivePlayground[22993:a0b] Sign in result: 0</span><br><span class="line">2013-12-28 18:25:50.927 RWReactivePlayground[22993:a0b] Sign in result: 1</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æ•´ä¸ªç®¡é“å°±åƒæˆ‘ä»¬æœŸæœ›çš„é‚£æ ·è¿è¡Œï¼Œæœ€åä¸€æ­¥å°±æ˜¯æŠŠç™»é™†æˆåŠŸ/å¤±è´¥åçš„é€»è¾‘æ·»åŠ åˆ°<code>subscribeNext</code>çš„ block ä¸­å»ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[[[self.signInButton</span><br><span class="line">  rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">  flattenMap:^id(id x) &#123;</span><br><span class="line">    return [self signInSignal];</span><br><span class="line">  &#125;]</span><br><span class="line">  subscribeNext:^(NSNumber *signedIn) &#123;</span><br><span class="line">    BOOL success = [signedIn boolValue];</span><br><span class="line">    self.signInFailureText.hidden = success;</span><br><span class="line">    if (success) &#123;</span><br><span class="line">      [self performSegueWithIdentifier:@&quot;signInSuccess&quot; sender:self];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª block ç°åœ¨æ ¹æ®ç™»é™†ä¿¡å·é‡å‘é€çš„äº‹ä»¶æ›´æ–°<code>signFailureText</code>çš„å¯è§æ€§ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¯¼èˆªã€‚</p>
<p>ç¼–è¯‘å¹¶è¿è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°çŒ«å’ªå•¦ï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/ReactivePlaygroundStarter.jpg" width="320" alt="ReactivePlaygroundåº”ç”¨ç¤ºä¾‹å›¾"></div>

<p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°å½“å‰çš„åº”ç”¨æœ‰ä¸€ä¸ªå¾ˆå°çš„ç”¨æˆ·ä½“éªŒé—®é¢˜ï¼šå½“åœ¨ç™»é™†éªŒè¯çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦åº”è¯¥ç¦æ‰ <strong>Sign In</strong> æŒ‰é’®çš„ç‚¹å‡»ï¼Ÿè¿™å¯ä»¥é˜²æ­¢ç”¨æˆ·é‡å¤ç‚¹å‡»ç™»é™†ï¼Œå¦å¤–ï¼Œå¦‚æœç™»é™†å¤±è´¥ï¼Œç”¨æˆ·å†æ¬¡ç™»é™†çš„æ—¶å€™åº”è¯¥éšè—æ‰é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªé€»è¾‘æ€ä¹ˆæ·»åŠ åˆ°å½“å‰çš„ç®¡é“ä¸­å»å‘¢ï¼Ÿæ›´æ”¹æŒ‰é’®çš„å¯ç‚¹å‡»çŠ¶æ€å¹¶ä¸æ˜¯ä¸€ä¸ªè½¬æ¢ã€è¿‡æ»¤æˆ–è€…å‰é¢æåˆ°çš„ä»»ä½•ä¸€ä¸ªæ“ä½œæ¦‚å¿µã€‚å®ƒè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ª <em>side effect</em> ï¼Œæˆ–è€…æ›´å‡†ç¡®ä¸€ç‚¹è¯´ï¼Œæ˜¯ä¸€ä¸ª next äº‹ä»¶å‘ç”Ÿæ—¶è¦åšçš„ä¸€ç‚¹é¢å¤–å·¥ä½œï¼Œä½†æ˜¯åˆä¸ä¼šæ”¹å˜äº‹ä»¶çš„æœ¬èº«ã€‚</p>
<h2 id="Adding-side-effect"><a href="#Adding-side-effect" class="headerlink" title="Adding side-effect"></a>Adding side-effect</h2><p>æ›¿æ¢å‰é¢çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[[[[self.signInButton</span><br><span class="line">   rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">   doNext:^(id x) &#123;</span><br><span class="line">     self.signInButton.enabled = NO;</span><br><span class="line">     self.signInFailureText.hidden = YES;</span><br><span class="line">   &#125;]</span><br><span class="line">   flattenMap:^id(id x) &#123;</span><br><span class="line">     return [self signInSignal];</span><br><span class="line">   &#125;]</span><br><span class="line">   subscribeNext:^(NSNumber *signedIn) &#123;</span><br><span class="line">     self.signInButton.enabled = YES;</span><br><span class="line">     BOOL success = [signedIn boolValue];</span><br><span class="line">     self.signInFailureText.hidden = success;</span><br><span class="line">     if (success) &#123;</span><br><span class="line">       [self performSegueWithIdentifier:@&quot;signInSuccess&quot; sender:self];</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;];</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå±•ç¤ºäº†å¦‚ä½•åœ¨ç®¡é“ä¸­ Button çš„ç‚¹å‡»äº‹ä»¶å‘ç”Ÿä¹‹åæ·»åŠ ä¸€ä¸ª<code>doNext:</code>æ­¥éª¤ã€‚<code>doNext:</code>æ­¥éª¤ä¸åæ‚”ä»»ä½•çš„å€¼ï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸€ä¸ª side-effectï¼Œå®ƒä¸ä¼šæ”¹å˜äº‹ä»¶ã€‚</p>
<blockquote>
<p>ã€è¯‘è€…æ³¨ã€‘doNext æ‰€åšçš„äº‹æƒ…è¿™é‡Œå°±ä¸è§£é‡Šäº†ã€‚</p>
</blockquote>
<p>æ‰€ä»¥æ•´ä¸ªæµç¨‹åˆå˜æˆä¸‹å›¾æ‰€ç¤ºï¼š</p>
<div align="center"><img src="https://koenig-media.raywenderlich.com/uploads/2014/01/SideEffects.png" alt="RAC æ•°æ®æµå›¾"></div>

<p>ç¼–è¯‘å¹¶è¿è¡Œä»£ç ï¼Œç¡®è®¤ <strong>Sign In</strong> æŒ‰é’®çš„å¯ç‚¹å‡»çŠ¶æ€å¦‚é¢„æœŸé‚£æ ·å˜åŒ–ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæ‰€æœ‰çš„å·¥ä½œéƒ½å®Œæˆäº†ï¼Œç°åœ¨æ•´ä¸ª App å®Œå…¨å˜æˆå“åº”å¼çš„äº†ã€‚Niceï¼</p>
<p>å¦‚æœå‰é¢æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¯ä»¥ä¸‹è½½æœ€ç»ˆçš„ä»£ç ï¼š<strong><a href="https://koenig-media.raywenderlich.com/uploads/2014/01/ReactivePlayground-Final.zip" target="_blank" rel="noopener">final project</a></strong>ï¼Œæˆ–è€…ç›´æ¥ä» <a href="https://github.com/ColinEberhardt/RWReactivePlayground" target="_blank" rel="noopener">GitHub</a> æ‹‰å–ï¼Œæ¯ä¸€ä¸ª commit éƒ½å¯¹åº”ç€å‰é¢çš„ä¸€ä¸ªæ­¥éª¤ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>å½“æŸäº›å¼‚æ­¥ä»»åŠ¡è¿›è¡Œæ—¶ç¦æ‰ button çš„ç‚¹å‡»æ˜¯ä¸€ä¸ªæ™®éåŠŸèƒ½ï¼ŒRAC æä¾›äº† RACCommand æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰å…´è¶£å¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚</p>
</blockquote>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>å¸Œæœ›è¿™ç¯‡æ•™ç¨‹ä¸ºä½ åœ¨è‡ªå·±çš„åº”ç”¨ä¸­ä½¿ç”¨ RAC æ‰“ä¸‹äº†ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€ã€‚ç†Ÿæ‚‰è¿™äº›æ¦‚å¿µéœ€è¦ä¸€å®šçš„è”ç³»ï¼Œä½†æ˜¯å’Œå­¦ä¹ è¯­è¨€æˆ–è€…ç¼–ç¨‹ä¸€æ ·ï¼Œä¸€æ—¦ä½ é€‚åº”äº†ï¼Œä¸€åˆ‡å°±å˜å¾—å¾ˆç®€å•ã€‚RAC çš„æ ¸å¿ƒå°±æ˜¯ä¿¡å·ï¼Œå³äº‹ä»¶æµï¼Œè¿˜æœ‰ä»€ä¹ˆæ¯”è¿™æ›´ç®€å•çš„å‘¢ï¼Ÿ</p>
<p>ä½¿ç”¨ RAC è®©æˆ‘è§‰å¾—æœ‰è¶£çš„ä¸€ç‚¹æ˜¯è§£å†³åŒä¸€ä¸ªé—®é¢˜æœ‰æ— æ•°ç§è§£å†³æ–¹æ¡ˆï¼Œä½ å¯ä»¥ç€ç”¨è¿™ä¸ªç¤ºä¾‹åº”ç”¨è¿›è¡Œæ›´å¤šçš„æ¢ç´¢ï¼Œè®©ä¿¡å·å’Œç®¡é“ä»¥åˆ«çš„æ–¹å¼è¿›è¡Œåˆ†å‰²å’Œç»„åˆã€‚</p>
<p>ä½¿ç”¨ RAC çš„ç›®çš„æ˜¯è®©ä»£ç æ›´åŠ æ•´æ´ï¼Œæ›´æ˜“ç†è§£ï¼Œè®°ä½è¿™ä¸ªéå¸¸æœ‰å¿…è¦ã€‚ä¸ªäººè§‚ç‚¹æ˜¯å°†åº”ç”¨çš„é€»è¾‘ä½¿ç”¨é“¾å¼è¯­æ³•è¡¨è¾¾ä¸ºæ¸…æ™°çš„ç®¡é“ç¡®å®è®©ç†è§£å˜å¾—æ›´ä¸ºç®€å•ã€‚</p>
<p>åœ¨æœ¬æ•™ç¨‹çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä½ ä¼šå­¦ä¹ åˆ°è¯¸å¦‚é”™è¯¯å¤„ç†ã€å¦‚ä½•ç®¡ç†ä¸åŒçš„çº¿ç¨‹ç­‰é«˜çº§ä¸»é¢˜ï¼Œç©çš„æ„‰å¿«ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[UIResponder å’Œ UIControl]]></title>
      <url>http://www.timebridge.space/2017/01/11/UIResponder-%E5%92%8C-UIControl/</url>
      <content type="html"><![CDATA[<p>å…ˆæ¥çœ‹ä¸€å¹…å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/view_class_tree.png" width="480" alt="View ç±»ç»§æ‰¿æ ‘"></div>

<p>è¿™å¹…å›¾å±•ç¤ºäº† iOS View ç±»çš„ç»§æ‰¿å…³ç³»ï¼Œå¯ä»¥çœ‹åˆ° UIResponder å’Œ UIControl ä¹‹é—´çš„å…³ç³»ã€‚ä¸ºä»€ä¹ˆè¦æ¯”å¯¹è¿™ä¸¤ä¸ªç±»å‘¢ï¼Ÿä»ç»§æ‰¿å…³ç³»ä¸­å¯ä»¥çœ‹å‡ºï¼š</p>
<ol>
<li>UIResponder çš„ç›´æ¥å­ç±»è¦†ç›–äº†æˆ‘ä»¬å¹³æ—¶ç”¨åˆ°çš„å‡ å¤§é‡è¦ç±»ï¼šUIApplicationï¼ŒUIView å’Œ UIViewControllerï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„ UIView çš„å­ç±» â€”â€” æˆ‘ä»¬å¹³æ—¶ç”¨çš„ View ç»„ä»¶éƒ½æ˜¯ UIResponder çš„å­ç±»ï¼›</li>
<li>UIView çš„å­ç±»åˆ†ä¸ºä¸¤ç»„ï¼Œä¸€ç±»æ˜¯ç›´æ¥å­ç±»ï¼Œä¸€ç±»åˆ™æ˜¯ UIControl çš„å­ç±»ï¼›</li>
</ol>
<p>æ‰€ä»¥ä»ç»§æ‰¿æ ‘ä¸Šçœ‹ï¼Œç ”ç©¶è¿™ä¸¤ä¸ªç±»å¯¹äºç†è§£ iOS çš„ View ç»“æ„æœ‰å¾ˆé‡è¦çš„æ„ä¹‰ã€‚<a id="more"></a></p>
<h2 id="UIResponder"><a href="#UIResponder" class="headerlink" title="UIResponder"></a>UIResponder</h2><p>å®˜ç½‘æè¿°ï¼š</p>
<blockquote>
<p>The <code>UIResponder</code> class defines an interface for objects that respond to and handle events. It is the superclass of <code>UIApplication</code>, <code>UIView</code> and its subclasses (which include <code>UIWindow</code>). Instances of these classes are sometimes referred to as responder objects or, simply, responders.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªç±»ä¸º <strong>å“åº”å’Œå¤„ç†äº‹ä»¶</strong> å®šä¹‰äº†ç›¸å…³æ¥å£ï¼Œé€šå¸¸ç»§æ‰¿è¿™ä¸ªç±»çš„å­ç±»è¢«ç§°ä¸º <strong>å“åº”è€…</strong>ã€‚UIResponder çš„ <a href="https://developer.apple.com/reference/uikit/uiresponder" target="_blank" rel="noopener">API</a> å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p>
<ol>
<li>å…³äº FirstResponderï¼›</li>
<li>touch äº‹ä»¶ï¼›</li>
<li>press äº‹ä»¶ï¼›</li>
<li>motion äº‹ä»¶ï¼›</li>
<li>remote äº‹ä»¶ï¼›</li>
</ol>
<p>touch äº‹ä»¶å³è§¦æ‘¸äº‹ä»¶ï¼Œpress äº‹ä»¶æ˜¯ç”±ç‰©ç†é”®è§¦å‘çš„ï¼Œæ¯”å¦‚æ‰‹æœºé¥æ§å™¨ï¼Œmotion äº‹ä»¶ç®€å•ç¿»è¯‘è¿‡æ¥æ˜¯æ‰‹åŠ¿äº‹ä»¶ï¼Œæ¯”å¦‚æ‘‡åŠ¨è®¾å¤‡ï¼Œremote äº‹ä»¶æ˜¯è¿œç¨‹æ§åˆ¶äº‹ä»¶ï¼Œæ¯”å¦‚è€³æœºã€‚</p>
<blockquote>
<p>å…³äºäº‹ä»¶ï¼Œå¯ä»¥é˜…è¯»ï¼š<a href="https://developer.apple.com/library/content/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009541" target="_blank" rel="noopener">Event Handling Guide for iOS</a>ã€‚</p>
</blockquote>
<h2 id="UIControl"><a href="#UIControl" class="headerlink" title="UIControl"></a>UIControl</h2><p>å®˜ç½‘æè¿°ï¼š</p>
<blockquote>
<p>The <code>UIControl</code> class implements common behavior for visual elements that convey a specific action or intention in response to user interactions. Controls implement elements such as buttons and sliders, which your app might use to facilitate navigation, gather user input, or manipulate content. Controls use the <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/Devpedia-CocoaApp/TargetAction.html#//apple_ref/doc/uid/TP40009071-CH3" target="_blank" rel="noopener">Target-Action</a> mechanism to report user interactions to your app.</p>
</blockquote>
<p>UIControl ä½¿ç”¨ Target-Action æœºåˆ¶æ¥å‘ŠçŸ¥ App ç”¨æˆ·çš„äº¤äº’ï¼Œå¹¶æŠŠè¿™ç§äº¤äº’æŠ½è±¡æˆä¸€äº›é€šç”¨çš„è¡Œä¸ºï¼Œæ¯”å¦‚<code>UIControlEventTouchUpInside</code>ã€‚ä¸º UIButton æ·»åŠ è¿‡ç›‘å¬çš„ç«¥é‹åº”è¯¥å¾ˆå®¹æ˜“ç†è§£ã€‚</p>
<blockquote>
<p>Target-Action æœºåˆ¶å¯å‚è€ƒæ–‡ç« <a href="http://www.cocoachina.com/ios/20160111/14932.html" target="_blank" rel="noopener">UIControl çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•å’Œ Target-Action æœºåˆ¶</a>ã€‚</p>
<p>åœ¨æˆ‘çœ‹æ¥å’Œ Java ä¸­çš„å›è°ƒç›‘å¬ä¸€æ ·ï¼Œåªä¸è¿‡ Java ä¸­å¹¶æ²¡æœ‰ SEL è¿™æ ·çš„æ¦‚å¿µï¼Œè€Œ iOS ä¸­éœ€è¦ Target å’Œ Action æ‰èƒ½æŒ‡å®šæ‰§è¡ŒæŸä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•ï¼Œä¸¤è€…ç†å¿µä¸Šåº”è¯¥æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚</p>
</blockquote>
<p>ç®€å•æŸ¥çœ‹ä¸€ä¸‹ UIControl çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¯ä»¥çœ‹å‡º UIControl æ˜¯åœ¨äº‹ä»¶çš„åŸºç¡€ä¸Šå°è£…å‡ºæ¥ä¸€äº›é«˜çº§æ¦‚å¿µï¼Œä»¥ä¾¿äºå¼€å‘è€…æ›´å®¹æ˜“çš„ç›¸åº”ç”¨æˆ·çš„äº¤äº’è¡Œä¸ºï¼Œæ¯”å¦‚ï¼šé€šè¿‡æ·»åŠ  Target æ¥ç›¸åº” <code>UIControlEventTouchUpInside</code> åŠ¨ä½œï¼Œè€Œè¿™ä¸ªåŠ¨ä½œåœ¨ iOS ä¸Šçš„å…¸å‹ä»£è¡¨å°±æ˜¯ä¸€æ¬¡ UIButton çš„ç‚¹å‡»è¿‡ç¨‹ï¼Œæ‹†åˆ†æˆäº‹ä»¶å°±æ˜¯ TouchBegin -&gt; TouchMove -&gt;â€¦-&gt; TouchMove -&gt; TouchEndï¼Œè¿˜æœ‰å¯¹ selectedã€highlighted ç­‰å±æ€§çš„å®šä¹‰ï¼Œéƒ½æ˜¯æ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯å®šä¹‰ä¸€äº›é€šç”¨çš„ç”¨æˆ·è¡Œä¸ºæ¨¡å¼ï¼Œç„¶ååœ¨ UIControl ä¸ºè¿™äº›æ¨¡å¼æä¾›ç›¸åº”å…¥å£ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç‚¹æ˜¯ä¸‹é¢ä¸¤ç»„æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// UIResponder</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br><span class="line">- (void)touchesMoved:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br><span class="line">- (void)touchesEnded:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br><span class="line">- (void)touchesCancelled:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br><span class="line"></span><br><span class="line">// UIControl</span><br><span class="line">- (BOOL)beginTrackingWithTouch:(UITouch *)touch withEvent:(nullable UIEvent *)event;</span><br><span class="line">- (BOOL)continueTrackingWithTouch:(UITouch *)touch withEvent:(nullable UIEvent *)event;</span><br><span class="line">- (void)endTrackingWithTouch:(nullable UITouch *)touch withEvent:(nullable UIEvent *)event; // touch is sometimes nil if cancelTracking calls through to this.</span><br><span class="line">- (void)cancelTrackingWithEvent:(nullable UIEvent *)event;   // event may be nil if cancelled for non-event reasons, e.g. removed from window</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ç»„æ¥å£éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯å‚æ•°ä¸Šå´åˆç•¥å¾®çš„ä¸åŒï¼šUIResponder ç»„å¾—åˆ°çš„æ˜¯ä¸€ä¸ª UITouch é›†åˆï¼Œè€Œ UIControl å¾—åˆ°çš„å´æ˜¯å•ä¸ªçš„ UITouchï¼Œç®€å•çŒœæµ‹æ˜¯å› ä¸ºåˆ¤æ–­ç”¨æˆ·è¡Œä¸ºæ¨¡å¼å¹¶ä¸éœ€è¦åŒæ—¶ç›‘æ§å¤šä¸ª UITouch å˜é‡ï¼Œå¤§å¤šæ•°çš„ UIControlEvents å®šä¹‰çš„ç”¨æˆ·è¡Œä¸ºæ¨¡å¼åªéœ€è¦ä¸€ä¸ª UITouch å³å¯åˆ¤æ–­ã€‚</p>
<blockquote>
<p>è¿™ä¸ªçŒœæµ‹å— Android ç³»ç»Ÿå½±å“ï¼Œå¯è§æ–‡ç« <a href="http://timebridge.space/2016/09/04/Android-touchevent-process/" target="_blank" rel="noopener">Android Viewäº‹ä»¶å¤„ç†</a>ã€‚</p>
<p>å…³äºè¿™ä¸¤ç»„ API çš„è¯¦ç»†æƒ…å†µï¼Œå¯ä»¥å‚è€ƒ <a href="http://www.cnblogs.com/machao/p/5471094.html" target="_blank" rel="noopener">å²ä¸Šæœ€è¯¦ç»†çš„iOSä¹‹äº‹ä»¶çš„ä¼ é€’å’Œå“åº”æœºåˆ¶</a>ã€‚</p>
</blockquote>
<h2 id="ä¸¤è€…çš„åŒºåˆ«å’Œè”ç³»"><a href="#ä¸¤è€…çš„åŒºåˆ«å’Œè”ç³»" class="headerlink" title="ä¸¤è€…çš„åŒºåˆ«å’Œè”ç³»"></a>ä¸¤è€…çš„åŒºåˆ«å’Œè”ç³»</h2><p>åŒºåˆ«å‰é¢å·²æœ‰è®ºè¿°ï¼Œæ€»ç»“æ¥è¯´ï¼š<strong>UIResponder ç±»è¡¨æ˜ä¸€ä¸ªç»„ä»¶æ˜¯å¯ä»¥æ¥å—äº‹ä»¶çš„ï¼Œå®ƒå®šä¹‰çš„æ–¹æ³•å¯ä»¥è·å¾—ä¸€ä¸ªç»„ä»¶æœ€åŸå§‹çš„äº‹ä»¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤šç‚¹è§¦æ§ç­‰ç­‰ï¼›UIControl åˆ™é€šè¿‡è¿™äº›äº‹ä»¶æŠ½è±¡å‡ºç”¨æˆ·çš„è¡Œä¸ºï¼Œæ¯”å¦‚ç‚¹å‡»äº‹ä»¶ï¼Œæ‹–æ›³äº‹ä»¶ï¼Œå¹¶é€šè¿‡ Target-Action æœºåˆ¶è®©å¼€å‘è€…å¯ä»¥æ–¹ä¾¿çš„ç›‘å¬è¿™äº›è¡Œä¸ºçš„å‘ç”Ÿã€‚</strong></p>
<p>è€Œä¸ºäº†ç ”ç©¶ä¸¤è€…ä¹‹é—´çš„è”ç³»ï¼Œæˆ‘é‡è½½äº†ä¸Šé¢æåˆ°çš„ä¸¤ç»„æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@interface XYButton ()</span><br><span class="line">-(void)printTouchInfo:(UITouch *)touch withTag:(NSString *)tag;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation XYButton</span><br><span class="line"></span><br><span class="line">// UIControl</span><br><span class="line">- (BOOL)beginTrackingWithTouch:(UITouch *)touch withEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:touch withTag:@&quot;UIControl-Begin&quot;];</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)continueTrackingWithTouch:(UITouch *)touch withEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:touch withTag:@&quot;UIControl-Move&quot;];</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)endTrackingWithTouch:(nullable UITouch *)touch withEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:touch withTag:@&quot;UIControl-End&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)cancelTrackingWithEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:[[event.allTouches allObjects] objectAtIndex:0] withTag:@&quot;UIControl-End&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// UIResponder</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:[[touches allObjects] objectAtIndex:0] withTag:@&quot;UIResponder-Begin&quot;];</span><br><span class="line">    [super touchesBegan:touches withEvent:event];</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesMoved:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:[[touches allObjects] objectAtIndex:0] withTag:@&quot;UIResponder-Move&quot;];</span><br><span class="line">    [super touchesMoved:touches withEvent:event];</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesEnded:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:[[touches allObjects] objectAtIndex:0] withTag:@&quot;UIResponder-End&quot;];</span><br><span class="line">    [super touchesEnded:touches withEvent:event];</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesCancelled:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event &#123;</span><br><span class="line">    [self printTouchInfo:[[touches allObjects] objectAtIndex:0] withTag:@&quot;UIResponder-Cancel&quot;];</span><br><span class="line">    [super touchesCancelled:touches withEvent:event];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)printTouchInfo:(UITouch *)touch withTag:(NSString *)tag &#123;</span><br><span class="line">    CGPoint point = [touch locationInView:self];</span><br><span class="line">    NSLog(@&quot;ã€%@ã€‘%f, %f&quot;, tag, point.x, point.y);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å½“è¿™ä¸ª UIButton æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šçš„æ—¶å€™ï¼Œæˆ‘åœ¨ Button ä¸Šæ‹–åŠ¨é¼ æ ‡ï¼ˆç‚¹å‡»ä½ç½®ï¼‰ï¼Œè¾“å‡ºçš„ Log å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">2017-01-11 17:55:25.079 MyP[37537:3413743] ã€UIResponder-Beginã€‘119.000000, 121.000000</span><br><span class="line">2017-01-11 17:55:25.080 MyP[37537:3413743] ã€UIControl-Beginã€‘119.000000, 121.000000</span><br><span class="line">2017-01-11 17:55:25.123 MyP[37537:3413743] ã€UIResponder-Moveã€‘119.000000, 123.666656</span><br><span class="line">2017-01-11 17:55:25.123 MyP[37537:3413743] ã€UIControl-Moveã€‘119.000000, 123.666656</span><br><span class="line">2017-01-11 17:55:25.142 MyP[37537:3413743] ã€UIResponder-Moveã€‘121.000000, 135.333328</span><br><span class="line">2017-01-11 17:55:25.143 MyP[37537:3413743] ã€UIControl-Moveã€‘121.000000, 135.333328</span><br><span class="line">2017-01-11 17:55:25.175 MyP[37537:3413743] ã€UIResponder-Moveã€‘136.000000, 221.333328</span><br><span class="line">2017-01-11 17:55:25.176 MyP[37537:3413743] ã€UIControl-Moveã€‘136.000000, 221.333328</span><br><span class="line">2017-01-11 17:55:25.192 MyP[37537:3413743] ã€UIResponder-Moveã€‘147.666656, 291.666656</span><br><span class="line">2017-01-11 17:55:25.193 MyP[37537:3413743] ã€UIControl-Moveã€‘147.666656, 291.666656</span><br><span class="line">2017-01-11 17:55:25.209 MyP[37537:3413743] ã€UIResponder-Moveã€‘159.666656, 352.666656</span><br><span class="line">2017-01-11 17:55:25.210 MyP[37537:3413743] ã€UIControl-Moveã€‘159.666656, 352.666656</span><br><span class="line">2017-01-11 17:55:25.226 MyP[37537:3413743] ã€UIResponder-Moveã€‘164.666656, 392.333328</span><br><span class="line">2017-01-11 17:55:25.226 MyP[37537:3413743] ã€UIControl-Moveã€‘164.666656, 392.333328</span><br><span class="line">2017-01-11 17:55:25.243 MyP[37537:3413743] ã€UIResponder-Moveã€‘168.666656, 424.000000</span><br><span class="line">2017-01-11 17:55:25.244 MyP[37537:3413743] ã€UIControl-Moveã€‘168.666656, 424.000000</span><br><span class="line">2017-01-11 17:55:25.260 MyP[37537:3413743] ã€UIResponder-Moveã€‘170.666656, 445.666656</span><br><span class="line">2017-01-11 17:55:25.260 MyP[37537:3413743] ã€UIControl-Moveã€‘170.666656, 445.666656</span><br><span class="line">2017-01-11 17:55:25.277 MyP[37537:3413743] ã€UIResponder-Moveã€‘170.666656, 455.666656</span><br><span class="line">2017-01-11 17:55:25.277 MyP[37537:3413743] ã€UIControl-Moveã€‘170.666656, 455.666656</span><br><span class="line">2017-01-11 17:55:25.294 MyP[37537:3413743] ã€UIResponder-Moveã€‘170.666656, 460.666656</span><br><span class="line">2017-01-11 17:55:25.294 MyP[37537:3413743] ã€UIControl-Moveã€‘170.666656, 460.666656</span><br><span class="line">2017-01-11 17:55:25.348 MyP[37537:3413743] ã€UIResponder-Endã€‘170.666656, 460.666656</span><br><span class="line">2017-01-11 17:55:25.348 MyP[37537:3413743] ã€UIControl-Endã€‘170.666656, 460.666656</span><br><span class="line">2017-01-11 17:55:26.431 MyP[37537:3413743] ã€UIResponder-Beginã€‘128.000000, 154.666656</span><br><span class="line">2017-01-11 17:55:26.431 MyP[37537:3413743] ã€UIControl-Beginã€‘128.000000, 154.666656</span><br><span class="line">2017-01-11 17:55:26.450 MyP[37537:3413743] ã€UIResponder-Moveã€‘128.000000, 157.666656</span><br><span class="line">2017-01-11 17:55:26.450 MyP[37537:3413743] ã€UIControl-Moveã€‘128.000000, 157.666656</span><br><span class="line">2017-01-11 17:55:26.467 MyP[37537:3413743] ã€UIResponder-Moveã€‘128.000000, 163.333328</span><br><span class="line">2017-01-11 17:55:26.468 MyP[37537:3413743] ã€UIControl-Moveã€‘128.000000, 163.333328</span><br><span class="line">2017-01-11 17:55:26.484 MyP[37537:3413743] ã€UIResponder-Moveã€‘129.000000, 174.333328</span><br><span class="line">2017-01-11 17:55:26.484 MyP[37537:3413743] ã€UIControl-Moveã€‘129.000000, 174.333328</span><br><span class="line">2017-01-11 17:55:26.501 MyP[37537:3413743] ã€UIResponder-Moveã€‘131.000000, 200.000000</span><br><span class="line">2017-01-11 17:55:26.501 MyP[37537:3413743] ã€UIControl-Moveã€‘131.000000, 200.000000</span><br><span class="line">2017-01-11 17:55:26.518 MyP[37537:3413743] ã€UIResponder-Moveã€‘135.000000, 235.666656</span><br><span class="line">2017-01-11 17:55:26.518 MyP[37537:3413743] ã€UIControl-Moveã€‘135.000000, 235.666656</span><br><span class="line">2017-01-11 17:55:26.534 MyP[37537:3413743] ã€UIResponder-Moveã€‘139.000000, 277.000000</span><br><span class="line">2017-01-11 17:55:26.535 MyP[37537:3413743] ã€UIControl-Moveã€‘139.000000, 277.000000</span><br><span class="line">2017-01-11 17:55:26.551 MyP[37537:3413743] ã€UIResponder-Moveã€‘141.000000, 300.666656</span><br><span class="line">2017-01-11 17:55:26.551 MyP[37537:3413743] ã€UIControl-Moveã€‘141.000000, 300.666656</span><br><span class="line">2017-01-11 17:55:26.568 MyP[37537:3413743] ã€UIResponder-Moveã€‘141.000000, 325.333328</span><br><span class="line">2017-01-11 17:55:26.709 MyP[37537:3413743] ã€UIResponder-Endã€‘141.000000, 346.333328</span><br><span class="line">2017-01-11 17:55:26.710 MyP[37537:3413743] ã€UIControl-Endã€‘141.000000, 346.333328</span><br></pre></td></tr></table></figure>
<p>åœ¨å•æŒ‡æƒ…å†µä¸‹ï¼Œå¯ä»¥çœ‹åˆ° UIResponder æ–¹æ³•çš„ UITouch é›†åˆçš„ç¬¬ä¸€ä¸ª UITouch å¯¹è±¡è®°å½•çš„ä¿¡æ¯å’Œ UIControl æ–¹æ³•çš„ UITouch å¯¹è±¡è®°å½•çš„ä¿¡æ¯å®Œå…¨ä¸€è‡´ï¼Œä¸”äº‹ä»¶ç±»å‹ä¹Ÿä¸€ä¸€å¯¹åº”ï¼ŒåŸºæœ¬å°è¯äº†å‰é¢çš„çŒœæµ‹ã€‚</p>
<blockquote>
<p>å¤šæŒ‡æƒ…å†µä¸‹å¾…éªŒè¯ã€‚</p>
</blockquote>
<p>è¿™ä¸€ç‚¹è®¾è®¡å’Œ Android å¾ˆä¸ä¸€æ ·ï¼ŒAndroid çš„è§¦æ‘¸ä»¥åŠäº‹ä»¶ç›‘å¬æ˜¯ View æä¾›çš„ç‰¹æ€§ï¼Œæ‰€æœ‰ View éƒ½æœ‰ä¸€è‡´çš„äº‹ä»¶ç›‘å¬æ·»åŠ æ–¹æ³•ï¼Œå¹¶ä¸åƒ iOS è¿™æ ·åšäº†åˆ’åˆ†ï¼Œä»¥è‡³åƒ UILabel è¿™æ ·çš„ç»„ä»¶æ— æ³•åƒ UIButton ä¸€æ ·æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java æ³¨é‡Š]]></title>
      <url>http://www.timebridge.space/2016/12/22/Java-%E6%B3%A8%E9%87%8A/</url>
      <content type="html"><![CDATA[<p>ç®—èµ·æ¥è‡ªå·±æ­£å„¿å…«ç»å†™ Java ä»£ç ä¹Ÿæœ‰ä¸¤å¹´å¤šäº†ï¼Œæ¯æ¯çœ‹åˆ° Android Framework å’Œæˆç†Ÿå¼€æºé¡¹ç›®çš„ä»£ç ï¼Œéƒ½æœ‰ä¸€ç§é«˜å¤§ä¸Šçš„æ°”æ¯æ²¹ç„¶è€Œç”Ÿã€‚è¿™äº›ä»£ç é™¤äº†æœ¬èº«å†™çš„å¥½ï¼Œæ³¨é‡Šé€šå¸¸ä¹Ÿéå¸¸å®Œå–„ã€‚è€Œå¹³æ—¥é‡Œæ¥è§¦åˆ°çš„å…¬å¸ä»£ç ä»¥åŠè‡ªå·±å†™çš„ä»£ç éƒ½ä¸æ˜¯éå¸¸æ³¨æ„æ³¨é‡Šè¿™å—å„¿ï¼Œå†™çš„éå¸¸éšæ„ç”šè‡³ä¸å†™ã€‚</p>
<blockquote>
<p>å› æ­¤å¾€å¾€é€šè¿‡æ³¨é‡Šå°±èƒ½åŒºåˆ«ä»£ç æ˜¯æ¥è‡ªå¼€æºé¡¹ç›®è¿˜æ˜¯å…¬å¸å†…éƒ¨è‡ªå·±å†™çš„ã€‚T T</p>
</blockquote>
<p>å…¶å® Java åœ¨å…³äºä»£ç æ³¨é‡Šçš„å†™æ³•è¿™å—ï¼Œæ˜¯æœ‰æ¯”è¾ƒå®Œå–„çš„è§„èŒƒçš„ï¼š<a href="http://www.oracle.com/technetwork/articles/java/index-137868.html" target="_blank" rel="noopener">How to Write Doc Comments for the Javadoc Tool</a>ã€‚<a id="more"></a></p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>é€šå¸¸æˆ‘ä»¬åœ¨å­¦ä¹ ä¸€ä¸ª ç³»ç»Ÿ/SDK çš„æ—¶å€™ä¼šé‡åˆ°ä¸¤ç±»æ–‡æ¡£ï¼šAPIæ–‡æ¡£ &amp; å¼€å‘æŒ‡å¯¼æ–‡æ¡£ï¼Œæœ‰çš„ ç³»ç»Ÿ/SDK ä¼šæŠŠä¸¤ç±»æ–‡æ¡£æ··æˆä¸€ä¸ªï¼Œä½†æ˜¯å®˜æ–¹å¹¶ä¸å»ºè®®è¿™ä¹ˆåšã€‚</p>
<p>API æ–‡æ¡£é€šå¸¸æ˜¯ç”± Javadoc ä»ä»£ç æ³¨é‡Šç”Ÿæˆï¼Œå®ƒæ‰€åº”è¯¥æ ‡æ³¨çš„åº”å½“æ˜¯ä¸å¹³å°æ— å…³ã€å®ç°æ— å…³çš„å…³äºè¿™ä¸ªæ–¹æ³•/ç±»/å±æ€§çš„å£°æ˜ï¼Œä»¥è¾¾åˆ° Java çš„ â€œwrite once, run anywhereâ€ çš„ç›®æ ‡ï¼›åº”å½“æ˜¯è°ƒç”¨è€…å’Œå®ç°è€…ä¹‹é—´çš„ä¸€ä¸ªåè®®ã€‚</p>
<p>å¼€å‘æŒ‡å¯¼æ–‡æ¡£ä¸€èˆ¬åŒ…æ‹¬ç¤ºä¾‹ã€å¼€å‘æœ¯è¯­å®šä¹‰ã€æ¦‚å¿µè§£é‡Šå’Œå­˜åœ¨çš„Bugã€ä½¿ç”¨ç¯å¢ƒã€‚æ¯«æ— ç–‘é—®è¿™äº›æè¿°ä¹Ÿæœ‰åŠ©äºå¼€å‘è€…ç†è§£å’Œä½¿ç”¨ ç³»ç»Ÿ/SDKï¼Œä½†å®ƒå¹¶ä¸æ˜¯æ¥å£å£°æ˜ï¼Œè€Œæ˜¯æ ¹æ®æ¥å£å£°æ˜è¿›è¡Œçš„å…·ä½“å®ç°ï¼Œåœ¨æ¥å£æ–‡æ¡£ä¸­ä¸æ˜¯å¿…é¡»çš„ã€‚Java æœ¬èº«å°±å°† API æ–‡æ¡£å’Œå¼€å‘æŒ‡å¯¼æ–‡æ¡£åˆ†å¼€ç»´æŠ¤â€”â€”JDK æ–‡æ¡£åŒ…ä¸­åŒ…å« API æ–‡æ¡£ä»¥åŠç¤ºä¾‹ä»£ç å’Œå¼€å‘æŒ‡å¯¼æ–‡æ¡£ï¼Œé€šè¿‡é“¾æ¥æ¥å…³è”ä¸¤è€…ã€‚</p>
<h2 id="æ ‡å‡†å†™æ³•"><a href="#æ ‡å‡†å†™æ³•" class="headerlink" title="æ ‡å‡†å†™æ³•"></a>æ ‡å‡†å†™æ³•</h2><p>æ–‡æ¡£æ³¨é‡Šå¿…é¡»åœ¨ç±»/å±æ€§/æ–¹æ³•å‰é¢ä½¿ç”¨ HTML æ ¼å¼ä¹¦å†™ï¼ˆä»£ç çš„ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥å†™æ³¨é‡Šï¼Œä½†æ˜¯åªæœ‰è¿™äº›åœ°æ–¹çš„æ³¨é‡Šä¼šè¢«ç”Ÿæˆåˆ° API æ–‡æ¡£ä¸­ï¼‰ï¼Œæ ‡å‡†æ ¼å¼åŒ…æ‹¬ä¸¤å—ï¼šæè¿°å— + æ ‡è®°å—ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns an Image object that can then be painted on the screen. </span></span><br><span class="line"><span class="comment"> * The url argument must specify an absolute &#123;<span class="doctag">@link</span> URL&#125;. The name</span></span><br><span class="line"><span class="comment"> * argument is a specifier that is relative to the url argument. </span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This method always returns immediately, whether or not the </span></span><br><span class="line"><span class="comment"> * image exists. When this applet attempts to draw the image on</span></span><br><span class="line"><span class="comment"> * the screen, the data will be loaded. The graphics primitives </span></span><br><span class="line"><span class="comment"> * that draw the image will incrementally paint on the screen. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  url  an absolute URL giving the base location of the image</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  name the location of the image, relative to the url argument</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>      the image at the specified URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span>         Image</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Image <span class="title">getImage</span><span class="params">(URL url, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getImage(<span class="keyword">new</span> URL(url, name));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>å‰é¢çš„ä¸¤æ®µæ–‡å­—å°±æ˜¯æè¿°å—ï¼Œåé¢å››è¡Œä»¥<code>@</code>å¼€å¤´çš„å°±ç§°ä¸ºæ ‡è®°å—ã€‚ç”Ÿæˆçš„ API æ–‡æ¡£å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/APIæ–‡æ¡£ç¤ºä¾‹.png" alt="APIæ–‡æ¡£ç¤ºä¾‹"></div>

<h3 id="åŸºæœ¬è§„èŒƒ"><a href="#åŸºæœ¬è§„èŒƒ" class="headerlink" title="åŸºæœ¬è§„èŒƒ"></a>åŸºæœ¬è§„èŒƒ</h3><p>æ¯”ç…§ä¸Šé¢çš„ä¾‹å­ï¼Œæ–‡æ¡£æ³¨é‡Šçš„åŸºæœ¬è§„èŒƒå¦‚ä¸‹ï¼š</p>
<ol>
<li>ä½¿ç”¨<code>/** */</code>åŒ…è£¹ï¼›</li>
<li>ä» Javadoc 1.4 å¼€å§‹ï¼Œæ¯ä¸€è¡Œçš„å¼€å¤´ <strong>*</strong> å¯é€‰ï¼ˆä½†æ˜¯ç°åœ¨çš„ IDE åœ¨æ ¼å¼åŒ–çš„æ—¶å€™éƒ½ä¿æŒäº†è¿™ä¸ªä¹ æƒ¯ï¼Œæ³¨é‡Šå› æ­¤çœ‹ä¸Šå»ä¹Ÿæ›´åŠ æ•´é½ï¼‰ï¼›</li>
<li>ç¬¬ä¸€å¥è¯åº”è¯¥æ˜¯æ–¹æ³•çš„æ€»ç»“ï¼ŒJavadoc åœ¨ç”Ÿæˆæ–‡æ¡£çš„æ—¶å€™ä¼šæŠŠè¿™å¥è¯ä½œä¸ºæ–¹æ³•æ€»ç»“å‘ˆç°åœ¨æ–¹æ³•æ¦‚è¦åˆ—è¡¨é‡Œé¢ï¼›</li>
<li>å¦‚æœæ³¨é‡Šæè¿°ä¸æ­¢ä¸€æ®µï¼Œæ¯ä¸€æ®µä¹‹é—´éœ€è¦åŠ ä¸Š<code>&lt;p&gt;</code>æ ‡è®°ç¬¦ï¼›</li>
<li>å½“é‡åˆ°ç¬¬ä¸€ä¸ªä»¥<code>@</code>å­—ç¬¦å¼€å¤´çš„è¡Œçš„æ—¶å€™ï¼Œå°±æ„å‘³ç€æè¿°å—çš„ç»“æŸï¼›</li>
</ol>
<h3 id="ç»†èŠ‚æŠ€å·§"><a href="#ç»†èŠ‚æŠ€å·§" class="headerlink" title="ç»†èŠ‚æŠ€å·§"></a>ç»†èŠ‚æŠ€å·§</h3><h4 id="ç¬¬ä¸€å¥æè¿°"><a href="#ç¬¬ä¸€å¥æè¿°" class="headerlink" title="ç¬¬ä¸€å¥æè¿°"></a>ç¬¬ä¸€å¥æè¿°</h4><p>ç¬¬ä¸€å¥æè¿°ä¼šè¢«ä½œä¸ºæ€»ç»“å‘ˆç°åœ¨ API æ–‡æ¡£é€‚å½“çš„åœ°æ–¹ï¼Œä¾‹å­ä¸­å±•ç¤ºçš„æ˜¯æ–¹æ³•ï¼Œä½†å¯¹äºç±»ã€å±æ€§ã€æ¥å£ä»¥åŠåŒ…éƒ½æ˜¯é€‚ç”¨çš„ã€‚ç¬¬ä¸€å¥è¯é€šå¸¸ä»¥ blankï¼Œtabï¼Œæ¢è¡Œç¬¦æˆ–è€…æ˜¯ç¬¬ä¸€ä¸ªæ ‡è®°å—ç»“æŸã€‚</p>
<blockquote>
<p>99%çš„æƒ…å†µéƒ½æ˜¯ä¸€ä¸ªæ­£å¸¸çš„è‹±æ–‡å¥å­ï¼Œåœ¨ä¸­æ–‡ä¸­ï¼Œä»¥å¥å·å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚å…»æˆä¹ æƒ¯ï¼Œç¬¬ä¸€å¥å†™ä¸€ä¸ªæ€»ç»“å¥å³å¯ã€‚</p>
</blockquote>
<h4 id="å®ç°æ— å…³"><a href="#å®ç°æ— å…³" class="headerlink" title="å®ç°æ— å…³"></a>å®ç°æ— å…³</h4><p>å†™ API æ³¨é‡Šçš„æ—¶å€™ï¼Œå®˜æ–¹å®¶å»ºè®®åº”å½“å°½é‡ä¸å®ç°æ— å…³ã€‚å®é™…ç”Ÿäº§ä¸­ï¼Œåƒ Android ç¡®å®æœ‰éƒ¨åˆ†ä»£ç æ˜¯å’Œ J2EE æœåŠ¡ç«¯å…¬ç”¨çš„ï¼Œä¹Ÿæœ‰ä»£ç ä¼šæœ‰å¤šä»½å®ç°ï¼Œå› æ­¤è¿™ä¸€ç‚¹éœ€è¦å¤šåŠ æ³¨æ„ï¼š<strong>æ³¨é‡Šå¿…é¡»ç¡®ä¿æœ‰è¶³å¤Ÿçš„ä¿¡æ¯ä¿è¯å®ç°çš„ä¸€è‡´ï¼Œä¿è¯èƒ½å¤Ÿå†™å‡ºä¸€è‡´çš„æµ‹è¯• caseï¼ŒåŒ…æ‹¬è¾¹ç•Œæ¡ä»¶ï¼Œå‚æ•°èŒƒå›´ï¼Œè¾¹ç•Œ case ç­‰ï¼Œè¯´æ˜æ¸…æ¥šå“ªäº›ç»†èŠ‚å¯ä»¥è‡ªç”±å®ç°</strong>ã€‚</p>
<blockquote>
<p>è¿™ä¸€ç‚¹å¾ˆåƒ Java è™šæ‹Ÿæœºè§„èŒƒï¼Œåˆ—å‡ºäº†å®ç°çš„å¾ˆå¤šå‚æ•°å’Œè¦æ±‚ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ–¹é¢æœªæœ‰æ¶‰åŠï¼Œç”±å®ç°è€…è‡ªè¡Œå†³å®šã€‚</p>
</blockquote>
<p>å¦‚æœå¿…é¡»å†™æ˜ä¸€äº›å®ç°ç›¸å…³çš„è¡Œä¸ºï¼Œå»ºè®®å¯ä»¥å¦å¼€ä¸€ä¸ªæ®µè½ï¼Œå¹¶ä»¥æ¸…æ™°çš„å¼€å¤´è¡¨æ˜æ¥ä¸‹å»çš„æè¿°æ˜¯å®ç°ç›¸å…³çš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<blockquote>
<p>On Windows systems, the path search behavior of the <code>loadLibrary</code> method is identical to that of the Windows APIâ€™s <code>LoadLibrary</code> procedure.</p>
</blockquote>
<p>è¿™æ®µæ³¨é‡Šå°±æ¸…æ™°çš„è¡¨æ˜å®ƒæè¿°çš„æ˜¯ Windows å¹³å°ç›¸å…³çš„å†…å®¹ã€‚</p>
<h4 id="æ–¹æ³•æ³¨é‡Šçš„è‡ªåŠ¨å¤ç”¨"><a href="#æ–¹æ³•æ³¨é‡Šçš„è‡ªåŠ¨å¤ç”¨" class="headerlink" title="æ–¹æ³•æ³¨é‡Šçš„è‡ªåŠ¨å¤ç”¨"></a>æ–¹æ³•æ³¨é‡Šçš„è‡ªåŠ¨å¤ç”¨</h4><p>æœ‰ä¸‰ç§æƒ…å†µï¼Œæ–¹æ³•çš„æ³¨é‡Šå¯ä»¥è‡ªåŠ¨ä»åˆ«çš„åœ°æ–¹å¤ç”¨ï¼š</p>
<ol>
<li>å­ç±»è¦†å†™çˆ¶ç±»çš„æ–¹æ³•ï¼›</li>
<li>å­æ¥å£è¦†å†™çˆ¶æ¥å£çš„æ–¹æ³•ï¼›</li>
<li>å­ç±»å®ç°æ¥å£çš„æ–¹æ³•ï¼›</li>
</ol>
<p>è¿™ä¸‰ç§æƒ…å†µä¸‹ï¼Œéƒ½ä¼šè‡ªåŠ¨å¤ç”¨è¢«è¦†å†™/å®ç°æ–¹æ³•çš„æ³¨é‡Šï¼ˆå¦‚æœä½ è‡ªå·±å†™äº†æ³¨é‡Šï¼Œé‚£å°±ä¸ä¼šå¤åˆ¶äº†ï¼Œä½†ä½¿ç”¨<a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/javadoc.html#inheritDoc" target="_blank" rel="noopener"><code>{@inheritDoc}</code></a>å¯ä»¥åšåˆ°ï¼‰ã€‚</p>
<h4 id="å¯¹äºå…³é”®å­—ä»¥åŠåå­—ï¼Œä½¿ç”¨-lt-code-gt"><a href="#å¯¹äºå…³é”®å­—ä»¥åŠåå­—ï¼Œä½¿ç”¨-lt-code-gt" class="headerlink" title="å¯¹äºå…³é”®å­—ä»¥åŠåå­—ï¼Œä½¿ç”¨&lt;code&gt;"></a>å¯¹äºå…³é”®å­—ä»¥åŠåå­—ï¼Œä½¿ç”¨<code>&lt;code&gt;</code></h4><p>å¯¹äºä»¥ä¸‹åœ¨æ³¨é‡Šä¸­å¼•ç”¨åˆ°çš„å­—ç¬¦ä¸²ï¼Œå»ºè®®ä½¿ç”¨<code>&lt;code&gt;</code>åŒ…è£¹ï¼š</p>
<ol>
<li>Java å…³é”®å­—ï¼›</li>
<li>åŒ…ã€ç±»ã€æ–¹æ³•ã€æ¥å£ã€å±æ€§ã€å‚æ•°åå­—ï¼›</li>
<li>ä»£ç ç¤ºä¾‹ï¼›</li>
</ol>
<p>è¿˜æœ‰ä¸€ç§æ›´åŠ ä¼˜é›…çš„å†™æ³•ï¼š<a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/javadoc.html#code" target="_blank" rel="noopener"><code>{@code}</code></a>ã€‚</p>
<blockquote>
<p>å®é™…ä½¿ç”¨æ—¶å‘ç°ç”Ÿæˆçš„æ–‡æ¡£ä¸Šå¹¶æ²¡æœ‰æ˜æ˜¾çš„æ ‡è®°ï¼Œå¯¹äºé•¿ä¸²çš„ä»£ç ä¹Ÿæ²¡æœ‰æ ¼å¼åŒ–ï¼Œä¸è¿‡åœ¨é˜…è¯»æ³¨é‡Šçš„æ—¶å€™æ˜¾å¾—æ›´åŠ æ¸…æ™°ã€‚</p>
</blockquote>
<h4 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h4><p>é™¤äº†ä¸Šè¿°æåˆ°çš„ï¼Œè¿˜æœ‰ä¸€äº›æ³¨æ„ç‚¹ï¼š</p>
<ol>
<li>å¦‚æœä¸€ä¸ªæ–¹æ³•æœ‰å¾ˆå¤šé‡è½½å½¢å¼ï¼Œé‚£ä¹ˆå½“éœ€è¦è¡¨è¾¾ä¸€ä¸ªé€šç”¨å½¢å¼çš„æ—¶å€™ï¼Œä¸€å®šä¸è¦å†æ–¹æ³•ååé¢åŠ ä¸Šæ‹¬å·ï¼Œæ¯”å¦‚<code>add()</code>å’Œ<code>add(int, Object)</code>ï¼Œç›´æ¥ç”¨<code>add</code>ä»£è¡¨è¿™ä¸¤ç§å½¢å¼å³å¯ï¼›</li>
<li>ä½¿ç”¨ç¬¬ä¸‰äººç§°è€Œä¸æ˜¯ç¬¬äºŒäººç§°ï¼›</li>
<li>é€šå¸¸æ–¹æ³•æ˜¯ç”¨æ¥å®ç°ä¸€ä¸ªè¡Œä¸ºçš„ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨åŠ¨è¯å¼€å¤´ï¼ˆçœ‹æ–¹æ³•è€Œå¼‚å§ï¼‰ï¼›</li>
<li>ä½¿ç”¨ this è€Œä¸æ˜¯ the æ¥ä»£æ›¿å½“å‰å¯¹è±¡ï¼›</li>
<li>æ³¨é‡Šä¸è¦åªæ˜¯å¤è¿°æ–¹æ³•åï¼Œè¦æ·»åŠ ä¸€äº›é¢å¤–çš„æè¿°ï¼ˆæœ‰æ—¶å€™è¿™ä¸ªå¾ˆè‰°éš¾ï¼‰ï¼›</li>
</ol>
<h3 id="Tagï¼ˆæ ‡è®°ï¼‰"><a href="#Tagï¼ˆæ ‡è®°ï¼‰" class="headerlink" title="Tagï¼ˆæ ‡è®°ï¼‰"></a>Tagï¼ˆæ ‡è®°ï¼‰</h3><p>Tagï¼Œå°±æ˜¯å‰é¢ä¾‹å­ä¸­çœ‹åˆ°çš„<code>@param</code>ã€<code>@return</code>ã€<code>@see</code>è¿™æ ·çš„æ ‡è®°ï¼Œå®ƒæ˜¯å¤§å°å†™é“­æ„Ÿçš„ï¼Œå¿…é¡»å†™åœ¨æŸä¸€è¡Œçš„å¼€å¤´ï¼ˆå‰é¢å¯ä»¥æœ‰ç©ºæ ¼æˆ–è€…å¯é€‰çš„æ˜Ÿå·ï¼‰ï¼Œå¦åˆ™å°±ä¼šè¢«å½“åšæ™®é€šæ–‡æœ¬å¤„ç†ã€‚</p>
<p><strong>Tag åˆ†ä¸ºä¸¤ç±»ï¼Œå— Tag (Block Tag)å’Œè¡Œå†… Tag(Inline Tag)ã€‚</strong>å‰è€…åªèƒ½å‡ºç°åœ¨æè¿°åé¢çš„ Tag éƒ¨åˆ†ï¼Œå½¢å¼æ˜¯<code>@tag</code>ï¼›åè€…å¯ä»¥å‡ºç°åœ¨æè¿°å—æˆ–è€…å— Tag åé¢çš„æè¿°ä¸­ï¼Œå½¢å¼æ˜¯<code>{@tag}</code>ã€‚ç›®å‰ Tag åŒ…æ‹¬ï¼š<code>@author</code>ï¼Œ<code>{@code}</code>ï¼Œ<code>{@docRoot}</code>ï¼Œ<code>@deprecated</code>ï¼Œ<code>@exception</code>ï¼Œ<code>{@inheritDoc}</code>ï¼Œ<code>{@link}</code>ï¼Œ<code>@{linkplain}</code>ï¼Œ<code>{@literal}</code>ï¼Œ<code>@param</code>ï¼Œ<code>@return</code>ï¼Œ<code>@see</code>ï¼Œ<code>serial</code>ï¼Œ<code>@serialData</code>ï¼Œ<code>@serialField</code>ï¼Œ<code>@since</code>ï¼Œ<code>@throws</code>ï¼Œ<code>{@value}</code>ï¼Œ<code>@version</code>ã€‚</p>
<p>ä¸‹é¢ç®€å•ä»‹ç»ä¸‹ç”¨æ³•ï¼Œè¯¦ç»†å¯è§ <a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/javadoc.html#link" target="_blank" rel="noopener">JAVADOC TAGS</a>ã€‚</p>
<h4 id="autohor-name-text"><a href="#autohor-name-text" class="headerlink" title="@autohor name-text"></a>@autohor name-text</h4><p>å¯ä»¥ä½¿ç”¨å¤šä¸ª<code>@author</code>è¡¨ç¤ºå¤šä¸ªä½œè€…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>,</code>åœ¨ä¸€ä¸ª<code>@author</code>ä¸­åˆ†éš”å¤šä¸ªä½œè€…ã€‚</p>
<h4 id="deprecated-deprecated-text"><a href="#deprecated-deprecated-text" class="headerlink" title="@deprecated deprecated-text"></a>@deprecated deprecated-text</h4><p>deprecated-text ä¼šè¢«ç§»åˆ°æè¿°å—å‰é¢ï¼Œä½¿ç”¨æ–œä½“è¡¨ç¤ºå¹¶å‰ç¼€ä¸€ä¸ªåŠ ç²—çš„å‘Šè­¦æç¤º â€œDeprecatedâ€ã€‚</p>
<p>è¿™ä¸ª Tag å¯ä»¥ç”¨åœ¨æ‰€æœ‰çš„å¯æ³¨é‡Šå…ƒç´ ä¸Šï¼Œä½¿ç”¨è¿™ä¸ª Tag çš„æ—¶å€™ï¼Œè‡³å°‘åœ¨ç¬¬ä¸€å¥è¯è¦è¯´æ˜ API æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åºŸå¼ƒï¼Œæ›¿ä»£æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Œåç»­æè¿°å¯ä»¥é˜è¿°ä¸ºä»€ä¹ˆåºŸå¼ƒè¿™ä¸ª APIã€‚ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@deprecated</span>  As of JDK 1.1, replaced by &#123;<span class="doctag">@link</span> #setBounds(int,int,int,int)&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h4 id="docRoot"><a href="#docRoot" class="headerlink" title="{@docRoot}"></a>{@docRoot}</h4><p>è¡¨ç¤ºåˆ°å½“å‰ç”Ÿæˆæ–‡æ¡£æ ¹ç›®å½•çš„ç›¸å¯¹çš„è·¯å¾„ï¼Œä¸€èˆ¬ç”¨äºæŒ‡å‘å­˜åœ¨äºæ ¹ç›®å½•ä¸‹çš„æŒ‡å®šæ–‡ä»¶ï¼Œæ¯”å¦‚ Logo æˆ–è€…ç‰ˆæƒå£°æ˜ã€‚å®ƒä¸ä½†å¯ä»¥åœ¨æ‰€æœ‰çš„å¯æ³¨é‡Šå…ƒç´ ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨å‘½ä»¤è¡Œä¸­ã€‚</p>
<p>å‘½ä»¤è¡Œä½¿ç”¨ç¤ºä¾‹ï¼š<code>javadoc -bottom &#39;&lt;a href=&quot;{@docRoot}/copyright.html&quot;&gt;Copyright&lt;/a&gt;&#39;</code>ã€‚åœ¨æ³¨é‡Šä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * See the &lt;a href="&#123;<span class="doctag">@docRoot</span>&#125;/copyright.html"&gt;Copyright&lt;/a&gt;.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h4 id="inheritDoc"><a href="#inheritDoc" class="headerlink" title="{@inheritDoc}"></a>{@inheritDoc}</h4><p>è¿™ä¸ªæ ‡è®°ä¼šä»ç»§æ‰¿æ ‘ä¸­æœ€è¿‘çš„ä½ç½®å¤åˆ¶æ³¨é‡Šï¼Œä»è€Œå…è®¸åœ¨ç»§æ‰¿æ ‘çš„é«˜å±‚ä¸­è¿›è¡Œä¸€äº›é€šç”¨çš„æ³¨é‡Šï¼Œåœ¨ä½å±‚ä¸­è¿›è¡Œæ›´ä¸ºè¯¦ç»†çš„æè¿°ã€‚è¿™ä¸ªæ ‡è®°å¯ä»¥åœ¨ä¸‹é¢ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨ï¼š</p>
<ol>
<li>åœ¨æ–¹æ³•çš„æè¿°å—ä¸­ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šä»çˆ¶ç±»/æ¥å£ä¸­æ‹·è´æè¿°ï¼›</li>
<li>åœ¨@returnï¼Œ@paramå’Œ@throwsæ ‡è®°çš„æ–‡æœ¬å‚æ•°ä¸­ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šä»çˆ¶æ–¹æ³•çš„å¯¹åº”æ ‡è®°ä¸­è¿›è¡Œæ‹·è´ï¼›</li>
</ol>
<blockquote>
<p>è¯¦ç»†çš„å¯»æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p><strong>Algorithm for Inheriting Method Comments</strong> - If a method does not have a doc comment, or has an {@inheritDoc} tag, the Javadoc tool searches for an applicable comment using the following algorithm, which is designed to find the most specific applicable doc comment, giving preference to interfaces over superclasses:</p>
<ol>
<li>Look in each directly implemented (or extended) interface in the order they appear following the word implements (or extends) in the method declaration. Use the first doc comment found for this method.</li>
<li>If step 1 failed to find a doc comment, recursively apply this entire algorithm to each directly implemented (or extended) interface, in the same order they were examined in step 1.</li>
<li>If step 2 failed to find a doc comment and this is a class other than Object (not an interface):</li>
<li><ol>
<li>If the superclass has a doc comment for this method, use it.</li>
<li>If step 3a failed to find a doc comment, recursively apply this entire algorithm to the superclass.</li>
</ol>
</li>
</ol>
<p>ç®€è€Œè¨€ä¹‹ï¼šä¼šä¸€ç›´å¾€ç»§æ‰¿æ ‘é«˜å±‚æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°å¯¹åº”çš„æ³¨é‡Šæˆ–è€…åˆ°è¾¾ Object ç±»ã€‚</p>
</blockquote>
<h4 id="link-package-class-member-label"><a href="#link-package-class-member-label" class="headerlink" title="{@link  package.class#member  label}"></a><strong>{@link</strong>  package.class#member  label}</h4><p>ä¸€ä¸ªéå¸¸å¼ºå¤§çš„æ ‡è®°ï¼Œå¯ä»¥é“¾æ¥åˆ°æºç ä¸­çš„ä»»ä½•ä¸€ä¸ªåŒ…ã€ç±»ã€æ–¹æ³•æˆ–è€…å±æ€§ï¼Œä»è€Œä½¿å¾—æ³¨é‡Šå¯ä»¥ç‚¹å‡»è·³è½¬ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Use the &#123;@link #getComponentAt(int, int) getComponentAt&#125; method.</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ³¨é‡Šä¼šäº§ç”Ÿå¦‚ä¸‹æ•ˆæœï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Use the <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"Component.html#getComponentAt(int, int)"</span>&gt;</span>getComponentAt<span class="tag">&lt;/<span class="name">a</span>&gt;</span> method.</span><br></pre></td></tr></table></figure>
<p>å®ƒå¯ä»¥ä½¿ç”¨åœ¨æ³¨é‡Šçš„ä»»ä½•åœ°æ–¹ã€‚å¦‚æœ label ä¸æ˜¯ä»£ç ï¼ˆä¸æ˜¯ä¸€ä¸ªæ–¹æ³•ã€ç±»åæˆ–è€…å±æ€§åç­‰ï¼Œä¸ä»£ç æ— å…³ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>{@linkplain  package.class#member  label}</code>ä»£æ›¿ã€‚</p>
<h4 id="literal-text"><a href="#literal-text" class="headerlink" title="{@literal text}"></a>{@literal text}</h4><p>å¯ä»¥é¿å…ä¸€æ®µæ–‡å­—è¢«å½“åš HTML æ ‡è®°æˆ–è€… Javadoc è§£æï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="meta">@literal</span> A&lt;B&gt;C&#125;</span><br></pre></td></tr></table></figure>
<p><code>&lt;B&gt;</code>å°±ä¸ä¼šè¢«å½“åšåŠ ç²—æ¥è§£æï¼Œå®é™…ä¸Šï¼Œ<code>{@code text}</code>å°±ç­‰äº<code>&lt;code&gt;{literal text}&lt;/code&gt;</code>ã€‚</p>
<h4 id="param"><a href="#param" class="headerlink" title="@param"></a>@param</h4><p>åœ¨æ–¹æ³•çš„æ³¨é‡Šä¸Šå¾ˆå¸¸è§ï¼Œä½†å®é™…ä¸Šä¹Ÿå¯ä»¥ç”¨æ¥æ ‡æ³¨ç±»ï¼Œå› ä¸ºå®ƒå¯ä»¥ç”¨äºæ ‡è®°æ³›å‹ã€‚</p>
<h4 id="see"><a href="#see" class="headerlink" title="@see"></a>@see</h4><p>è¿™ä¸ªæ ‡è®°ä¼šç”Ÿæˆ â€œSee Alsoâ€ ï¼ˆä¸­æ–‡ï¼šå¦è¯·å‚é˜…ï¼‰çš„æ³¨é‡Šç”¨äºæŒ‡å‘ä¸€ä¸ªå¼•ç”¨ï¼Œå¯ä»¥å†ä»»ä½•å¯æ³¨é‡Šçš„å¯¹è±¡ä¸Šã€‚å®ƒæœ‰ä¸‰ç§ç”¨æ³•ï¼š</p>
<ol>
<li><code>@see &quot;string&quot;</code>ã€‚ä¾‹å¦‚<code>@see &quot;The Java Programming Language&quot;</code>ï¼Œstring ä»£è¡¨çš„æ˜¯ä¸€æœ¬ä¹¦æˆ–è€…æ— æ³•é€šè¿‡ URL è·å–çš„èµ„æ–™ï¼Œå¿…é¡»è¦åŠ ä¸ŠåŒå¼•å·æ‰è¡Œï¼›</li>
<li><code>@see &lt;a herf=&quot;URL#valie&gt;label&lt;/a&gt;&quot;&gt;</code>ã€‚è¿™é‡Œç»™å‡ºçš„æ˜¯ä¸€ä¸ª URLï¼›</li>
<li><code>@see package.class#member label</code>ã€‚è¿™ä¸ªç”¨æ³•å’Œ<code>{@link}</code>å¾ˆåƒï¼Œå¯ä»¥é“¾æ¥åˆ°æºç ä¸­çš„ä»»ä½•åŒ…/ç±»/æ–¹æ³•/å±æ€§ã€‚label æ˜¯å¯é€‰çš„ï¼Œå…·ä½“æ˜¾ç¤ºå¯ä»¥å‚è§<a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/javadoc.html#shortened" target="_blank" rel="noopener">How a name is displayed</a>ã€‚</li>
</ol>
<p>å…·ä½“å†™æ³•å¯ä»¥å‚è§ä¸‹é¢çš„è¡¨æ ¼ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/@seeå†™æ³•.png" height="360" alt="APIæ–‡æ¡£ç¤ºä¾‹"></div>

<h4 id="since-since-text"><a href="#since-since-text" class="headerlink" title="@since since-text"></a>@since since-text</h4><p>å¯ä»¥ç”¨äºæ ‡è®°æŸä¸ª API /ç‰¹æ€§æ˜¯åœ¨å“ªä¸ªç‰ˆæœ¬è¢«åŠ ä¸Šçš„ï¼Œå¯ä»¥ç”¨åœ¨æ‰€æœ‰å¯æ³¨é‡Šçš„å…ƒç´ ä¸Šï¼Œæ¯”å¦‚<code>@since 1.5</code>ã€‚</p>
<h4 id="throws"><a href="#throws" class="headerlink" title="@throws"></a>@throws</h4><p>å’Œ<code>@exception</code>ä¸€æ ·ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªæ–¹æ³•å¯èƒ½ä¼šæŠ›å‡ºçš„å¼‚å¸¸ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException  If an input or output </span></span><br><span class="line"><span class="comment"> *                      exception occurred</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå¦‚æœæ–¹æ³•ç­¾åï¼ˆæ³¨æ„ï¼šä¸æ˜¯æ–¹æ³•ä½“ï¼‰throw äº†ä¸€ä¸ªå¼‚å¸¸ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ @throws æ ‡è®°ï¼ŒJavadoc å·¥å…·ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ²¡æœ‰æè¿°çš„ HTML æ’å…¥åˆ°æ–‡æ¡£ä¸­ã€‚</p>
<h4 id="value-package-class-field"><a href="#value-package-class-field" class="headerlink" title="@{value package.class#field}"></a>@{value package.class#field}</h4><p>å¦‚æœ<code>{@value}</code>ç”¨äºä¿®é¥°ä¸€ä¸ªé™æ€çš„ final å˜é‡ï¼Œé‚£ä¹ˆå°±ä¼šå±•ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The value of this constant is &#123;<span class="doctag">@value</span>&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCRIPT_START = <span class="string">"&lt;script&gt;"</span></span><br></pre></td></tr></table></figure>
<p>å¦åˆ™å®ƒå°±å¯ä»¥ç”¨æ¥è¡¨ç¤ºæŸä¸ªç±»çš„å¸¸é‡å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Evaluates the script starting with &#123;<span class="doctag">@value</span> #SCRIPT_START&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">evalScript</span><span class="params">(String script)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šå˜é‡å¿…é¡»æ˜¯é™æ€çš„ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ–‡ç« æåˆ°çš„ä¸¤ç¯‡æ–‡æ¡£ä¸­è¿˜æœ‰å¾ˆå¤šæ³¨é‡Šç›¸å…³çš„æ•´ç†ï¼Œå°¤å…¶æ˜¯å…³äºç”Ÿæˆæ–‡æ¡£çš„å‘½ä»¤é€‰é¡¹ï¼Œå¦‚æœçœŸçš„éœ€è¦ç”Ÿæˆ API æ–‡æ¡£ï¼Œå¯ä»¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹ã€‚è¿™é‡Œæ•´ç†çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†æ—¥å¸¸å¼€å‘æ‰€ç”¨ï¼Œä¸€èˆ¬åªé™äºä»£ç æ³¨é‡Šè€Œä¸ç”¨ç”Ÿæˆ API æ–‡æ¡£ï¼Œå› æ­¤è¿™é‡Œå°±ä¸å†ç»§ç»­ç ”ç©¶äº†ã€‚</p>
<p>å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿæé«˜ä¸€ä¸‹è‡ªå·±å’Œè¯»è€…å†™æ³¨é‡Šçš„è§„èŒƒæ€§ï¼Œè®©æ³¨é‡Šèƒ½æ›´å¥½çš„å¸®åŠ©åˆ«äººç†è§£æˆ‘ä»¬çš„ä»£ç ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[OC Runtimeï¼ˆäºŒï¼‰]]></title>
      <url>http://www.timebridge.space/2016/12/10/OC-Runtime%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>åœ¨å‰ä¸€ç¯‡æ–‡ç« <a href="http://timebridge.space/2016/12/10/OC-Runtime/" target="_blank" rel="noopener">OC Runtimeï¼ˆä¸€ï¼‰</a>ï¼ˆä»¥ä¸‹ç®€ç§°â€å‰æ–‡â€ï¼‰é‡Œé¢ï¼Œé€šè¿‡å¯¹<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048-CH1-SW1" target="_blank" rel="noopener">ã€ŠObjC Runtime Guideã€‹</a>æ–‡æ¡£çš„é˜…è¯»ï¼ŒåŸºæœ¬äº†è§£äº† Runtime çš„æ¦‚å¿µå’Œèƒ½åŠ›ã€‚æœ¬æ–‡åœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥æ·±å…¥æ¢ç´¢ï¼Œä¸ºä»€ä¹ˆ Runtime å…·å¤‡è¿™æ ·çš„èƒ½åŠ›ï¼ŒOC åˆæ˜¯åŸºäºæ€æ ·çš„ç»“æ„å®ç°å½“å‰çš„ç‰¹æ€§çš„ã€‚</p>
<blockquote>
<p>åœ¨ Apple çš„<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">Source Browser</a>ç½‘ç«™ä¸Šå¯ä»¥ä¸‹è½½åˆ° Runtime çš„æºä»£ç ï¼Œä»£ç ä¸‹è½½ä¸‹æ¥è§£å‹åå¯ä»¥å¯¼å…¥åˆ° XCode ä¸­æŸ¥çœ‹ã€‚</p>
</blockquote>
<h2 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h2><p>å‰æ–‡æåˆ°ï¼Œå¼€å‘è€…åœ¨ OC ä¸­çš„æ¶ˆæ¯å‘é€æœ€ç»ˆä¼šè¢«è½¬åŒ–ä¸º <code>objc_msgSend(receiver, selector, arg1, arg2, ...)</code>è¿™æ ·çš„è°ƒç”¨æ ¼å¼ï¼Œ<code>objc_msgSend</code>æ–¹æ³•å®šä¹‰åœ¨ message.h ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id objc_msgSend(id self, SEL op, ...)</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå‚æ•°åœ¨å‰æ–‡ä¸­æœ‰ç›¸åº”è§£é‡Šï¼Œè¿™é‡Œå®ƒä»¬çš„ç±»å‹åˆ†åˆ«æ˜¯ id å’Œ SELï¼Œå¹¶ä¸”å‡½æ•°çš„è¿”å›å€¼ç±»å‹ä¹Ÿæ˜¯ idã€‚é‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å‹ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å°±ä»è¿™é‡Œå…¥æ‰‹ã€‚<a id="more"></a></p>
<h2 id="SEL-å’Œ-id"><a href="#SEL-å’Œ-id" class="headerlink" title="SEL å’Œ id"></a>SEL å’Œ id</h2><p>åœ¨é¡¹ç›®ä¸­ç®€å•æœç´¢ï¼Œå¾ˆå¿«å°±èƒ½å‘ç°ä¸¤è€…çš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_selector *SEL;</span><br><span class="line">typedef struct objc_object *id;</span><br></pre></td></tr></table></figure>
<p>SEL æ˜¯ä¸€ä¸ªæŒ‡å‘ objc_selector çš„æŒ‡é’ˆï¼Œid æ˜¯ä¸€ä¸ªæŒ‡å‘ objc_object çš„æŒ‡é’ˆã€‚</p>
<h3 id="objc-selector"><a href="#objc-selector" class="headerlink" title="objc_selector"></a>objc_selector</h3><p>å…³äº objc_selector è¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼Œruntime åº“ä¸­å¹¶æ²¡æœ‰ç»™å‡ºï¼Œä½†æ˜¯å¯ä»¥å‚è€ƒä»¥ä¸‹ä¸¤ä»½èµ„æ–™ï¼š</p>
<ul>
<li><a href="https://sourceware.org/svn/gcc/tags/stack-last-merge/libobjc/objc/objc.h" target="_blank" rel="noopener">objc.h</a></li>
<li><a href="https://books.google.com.hk/books?id=onyzCAAAQBAJ&amp;pg=PA237&amp;lpg=PA237&amp;dq=the+definition+of+objc_selector&amp;source=bl&amp;ots=p2rIQX9Wjb&amp;sig=MxfZ9CPPzWSlAKqyz1xMZJt_10k&amp;hl=zh-CN&amp;sa=X&amp;ved=0ahUKEwj7vbD-4enQAhXFLhoKHa__Cz0Q6AEIVDAI#v=onepage&amp;q=the%20definition%20of%20objc_selector&amp;f=false" target="_blank" rel="noopener">Professional Swift</a></li>
</ul>
<p>å…¶ä¸­ç¬¬äºŒä»½èµ„æ–™æåˆ°ï¼š</p>
<blockquote>
<p>However, on OS X and iOS, a struct objc_selector is simply a C string internally.</p>
</blockquote>
<p>ç»“åˆæˆ‘ä»¬å¯¹ SEL çš„ä½¿ç”¨çœ‹ï¼Œå¯ä»¥è®¤ä¸º SEL ç­‰äºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Method method = class_getInstanceMethod([MsgTest class], @selector(realMethod));</span><br><span class="line">NSLog(@&quot;%@&quot;, NSStringFromSelector(method_getName(method)));</span><br></pre></td></tr></table></figure>
<p>å°±ä¼šè¾“å‡ºï¼šrealMethodã€‚</p>
<p>è¯»è€…å¯ä»¥å»çœ‹çœ‹<code>method_getName</code>è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œå°±æ˜¯ SELï¼Œä¹Ÿå°±æ˜¯è¯´ SEL æ˜¯ç”¨æ¥è¡¨ç¤ºæ–¹æ³•åçš„ã€‚</p>
<h3 id="objc-object"><a href="#objc-object" class="headerlink" title="objc_object"></a>objc_object</h3><p>è¿™ä¸ªç»“æ„ä½“å®šä¹‰åœ¨ object-private.h ä¸­ï¼Œåªæœ‰ä¸€ä¸ªå±æ€§ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">isa_t</span> isa;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//å„ç§æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå±æ€§æ˜¯ isa_t ç±»å‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªè”åˆä½“ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">isa_t</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="keyword">isa_t</span>(<span class="keyword">uintptr_t</span> value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="keyword">uintptr_t</span> bits;</span><br><span class="line">  	<span class="comment">//ä¸‹é¢æ˜¯ä¸‰ä¸ªç»“æ„ä½“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­æ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸€ä¸ª Class å±æ€§ï¼ŒClass æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_class *Class;</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸€ä¸ªæŒ‡å‘ objc_class çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æ¯ä¸€ä¸ªå¯¹è±¡å†…éƒ¨éƒ½å­˜å‚¨ç€æŒ‡å‘è‡ªå·±æ‰€å±ç±»å‹çš„æŒ‡é’ˆ</strong>ã€‚</p>
<p>objc_class çš„å®šä¹‰åˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line">    <span class="keyword">uint32_t</span> info;</span><br><span class="line">    <span class="keyword">uint32_t</span> instance_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_ivar_list</span> *<span class="title">ivars</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_method_list</span> **<span class="title">methodLists</span>;</span></span><br><span class="line">    Cache cache;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_protocol_list</span> *<span class="title">protocols</span>;</span></span><br><span class="line">  	<span class="comment">// CLS_EXT only</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *ivar_layout;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_class_ext</span> *<span class="title">ext</span>;</span></span><br><span class="line">    <span class="comment">//å„ç§æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œå°±å¾ˆæœ‰æ„æ€äº†ï¼Œè™½ç„¶è¿™äº›ä»£ç æ³¨é‡Šä¸å¤šï¼Œä½†æ ¹æ®åå­—ï¼Œä¾ç„¶èƒ½å¤Ÿçœ‹å‡ºä¸€äº›ç«¯å€ªã€‚</p>
<ul>
<li>é¦–å…ˆè¿™ä¸ªç»“æ„ä½“æ˜¯ç»§æ‰¿ objc_object çš„ï¼Œè¿™è¡¨æ˜ç±»ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰ä¸€ä¸ª isa å±æ€§ï¼›</li>
<li>å…¶æ¬¡è¿™ä¸ªç»“æ„ä½“åŒ…å«ä¸€ä¸ª superclass çš„ Class å±æ€§ï¼Œè¿™åº”è¯¥æ˜¯æŒ‡å‘å®ƒçš„çˆ¶ç±»ï¼›</li>
<li>æ¥ç€ï¼Œè¿™ä¸ªç»“æ„ä½“åŒ…å«ä¸‰ä¸ªç»“æ„ä½“ï¼Œä»åå­—çœ‹ï¼Œåº”è¯¥æ˜¯ä¾æ¬¡åŒ…å«æ‰€æœ‰å˜é‡ã€æ–¹æ³•å’Œå®ç°çš„åè®®ï¼›</li>
<li>è¿˜æœ‰ä¸€ä¸ª Cache å˜é‡ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å‰æ–‡æåˆ°çš„ç”¨äºç¼“å­˜è¢«è°ƒç”¨æ–¹æ³•çš„ï¼›</li>
<li>æœ€åï¼Œæœ‰ä¸€ä¸ª old_class_ext æ‰©å±•ç»“æ„ä½“å±æ€§ï¼›</li>
</ul>
<h4 id="å˜é‡ã€æ–¹æ³•ã€åè®®å’Œå±æ€§"><a href="#å˜é‡ã€æ–¹æ³•ã€åè®®å’Œå±æ€§" class="headerlink" title="å˜é‡ã€æ–¹æ³•ã€åè®®å’Œå±æ€§"></a>å˜é‡ã€æ–¹æ³•ã€åè®®å’Œå±æ€§</h4><p>å˜é‡åˆ—è¡¨çš„ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_ivar</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *ivar_name;</span><br><span class="line">    <span class="keyword">char</span> *ivar_type;</span><br><span class="line">    <span class="keyword">int</span> ivar_offset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_ivar_list</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> ivar_count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_ivar</span> <span class="title">ivar_list</span>[1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸Šå»å¾ˆç®€å•ï¼Œè¿™ä¸ªåˆ—è¡¨é‡Œé¢å­˜å‚¨ç€çš„å…ƒç´ æ˜¯ old_varï¼Œè€Œè¿™ä¸ªç»“æ„ä½“ä¸­æœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„æˆå‘˜ï¼šå˜é‡åå’Œå˜é‡ç±»å‹ã€‚æ–¹æ³•åˆ—è¡¨å¤§è‡´ç›¸åŒï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_method</span> &#123;</span></span><br><span class="line">    SEL method_name;</span><br><span class="line">    <span class="keyword">char</span> *method_types;</span><br><span class="line">    IMP method_imp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_method_list</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *obsolete;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> method_count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_method</span> <span class="title">method_list</span>[1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯æ–¹æ³•åˆ—è¡¨çš„å…ƒç´ ç»“æ„ä½“æœ‰äº›ç‰¹æ®Šï¼Œé¦–å…ˆæ–¹æ³•åæ˜¯ SEL ç±»å‹çš„ï¼Œè¿™ä¸ªå‰é¢å·²ç»æœ‰åˆ†æã€‚method_types æ˜¯ä»€ä¹ˆï¼ŸIMP æ˜¯åˆä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ</p>
<p>å¦‚æœè¯»è€…é˜…è¯»äº†å‰æ–‡æåˆ°çš„<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1" target="_blank" rel="noopener">Type Encodings</a>å°èŠ‚ï¼Œå…¶å®ä¸æ˜¯å¾ˆéš¾ç†è§£ method_typesï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ä»£ç æ‰“å°å‡ºå®ƒçš„æ¡ˆä¾‹ï¼Œè¿˜æ˜¯ä»¥å‰æ–‡çš„ MsgTest ç±»ä¸ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Method method = class_getInstanceMethod([MsgTest class], @selector(realMethod));</span><br><span class="line">NSLog(@&quot;%s&quot;, method_getTypeEncoding(method));</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¼šè¾“å‡ºï¼šv16@0:8ã€‚</p>
<blockquote>
<p>v è¡¨ç¤º voidï¼Œå³è¿”å›å€¼ä¸º voidï¼Œ16 è¡¨ç¤º æ•´ä¸ªæ–¹æ³•å‚æ•°å ä½çš„æ€»é•¿åº¦ï¼Œ@0 è¡¨ç¤ºåœ¨å‚æ•°åŒºåŸŸåç§»ä¸º 0 çš„ä½ç½®æœ‰ä¸€ä¸ª OC å¯¹è±¡ï¼Œè¿˜è®°å¾—å‰é¢è¯´åˆ°çš„æ–¹æ³•åœ¨è¢«ç¼–è¯‘ä¹‹åï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ id ç±»å‹ï¼Œå³ self ä¹ˆï¼Ÿ:8 è¡¨ç¤ºåœ¨å‚æ•°åˆ—è¡¨åç§»ä¸º 8 å­—èŠ‚çš„åœ°æ–¹æœ‰ä¸€ä¸ª SEL å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å‰é¢åˆ†æçš„ç¬¬äºŒä¸ªå‚æ•° _cmdã€‚</p>
<p>è¿™é‡Œç”±äºå†…å­˜å¯¹é½çš„åŸå› ï¼Œä¼šå¯¼è‡´å¾ˆå¤šç±»å‹éƒ½ç«™ 4 ä¸ªå­—èŠ‚æˆ–è€… 8 ä¸ªå­—èŠ‚ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å®éªŒã€‚</p>
</blockquote>
<p>IMP çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A pointer to the function of a method implementation. </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !OBJC_OLD_DISPATCH_PROTOTYPES</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*IMP)</span><span class="params">(<span class="keyword">void</span> <span class="comment">/* id, SEL, ... */</span> )</span></span>; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">id</span> <span class="params">(*IMP)</span><span class="params">(id, SEL, ...)</span></span>; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>æ³¨é‡Šè¯´çš„å¾ˆæ˜ç™½ï¼šæŒ‡å‘æ–¹æ³•å®ç°çš„å‡½æ•°æŒ‡é’ˆã€‚å…¶å®åœ¨å‰æ–‡ä¸­æåˆ° class_addMethod çš„æ—¶å€™ï¼Œå·²ç»é‡åˆ°å¹¶ä½¿ç”¨è¿‡å®ƒäº†ã€‚</p>
<p>åè®®éƒ¨åˆ†çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_protocol</span> &#123;</span></span><br><span class="line">    Class isa;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *protocol_name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_protocol_list</span> *<span class="title">protocol_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_description_list</span> *<span class="title">instance_methods</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_description_list</span> *<span class="title">class_methods</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_protocol_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_protocol_list</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">long</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_protocol</span> *<span class="title">list</span>[1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åè®®å…ƒç´  old_protocol åŒ…å«ä¸¤ä¸ªç»“æ„ä½“ï¼Œåˆ†åˆ«æè¿°å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•ã€‚æœ€ç»ˆéƒ½æŒ‡å‘ä»¥ä¸‹å…ƒç´ çš„ä¸€ä¸ªé›†åˆï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Defines a method</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_method_description</span> &#123;</span></span><br><span class="line">	SEL name;               <span class="comment">/**&lt; The name of the method */</span></span><br><span class="line">	<span class="keyword">char</span> *types;            <span class="comment">/**&lt; The types of the method arguments */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå€’æ˜¯å¾ˆæ¸…æ¥šçš„æŒ‡å‡ºäº†<strong>SEL ä»£è¡¨çš„å°±æ˜¯æ–¹æ³•å</strong>ï¼Œè€Œ types æŒ‡å‘çš„æ˜¯å‚æ•°ç±»å‹ã€‚åªä¸è¿‡åè®®æ˜¯æ²¡æœ‰æ–¹æ³•å®ç°çš„ï¼Œå› æ­¤è¿™é‡Œæ²¡æœ‰ IMP æŒ‡é’ˆã€‚å…¶ä½™çš„éƒ¨åˆ†å°±ä¸è¿‡å¤šæ¢ç©¶äº†ã€‚</p>
<h4 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h4><p>ä¹ä¸€çœ‹ï¼Œobjc_class ç»“æ„ä½“ä¸­å¹¶æ²¡æœ‰å±æ€§ç›¸å…³çš„å†…å®¹ï¼Œé‚£æ˜¯å› ä¸ºå±æ€§è—åˆ°äº† old_class_ext ç»“æ„ä½“ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_class_ext</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> size;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *weak_ivar_layout;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_property_list</span> **<span class="title">propertyLists</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>old_property_list ç»“æ„ä½“çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_property</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *attributes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">old_property_list</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> entsize;</span><br><span class="line">    <span class="keyword">uint32_t</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">old_property</span> <span class="title">first</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™è¾¹ä¼šçœ‹åˆ°ä¸€äº›ç†Ÿæ‚‰çš„ä¸œè¥¿ï¼Œè¿™ä¸ªåˆ—è¡¨é‡Œçš„å…ƒç´ æ˜¯ old_property ç»“æ„ä½“ï¼Œè¿˜è®°å¾—å‰æ–‡ä¸­æ‰“å°å±æ€§çš„ name å’Œattributes çš„ä¾‹å­ä¹ˆï¼Ÿè¿™å°±æ˜¯é‚£ä¸¤ä¸ªå€¼å­˜å‚¨çš„åœ°æ–¹ã€‚</p>
<h4 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h4><p>Cache çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> *<span class="title">Cache</span></span></span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘ objc_cache çš„æŒ‡é’ˆï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>                 OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied                                    OBJC2_UNAVAILABLE;</span><br><span class="line">    Method buckets[<span class="number">1</span>]                                        OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Method åˆæ˜¯å•¥ï¼Ÿå…¶å®å‰é¢çš„ä¾‹å­ä¸­å·²ç»ç”¨åˆ°ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">old_method</span> *<span class="title">Method</span>;</span></span><br></pre></td></tr></table></figure>
<p>å°±æ˜¯ä¸€ä¸ªæŒ‡å‘ old_method ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¿™ä¸ªç»“æ„ä½“å‰é¢å·²ç»å±•ç¤ºè¿‡äº†ï¼Œå› æ­¤ Cache å¯ä»¥ç®€å•çš„è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªå­˜å‚¨ç€æ–¹æ³•åˆ—è¡¨çš„ç»“æ„ä½“ã€‚è¿™å’Œæˆ‘ä»¬ä¹‹å‰äº†è§£åˆ°çš„å’ŒçŒœæµ‹çš„ä¹Ÿç›¸ç¬¦åˆã€‚</p>
<h4 id="ç±»å’Œå…ƒç±»"><a href="#ç±»å’Œå…ƒç±»" class="headerlink" title="ç±»å’Œå…ƒç±»"></a>ç±»å’Œå…ƒç±»</h4><p>è™½ç„¶å‰é¢å¯¹ objc_class ç»“æ„ä½“çš„å±•ç¤ºçœç•¥äº†æ‰€æœ‰çš„æ–¹æ³•ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NOT identical to this-&gt;ISA() when this is a metaclass</span></span><br><span class="line"><span class="function">Class <span class="title">getMeta</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (isMetaClass()) <span class="keyword">return</span> (Class)<span class="keyword">this</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">this</span>-&gt;ISA();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªå…ƒç±»çš„æ¦‚å¿µï¼Œå½“è°ƒç”¨<code>getMeta()</code>æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰ç±»å°±æ˜¯ä¸€ä¸ªå…ƒç±»ï¼Œè¿”å›è‡ªèº«å°±å¥½ï¼Œå¦åˆ™è¿”å›çš„æ˜¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> Class objc_object::ISA() </span><br><span class="line">&#123;</span><br><span class="line">    assert(!isTaggedPointer()); </span><br><span class="line">    <span class="keyword">return</span> isa.cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸ªå†…è”å‡½æ•°ï¼Œæœ€ç»ˆå€¼ä¸º isa.cls â€”â€” æŒ‡å‘çš„æ˜¯ä¸€ä¸ª Class å¯¹è±¡ã€‚é‚£ä¹ˆç©¶ç«Ÿä»€ä¹ˆæ˜¯ Meta Class å‘¢ï¼Ÿè¯»è€…å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cocoawithlove.com/2010/01/what-is-meta-class-in-objective-c.html" target="_blank" rel="noopener">What is a meta-class in Objective-C?</a> å®ƒçš„ä¸»è¦ç»“è®ºå¦‚ä¸‹ï¼š</p>
<ol>
<li>ä»»ä½•åŒ…å«æŒ‡å‘ Class ç»“æ„ä½“æŒ‡é’ˆçš„ç»“æ„ä½“éƒ½å¯ä»¥è¢«è®¤ä¸ºæ˜¯ objc_objectï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ OC ä¸­å¯ä»¥å‘å¯¹è±¡å‘é€æ¶ˆæ¯çš„åŸå› ï¼šå› ä¸º Class ä¸­åŒ…å«äº†æ–¹æ³•åˆ—è¡¨ï¼Œè¿™ä¸ªåœ¨å‰æ–‡ä»¥åŠå‰é¢çš„åˆ†æä¸­éƒ½å·²ç»æåˆ°ï¼›</li>
<li>Class ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ ¹æ®å‰é¢çš„åˆ†æï¼Œobjc_class æ˜¯ç»§æ‰¿ objc_object çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒClass ä¹Ÿå¯ä»¥æ¥æ”¶æ¶ˆæ¯ï¼Œæ¯”å¦‚<code>[NSObject alloc]</code>ï¼›</li>
<li>æ—¢ç„¶ Class ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å°±å¿…ç„¶æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡é’ˆä¸€ä¸ªç±»å‹ï¼Œä»¥ç¬¦åˆç»“è®º 1 ä¸­å®šä¹‰çš„ objc_object çš„ç»“æ„ä½“ç‰¹æ€§ï¼ŒClass æŒ‡å‘çš„è¿™ä¸ªç±»å‹ä¹Ÿå¿…é¡»åŒ…å«ä¸€ä¸ª Method åˆ—è¡¨ä»¥è¡¨æ˜æˆ‘ä»¬å¯ä»¥åœ¨ Class ä¸Šæ‰§è¡Œå“ªäº›æ–¹æ³•ï¼›</li>
<li>Meta-Classï¼Œå³å…ƒç±»ï¼Œå°±æ˜¯ä¸ºè¿™ä¸ªéœ€æ±‚å­˜åœ¨çš„ï¼šå½“å‘ä¸€ä¸ª Class å¯¹è±¡å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨å…ƒç±»ä¸­å¯»æ‰¾æ¶ˆæ¯çš„å¤„ç†è€…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…ƒç±»å­˜å‚¨ç€ç±»æ–¹æ³•ï¼Œæ¯ä¸€ä¸ªç±»éƒ½å¿…é¡»æœ‰è‡ªå·±ç‹¬ç‰¹çš„å…ƒç±»ï¼Œå› ä¸ºæ¯ä¸ªç±»çš„ç±»æ–¹æ³•éƒ½å¯èƒ½ä¸ä¸€æ ·ï¼›</li>
<li>æ—¢ç„¶å…ƒç±»ä¹Ÿæœ‰æ¶ˆæ¯å¤„ç†èƒ½åŠ›ï¼Œå³è¡¨æ˜å…ƒç±»ä¹Ÿå’Œ Class ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å®ƒä¹Ÿå¿…é¡»æœ‰ä¸€ä¸ª Classã€‚æ‰€æœ‰çš„å…ƒç±»éƒ½ä»¥ç»§æ‰¿æ ‘ä¸­çš„æœ€åŸºç±»çš„å…ƒç±»ä½œä¸ºå®ƒä»¬çš„ Classï¼Œä¹Ÿå°±æ˜¯ NSObject çš„æ‰€æœ‰å­ç±»çš„å…ƒç±»éƒ½ä»¥ NSObject çš„å…ƒç±»ä½œä¸ºè‡ªå·±çš„ Classã€‚</li>
<li>Class é€šè¿‡ superclass æŒ‡å‘æŒ‡å‘è‡ªå·±çš„çˆ¶ç±»ï¼Œmeta-class åˆ™é€šè¿‡è‡ªå·±çš„ superclass æŒ‡å‘çˆ¶ç±»çš„å…ƒç±»ã€‚</li>
</ol>
<p>æ€»ç»“ä¸‹æ¥å°±æ˜¯ä¸‹é¢è¿™å¹…å›¾ï¼ˆæ¥æºä¸æ˜ï¼‰ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/ç±»ä¸å…ƒç±».jpg" height="360" alt="Androidè°ƒä¼˜å·¥å…·æ±‡æ€»"></div>

<p><strong>æœ€åŸºç±»ï¼ˆNSObjectï¼‰æ˜¯æ‰€æœ‰å­ç±»çš„åŸºç±»ï¼Œæœ€åŸºç±»çš„å…ƒç±»æ˜¯æœ€åŸºç±»æ‰€æœ‰å­ç±»çš„å…ƒç±»çš„æœ€åŸºç±»ï¼Œæœ€åŸºç±»çš„å…ƒç±»æ˜¯æ‰€æœ‰å­ç±»ä»¥åŠè‡ªèº«å…ƒç±»çš„å…ƒç±»ã€‚</strong></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼ŒRuntime ä¸­æ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„åˆ†æå®Œæ¯•ï¼Œç»“åˆå‰æ–‡ï¼Œæˆ‘ä»¬ä¹ŸåŸºæœ¬çŸ¥é“äº† OC ä¸‹é¢æ˜¯æ€æ ·çš„ä¸€å¥—æ•°æ®ç»“æ„åœ¨æ”¯æ’‘å®ƒçš„ç‰¹æ€§ã€‚</p>
<p>Runtime åº“ä¸­æœ‰éƒ¨åˆ†å®ç°ä»£ç åœ¨å…¶ä¸­ï¼Œåœ¨äº†è§£äº†åŸºæœ¬çš„æ•°æ®ç»“æ„ä¹‹åï¼Œæ¥ç€å°±æ˜¯æ¢ç´¢ OC ç‰¹æ€§ä¸è¿™äº›æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ï¼Œæ¯”å¦‚ Category çš„å®ç°åŸç†ã€Method Swizzlingç­‰ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[OC Runtimeï¼ˆä¸€ï¼‰]]></title>
      <url>http://www.timebridge.space/2016/12/10/OC-Runtime/</url>
      <content type="html"><![CDATA[<blockquote>
<p>å‚è€ƒèµ„æ–™ï¼š<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048-CH1-SW1" target="_blank" rel="noopener">ã€ŠObjC Runtime Guideã€‹</a>ã€‚</p>
</blockquote>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>ç®€å•æ¥è¯´ï¼Œ<strong>Runtime æ˜¯ OC è¯­è¨€çš„è¿è¡Œç¯å¢ƒ</strong>ã€‚</p>
<p>OC ä¼šå°½é‡å°†å†³è®®å»¶è¿Ÿåˆ°è¿è¡Œæ—¶åšå‡ºè€Œéåœ¨ç¼–è¯‘å’Œè¿æ¥æœŸé—´ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨å…·ä½“æ˜¯æ‰§è¡Œå“ªæ®µä»£ç ã€‚è¿™æ„å‘³ç€ OC ä¸ä»…éœ€è¦ä¸€ä¸ªç‰¹å®šçš„ç¼–è¯‘å™¨ï¼Œè€Œä¸”éœ€è¦ä¸€ä¸ªè¿è¡Œç³»ç»Ÿæ¥æ‰§è¡Œç¼–è¯‘åçš„ä»£ç ä»è€Œå®ç°å†³è®®å»¶è¿Ÿï¼Œè¿™æœ‰ç‚¹åƒ JVM å’Œ Javaçš„å…³ç³»ã€‚å› æ­¤ç ”ç©¶ Runtime æœ‰åŠ©äºäº†è§£ OC çš„è¿è¡Œï¼Œå¸®åŠ©è®¤è¯† OC çš„æœ¬è´¨ã€‚</p>
<p>Runtime åˆ†ä¸ºä¸¤ä¸ªç‰ˆæœ¬ï¼Œâ€œmodernâ€å’Œâ€œlegacyâ€ã€‚modern ç‰ˆæœ¬ä» OC2.0 å¼€å§‹å¼•å…¥ï¼Œåœ¨<a href="https://developer.apple.com/reference/objectivec/1657527-objective_c_runtime" target="_blank" rel="noopener">Objective-C Runtime Reference</a>ä¸­æœ‰è¯¦ç»†çš„å¼€å‘æ¥å£æè¿°ã€‚modern ç‰ˆæœ¬ç›¸æ¯”äº legacy ç‰ˆæœ¬çš„æœ€å¤§äº®ç‚¹åœ¨äºï¼šåœ¨ legacy ç‰ˆæœ¬çš„ Runtime ä¸­ï¼Œå¦‚æœä½ æ”¹å˜äº†å®ä¾‹å˜é‡çš„å¸ƒå±€ï¼Œå°±å¿…é¡»é‡æ–°ç¼–è¯‘æ‰€æœ‰çš„å­ç±»ï¼Œåœ¨ modern ç‰ˆæœ¬çš„ Runtime ä¸­åˆ™ä¸éœ€è¦ã€‚å¦å¤–ï¼Œ modern ç‰ˆæœ¬ Runtime æ”¯æŒä»å£°æ˜çš„ property ç»¼åˆæ¨ç†ï¼ˆsynthesisï¼‰å‡ºå®ä¾‹å˜é‡ã€‚</p>
<p>iPhone åº”ç”¨å’Œ OS X v10.5ä»¥åŠä¹‹åç‰ˆæœ¬çš„ 64-bit ç¨‹åºä½¿ç”¨çš„æ˜¯ modern ç‰ˆæœ¬ï¼Œå…¶ä½™çš„åº”ç”¨ä½¿ç”¨çš„æ˜¯ legacy ç‰ˆæœ¬ã€‚<a id="more"></a></p>
<blockquote>
<p>legacy ç‰ˆæœ¬å¼€å‘æ¥å£åœ¨ Objective-C 1 Runtime Reference ä¸­æœ‰æè¿°ï¼Œä½†åŸºæœ¬ä¸éœ€è¦å»å…³å¿ƒäº†ã€‚</p>
</blockquote>
<h3 id="è°ƒç”¨-Runtime-çš„æ–¹å¼"><a href="#è°ƒç”¨-Runtime-çš„æ–¹å¼" class="headerlink" title="è°ƒç”¨ Runtime çš„æ–¹å¼"></a>è°ƒç”¨ Runtime çš„æ–¹å¼</h3><p>OC è¯­è¨€å’Œ Runtime æœ‰ä¸‰ç§å±‚æ¬¡çš„äº¤äº’ï¼š</p>
<ul>
<li><strong>é€šè¿‡ OC æºç äº¤äº’ã€‚</strong> è¿™ç§äº¤äº’å¹¶ä¸æ˜¯è¯´é€šè¿‡ OC æ–¹æ³•å»è°ƒç”¨ runtime ï¼Œè€Œæ˜¯æŒ‡ç¼–è¯‘å™¨ä¼šé€šè¿‡åˆ›å»ºåˆé€‚çš„æ•°æ®ç»“æ„å’Œæ–¹æ³•è°ƒç”¨æ¥å®ç°è¯­è¨€çš„åŠ¨æ€ç‰¹å¾ï¼Œæ¯”å¦‚ç”¨äºæè¿°ç±»ã€Categoryã€åè®®ä»¥åŠ selectorã€‚æœ€ä¸»è¦çš„ä¸€ä¸ª runtime å‡½æ•°å°±æ˜¯ç”¨äºå‘é€æ¶ˆæ¯çš„ï¼Œåé¢ä¼šæœ‰æè¿°ï¼Œå®ƒå°±æ˜¯é€šè¿‡ OC å±‚é¢çš„æ¶ˆæ¯å‘é€è¡¨è¾¾å¼æ¥è°ƒç”¨çš„ã€‚</li>
<li><strong>ä½¿ç”¨ Foundation ä¸­å®šä¹‰çš„ NSObject ç±»äº¤äº’ã€‚ </strong> Cocoa ä¸­å¤§éƒ¨åˆ†çš„å¯¹è±¡éƒ½æ˜¯ NSObject çš„å­ç±»ï¼Œæ‰€ä»¥å®ƒä»¬ä¹Ÿç»§æ‰¿äº† NSobject çš„æ–¹æ³•ï¼Œå…¶ä¸­æœ‰éƒ¨åˆ†æ–¹æ³•æ˜¯ç”¨äºå†…çœçš„ï¼Œæ¯”å¦‚<code>class</code>æ–¹æ³•â€”â€”ç”¨äºè¯¢é—®ä¸€ä¸ªå¯¹è±¡å®ƒçš„ç±»æ˜¯ä»€ä¹ˆï¼›ç”¨äºåˆ¤æ–­ç»§æ‰¿å…³ç³»çš„æ–¹æ³•<code>isKindOfClass:</code>å’Œ<code>isMemberOfClass:</code>ï¼›åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦èƒ½æ¥å—æŸä¸ªæ¶ˆæ¯çš„æ–¹æ³•<code>respondsToSelector:</code>ï¼›åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å®ç°äº†æŸä¸ªåè®®çš„æ–¹æ³•<code>conformsToProtocol:</code>ï¼›æŸ¥è¯¢æ–¹æ³•å®ç°åœ°å€çš„æ–¹æ³•<code>methodForSelector:</code>ã€‚è¿™äº›æ–¹æ³•èµ‹äºˆäº†å¯¹è±¡å†…çœçš„èƒ½åŠ›ã€‚</li>
<li><strong>ç›´æ¥è°ƒç”¨ runtime å‡½æ•°ã€‚</strong> Runtime ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œç”±ä¸€ç»„å‡½æ•°å’Œæ•°æ®ç»“æ„ç»„æˆçš„ï¼Œå®ƒä½äºç³»ç»Ÿçš„ /usr/include/objc ç›®å½•ä¸‹é¢ã€‚è¿™é‡Œçš„å¾ˆå¤šå‡½æ•°å…è®¸å¼€å‘è€…åœ¨å¼€å‘åº”ç”¨çš„æ—¶å€™ä½¿ç”¨çº¯ C è¯­è¨€æ¥å¤åˆ¶ç¼–è¯‘å™¨çš„è¡Œä¸ºã€‚å…¶ä¸­ä¸€äº›å°±æ˜¯å‰é¢æåˆ°çš„ NSObject å†…çœå‡½æ•°çš„åŸºç¡€ã€‚æ‰€æœ‰çš„è¿™äº›å‡½æ•°éƒ½å¯ä»¥åœ¨æ–‡æ¡£ <a href="https://developer.apple.com/reference/objectivec/1657527-objective_c_runtime" target="_blank" rel="noopener">Objective-C Runtime Reference</a> ä¸­æŸ¥é˜…ã€‚</li>
</ul>
<h3 id="Runtimeçš„å†…å®¹"><a href="#Runtimeçš„å†…å®¹" class="headerlink" title="Runtimeçš„å†…å®¹"></a>Runtimeçš„å†…å®¹</h3><p>Runtimeæ€»å…±åŒ…å«ä¸‰ä¸ªæ–¹é¢çš„å†…å®¹ï¼š</p>
<ul>
<li>ç±»çš„åŠ¨æ€åŠ è½½</li>
<li>æ¶ˆæ¯å‘é€</li>
<li>å±æ€§å†…çœ</li>
</ul>
<p>ä¸‹é¢ä¸€ä¸€é˜è¿°ã€‚</p>
<h2 id="ç±»çš„åŠ¨æ€åŠ è½½"><a href="#ç±»çš„åŠ¨æ€åŠ è½½" class="headerlink" title="ç±»çš„åŠ¨æ€åŠ è½½"></a>ç±»çš„åŠ¨æ€åŠ è½½</h2><p>OC å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ è½½å’Œé“¾æ¥æ–°çš„ç±»å’Œ Categoryï¼ŒåŠ è½½å®Œæˆåå’Œç¨‹åºä¸­åŸå§‹çš„ç±»ä»¥åŠ Category å¹¶æ— äºŒè‡´ã€‚æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è¿›è¡Œç±»åŠ¨æ€åŠ è½½ï¼š</p>
<ol>
<li>objc/objc-load.h æ–‡ä»¶ä¸­å®šä¹‰çš„ runtime å‡½æ•°ï¼›</li>
<li>Cocoa çš„ NSBundle ç±»ï¼›</li>
</ol>
<p>å…·ä½“æ“ä½œå› ä¸ºæ–‡æ¡£æ²¡æœ‰æè¿°ï¼Œæœ¬æ–‡ä¹Ÿä¸æ‰“ç®—æ‹“å±•ï¼Œè®¡åˆ’åé¢è¡¥å……ã€‚</p>
<h2 id="æ¶ˆæ¯å‘é€"><a href="#æ¶ˆæ¯å‘é€" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h2><p>åœ¨ OC ä»£ç ä¸­æˆ‘ä»¬é€šè¿‡<code>[]</code>æ¥è¡¨è¾¾ä¸€ä¸ªæ¶ˆæ¯çš„å‘é€ï¼Œæ¯”å¦‚<code>[self class]</code>ï¼Œè¿™ä¸ªè°ƒç”¨æœ€ç»ˆä¼šè¢«è½¬åŒ–ä¸º<code>objc_msgSend</code>å‡½æ•°è°ƒç”¨ã€‚</p>
<h3 id="objc-msgSendå‡½æ•°"><a href="#objc-msgSendå‡½æ•°" class="headerlink" title="objc_msgSendå‡½æ•°"></a><code>objc_msgSend</code>å‡½æ•°</h3><p><code>objc_msgSend</code>å‡½æ•°çš„è½¬æ¢å¦‚ä¸‹ï¼šå¦‚æœ OC ä¸­çš„è°ƒç”¨æ˜¯<code>[receiver message]</code>ï¼Œé‚£ä¹ˆä¼šè¢«è½¬åŒ–ä¸º<code>objc_msgSend(receiver, selector)</code>ï¼Œå…¶ä¸­ selector ä»£è¡¨çš„å°±æ˜¯ messageï¼Œå¦‚æœæœ‰å‚æ•°ï¼Œå°±ä¼šè½¬åŒ–ä¸º<code>objc_msgSend(receiver, selector, arg1, arg2, ...)</code>è°ƒç”¨æ ·å¼ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å°±å¯ä»¥å®ç°åŠ¨æ€ç»‘å®šï¼š</p>
<ol>
<li>å®ƒé¦–å…ˆä¼šæ‰¾åˆ° selector æŒ‡å‘çš„æ–¹æ³•å®ç°ã€‚ç”±äºä¸åŒçš„ç±»å¯èƒ½ä¼šå®ç°åŒæ ·çš„æ–¹æ³•ï¼ˆæŒ‡çš„æ˜¯æ–¹æ³•åå­—ä¸€æ ·ï¼‰ï¼Œå› æ­¤è¿™ä¸ªå¯»æ‰¾è¿‡ç¨‹æ˜¯ä¾èµ–äº receiver çš„ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ‰¾åˆ° receiver ä¸Šçš„è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼›</li>
<li>ä¹‹åè°ƒç”¨è¿™ä¸ªæ–¹æ³•å®ç°ï¼Œå°†å¯¹è±¡å®ä¾‹ä»¥åŠå‚æ•°ä¼ é€’ç»™æ–¹æ³•ï¼ˆä¼ é€’å¯¹è±¡å®ä¾‹æ˜¯ä¸ºäº†å¼•ç”¨å¯¹è±¡çš„å®ä¾‹å˜é‡ï¼‰ï¼›</li>
<li>æœ€ç»ˆå®ƒä¼šè¿”å›æ–¹æ³•è¿”å›çš„å€¼ï¼›</li>
</ol>
<blockquote>
<p>è‹¹æœå»ºè®®æ°¸è¿œä¸è¦è‡ªå·±å»è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p>
</blockquote>
<p>å‘é€æ¶ˆæ¯çš„å…³é”®åœ¨äºç¼–è¯‘å™¨ä¸ºæ¯ä¸€ä¸ªç±»å’Œå¯¹è±¡åˆ›å»ºçš„æ•°æ®ç»“æ„ã€‚æ¯ä¸€ä¸ªç±»éƒ½åŒ…å«ä¸¤ä¸ªå…³é”®çš„å…ƒç´ ï¼š</p>
<ul>
<li>æŒ‡å‘çˆ¶ç±»çš„æŒ‡é’ˆï¼›</li>
<li>ç±»åˆ†å‘è¡¨ã€‚è¿™å¼ è¡¨å®šä¹‰äº† selector åˆ°ç±»å®šä¹‰æ–¹æ³•çš„æ˜ å°„ã€‚</li>
</ul>
<p>æ¯ä¸€ä¸ªå¯¹è±¡å®ä¾‹åˆ›å»ºä¹‹åï¼Œéƒ½ä¼šæºå¸¦æœ‰ä¸€ä¸ªæŒ‡å‘ç±»ç»“æ„çš„æŒ‡é’ˆå˜é‡â€”â€”<code>isa</code>ã€‚è¿™ä¸ªæŒ‡é’ˆå¯ä»¥è®©å¯¹è±¡çŸ¥é“è‡ªå·±çš„ç±»å‹ä»¥åŠè‡ªå·±çš„æ‰€æœ‰çˆ¶ç±»ã€‚</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ¶ˆæ¯å‘é€æ¡†æ¶.png" width="280" alt="æ¶ˆæ¯å‘é€æ¡†æ¶"></div>

<p>å¦‚å›¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡æ¥æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯æ—¶ï¼Œ<code>objc_msgSend</code>å‡½æ•°ä¼šæ ¹æ®å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆæ‰¾åˆ°ç±»ç»“æ„ä½“ï¼Œä»è€Œæ‰¾åˆ°ç±»çš„åˆ†å‘è¡¨ï¼ŒæŸ¥è¯¢æ˜¯å¦æœ‰ selector å¯¹åº”çš„æ–¹æ³•ä½“ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ ¹æ® superclass æ‰¾åˆ°çˆ¶ç±»çš„åˆ†å‘è¡¨ï¼Œå‘¨è€Œå¤å§‹ç›´åˆ°æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ä½“ã€‚<strong>è¿™å°±æ˜¯è¿è¡Œæ—¶åŠ¨æ€ç»‘å®šæ–¹æ³•çš„æµç¨‹</strong>ã€‚</p>
<blockquote>
<p>æ‰¾ä¸åˆ°çš„å¤„ç†åé¢ä¼šæåˆ°ã€‚</p>
</blockquote>
<p>è¿™ç§å®ç°çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼šå¦‚æœæ¯æ¬¡éƒ½å»ä¸€å±‚å±‚æ‰¾ï¼Œè‚¯å®šæ¯”ç›´æ¥è¿›è¡Œæ–¹æ³•è°ƒç”¨è¦æ…¢å¾ˆå¤šï¼Œè¿™ç§å·®åˆ«å°±åƒåœ¨é“¾è¡¨å’Œæ•°ç»„ä¸­å®šä½ä¸€ä¸ªå…ƒç´ ä¸€æ ·ï¼Œä¸€ä¸ªé€šè¿‡ä¸‹æ ‡å®šä½ï¼Œä¸€ä¸ªé€šè¿‡éå†å®šä½ï¼Œå·®è·ä¸è¨€è€Œå–»ã€‚å› æ­¤åœ¨æ¯ä¸ªç±»ä¸­ä¼šæœ‰é¢å¤–çš„ç¼“å­˜ç»“æ„æ¥å­˜å‚¨è¿™ä¸ªç±»ç»å¸¸ä½¿ç”¨åˆ°çš„æ–¹æ³•â€”â€”åŒ…æ‹¬è‡ªèº«å’Œçˆ¶ç±»çš„æ–¹æ³•ã€‚å¯¹è±¡æ¯æ¬¡æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™éƒ½ä¼šé¦–å…ˆæœå¯»ç¼“å­˜ç»“æ„ï¼Œæœå¯»ä¸åˆ°æ‰ä¼šå»æœå¯»åˆ†å‘è¡¨ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç¼©å°æ¶ˆæ¯å‘é€å’Œæ–¹æ³•è°ƒç”¨ä¹‹é—´çš„é€Ÿåº¦å·®è·ã€‚åé¢è¿˜ä¼šæåˆ°åˆ«çš„æ‰‹æ®µç”¨äºç¼©å°è¿™ç§å·®è·ã€‚</p>
<blockquote>
<p>ç¼“å­˜åŸºäºå±€éƒ¨æ€§åŸç†ã€‚</p>
</blockquote>
<h3 id="éšè—çš„å‚æ•°"><a href="#éšè—çš„å‚æ•°" class="headerlink" title="éšè—çš„å‚æ•°"></a>éšè—çš„å‚æ•°</h3><p>å½“ä½¿ç”¨<code>objc_msgSend</code>å‡½æ•°ä¼ é€’æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒä¸ä»…ä¼šä¼ é€’åŸæ¥æ¶ˆæ¯çš„æ‰€æœ‰å‚æ•°ï¼Œè¿˜ä¼šé»˜è®¤ä¼ é€’ä¸¤ä¸ªé¢å¤–çš„å‚æ•°ï¼š</p>
<ol>
<li>æ¥å—å¯¹è±¡ receiverï¼›</li>
<li>è¡¨ç¤ºæ–¹æ³•çš„ selectorï¼›</li>
</ol>
<p>è¿™ä¸¤ä¸ªå‚æ•°åœ¨ç¼–è¯‘å™¨ç¼–è¯‘æ—¶è¢«â€œå·å·â€æ’å…¥ï¼Œä»è€Œä½¿å¾—<code>objc_msgSend</code>å¯ä»¥è¿˜åŸå‡ºå®Œæ•´çš„æ¶ˆæ¯å‘é€ä¿¡æ¯ï¼š</p>
<ol>
<li>æ¶ˆæ¯æ˜¯ä»€ä¹ˆï¼ˆselectorï¼‰ï¼›</li>
<li>æ¶ˆæ¯æ˜¯å‘é€ç»™è°çš„ï¼ˆreceiverï¼‰ï¼›</li>
<li>å‚æ•°æ˜¯ä»€ä¹ˆï¼›</li>
</ol>
<p>è™½ç„¶å‚æ•°æ˜¯éšå½¢çš„ï¼Œä½†æ˜¯åœ¨ä»£ç é‡Œé¢å´å¯ä»¥ä½¿ç”¨å®ƒä»¬ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯<code>self</code>å’Œ<code>_cmd</code>ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)strange &#123;</span><br><span class="line">    id  target = getTheReceiver();</span><br><span class="line">    SEL method = getTheMethod();</span><br><span class="line">    if ( target == self || method == _cmd )</span><br><span class="line">        return nil;</span><br><span class="line">    return [target performSelector:method];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ self å°±ä»£è¡¨æ¶ˆæ¯ strange æ‰€åœ¨çš„å¯¹è±¡ï¼Œ_cmd å°±è¡¨ç¤ºä»£è¡¨ strange çš„ selectorã€‚<strong>self å°±æ˜¯æ–¹æ³•ä¸ºä»€ä¹ˆå¯ä»¥æ“ä½œå¯¹è±¡å®ä¾‹å˜é‡çš„å…³é”®æ‰€åœ¨ï¼šé€šè¿‡selfï¼Œå¯ä»¥å¼•ç”¨åˆ°å¯¹è±¡æœ¬èº«ï¼Œä»è€Œå¯ä»¥å¼•ç”¨å¯¹è±¡çš„å˜é‡</strong>ã€‚</p>
<h3 id="è·å–æ–¹æ³•åœ°å€"><a href="#è·å–æ–¹æ³•åœ°å€" class="headerlink" title="è·å–æ–¹æ³•åœ°å€"></a>è·å–æ–¹æ³•åœ°å€</h3><p>åŠ¨æ€ç»‘å®šå¤„ç†æ¶ˆæ¯æ–¹æ³•çš„è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨ç¼“å­˜åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œè¿˜å¯ä»¥é€šè¿‡è·å–æ–¹æ³•åœ°å€ç›´æ¥è°ƒç”¨æ–¹æ³•çš„æ–¹å¼æ¥é¿å…åŠ¨æ€ç»‘å®šã€‚è¿™ç§æ–¹æ³•å¹¶ä¸å¸¸è§ï¼Œé™¤éä½ åœ¨çŸ­æ—¶é—´å†…éœ€è¦é«˜é¢‘æ¬¡çš„è°ƒç”¨æŸä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”ç›´æ¥è°ƒç”¨å·²ç»é€ æˆæ€§èƒ½é—®é¢˜ã€‚</p>
<p>NSObject ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨äºè·å–æ–¹æ³•åœ°å€çš„ï¼š<code>methodForSelector</code>ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥è·å¾—ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void (*setter)(id, SEL, BOOL);</span><br><span class="line">int i;</span><br><span class="line">setter = (void (*)(id, SEL, BOOL))[target</span><br><span class="line">    methodForSelector:@selector(setFilled:)];</span><br><span class="line">for ( i = 0 ; i &lt; 1000 ; i++ )</span><br><span class="line">    setter(targetList[i], @selector(setFilled:), YES);</span><br></pre></td></tr></table></figure>
<p>å£°æ˜çš„å‡½æ•°æŒ‡é’ˆä¸­ä¹Ÿæ ‡è®°é™¤äº†éšå½¢å‚æ•°ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™éœ€è¦æŠŠå¯¹åº”çš„å€¼è®¾ç½®è¿›å»ã€‚</p>
<h3 id="æ–¹æ³•åŠ¨æ€è§£æ"><a href="#æ–¹æ³•åŠ¨æ€è§£æ" class="headerlink" title="æ–¹æ³•åŠ¨æ€è§£æ"></a>æ–¹æ³•åŠ¨æ€è§£æ</h3><p>OC é™¤äº†å¯ä»¥é€šè¿‡ <code>objc_msgSend</code>å‡½æ•°åŠ¨æ€ç»‘å®šå·²æœ‰çš„æ–¹æ³•ï¼Œè¿˜å¯ä»¥é€šè¿‡å®ç°æ–¹æ³•<code>resolveInstanceMethod:</code>å’Œ<code>resolveInstanceMethod:</code>åŠ¨æ€æä¾›ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•å®ç°ã€‚<strong>OC æ–¹æ³•æœ¬è´¨ä¸Šæ¥è¯´å°±æ˜¯è‡³å°‘æ¥å— self å’Œ _cmd ä¸¤ä¸ªå‚æ•°çš„ C å‡½æ•°</strong>ã€‚é€šè¿‡è°ƒç”¨æ–¹æ³•<code>class_addMethod</code>å¯ä»¥ä¸ºç±»æ·»åŠ ä¸€ä¸ªå‡½æ•°ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void dynamicMethodIMP(id self, SEL _cmd) &#123;</span><br><span class="line">    // implementation ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@implementation MyClass</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)aSEL &#123;</span><br><span class="line">	if (aSEL == @selector(resolveThisMethodDynamically)) &#123;</span><br><span class="line">		class_addMethod([self class], aSEL, (IMP) dynamicMethodIMP, &quot;v@:&quot;);</span><br><span class="line">		return YES;</span><br><span class="line">	&#125;</span><br><span class="line">	return [super resolveInstanceMethod:aSEL];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>æ¶ˆæ¯è½¬å‘ï¼ˆåé¢ä¼šæï¼‰å’Œæ–¹æ³•åŠ¨æ€è§£æç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯æ­£äº¤çš„ï¼Œæ–¹æ³•åŠ¨æ€è§£æä¼šåœ¨æ¶ˆæ¯è½¬å‘ä¹‹å‰è¿›è¡Œã€‚å¦‚æœ<code>respondsToSelector:</code>æˆ–è€…<code>instancesRespondToSelector:</code>è¢«è°ƒç”¨ï¼Œæ–¹æ³•åŠ¨æ€è§£ææ˜¯æœ‰æœºä¼šä¸º selector æä¾›ä¸€ä¸ª IMPï¼ˆå¯ä»¥è®¤ä¸ºæ˜¯å‡½æ•°æŒ‡é’ˆï¼‰çš„ã€‚ä½†å¦‚æœæƒ³åœ¨åŠ¨æ€è§£æä¹‹åè¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼Œè¿™é‡Œå¯ä»¥è¿”å› NOã€‚</p>
<h3 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h3><p>å‰é¢æåˆ°ï¼Œ<code>objc_msgSend</code>å‡½æ•°ä¼šåœ¨åˆ†å‘è¡¨ä¸­å¯»æ‰¾ selector å¯¹åº”çš„æ–¹æ³•ä½“ï¼Œå¦‚æœæ‰¾åˆ° NSObject è¿˜æ˜¯æ‰¾ä¸åˆ°æ€ä¹ˆåŠå‘¢ï¼Ÿä¸€ç§æƒ…å†µå°±æ˜¯åŠ¨æ€æ–¹æ³•è§£æï¼Œå¦‚æœè¿”å› YESï¼Œå°±è¡¨ç¤ºå¯¹äºçš„æ–¹æ³•ä½“å·²ç»æ·»åŠ åˆ°äº†ç±»ä¸­ï¼ŒNO åˆ™ç›¸åã€‚é‚£ä¹ˆå¦‚æœæ˜¯è¿”å›æ˜¯ NOï¼Œé‚£æ˜¯ä¸æ˜¯ç¨‹åºå°±å‡ºé”™ï¼Œç›´æ¥ crash äº†å‘¢ï¼ŸOC åœ¨è¿™ä¸ªæ—¶å€™è¿˜æä¾›äº†æœ€åä¸€é“å…³å¡ï¼šåœ¨æŠ¥é”™ä¹‹å‰ï¼Œruntime ä¼šå‘æ¶ˆæ¯çš„åŸæœ¬å‘é€å¯¹è±¡å‘é€ä¸€ä¸ª<code>forwardInvocation:</code>æ¶ˆæ¯ï¼Œå¹¶æºå¸¦ä¸€ä¸ª NSInvocation å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°åŒ…è£…äº†åŸå§‹çš„æ¶ˆæ¯å’Œå‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªåœ°æ–¹å¯¹ä¸€ä¸ªæ¶ˆæ¯è¿›è¡Œæœ€åçš„å¤„ç†ã€‚</p>
<p>é¦–å…ˆé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¸€èˆ¬ç”¨äºå°†æ¶ˆæ¯è½¬å‘ç»™åˆ«çš„å¯¹è±¡ã€‚é€šè¿‡å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç»™æ¶ˆæ¯ä¸€ä¸ªé»˜è®¤çš„å“åº”ï¼Œæˆ–è€…é€šè¿‡åˆ«çš„æ‰‹æ®µæ¥é˜²æ­¢å‡ºé”™ã€‚å¦‚æœæˆ‘ä»¬ä¸å»é‡è½½è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ NSObject çš„é»˜è®¤å®ç°ï¼Œå³è°ƒç”¨<code>doesNotRecognizeSelector:</code>æ–¹æ³•ï¼Œä»è€ŒæŠ¥é”™ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    if ([someOtherObject respondsToSelector:[anInvocation selector]])</span><br><span class="line">        [anInvocation invokeWithTarget:someOtherObject];</span><br><span class="line">    else</span><br><span class="line">    	[super forwardInvocation:anInvocation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ–¹æ³•å¯ä»¥æ‰®æ¼”ä¸èƒ½è¯†åˆ«çš„æ¶ˆæ¯çš„è½¬å‘ä¸­å¿ƒï¼Œæˆ–è€…ä½œä¸ºä¸€ä¸ªä¸­è½¬ç«™ï¼Œå°†æ‰€æœ‰çš„æ¶ˆæ¯è½¬å‘åˆ°ä¸€ä¸ªç‰¹å®šçš„å¯¹è±¡ï¼›ä¹Ÿå¯ä»¥å°†ä¸€ä¸ªæ¶ˆæ¯è½¬æ¢ä¸ºåˆ«çš„æ¶ˆæ¯ï¼Œç”šè‡³ç›´æ¥åæ²¡ä¸€äº›æ¶ˆæ¯ï¼Œä»¥é¿å…é”™è¯¯å‘ç”Ÿã€‚ç®€è€Œè¨€ä¹‹ï¼Œæœªè¢«è¯†åˆ«çš„æ¶ˆæ¯ä»¥åŠæœªèƒ½åŠ¨æ€è§£æçš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬åˆ°è¿™é‡Œè¿›è¡Œå¤„ç†ï¼Œå› æ­¤è¿™é‡Œå¯ä»¥æœ‰å¾ˆå¤šç©æ³•ï¼Œæ¯”å¦‚å¤šç»§æ‰¿æ¨¡æ‹Ÿï¼Œæ¯”å¦‚å®ç°ä»£ç†ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šæƒ³è¦è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿˜éœ€è¦é‡è½½å¦å¤–ä¸€ä¸ªæ–¹æ³•<code>methodSignatureForSelector:</code>ï¼Œè¯¦ç»†è§ä¸‹é¢ä¾‹å­ã€‚</p>
</blockquote>
<p>é™¤äº†<code>forwardInvocation</code>è¿™ä¸ªæ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥æ‰®æ¼”è¿™ä¸ªè§’è‰²â€”â€”<code>forwardingTargetForSelector:</code>ã€‚è¿™ä¸ªæ–¹æ³•é€šè¿‡è¿”å›ä¸€ä¸ªæ¶ˆæ¯çš„æ¥æ”¶è€…æ¥å®Œæˆå¯¹æ¶ˆæ¯çš„è½¬å‘ï¼Œåé¢ç¤ºä¾‹ä¼šç»™å‡ºç”¨æ³•ã€‚</p>
<h4 id="æ¶ˆæ¯è½¬å‘æ¨¡æ‹Ÿå¤šç»§æ‰¿"><a href="#æ¶ˆæ¯è½¬å‘æ¨¡æ‹Ÿå¤šç»§æ‰¿" class="headerlink" title="æ¶ˆæ¯è½¬å‘æ¨¡æ‹Ÿå¤šç»§æ‰¿"></a>æ¶ˆæ¯è½¬å‘æ¨¡æ‹Ÿå¤šç»§æ‰¿</h4><p>æ¶ˆæ¯è½¬å‘æ˜¯å¯ä»¥æ¨¡æ‹Ÿå‡ºå¤šç»§æ‰¿çš„ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ¶ˆæ¯è½¬å‘.png" width="320" alt="æ¶ˆæ¯è½¬å‘"></div>

<p>Warrior é€šè¿‡æŠŠ negotiate æ–¹æ³•è½¬å‘ç»™ Diplomatï¼Œçœ‹ä¸Šå»å°±åƒæ˜¯ç»§æ‰¿äº† Diplomatï¼Œå¦å¤–ä¸€æ–¹é¢ Warrior æœ¬èº«å°±ç»§æ‰¿äº† NSObjectï¼Œä»è€Œå°±å…·å¤‡äº†ä¸¤æ¡ç»§æ‰¿çº¿ã€‚</p>
<blockquote>
<p>è¿™ç§å¤šç»§æ‰¿çš„â€œæ¨¡æ‹Ÿâ€å…¶å®å°±æ˜¯ç»„åˆçš„ä¸€ä¸ªå˜ç§ï¼Œåªä¸è¿‡å®ç°èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚</p>
</blockquote>
<p>å®é™…ä¸Šè¦å®Œå…¨æ¨¡æ‹Ÿå¤šç»§æ‰¿å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å¾ˆå¤šé»˜è®¤çš„å†…çœå‡½æ•°æ¥è¿›ä¸€æ­¥å®Œå–„è¿™ç§æ¨¡æ‹Ÿï¼Œæ¯”å¦‚:</p>
<ul>
<li><code>respondsToSelector:</code></li>
<li><code>isKindOfClass:</code></li>
<li><code>nstancesRespondToSelector:</code></li>
<li><code>methodSignatureForSelector:</code></li>
<li><code>methodSignatureForSelector:</code></li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)respondsToSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    if ( [super respondsToSelector:aSelector] )</span><br><span class="line">        return YES;</span><br><span class="line">    else &#123;</span><br><span class="line">        /* Here, test whether the aSelector message can     *</span><br><span class="line">         * be forwarded to another object and whether that  *</span><br><span class="line">         * object can respond to it. Return YES if it can.  */</span><br><span class="line">    &#125;</span><br><span class="line">	return NO; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>å‰é¢æè¿°äº†æ¶ˆæ¯å¤„ç†çš„è¿‡ç¨‹ï¼Œæ€»å…±åŒ…æ‹¬ä¸‰ç§æ–¹å¼ï¼š</p>
<ol>
<li>åˆ†å‘è¡¨ï¼›</li>
<li>åŠ¨æ€è§£æï¼›</li>
<li>æ¶ˆæ¯è½¬å‘ï¼›</li>
</ol>
<p>ä¸‹é¢ç»™ä¸€ä¸ªä¾‹å­å®è·µä¸€ä¸‹ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…å’Œæ–¹ä¾¿é˜…è¯»ï¼Œh å’Œ m å°±å†™åœ¨ä¸€ä¸ªä»£ç å—é‡Œé¢äº†ã€‚é¦–å…ˆå£°æ˜ MsgTest ç±»ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@interface MsgTest : NSObject</span><br><span class="line">-(void)realMethod;</span><br><span class="line">@end</span><br><span class="line">  </span><br><span class="line">void dynamicMethodIMP(id self, SEL _cmd) &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, @&quot;Dynamic Resolving.&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@interface MsgTest ()</span><br><span class="line">@property(nonatomic, strong) MsgResovler *msgResolver;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation MsgTest</span><br><span class="line">@synthesize msgResolver;</span><br><span class="line"></span><br><span class="line">-(instancetype)init&#123;</span><br><span class="line">    if(self = [super init])&#123;</span><br><span class="line">        msgResolver = [[MsgResovler alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)realMethod&#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, @&quot;Real Method&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)aSEL &#123;</span><br><span class="line">    if (aSEL == @selector(resolveThisMethodDynamically)) &#123;</span><br><span class="line">        class_addMethod([self class], aSEL, (IMP) dynamicMethodIMP, &quot;v@:&quot;);</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return [super resolveInstanceMethod:aSEL];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    if (aSelector == @selector(forwardTarget)) &#123;</span><br><span class="line">        return msgResolver; // è¿”å›å®é™…å¤„ç†å¯¹è±¡</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    if ([msgResolver respondsToSelector:[anInvocation selector]])</span><br><span class="line">        [anInvocation invokeWithTarget:msgResolver];</span><br><span class="line">    else</span><br><span class="line">        [super forwardInvocation:anInvocation];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ¶ˆæ¯è½¬å‘çš„æ—¶å€™ï¼Œä¸è¦å¿˜äº†å®ç°è¿™ä¸ªæ–¹æ³•</span><br><span class="line">- (NSMethodSignature*)methodSignatureForSelector:(SEL)selector</span><br><span class="line">&#123;</span><br><span class="line">    NSMethodSignature* signature = [super methodSignatureForSelector:selector];</span><br><span class="line">    if (!signature) &#123;</span><br><span class="line">        signature = [msgResolver methodSignatureForSelector:selector];</span><br><span class="line">    &#125;</span><br><span class="line">    return signature;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯æ ¸å¿ƒç±»ï¼Œä¼šæ ¹æ®å‰é¢æåˆ°çš„æ¶ˆæ¯å¤„ç†æ–¹å¼åˆ†åˆ«æ¥å—å››ç§æ¶ˆæ¯ï¼Œæ¥ç€ä¸ºæ¶ˆæ¯è½¬å‘å£°æ˜æ¶ˆæ¯æ¥å—ç±» MsgResovlerï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@interface MsgResovler : NSObject</span><br><span class="line">-(void)forwardMsg;</span><br><span class="line">-(void)forwardTarget;</span><br><span class="line">@end</span><br><span class="line">  </span><br><span class="line">@implementation MsgResovler</span><br><span class="line">-(void)forwardMsg &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, @&quot;Forwarded Msg&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)forwardTarget&#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, @&quot;Forwarding Target&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>æœ€åå°è¯•è°ƒç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        MsgTest *msgTest = [[MsgTest alloc] init];</span><br><span class="line">        NSLog(@&quot;%@&quot;, @&quot;============= çœŸå®æ–¹æ³• =============&quot;);</span><br><span class="line">        [msgTest realMethod];</span><br><span class="line">        NSLog(@&quot;%@&quot;, @&quot;============= åŠ¨æ€è§£æ =============&quot;);</span><br><span class="line">        [msgTest performSelector:@selector(resolveThisMethodDynamically)];</span><br><span class="line">        NSLog(@&quot;%@&quot;, @&quot;============= æ¶ˆæ¯è½¬å‘ =============&quot;);</span><br><span class="line">        [msgTest performSelector:@selector(forwardMsg)];</span><br><span class="line">      	NSLog(@&quot;%@&quot;, @&quot;============= æ¶ˆæ¯è½¬å‘ =============&quot;);</span><br><span class="line">        [msgTest performSelector:@selector(forwardTarget)];</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°±å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">============= çœŸå®æ–¹æ³• =============</span><br><span class="line">Real Method</span><br><span class="line">============= åŠ¨æ€è§£æ =============</span><br><span class="line">Dynamic Resolving.</span><br><span class="line">============= æ¶ˆæ¯è½¬å‘ =============</span><br><span class="line">Forwarded Msg</span><br><span class="line">============= æ¶ˆæ¯è½¬å‘ =============</span><br><span class="line">Forwarding Target</span><br><span class="line">Program ended with exit code: 0</span><br></pre></td></tr></table></figure>
<p>å››ä¸ªæ–¹æ³•éƒ½é¡ºåˆ©å®Œæˆè°ƒç”¨ï¼Œæ²¡æœ‰æŠ¥é”™ã€‚é‚£ä¹ˆè¿™å‡ ç§æ–¹æ³•çš„è°ƒç”¨é¡ºåºæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿå€Ÿç”¨ç½‘ä¸Šä¸€å¹…å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ¶ˆæ¯å‘é€è·¯çº¿.png" width="360" alt="æ¶ˆæ¯è½¬å‘è·¯çº¿"></div>

<p>ä¸€ç›®äº†ç„¶ã€‚</p>
<h2 id="å±æ€§å†…çœ"><a href="#å±æ€§å†…çœ" class="headerlink" title="å±æ€§å†…çœ"></a>å±æ€§å†…çœ</h2><h3 id="Type-Encoding"><a href="#Type-Encoding" class="headerlink" title="Type Encoding"></a>Type Encoding</h3><p>åœ¨è¯´å±æ€§å†…çœä¹‹å‰ï¼Œéœ€è¦å…ˆè¯´ä¸€ä¸ªæ¦‚å¿µâ€”â€”Type Encodingã€‚Type Encoding å®é™…æ˜¯ç”¨äºè¡¨è¾¾æ–¹æ³•è¿”å›å€¼å’Œå‚æ•°çš„ç®€æ´è¡¨è¾¾å¼ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡<code>@encode()</code>ç¼–è¯‘å‘½ä»¤å¯¹æŸä¸€ä¸ªç‰¹å®šç±»å‹è¿›è¡Œè½¬åŒ–ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">char *buf1 = @encode(int **);//^^i</span><br><span class="line">char *buf2 = @encode(struct key);//è¦çœ‹keyå†…å®¹</span><br><span class="line">char *buf3 = @encode(Rectangle);//è¦çœ‹Rectangleç±»</span><br></pre></td></tr></table></figure>
<p>å…·ä½“å¯¹åº”åˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">Code</th>
<th style="text-align:center">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">c</td>
<td style="text-align:center">A char</td>
</tr>
<tr>
<td style="text-align:center">i</td>
<td style="text-align:center">An int</td>
</tr>
<tr>
<td style="text-align:center">s</td>
<td style="text-align:center">A short</td>
</tr>
<tr>
<td style="text-align:center">l</td>
<td style="text-align:center">A long</td>
</tr>
<tr>
<td style="text-align:center">q</td>
<td style="text-align:center">A long long</td>
</tr>
<tr>
<td style="text-align:center">C</td>
<td style="text-align:center">An unsigned char</td>
</tr>
<tr>
<td style="text-align:center">I</td>
<td style="text-align:center">An unsigned int</td>
</tr>
<tr>
<td style="text-align:center">S</td>
<td style="text-align:center">An unsigned short</td>
</tr>
<tr>
<td style="text-align:center">L</td>
<td style="text-align:center">An unsigned long</td>
</tr>
<tr>
<td style="text-align:center">Q</td>
<td style="text-align:center">An unsigned long long</td>
</tr>
<tr>
<td style="text-align:center">f</td>
<td style="text-align:center">A float</td>
</tr>
<tr>
<td style="text-align:center">d</td>
<td style="text-align:center">A double</td>
</tr>
<tr>
<td style="text-align:center">B</td>
<td style="text-align:center">A C++ bool or C99_Bool</td>
</tr>
<tr>
<td style="text-align:center">v</td>
<td style="text-align:center">A void</td>
</tr>
<tr>
<td style="text-align:center">*</td>
<td style="text-align:center">A character string(char *)</td>
</tr>
<tr>
<td style="text-align:center">@</td>
<td style="text-align:center">An object(whether statically typed or typed id)</td>
</tr>
<tr>
<td style="text-align:center">#</td>
<td style="text-align:center">A class object(Class)</td>
</tr>
<tr>
<td style="text-align:center">:</td>
<td style="text-align:center">A method selector(SEL)</td>
</tr>
<tr>
<td style="text-align:center">[array type]</td>
<td style="text-align:center">An array</td>
</tr>
<tr>
<td style="text-align:center">{name=typeâ€¦}</td>
<td style="text-align:center">A structure</td>
</tr>
<tr>
<td style="text-align:center">(name=typeâ€¦)</td>
<td style="text-align:center">A union</td>
</tr>
<tr>
<td style="text-align:center">bnum</td>
<td style="text-align:center">A bit bield of num bits</td>
</tr>
<tr>
<td style="text-align:center">^type</td>
<td style="text-align:center">A pointer</td>
</tr>
<tr>
<td style="text-align:center">?</td>
<td style="text-align:center">An unknown type(among other things, this code is used for function pointers)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>æ³¨æ„ï¼šOC ä¸æ”¯æŒ long double ç±»å‹ï¼Œ@encode(long double) ä¼šè¿”å› dï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«å½“åš double æ‰§è¡Œã€‚</p>
</blockquote>
<p>ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">ä¾‹å­</th>
<th style="text-align:center">è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">[12^f]</td>
<td style="text-align:center">ä¸€ä¸ªåŒ…å«12ä¸ªæŒ‡å‘ float å…ƒç´ çš„æŒ‡é’ˆçš„æ•°ç»„</td>
</tr>
<tr>
<td style="text-align:center">{example=@*i}</td>
<td style="text-align:center">ä¸€ä¸ªåŒ…å«å¯¹è±¡ã€charæŒ‡é’ˆå’Œintå€¼çš„ç»“æ„ä½“ï¼Œåä¸ºexample</td>
</tr>
<tr>
<td style="text-align:center">^{example=@*i}</td>
<td style="text-align:center">ä¸Šè¿°ç»“æ„ä½“çš„æŒ‡é’ˆ</td>
</tr>
<tr>
<td style="text-align:center">^^{example}</td>
<td style="text-align:center">ä¸Šè¿°æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œè¿™æ—¶å€™å¯ä»¥å¿½ç•¥ç»“æ„ä½“å†…å®¹</td>
</tr>
<tr>
<td style="text-align:center">{NSObject=# }</td>
<td style="text-align:center">å¯¹è±¡ä¼šè¢«å½“åšç»“æ„ä½“å¯¹å¾…ï¼Œ@encode(NSObject)å°±ä¼šäº§ç”Ÿå·¦è¾¹çš„è¡¨è¾¾å¼ï¼ŒNSObject çš„å¯¹è±¡å®ä¾‹åªæœ‰ä¸€ä¸ª Class ç±»å‹çš„ isa æŒ‡é’ˆã€‚</td>
</tr>
</tbody>
</table>
<blockquote>
<p>å…³äº@encode{NSObject}ï¼Œè¾“å‡ºçš„å…¶å®æ˜¯NSObjectè¿™ä¸ªç±»å®ƒçš„å®ä¾‹çš„è¡¨è¾¾å¼ï¼šåŒ…å«ä¸€ä¸ª isa æŒ‡é’ˆä»¥åŠå±æ€§ã€‚</p>
</blockquote>
<h3 id="Property-ç±»å‹å’Œå‡½æ•°"><a href="#Property-ç±»å‹å’Œå‡½æ•°" class="headerlink" title="Property ç±»å‹å’Œå‡½æ•°"></a>Property ç±»å‹å’Œå‡½æ•°</h3><p>å½“ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ property çš„æ—¶å€™ï¼Œå®ƒä¼šäº§ç”Ÿä¸€äº›ä¸ç±»ã€Categoryä»¥åŠåè®®ç›¸å…³çš„æè¿°å…ƒæ•°æ®ã€‚OC æä¾›äº†ä¸€äº›å‡½æ•°å¯ä»¥é€šè¿‡åå­—æœç´¢ç±»æˆ–è€…åè®®ä¸Šçš„ propertyï¼Œä»è€Œè·å–è¿™äº›å…ƒæ•°æ®ã€‚</p>
<p>Property å®é™…æ˜¯ä¸€ä¸ª objc_property æŒ‡é’ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_property *Property;</span><br></pre></td></tr></table></figure>
<p>å¼€å‘è€…å¯ä»¥é€šè¿‡<code>class_copyPropertyList</code>å’Œ<code>protocol_copyPropertyList</code>ä¸¤ä¸ªå‡½æ•°æ¥è·å–ç±»/åè®®çš„å±æ€§æ•°ç»„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objc_property_t *class_copyPropertyList(Class cls, unsigned int *outCount)</span><br><span class="line">objc_property_t *protocol_copyPropertyList(Protocol *proto, unsigned int *outCount)</span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå£°æ˜å¦‚ä¸‹ä¸€ä¸ªç±»ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@interface Lender : NSObject &#123;</span><br><span class="line">    float ins;</span><br><span class="line">&#125;</span><br><span class="line">@property float alone;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å¦‚ä¸‹æ–¹æ³•å¯ä»¥è·å–å±æ€§åˆ—è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id LenderClass = objc_getClass(&quot;Lender&quot;);</span><br><span class="line">unsigned int outCount;</span><br><span class="line">objc_property_t *properties = class_copyPropertyList(LenderClass, &amp;outCount);</span><br></pre></td></tr></table></figure>
<p>è·å–å±æ€§ä¹‹åï¼Œå¯ä»¥æ ¹æ®<code>property_getName</code>æ¥è·å–å±æ€§åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const char *property_getName(objc_property_t property)</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æŒ‡å®šæŸä¸ªç±»çš„æŸä¸ªå±æ€§åå­—ï¼Œä¹Ÿå¯ä»¥è·å–åˆ°ä¸€ä¸ªå±æ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objc_property_t class_getProperty(Class cls, const char *name)</span><br><span class="line">objc_property_t protocol_getProperty(Protocol *proto, const char *name, BOOL</span><br><span class="line">isRequiredProperty, BOOL isInstanceProperty)</span><br></pre></td></tr></table></figure>
<p>æ¥ç€è°ƒç”¨<code>property_getAttributes</code>å‡½æ•°å¯ä»¥è·å–å±æ€§çš„åå­—ä»¥åŠ @encode ç±»å‹å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const char *property_getAttributes(objc_property_t property)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>@encode ç±»å‹å­—ç¬¦ä¸² å¯ä»¥å‚è§<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101-SW1" target="_blank" rel="noopener">Property Type String</a>å’Œ<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101-SW1" target="_blank" rel="noopener">Property Attribute Description Examples</a>ã€‚</p>
</blockquote>
<p>æŠŠè¿™äº›ä»£ç èåˆåœ¨ä¸€å—å„¿ï¼Œå°±å¯ä»¥è·å¾—ä¸€ä¸ªç±»/åè®®çš„æ‰€æœ‰å±æ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">id LenderClass = objc_getClass(&quot;Lender&quot;);</span><br><span class="line">unsigned int outCount, i;</span><br><span class="line">objc_property_t *properties = class_copyPropertyList(LenderClass, &amp;outCount);</span><br><span class="line">for (i = 0; i &lt; outCount; i++) &#123;</span><br><span class="line">	objc_property_t property = properties[i];</span><br><span class="line">	fprintf(stdout, &quot;%s %s\n&quot;, property_getName(property), property_getAttributes(property));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alone Tf,V_alone</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®è·µç»“æœè¡¨æ˜ï¼šCategory ä¸­çš„å±æ€§ä¼šè¢«ä¸€å¹¶æ‰“å°ï¼Œè€Œå®ä¾‹å˜é‡ä¸ä¼šè¢«æ‰“å°ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048-CH1-SW1" target="_blank" rel="noopener">ã€ŠObjC Runtime Guideã€‹</a>æ˜¯å­¦ä¹  Runtime çš„å…¥é—¨è¯»ç‰©ï¼Œæœ¬æ–‡æ˜¯è¯¥æ–‡æ¡£çš„é˜…è¯»ç¬”è®°ï¼Œä¸»è¦ç›®çš„æ˜¯ææ¸…æ¥šä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>ä»€ä¹ˆæ˜¯ Runtimeï¼›</li>
<li>Runtime èƒ½åšä»€ä¹ˆï¼›</li>
</ol>
<p>é™¤æ­¤ä¹‹å¤–æ²¡æœ‰ä»»ä½•çš„æ¢ç©¶æ‹“å±•ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œåç»­ä¼šæ¢ç´¢ Runtime æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯æœ¬æ–‡æåˆ°çš„å‡½æ•°å’Œæ•°æ®ç»“æ„ï¼Œè¿›è€Œå‘ç° Runtime æ›´ä¸ºæœ¬è´¨çš„å†…åœ¨å’Œæ›´ä¸ºå¼ºå¤§çš„ç”¨æ³•ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidå¡é¡¿ç›‘æ§æ–¹æ¡ˆä»¥åŠå±€é™æ€§]]></title>
      <url>http://www.timebridge.space/2016/12/08/Android%E5%8D%A1%E9%A1%BF%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%E4%BB%A5%E5%8F%8A%E5%B1%80%E9%99%90%E6%80%A7/</url>
      <content type="html"><![CDATA[<h2 id="æ–¹æ¡ˆä»‹ç»"><a href="#æ–¹æ¡ˆä»‹ç»" class="headerlink" title="æ–¹æ¡ˆä»‹ç»"></a>æ–¹æ¡ˆä»‹ç»</h2><p>æœ€æ—©åœ¨ QQ ç©ºé—´å›¢é˜Ÿçš„å¾®ä¿¡å…¬ä¼—å·ä¸Šçœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼š<a href="http://mp.weixin.qq.com/s/40br55yHjABd5RALf5BO0g" target="_blank" rel="noopener">Androidå¡æ…¢ç›‘æ§ç»„ä»¶ç®€ä»‹</a>ï¼Œä»‹ç»äº†ä¸€ç§ç›‘æ§Androidåº”ç”¨å¡é¡¿çš„æ€è·¯ã€‚åŸç†éå¸¸ç®€å•ï¼šåœ¨<code>Looper.loop()</code>æ–¹æ³•å†…ï¼Œæœ‰ä¸€æ®µè¿™æ ·çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line"><span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">	logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</span><br><span class="line">		msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msg.target.dispatchMessage(msg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">	logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å°±æ˜¯æ¶ˆæ¯å¾ªç¯æœºåˆ¶ä¸­å¤„ç†æ¶ˆæ¯çš„æ ¸å¿ƒä»£ç ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒï¼š<a href="http://muzileecoding.com/2015/11/23/Android-Handler/" target="_blank" rel="noopener">Handleræºç åˆ†æ</a>ã€‚<a id="more"></a>åœ¨å¤„ç†æ¶ˆæ¯å‰åï¼Œéƒ½è°ƒç”¨äº†loggingå¯¹è±¡æ‰“å°æ¶ˆæ¯æ—¥å¿—ï¼Œå¹¶ä¸”Looperä¸­çš„æ¶ˆæ¯å¯¹è±¡æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œå› æ­¤æ€è·¯å°±æ˜¯æˆ‘ä»¬è‡ªå·±å¼€å‘ä¸€ä¸ªloggingå¯¹è±¡ï¼Œé€šè¿‡ç›‘æ§è¿™ä¸¤æ®µæ—¥å¿—æ‰“å°æ¥ç»Ÿè®¡<code>dispatchMessage</code>æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ã€‚ä¸»çº¿ç¨‹ä¸Šå¦‚æœèƒ½ä¿è¯æ¯ä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†æ—¶é—´åœ¨16msä»¥å†…ï¼Œå°±å¯ä»¥ä¿è¯ä¸å¡é¡¿ã€‚</p>
<blockquote>
<p>å®é™…ä¸Šåº”è¯¥è®¾ç½®çš„é˜ˆå€¼åº”å½“è¿œå¤§äº16msï¼Œå› ä¸ºè¯¸å¦‚Activityåˆ›å»ºè¿™æ ·çš„åŠ¨ä½œï¼Œæ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œè€Œä¸”è¿™ç§æƒ…å†µä¸‹åªè¦ä¸å‡ºç°é»‘å±ä¹‹ç±»çš„é—®é¢˜ï¼Œç”¨æˆ·ä¸ä¼šè§‰å¾—å¡é¡¿ã€‚</p>
</blockquote>
<p>åæ¥å‘ç°å·²ç»æœ‰ç›¸å…³çš„å®ç°åº“äº†ï¼Œè¿™å°±æ˜¯<a href="https://github.com/markzhai/AndroidPerformanceMonitor" target="_blank" rel="noopener">BlockCanary</a>ã€‚å®ƒçš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">println</span><span class="params">(String x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!mPrintingStarted) &#123;</span><br><span class="line">		mStartTimestamp = System.currentTimeMillis();</span><br><span class="line">		mStartThreadTimestamp = SystemClock.currentThreadTimeMillis();</span><br><span class="line">		mPrintingStarted = <span class="keyword">true</span>;</span><br><span class="line">		startDump();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">		mPrintingStarted = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (isBlock(endTime)) &#123;</span><br><span class="line">			notifyBlockEvent(endTime);</span><br><span class="line">		&#125;</span><br><span class="line">		stopDump();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ç›‘æ§ä¸¤æ¬¡æ‰“å°ï¼Œåˆ¤æ–­äº‹ä»¶æ˜¯å¦è¶…å‡ºé˜ˆå€¼ï¼Œè¶…å‡ºåˆ™å›è°ƒ Block äº‹ä»¶ï¼Œå¹¶æ‰“å°ç›¸å…³çš„ CPU ä¿¡æ¯ã€æ ˆä¿¡æ¯ä»¥è¾…åŠ©è§£å†³é—®é¢˜ã€‚</p>
<p>ä»¥ä¸Šæ–¹æ¡ˆå¯ä»¥è¯´æœ‰ä¸€ç‚¹æŠ•æœºå–å·§ï¼Œå®ƒæœ‰å±€é™æ€§çš„ã€‚</p>
<h2 id="Loggerå˜åŒ–æ€ä¹ˆåŠï¼Ÿ"><a href="#Loggerå˜åŒ–æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="Loggerå˜åŒ–æ€ä¹ˆåŠï¼Ÿ"></a>Loggerå˜åŒ–æ€ä¹ˆåŠï¼Ÿ</h2><p>å¦‚æœæŸå¤© Android ç³»ç»Ÿä¸å†è°ƒç”¨è¿™æ®µ Loggerï¼Œæˆ–è€…åœ¨åˆ«çš„åœ°æ–¹ä¹Ÿæ‰“å° Loggerï¼Œå¾ˆå®¹æ˜“çœ‹åˆ° BlockCanary çš„æ–¹æ¡ˆå°±ä¼šå¤±æ•ˆã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯»è€…å¯èƒ½ä¼šå¿½ç•¥å‰é¢å±•ç¤ºçš„ Looper çš„é‚£æ®µä»£ç çš„ä¸€ä¸ªå°æ³¨é‡Šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br></pre></td></tr></table></figure>
<p>UI æ—¶é—´å¯èƒ½ä¹Ÿä¼šè®¾ç½®è¿™ä¸ª loggerï¼Œå› æ­¤ä¾èµ– Logger å¹¶ä¸é è°±ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ <a href="https://github.com/mmin18/SafeLooper" target="_blank" rel="noopener">SafeLooper</a>ã€‚</p>
<p>SafeLooper é€šè¿‡åœ¨ä¸»çº¿ç¨‹é˜Ÿåˆ—ä¸­å¡å…¥ä¸€ä¸ªå¯ä»¥æ‰˜ç®¡ä¸»çº¿ç¨‹åç»­æ¶ˆæ¯çš„é˜»å¡æ¶ˆæ¯ï¼Œå¯ä»¥åœ¨åº”ç”¨å†…éƒ¨æ‰§è¡Œï¼š</p>
<p><code>h.dispatchMessage(msg);</code></p>
<p>è¿™æ®µä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥å®Œå…¨ä¸ä¾èµ–Loggeræ¥ç»Ÿè®¡æ—¶é—´ã€‚</p>
<h2 id="å¦‚æœå¡é¡¿æ—¶é—´éå¸¸éå¸¸é•¿æ€ä¹ˆåŠï¼Ÿ"><a href="#å¦‚æœå¡é¡¿æ—¶é—´éå¸¸éå¸¸é•¿æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="å¦‚æœå¡é¡¿æ—¶é—´éå¸¸éå¸¸é•¿æ€ä¹ˆåŠï¼Ÿ"></a>å¦‚æœå¡é¡¿æ—¶é—´éå¸¸éå¸¸é•¿æ€ä¹ˆåŠï¼Ÿ</h2><p>BlockCanary æ˜¯éœ€è¦ä¾èµ–ä¸¤æ¬¡ Logger çš„è°ƒç”¨æ‰èƒ½å®Œæˆç›‘æ§æ—¥å¿—çš„è¾“å‡ºçš„ï¼Œé‚£å¦‚æœ <code>dispatchMessage</code>æ–¹æ³•æ°¸è¿œä¸è¿”å›ï¼Œæ¯”å¦‚é»‘å±äº†æ€ä¹ˆç›‘æ§å‘¢ï¼Ÿ</p>
<p>è¿™éœ€è¦å¦å¤–å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨å›ºå®šæ—¶é—´ä¹‹åå®Œæˆç›‘æ§ï¼Œç®€å•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">println</span><span class="params">(String x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mPrintingStarted) &#123;</span><br><span class="line">        mStartTimestamp = System.currentTimeMillis();</span><br><span class="line">        mStartThreadTimestamp = SystemClock.currentThreadTimeMillis();</span><br><span class="line">        mPrintingStarted = <span class="keyword">true</span>;</span><br><span class="line">        startDump();</span><br><span class="line">        monitorHandler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">                notifyBlockEvent(endTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, mBlockThresholdMillis * <span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        monitorHandler.removeCallbacksAndMessages(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">        mPrintingStarted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (isBlock(endTime)) &#123;</span><br><span class="line">            notifyBlockEvent(endTime);</span><br><span class="line">        &#125;</span><br><span class="line">        stopDump();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å³ä½¿å®Œå…¨å¡æ­»ï¼Œä¹Ÿå¯ä»¥è·å–ç›‘æ§ä¿¡æ¯ã€‚</p>
<h2 id="Applicationå¦‚ä½•ç›‘æ§"><a href="#Applicationå¦‚ä½•ç›‘æ§" class="headerlink" title="Applicationå¦‚ä½•ç›‘æ§"></a>Applicationå¦‚ä½•ç›‘æ§</h2><blockquote>
<p>è¿™ä¸ªé—®é¢˜å’Œå‰é¢ä¸€ä¸ªé—®é¢˜å¯èƒ½æœ€åˆä¸åœ¨è¿™ä¸ªæ–¹æ¡ˆçš„è®¾è®¡è€…çš„ç›®æ ‡ä¹‹å†…ï¼Œä½†å¦‚æœèƒ½è¿›ä¸€æ­¥æ‰©å……ï¼Œæ•´ä¸ªæ–¹æ¡ˆä¼šæ›´åŠ å¥å…¨ã€‚</p>
</blockquote>
<p>åœ¨å®é™…å®éªŒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼ŒApplication çš„<code>onCreate()</code>æ–¹æ³•æ˜¯æ— æ³•ç›‘æ§çš„ï¼Œä¸è®ºæ˜¯åœ¨<code>onCreate()</code>çš„ç¬¬ä¸€è¡Œï¼Œè¿˜æ˜¯åœ¨ Application çš„æ„é€ å‡½æ•°ä¸­è°ƒç”¨éƒ½åšä¸åˆ°ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ‰“å°ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨å †æ ˆä¿¡æ¯ï¼š</p>
<p>ã€æ„é€ å‡½æ•°ã€‘</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">12-07 20:51:41.547 I/System.out: *******************************************</span><br><span class="line">12-07 20:51:41.547 I/System.out: stacktrace len:16</span><br><span class="line">12-07 20:51:41.547 I/System.out: ----  the 0 element  ----</span><br><span class="line">12-07 20:51:41.547 I/System.out: toString: dalvik.system.VMStack.getThreadStackTrace(Native Method)</span><br><span class="line">12-07 20:51:41.547 I/System.out: ClassName: dalvik.system.VMStack</span><br><span class="line">12-07 20:51:41.547 I/System.out: FileName: VMStack.java</span><br><span class="line">12-07 20:51:41.547 I/System.out: LineNumber: -2</span><br><span class="line">12-07 20:51:41.547 I/System.out: MethodName: getThreadStackTrace</span><br><span class="line">12-07 20:51:41.547 I/System.out: ----  the 1 element  ----</span><br><span class="line">12-07 20:51:41.547 I/System.out: toString: java.lang.Thread.getStackTrace(Thread.java:580)</span><br><span class="line">12-07 20:51:41.547 I/System.out: ClassName: java.lang.Thread</span><br><span class="line">12-07 20:51:41.547 I/System.out: FileName: Thread.java</span><br><span class="line">12-07 20:51:41.547 I/System.out: LineNumber: 580</span><br><span class="line">12-07 20:51:41.547 I/System.out: MethodName: getStackTrace</span><br><span class="line">12-07 20:51:41.547 I/System.out: ----  the 2 element  ----</span><br><span class="line">12-07 20:51:41.547 I/System.out: toString: com.example.blockcanary.DemoApplication.<span class="tag">&lt;<span class="name">init</span>&gt;</span>(DemoApplication.java:31)</span><br><span class="line">12-07 20:51:41.547 I/System.out: ClassName: com.example.blockcanary.DemoApplication</span><br><span class="line">12-07 20:51:41.547 I/System.out: FileName: DemoApplication.java</span><br><span class="line">12-07 20:51:41.547 I/System.out: LineNumber: 31</span><br><span class="line">12-07 20:51:41.547 I/System.out: MethodName: <span class="tag">&lt;<span class="name">init</span>&gt;</span></span><br><span class="line">12-07 20:51:41.547 I/System.out: ----  the 3 element  ----</span><br><span class="line">12-07 20:51:41.547 I/System.out: toString: java.lang.Class.newInstance(Native Method)</span><br><span class="line">12-07 20:51:41.547 I/System.out: ClassName: java.lang.Class</span><br><span class="line">12-07 20:51:41.547 I/System.out: FileName: Class.java</span><br><span class="line">12-07 20:51:41.547 I/System.out: LineNumber: -2</span><br><span class="line">12-07 20:51:41.547 I/System.out: MethodName: newInstance</span><br><span class="line">12-07 20:51:41.547 I/System.out: ----  the 4 element  ----</span><br><span class="line">12-07 20:51:41.547 I/System.out: toString: android.app.Instrumentation.newApplication(Instrumentation.java:996)</span><br><span class="line">12-07 20:51:41.547 I/System.out: ClassName: android.app.Instrumentation</span><br><span class="line">12-07 20:51:41.547 I/System.out: FileName: Instrumentation.java</span><br><span class="line">12-07 20:51:41.547 I/System.out: LineNumber: 996</span><br><span class="line">12-07 20:51:41.547 I/System.out: MethodName: newApplication</span><br><span class="line">12-07 20:51:41.547 I/System.out: ----  the 5 element  ----</span><br><span class="line">12-07 20:51:41.547 I/System.out: toString: android.app.Instrumentation.newApplication(Instrumentation.java:981)</span><br><span class="line">12-07 20:51:41.547 I/System.out: ClassName: android.app.Instrumentation</span><br><span class="line">12-07 20:51:41.547 I/System.out: FileName: Instrumentation.java</span><br><span class="line">12-07 20:51:41.547 I/System.out: LineNumber: 981</span><br><span class="line">12-07 20:51:41.547 I/System.out: MethodName: newApplication</span><br><span class="line">12-07 20:51:41.547 I/System.out: ----  the 6 element  ----</span><br><span class="line">12-07 20:51:41.547 I/System.out: toString: android.app.LoadedApk.makeApplication(LoadedApk.java:573)</span><br><span class="line">12-07 20:51:41.547 I/System.out: ClassName: android.app.LoadedApk</span><br><span class="line">12-07 20:51:41.547 I/System.out: FileName: LoadedApk.java</span><br><span class="line">12-07 20:51:41.547 I/System.out: LineNumber: 573</span><br><span class="line">12-07 20:51:41.547 I/System.out: MethodName: makeApplication</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 7 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: android.app.ActivityThread.handleBindApplication(ActivityThread.java:4680)</span><br><span class="line">12-07 20:51:41.548 I/System.out: ClassName: android.app.ActivityThread</span><br><span class="line">12-07 20:51:41.548 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:51:41.548 I/System.out: LineNumber: 4680</span><br><span class="line">12-07 20:51:41.548 I/System.out: MethodName: handleBindApplication</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 8 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: android.app.ActivityThread.-wrap1(ActivityThread.java)</span><br><span class="line">12-07 20:51:41.548 I/System.out: ClassName: android.app.ActivityThread</span><br><span class="line">12-07 20:51:41.548 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:51:41.548 I/System.out: LineNumber: -1</span><br><span class="line">12-07 20:51:41.548 I/System.out: MethodName: -wrap1</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 9 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: android.app.ActivityThread$H.handleMessage(ActivityThread.java:1405)</span><br><span class="line">12-07 20:51:41.548 I/System.out: ClassName: android.app.ActivityThread$H</span><br><span class="line">12-07 20:51:41.548 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:51:41.548 I/System.out: LineNumber: 1405</span><br><span class="line">12-07 20:51:41.548 I/System.out: MethodName: handleMessage</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 10 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: android.os.Handler.dispatchMessage(Handler.java:102)</span><br><span class="line">12-07 20:51:41.548 I/System.out: ClassName: android.os.Handler</span><br><span class="line">12-07 20:51:41.548 I/System.out: FileName: Handler.java</span><br><span class="line">12-07 20:51:41.548 I/System.out: LineNumber: 102</span><br><span class="line">12-07 20:51:41.548 I/System.out: MethodName: dispatchMessage</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 11 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: android.os.Looper.loop(Looper.java:148)</span><br><span class="line">12-07 20:51:41.548 I/System.out: ClassName: android.os.Looper</span><br><span class="line">12-07 20:51:41.548 I/System.out: FileName: Looper.java</span><br><span class="line">12-07 20:51:41.548 I/System.out: LineNumber: 148</span><br><span class="line">12-07 20:51:41.548 I/System.out: MethodName: loop</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 12 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: android.app.ActivityThread.main(ActivityThread.java:5417)</span><br><span class="line">12-07 20:51:41.548 I/System.out: ClassName: android.app.ActivityThread</span><br><span class="line">12-07 20:51:41.548 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:51:41.548 I/System.out: LineNumber: 5417</span><br><span class="line">12-07 20:51:41.548 I/System.out: MethodName: main</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 13 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">12-07 20:51:41.548 I/System.out: ClassName: java.lang.reflect.Method</span><br><span class="line">12-07 20:51:41.548 I/System.out: FileName: Method.java</span><br><span class="line">12-07 20:51:41.548 I/System.out: LineNumber: -2</span><br><span class="line">12-07 20:51:41.548 I/System.out: MethodName: invoke</span><br><span class="line">12-07 20:51:41.548 I/System.out: ----  the 14 element  ----</span><br><span class="line">12-07 20:51:41.548 I/System.out: toString: com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:726)</span><br><span class="line">12-07 20:51:41.549 I/System.out: ClassName: com.android.internal.os.ZygoteInit$MethodAndArgsCaller</span><br><span class="line">12-07 20:51:41.549 I/System.out: FileName: ZygoteInit.java</span><br><span class="line">12-07 20:51:41.549 I/System.out: LineNumber: 726</span><br><span class="line">12-07 20:51:41.549 I/System.out: MethodName: run</span><br><span class="line">12-07 20:51:41.549 I/System.out: ----  the 15 element  ----</span><br><span class="line">12-07 20:51:41.549 I/System.out: toString: com.android.internal.os.ZygoteInit.main(ZygoteInit.java:616)</span><br><span class="line">12-07 20:51:41.549 I/System.out: ClassName: com.android.internal.os.ZygoteInit</span><br><span class="line">12-07 20:51:41.549 I/System.out: FileName: ZygoteInit.java</span><br><span class="line">12-07 20:51:41.549 I/System.out: LineNumber: 616</span><br><span class="line">12-07 20:51:41.549 I/System.out: MethodName: main</span><br></pre></td></tr></table></figure>
<p>ã€<code>onCreate()</code>æ–¹æ³•ã€‘</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">12-07 20:36:45.733 I/System.out: *******************************************</span><br><span class="line">12-07 20:36:45.733 I/System.out: stacktrace len:13</span><br><span class="line">12-07 20:36:45.733 I/System.out: ----  the 0 element  ----</span><br><span class="line">12-07 20:36:45.733 I/System.out: toString: dalvik.system.VMStack.getThreadStackTrace(Native Method)</span><br><span class="line">12-07 20:36:45.733 I/System.out: ClassName: dalvik.system.VMStack</span><br><span class="line">12-07 20:36:45.733 I/System.out: FileName: VMStack.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: -2</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: getThreadStackTrace</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 1 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: java.lang.Thread.getStackTrace(Thread.java:580)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: java.lang.Thread</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: Thread.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 580</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: getStackTrace</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 2 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: com.example.blockcanary.DemoApplication.onCreate(DemoApplication.java:43)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: com.example.blockcanary.DemoApplication</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: DemoApplication.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 43</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: onCreate</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 3 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: android.app.Instrumentation.callApplicationOnCreate(Instrumentation.java:1013)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: android.app.Instrumentation</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: Instrumentation.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 1013</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: callApplicationOnCreate</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 4 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: android.app.ActivityThread.handleBindApplication(ActivityThread.java:4707)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: android.app.ActivityThread</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 4707</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: handleBindApplication</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 5 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: android.app.ActivityThread.-wrap1(ActivityThread.java)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: android.app.ActivityThread</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: -1</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: -wrap1</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 6 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: android.app.ActivityThread$H.handleMessage(ActivityThread.java:1405)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: android.app.ActivityThread$H</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 1405</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: handleMessage</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 7 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: android.os.Handler.dispatchMessage(Handler.java:102)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: android.os.Handler</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: Handler.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 102</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: dispatchMessage</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 8 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: android.os.Looper.loop(Looper.java:148)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: android.os.Looper</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: Looper.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 148</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: loop</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 9 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: android.app.ActivityThread.main(ActivityThread.java:5417)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: android.app.ActivityThread</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: ActivityThread.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 5417</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: main</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 10 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: java.lang.reflect.Method</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: Method.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: -2</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: invoke</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 11 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:726)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: com.android.internal.os.ZygoteInit$MethodAndArgsCaller</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: ZygoteInit.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 726</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: run</span><br><span class="line">12-07 20:36:45.734 I/System.out: ----  the 12 element  ----</span><br><span class="line">12-07 20:36:45.734 I/System.out: toString: com.android.internal.os.ZygoteInit.main(ZygoteInit.java:616)</span><br><span class="line">12-07 20:36:45.734 I/System.out: ClassName: com.android.internal.os.ZygoteInit</span><br><span class="line">12-07 20:36:45.734 I/System.out: FileName: ZygoteInit.java</span><br><span class="line">12-07 20:36:45.734 I/System.out: LineNumber: 616</span><br><span class="line">12-07 20:36:45.734 I/System.out: MethodName: main</span><br></pre></td></tr></table></figure>
<p>ç®€å•åˆ†æå¯ä»¥çœ‹åˆ°ï¼š</p>
<p>1ï¼‰è¿™ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨éƒ½æ˜¯ç”±<code>ActivityThread.main()</code>å‡½æ•°åœ¨5417è¡Œå‘èµ·è°ƒç”¨çš„ï¼›</p>
<p>2ï¼‰æœ€ç»ˆé€šè¿‡æ¶ˆæ¯åˆ†å‘ï¼ˆæ³¨æ„<code>handleMessage()</code>å‡½æ•°çš„è°ƒç”¨ï¼‰äº¤ä»˜ç»™<code>ActivityThread.handleBindApplication()</code>æ‰§è¡Œï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ç¬¬ 4680 è¡Œä¼šè°ƒç”¨<code>LoadedApk.makeApplication()</code>æ–¹æ³•åˆ›å»º Application å¯¹è±¡ï¼Œåœ¨ 4707 è¡Œä¼šè°ƒç”¨<code>Instrumentation.callApplicationOnCreate()</code>æ–¹æ³•è°ƒç”¨ Application çš„<code>onCreate()</code>æ–¹æ³•ï¼›</p>
<p><code>ActivityThread.handleBindApplication()</code>æ–¹æ³•çš„å±€éƒ¨å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// If the app is being launched for full backup or restore, bring it up in</span></span><br><span class="line">    <span class="comment">// a restricted environment with the base application class.</span></span><br><span class="line">    <span class="comment">// åˆ›å»º Application</span></span><br><span class="line">    Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">    mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// don't bring up providers in restricted mode; they may depend on the</span></span><br><span class="line">    <span class="comment">// app's custom Application class</span></span><br><span class="line">    <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">        List&lt;ProviderInfo&gt; providers = data.providers;</span><br><span class="line">        <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            installContentProviders(app, providers);</span><br><span class="line">            <span class="comment">// For process that contains content providers, we want to</span></span><br><span class="line">            <span class="comment">// ensure that the JIT is enabled "at some point".</span></span><br><span class="line">            mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do this after providers, since instrumentation tests generally start their</span></span><br><span class="line">    <span class="comment">// test thread at this point, and we don't want that racing.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"Exception thrown in onCreate() of "</span></span><br><span class="line">                + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ onCreate æ–¹æ³•</span></span><br><span class="line">        mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to create application "</span> + app.getClass().getName()</span><br><span class="line">                    + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€è€Œè¨€ä¹‹ï¼šApplication çš„åˆ›å»ºå’Œ <code>onCreate()</code>æ˜¯åœ¨ä¸€ä¸ªæ¶ˆæ¯ä¸­æ‰§è¡Œå®Œæˆçš„ã€‚å†çœ‹Application çš„<code>onCreate()</code>æ–¹æ³•çš„æ³¨é‡Šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called when the application is starting, before any activity, service,</span></span><br><span class="line"><span class="comment"> * or receiver objects (excluding content providers) have been created.</span></span><br><span class="line"><span class="comment"> * Implementations should be as quick as possible (for example using </span></span><br><span class="line"><span class="comment"> * lazy initialization of state) since the time spent in this function</span></span><br><span class="line"><span class="comment"> * directly impacts the performance of starting the first activity,</span></span><br><span class="line"><span class="comment"> * service, or receiver in a process.</span></span><br><span class="line"><span class="comment"> * If you override this method, be sure to call super.onCreate().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå…ˆäºå››å¤§ç»„ä»¶è¿è¡Œã€‚ç»¼ä¸Šå¯ä»¥å¾—å‡ºç»“è®ºï¼š<strong>åœ¨Applicationçš„æ„é€ å‡½æ•°ä¸­ï¼Œå¼€å‘è€…å¯ä»¥è·å¾—Appå‘å‡ºçš„ç¬¬ä¸€ä¸ªä¸»çº¿ç¨‹æ¶ˆæ¯å¹¶æ‰§è¡Œç›¸å…³ä»£ç </strong>ã€‚</p>
<p>æ ¹æ®å‰é¢çš„å¡é¡¿åŸç†åˆ†æï¼Œè¿™ç§æƒ…å†µä¸‹æ˜¯æ— æ³•ç›‘æ§åˆ°è¿™ä¸ªæ¶ˆæ¯æœ¬èº«çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡ Logger çš„æ‰“å°ä¸èƒ½ç›‘æ§åˆ° Application çš„<code>onCreate()</code>æ–¹æ³•ã€‚</p>
<p>è§£å†³åŠæ³•ä¹Ÿä¸éš¾ï¼ŒæŒ‰ç…§ BlockCanary çš„å®ç°ï¼Œæˆ‘åªéœ€è¦æ‹¿åˆ° LooperMonitor å¯¹è±¡ï¼Œæ‰‹åŠ¨æ’å…¥ Logger ä»£ç å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">    monitor.println(<span class="string">"Application Create Start"</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//Application åˆå§‹åŒ–ä»£ç </span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        </span><br><span class="line">    monitor.println(<span class="string">"Application Create End"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä¹Ÿèƒ½å®Œæˆ<code>onCreate()</code>æ–¹æ³•çš„ç›‘æ§ã€‚</p>
<blockquote>
<p>ä½†è¿™ç§æ–¹æ¡ˆå®é™…åœ¨ SafeLooper ä¸­æ¯”è¾ƒéš¾æ“ä½œï¼Œè¦å®ç°å’Œ SafeLooper çš„ç»“åˆéœ€è¦å¯¹é¡¹ç›®åšæ¯”è¾ƒå¤§çš„é‡æ„ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™å¥—æ–¹æ¡ˆåˆ©ç”¨ç³»ç»Ÿæš´éœ²çš„æ¥å£å’Œå®ç°ï¼Œå·§å¦™åœ°å®ç°äº†ç›‘æ§å¡é¡¿çš„ç›®çš„ã€‚</p>
<p>å‰é¢æåˆ°ï¼Œæ–¹æ¡ˆçš„ Block é˜ˆå€¼æ˜¯æ¯”è¾ƒéš¾è®¾ç½®çš„ï¼Œæ¯”è¾ƒç†æƒ³çš„çŠ¶å†µæ˜¯æŠŠ Application å’Œå››å¤§ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å•ç‹¬æŠ½å–å‡ºæ¥åšç»Ÿè®¡ï¼Œè¿™éƒ¨åˆ†å¯¹ Block çš„è¦æ±‚è¿œè¿œè¦æ¯”åœ¨é¡µé¢ä¸Šæ»šåŠ¨ä¸€ä¸ªåˆ—è¡¨é¡µè¦æ¥çš„ä½ã€‚</p>
<p>å†è¿›ä¸€æ­¥çš„ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªå®¢æˆ·ç«¯å¡é¡¿ç›‘æ§ç³»ç»Ÿï¼Œå°† BlockCanary èåˆ SafeLooper ä¹‹åä½œä¸ºç›‘æ§ç³»ç»Ÿæ¶ˆæ¯çš„ä¸€ç§æ‰‹æ®µçº³å…¥å…¶ä¸­ï¼Œå¹¶æä¾›æ¥å£å¯ä»¥è®©å¼€å‘è€…æ‰‹åŠ¨ç›‘æ§æŸæ®µä»£ç çš„æ‰§è¡Œæ—¶é—´ï¼Œä»è€Œæ„å»ºä¸€ä¸ªæ¯”è¾ƒå…¨é¢çš„å®¢æˆ·ç«¯ä»£ç è¿è¡Œç›‘æ§ç³»ç»Ÿã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo é«˜çº§ç©æ³•å’Œå‘]]></title>
      <url>http://www.timebridge.space/2016/12/03/Hexo%E9%AB%98%E7%BA%A7%E7%8E%A9%E6%B3%95%E5%92%8C%E5%9D%91/</url>
      <content type="html"><![CDATA[<p>Hexo è™½ç„¶å·²ç»æœ‰å¾ˆå¤šçš„ä¸»é¢˜å®ç°äº†å„ç§é…·ç‚«çš„åŠŸèƒ½å’Œæ’ç‰ˆï¼Œä½†æ˜¯ä¾ç„¶æœ‰äººä¸æ»¡è¶³ã€‚æœ¬æ–‡å°±ç»“åˆè‡ªå·±éƒ¨ç½²åšå®¢æ—¶æ‰€åšæ”¹åŠ¨ä»‹ç»ä¸¤ä¸ªå¤§å®¶ç©çš„æ¯”è¾ƒæºœçš„é«˜çº§ç©æ³•ï¼Œä»¥åŠè¿™ä¸¤ä¸ªç©æ³•è¦æ³¨æ„çš„é—®é¢˜ã€‚</p>
<blockquote>
<p><a href="https://hexo.io/plugins/" target="_blank" rel="noopener">Hexo æ’ä»¶å®˜ç½‘</a>ä¸Šæœ‰å¾ˆå¤šæ’ä»¶å¯ä»¥é€‰æ‹©ã€‚Hexoçš„æ’ä»¶å®‰è£…éå¸¸ç®€å•ï¼Œåœ¨åšå®¢çš„æ ¹ç›®å½•ä¸‹é¢æ‰§è¡Œ:<code>npm install -g æ’ä»¶å</code>å³å¯ã€‚</p>
</blockquote>
<h2 id="ç½®é¡¶åŠŸèƒ½"><a href="#ç½®é¡¶åŠŸèƒ½" class="headerlink" title="ç½®é¡¶åŠŸèƒ½"></a>ç½®é¡¶åŠŸèƒ½</h2><p>ç½®é¡¶åŠŸèƒ½ç›¸å…³çš„å¸–å­æœ€æ—©å‡ºå¤„åº”è¯¥æ˜¯<a href="http://www.netcan666.com/2015/11/22/%E8%A7%A3%E5%86%B3Hexo%E7%BD%AE%E9%A1%B6%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">è§£å†³Hexoç½®é¡¶é—®é¢˜</a>è¿™ç¯‡æ–‡ç« ã€‚Hexo åœ¨å®‰è£…çš„æ—¶å€™å°±è‡ªå¸¦äº†ç”Ÿæˆ Index çš„æ’ä»¶ï¼Œä¹Ÿå°±æ˜¯<code>/node_modules/hexo-generator-index</code>æ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶çš„å…·ä½“ç©æ³•åœ¨<a href="https://github.com/hexojs/hexo-generator-index" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚å¯ä»¥æœ‰ä¸¤ä¸ªé…ç½®é¡¹ï¼Œå…¶ä¸­ä¸€ä¸ªå°±è¡¨ç¤ºæ ¹æ® date æ’åºï¼Œä¹Ÿå°±æ˜¯æ–‡ç« çš„åˆ›å»ºæ—¥æœŸã€‚<a id="more"></a></p>
<p><a href="http://www.netcan666.com/2015/11/22/%E8%A7%A3%E5%86%B3Hexo%E7%BD%AE%E9%A1%B6%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">è§£å†³Hexoç½®é¡¶é—®é¢˜</a>é€šè¿‡æ¯”è¾ƒ top æ¥å®ç°ç½®é¡¶é—®é¢˜ï¼Œéå¸¸å®Œç¾ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯åŸæ¥çš„æ’åºä»£ç æ˜¯ï¼š</p>
<p><code>var posts = locals.posts.sort(config.index_generator.order_by);</code> </p>
<p>è€Œæ–°çš„ä»£ç å´æ˜¯ï¼š</p>
<p><code>posts.data = posts.data.sort(function(a, b)...</code></p>
<p>è¿™é‡Œå¤šäº†ä¸€ä¸ª data å±æ€§ï¼Œè€Œä¸æ˜¯ç›´æ¥å¯¹ posts æ•°ç»„æ’åºï¼Œå¦‚æœä¸å†™è¿™ä¸ªï¼Œä¼šå‡ºç°ä¹±åºã€‚</p>
<blockquote>
<p>æ‰€æœ‰æ–‡ç« ä¹ŸåŒæ ·éœ€è¦æ’åºï¼Œå®ƒçš„ä¿®æ”¹ä½ç½®åœ¨<code>/node_modules/hexo-generator-archive/lib/generator.js</code>ä¸­ï¼Œæœç´¢ sort è¿›è¡Œç›¸åŒæ›¿æ¢å°±å¯ä»¥äº†ã€‚</p>
</blockquote>
<p>å¦å¤–è¿™ä¸ª top å±æ€§ä¹Ÿå¯ä»¥æ‹¿æ¥åšåˆ«çš„äº‹æƒ…ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸ä»…å¸Œæœ›åšå®¢å¯ä»¥æŒ‡å®šï¼Œè€Œä¸”æœ‰æ˜æ˜¾çš„æ ‡è¯†ï¼Œåƒä¸‹é¢ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/åšå®¢ç½®é¡¶æ ·å¼.png" alt="åšå®¢ç½®é¡¶æ ·å¼" width="320"></div>

<p>åœ¨æ ‡é¢˜å‰é¢åŠ ä¸Šçº¢è‰²åŠ ç²—â€[ç½®é¡¶]â€æ–‡æ¡ˆï¼Œé‚£å¯ä»¥å»ä¿®æ”¹å¯¹åº”ä¸»é¢˜<code>/layout/_partial/post/titls.ejs</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;% <span class="keyword">if</span> (post.link)&#123; %&gt;</span><br><span class="line">  &lt;h1 itemprop=<span class="string">"name"</span>&gt;</span><br><span class="line">    &lt;a <span class="class"><span class="keyword">class</span></span>=<span class="string">"&lt;%= class_name %&gt;"</span> href=<span class="string">"&lt;%- url_for(post.link) %&gt;"</span> target=<span class="string">"_blank"</span> itemprop=<span class="string">"url"</span>&gt;</span><br><span class="line">      &lt;%<span class="keyword">if</span>(post.top)&#123;%&gt;&lt;span style="font-weight:bold;color:red"&gt;[ç½®é¡¶]&lt;/span&gt;&lt;% &#125; %&gt;&lt;%= post.title %&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">  &lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">&lt;% &#125; else if (post.title)&#123; %&gt;</span></span><br><span class="line"><span class="regexp">  &lt;% if (index)&#123; %&gt;</span></span><br><span class="line"><span class="regexp">    &lt;h1 itemprop="name"&gt;</span></span><br><span class="line"><span class="regexp">      &lt;a class="&lt;%= class_name %&gt;" href="&lt;%- url_for(post.path) %&gt;"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;% if(post.top)&#123; %&gt;</span></span><br><span class="line"><span class="regexp">          &lt;% if(class_name !== 'archive-article-title')&#123; %&gt;</span></span><br><span class="line"><span class="regexp">            &lt;span style="font-weight:bold;color:red"&gt;[ç½®é¡¶]&lt;/</span>span&gt;</span><br><span class="line">          &lt;% &#125; <span class="keyword">else</span> &#123; %&gt;</span><br><span class="line">            &lt;span style=<span class="string">"font-weight:bold;color:red;display:inline"</span>&gt;[ç½®é¡¶]&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">          &lt;% &#125; %&gt;</span></span><br><span class="line"><span class="regexp">        &lt;% &#125; %&gt;</span></span><br><span class="line"><span class="regexp">        &lt;%= post.title %&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>a&gt;</span><br><span class="line">    &lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">  &lt;% &#125; else &#123; %&gt;</span></span><br><span class="line"><span class="regexp">    &lt;h1 class="&lt;%= class_name %&gt;" itemprop="name"&gt;</span></span><br><span class="line"><span class="regexp">      &lt;%if(post.top)&#123;%&gt;&lt;span style="font-weight:bold;color:red"&gt;[ç½®é¡¶]&lt;/</span>span&gt;&lt;% &#125; %&gt;&lt;%= post.title %&gt;</span><br><span class="line">    &lt;/h1&gt;</span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ‰€æœ‰æ˜¾ç¤ºæ ‡é¢˜çš„åœ°æ–¹åˆ¤æ–­æ–‡ç« æ˜¯ä¸æ˜¯topçš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ·»åŠ æ–‡æ¡ˆã€‚</p>
<h2 id="æµè§ˆé‡ç»Ÿè®¡åŠŸèƒ½"><a href="#æµè§ˆé‡ç»Ÿè®¡åŠŸèƒ½" class="headerlink" title="æµè§ˆé‡ç»Ÿè®¡åŠŸèƒ½"></a>æµè§ˆé‡ç»Ÿè®¡åŠŸèƒ½</h2><p>è¿™ä¸ªåŠŸèƒ½å¯¹äºåšå®¢å†™ä½œè€…æ¥è¯´åº”è¯¥æ˜¯è›®é‡è¦ä¸€ä¸ªåŠŸèƒ½ï¼Œæˆ‘çš„è§†çº¿æ–¹æ¡ˆä½¿ç”¨çš„æ˜¯<a href="https://link.zhihu.com/?target=http%3A//crescentmoon.info/2014/12/11/popular-widget/" target="_blank" rel="noopener">ä½¿ç”¨LeanCloudå¹³å°ä¸ºHexoåšå®¢æ·»åŠ æ–‡ç« æµè§ˆé‡ç»Ÿè®¡ç»„ä»¶</a>æ‰€ä»‹ç»çš„åŸºäº LeadCloud çš„æ–¹æ¡ˆã€‚è¯¦ç»†æ–¹æ¡ˆåŸæ–‡å·²ç»é˜è¿°ï¼Œä½†è¿™ä¸ªæ–¹æ¡ˆå®é™…æ˜¯ä½œè€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œå¼€å‘çš„ï¼Œä¹Ÿå°±æ˜¯æ˜¾ç¤ºåœ¨è¾¹æ ä¸Šã€‚å› æ­¤å»ºè®®è¯»è€…çœ‹æ‡‚ JS ä»£ç ä¹‹åå†ä¿®æ”¹ä¸€ä¸‹ï¼Œä¸‹é¢æ˜¯æˆ‘çš„ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;% <span class="keyword">if</span>(!index)&#123; %&gt;</span><br><span class="line">    &lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">"post-meta"</span>&gt;æ€»å­—æ•°: &lt;%= wordcount(post.content) %&gt; | é˜…è¯»é¢„è®¡ &lt;%= min2read(post.content) %&gt; åˆ†é’Ÿ&lt;/span&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">    	addCount();</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;% &#125; %&gt;</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘è¿™é‡Œè¿˜æ¶‰åŠä¸€ä¸ªå­—æ•°ç»Ÿè®¡çš„åŠŸèƒ½ï¼Œåé¢å†ä»‹ç»ã€‚ç„¶åä¿®æ”¹<code>head.ejs</code>æ–‡ä»¶ï¼Œåœ¨æœ€å header æ ‡ç­¾ä¹‹å‰æ·»åŠ ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"https://cdn1.lncld.net/static/js/av-min-1.5.0.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> APP_ID = <span class="string">'XXXXXXXX'</span>;</span><br><span class="line">    <span class="keyword">var</span> APP_KEY = <span class="string">'XXXXXXXXXXX'</span>;</span><br><span class="line">    AV.init(&#123;</span><br><span class="line">        appId: APP_ID,</span><br><span class="line">        appKey: APP_KEY</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;!--page counter part--&gt;</span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">    function addCount() &#123;</span></span><br><span class="line"><span class="regexp">        var Counter=AV.Object.extend("Counter");</span></span><br><span class="line"><span class="regexp">        url=$('.article-date').attr('href').trim();</span></span><br><span class="line"><span class="regexp">        title = $('.article-title').text().trim();</span></span><br><span class="line"><span class="regexp">        var query=new AV.Query(Counter);</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/use url as unique idnetfication</span></span><br><span class="line"><span class="regexp">        query.equalTo("url",url);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        query.find(&#123;</span></span><br><span class="line"><span class="regexp">            success: function(results)&#123;</span></span><br><span class="line"><span class="regexp">                if(results.length&gt;0) &#123;</span></span><br><span class="line"><span class="regexp">                    var counter=results[0];</span></span><br><span class="line"><span class="regexp">                    var times=counter.get('time')+1;</span></span><br><span class="line"><span class="regexp">                    $('.post-meta').append(" | PV: " + times);</span></span><br><span class="line"><span class="regexp">                    counter.set('time', times);</span></span><br><span class="line"><span class="regexp">                    counter.save();</span></span><br><span class="line"><span class="regexp">                &#125; else &#123;</span></span><br><span class="line"><span class="regexp">                    var newcounter=new Counter();</span></span><br><span class="line"><span class="regexp">                    newcounter.set("title",title);</span></span><br><span class="line"><span class="regexp">                    newcounter.set("url",url);</span></span><br><span class="line"><span class="regexp">                    newcounter.set("time",1);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                    $('.post-meta').append(" | PV: 1");</span></span><br><span class="line"><span class="regexp">                    newcounter.save().then(function (counter) &#123;</span></span><br><span class="line"><span class="regexp">                        /</span><span class="regexp">/ æˆåŠŸ</span></span><br><span class="line"><span class="regexp">                    &#125;,function (error) &#123;</span></span><br><span class="line"><span class="regexp">                        /</span><span class="regexp">/ å¤±è´¥</span></span><br><span class="line"><span class="regexp">                    &#125;);</span></span><br><span class="line"><span class="regexp">                &#125;</span></span><br><span class="line"><span class="regexp">            &#125;,</span></span><br><span class="line"><span class="regexp">            error: function(error)&#123;</span></span><br><span class="line"><span class="regexp">            &#125;</span></span><br><span class="line"><span class="regexp">        &#125;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ JS æ–‡ä»¶çš„é“¾æ¥ä¸åŸæ–‡çš„ä¸åŒï¼ŒåŸæ–‡æä¾›çš„é“¾æ¥å·²ç»å¤±æ•ˆï¼Œè¿™ç‚¹åŸä½œè€…æœ‰æé†’ï¼Œå¦å¤–åˆå§‹åŒ–æ–¹æ³•ä¹Ÿä¸ä¸€æ ·ï¼Œè¿™æ˜¯å‡çº§æ‰€è‡´ï¼Œå…·ä½“å¯è§ï¼š<a href="https://leancloud.cn/docs/sdk_setup-js.html#åˆå§‹åŒ–" target="_blank" rel="noopener"><a href="https://leancloud.cn/docs/sdk_setup-js.html#JavaScript_SDK_å®‰è£…æŒ‡å—" target="_blank" rel="noopener">JavaScript SDK å®‰è£…æŒ‡å—</a></a>ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å­˜å–ï¼Œæ–¹æ³•å¯è§æ–‡æ¡£ï¼š[<a href="https://leancloud.cn/docs/leanstorage_guide-js.html#æ•°æ®å­˜å‚¨å¼€å‘æŒ‡å—___JavaScript" target="_blank" rel="noopener">æ•°æ®å­˜å‚¨å¼€å‘æŒ‡å— Â· JavaScript</a>]</p>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯åœ¨ LeanCloud ä¸Šæ–°å»º Class çš„æ—¶å€™ï¼Œæƒé™åŠ¡å¿…é€‰æ‹©æ— é™åˆ¶ï¼Œä¸ç„¶åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™ä¼šè¢« Forbiddenã€‚</p>
<h2 id="åšå®¢ç»Ÿè®¡åŠŸèƒ½"><a href="#åšå®¢ç»Ÿè®¡åŠŸèƒ½" class="headerlink" title="åšå®¢ç»Ÿè®¡åŠŸèƒ½"></a>åšå®¢ç»Ÿè®¡åŠŸèƒ½</h2><p>è¿™ä¸ªåŠŸèƒ½ä½¿ç”¨çš„æ˜¯æ’ä»¶<a href="https://www.npmjs.com/package/hexo-wordcount" target="_blank" rel="noopener">hexo-wordcount</a>ï¼Œæä¾›ä»¥ä¸‹ä¸‰ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>åšå®¢æ€»æ•°é‡ç»Ÿè®¡ï¼›</li>
<li>åšå®¢å­—æ•°ç»Ÿè®¡ï¼›</li>
<li>é¢„è®¡é˜…è¯»æ—¶é—´ç»Ÿè®¡ï¼›</li>
</ol>
<p>å…·ä½“æ€ä¹ˆç”¨åœ¨å®˜ç½‘ä¸Šæœ‰æ˜ç¡®çš„è¯´æ˜ï¼Œè€Œå…·ä½“æ”¾ç½®åœ¨ä»€ä¹ˆä½ç½®ï¼Œè¯»è€…å¯ä»¥ç ”ç©¶ä¸€ä¸‹ä¸»é¢˜ä¸‹é¢<code>/layout/_partial/article.ejs</code>æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æè¿°äº†åœ¨æ–‡ç« åˆ—è¡¨å’Œè¯¦æƒ…é¡µé¢æ–‡ç« å¦‚ä½•æ˜¾ç¤ºï¼Œæ‰¾ä¸€ä¸ªåˆé€‚çš„åœ°æ–¹æ’å…¥å³å¯ã€‚</p>
<blockquote>
<p>æ³¨ï¼šå¯ä»¥é€šè¿‡ index è¿™ä¸ªå‚æ•°åˆ¤æ–­æ˜¯ä¸æ˜¯åœ¨åˆ—è¡¨é¡µé¢ä¸Šã€‚</p>
</blockquote>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ç²—ç•¥æ„Ÿè§‰ Hexo æ˜¯ä¸€ä¸ªç»“æ„éå¸¸å¥½çš„é¡¹ç›®ï¼Œå³ä½¿æˆ‘è¿™ç§èœé¸Ÿä¹Ÿèƒ½åœ¨çŸ­æ—¶é—´å†…ç…§è‘«èŠ¦ç”»ç“¢è¿›è¡Œä¸€äº›ä¸ªæ€§åŒ–å®šåˆ¶ï¼Œé…ç½® Hexo çš„è¿‡ç¨‹æå¤§çš„æ¿€å‘äº†æˆ‘å­¦å‰ç«¯çš„æ¬²æœ›ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Log4j]]></title>
      <url>http://www.timebridge.space/2016/11/30/log4j/</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ç®€å•æ¥è¯´ï¼Œ<a href="https://logging.apache.org/log4j/1.2/manual.html" target="_blank" rel="noopener">Log4j</a> æ˜¯ä¸€ä¸ªä¸“é—¨çš„æ—¥å¿—å·¥å…·ï¼Œå¯ä»¥å¯é ã€å¿«é€Ÿçš„è¿›è¡Œæ—¥å¿—è¾“å‡ºã€‚</p>
<blockquote>
<p>Inserting log statements into code is a low-tech method for debugging it. It may also be the only way because debuggers are not always available or applicable. This is usually the case for multithreaded applications and distributed applications at large.</p>
</blockquote>
<p>æŒ‰ç…§å®˜ç½‘çš„è¯´æ³•ï¼Œæ—¥å¿—åœ¨æŸäº›æƒ…å†µæ˜¯å”¯ä¸€è¿›è¡Œè°ƒè¯•çš„æ‰‹æ®µï¼Œæ¯”å¦‚å¤šçº¿ç¨‹çŠ¶æ€ä¸‹ï¼Œæˆ–è€…æ˜¯åˆ†å¸ƒå¼åº”ç”¨ä¸­ã€‚æŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œæ—¥å¿—æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p>
<p>1ï¼‰æˆ‘ä»¬å¯ä»¥é€‰æ‹©è¾“å‡ºæˆ‘ä»¬å…³æ³¨çš„ä¿¡æ¯åˆ°æ–‡ä»¶æˆ–è€…æˆ‘ä»¬ä»»ä½•æƒ³è¦çš„åœ°æ–¹ï¼Œé è°±å¿«é€Ÿï¼›<br>2ï¼‰æ—¥å¿—ç³»ç»Ÿå¯ä»¥åšå¿«ç…§ï¼Œåœ¨å‘ç”Ÿå¼‚å¸¸æƒ…å†µæ—¶ï¼Œå¯ä»¥è®°å½•æ­¤æ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼›</p>
<a id="more"></a>Log4j ä¸»è¦åŒ…å«ä¸‰ä¸ªæ–¹é¢çš„ä¸œè¥¿ï¼šLoggerã€Appender å’Œ Layoutï¼Œè¿™ä¸‰ä¸ªéƒ¨åˆ†å®šä¹‰äº† Log çš„å†…å®¹ã€æ ¼å¼ã€çº§åˆ«ä»¥åŠè¾“å‡ºç›®æ ‡ã€‚å¼€å§‹å­¦ä¹ å‰ï¼Œå…ˆç»™ä¸€ä¸ªä¾‹å­ç›´è§‚æ„Ÿå—ä¸€ä¸‹ï¼š<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Logger  logger = Logger.getLogger(<span class="string">"com.foo"</span>);<span class="comment">//ä¸º Logger å–ä¸€ä¸ªåå­—</span></span><br><span class="line">logger.setLevel(Level.INFO);<span class="comment">// è®¾ç½® Logger çš„çº§åˆ«</span></span><br><span class="line">logger.warn(<span class="string">"Low fuel level."</span>); <span class="comment">// æ‰“å°ä¸€ä¸ªwarnçº§åˆ«çš„æ—¥å¿—</span></span><br><span class="line">logger.debug(<span class="string">"Starting search for nearest gas station."</span>);<span class="comment">// æ‰“å°ä¸€ä¸ªdebugçº§åˆ«çš„æ—¥å¿—ï¼Œä½†æ˜¯è¿™é‡Œå®é™…ä¸ä¼šæ‰“å°ï¼Œä¸‹é¢ä¼šè§£é‡ŠåŸå› </span></span><br></pre></td></tr></table></figure>
<h2 id="Logger-çš„ç»§æ‰¿"><a href="#Logger-çš„ç»§æ‰¿" class="headerlink" title="Logger çš„ç»§æ‰¿"></a>Logger çš„ç»§æ‰¿</h2><h3 id="ç»§æ‰¿å’Œçº§åˆ«"><a href="#ç»§æ‰¿å’Œçº§åˆ«" class="headerlink" title="ç»§æ‰¿å’Œçº§åˆ«"></a>ç»§æ‰¿å’Œçº§åˆ«</h3><p>Logger æ ¹æ® <code>System.out.println</code>çš„è®¾è®¡ï¼Œä¹Ÿå¯¹æ—¥å¿—è¿›è¡Œç©ºé—´åˆ’åˆ†ï¼Œä¹Ÿå°±æ˜¯ Category çš„æ¦‚å¿µï¼Œç®€å•æ¥è¯´ï¼Œæ—¥å¿—çš„è¾“å‡ºæ˜¯åˆ†ç»„ï¼Œå¯ä»¥æŠŠæŸäº›æ—¥å¿—åˆ†ä¸ºä¸€ç»„ï¼Œä»è€Œå¯ä»¥åœ¨ç»„çš„å±‚é¢ä¸Šæ§åˆ¶æ—¥å¿—çš„è¾“å‡ºã€‚Category çš„æ¦‚å¿µåœ¨ Log4j 1.2ä¹‹åå°±è¢«å–ä»£äº†ï¼Œè¿™å°±æ˜¯ Logger ç±»ã€‚å®˜ç½‘ä¸Šå…³äºåˆ†ç»„çš„è¯´æ³•æ˜¯ï¼š</p>
<blockquote>
<p>A logger is said to be an <em>ancestor</em> of another logger if its name followed by a dot is a prefix of the<em>descendant</em> logger name. A logger is said to be a <em>parent</em> of a <em>child</em> logger if there are no ancestors between itself and the descendant logger.</p>
</blockquote>
<p>è¿™ä¸ªå’ŒåŒ…ä»¥åŠå­åŒ…çš„æ¦‚å¿µä¸€æ ·ï¼Œåå­—å«åšâ€java.utilâ€çš„ Logger æ˜¯åå­—å«åšâ€javaâ€çš„ Logger çš„å­ï¼Œæ˜¯åå­—å«åšâ€java.util.Vectorâ€çš„ Logger çš„çˆ¶ï¼Œæ˜¯åå­—å«åšâ€java.util.X.Yâ€çš„ Logger çš„ç¥–å…ˆã€‚<strong>æ¢å¥è¯è¯´ï¼šLoggerç±»é€šè¿‡åå­—ï¼ˆè¯¦è§å‰é¢ä¾‹å­ï¼‰æ¥æ ‡è®°èº«ä»½ï¼Œåå­—ä¹‹é—´å¦‚æœæŒ‰ç…§è§„èŒƒæœ‰çˆ¶å­å…³ç³»ï¼Œåˆ™ç§°ä½œ Logger ä¹‹é—´æœ‰ç»§æ‰¿å…³ç³»</strong>ã€‚</p>
<p>åŒæ—¶ Logger ä¹Ÿæœ‰ä¸€ä¸ª root loggerï¼Œå®ƒæ¯”è¾ƒç‰¹æ®Šï¼š</p>
<p>1ï¼‰è¿™ä¸ª Logger æ€»æ˜¯å­˜åœ¨çš„ï¼›</p>
<p>2ï¼‰ä¸èƒ½é€šè¿‡åå­—è·å–å®ä¾‹ï¼Œåªèƒ½é€šè¿‡æ–¹æ³•<code>Logger.getRootLogger</code>è·å–ï¼›</p>
<p>ä¸‹é¢æ˜¯ Logger å¸¸ç”¨çš„ä¸€äº›æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.log4j;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Creation &amp; retrieval methods:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Logger <span class="title">getRootLogger</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Logger <span class="title">getLogger</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printing methods:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trace</span><span class="params">(Object message)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">(Object message)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(Object message)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(Object message)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Object message)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fatal</span><span class="params">(Object message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// generic printing method:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(Level l, Object message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä» API å°±å¯ä»¥çœ‹å‡ºï¼Œæ—¥å¿—æ˜¯æœ‰çº§åˆ«çš„ï¼Œå®˜æ–¹çš„çº§åˆ«å®šä¹‰åœ¨ <a href="https://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/Level.html" target="_blank" rel="noopener">Level</a> ç±»ä¸­ï¼Œå¦‚æœä¸€ä¸ª Logger æ²¡æœ‰è¢«èµ‹äºˆæ—¥å¿—çº§åˆ«ï¼Œé‚£å®ƒå°±ä¼šä»æœ€è¿‘çš„ç¥–å…ˆé‚£é‡Œç»§æ‰¿ä¸€ä¸ªçº§åˆ«ã€‚</p>
<blockquote>
<p>è¿™é‡Œå¯èƒ½æœ‰ç‚¹æ¨¡ç³Šäº†ï¼Œæ—¥å¿—çš„çº§åˆ«æ˜¯åŒºåˆ†å¤§å°çš„ï¼Œæ¯”å¦‚å¸¸è§çš„å‡ ç§çº§åˆ«çš„å¤§å°æ¯”è¾ƒå°±æ˜¯ï¼šDEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATALã€‚</p>
<p>Logger æœ¬èº«ä¹Ÿæ˜¯æœ‰æ—¥å¿—çº§åˆ«çš„ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Logger å¯ä»¥è¾“å‡ºä»€ä¹ˆçº§åˆ«çš„æ—¥å¿—ï¼Œæ¯”å¦‚ Logger A å®šä¹‰çš„çº§åˆ«æ˜¯ warnï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ä¸ª Logger è¾“å‡º warn çº§åˆ«çš„æ—¥å¿—å°±ä¼šè¢«è¿‡æ¥æ‰ï¼Œè€Œ warn å’Œæ›´é«˜çº§åˆ«çš„ error æ—¥å¿—å°±å¯ä»¥è¢«è¾“å‡ºã€‚å› æ­¤æ—¥å¿—çº§åˆ«å¯¹äº Logger æ¥è¯´ç›¸å½“äºä¸€ä¸ªè¿‡æ»¤å™¨ã€‚</p>
</blockquote>
<p>ä¸ºäº†ä¿è¯æ‰€æœ‰çš„ Logger éƒ½ä¼šæœ‰ä¸€ä¸ªçº§åˆ«ï¼Œroot logger æ€»æ˜¯ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çº§åˆ«ã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">Logger name</th>
<th style="text-align:center">Assigned level</th>
<th style="text-align:center">Inherited level</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">root</td>
<td style="text-align:center">Proof</td>
<td style="text-align:center">Proof</td>
</tr>
<tr>
<td style="text-align:center">X</td>
<td style="text-align:center">none</td>
<td style="text-align:center">Proof</td>
</tr>
<tr>
<td style="text-align:center">X.Y</td>
<td style="text-align:center">Pxy</td>
<td style="text-align:center">Pxy</td>
</tr>
<tr>
<td style="text-align:center">X.Y.Z</td>
<td style="text-align:center">none</td>
<td style="text-align:center">Pxy</td>
</tr>
</tbody>
</table>
<p>Logger X æ²¡æœ‰è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œåˆ™ä» root logger ç»§æ‰¿ä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿæ˜¯ Proofï¼Œè€Œ Logger X.Y è®¾ç½®äº†æ—¥å¿—çº§åˆ«ä¸º Pxyï¼Œåˆ™æœ€ç»ˆçš„æ—¥å¿—çº§åˆ«ä¹Ÿä¸º Pxyï¼ŒLogger X.Y.Z æ²¡æœ‰è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œåˆ™é»˜è®¤ä»æœ€è¿‘çš„ç¥–å…ˆï¼Œä¹Ÿå°±æ˜¯ Logger X.Y é‡Œç»§æ‰¿ä¸€ä¸ªï¼Œå³ Pxyã€‚</p>
<p>é€šè¿‡åŒä¸€ä¸ªåå­—è·å–çš„ Logger æ€»æ˜¯æŒ‡å‘åŒä¸€ä¸ª Logger å®ä¾‹ã€‚é€šå¸¸åœ¨å¼€å‘ä¸­æˆ‘ä»¬ä¼šä½¿ç”¨å½“å‰ç±»çš„ class æ¥è·å–ä¸€ä¸ª Logger ã€‚æ¯”å¦‚ï¼š</p>
<p><code>private static final Logger logger = Logger.getLogger(MonitorController.class);</code></p>
<p>è¿™æ˜¯ä¸€ç§ç®€ä¾¿æœ‰æ•ˆçš„è·å– Logger çš„æ–¹æ³•ï¼Œå½“ç„¶ Logger4j å¹¶ä¸æ’æ–¥ä½ ç”¨åˆ«çš„æ–¹å¼ä¸º Logger å‘½åã€‚çˆ¶ Logger å’Œå­ Logger å¯ä»¥ä»¥ä»»æ„çš„é¡ºåºè¿›è¡Œé…ç½®å’Œåˆå§‹åŒ–ï¼Œå¹¶ä¸å½±å“å®ƒä»¬çš„ç»§æ‰¿å…³ç³»ã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>é€šè¿‡å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼š</p>
<p>1ï¼‰æ—¥å¿—æœ¬èº«æ˜¯æœ‰çº§åˆ«çš„ï¼Œçº§åˆ«ä¹Ÿæ˜¯æœ‰åºçš„ï¼›</p>
<p>2ï¼‰Logger ä¹Ÿæ˜¯æœ‰çº§åˆ«çš„ï¼Œåªæœ‰å½“æ‰“å°çš„æ—¥å¿—çº§åˆ«å¤§äºç­‰äº Logger çš„æ—¥å¿—çº§åˆ«ï¼Œæ‰ä¼šè¾“å‡ºæ—¥å¿—ï¼›</p>
<p>3ï¼‰Logger çš„æ—¥å¿—çº§åˆ«å¯ä»¥ç»§æ‰¿ï¼›</p>
<p>ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæ—¥å¿—çš„æœ‰åºçº§åˆ«æ˜¯ Log4j æ§åˆ¶æ—¥å¿—è¾“å‡ºçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚</p>
<blockquote>
<p>Log4jå»ºè®®åªä½¿ç”¨å››ä¸ªçº§åˆ«ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½åˆ†åˆ«æ˜¯ERRORã€WARNã€INFOã€DEBUGã€‚</p>
</blockquote>
<h2 id="Appenderså’ŒLayouts"><a href="#Appenderså’ŒLayouts" class="headerlink" title="Appenderså’ŒLayouts"></a>Appenderså’ŒLayouts</h2><p>åœ¨è¾“å‡ºæ—¥å¿—çš„æ—¶å€™ï¼Œé™¤äº†éœ€è¦æ ¹æ®çº§åˆ«æ¥æ§åˆ¶æ—¥å¿—è¾“å‡ºï¼Œè¿˜éœ€è¦æ§åˆ¶æ—¥å¿—è¾“å‡ºçš„ç›®çš„åœ°å’Œæ ¼å¼ï¼Œè¿™å°±æ˜¯Appenderå’ŒLayoutçš„ä½œç”¨ã€‚</p>
<h3 id="Appender"><a href="#Appender" class="headerlink" title="Appender"></a>Appender</h3><p>ä¸€ä¸ª Logger å¯ä»¥é…ç½®å¤šä¸ª Appenderï¼Œç®€è€Œè¨€ä¹‹ï¼ŒLogger å¯ä»¥æŠŠåŒä¸€ä»½æ—¥å¿—è¾“å‡ºåˆ°å¤šä¸ªåœ°æ–¹ï¼Œæ¯”å¦‚consoleã€æ–‡ä»¶ã€‚ä¸€ä¸ªæœ‰æ•ˆçš„æ—¥å¿—è¯·æ±‚ï¼ˆæŒ‡çš„æ˜¯çº§åˆ«å¤§äºç­‰äº Logger çš„æ—¥å¿—çº§åˆ«ï¼‰ä¸ä½†ä¼šè¢«å½“å‰ Logger çš„æ‰€æœ‰ Appender å¤„ç†ï¼Œè€Œä¸”ä¼šè¢« Logger çš„ç¥–å…ˆ Logger æ‰€é…ç½®çš„æ‰€æœ‰ Appender å¤„ç†ï¼Œæ¯”å¦‚ root logger é…ç½®äº†ä¸€ä¸ª console Appenderï¼Œåˆ™æ‰€æœ‰çš„ Appender éƒ½è‡³å°‘ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—ã€‚ä¹Ÿå°±æ˜¯è¯´ <strong>Appender ä¹Ÿå…·æœ‰ç»§æ‰¿æ€§</strong>ï¼Œä½†ä¸åŒäºæ—¥å¿—çº§åˆ«çš„ç»§æ‰¿ï¼ŒAppender çš„ç»§æ‰¿æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼šåªéœ€è¦å°† Logger çš„ additivity å±æ€§è®¾ç½®ä¸ºfalseï¼Œè¯¥ Logger å°†ä¸ä¼šç»§æ‰¿çˆ¶ Logger çš„ Appenderã€‚</p>
<h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h3><p>Logger å…è®¸ä¸º Appender è®¾ç½®ä¸€ä¸ª Layout æ¥æ§åˆ¶æ—¥å¿—çš„è¾“å‡ºæ ¼å¼ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Activityå¯åŠ¨è¿‡ç¨‹]]></title>
      <url>http://www.timebridge.space/2016/09/25/activity-launch-progress/</url>
      <content type="html"><![CDATA[<p>å‰é¢å‡ ç¯‡æ–‡ç« è®²è¿°äº† Binder é€šä¿¡æœºåˆ¶ï¼Œå¦å¤–ä¸¤è¾¹æ–‡ç«  <a href="https://www.muzileecoding.com/android/Android-touchevent-process.html" target="_blank" rel="noopener">Android Viewäº‹ä»¶å¤„ç†</a> å’Œ <a href="https://www.muzileecoding.com/android/Android-view-display.html" target="_blank" rel="noopener">Android Viewç»˜åˆ¶è¿‡ç¨‹</a> è®²è¿°äº† Activity ä¸Š View ç›¸å…³çš„æœºåˆ¶ã€‚é‚£ä¹ˆå‰©ä¸‹çš„å°±æ˜¯å¦‚ä½•ç»„åˆè¿™äº›æœºåˆ¶å®ç°æˆ‘ä»¬å¼€å‘ã€ä½¿ç”¨æ‰€çœ‹åˆ°çš„ç°è±¡ã€‚</p>
<blockquote>
<p>åœ¨ <a href="https://www.muzileecoding.com/android/Android-view-display.html" target="_blank" rel="noopener">Android Viewç»˜åˆ¶è¿‡ç¨‹</a> åé¢è¿˜ç•™äº†ä¸€ä¸ªç‚¹ï¼Œå³<code>ViewRootImpl.performTraversals()</code>æ˜¯å¦‚ä½•è¢«è§¦å‘è°ƒç”¨çš„ï¼Œæœ¬æ–‡å°±æ˜¯å¼¥åˆè¿™æ ·çš„è£‚ç¼ã€‚</p>
</blockquote>
<p><a id="more"></a>å¾…ç»­â€¦</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android Viewç»˜åˆ¶è¿‡ç¨‹]]></title>
      <url>http://www.timebridge.space/2016/09/21/Android-view-display/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong>A View occupies a rectangular area on the screen and is responsible for drawing and event handlingã€‚</strong></p>
</blockquote>
<h2 id="View-ç»˜åˆ¶æ¨¡å‹"><a href="#View-ç»˜åˆ¶æ¨¡å‹" class="headerlink" title="View ç»˜åˆ¶æ¨¡å‹"></a>View ç»˜åˆ¶æ¨¡å‹</h2><p>æ’‡å¼€ Android ç³»ç»Ÿä¸è°ˆï¼Œæˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹è‡ªå·±è¦ç”»ä¸€å¹…ç”»ä¼šé¦–å…ˆåšå“ªäº›äº‹æƒ…ï¼Ÿé¦–å…ˆå¾—æ„å›¾ï¼Œæˆ‘ä»¬å¾—è§„åˆ’ä¸€ä¸‹è¦ç”»å“ªäº›ä¸œè¥¿ï¼Œç”»åœ¨ä»€ä¹ˆåœ°æ–¹ä»¥åŠç”»å¤šå¤§ï¼Œç„¶åæˆ‘ä»¬å°±èƒ½ä¸‹ç¬”æˆç”»äº†ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/viewdraw-mnlsh.jpg" alt="è’™å¨œä¸½èçš„å¾®ç¬‘"></div>

<a id="more"></a>é‚£ä¹ˆ Android ç³»ç»Ÿæ˜¯ä¸æ˜¯ä¹Ÿè¿™ä¹ˆæœºæ™ºå‘¢ï¼Ÿç¡®å®å¦‚æ­¤ã€‚Android çš„ç»˜åˆ¶è¿‡ç¨‹ç”±<code>ViewRootImpl.performTraversals()</code>æ–¹æ³•è§¦å‘ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰800å¤šè¡Œï¼Œå®ƒè°ƒç”¨äº†ä¸‰ä¸ªæ–¹æ³•ï¼š<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">performMeasure()</span><br><span class="line">performLayout()</span><br><span class="line">performDraw()</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«ä»£è¡¨ç€æµ‹é‡å°ºå¯¸ã€æ”¾ç½®ä½ç½®ã€è¿›è¡Œç»˜åˆ¶ä¸‰ä¸ªæ­¥éª¤ã€‚</p>
<p>åœ¨è¯¦ç»†çœ‹è¿™ä¸‰ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸¤ä»¶äº‹æƒ…: </p>
<ol>
<li>Activity å†…çš„ View ç»„ç»‡æ–¹å¼ï¼›</li>
<li><code>setCotentView()</code>æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼›</li>
</ol>
<h3 id="Activity-å†…çš„-View-ç»„ç»‡æ–¹å¼"><a href="#Activity-å†…çš„-View-ç»„ç»‡æ–¹å¼" class="headerlink" title="Activity å†…çš„ View ç»„ç»‡æ–¹å¼"></a>Activity å†…çš„ View ç»„ç»‡æ–¹å¼</h3><p>å¦‚ä¸‹å›¾: </p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Viewå±‚çº§.png" alt="Viewå±‚çº§"></div>

<p>PhoneWindow æ˜¯ Window çš„å­ç±»ï¼Œæ ¹æ®æ³¨é‡Šï¼ŒWindowçš„ä½œç”¨æ˜¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Abstract base class for a top-level window look and behavior policy.  An</span></span><br><span class="line"><span class="comment"> * instance of this class should be used as the top-level view added to the</span></span><br><span class="line"><span class="comment"> * window manager. It provides standard UI policies such as a background, title</span></span><br><span class="line"><span class="comment"> * area, default key processing, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>å®ƒè´Ÿè´£ç»„ç»‡ä¸€ç»„ Viewï¼Œå¹¶å®ç°å®ƒä»¬çš„ç»˜åˆ¶æ˜¾ç¤ºæ–¹å¼ä»¥åŠå¯¹åº”çš„è¡Œä¸ºï¼Œæ¥ä¸º window çš„æœ€ç»ˆæ˜¾ç¤ºæä¾›æ”¯æŒã€‚</p>
<p><strong>å›¾ä¸­ç»¿è‰²éƒ¨åˆ†å’Œ View æ— å…³ï¼Œå®ƒä»¬æ˜¯è´Ÿè´£åŒ…è£… View æ˜¾ç¤ºå’Œè¡Œä¸ºçš„ï¼Œè€Œä» DecorView å¼€å§‹ï¼Œå°±æ˜¯çœŸæ­£æ˜¾ç¤ºåœ¨æ‰‹æœºå±å¹•ä¸Šçš„ View çš„æ ¹èŠ‚ç‚¹ã€‚è“è‰²éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬é€šå¸¸ä½¿ç”¨<code>setContentView()</code>æ–¹æ³•è¿›è¡Œå¸ƒå±€çš„åœ°æ–¹ã€‚</strong></p>
<h3 id="setCotentView-æ˜¯å¦‚ä½•å·¥ä½œçš„"><a href="#setCotentView-æ˜¯å¦‚ä½•å·¥ä½œçš„" class="headerlink" title="setCotentView()æ˜¯å¦‚ä½•å·¥ä½œçš„"></a><code>setCotentView()</code>æ˜¯å¦‚ä½•å·¥ä½œçš„</h3><p>æˆ‘ä»¬ä»<code>Activity.attach()</code>è¿™ä¸ªæ–¹æ³•å¼€å§‹åˆ†æ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">        attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">        mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line"></span><br><span class="line">        mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.getLayoutInflater().setPrivateFactory(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåœ¨ Activity ä¸­<code>new</code>äº†ä¸€ä¸ª<code>PhoneWindow</code>å¯¹è±¡ã€‚è€Œå½“æˆ‘ä»¬<code>setContentView()</code>çš„æ—¶å€™ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Window <span class="title">getWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mWindow;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">	getWindow().setContentView(layoutResID);</span><br><span class="line">	initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª View/ID æœ€ç»ˆè¢«è®¾ç½®åˆ°äº† mWindow ä¸­å»äº†ï¼Œä¹Ÿå°±æ˜¯ PhoneWindowï¼Œå®ƒçš„<code>setContentView()</code>æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    mContentParent.addView(view, params);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mDecor = generateDecor(); <span class="comment">//æ–¹æ³•1</span></span><br><span class="line">        mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">        mDecor.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="number">0</span>) &#123;</span><br><span class="line">            mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mContentParent = generateLayout(mDecor); <span class="comment">//æ–¹æ³•2</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•1å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> DecorView(getContext(), -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•2å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> layoutResource;</span><br><span class="line">    <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</span><br><span class="line">        layoutResource = R.layout.screen_swipe_dismiss;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    mDecor.startChanging();</span><br><span class="line"></span><br><span class="line">    View in = mLayoutInflater.inflate(layoutResource, <span class="keyword">null</span>);</span><br><span class="line">    decor.addView(in, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    mContentRoot = (ViewGroup) in;</span><br><span class="line"></span><br><span class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> contentParent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¾€ decor é‡Œé¢æ·»åŠ äº†ä¸€ä¸ª Viewï¼Œç„¶åä» decor ä¸­è·å–åˆ°äº† contentParent, åŠæ³•æ˜¯<code>findViewById(ID_ANDROID_CONTENT)</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª id æ‰€ä»£è¡¨çš„ View æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªè¦çœ‹åˆ° layoutResource æ‰€ä»£è¡¨çš„èµ„æºï¼Œç»™è¿™ä¸ªå˜é‡èµ‹å€¼çš„æ—¶å€™ä¼šåšå¾ˆå¤šçš„åˆ¤æ–­ï¼Œå€¼ä¹Ÿæœ‰å¾ˆå¤šçš„å¯èƒ½æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªå€¼æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">layoutResource = R.layout.screen_simple;</span><br></pre></td></tr></table></figure>
<p>è€Œ<code>R.layout.screen_simple</code>ä»£è¡¨çš„èµ„æºå¦‚ä¸‹:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">"@+id/action_mode_bar_stub"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:inflatedId</span>=<span class="string">"@+id/action_mode_bar"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout</span>=<span class="string">"@layout/action_mode_bar"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:theme</span>=<span class="string">"?attr/actionBarTheme"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:id</span>=<span class="string">"@android:id/content"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundInsidePadding</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundGravity</span>=<span class="string">"fill_horizontal|top"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foreground</span>=<span class="string">"?android:attr/windowContentOverlay"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸æ˜¯éå¸¸çœ¼ç†Ÿï¼Ÿæˆ‘ä»¬ç»å¸¸ä¼šä¸º Activity é…ç½®ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚æ—  ActionBar ï¼Œé‚£å°±å¯¹åº”åˆ°ä¸åŒçš„ Activity æ¨¡æ¿ï¼Œè€Œè¿™é‡Œçš„ FrameLayout å°±æ˜¯æˆ‘ä»¬æ‰¾åˆ°çš„ contentParentï¼Œæˆ‘ä»¬é€šè¿‡<code>setContentView()</code>è®¾ç½®çš„ View æœ€ç»ˆå°±æ˜¯è¢«æ·»åŠ åˆ°è¿™ä¸ª View ä¸­å»äº†ã€‚</p>
<p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç»†ç»†åˆ†æ View çš„ç»˜åˆ¶ä¸‰æ­¥éª¤ã€‚</p>
<h2 id="measure-è¿‡ç¨‹"><a href="#measure-è¿‡ç¨‹" class="headerlink" title="measure è¿‡ç¨‹"></a>measure è¿‡ç¨‹</h2><p>æµ‹é‡å°ºå¯¸æ˜¯ä½¿ç”¨æ–¹æ³•<code>performMeasure()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯è°ƒç”¨äº† View çš„<code>measure</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||</span><br><span class="line">            widthMeasureSpec != mOldWidthMeasureSpec ||</span><br><span class="line">            heightMeasureSpec != mOldHeightMeasureSpec) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// first clears the measured dimension flag</span></span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</span><br><span class="line"></span><br><span class="line">        resolveRtlPropertiesIfNeeded();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="number">1</span> :</span><br><span class="line">                    mMeasureCache.indexOfKey(key);</span><br><span class="line">        <span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</span><br><span class="line">            <span class="comment">// measure ourselves, this should set the measured dimension flag back</span></span><br><span class="line">            onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</span><br><span class="line">            (<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è®¾ç½®<code>PFLAG_FORCE_LAYOUT</code>æ ‡å¿—ä½ï¼Œæˆ–è€…çˆ¶ View çš„å°ºå¯¸å’Œä¸Šæ¬¡çš„æœ‰æ²¡æœ‰å˜åŒ–ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç»§ç»­åˆ¤æ–­æ˜¯å¦æ˜¯<code>PFLAG_FORCE_LAYOUT</code>å¼•èµ·çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¿½ç•¥ç¼“å­˜çš„å†…å®¹ï¼Œè°ƒç”¨<code>onMeasure()</code>è¿›è¡Œæµ‹é‡ï¼Œåœ¨æ–¹æ³•çš„æœ€åï¼Œä¼šæ›´æ–°ç¼“å­˜åœ¨ mMeasureCache ä¸­çš„å†…å®¹ã€‚è€Œ<code>onMeasure()</code>æ–¹æ³•çš„é»˜è®¤å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">	setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">			getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè®¡ç®—å®½é«˜çš„ä¸¤ç»„æ–¹æ³•æ˜¯å¯¹åº”çš„ï¼Œçœ‹ä¸€ç»„å³å¯ï¼Œæˆ‘ä»¬çœ‹çœ‹å®½åº¦çš„è®¡ç®—ç›¸å…³çš„æ–¹æ³•å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> result = size;</span><br><span class="line">	<span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">	<span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">		<span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">			result = size;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">		<span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">			result = specSize;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆçœ‹<code>getSuggestedMinimumWidth()</code>çš„è®¡ç®—ï¼Œå®ƒå¾—åˆ°çš„æ˜¯ View æœ¬èº«å’Œå®ƒçš„èƒŒæ™¯å…è®¸çš„æœ€å°å®½åº¦çš„è¾ƒå¤§å€¼ã€‚è€Œè‡³äº<code>getDefaultSize()</code>æ–¹æ³•ï¼Œåˆ™æ˜¯æ ¹æ® sepcModeï¼Œå†³å®šæ˜¯å¦é‡‡ç”¨å‰é¢çš„è¾ƒå¤§å€¼ï¼Œé‚£ä¹ˆè¿™å‡ ç§ specMode åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ<a href="https://developer.android.com/guide/topics/ui/how-android-draws.html" target="_blank" rel="noopener">å®˜ç½‘</a>æœ‰è¯¦ç»†çš„æè¿°ï¼š</p>
<blockquote>
<p>A MeasureSpec can be in one of three modes:</p>
<p><strong>UNSPECIFIED</strong>: This is used by a parent to determine the desired dimension of a child View. For example, a LinearLayout may call measure() on its child with the height set to UNSPECIFIED and a width of EXACTLY 240 to find out how tall the child View wants to be given a width of 240 pixels.</p>
<p><strong>EXACTLY:</strong> This is used by the parent to impose an exact size on the child. The child must use this size, and guarantee that all of its descendants will fit within this size.</p>
<p><strong>AT MOST</strong>: This is used by the parent to impose a maximum size on the child. The child must guarantee that it and all of its descendants will fit within this size.</p>
</blockquote>
<p>ç®€å•æ¥è¯´ï¼Œ<strong>UNSPECIFIED</strong> æ˜¯çˆ¶ View ç”¨æ¥æŸ¥çœ‹å­ View è‡ªå·±æƒ³è¦çš„å°ºå¯¸çš„ä¸€ç§ Modeï¼Œå®ƒå¹¶æ²¡æœ‰è¯¦ç»†è¯´æ˜å°ºå¯¸çš„é™åˆ¶ï¼ŒView æ ¹æ®è‡ªèº«çš„æ¡ä»¶è‡ªå·±å»åˆ¤æ–­å³å¯ã€‚<strong>EXACTLY</strong> æ˜¯çˆ¶ View ç”¨äºå¯¹å­ View å¼ºåˆ¶æ–½åŠ ä¸€ä¸ªå°ºå¯¸ç”¨çš„ï¼Œå­ View å¿…é¡»ä¿è¯ä½¿ç”¨è¿™ä¸ªå°ºå¯¸ï¼Œä¸”æ‰€æœ‰çš„å­ View éƒ½èƒ½å¤Ÿé€‚é…äºè¿™ä¸ªå°ºå¯¸ï¼Œ<strong>AT MOST</strong>åˆ™æ˜¯çˆ¶ View å‘Šè¯‰å­ View ä¸€ä¸ªæœ€å¤§å¯ä»¥ä½¿ç”¨çš„å°ºå¯¸ï¼Œå­ View å¿…é¡»ä¿è¯ä¸è¶…è¿‡è¿™ä¸ªå°ºå¯¸ã€‚</p>
<blockquote>
<p>EXACTLY å¯¹åº”äºmatch_parentå’Œå…·ä½“çš„æ•°å€¼è¿™ä¸¤ç§æ¨¡å¼ï¼Œè€Œ AT_MOST å¯¹åº”äº wrap_contentã€‚</p>
</blockquote>
<p>å› æ­¤çˆ¶ View åœ¨å‘Šè¯‰å­ View æµ‹é‡å°ºå¯¸çš„æ—¶å€™ï¼Œä¸ä»…ä¼šå‘Šè¯‰å®ƒè‡ªå·±çš„å°ºå¯¸æ˜¯å¤šå°‘ï¼Œè¿˜ä¼šå‘Šè¯‰å®ƒè‡ªå·±å¯¹è¿™ä¸ªå°ºå¯¸çš„ä¸€ä¸ªè¦æ±‚ï¼Œæ˜¯è¦ä¸¥æ ¼éµå®ˆï¼Œè¿˜æ˜¯è‡ªè¡Œè€ƒé‡ã€‚åœ¨æµ‹é‡å®Œå°ºå¯¸ä¹‹åï¼Œéœ€è¦è°ƒç”¨<code>setMeasuredDimension()</code>æ–¹æ³•è¿›è¡Œè®¾ç½®:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</span><br><span class="line">        Insets insets = getOpticalInsets();</span><br><span class="line">        <span class="keyword">int</span> opticalWidth  = insets.left + insets.right;</span><br><span class="line">        <span class="keyword">int</span> opticalHeight = insets.top  + insets.bottom;</span><br><span class="line"></span><br><span class="line">        measuredWidth  += optical ? opticalWidth  : -opticalWidth;</span><br><span class="line">        measuredHeight += optical ? opticalHeight : -opticalHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    setMeasuredDimensionRaw(measuredWidth, measuredHeight);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</span><br><span class="line">    mMeasuredWidth = measuredWidth;</span><br><span class="line">    mMeasuredHeight = measuredHeight;</span><br><span class="line"></span><br><span class="line">    mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®çš„æ—¶å€™å…¶å®å°±æ˜¯å°†å€¼èµ‹å€¼ç»™ mMeasuredWidth å’Œ mMeasuredHeightï¼Œè€Œè¿™ä¸¤ä¸ªå€¼æ­£æ˜¯<code>getMeasuredWidth()</code>å’Œ<code>getMeasuredHeight()</code>è¿™ä¸¤ä¸ªæ–¹æ³•çš„è¿”å›å€¼ã€‚å› æ­¤åªæœ‰åœ¨æµ‹é‡å®Œæ¯•ä¹‹åï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ‰èƒ½è¿”å›æ­£ç¡®çš„æœ‰æ•ˆå€¼ã€‚</p>
<p>ä»¥ä¸Šæ˜¯ View çš„ measure è¿‡ç¨‹ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹ ViewGroup çš„ã€‚ViewGroup çš„æµ‹é‡ä¸ä¸‰ä¸ªæ–¹æ³•ç›¸å…³ï¼š<code>measureChildren()</code>ã€<code>measureChild()</code>å’Œ<code>measureChildWithMargins()</code>ã€‚ä¸€ä¸ªä¸ªæ¥çœ‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mChildrenCount;</span><br><span class="line">    <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = children[i];</span><br><span class="line">        <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) &#123;</span><br><span class="line">            measureChild(child, widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼šå¾ªç¯éå†æ‰€æœ‰çš„å­ View ï¼Œåªè¦å¯è§æ€§ä¸æ˜¯ GONE çš„ï¼Œå°±è°ƒç”¨<code>measureChild()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChild</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> parentHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> LayoutParams lp = child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">            mPaddingLeft + mPaddingRight, lp.width);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">            mPaddingTop + mPaddingBottom, lp.height);</span><br><span class="line"></span><br><span class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¼šè®¡ç®—ä¼ é€’ç»™å­ View <code>measure()</code> çš„å®½é«˜ï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯<code>getChildMeasureSpec()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> resultMode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="comment">// Parent has imposed an exact size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size. So be it.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can't be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent has imposed a maximum size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... so be it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size, but our size is not fixed.</span></span><br><span class="line">            <span class="comment">// Constrain child to not be bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can't be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent asked to see how big we want to be</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... let him have it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size... find out how big it should</span></span><br><span class="line">            <span class="comment">// be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size.... find out how</span></span><br><span class="line">            <span class="comment">// big it should be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯ç»†çœ‹å¹¶ä¸éš¾ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¹³æ—¶åœ¨æ·»åŠ å­ View çš„æ—¶å€™ï¼Œä½¿ç”¨çš„ LayoutParams å¯¹å¸ƒå±€çš„å½±å“ã€‚<code>measureChildWithMargins()</code>æ–¹æ³•å°±ä¸åˆ†æäº†ï¼Œå®ƒåªæ˜¯æŠŠ margin ä¹Ÿä» View çš„ç©ºé—´ä¸­æ‰£é™¤äº†ã€‚</p>
<blockquote>
<p>ç”±æ­¤å¯è§ï¼Œä¸€ä¸ª View çš„ MeasureSpec ç”±çˆ¶å¸ƒå±€ MeasureSpec å’Œè‡ªèº«çš„ LayoutParams å…±åŒäº§ç”Ÿã€‚</p>
</blockquote>
<p>è™½ç„¶ ViewGroup æœ‰è¿™æ ·ä¸€ç»„ä¸æµ‹é‡æœ‰å…³çš„æ–¹æ³•ï¼Œä½†æ˜¯ framework å±‚é¢å¥½åƒå¹¶æ²¡æœ‰å»ä½¿ç”¨ï¼Œåƒ FrameLayoutã€LinearLayout ç­‰éƒ½æ˜¯è‡ªå·±é‡è½½äº†<code>onMeasure()</code>ï¼Œå¹¶åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æŒ‰ç…§è‡ªå·±çš„é€»è¾‘å®Œæˆäº†å­ View çš„æµ‹é‡ã€‚</p>
<p>ä»¥ä¸Šï¼Œå°±æ˜¯ View çš„æµ‹é‡è¿‡ç¨‹ã€‚</p>
<h2 id="layout-è¿‡ç¨‹"><a href="#layout-è¿‡ç¨‹" class="headerlink" title="layout è¿‡ç¨‹"></a>layout è¿‡ç¨‹</h2><p>View çš„ layout è¿‡ç¨‹èµ·å§‹äº ViewRootImpl çš„ <code>performLayout</code>æ–¹æ³•: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">    mLayoutRequested = <span class="keyword">false</span>;</span><br><span class="line">    mScrollMayChange = <span class="keyword">true</span>;</span><br><span class="line">    mInLayout = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> View host = mView;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    mInLayout = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•é‡Œé¢è°ƒç”¨äº†ä¸€ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•ï¼Œå³ View çš„<code>layout</code>æ–¹æ³•: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">        onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</span><br><span class="line">        mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oldL = mLeft;</span><br><span class="line">    <span class="keyword">int</span> oldT = mTop;</span><br><span class="line">    <span class="keyword">int</span> oldB = mBottom;</span><br><span class="line">    <span class="keyword">int</span> oldR = mRight;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</span><br><span class="line">            setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line">        onLayout(changed, l, t, r, b);</span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</span><br><span class="line"></span><br><span class="line">        ListenerInfo li = mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</span><br><span class="line">                    (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</span><br><span class="line">            <span class="keyword">int</span> numListeners = listenersCopy.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">    mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆé€šè¿‡<code>setOpticalFrame()</code>æˆ–è€…<code>setFrame()</code>æ–¹æ³•åˆ¤æ–­è¾¹ç•Œæœ‰æ²¡æœ‰å˜åŒ–ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æœ€ç»ˆéƒ½è°ƒç”¨åˆ°äº†<code>setFrame()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Assign a size and position to this view.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is called from layout.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> left Left position, relative to parent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> top Top position, relative to parent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> right Right position, relative to parent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bottom Bottom position, relative to parent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if the new size and position are different than the</span></span><br><span class="line"><span class="comment"> *         previous ones</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setFrame</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¸ä¹‹å‰çš„å€¼ä¸ä¸€è‡´ï¼Œå°±è¯´æ˜ View çš„è¾¹ç•Œå˜åŒ–äº†</span></span><br><span class="line">    <span class="keyword">if</span> (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;</span><br><span class="line">        changed = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remember our drawn bit</span></span><br><span class="line">        <span class="keyword">int</span> drawn = mPrivateFlags &amp; PFLAG_DRAWN;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> oldWidth = mRight - mLeft;</span><br><span class="line">        <span class="keyword">int</span> oldHeight = mBottom - mTop;</span><br><span class="line">        <span class="keyword">int</span> newWidth = right - left;</span><br><span class="line">        <span class="keyword">int</span> newHeight = bottom - top;</span><br><span class="line">        <span class="comment">// sizeChanged è¡¨ç¤ºå¤§å°æœ‰æ²¡æœ‰å˜åŒ–</span></span><br><span class="line">        <span class="keyword">boolean</span> sizeChanged = (newWidth != oldWidth) || (newHeight != oldHeight);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Invalidate our old position</span></span><br><span class="line">        invalidate(sizeChanged);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡æ–°èµ‹å€¼</span></span><br><span class="line">        mLeft = left;</span><br><span class="line">        mTop = top;</span><br><span class="line">        mRight = right;</span><br><span class="line">        mBottom = bottom;</span><br><span class="line">        mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);</span><br><span class="line"></span><br><span class="line">        mPrivateFlags |= PFLAG_HAS_BOUNDS;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">            sizeChange(newWidth, newHeight, oldWidth, oldHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || mGhostView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If we are visible, force the DRAWN bit to on so that</span></span><br><span class="line">            <span class="comment">// this invalidate will go through (at least to our parent).</span></span><br><span class="line">            <span class="comment">// This is because someone may have invalidated this view</span></span><br><span class="line">            <span class="comment">// before this call to setFrame came in, thereby clearing</span></span><br><span class="line">            <span class="comment">// the DRAWN bit.</span></span><br><span class="line">            mPrivateFlags |= PFLAG_DRAWN;</span><br><span class="line">            invalidate(sizeChanged);</span><br><span class="line">            <span class="comment">// parent display list may need to be recreated based on a change in the bounds</span></span><br><span class="line">            <span class="comment">// of any child</span></span><br><span class="line">            invalidateParentCaches();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset drawn bit to original value (invalidate turns it off)</span></span><br><span class="line">        mPrivateFlags |= drawn;</span><br><span class="line"></span><br><span class="line">        mBackgroundSizeChanged = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mForegroundInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mForegroundInfo.mBoundsChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        notifySubtreeAccessibilityStateChangedIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹å·²ç»æ ‡æ³¨åœ¨ä»£ç é‡Œé¢äº†ï¼Œåˆ¤æ–­çš„ä¾æ®å°±æ˜¯å’ŒåŸæœ‰çš„æ—§å€¼ç›¸æ¯”è¾ƒã€‚å¦‚æœå˜åŒ–äº†æˆ–è€…æ˜¯è®¾ç½®äº†<code>PFLAG_LAYOUT_REQUIRED</code>æ ‡è®°ï¼Œå°±è°ƒç”¨<code>onLayout()</code>æ–¹æ³•ã€‚å› æ­¤ View çš„<code>onLayout()</code>æ–¹æ³•è™½ç„¶ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯åªè¦å®ƒçš„ä¸Šä¸‹å·¦å³çš„ä½ç½®ä¸å˜ï¼Œåˆ™<code>changed</code>å‚æ•°å°±ä¸º falseã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>onLayout()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œè€Œåœ¨ ViewGroup é‡Œé¢ï¼Œæ–¹æ³•åˆ™æ˜¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span></span>;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ã€‚é‚£ä¹ˆåˆ°åº• ViewGroup ä¼šå¦‚ä½•å»ä½¿ç”¨è¿™äº›å‚æ•°å‘¢ï¼Ÿå¯ä»¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­: FrameLayoutã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">    layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">boolean</span> forceLeftGravity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. è®¡ç®— FrameLayout ä¸Šä¸‹å·¦å³çš„è¾¹ç•Œä½ç½®</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. éå†æ‰€æœ‰çš„å­ View </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</span><br><span class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–ä¹‹å‰å­ View æµ‹é‡å‡ºæ¥çš„å°ºå¯¸</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> childLeft;</span><br><span class="line">            <span class="keyword">int</span> childTop;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> gravity = lp.gravity;</span><br><span class="line">            <span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</span><br><span class="line">                gravity = DEFAULT_CHILD_GRAVITY;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. æ ¹æ® ViewGroup è®¾ç½®çš„å±æ€§ï¼Œæ¯”å¦‚ gravityï¼Œè®¡ç®—å­ View çš„ä¸Šä¸‹å·¦å³è¾¹ç•Œä½ç½®</span></span><br><span class="line">            <span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</span><br><span class="line">                <span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</span><br><span class="line">                    childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</span><br><span class="line">                    lp.leftMargin - lp.rightMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Gravity.RIGHT:</span><br><span class="line">                    <span class="keyword">if</span> (!forceLeftGravity) &#123;</span><br><span class="line">                        childLeft = parentRight - width - lp.rightMargin;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> Gravity.LEFT:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    childLeft = parentLeft + lp.leftMargin;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (verticalGravity) &#123;</span><br><span class="line">                <span class="keyword">case</span> Gravity.TOP:</span><br><span class="line">                    childTop = parentTop + lp.topMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Gravity.CENTER_VERTICAL:</span><br><span class="line">                    childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</span><br><span class="line">                    lp.topMargin - lp.bottomMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Gravity.BOTTOM:</span><br><span class="line">                    childTop = parentBottom - height - lp.bottomMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    childTop = parentTop + lp.topMargin;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. ä¼ é€’ç»™å­ View å®ƒçš„ä½ç½®</span></span><br><span class="line">            child.layout(childLeft, childTop, childLeft + width, childTop + height);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³é”®çš„å››æ­¥å·²ç»æ ‡æ³¨åœ¨ä»£ç ä¸­äº†ï¼Œç¬¬ 4 æ­¥ä¹‹åï¼Œå°±å›åˆ°æˆ‘ä»¬å‰é¢åˆ†æçš„ View çš„<code>setFrame()</code>æ–¹æ³•ï¼ŒView ä¼šè®°å½•ä¸‹ mLeft/mTop/mRight/mBottom å››ä¸ªå€¼ã€‚</p>
<p>ä»¥ä¸Šï¼Œå°±æ˜¯ View çš„ layout è¿‡ç¨‹ã€‚</p>
<h2 id="draw-è¿‡ç¨‹"><a href="#draw-è¿‡ç¨‹" class="headerlink" title="draw è¿‡ç¨‹"></a>draw è¿‡ç¨‹</h2><p>ç»è¿‡å‰é¢ä¸¤ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è¦åœ¨ä»€ä¹ˆä½ç½®ç”»å¤šå¤§çš„ä¸€ä¸ª View ï¼Œæ¥ä¸‹å»å°±æ˜¯è¦å¼€å§‹ç»˜åˆ¶äº†ï¼Œèµ·å§‹å½“ç„¶æ˜¯<code>performDraw()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mIsDrawing = <span class="keyword">true</span>;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"draw"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        draw(fullRedrawNeeded);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mIsDrawing = <span class="keyword">false</span>;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè°ƒç”¨äº†<code>draw()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</span><br><span class="line">    Surface surface = mSurface;</span><br><span class="line">    <span class="keyword">if</span> (!surface.isValid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    <span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If we get here with a disabled &amp; requested hardware renderer, something went</span></span><br><span class="line">            <span class="comment">// wrong (an invalidate posted right before we destroyed the hardware surface</span></span><br><span class="line">            <span class="comment">// for instance) so we should just bail out. Locking the surface with software</span></span><br><span class="line">            <span class="comment">// rendering at this point would lock it forever and prevent hardware renderer</span></span><br><span class="line">            <span class="comment">// from doing its job when it comes back.</span></span><br><span class="line">            <span class="comment">// Before we request a new frame we must however attempt to reinitiliaze the</span></span><br><span class="line">            <span class="comment">// hardware renderer if it's in requested state. This would happen after an</span></span><br><span class="line">            <span class="comment">// eglTerminate() for instance.</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animating) &#123;</span><br><span class="line">        mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šå»åˆ¤æ–­æ˜¯å¦æ˜¯å¼€å¯äº†ç¡¬ä»¶åŠ é€Ÿï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±è°ƒç”¨<code>drawSoftware()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> scalingRequired, Rect dirty)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw with software renderer.</span></span><br><span class="line">    <span class="keyword">final</span> Canvas canvas;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> left = dirty.left;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> top = dirty.top;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> right = dirty.right;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> bottom = dirty.bottom;</span><br><span class="line"></span><br><span class="line">        canvas = mSurface.lockCanvas(dirty);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The dirty rectangle can be modified by Surface.lockCanvas()</span></span><br><span class="line">        <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">        <span class="keyword">if</span> (left != dirty.left || top != dirty.top || right != dirty.right</span><br><span class="line">                || bottom != dirty.bottom) &#123;</span><br><span class="line">            attachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Do this in native</span></span><br><span class="line">        canvas.setDensity(mDensity);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Surface.OutOfResourcesException e) &#123;</span><br><span class="line">        handleOutOfResourcesException(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// If this bitmap's format includes an alpha channel, we</span></span><br><span class="line">        <span class="comment">// need to clear it before drawing so that the child will</span></span><br><span class="line">        <span class="comment">// properly re-composite its drawing on a transparent</span></span><br><span class="line">        <span class="comment">// background. This automatically respects the clip/dirty region</span></span><br><span class="line">        <span class="comment">// or</span></span><br><span class="line">        <span class="comment">// If we are applying an offset, we need to clear the area</span></span><br><span class="line">        <span class="comment">// where the offset doesn't appear to avoid having garbage</span></span><br><span class="line">        <span class="comment">// left in the blank areas.</span></span><br><span class="line">        <span class="keyword">if</span> (!canvas.isOpaque() || yoff != <span class="number">0</span> || xoff != <span class="number">0</span>) &#123;</span><br><span class="line">            canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dirty.setEmpty();</span><br><span class="line">        mIsAnimating = <span class="keyword">false</span>;</span><br><span class="line">        mView.mPrivateFlags |= View.PFLAG_DRAWN;</span><br><span class="line"></span><br><span class="line">        canvas.translate(-xoff, -yoff);</span><br><span class="line">        <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTranslator.translateCanvas(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">        canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</span><br><span class="line">        attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// ï¼ï¼ï¼</span></span><br><span class="line">        mView.draw(canvas);</span><br><span class="line">        drawAccessibilityFocusedDrawableIfNeeded(canvas);    </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            surface.unlockCanvasAndPost(canvas);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•é”å®šäº† Surface ä¸Šçš„ä¸€å— Canvas åŒºåŸŸï¼Œç„¶åè°ƒç”¨äº† View çš„<code>draw()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</span><br><span class="line">            (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</span><br><span class="line">    mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Draw traversal performs several drawing steps which must be executed</span></span><br><span class="line"><span class="comment">     * in the appropriate order:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 1. Draw the background</span></span><br><span class="line"><span class="comment">     * 2. If necessary, save the canvas' layers to prepare for fading</span></span><br><span class="line"><span class="comment">     * 3. Draw view's content</span></span><br><span class="line"><span class="comment">     * 4. Draw children</span></span><br><span class="line"><span class="comment">     * 5. If necessary, draw the fading edges and restore layers</span></span><br><span class="line"><span class="comment">     * 6. Draw decorations (scrollbars for instance)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1, draw the background, if needed</span></span><br><span class="line">    <span class="keyword">int</span> saveCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dirtyOpaque) &#123;</span><br><span class="line">        drawBackground(canvas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</span><br><span class="line">    <span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</span><br><span class="line">        <span class="comment">// Step 3, draw the content</span></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 4, draw the children</span></span><br><span class="line">        dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Overlay is part of the content and draws beneath Foreground</span></span><br><span class="line">        <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</span><br><span class="line">            mOverlay.getOverlayView().dispatchDraw(canvas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 6, draw decorations (foreground, scrollbars)</span></span><br><span class="line">        onDrawForeground(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we're done...</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šéå¸¸æ¸…æ¥šï¼Œç»˜åˆ¶è¿‡ç¨‹ä¸»è¦åˆ†ä¸º 6 ä¸ªæ­¥éª¤:</p>
<ol>
<li>ç»˜åˆ¶èƒŒæ™¯ï¼›</li>
<li>åˆ¤æ–­æ˜¯å¦è¦æ˜¾ç¤ºæ¨ªå‘æˆ–è€…çºµå‘çš„fading edge;</li>
<li>ç»˜åˆ¶è‡ªèº«çš„å†…å®¹ï¼›</li>
<li>ç»˜åˆ¶å­Viewï¼›</li>
<li>å¦‚æœéœ€è¦ç»˜åˆ¶fading edgeï¼Œåˆ™åœ¨è¿™ä¸€æ­¥è¿›è¡Œç»˜åˆ¶ï¼›</li>
<li>ç»˜åˆ¶è£…é¥°å“ï¼Œæ¯”å¦‚æ»šåŠ¨æ¡ç­‰ï¼›</li>
</ol>
<p>2 å’Œ 5ä¼šå°½å¯èƒ½çš„çœç•¥ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰çš„ View éƒ½éœ€è¦ç»˜åˆ¶ã€‚<code>draw()</code>æ–¹æ³•ä¼šæ ¹æ®æœ‰æ²¡æœ‰fading edge é€‰æ‹©ä¸¤æ¡ä¸åŒçš„é€»è¾‘è¿›è¡Œç»˜åˆ¶ï¼Œä»£ç ç‰‡æ®µä¸­å±•ç¤ºçš„æ˜¯ç®€å•çš„ä¸€æ¡ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œstep 3ï¼Œä¹Ÿå°±æ˜¯ç»˜åˆ¶è‡ªèº«å†…å®¹è¿™å—ï¼Œå®ƒè°ƒç”¨äº†å¦å¤–ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œå³<code>onDraw()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ View ç±»ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œå› æ­¤å®ƒä¸ä¼šç»˜åˆ¶ä»»ä½•å†…å®¹ï¼Œè¯»è€…å¯ä»¥å»çœ‹ä¸€ä¸‹ TextView ç­‰å­ç±»å…³äºè¯¥æ–¹æ³•çš„å®ç°ã€‚è€Œ step 4è°ƒç”¨çš„å¦å¤–ä¸€ä¸ªæ–¹æ³•<code>dispatchDraw()</code>ä¹Ÿæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œåœ¨ ViewGroup ä¸­ä¼šæœ‰ç›¸åº”çš„å®ç°ã€‚</p>
<p>ä»¥ä¸Šï¼Œå°±æ˜¯ View çš„ç»˜åˆ¶è¿‡ç¨‹ã€‚</p>
<h2 id="ä¸€äº›é—®é¢˜"><a href="#ä¸€äº›é—®é¢˜" class="headerlink" title="ä¸€äº›é—®é¢˜"></a>ä¸€äº›é—®é¢˜</h2><h3 id="ViewRootImpl-performTraversals-æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ"><a href="#ViewRootImpl-performTraversals-æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ" class="headerlink" title="ViewRootImpl.performTraversals()æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ"></a><code>ViewRootImpl.performTraversals()</code>æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ</h3><p>è¿™ä¸ªé—®é¢˜è¦åˆ°<a href="https://www.muzileecoding.com/framework/activity-launch-progress.html" target="_blank" rel="noopener">Activityå¯åŠ¨è¿‡ç¨‹</a>ä¸€æ–‡ä¸­è§£ç­”ã€‚</p>
<h3 id="getWidth-getHeight-å’ŒgetMeasuredWidth-getMeasuredHeight-ä¸¤ç»„æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ"><a href="#getWidth-getHeight-å’ŒgetMeasuredWidth-getMeasuredHeight-ä¸¤ç»„æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ" class="headerlink" title="getWidth()/getHeight()å’ŒgetMeasuredWidth()/getMeasuredHeight()ä¸¤ç»„æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ"></a><code>getWidth()/getHeight()</code>å’Œ<code>getMeasuredWidth()/getMeasuredHeight()</code>ä¸¤ç»„æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Ÿ</h3><p>ä¸¤ç»„æ–¹æ³•çš„å®ç°åˆ†åˆ«å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€ç»„</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mRight - mLeft;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mBottom - mTop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒç»„</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getMeasuredWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mMeasuredWidth &amp; MEASURED_SIZE_MASK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getMeasuredHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mMeasuredHeight &amp; MEASURED_SIZE_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦çœ‹çœ‹è¿™äº›å˜é‡ä»€ä¹ˆæ—¶å€™è¢«èµ‹å€¼å°±å¥½äº†ï¼Œæ ¹æ®å‰é¢çš„åˆ†æï¼š mRight/mLeft/mBottom/mTop å››ä¸ªå˜é‡æ˜¯åœ¨ layout ä¹‹åæ‰è¢«èµ‹å€¼ï¼ˆ<code>setFrame()</code>æ–¹æ³•ä½“å†…ï¼‰ï¼Œå› æ­¤ä¹‹ååœ¨ layout ä¹‹åï¼Œè¿™ç»„æ–¹æ³•æ‰ä¼šæœ‰æ•ˆã€‚è€Œ mMeasuredWidth/mMeasuredHeight æ˜¯åœ¨<code>onMeasure()</code>æ–¹æ³•ä¸­è°ƒç”¨<code>setMeasuredDimension()</code>è®¾ç½®åæ‰æœ‰å€¼çš„ï¼Œå› æ­¤è¿™ç»„æ–¹æ³•æ˜¯åœ¨ measure è¿‡ç¨‹å®Œæˆä¹‹åå°±æœ‰æ•ˆäº†ã€‚</p>
<p>è¿™ä¸¤ç»„å€¼å¯èƒ½ä¸ä¸€æ ·ï¼Œä¹Ÿå¯èƒ½ä¸€æ ·ï¼Œå…·ä½“è¦çœ‹åœ¨å®é™… layout çš„è¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰éµå¾ª measure è¿‡ç¨‹ä¸­è®¾ç½®å¥½çš„é™åˆ¶ã€‚</p>
<h3 id="invalidate-postInvalidate-requestLayout"><a href="#invalidate-postInvalidate-requestLayout" class="headerlink" title="invalidate()/postInvalidate()/requestLayout"></a><code>invalidate()</code>/<code>postInvalidate()</code>/<code>requestLayout</code></h3><p>è¿™ä¸‰ä¸ªæ–¹æ³•å‡ºç°çš„èƒŒæ™¯æ˜¯ï¼šä¸€ä¸ªé¡µé¢å·²ç»ç»˜åˆ¶å¥½äº†ï¼Œå¦‚æœå› ä¸ºä¸€äº›åŸå› å®ƒçš„ä½ç½®ã€å°ºå¯¸ã€å¤–è§‚éœ€è¦å‘ç”Ÿå˜åŒ–ï¼Œæ¯”å¦‚ä¸€ä¸ª View æ­£åœ¨æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œé‚£å°±éœ€è¦ View è‡ªå·±èƒ½å¤Ÿä¸»åŠ¨è¯·æ±‚é‡æ–°è®¡ç®—ã€å±•ç°è¿™äº›å˜åŒ–ã€‚</p>
<h4 id="invalidate-å’ŒpostInvalidate"><a href="#invalidate-å’ŒpostInvalidate" class="headerlink" title="invalidate()å’ŒpostInvalidate()"></a><code>invalidate()</code>å’Œ<code>postInvalidate()</code></h4><p><code>postInvalidate()</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Cause an invalidate to happen on a subsequent cycle through the event loop.</span></span><br><span class="line"><span class="comment"> * Use this to invalidate the View from a non-UI thread.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This method can be invoked from outside of the UI thread</span></span><br><span class="line"><span class="comment"> * only when this View is attached to a window.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #invalidate()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #postInvalidateDelayed(long)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postInvalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    postInvalidateDelayed(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postInvalidateDelayed</span><span class="params">(<span class="keyword">long</span> delayMilliseconds)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We try only with the AttachInfo because there's no point in invalidating</span></span><br><span class="line">    <span class="comment">// if we are not attached to our window</span></span><br><span class="line">    <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">    <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        attachInfo.mViewRootImpl.dispatchInvalidateDelayed(<span class="keyword">this</span>, delayMilliseconds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»æ³¨é‡Šçœ‹ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸ºäº†ä»é-UI çº¿ç¨‹æ¥åˆ·æ–° Viewï¼Œæœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯<code>ViewRootImpl.dispatchInvalidateDelayed()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchInvalidateDelayed</span><span class="params">(View view, <span class="keyword">long</span> delayMilliseconds)</span> </span>&#123;</span><br><span class="line">	Message msg = mHandler.obtainMessage(MSG_INVALIDATE, view);</span><br><span class="line">	mHandler.sendMessageDelayed(msg, delayMilliseconds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œäº§ç”Ÿäº†ä¸€ä¸ª<code>MSG_INVALIDATE</code>æ¶ˆæ¯ï¼Œå®ƒçš„å¤„ç†å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> MSG_INVALIDATE:</span><br><span class="line">            ((View) msg.obj).invalidate();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œæ˜¯é€šè¿‡ä¸»çº¿ç¨‹çš„ Handler å°† invalidate æ¶ˆæ¯è°ƒåº¦åˆ°è‡³ä¸»çº¿ç¨‹ã€‚å› æ­¤ï¼Œ<strong><code>invalidate()</code>å’Œ<code>postInvalidate()</code>çš„åŒºåˆ«å°±æ˜¯å‰è€…æ˜¯åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œåè€…å¯ä»¥ä»éä¸»çº¿ç¨‹è°ƒåº¦</strong>ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹<code>invalidate()</code>å’Œ<code>requestLayout</code>å„è‡ªæ‰€èµ·çš„ä½œç”¨ã€‚</p>
<h4 id="requestLayoutæ–¹æ³•"><a href="#requestLayoutæ–¹æ³•" class="headerlink" title="requestLayoutæ–¹æ³•"></a><code>requestLayout</code>æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mMeasureCache != <span class="keyword">null</span>) mMeasureCache.clear();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸¤ä¸ªæ ‡å¿—ä½</span></span><br><span class="line">    mPrivateFlags |= PFLAG_FORCE_LAYOUT;</span><br><span class="line">    mPrivateFlags |= PFLAG_INVALIDATED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ ViewGroup çš„ requestLayout() æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">        mParent.requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="keyword">this</span>) &#123;</span><br><span class="line">        mAttachInfo.mViewRequestingLayout = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒè®¾ç½®äº†ä¸¤ä¸ªæ ‡å¿—ä½ï¼Œä¹‹åè°ƒç”¨çˆ¶ View çš„<code>requestLayout()</code>æ–¹æ³•ï¼Œæ ¹æ®æˆ‘ä»¬å‰é¢åˆ†æçš„ Activity çš„ View ç»“æ„ï¼Œè¿™ä¸ªè°ƒç”¨ä¼šå±‚å±‚å‘ä¸Šï¼Œä¼šåˆ°å“ªé‡Œå‘¢ï¼Ÿæœ€ç»ˆä¼šè°ƒç”¨åˆ° ViewRootImpl çš„<code>requestLayout()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">        checkThread();</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šè®¾ç½® mLayoutRequested æ ‡å¿—ä½ï¼Œå¹¶è°ƒç”¨<code>scheduleTraversals()</code>ï¼Œè¿™ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨åˆ°æˆ‘ä»¬å‰é¢åˆ†æçš„<code>performTraversals()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">    <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">        windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// æˆç«‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">    <span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line">	<span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">		performLayout(lp, desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºå‰é¢å°† mLayoutRequested ç½®ä¸º trueï¼Œå› æ­¤ä¸€å®šä¼šè°ƒç”¨<code>measureHierarchy()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">measureHierarchy</span><span class="params">(<span class="keyword">final</span> View host, <span class="keyword">final</span> WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Resources res, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowWidth, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">boolean</span> goodMeasure = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">if</span> (baseSize != <span class="number">0</span> &amp;&amp; desiredWindowWidth &gt; baseSize) &#123;</span><br><span class="line">            ...</span><br><span class="line">            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> ((host.getMeasuredWidthAndState()&amp;View.MEASURED_STATE_TOO_SMALL) == <span class="number">0</span>) &#123;</span><br><span class="line">                goodMeasure = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">                <span class="keyword">if</span> ((host.getMeasuredWidthAndState()&amp;View.MEASURED_STATE_TOO_SMALL) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_DIALOG) Log.v(TAG, <span class="string">"Good!"</span>);</span><br><span class="line">                    goodMeasure = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!goodMeasure) &#123;</span><br><span class="line">        childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);</span><br><span class="line">        childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</span><br><span class="line">        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        <span class="keyword">if</span> (mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight()) &#123;</span><br><span class="line">            windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªä»£ç ç‰‡æ®µä¸­ï¼Œè‚¯å®šä¼šè°ƒç”¨<code>performMeasure()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||</span><br><span class="line">        widthMeasureSpec != mOldWidthMeasureSpec ||</span><br><span class="line">        heightMeasureSpec != mOldHeightMeasureSpec) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// first clears the measured dimension flag</span></span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</span><br><span class="line"></span><br><span class="line">        resolveRtlPropertiesIfNeeded();</span><br><span class="line">        <span class="comment">// è®¾ç½®äº† PFLAG_FORCE_LAYOUTï¼ŒcacheIndex ä¸º -1</span></span><br><span class="line">        <span class="keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="number">1</span> :</span><br><span class="line">                mMeasureCache.indexOfKey(key);</span><br><span class="line">        <span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</span><br><span class="line">            <span class="comment">// measure ourselves, this should set the measured dimension flag back</span></span><br><span class="line">            onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</span><br><span class="line">            <span class="comment">// Casting a long to int drops the high 32 bits, no mask needed</span></span><br><span class="line">            setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</span><br><span class="line">            mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// è®¾ç½®æ ‡å¿—ä½ï¼šPFLAG_LAYOUT_REQUIRED</span></span><br><span class="line">        mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOldWidthMeasureSpec = widthMeasureSpec;</span><br><span class="line">    mOldHeightMeasureSpec = heightMeasureSpec;</span><br><span class="line"></span><br><span class="line">    mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</span><br><span class="line">            (<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰é¢è°ƒç”¨<code>requestLayout()</code>æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®¾ç½®äº†<code>PFLAG_FORCE_LAYOUT</code>æ ‡å¿—ä½ï¼Œå› æ­¤è¿™é‡Œä¼šæ‰§è¡Œåˆ°<code>onMeasure()</code>æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ä¼šè¿›è¡Œæµ‹é‡è¿‡ç¨‹ã€‚</p>
<p>æˆ‘ä»¬å†å›åˆ°<code>performTraversals()</code>æ–¹æ³•ï¼Œæ¥ä¸‹å»ä¼šè°ƒç”¨<code>performLayout()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å‰é¢åˆ†æè¿‡äº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">        onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</span><br><span class="line">        mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oldL = mLeft;</span><br><span class="line">    <span class="keyword">int</span> oldT = mTop;</span><br><span class="line">    <span class="keyword">int</span> oldB = mBottom;</span><br><span class="line">    <span class="keyword">int</span> oldR = mRight;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</span><br><span class="line">            setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line">    <span class="comment">// å¦‚æœè®¾ç½®äº† PFLAG_LAYOUT_REQUIRED æ ‡å¿—ä½ï¼Œåˆ™è¿›è¡Œ onLayout</span></span><br><span class="line">    <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line">        onLayout(changed, l, t, r, b);</span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</span><br><span class="line"></span><br><span class="line">        ListenerInfo li = mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</span><br><span class="line">                    (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</span><br><span class="line">            <span class="keyword">int</span> numListeners = listenersCopy.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">    mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºåœ¨ measure è¿‡ç¨‹ä¸­è®¾ç½®äº†<code>PFLAG_LAYOUT_REQUIRED</code>æ ‡å¿—ä½ï¼Œæ‰€ä»¥è¿™é‡Œä¼šé‡æ–°è®¾ç½®ä½ç½®ã€‚è€Œ<code>performDraw()</code>æ–¹æ³•è™½ç„¶æœ‰è§¦å‘æ¡ä»¶ï¼Œä½†æ˜¯å¦‚æœ View çš„å°ºå¯¸å’Œä½ç½®å˜åŒ–äº†ï¼Œä¸€å®šä¼šè§¦å‘è¯¥æ–¹æ³•çš„è°ƒç”¨ã€‚</p>
<h4 id="invalidate-æ–¹æ³•"><a href="#invalidate-æ–¹æ³•" class="headerlink" title="invalidate()æ–¹æ³•"></a><code>invalidate()</code>æ–¹æ³•</h4><p>è¿™ä¸ªæ–¹æ³•å…¶å®æœ‰ä¸€äº›é‡è½½æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    invalidate(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(<span class="keyword">boolean</span> invalidateCache)</span> </span>&#123;</span><br><span class="line">    invalidateInternal(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop, invalidateCache, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalidateInternal</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b, <span class="keyword">boolean</span> invalidateCache,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> fullInvalidate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mGhostView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mGhostView.invalidate(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (skipInvalidate()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡ç»˜æ‰§è¡Œçš„æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)) == (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)</span><br><span class="line">            || (invalidateCache &amp;&amp; (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID)</span><br><span class="line">            || (mPrivateFlags &amp; PFLAG_INVALIDATED) != PFLAG_INVALIDATED</span><br><span class="line">            || (fullInvalidate &amp;&amp; isOpaque() != mLastIsOpaque)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fullInvalidate) &#123;</span><br><span class="line">            mLastIsOpaque = isOpaque();</span><br><span class="line">            mPrivateFlags &amp;= ~PFLAG_DRAWN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®æ ‡å¿—ä½</span></span><br><span class="line">        mPrivateFlags |= PFLAG_DIRTY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­æˆç«‹</span></span><br><span class="line">        <span class="keyword">if</span> (invalidateCache) &#123;</span><br><span class="line">            mPrivateFlags |= PFLAG_INVALIDATED;</span><br><span class="line">            mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Propagate the damage rectangle to the parent view.</span></span><br><span class="line">        <span class="keyword">final</span> AttachInfo ai = mAttachInfo;</span><br><span class="line">        <span class="keyword">final</span> ViewParent p = mParent;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ View çš„ invalidateChild æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; ai != <span class="keyword">null</span> &amp;&amp; l &lt; r &amp;&amp; t &lt; b) &#123;</span><br><span class="line">            <span class="keyword">final</span> Rect damage = ai.mTmpInvalRect;</span><br><span class="line">            damage.set(l, t, r, b);</span><br><span class="line">            p.invalidateChild(<span class="keyword">this</span>, damage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Damage the entire projection receiver, if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (mBackground != <span class="keyword">null</span> &amp;&amp; mBackground.isProjected()) &#123;</span><br><span class="line">            <span class="keyword">final</span> View receiver = getProjectionReceiver();</span><br><span class="line">            <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">                receiver.damageInParent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Damage the entire IsolatedZVolume receiving this view's shadow.</span></span><br><span class="line">        <span class="keyword">if</span> (isHardwareAccelerated() &amp;&amp; getZ() != <span class="number">0</span>) &#123;</span><br><span class="line">            damageShadowReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æ³¨é‡Šæ‰€è¯´ï¼Œæœ€ç»ˆè°ƒç”¨äº†çˆ¶ ViewParent çš„<code>invalidateChild()</code>æ–¹æ³•ï¼Œå¹¶æŠŠå½“å‰ View çš„èŒƒå›´é»˜è®¤ä¼ é€’ç»™äº†è¯¥æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Don't call or override this method. It is used for the implementation of</span></span><br><span class="line"><span class="comment"> * the view hierarchy.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invalidateChild</span><span class="params">(View child, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŠŠè‡ªèº«èµ‹å€¼ç»™ parent</span></span><br><span class="line">    ViewParent parent = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">    <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] location = attachInfo.mInvalidateChildLocation;</span><br><span class="line">        location[CHILD_LEFT_INDEX] = child.mLeft;</span><br><span class="line">        location[CHILD_TOP_INDEX] = child.mTop;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// while å¾ªç¯</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            View view = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (parent <span class="keyword">instanceof</span> View) &#123;</span><br><span class="line">                view = (View) parent;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            parent = parent.invalidateChildInParent(location, dirty);</span><br><span class="line">            <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Account for transform on current parent</span></span><br><span class="line">                Matrix m = view.getMatrix();</span><br><span class="line">                <span class="keyword">if</span> (!m.isIdentity()) &#123;</span><br><span class="line">                    RectF boundingRect = attachInfo.mTmpTransformRect;</span><br><span class="line">                    boundingRect.set(dirty);</span><br><span class="line">                    m.mapRect(boundingRect);</span><br><span class="line">                    dirty.set((<span class="keyword">int</span>) (boundingRect.left - <span class="number">0.5f</span>),</span><br><span class="line">                            (<span class="keyword">int</span>) (boundingRect.top - <span class="number">0.5f</span>),</span><br><span class="line">                            (<span class="keyword">int</span>) (boundingRect.right + <span class="number">0.5f</span>),</span><br><span class="line">                            (<span class="keyword">int</span>) (boundingRect.bottom + <span class="number">0.5f</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (parent != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šä¸åœçš„è°ƒç”¨ parent çš„<code>invalidateChildInParent()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸€ç›´è°ƒç”¨ï¼Œä¼šè°ƒç”¨åˆ°<code>ViewRootImpl.invalidateRectOnScreen()</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invalidateRectOnScreen</span><span class="params">(Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Rect localDirty = mDirty;</span><br><span class="line">    <span class="keyword">if</span> (!localDirty.isEmpty() &amp;&amp; !localDirty.contains(dirty)) &#123;</span><br><span class="line">        mAttachInfo.mSetIgnoreDirtyState = <span class="keyword">true</span>;</span><br><span class="line">        mAttachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the new dirty rect to the current one</span></span><br><span class="line">    localDirty.union(dirty.left, dirty.top, dirty.right, dirty.bottom);</span><br><span class="line">    <span class="comment">// Intersect with the bounds of the window to skip</span></span><br><span class="line">    <span class="comment">// updates that lie outside of the visible region</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> appScale = mAttachInfo.mApplicationScale;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> intersected = localDirty.intersect(<span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">            (<span class="keyword">int</span>) (mWidth * appScale + <span class="number">0.5f</span>), (<span class="keyword">int</span>) (mHeight * appScale + <span class="number">0.5f</span>));</span><br><span class="line">    <span class="keyword">if</span> (!intersected) &#123;</span><br><span class="line">        localDirty.setEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æˆç«‹</span></span><br><span class="line">    <span class="keyword">if</span> (!mWillDrawSoon &amp;&amp; (intersected || mIsAnimating)) &#123;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤è¿™é‡Œè¿˜æ˜¯å»è°ƒç”¨äº†<code>scheduleTraversals()</code>æ–¹æ³•ï¼Œä¸åŒçš„æ˜¯ï¼Œè¿™æ¬¡æ²¡æœ‰è®¾ç½® mLayoutRequested ä¸º trueï¼Œå› æ­¤ä¸ä¼šè°ƒç”¨<code>performLayout()</code>æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå»è°ƒç”¨<code>measureHierarchy()</code>æ–¹æ³•ã€‚</p>
<blockquote>
<p>å…³äºè¿™ä¸€ç‚¹è®ºæ–­ï¼Œè¯»è€…å¯ä»¥å»çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨å¤„ï¼Œéƒ½å’Œ mLayoutRequested ç›¸å…³ã€‚</p>
</blockquote>
<p>å› æ­¤åªä¼šç›´æ¥å»è°ƒç”¨<code>performDraw()</code>æ–¹æ³•ã€‚</p>
<h4 id="æ–¹æ³•æ€»ç»“"><a href="#æ–¹æ³•æ€»ç»“" class="headerlink" title="æ–¹æ³•æ€»ç»“"></a>æ–¹æ³•æ€»ç»“</h4><p>ä¸‹é¢è¿™å¹…å›¾å‡ºè‡ª Google+ ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/android-view-method.webp" height="400" alt="android-view-method"></div>

<p>å®ƒå¾ˆå¥½çš„æ€»ç»“äº†ç›¸å…³è¿‡ç¨‹ï¼ŒæŒ‡å‡ºäº†<code>invalidate()</code>å’Œ<code>requestLayout()</code>æ–¹æ³•çš„åŒºåˆ«ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>View çš„ç»˜åˆ¶è¿‡ç¨‹ä¸€å¦‚æˆ‘ä»¬è‡ªå·±ä½œç”»çš„è¿‡ç¨‹ä¸€æ ·ï¼ŒæŠ½è±¡å‡ºæ¥æ— éæ˜¯ç¡®è®¤ View çš„å¤§å°ï¼Œè®¾ç½® View çš„ä½ç½®ï¼Œç»˜åˆ¶ View çš„å†…å®¹ä¸‰ä¸ªæ­¥éª¤ï¼Œå‰é¢çš„åˆ†æèƒ½å¤Ÿè®©è¯»è€…å¯¹ç»˜åˆ¶çš„è¿‡ç¨‹æœ‰ä¸€ä¸ªç²—ç•¥çš„äº†è§£ã€‚</p>
<p>ç»“åˆ<a href="https://www.muzileecoding.com/android/Android-touchevent-process.html" target="_blank" rel="noopener">Android Viewäº‹ä»¶å¤„ç†</a>ï¼Œæˆ‘ä»¬è¿˜èƒ½å¾—å‡ºä¸€ä¸ªç»“è®ºï¼š<strong>View çš„ç»˜åˆ¶è¿‡ç¨‹æ— éæ˜¯æŠŠæˆ‘ä»¬æƒ³è¦çš„ View ç•Œé¢ç»˜åˆ¶åœ¨ Surface çš„ Canvas ä¸Šå¹¶æœ€ç»ˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œæœ€ç»ˆçš„æ˜¾ç¤ºå’Œæˆ‘ä»¬å±å¹•æˆªå›¾ä¸‹æ¥çš„å›¾ç‰‡æœ¬è´¨ä¸Šæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚å®ƒçš„å¥‡ç‰¹ä¹‹å¤„å°±åœ¨äºå®ƒèƒ½æ¥å—äº‹ä»¶å¹¶ä½œå‡ºååº”ï¼Œè€Œè¿™æ˜¯é€šè¿‡åº•å±‚çš„View å¯¹è±¡æ¥å®ç°çš„ã€‚</strong></p>
<p>ç„¶è€Œï¼Œè´´å‡ºæ¥åˆ†æçš„ä»£ç æ˜¯ç»è¿‡åˆ å‡çš„ï¼Œè¯»è€…å¦‚æœè‡ªå·±å»çœ‹æ–¹æ³•ä½“ï¼Œä¼šå‘ç°è¿‡ç¨‹å¤æ‚çš„å¤šï¼Œå°±æ¯”å¦‚æˆ‘ä»¬æœ€å¼€å§‹åˆ†æçš„<code>ViewRootImpl.performTraversals()</code>æ–¹æ³•ï¼Œå®ƒå¹¶ä¸æ˜¯ç®€ç®€å•å•çš„å°±è°ƒç”¨äº†è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œç”šè‡³ä¹Ÿä¸æ˜¯è°ƒç”¨äº†ä¸€æ¬¡ã€‚ä½†è¿™å¹¶ä¸å¦¨ç¢æˆ‘ä»¬å»äº†è§£è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼Œå½“æˆ‘ä»¬ä»¥åé‡åˆ°é—®é¢˜ï¼Œè‡³å°‘å¯ä»¥æœ‰ä¸€ä¸ªåŸºæœ¬çš„æ¦‚å¿µå»çŒœæµ‹ä¸€ä¸‹é—®é¢˜ç‚¹ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android Viewäº‹ä»¶å¤„ç†]]></title>
      <url>http://www.timebridge.space/2016/09/04/Android-touchevent-process/</url>
      <content type="html"><![CDATA[<h2 id="View-æ¨¡å‹-amp-äº‹ä»¶æ¨¡å‹"><a href="#View-æ¨¡å‹-amp-äº‹ä»¶æ¨¡å‹" class="headerlink" title="View æ¨¡å‹ &amp; äº‹ä»¶æ¨¡å‹"></a>View æ¨¡å‹ &amp; äº‹ä»¶æ¨¡å‹</h2><h3 id="View-æ¨¡å‹"><a href="#View-æ¨¡å‹" class="headerlink" title="View æ¨¡å‹"></a>View æ¨¡å‹</h3><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¯æˆ‘ä»¬æ—¥å¸¸å¼€å‘å¸ƒå±€æ‰€æ¥è§¦çš„ View æ¨¡å‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Android-Viewæ¨¡å‹.png" alt="Android-Viewæ¨¡å‹"></div>

<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ View å’Œ ViewGroup çš„åµŒå¥—ç»„åˆã€‚ViewGroup æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Viewï¼Œç‰¹æ®Šä¹‹å¤„å°±åœ¨äºå®ƒå¯ä»¥å®¹çº³å¹¶æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ’åˆ—Viewï¼Œæ­¤æ—¶çš„ View è¢«ç§°ä¸ºå­ Viewï¼Œå¸¸è§çš„ View æœ‰ Buttonã€ImageView ç­‰ï¼Œå¸¸è§çš„ ViewGroup æœ‰ LinearLayoutã€Relativelayoutç­‰ï¼ŒAndroid å¼€å‘è€…åº”è¯¥éå¸¸ç†Ÿæ‚‰ã€‚<a id="more"></a></p>
<h3 id="äº‹ä»¶æ¨¡å‹"><a href="#äº‹ä»¶æ¨¡å‹" class="headerlink" title="äº‹ä»¶æ¨¡å‹"></a>äº‹ä»¶æ¨¡å‹</h3><p>æœ¬æ–‡è¦è®¨è®ºçš„æ˜¯è¿™æ ·ä¸€ç»„ View æ¨¡å‹å¯¹äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚ä»€ä¹ˆæ˜¯äº‹ä»¶ï¼Ÿæˆ‘ä»¬è§¦æ‘¸å±å¹•ï¼Œä»æˆ‘ä»¬çš„æ‰‹æŒ‡å¼€å§‹æ¥è§¦å±å¹•åˆ°æ‰‹æŒ‡ç¦»å¼€å±å¹•ï¼Œæ‰‹æŒ‡ä¸å±å¹•ä¹‹é—´çš„äº¤äº’éƒ½è¢«æŠ½è±¡æˆè¿ç»­çš„äº‹ä»¶ï¼Œç”¨äºæè¿°ä¸€ä¸ªè§¦æ‘¸è¿‡ç¨‹ã€‚äº‹ä»¶ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ol>
<li>ACTION_DOWNï¼šDownäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è½ä¸‹æ‰‹æŒ‡çš„äº‹ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªäº‹ä»¶æµçš„å¼€å§‹ï¼›</li>
<li>ACTION_MOVEï¼šMoveäº‹ä»¶ï¼Œæˆ‘ä»¬æ‰‹æŒ‡æŒ‰åœ¨å±å¹•ä¸Šï¼Œä¸ä¼šä¸€ç›´ä¸åŠ¨ï¼Œæ¯”å¦‚æˆ‘ä»¬ç©åˆ‡æ°´æœæ¸¸æˆï¼Œæ‰‹æŒ‡ä¼šé£å¿«çš„åˆ’è¿‡é¡µé¢ï¼Œè¿™æ ·å°±äº§ç”Ÿäº†ä¸€ç³»åˆ—çš„Moveäº‹ä»¶ï¼Œé€šè¿‡Moveäº‹ä»¶ï¼Œå¯ä»¥æ„é€ å‡ºæ‰‹æŒ‡ç§»åŠ¨çš„è·¯å¾„ï¼›</li>
<li>ACTION_UPï¼šUpäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯æ‰‹æŒ‡æ‹¿èµ·çš„äº‹ä»¶ï¼›</li>
</ol>
<p>è¿™ä¸‰ç±»äº‹ä»¶ä¸²èµ·æ¥å¯ä»¥æè¿°æˆ‘ä»¬ç»å¤§éƒ¨åˆ†çš„è§¦å±æ“ä½œï¼šACTION_DOWN, ACTION_MOVE,ACTION_MOVEâ€¦ACTION_MOVE, ACTION_UPã€‚é‚£ä¹ˆè¿™æ ·ä¸€ç»„äº‹ä»¶æµæ˜¯å¦‚ä½•åˆ†å‘åˆ° View æ¨¡å‹ä¸­å»å¤„ç†çš„å‘¢ï¼Ÿä¸‹é¢è¯¦ç»†åˆ†æã€‚</p>
<h2 id="Viewçš„äº‹ä»¶å¤„ç†"><a href="#Viewçš„äº‹ä»¶å¤„ç†" class="headerlink" title="Viewçš„äº‹ä»¶å¤„ç†"></a>Viewçš„äº‹ä»¶å¤„ç†</h2><h3 id="äº‹ä»¶åˆ†å‘â€”â€”dispatchTouchEvent"><a href="#äº‹ä»¶åˆ†å‘â€”â€”dispatchTouchEvent" class="headerlink" title="äº‹ä»¶åˆ†å‘â€”â€”dispatchTouchEvent"></a>äº‹ä»¶åˆ†å‘â€”â€”<code>dispatchTouchEvent</code></h3><p>View çš„äº‹ä»¶å¤„ç†æ˜¯ä»<code>dispatchTouchEvent()</code>æ–¹æ³•å¼€å§‹çš„ï¼ŒViewä¸­è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬æŠ½é‡ç‚¹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1 è¿‡æ»¤</span></span><br><span class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">        ListenerInfo li = mListenerInfo;</span><br><span class="line">        <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">                &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œæ ¸å¿ƒä»£ç å°±è¿™ä¸€æ®µã€‚åœ¨äº‹ä»¶å¤„ç†å‰ï¼Œé¦–å…ˆè¦åšä¸€ä¸‹å®‰å…¨è¿‡æ»¤ï¼Œ<code>onFilterTouchEventForSecurity()</code>æ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Filter the touch event to apply security policies.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event The motion event to be filtered.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> True if the event should be dispatched, false if the event should be dropped.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getFilterTouchesWhenObscured</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onFilterTouchEventForSecurity</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//noinspection RedundantIfStatement</span></span><br><span class="line">    <span class="keyword">if</span> ((mViewFlags &amp; FILTER_TOUCHES_WHEN_OBSCURED) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; (event.getFlags() &amp; MotionEvent.FLAG_WINDOW_IS_OBSCURED) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Window is obscured, drop this touch.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æ³¨é‡Šæ‰€è¯´ï¼Œè¿™ä¸ªè¿‡æ»¤æ˜¯ä¸ºäº†ä¸€äº›å®‰å…¨ç­–ç•¥ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹<code>FILTER_TOUCHES_WHEN_OBSCURED</code>å’Œ<code>FLAG_WINDOW_IS_OBSCURED</code>ä¸¤ä¸ªå˜é‡çš„æ³¨é‡Šï¼Œå°¤å…¶æ˜¯åè€…çš„ï¼Œå¯ä»¥å¤§è‡´äº†è§£ä¸€ä¸‹è¿™é‡Œçš„å®‰å…¨æŒ‡çš„æ˜¯ä»€ä¹ˆã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å½“å®ƒæ˜¯è¿”å›çš„ true æ¥ç»§ç»­å¾€ä¸‹åˆ†æ 2 å¤„ã€‚åˆ†æ 2 ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹å‡ ä¸ªæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnTouchListener</span><span class="params">(OnTouchListener l)</span> </span>&#123;</span><br><span class="line">	getListenerInfo().mOnTouchListener = l;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function">ListenerInfo <span class="title">getListenerInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mListenerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> mListenerInfo;</span><br><span class="line">	&#125;</span><br><span class="line">	mListenerInfo = <span class="keyword">new</span> ListenerInfo();</span><br><span class="line">	<span class="keyword">return</span> mListenerInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•æŒ‡æ˜äº†<code>mListenerInfo</code>ä¸­<code>mOnTouchListener</code>çš„æ¥æºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶å¼€å‘ä¸­é€šè¿‡è°ƒç”¨<code>setOnTouchListener()</code>ä¸ºViewè®¾ç½®çš„<code>OnTouchListener</code>ç›‘å¬ï¼Œå› æ­¤ 2 å¤„çš„åˆ¤æ–­çš„å«ä¹‰æ˜¯å¦‚æœ View æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>è®¾ç½®äº†<code>OnTouchListener</code>ç›‘å¬ï¼›</li>
<li>View çš„çŠ¶æ€æ˜¯ enable çš„ï¼›</li>
<li>è°ƒç”¨<code>OnTouchListener</code>çš„<code>onTouch</code>æ–¹æ³•è¿”å›çš„æ˜¯trueï¼›</li>
</ol>
<p>é‚£ä¹ˆ<code>dispatchTouchEvent()</code>æ–¹æ³•å°±ä¼šè¿”å›trueï¼Œå¦åˆ™<code>result</code>ä¸º falseï¼Œä¼šç»§ç»­æ‰§è¡Œ 3 å¤„ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè‡ªå·±çš„<code>onTouchEvent()</code>æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯å¤„ç†æµç¨‹å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Viewäº‹ä»¶å¤„ç†æµç¨‹å›¾.png" width="600" alt="Viewäº‹ä»¶å¤„ç†æµç¨‹å›¾"></div>

<h3 id="äº‹ä»¶å¤„ç†â€”â€”onTouchEvent"><a href="#äº‹ä»¶å¤„ç†â€”â€”onTouchEvent" class="headerlink" title="äº‹ä»¶å¤„ç†â€”â€”onTouchEvent"></a>äº‹ä»¶å¤„ç†â€”â€”<code>onTouchEvent</code></h3><p>ä¸‹é¢æˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹<code>onTouchEvent</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ã€æ³¨æ„ã€‘è¿™é‡Œè°ƒç”¨çš„æ˜¯getX()å’ŒgetY()ï¼Œä¸åŠ ä»»ä½•çš„å‚æ•°ï¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> x = event.getX();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> y = event.getY();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1 å¦‚æœ View æ˜¯ DISABLED</span></span><br><span class="line">    <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ UP äº‹ä»¶ï¼Œå¹¶ä¸”å½“å‰ View å¤„äº PRESSED çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å–æ¶ˆ PRESSED çŠ¶æ€</span></span><br><span class="line">            setPressed(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// A disabled view that is clickable still consumes the touch</span></span><br><span class="line">        <span class="comment">// events, it just doesn't respond to them.</span></span><br><span class="line">        <span class="keyword">return</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">                    || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">                    || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2 å¦‚æœè®¾ç½®äº† mTouchDelegateï¼Œå…ˆè°ƒç”¨å®ƒçš„ onTouchEvent æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3 å¦‚æœ View å¯ç‚¹å‡»</span></span><br><span class="line">    <span class="keyword">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</span><br><span class="line">            (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||</span><br><span class="line">            (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4</span></span><br><span class="line">                <span class="comment">// Walk up the hierarchy to determine if we're inside a scrolling container.</span></span><br><span class="line">                <span class="keyword">boolean</span> isInScrollingContainer = isInScrollingContainer();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For views inside a scrolling container, delay the pressed feedback for</span></span><br><span class="line">                <span class="comment">// a short period in case this is a scroll.</span></span><br><span class="line">                <span class="keyword">if</span> (isInScrollingContainer) &#123;</span><br><span class="line">                    mPrivateFlags |= PFLAG_PREPRESSED;</span><br><span class="line">                    <span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPendingCheckForTap.x = event.getX();</span><br><span class="line">                    mPendingCheckForTap.y = event.getY();</span><br><span class="line">                    <span class="comment">// 5 å»¶è¿Ÿä¸€æ®µæ—¶é—´å†å»Check</span></span><br><span class="line">                    postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                    <span class="comment">// 6 ç›´æ¥è®¾ç½® PRESSED çŠ¶æ€ï¼Œå¹¶ Check LongClick</span></span><br><span class="line">                    <span class="comment">// Not inside a scrolling container, so show the feedback right away</span></span><br><span class="line">                    setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">                    checkForLongClick(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                drawableHotspotChanged(x, y);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 7 åˆ¤æ–­æ˜¯å¦ç§»å‡ºäº† View çš„è¾¹ç•Œ</span></span><br><span class="line">                <span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</span><br><span class="line">                    <span class="comment">// ç§»å‡ºå»äº†å°±ç§»é™¤ Tap ä»»åŠ¡</span></span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    <span class="comment">// å¦‚æœ Tap ä»»åŠ¡å·²ç»æ‰§è¡Œ</span></span><br><span class="line">                    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// ç§»é™¤ LongPressä»»åŠ¡</span></span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line">                        <span class="comment">// å–æ¶ˆ PRESSED çŠ¶æ€</span></span><br><span class="line">                        setPressed(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                <span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 8 å¦‚æœæŠ¬èµ·çš„æ—¶å€™ï¼ŒViewå¤„äº PRESSED çŠ¶æ€æˆ–è€…å¤„äº PRESSED ç¡®è®¤æœŸ</span></span><br><span class="line">                <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</span><br><span class="line">                    <span class="comment">// take focus if we don't have it already and we should in</span></span><br><span class="line">                    <span class="comment">// touch mode.</span></span><br><span class="line">                    <span class="comment">// è·å–ç„¦ç‚¹</span></span><br><span class="line">                    <span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">                        focusTaken = requestFocus();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å¦‚æœå¤„äº PRESSED ç¡®è®¤æœŸï¼Œæ­¤æ—¶ç¡®è®¤ PRESSED</span></span><br><span class="line">                    <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                        <span class="comment">// The button is being released before we actually</span></span><br><span class="line">                        <span class="comment">// showed it as pressed.  Make it show the pressed</span></span><br><span class="line">                        <span class="comment">// state now (before scheduling the click) to ensure</span></span><br><span class="line">                        <span class="comment">// the user sees it.</span></span><br><span class="line">                        setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 9 å¦‚æœæ­¤æ—¶æ²¡æœ‰è¿›å…¥é•¿æŒ‰ (å¦å¤–ä¸€ä¸ªå˜é‡ä¸éœ€è¦care)</span></span><br><span class="line">                    <span class="keyword">if</span> (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">                        <span class="comment">// This is a tap, so remove the longpress check</span></span><br><span class="line">                        <span class="comment">// ä¸è¦å†å» Check é•¿æŒ‰äº‹ä»¶äº†</span></span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Only perform take click actions if we were in the pressed state</span></span><br><span class="line">                        <span class="comment">// 10 åˆ¤æ–­æ˜¯å¦å¤„äºç„¦ç‚¹çŠ¶æ€, ä¸å¤„äºåˆ™æ‰§è¡Œ PerformClick ä»»åŠ¡</span></span><br><span class="line">                        <span class="keyword">if</span> (!focusTaken) &#123;</span><br><span class="line">                            <span class="comment">// Use a Runnable and post this rather than calling</span></span><br><span class="line">                            <span class="comment">// performClick directly. This lets other visual state</span></span><br><span class="line">                            <span class="comment">// of the view update before click actions start.</span></span><br><span class="line">                            <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                mPerformClick = <span class="keyword">new</span> PerformClick();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (!post(mPerformClick)) &#123;</span><br><span class="line">                                performClick();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å–æ¶ˆ PRESSED çŠ¶æ€</span></span><br><span class="line">                    <span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                        postDelayed(mUnsetPressedState,</span><br><span class="line">                                ViewConfiguration.getPressedStateDuration());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) &#123;</span><br><span class="line">                        <span class="comment">// If the post failed, unpress right now</span></span><br><span class="line">                        mUnsetPressedState.run();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                &#125;</span><br><span class="line">                mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                setPressed(<span class="keyword">false</span>);</span><br><span class="line">                removeTapCallback();</span><br><span class="line">                removeLongPressCallback();</span><br><span class="line">                mInContextButtonPress = <span class="keyword">false</span>;</span><br><span class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line">                mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;            </span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­å‡ ä¸ª case çš„å¤„ç†è°ƒæ¢äº†ä»¥ä¸‹é¡ºåºï¼Œä»¥ä¾¿äºåˆ†æã€‚ä»£ç æ€»å…±åšäº† 10 å¤„æ³¨é‡Šï¼ŒåŸºæœ¬å¯ä»¥ç†æ¸…æ¥šè¿™æ®µä»£ç çš„è„‰ç»œã€‚ä¸‹é¢å¯¹å…¶ä¸­å‡ å¤„åšä¸€ä¸‹è¡¥å……ã€‚</p>
<h4 id="getX-getY-ä¸getX-int-getY-int"><a href="#getX-getY-ä¸getX-int-getY-int" class="headerlink" title="getX()/getY()ä¸getX(int)/getY(int)"></a>getX()/getY()ä¸getX(int)/getY(int)</h4><p>åœ¨æ–¹æ³•æ‰§è¡Œçš„ä¸€å¼€å§‹æˆ‘å°±æ ‡æ³¨äº†ä¸€ä¸ª<strong>ã€æ³¨æ„ã€‘</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆç»†èŠ‚çš„åœ°æ–¹ï¼Œè¿™ä¸¤ç»„æ–¹æ³•çš„åŒºåˆ«è¯»è€…å¯ä»¥è‡ªå·±å»æŸ¥ API æ–‡æ¡£ï¼Œæ³¨æ„åˆ°å®ƒä»¬çš„ä¸åŒå°±å¯ä»¥è§£é‡Šä¸‹é¢çš„ç°è±¡ï¼š</p>
<p><strong>æœ‰ä¸€ä¸ª View æ˜¯Clickableçš„ï¼Œå¦‚æœ View ä¸Šæœ‰ä¸¤æ ¹æ‰‹æŒ‡ï¼Œå‡è®¾ A æ˜¯å…ˆæŒ‰ä¸‹çš„ï¼ŒB æ˜¯åæŒ‰ä¸‹çš„ï¼Œé‚£ä¹ˆå¦‚æœ B ç§»å‡º View è¾¹ç•Œï¼ŒA æŠ¬èµ·ä¾ç„¶å¯ä»¥è§¦å‘ Click äº‹ä»¶ï¼Œä½†æ˜¯å¦‚æœ A å…ˆç§»å‡ºè¾¹ç•Œï¼ŒB åæŠ¬èµ·ï¼Œåˆ™ä¸èƒ½è§¦å‘ Click äº‹ä»¶ã€‚</strong>(ä»å®è·µç»“æœæ¥çœ‹ï¼Œè™½ç„¶ A å’Œ B è§¦å‘çš„éƒ½æ˜¯ Move äº‹ä»¶ï¼Œä½†æ˜¯å®é™…ä¸Š B çš„ Move äº‹ä»¶çš„åæ ‡å¹¶ä¸æ˜¯ç»å¯¹åæ ‡ï¼Œè€Œå°±æ˜¯ A çš„åæ ‡ï¼Œåªæœ‰å½“ A æŠ¬èµ·ä¹‹åï¼ŒB è§¦å‘çš„æ‰ä¼šæ¢å¤è‡ªå·±çš„ç»å¯¹åæ ‡ã€‚)</p>
<h4 id="VIEW-çš„-CLICKABLE"><a href="#VIEW-çš„-CLICKABLE" class="headerlink" title="VIEW çš„ CLICKABLE"></a>VIEW çš„ CLICKABLE</h4><p>1 å’Œ 3 å¤„åˆèµ·æ¥å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šä¸€ä¸ª View åªè¦æ˜¯ <code>CLICKABLE || LONG_CLICKABLE || CONTEXT_CLICKABLE</code> çš„ï¼Œå®ƒå°±èƒ½æ¶ˆè´¹äº‹ä»¶ï¼Œä¸æ˜¯å¦ DISABLE æ— å…³ï¼Œåªä¸è¿‡ DISABLE çš„æ—¶å€™ä¸ä¼šåšå‡ºå“åº”ã€‚</p>
<p>View åœ¨æ²¡æœ‰ä»»ä½•è®¾ç½®çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ CLICKABLE æ˜¯ false çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ xml ä¸­è®¾ç½® <code>android:clickable=&quot;true&quot;</code>æˆ–è€…è°ƒç”¨<code>setClickable(boolean)</code>æ¥æ›´æ”¹ï¼Œæˆ–è€…å½“æˆ‘ä»¬è°ƒç”¨<code>setOnClickListener()</code>çš„æ—¶å€™ï¼Œè¿™ä¸ªæ ‡å¿—ä½ä¹Ÿä¼šè¢«é»˜è®¤è®¾ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(@Nullable OnClickListener l)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!isClickable()) &#123;</span><br><span class="line">		setClickable(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	getListenerInfo().mOnClickListener = l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ‰‹åŠ¿å»¶è¿Ÿåˆ¤æ–­"><a href="#æ‰‹åŠ¿å»¶è¿Ÿåˆ¤æ–­" class="headerlink" title="æ‰‹åŠ¿å»¶è¿Ÿåˆ¤æ–­"></a>æ‰‹åŠ¿å»¶è¿Ÿåˆ¤æ–­</h4><p>4 å¤„åœ¨å¤„ç†äº‹ä»¶çš„æ—¶å€™ï¼Œé¦–å…ˆè¦åˆ¤æ–­è‡ªèº«æ˜¯ä¸æ˜¯å¤„äºä¸€ä¸ªå¯ä»¥æ»šåŠ¨çš„å®¹å™¨ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯è°ƒç”¨çš„ ViewGroup çš„<code>shouldDelayChildPressedState()</code>æ¥åˆ¤æ–­çš„ï¼ŒæŸ¥çœ‹äº†å‡ ä¸ªå¸¸è§çš„ ViewGroupï¼Œå…¶ä¸­æ¯”å¦‚ LinearLayoutã€FrameLayout ç­‰ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„å°±æ˜¯ falseï¼Œè€Œåƒ ScrollViewã€ListView è¿”å›çš„å°±æ˜¯ trueï¼ŒViewGroup ä¸­é»˜è®¤è¿”å›çš„å°±æ˜¯trueã€‚</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦åšè¿™ä¸ªåˆ¤æ–­å‘¢ï¼Ÿå› ä¸ºåœ¨å¯æ»šåŠ¨çš„å®¹å™¨ä¸­ï¼ŒDOWN äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™æ˜¯æ— æ³•åˆ¤æ–­ç”¨æˆ·çš„ç”¨æ„åˆ°åº•æ˜¯ç‚¹å‡»è¿˜æ˜¯æ»šåŠ¨çš„ï¼Œå› æ­¤è¿™é‡Œåªå›å»è®¾ç½®ä¸€ä¸ª <code>PFLAG_PREPRESSED</code> çŠ¶æ€ï¼Œå¹¶ä¸”å¯åŠ¨äº†ä¸€ä¸ª <code>CheckForTap</code> ä»»åŠ¡ï¼Œå»¶è¿Ÿ <code>ViewConfiguration.getTapTimeout()</code> å†æ‰§è¡Œï¼›å¦åˆ™å°±ç›´æ¥è®¾ç½® Pressed çŠ¶æ€ï¼Œå¹¶ä¸”æ·»åŠ ä¸€ä¸ª <code>CheckForLongPress</code> ä»»åŠ¡ã€‚ </p>
<h4 id="æ‰‹åŠ¿è¯†åˆ«ä»»åŠ¡"><a href="#æ‰‹åŠ¿è¯†åˆ«ä»»åŠ¡" class="headerlink" title="æ‰‹åŠ¿è¯†åˆ«ä»»åŠ¡"></a>æ‰‹åŠ¿è¯†åˆ«ä»»åŠ¡</h4><p>ä¸Šä¸€å°èŠ‚æåˆ°äº†ä¸¤ä¸ªä»»åŠ¡ï¼š<code>CheckForTap</code> å’Œ <code>CheckForLongPress</code>ã€‚ä¸‹é¢ç»†çœ‹çœ‹è¿™ä¸¤ä¸ªä»»åŠ¡å…·ä½“åšä»€ä¹ˆã€‚</p>
<h5 id="CheckForTap"><a href="#CheckForTap" class="headerlink" title="CheckForTap"></a>CheckForTap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckForTap</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> x;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> y;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		mPrivateFlags &amp;= ~PFLAG_PREPRESSED;</span><br><span class="line">		setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">		checkForLongClick(ViewConfiguration.getTapTimeout());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä»»åŠ¡ä¸€æ—¦æ‰§è¡Œï¼Œå°±è¯´æ˜ç”¨æˆ·è§¦æ‘¸çš„ä¸€ä¸ª View çš„æ—¶é—´å·²ç»åˆ°äº†å¯ä»¥ç¡®è®¤ä¸º Tap çš„æ—¶é•¿äº†ï¼Œæ‰€ä»¥é¦–å…ˆè¦åšçš„å°±æ˜¯å–æ¶ˆ <code>PFLAG_PREPRESSED</code>çŠ¶æ€ï¼Œå¹¶è®¾ç½® PRESSED çŠ¶æ€ï¼Œè‡³æ­¤æ•´ä¸ª View ç¡®å®è¿›å…¥åˆ°äº† PRESSED çŠ¶æ€ã€‚ç„¶åå®ƒä¼šè°ƒç”¨<code>checkForLongClick()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForLongClick</span><span class="params">(<span class="keyword">int</span> delayOffset)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((mViewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) &#123;</span><br><span class="line">		mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mPendingCheckForLongPress == <span class="keyword">null</span>) &#123;</span><br><span class="line">			mPendingCheckForLongPress = <span class="keyword">new</span> CheckForLongPress();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		mPendingCheckForLongPress.rememberWindowAttachCount();</span><br><span class="line">		postDelayed(mPendingCheckForLongPress,</span><br><span class="line">				ViewConfiguration.getLongPressTimeout() - delayOffset);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½ä¸€ç›®äº†ç„¶ï¼šå¦‚æœ View æ˜¯<code>LONG_CLICKABLE</code>çš„ï¼Œå°±å‘èµ·ä¸€ä¸ª<code>CheckForLongPress</code>ä»»åŠ¡ã€‚è¦æ³¨æ„å»¶è¿Ÿæ—¶é—´ï¼šå¦‚æœæ˜¯<code>CheckForTap</code>å‘èµ·çš„ï¼Œå°±éœ€è¦å‡å»ä¹‹å‰ç­‰å¾…ç¡®è®¤ Tap åŠ¨ä½œçš„æ—¶é—´ï¼Œå¦‚æœæ˜¯ DOWN äº‹ä»¶ç›´æ¥è§¦å‘çš„ï¼Œé‚£å°±éœ€è¦ç­‰å¾…<code>ViewConfiguration.getLongPressTimeout()</code>æ—¶é•¿ã€‚</p>
<h5 id="CheckForLongPress"><a href="#CheckForLongPress" class="headerlink" title="CheckForLongPress"></a>CheckForLongPress</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckForLongPress</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mOriginalWindowAttachCount;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (isPressed() &amp;&amp; (mParent != <span class="keyword">null</span>)</span><br><span class="line">				&amp;&amp; mOriginalWindowAttachCount == mWindowAttachCount) &#123;</span><br><span class="line">			<span class="keyword">if</span> (performLongClick()) &#123;</span><br><span class="line">				mHasPerformedLongPress = <span class="keyword">true</span>; <span class="comment">// ç½®ä½</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rememberWindowAttachCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		mOriginalWindowAttachCount = mWindowAttachCount;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•åˆ¤æ–­å¦‚æœå½“å‰ View å¤„äº Pressed çŠ¶æ€ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œ<code>performLongClick()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå›è°ƒè®¾ç½®çš„<code>OnLongClickListener</code>ç›‘å¬ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹<code>performLongClick()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¦‚æœè¿”å› trueï¼Œåˆ™ä¼šè®¾ç½®æ ‡å¿—ä½ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†<code>OnLongClickListener</code>ï¼Œè¿™é‡Œå°±è¯¥è¿”å› trueã€‚</p>
<h4 id="è¾¹ç•Œé—®é¢˜"><a href="#è¾¹ç•Œé—®é¢˜" class="headerlink" title="è¾¹ç•Œé—®é¢˜"></a>è¾¹ç•Œé—®é¢˜</h4><p>7 å¤„ä¸»è¦å¤„ç†çš„æ˜¯è¾¹ç•Œé—®é¢˜ï¼Œå¦‚æœ View ç§»å‡ºäº†è¾¹ç•Œï¼Œé‚£ä¹ˆé¦–å…ˆè¦ç§»é™¤<code>CheckForTap</code>ä»»åŠ¡ã€‚æ ¹æ®å‰é¢çš„åˆ†æï¼Œåªæœ‰å½“ View å¤„äºå¯æ»šåŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œæ‰ä¼šæ·»åŠ è¿™ä¸ªä»»åŠ¡ã€‚ç§»å‡ºä¹‹åæŸ¥çœ‹ View æ˜¯å¦è¿˜å¤„äº PFLAG_PRESSED çŠ¶æ€ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¯´æ˜ View æ˜¯ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼š</p>
<ol>
<li>View çš„ Down äº‹ä»¶èµ°çš„æ˜¯â‘£-â‘¤è·¯çº¿ï¼Œå¹¶ä¸”<code>CheckForTap</code>ä»»åŠ¡å·²ç»æ‰§è¡Œäº†ï¼Œè¿™ä¸ªæ—¶å€™ä»»åŠ¡é˜Ÿåˆ—ä¸­å¾ˆå¯èƒ½æœ‰<code>CheckForLongPress</code>ä»»åŠ¡ï¼›</li>
<li>View çš„ Down äº‹ä»¶èµ°çš„æ˜¯â‘£-â‘¥è·¯çº¿ï¼Œé˜Ÿåˆ—ä¸­è‚¯å®šæœ‰ä¸€ä¸ª<code>CheckForLongPress</code>ä»»åŠ¡ï¼›</li>
</ol>
<p>å› æ­¤æ¥ç€è¦åšçš„äº‹æƒ…å°±æ˜¯ç§»é™¤<code>CheckForLongPress</code>ä»»åŠ¡ï¼Œå¹¶ä¸”å–æ¶ˆ Pressed çŠ¶æ€ã€‚</p>
<h4 id="ç„¦ç‚¹"><a href="#ç„¦ç‚¹" class="headerlink" title="ç„¦ç‚¹"></a>ç„¦ç‚¹</h4><p>8 å¤„çš„å¤„ç†å’Œç„¦ç‚¹ç›¸å…³ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ç§»å‡ºè¾¹ç•Œï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶æ­¤æ—¶è‚¯å®šå¤„äº PRESSED æˆ–è€… PFLAG_PREPRESSED çŠ¶æ€ã€‚View æ­¤æ—¶è¦å°è¯•å»æ‹¿ä¸€ä¸‹ç„¦ç‚¹ã€‚é»˜è®¤æ¥è¯´ï¼ŒTouch Mode ä¸‹æ˜¯æ— æ³•æ‹¿åˆ°ç„¦ç‚¹çš„ï¼Œå› æ­¤ <code>focusTaken</code> è‚¯å®šä¸º falseã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æŠŠ View çš„ <code>FOCUSABLE_MASK</code> å’Œ <code>FOCUSABLE_IN_TOUCH_MODE</code> æ ‡å¿—ä½éƒ½è®¾ç½®äº†ï¼ˆé€šè¿‡ä»£ç å’ŒXMLéƒ½å¯ä»¥ï¼‰ï¼Œé‚£ä¹ˆ View å°±å¯ä»¥åœ¨ Touch Mode ä¸‹è·å–ç„¦ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>focusTaken</code> åœ¨ç¬¬ä¸€æ¬¡ Up äº‹ä»¶çš„æ—¶å€™ï¼Œä¼šè¢«ç½®ä¸º true ï¼Œè€Œç¬¬äºŒæ¬¡å› ä¸º <code>isFocused()</code> è¿”å› trueï¼ˆç¬¬ä¸€æ¬¡Upçš„æ—¶å€™å› ä¸ºæ‰§è¡Œ<code>requestFocus()</code>ä¼šè·å–ç„¦ç‚¹ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡å°±ä¼šè¿”å›trueï¼‰è€Œè¢«ç½®ä¸º falseã€‚è¿™ä¸ªåŠ¡å¿…æ³¨æ„ã€‚</p>
<p>9 é™¤é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ‰§è¡Œäº† <code>CheckForLongPress</code>ï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œï¼Œé‚£ä¹ˆç§»é™¤ä»»åŠ¡ï¼Œåˆ¤æ–­ View æ˜¯å¦åœ¨ Up å¤„ç†ä¸­è·å–åˆ°äº†ç„¦ç‚¹ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šæ‰§è¡Œ<code>PerformClick</code>ä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡ä»åå­—çœ‹å°±å¾ˆçœ¼ç†Ÿï¼Œå®ƒæ‰§è¡Œçš„å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> result;</span><br><span class="line">	<span class="keyword">final</span> ListenerInfo li = mListenerInfo;</span><br><span class="line">	<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">		playSoundEffect(SoundEffectConstants.CLICK);</span><br><span class="line">		li.mOnClickListener.onClick(<span class="keyword">this</span>);</span><br><span class="line">		result = <span class="keyword">true</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		result = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸ä¸º View è®¾ç½®çš„ç‚¹å‡»ç›‘å¬ã€‚</p>
<blockquote>
<p><strong>Google å®˜æ–¹ä¸å»ºè®®è®¾ç½® <code>FOCUSABLE_MASK</code> å’Œ <code>FOCUSABLE_IN_TOUCH_MODE</code> çš„ç†ç”±ä¹Ÿåœ¨è¿™é‡Œï¼Œ10 å¤„å¾ˆæ˜æ˜¾çš„å±•ç¤ºäº†æ‰“å¼€è¿™ä¸¤ä¸ªæ ‡å¿—ä½çš„åæœï¼šç¬¬ä¸€æ¬¡ Click çš„æ—¶å€™ï¼Œ<code>View.OnClickListener</code>æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œ</strong>ã€‚ç›¸å…³çš„èµ„æ–™å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="http://android-developers.blogspot.jp/2008/12/touch-mode.html" target="_blank" rel="noopener">Touch Mode</a>ã€‚</p>
</blockquote>
<h2 id="ViewGroupçš„äº‹ä»¶å¤„ç†"><a href="#ViewGroupçš„äº‹ä»¶å¤„ç†" class="headerlink" title="ViewGroupçš„äº‹ä»¶å¤„ç†"></a>ViewGroupçš„äº‹ä»¶å¤„ç†</h2><p>åˆ†æå®Œå•ä¸ª View çš„äº‹ä»¶å¤„ç†æµç¨‹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦åˆ†æ ViewGroup çš„äº‹ä»¶å¤„ç†æµç¨‹ï¼Œé¦–å…ˆè¦æ˜ç™½çš„äº‹æƒ…æ˜¯ ViewGroup ä¹Ÿæ˜¯ä¸€ç§ Viewï¼Œå› æ­¤å®ƒå’Œ View ä¸€æ ·ï¼Œä¹Ÿå…·å¤‡æ¶ˆè´¹äº‹ä»¶çš„èƒ½åŠ›ï¼Œæ‰€ä¸åŒçš„æ˜¯ï¼šViewGroup å¯èƒ½æ‹¥æœ‰å¾ˆå¤šä¸ªå­ Viewï¼Œå®ƒè¦å†³å®šäº‹ä»¶åˆ†å‘çš„ç­–ç•¥ä»¥ä¾¿äºäº‹ä»¶èƒ½å¤Ÿåˆ†å‘åˆ°åˆé€‚çš„å­ View å»å¤„ç†ã€‚å› æ­¤è™½ç„¶ ViewGroup å’Œ View ä¸€æ ·éƒ½æ˜¯ä» <code>onTouchEvent</code>æ–¹æ³•å¼€å§‹äº‹ä»¶å¤„ç†ï¼Œä½†æ˜¯è¡Œä¸ºä¸Šæ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚</p>
<h3 id="ViewGroup-çš„dispatchTouchEvent"><a href="#ViewGroup-çš„dispatchTouchEvent" class="headerlink" title="ViewGroup çš„dispatchTouchEvent"></a>ViewGroup çš„<code>dispatchTouchEvent</code></h3><p>ç›¸æ¯”è¾ƒäº View çš„<code>dispatchTouchEvent</code>æ–¹æ³•ï¼ŒViewGroup çš„<code>dispatchTouchEvent</code>æ–¹æ³•è¦å¤æ‚çš„å¤šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1 åˆå§‹åŒ– ViewGroup çš„äº‹ä»¶å¤„ç†çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// Handle an initial down.</span></span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            <span class="comment">// Throw away all previous state when starting a new touch gesture.</span></span><br><span class="line">            <span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></span><br><span class="line">            <span class="comment">// due to an app switch, ANR, or some other state change.</span></span><br><span class="line">            cancelAndClearTouchTargets(ev);</span><br><span class="line">            resetTouchState();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2 åˆ¤æ–­æ˜¯å¦è¦æ‹¦æˆªäº‹ä»¶</span></span><br><span class="line">        <span class="comment">// Check for interception.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                intercepted = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">            <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">            intercepted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @@ æŸ¥çœ‹äº‹ä»¶æ˜¯å¦éœ€è¦å–æ¶ˆ</span></span><br><span class="line">        <span class="comment">// Check for cancelation.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</span><br><span class="line">                || actionMasked == MotionEvent.ACTION_CANCEL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update list of touch targets for pointer down, if needed.</span></span><br><span class="line">        <span class="comment">// 3.0 ä»¥ä¸Šï¼Œè¿™é‡Œé»˜è®¤ç½®ä½</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</span><br><span class="line">        TouchTarget newTouchTarget = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Down äº‹ä»¶çš„å¤„ç†æµç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3 å¦‚æœæ˜¯ Down äº‹ä»¶æˆ–è€…åœ¨å…è®¸å¤šæŒ‡è§¦æ‘¸çš„æ—¶å€™</span></span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                    || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class="line">                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">                <span class="comment">// å¤šæŒ‡è§¦æ‘¸</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex(); <span class="comment">// always 0 for down</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> idBitsToAssign = split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</span><br><span class="line">                        : TouchTarget.ALL_POINTER_IDS;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></span><br><span class="line">                <span class="comment">// have become out of sync.</span></span><br><span class="line">                removePointersFromTouchTargets(idBitsToAssign);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</span><br><span class="line">                <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</span><br><span class="line">                    <span class="comment">// Find a child that can receive the event.</span></span><br><span class="line">                    <span class="comment">// Scan children from front to back.</span></span><br><span class="line">                    <span class="comment">// 4 é»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªåˆ—è¡¨å°±æ˜¯ View æ·»åŠ çš„é¡ºåº</span></span><br><span class="line">                    <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></span><br><span class="line">                            &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class="line">                    <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                    <span class="comment">// 5 å€’å™éå†æ‰€æœ‰çš„å­ Viewï¼Œè¿™æ ·æœ€åæ·»åŠ çš„ï¼Œåœ¨æœ€ä¸Šé¢ç»˜åˆ¶çš„ View ä¼šé¦–å…ˆè¢«åˆ†æ´¾äº‹ä»¶</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> childIndex = customOrder</span><br><span class="line">                                ? getChildDrawingOrder(childrenCount, i) : i;</span><br><span class="line">                        <span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</span><br><span class="line">                                ? children[childIndex] : preorderedList.get(childIndex);</span><br><span class="line"></span><br><span class="line">                        ...</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 6 åˆ¤æ–­ View èƒ½å¦æ¥å— Touch äº‹ä»¶ï¼Œå¹¶ä¸”è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨æœ¬ View å†…éƒ¨</span></span><br><span class="line">                        <span class="keyword">if</span> (!canViewReceivePointerEvents(child)</span><br><span class="line">                                || !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                            ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 7 æŸ¥çœ‹ç›®æ ‡ View æ˜¯å¦å­˜åœ¨åœ¨ TargetView é“¾è¡¨ä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™è¯´æ˜å·²ç»å¤„ç†è¿‡ Down</span></span><br><span class="line">                        <span class="comment">// äº‹ä»¶ï¼Œä¸éœ€è¦å†å»å¤„ç†ä¸€æ¬¡ï¼ˆæƒ³è±¡ä¸€ä¸‹ä¸¤æ ¹æ‰‹æŒ‡åŒæ—¶è§¦æ‘¸ä¸€ä¸ª Viewï¼‰ï¼Œåªéœ€è¦è®°å½•ä¸€ä¸‹ç¬¬äºŒ</span></span><br><span class="line">                        <span class="comment">// æ¬¡è§¦æ‘¸çš„ PoniterId</span></span><br><span class="line">                        newTouchTarget = getTouchTarget(child);</span><br><span class="line">                        <span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// Child is already receiving touch within its bounds.</span></span><br><span class="line">                            <span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></span><br><span class="line">                            newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        resetCancelNextUpFlag(child);</span><br><span class="line">                        <span class="comment">// 8 åˆ†å‘äº‹ä»¶ç»™å­ View æˆ–è€…è‡ªå·±ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šé‡ç‚¹åˆ†æï¼Œå®ƒæ˜¯ ViewGroup äº‹ä»¶å¤„ç†çš„æ ¸å¿ƒ</span></span><br><span class="line">                        <span class="comment">// å¦‚æœè¿”å›trueï¼Œè¡¨ç¤ºäº‹ä»¶è¢«æˆåŠŸæ¶ˆè´¹</span></span><br><span class="line">                        <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line">                            <span class="comment">// Child wants to receive touch within its bounds.</span></span><br><span class="line">                            mLastTouchDownTime = ev.getDownTime();</span><br><span class="line">                            <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// childIndex points into presorted list, find original index</span></span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</span><br><span class="line">                                        mLastTouchDownIndex = j;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                mLastTouchDownIndex = childIndex;</span><br><span class="line">                            &#125;</span><br><span class="line">                            mLastTouchDownX = ev.getX();</span><br><span class="line">                            mLastTouchDownY = ev.getY();</span><br><span class="line">                            <span class="comment">// æŠŠ TargetView æ·»åŠ åˆ°é“¾è¡¨ä¸­å»ï¼Œå¹¶ä¸”æŒ‡æ˜å®ƒæ˜¯å¤„ç†å“ªäº› PointerId çš„</span></span><br><span class="line">                            newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                            <span class="comment">// ç½®ä½</span></span><br><span class="line">                            alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="comment">// è¿™ä¸ªæ—¶å€™ä¸€ä¸ª Down äº‹ä»¶å·²ç»æ‰¾åˆ°ç›®æ ‡ View å»æ¶ˆè´¹ï¼Œåç»­å°±ä¸ç”¨å†ç»§ç»­æ‰¾äº†</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// The accessibility focus didn't handle the event, so clear</span></span><br><span class="line">                        <span class="comment">// the flag and do a normal dispatch to all children.</span></span><br><span class="line">                        ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 9 å¦‚æœæ²¡æ‰¾åˆ°å¤„ç†å¯¹è±¡ï¼Œå°±æŠŠè¿™ä¸ª PointerId èµ‹å€¼ç»™æœ€æ—©æ·»åŠ çš„ TargetViewï¼Œã€Whyã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Did not find a child to receive the event.</span></span><br><span class="line">                    <span class="comment">// Assign the pointer to the least recently added target.</span></span><br><span class="line">                    newTouchTarget = mFirstTouchTarget;</span><br><span class="line">                    <span class="keyword">while</span> (newTouchTarget.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        newTouchTarget = newTouchTarget.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 10 æ‰€æœ‰ç±»å‹äº‹ä»¶çš„å¤„ç†æµç¨‹ï¼</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä¸€ä¸ªç›®æ ‡ Viewï¼Œå³è¿™ä¸ª ViewGroup é‡Œé¢çš„æ‰€æœ‰</span></span><br><span class="line">        <span class="comment">// Viewéƒ½ä¸æ¶ˆè´¹äº‹ä»¶ï¼Œåˆ™è°ƒç”¨ dispatchTransformedTouchEvent å¤„ç†ï¼Œè¿™ä¸ªåé¢é‡ç‚¹è¯´</span></span><br><span class="line">        <span class="comment">// Dispatch to touch targets.</span></span><br><span class="line">        <span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No touch targets so treat this as an ordinary view.</span></span><br><span class="line">            handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</span><br><span class="line">                        TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></span><br><span class="line">            <span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></span><br><span class="line">            TouchTarget predecessor = <span class="keyword">null</span>;</span><br><span class="line">            TouchTarget target = mFirstTouchTarget;</span><br><span class="line">            <span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> TouchTarget next = target.next;</span><br><span class="line">                <span class="comment">// é’ˆå¯¹ Down äº‹ä»¶ï¼Œå‰é¢å·²ç»æ‰¾åˆ° View å¤„ç†è¿‡äº†</span></span><br><span class="line">                <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</span><br><span class="line">                    handled = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 11 åˆ¤æ–­äº‹ä»¶æ˜¯å¦è¦å–æ¶ˆï¼Œä»¥ä¾¿äºåˆ†å‘æ­£ç¡®ç±»å‹çš„äº‹ä»¶</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</span><br><span class="line">                            || intercepted;</span><br><span class="line">                    <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class="line">                            target.child, target.pointerIdBits)) &#123;</span><br><span class="line">                        handled = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯ CANCEL äº‹ä»¶ï¼Œå°±æŠŠ TargetView ä»é“¾è¡¨ä¸­åˆ é™¤æ‰</span></span><br><span class="line">                    <span class="keyword">if</span> (cancelChild) &#123;</span><br><span class="line">                        <span class="comment">// è¯´æ˜æ˜¯ TargetView é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª</span></span><br><span class="line">                        <span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            mFirstTouchTarget = next;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            predecessor.next = next;</span><br><span class="line">                        &#125;</span><br><span class="line">                        target.recycle();</span><br><span class="line">                        target = next;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è‡³å°‘å¾ªç¯ä¸€æ¬¡æ‰ä¼šèµ‹å€¼</span></span><br><span class="line">                predecessor = target;</span><br><span class="line">                target = next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 12 é’ˆå¯¹ Up äº‹ä»¶åšçš„å¤„ç† â€”â€” é‡ç½®çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// Update list of touch targets for pointer up or cancel, if needed.</span></span><br><span class="line">        <span class="keyword">if</span> (canceled</span><br><span class="line">                || actionMasked == MotionEvent.ACTION_UP</span><br><span class="line">                || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">            resetTouchState();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> idBitsToRemove = <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex);</span><br><span class="line">            removePointersFromTouchTargets(idBitsToRemove);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹ˆé•¿çš„ä»£ç ï¼Œåªèƒ½åœ¨ä»£ç ä¸­è¿›è¡Œæ³¨é‡Šï¼Œå¤§æ¦‚çš„æµç¨‹æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ï¼š</p>
<p>ä¸‹é¢è¿˜æ˜¯åˆ†å°ç‚¹ä¸€ä¸€è¡¥å……ã€‚</p>
<h4 id="cancelAndClearTouchTargetsäº‹ä»¶æ¸…ç†"><a href="#cancelAndClearTouchTargetsäº‹ä»¶æ¸…ç†" class="headerlink" title="cancelAndClearTouchTargetsäº‹ä»¶æ¸…ç†"></a><code>cancelAndClearTouchTargets</code>äº‹ä»¶æ¸…ç†</h4><p>åœ¨ 1 å¤„ï¼Œä¸€æ—¦å‘ç°äº‹ä»¶ç±»å‹æ˜¯ Down ç±»å‹ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯äº‹ä»¶æ¸…ç†ï¼Œå› ä¸º Down äº‹ä»¶æ˜¯ä¸€ä¸ªäº‹ä»¶æµçš„å¼€å§‹ï¼ŒViewGroup ä¸€æ—¦æ¥æ”¶åˆ°è¯¥äº‹ä»¶ï¼Œåˆ™æ„å‘³ç€åº”è¯¥åˆå§‹åŒ–çŠ¶æ€æ¥å‡†å¤‡å¤„ç†ä¸€ä¸ªæ–°çš„äº‹ä»¶æµã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆæ¸…ç†çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cancels and clears all touch targets.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAndClearTouchTargets</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> syntheticEvent = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            event = MotionEvent.obtain(now, now,</span><br><span class="line">                    MotionEvent.ACTION_CANCEL, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0</span>);</span><br><span class="line">            event.setSource(InputDevice.SOURCE_TOUCHSCREEN);</span><br><span class="line">            syntheticEvent = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (TouchTarget target = mFirstTouchTarget; target != <span class="keyword">null</span>; target = target.next) &#123;</span><br><span class="line">            resetCancelNextUpFlag(target.child);</span><br><span class="line">            dispatchTransformedTouchEvent(event, <span class="keyword">true</span>, target.child, target.pointerIdBits);</span><br><span class="line">        &#125;</span><br><span class="line">        clearTouchTargets();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (syntheticEvent) &#123;</span><br><span class="line">            event.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¼ å…¥çš„ event ä¸º Nullï¼Œé‚£ä¹ˆä¼š Mock ä¸€ä¸ª CANCEL äº‹ä»¶å‡ºæ¥ï¼Œå¦åˆ™ä¼šä½¿ç”¨åŸ Eventï¼Œå°½é‡ä¿ç•™åŸå§‹ä¿¡æ¯ã€‚ç„¶åéå†æ‰€æœ‰çš„ TargetViewï¼Œé‡ç½®çŠ¶æ€å¹¶åˆ†å‘äº‹ä»¶ï¼Œè¿™åˆ†ä¸ºä¸¤æ­¥ã€‚ä¸‹é¢ä¼šè¯¦ç»†åˆ†æã€‚çŠ¶æ€é‡ç½®ä¹‹åï¼Œä¼šè°ƒç”¨<code>clearTouchTargets()</code>æ–¹æ³•æŠŠæ‰€æœ‰çš„ TargetViewæ¸…é™¤æ‰ã€‚è¿™æ ·å°±å®Œæˆäº†åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œæ€»ç»“ä¸€ä¸‹æ ¸å¿ƒå°±æ˜¯ä¸¤æ­¥ï¼š</p>
<ol>
<li>ä¹‹å‰æ­£åœ¨æ¶ˆè´¹äº‹ä»¶çš„Viewï¼Œå…¨éƒ¨å‘é€ä¸€æ¬¡ CANCEL äº‹ä»¶ï¼›</li>
<li>è®°å½•æ¶ˆè´¹äº‹ä»¶çš„Viewé“¾ï¼Œæ¸…ç©ºï¼›</li>
</ol>
<h5 id="resetCancelNextUpFlag"><a href="#resetCancelNextUpFlag" class="headerlink" title="resetCancelNextUpFlag"></a><code>resetCancelNextUpFlag</code></h5><p>è¿™ä¸ªæ–¹æ³•åœ¨å¾ˆå¤šåœ°æ–¹éƒ½è¢«è°ƒç”¨ï¼Œè¿™é‡Œç»Ÿä¸€è§£é‡Šä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Resets the cancel next up flag.</span></span><br><span class="line"><span class="comment"> * Returns true if the flag was previously set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">resetCancelNextUpFlag</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((view.mPrivateFlags &amp; PFLAG_CANCEL_NEXT_UP_EVENT) != <span class="number">0</span>) &#123;</span><br><span class="line">        view.mPrivateFlags &amp;= ~PFLAG_CANCEL_NEXT_UP_EVENT;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯é‡ç½®ä¸€ä¸ªæ ‡å¿—ä½ï¼š<code>PFLAG_CANCEL_NEXT_UP_EVENT</code>ã€‚è¿™ä¸ªæ ‡å¿—ä½æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ³¨é‡Šæ˜¯è¿™æ ·è¯´çš„ï¼šIndicates whether the view is temporarily detachedã€‚æ‰“å¼€å¯ä»¥çŒœæµ‹ä¸€ä¸‹ï¼šå¦‚æœä¸€ä¸ª View æ­£åœ¨ä» Window ä¸Š detachï¼ˆä¸€ä¸ªä¸­é—´æ€ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ ‡å¿—ä½å°±ä¼šè¢«ç½®ä½ã€‚å¦‚æœè°ƒç”¨è¯¥æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä½è¢«ç½®ï¼Œåˆ™è¿”å›trueã€‚è€Œè¿™é‡Œçš„æ¸…ç†ï¼Œåªæ˜¯é‡ç½®è€Œå·²ï¼Œå¯¹äºæ˜¯å¦ç½®ä½å¹¶ä¸å…³å¿ƒã€‚</p>
<h5 id="dispatchTransformedTouchEvent"><a href="#dispatchTransformedTouchEvent" class="headerlink" title="dispatchTransformedTouchEvent"></a><code>dispatchTransformedTouchEvent</code></h5><p>è¿™ä¸ªæ–¹æ³•åœ¨ 8 å¤„å’Œ 10 å¤„éƒ½å‡ºç°è¿‡ï¼Œå…¶å®ƒçš„æ­¥éª¤ä¸»è¦æ˜¯è´Ÿè´£å®šä½äº‹ä»¶åº”è¯¥ä¼ é€’ç»™ä»€ä¹ˆ Viewï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯åšå®é™…åˆ†å‘çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Transforms a motion event into the coordinate space of a particular child view,</span></span><br><span class="line"><span class="comment"> * filters out irrelevant pointer ids, and overrides its action if necessary.</span></span><br><span class="line"><span class="comment"> * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></span><br><span class="line"><span class="function"><span class="params">        View child, <span class="keyword">int</span> desiredPointerIdBits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> handled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨é‡Šè¯´çš„æä¸ºæ¸…æ¥šï¼ŒCANCEL äº‹ä»¶æ˜¯ä¸€ä¸ªç‰¹æ®Šäº‹ä»¶ï¼Œé‡ç‚¹åœ¨äºäº‹ä»¶ç±»å‹è€Œéå†…å®¹</span></span><br><span class="line">    <span class="comment">// Canceling motions is a special case.  We don't need to perform any transformations</span></span><br><span class="line">    <span class="comment">// or filtering.  The important part is the action, not the contents.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldAction = event.getAction();</span><br><span class="line">    <span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</span><br><span class="line">        event.setAction(MotionEvent.ACTION_CANCEL);</span><br><span class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// child å¦‚æœæ˜¯Nullï¼Œå°±åˆ†å‘äº‹ä»¶åˆ°çˆ¶ç±»ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨å‰é¢åˆ†æçš„ View çš„ dispatchTouchEvent æ–¹æ³•</span></span><br><span class="line">            handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™ä¸‹å‘åˆ° child å»å¤„ç† CANCEL äº‹ä»¶</span></span><br><span class="line">            handled = child.dispatchTouchEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">        event.setAction(oldAction);</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calculate the number of pointers to deliver.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldPointerIdBits = event.getPointerIdBits();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒäº‹ä»¶æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸º 0ï¼Œè¯´æ˜äº‹ä»¶ä¸åº”è¯¥ç”±è¿™ä¸ª View å¤„ç†</span></span><br><span class="line">    <span class="comment">// If for some reason we ended up in an inconsistent state where it looks like we</span></span><br><span class="line">    <span class="comment">// might produce a motion event with no pointers in it, then drop the event.</span></span><br><span class="line">    <span class="keyword">if</span> (newPointerIdBits == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªè¦ child ä¸º nullï¼Œå°±ä¼šè°ƒç”¨çˆ¶ç±»ï¼Œä¹Ÿå°±æ˜¯ View çš„ dispatchTouchEvent æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// If the number of pointers is the same and we don't need to perform any fancy</span></span><br><span class="line">    <span class="comment">// irreversible transformations, then we can reuse the motion event for this</span></span><br><span class="line">    <span class="comment">// dispatch as long as we are careful to revert any changes we make.</span></span><br><span class="line">    <span class="comment">// Otherwise we need to make a copy.</span></span><br><span class="line">    <span class="keyword">final</span> MotionEvent transformedEvent;</span><br><span class="line">    <span class="keyword">if</span> (newPointerIdBits == oldPointerIdBits) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span> || child.hasIdentityMatrix()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">                handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</span><br><span class="line">                <span class="comment">// ä¸ºäº‹ä»¶åšåç§»</span></span><br><span class="line">                event.offsetLocation(offsetX, offsetY);</span><br><span class="line">                <span class="comment">// åˆ†å‘äº‹ä»¶</span></span><br><span class="line">                handled = child.dispatchTouchEvent(event);</span><br><span class="line">                <span class="comment">// æ¢å¤äº‹ä»¶</span></span><br><span class="line">                event.offsetLocation(-offsetX, -offsetY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> handled;</span><br><span class="line">        &#125;</span><br><span class="line">        transformedEvent = MotionEvent.obtain(event);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ†åŒ–å‡ºä¸€ä¸ªæ–°çš„äº‹ä»¶</span></span><br><span class="line">        transformedEvent = event.split(newPointerIdBits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Perform any necessary transformations and dispatch.</span></span><br><span class="line">    <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">        handled = <span class="keyword">super</span>.dispatchTouchEvent(transformedEvent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</span><br><span class="line">        transformedEvent.offsetLocation(offsetX, offsetY);</span><br><span class="line">        <span class="keyword">if</span> (! child.hasIdentityMatrix()) &#123;</span><br><span class="line">            transformedEvent.transform(child.getInverseMatrix());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        handled = child.dispatchTouchEvent(transformedEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Done.</span></span><br><span class="line">    transformedEvent.recycle();</span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒå…¶å®åªåšä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>äº‹ä»¶æ˜¯å¦æ˜¯ CANCEL çš„ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥åˆ†å‘å³å¯ï¼›</li>
<li>ç¡®å®šåˆ†å‘çš„äº‹ä»¶åˆæ³•ï¼Œä¸»è¦æ˜¯çœ‹ newPointerIdBits æ˜¯å¦ä¸º 0ï¼Œè¯»è€…è¦å»ç†è§£è¿™ä¸ªæ–¹æ³•ï¼Œéœ€è¦çœ‹ä¸€ä¸‹<code>MotionEvent.getPointerIdBits()</code>æ–¹æ³•ï¼›</li>
<li>é‡æ–°è®¡ç®—äº‹ä»¶çš„åæ ‡ï¼Œå¹¶åˆ†å‘ï¼Œåˆ†å‘çš„æ—¶å€™åˆ¤æ–­ child æ˜¯å¦ä¸º nullï¼Œå¦‚æœä¸º nullï¼Œåˆ™åˆ†å‘ç»™ ViewGroup çš„çˆ¶ç±»ä¹Ÿå°±æ˜¯ View å¤„ç†ï¼Œå¦åˆ™åˆ†å‘ç»™å­ View å¤„ç†ï¼›</li>
</ol>
<h4 id="äº‹ä»¶æ‹¦æˆª"><a href="#äº‹ä»¶æ‹¦æˆª" class="headerlink" title="äº‹ä»¶æ‹¦æˆª"></a>äº‹ä»¶æ‹¦æˆª</h4><p>2 å¤„çš„åˆ¤æ–­çœ‹ä¸Šå»å¯èƒ½æ¯”è¾ƒéš¾æ‡‚ï¼Œæ¢ä¸€ä¸ªç­‰ä»·çš„åˆ¤æ–­å°±æ˜ç™½äº†ï¼š<code>actionMasked != MotionEvent.ACTION_DOWN &amp;&amp; mFirstTouchTarget == null</code>ã€‚<code>mFirstTouchTarget</code>ä¸º nullï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰æ‰¾åˆ° View å¤„ç†äº‹ä»¶ï¼ŒAction ä¸ä¸º Downï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯äº‹ä»¶æµçš„èµ·å§‹ï¼Œé‚£è¿™ä¸ªäº‹ä»¶å®Œå…¨å°±æ˜¯éæ³•çš„ï¼Œä¸åº”è¯¥ä¼ é€’åˆ°è¿™é‡Œæ¥ï¼Œå› æ­¤è‚¯å®šä¸ä¼šä¸‹å‘ï¼Œæ‰€ä»¥<code>intercepted</code>å°±ç½®ä¸º trueã€‚</p>
<p>if è¯­å¥é‡Œé¢çš„åˆ¤æ–­å’Œæ–¹æ³•è°ƒç”¨ï¼Œå°±ä¸åšè§£é‡Šäº†ã€‚è¯»è€…å»äº†è§£ä¸€ä¸‹<code>requestDisallowInterceptTouchEvent()</code>æ–¹æ³•å’Œ<code>onInterceptTouchEvent()</code>å°±å¥½ï¼Œè¯´ç™½äº†å°±æ˜¯ ViewGroup æä¾›çš„äº‹ä»¶æ‹¦æˆªä»¥åŠç¦æ­¢äº‹ä»¶æ‹¦æˆªçš„ä¸¤ä¸ªæ–¹æ³•ã€‚è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæ–¹æ³•è¿”å›ä¸åŒçš„ç»“æœå¯¹äº‹ä»¶æµå¤„ç†é€ æˆçš„å½±å“ã€‚</p>
<p>è¿™é‡Œæ¥ä¸ªå°¾å·´ï¼Œåœ¨åˆ¤æ–­å®Œäº‹ä»¶æ‹¦æˆªåï¼Œ@@ å¤„åˆè°ƒç”¨äº†ä¸€æ¬¡<code>resetCancelNextUpFlag()</code>æ–¹æ³•ï¼Œè¿™ä¸€æ¬¡å®ƒçš„è¿”å›ç»“æœå°±è¢«è®°å½•ä¸‹æ¥äº†ï¼Œç”¨äºåˆ¤æ–­äº‹ä»¶æ˜¯å¦è¦å–æ¶ˆï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥åˆ¤æ–­ä¸€ä¸ª View æ˜¯å¦èƒ½åˆæ³•çš„æ¥æ”¶äº‹ä»¶ã€‚</p>
<h4 id="å¤šæŒ‡è§¦æ‘¸"><a href="#å¤šæŒ‡è§¦æ‘¸" class="headerlink" title="å¤šæŒ‡è§¦æ‘¸"></a>å¤šæŒ‡è§¦æ‘¸</h4><p>3 å¤„åœ¨åˆ¤æ–­çš„æ—¶å€™æ˜¯è€ƒè™‘åˆ°äº†å¤šæŒ‡è§¦æ‘¸çš„æƒ…å†µçš„ï¼Œä¸€ä¸ª ViewGroup é‡Œé¢å¯èƒ½æœ‰å¤šä¸ª Viewï¼Œè¿™ä¸€ä¸ªæˆ–è€…å¤šä¸ª View å¯ä»¥åŒæ—¶è¢«å¤šæ ¹æ‰‹æŒ‡ Touchï¼Œé‚£ä¹ˆåœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œå°±éœ€è¦è®°å½•å“ªä¸ª View è¢«å“ªä¸ª Pointerï¼ˆå½¢è±¡ä¸€ç‚¹å¯ä»¥æƒ³è±¡æˆæ‰‹æŒ‡ï¼‰è§¦æ‘¸ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡ TouchTarget çš„ pointerIdBits æ¥è®°å½•çš„ï¼ŒTouchTarget å¯ä»¥ä»£è¡¨ç€ä¸€ä¸ªè§¦æ‘¸å¯¹è±¡ï¼Œå®ƒå°è£…äº†ä¸€ä¸ª View ä»¥åŠä¸è§¦æ‘¸ç›¸å…³çš„ä¿¡æ¯åœ¨å†…éƒ¨ã€‚</p>
<h4 id="View-æ˜¯å¦èƒ½æ¥å—äº‹ä»¶"><a href="#View-æ˜¯å¦èƒ½æ¥å—äº‹ä»¶" class="headerlink" title="View æ˜¯å¦èƒ½æ¥å—äº‹ä»¶"></a>View æ˜¯å¦èƒ½æ¥å—äº‹ä»¶</h4><p>6 å¤„åˆ¤æ–­ä¸€ä¸ªViewæ˜¯å¦èƒ½æ¥å—äº‹ä»¶ï¼Œè°ƒç”¨äº†è¿™æ ·ä¸€ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns true if a child view can receive pointer events.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">canViewReceivePointerEvents</span><span class="params">(View child)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE</span><br><span class="line">                || child.getAnimation() != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªåˆ¤æ–­æœ‰ä¾æ®çš„æ˜¯ View æ˜¯å¦å¯è§ï¼Œæˆ–è€… View æ˜¯å¦æ­£åœ¨æ‰§è¡ŒåŠ¨ç”»ã€‚</p>
<h4 id="å…³äºACTION-XXXXå’ŒACTION-POINTER-XXXX"><a href="#å…³äºACTION-XXXXå’ŒACTION-POINTER-XXXX" class="headerlink" title="å…³äºACTION_XXXXå’ŒACTION_POINTER_XXXX"></a>å…³äº<code>ACTION_XXXX</code>å’Œ<code>ACTION_POINTER_XXXX</code></h4><p>XXXX ä»£è¡¨ç€ DOWN æˆ–è€… UPï¼ˆä¸å­˜åœ¨<code>ACTION_POINTER_MOVE</code>ï¼‰ï¼Œè¿™é‡Œå¯ä»¥ä»å®éªŒå¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</p>
<ol>
<li>ç¬¬ä¸€ä¸ªæŒ‰ä¸‹å»çš„äº‹ä»¶ç±»å‹æ˜¯<code>ACTION_DOWN</code>ï¼Œå…¶ä½™ä¸è®ºæŒ‰ä¸‹å¤šå°‘ä¸ªæ‰‹æŒ‡ï¼Œäº‹ä»¶ç±»å‹éƒ½æ˜¯<code>ACTION_POINTER_DOWN</code>;</li>
<li>ä¸è®ºæŒ‰ä¸‹å»å’ŒæŠ¬èµ·æ¥çš„é¡ºåºï¼Œæœ€åä¸€ä¸ªæŠ¬èµ·çš„æ‰‹æŒ‡ï¼Œå®ƒè§¦å‘çš„äº‹ä»¶ç±»å‹å°±æ˜¯<code>ACTION_UP</code>ï¼Œè¿™ä¸ªä¸<code>ACTION_DOWN</code>å¹¶ä¸ä¸€å®šå‘ç”Ÿåœ¨åŒä¸€æ ¹æ‰‹æŒ‡ä¸Šï¼›</li>
<li><p>PointerId å¯ä»¥å”¯ä¸€æ ‡è®°ä¸€ä¸ªæ‰‹æŒ‡è§¦æ‘¸äº‹ä»¶ï¼Œç¬¬ä¸€ä¸ªè§¦æ‘¸çš„æ‰‹æŒ‡ ID ä¸º1, ç¬¬äºŒä¸ªè§¦æ‘¸çš„æ‰‹æŒ‡ ID ä¸º2ï¼Œç¬¬ä¸‰ä¸ªè§¦æ‘¸çš„æ‰‹æŒ‡ ID ä¸º 3ï¼Œä»¥æ­¤ç±»æ¨â€¦å› æ­¤å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•å¾ˆæ–¹ä¾¿çš„å°†äº‹ä»¶å‘ç”Ÿæ—¶æ‰‹æŒ‡çš„è§¦æ‘¸æƒ…å†µåæ˜ æˆä¸€ä¸ª Bit ç»„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getPointerIdBits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> idBits = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> pointerCount = nativeGetPointerCount(mNativePtr);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</span><br><span class="line">		idBits |= <span class="number">1</span> &lt;&lt; nativeGetPointerId(mNativePtr, i);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> idBits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å¦‚æœæˆ‘æœ‰å››æ ¹æ‰‹æŒ‡è§¦æ‘¸ç€å±å¹•ï¼Œé‚£ä¹ˆé€šè¿‡è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å¾—åˆ°çš„<code>1111</code>ï¼ˆäºŒè¿›åˆ¶ï¼Œåé¢åŒå«ä¹‰çš„æ•°å­—ä¹Ÿæ˜¯äºŒè¿›åˆ¶è¡¨ç¤ºï¼‰ï¼Œå¦‚æœæˆ‘ç¬¬ä¸€ä¸ªæŒ‰ä¸‹çš„æ‰‹æŒ‡æŠ¬èµ·ï¼Œé‚£ä¹ˆè®¡ç®—å‡ºæ¥çš„å€¼å°±æ˜¯<code>1110</code>ï¼Œç¬¬å››æ ¹æŒ‰ä¸‹çš„æ‰‹æŒ‡æŠ¬èµ·ï¼Œè®¡ç®—å‡ºæ¥çš„å€¼å°±æ˜¯<code>0110</code>ï¼Œä»¥æ­¤ç±»æ¨â€¦å› æ­¤åœ¨ MOVE ä¸­å¯ä»¥é€šè¿‡è¿™ç§æ‰‹æ®µç¡®è®¤æ˜¯å“ªå‡ æ ¹æ‰‹æŒ‡å¤„äºæŒ‰ä¸‹çŠ¶æ€ã€‚é€šè¿‡ä»¥ä¸‹æ–¹æ³•å¯ä»¥è·çŸ¥æ¯ä¸€æ ¹æ‰‹æŒ‡çš„åæ ‡ä½ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pointerCount = event.getPointerCount();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</span><br><span class="line">	<span class="keyword">int</span> id = event.getPointerId(i);</span><br><span class="line">	<span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX(i);</span><br><span class="line">	<span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>ç›¸å…³çš„è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯<code>getActionIndex()</code>ï¼Œè¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨äº‹ä»¶ç±»å‹ä¸º<code>ACTION_POINTER_DOWN</code>æˆ–è€…<code>ACTION_POINTER_UP</code>çš„æ—¶å€™æ‰æœ‰æ„ä¹‰ï¼Œå…¶ä½™æƒ…å†µä¸‹è¿”å›çš„éƒ½æ˜¯0ã€‚è¯¦ç»†å¯è§é™„è¡¨æ•°æ®ã€‚</p>
</blockquote>
<p>é…åˆä»¥ä¸Šå‡ ä¸ªç»“è®ºï¼Œçœ‹ 12 å¤„çš„æ—¶å€™ä¼šæ›´åŠ æ¸…æ™°ï¼šåœ¨<code>ACTION_UP</code>çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ‰€æœ‰æ‰‹æŒ‡å·²ç»ç¦»å¼€ Viewï¼Œæ‰€ä»¥å¯ä»¥é‡ç½®çŠ¶æ€ã€‚è€Œ View ä¸­åªä¼šå¤„ç†<code>ACTION_UP</code>å’Œ<code>ACTION_DOWN</code>äº‹ä»¶ï¼Œå› æ­¤å¯¹äº View æ¥è¯´ï¼ˆè¿™é‡Œæ˜¯ç‹­ä¹‰çš„ Viewï¼Œä¸åŒ…æ‹¬ ViewGroupï¼‰ï¼Œåªæœ‰å•æŒ‡äº‹ä»¶ã€‚</p>
<h4 id="ACTION-CANCELäº‹ä»¶å‘ç”Ÿæ—¶æœº"><a href="#ACTION-CANCELäº‹ä»¶å‘ç”Ÿæ—¶æœº" class="headerlink" title="ACTION_CANCELäº‹ä»¶å‘ç”Ÿæ—¶æœº"></a><code>ACTION_CANCEL</code>äº‹ä»¶å‘ç”Ÿæ—¶æœº</h4><p>11 å¤„<strong>æŒ‡æ˜äº†<code>ACTION_CANCEL</code>äº‹ä»¶å‘ç”Ÿçš„æ—¶æœºï¼šçˆ¶ ViewGroup æ‹¦æˆªäº†å­ View çš„äº‹ä»¶æµ</strong>ã€‚ å…·ä½“å¯è§<a href="https://developer.android.com/reference/android/view/ViewGroup.html#onInterceptTouchEvent(android.view.MotionEvent" target="_blank" rel="noopener"><code>VierGroup.onInterceptTouchEvent()</code></a>)æ–¹æ³•çš„ API æ–‡æ¡£ã€‚</p>
<p><strong>å…¶ä½™çš„ç‚¹éƒ½ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Œç¬¬ â‘¨ å¤„ç•™æœ‰ä¸€ä¸ªç–‘é—®ï¼šè¿™é‡Œä¸ºä»€ä¹ˆè¦æŠŠ PointerId è®°å½•åˆ°ç¬¬ä¸€ä¸ªæ·»åŠ çš„ TargetView ä¸­å»ï¼Ÿã€‚</strong></p>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>è‡³æ­¤ï¼ŒView å’Œ ViewGroup çš„äº‹ä»¶åˆ†å‘å¤„ç†æœºåˆ¶å·²ç»è§£æå®Œæ¯•ã€‚</p>
<p>äº‹ä»¶è¢«åˆ†å‘åˆ° ViewGroup ä¹‹åï¼Œä¼šç”± ViewGroup æŸ¥çœ‹å“ªäº›å­ View èƒ½å¤Ÿæ¥å—è¯¥äº‹ä»¶ï¼Œåˆ¤æ–­çš„åˆå§‹æ ‡å‡†å¾ˆç®€å•ï¼šå‚è€ƒæ–¹æ³•<code>canViewReceivePointerEvents()</code>å’Œ<code>isTransformedTouchPointInView()</code>ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„çš„å­ Viewï¼Œå°è¯•è°ƒç”¨<code>dispatchTransformedTouchEvent()</code>æ–¹æ³•å°†äº‹ä»¶åˆ†å‘ç»™å­ View ï¼Œå¦‚æœå­ View å¤„ç†äº‹ä»¶æˆåŠŸï¼ˆå¤„ç†è¿‡ç¨‹å‚è€ƒå‰é¢çš„å›¾ï¼‰ï¼Œåˆ™è¯¥ View è¢«åŠ å…¥åˆ° ViewGroup çš„ TargetView é“¾ä¸­å»ï¼Œåç»­çš„äº‹ä»¶ä¼šç»§ç»­åˆ†å‘ç»™å®ƒï¼Œå¦åˆ™å®ƒå°†ä¸èƒ½å†æ¥å—äº‹ä»¶ã€‚</p>
<p>å¦‚æœ ViewGroup æ‰¾ä¸åˆ°è¿™æ ·ä¸€ä¸ªå­ View è¿›è¡Œäº‹ä»¶å¤„ç†ï¼Œå°±ä¼šå°è¯•è°ƒç”¨çˆ¶ç±»çš„<code>dispatchTouchEvent()</code>æ–¹æ³•å¤„ç†äº‹ä»¶ï¼Œæ­¤æ—¶ ViewGroup æŠŠè‡ªå·±å½“åšä¸€ä¸ª View æ¥çœ‹å¾…ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯ ViewGroup è¿›è¡Œäº‹ä»¶åˆ†å‘ å’Œ View å¤„ç†äº‹ä»¶çš„ä¸»æµç¨‹ã€‚</p>
<h2 id="é™„è¡¨"><a href="#é™„è¡¨" class="headerlink" title="é™„è¡¨"></a>é™„è¡¨</h2><p>ä¸‹é¢æ˜¯ä¸€å¼ ä¸‰æ ¹æ‰‹æŒ‡æ“ä½œ View çš„æ—¶å€™ï¼Œå®ƒæ”¶åˆ°çš„äº‹ä»¶çš„ç›¸å…³ä¿¡æ¯æ‰“å°ï¼Œæ‰“å°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> actionIndex = ev.getActionIndex();</span><br><span class="line">	<span class="keyword">int</span> pointerCount = ev.getPointerCount();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; pointerCount; index++) &#123;</span><br><span class="line">		Log.e(TAG, <span class="string">"PointId: "</span> + ev.getPointerId(index) + <span class="string">" # ActionIndex: "</span> + actionIndex + <span class="string">" # ActionType: "</span> + ev.getActionMasked());</span><br><span class="line">		Log.e(TAG, <span class="string">"X"</span> + index + <span class="string">": "</span> + ev.getX(index) + <span class="string">" # Y"</span> + index + <span class="string">": "</span> + ev.getY(index) + <span class="string">" # PointId: "</span> + ev.getPointerId(actionIndex));</span><br><span class="line">	&#125;</span><br><span class="line">	Log.e(TAG, <span class="string">"======================"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">09-19 10:14:06.045  PointId: 0 # ActionIndex: 0 # ActionType: 0</span><br><span class="line">09-19 10:14:06.045  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">06.045</span>  ======================</span><br><span class="line">09-19 10:14:06.584  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:06.584  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">06.584</span>  ======================</span><br><span class="line">09-19 10:14:06.584  PointId: 0 # ActionIndex: 1 # ActionType: 5</span><br><span class="line">09-19 10:14:06.584  X0: 224.0 # Y0: 1232.0 # PointId: 1</span><br><span class="line">09-19 10:14:06.584  PointId: 1 # ActionIndex: 1 # ActionType: 5</span><br><span class="line">09-19 10:14:06.584  X1: 483.0 # Y1: 973.0 # PointId: 1</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">06.584</span>  ======================</span><br><span class="line">09-19 10:14:06.953  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:06.953  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:06.953  PointId: 1 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:06.953  X1: 483.0 # Y1: 973.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">06.953</span>  ======================</span><br><span class="line">09-19 10:14:06.954  PointId: 0 # ActionIndex: 2 # ActionType: 5</span><br><span class="line">09-19 10:14:06.954  X0: 224.0 # Y0: 1232.0 # PointId: 2</span><br><span class="line">09-19 10:14:06.954  PointId: 1 # ActionIndex: 2 # ActionType: 5</span><br><span class="line">09-19 10:14:06.954  X1: 483.0 # Y1: 973.0 # PointId: 2</span><br><span class="line">09-19 10:14:06.954  PointId: 2 # ActionIndex: 2 # ActionType: 5</span><br><span class="line">09-19 10:14:06.954  X2: 811.0 # Y2: 1076.0 # PointId: 2</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">06.954</span>  ======================</span><br><span class="line">09-19 10:14:07.264  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.264  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.264  PointId: 1 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.264  X1: 483.0 # Y1: 973.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.264  PointId: 2 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.264  X2: 809.0 # Y2: 1076.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.264</span>  ======================</span><br><span class="line">09-19 10:14:07.280  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.280  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.280  PointId: 1 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.280  X1: 483.0 # Y1: 973.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.280  PointId: 2 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.280  X2: 807.0 # Y2: 1076.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.280</span>  ======================</span><br><span class="line">09-19 10:14:07.297  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.297  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.297  PointId: 1 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.297  X1: 483.0 # Y1: 973.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.297  PointId: 2 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.297  X2: 805.0 # Y2: 1076.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.297</span>  ======================</span><br><span class="line">09-19 10:14:07.314  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.314  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.314  PointId: 1 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.314  X1: 483.0 # Y1: 973.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.314  PointId: 2 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.314  X2: 803.0 # Y2: 1076.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.314</span>  ======================</span><br><span class="line">09-19 10:14:07.331  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.331  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.331  PointId: 1 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.331  X1: 483.0 # Y1: 973.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.331  PointId: 2 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.331  X2: 802.0 # Y2: 1076.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.331</span>  ======================</span><br><span class="line">09-19 10:14:07.405  PointId: 0 # ActionIndex: 1 # ActionType: 6</span><br><span class="line">09-19 10:14:07.405  X0: 224.0 # Y0: 1232.0 # PointId: 1</span><br><span class="line">09-19 10:14:07.405  PointId: 1 # ActionIndex: 1 # ActionType: 6</span><br><span class="line">09-19 10:14:07.406  X1: 483.0 # Y1: 973.0 # PointId: 1</span><br><span class="line">09-19 10:14:07.406  PointId: 2 # ActionIndex: 1 # ActionType: 6</span><br><span class="line">09-19 10:14:07.406  X2: 802.0 # Y2: 1076.0 # PointId: 1</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.406</span>  ======================</span><br><span class="line">09-19 10:14:07.415  PointId: 0 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.415  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.415  PointId: 2 # ActionIndex: 0 # ActionType: 2</span><br><span class="line">09-19 10:14:07.415  X1: 803.0 # Y1: 1076.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.415</span>  ======================</span><br><span class="line">09-19 10:14:07.421  PointId: 0 # ActionIndex: 0 # ActionType: 6</span><br><span class="line">09-19 10:14:07.421  X0: 224.0 # Y0: 1232.0 # PointId: 0</span><br><span class="line">09-19 10:14:07.421  PointId: 2 # ActionIndex: 0 # ActionType: 6</span><br><span class="line">09-19 10:14:07.421  X1: 803.0 # Y1: 1076.0 # PointId: 0</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.421</span>  ======================</span><br><span class="line">09-19 10:14:07.421  PointId: 2 # ActionIndex: 0 # ActionType: 1</span><br><span class="line">09-19 10:14:07.421  X0: 803.0 # Y0: 1076.0 # PointId: 2</span><br><span class="line"><span class="number">09</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">07.421</span>  ======================</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šæ‰‹æŒ‡æŠ¬èµ·çš„é¡ºåºä¸ä¸€è‡´ï¼Œä¹Ÿä¼šå¼•èµ·ä¸€äº›æ•°æ®å˜åŒ–ï¼Œè¯»è€…è¦ç†è§£ï¼Œå¯ä»¥è‡ªå·±å¤åˆ¶ä»£ç åšå®éªŒã€‚</p>
<blockquote>
<p>1 æ˜¯<code>ACTION_UP</code>ï¼Œ2 æ˜¯<code>ACTION_DOWN</code>ï¼Œ5 æ˜¯<code>ACTION_POINTER_DOWN</code>ï¼Œ6 æ˜¯<code>ACTION_POINTER_UP</code>ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ReactiveX åˆæ¢]]></title>
      <url>http://www.timebridge.space/2016/07/30/ReactiveX/</url>
      <content type="html"><![CDATA[<p>ReactiveXï¼Œ<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener">GitHub</a> ä¸Šçš„çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>A library for composing asynchronous and event-based programs by using observable sequences.</p>
<p>It extends the observer pattern to support sequences of data/events and <strong>adds operators</strong> that allow you to compose sequences together declaratively <strong>while abstracting away concerns about things like low-level threading, synchronization, thread-safety and concurrent data structures</strong>.</p>
</blockquote>
<p>å®ƒé€šè¿‡æ‰©å±•è§‚å¯Ÿè€…æ¨¡å¼æ¥æ”¯æŒåŸºäºæ•°æ®/äº‹ä»¶æµçš„å¼€å‘æ¨¡å¼ï¼Œå…è®¸å£°æ˜ä¸€ç»„æ“ä½œæ¥å¤„ç†æ•°æ®/äº‹ä»¶ï¼ŒåŒæ—¶èƒ½å¤Ÿé¿å…å¼€å‘è€…èŠ±ç²¾åŠ›å»å…³æ³¨ä¸€äº›åº•å±‚çš„æ¦‚å¿µï¼Œæ¯”å¦‚çº¿ç¨‹ã€åŒæ­¥ã€çº¿ç¨‹å®‰å…¨ä»¥åŠå¹¶å‘æ•°æ®ç»“æ„ã€‚</p>
<p>ä¸‹é¢æ¥è¯¦ç»†è®¨è®ºä¸€ä¸‹å®ƒçš„ç‰¹ç‚¹ã€‚<a id="more"></a></p>
<h2 id="Rxçš„ç†å¿µ"><a href="#Rxçš„ç†å¿µ" class="headerlink" title="Rxçš„ç†å¿µ"></a>Rxçš„ç†å¿µ</h2><p>Rx æ˜¯åŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„ï¼Œè¿™ä¸ªæ¨¡å¼åœ¨æ—¥å¸¸åº”ç”¨å¼€å‘ä¸­éå¸¸å¸¸è§ï¼Œè¿™é‡Œä¸å¤šè¯´ã€‚Rx åœ¨è§‚å¯Ÿè€…æ¨¡å¼çš„åŸºç¡€ä¹‹ä¸Šï¼Œæ˜ç¡®æå‡ºå››ä¸ªæ¦‚å¿µï¼š</p>
<ol>
<li>è¢«è§‚å¯Ÿè€…(Observable)ï¼›</li>
<li>è§‚å¯Ÿè€…(Subscriber/Observer)ï¼›</li>
<li>äº‹ä»¶(Event)ï¼›</li>
<li>è§‚å¯Ÿå…³ç³»(Subscription)ï¼›</li>
</ol>
<p>è¢«è§‚å¯Ÿè€…ä»£è¡¨çš„æ˜¯äº‹ä»¶çš„å‘å‡ºè€…ï¼Œè§‚å¯Ÿè€…æ˜¯è¿™ä¸ªäº‹ä»¶çš„å¤„ç†è€…ï¼Œäº‹ä»¶å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ¶ˆæ¯æˆ–è€…ä¸€å—æ•°æ®ï¼ˆè¿™é‡Œå¯ä»¥æƒ³æƒ³EventBusï¼‰ï¼Œè§‚å¯Ÿå…³ç³»åˆ™æ˜¯ç”¨æ¥æè¿° A è®¢é˜… B å‘å‡ºçš„ E äº‹ä»¶è¿™æ ·ä¸€ä¸ªå…³ç³»ï¼Œè¿™ä¸ªå…³ç³»æœ‰æ—¶å€™éœ€è¦è¢«æ˜ç¡®çš„ç®¡ç†ï¼Œæ¯”å¦‚è§£é™¤è®¢é˜…ï¼Œåˆ¤æ–­æ˜¯å¦è¿˜åœ¨è®¢é˜…ã€‚è¿™å››ä¸ªæ¦‚å¿µå…±åŒç»„æˆäº†Rxçš„æ ¸å¿ƒï¼Œæ‹¬å·é‡Œé¢çš„ç±»åæ˜¯RxJavaå¯¹è¿™å››ä¸ªæ¦‚å¿µçš„æŠ½è±¡ã€‚</p>
<p>é™¤äº†æŠ½è±¡è¿™å››ä¸ªæ¦‚å¿µä»¥å¤–ï¼Œæœ€å‰é¢é‚£æ®µå®šä¹‰è¿˜æœ‰ä¸€ä¸ªå…³é”®çš„åœ°æ–¹ï¼š<strong>add operators</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æ·»åŠ æ“ä½œã€‚Rxä¸ä½†æä¾›äº†å°†äº‹ä»¶ä» Observale å‘é€åˆ° Subscriber çš„èƒ½åŠ›ï¼Œè¿˜å…è®¸å¯¹äº‹ä»¶æ·»åŠ ä¸€äº›æ“ä½œï¼Œå› æ­¤å¯¹äº Rx æ¥è¯´ï¼Œç¨‹åºé€»è¾‘å®é™…æ˜¯è¿™æ ·çš„ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Rxç†å¿µ.png" alt="Rxç†å¿µ"></div>

<p>å¦‚å›¾ï¼Œä½¿ç”¨ Rx æ„å»ºä¸€æ®µé€»è¾‘æ—¶ï¼Œæ€è·¯å°±æ˜¯è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯å®šä¹‰å¥½å›¾ä¸­çš„å„ä¸ªæ¨¡å—ï¼Œä»¥ä¾¿äºå®ƒä»¬èƒ½å¤Ÿä¸²èµ·æ¥å·¥ä½œã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Rx"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Rx" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Rx"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Rx</h2><p>è¿™é‡Œå»ºè®®è¯»è€…å…ˆå»çœ‹ä¸€ä¸‹<a href="https://github.com/rengwuxian" target="_blank" rel="noopener">æ‰”ç‰©çº¿</a>ç«¥é‹çš„æ–‡ç« <a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="noopener">ç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£</a>ã€‚è¿™ç¯‡æ–‡ç« ä¸­æœ‰å‡ ä¸ªç»å…¸çš„ä¾‹å­ï¼Œè¯´æ˜äº†ä½¿ç”¨ Rx çš„åœºæ™¯ã€‚</p>
<p>ä¸ªäººè®¤ä¸º Rx çš„ä½¿ç”¨æ˜¯æœ‰æ¡ä»¶çš„ï¼š</p>
<ol>
<li>ä¸€ä¸ªè¾ƒé•¿çš„é€»è¾‘é“¾ &amp; å­˜åœ¨åµŒå¥—ï¼›</li>
<li>ä¸€ä¸ªè¾ƒé•¿çš„é€»è¾‘é“¾ &amp; çº¿ç¨‹é—´åˆ‡æ¢ï¼›</li>
</ol>
<p>è¾ƒé•¿çš„é€»è¾‘é“¾æ˜¯æŒ‡ä»å·²æœ‰çš„ä¿¡æ¯åˆ°æœ€ç»ˆéœ€è¦è¾“å‡ºçš„ä¿¡æ¯ä¹‹é—´æ˜¯æœ‰ä¸€ä¸ªæ¯”è¾ƒé•¿ã€æ¯”è¾ƒå¤æ‚çš„å¤„ç†è¿‡ç¨‹çš„ï¼Œæ¯”å¦‚è¯´æ‰”ç‰©çº¿æ‰€ä¸¾çš„<code>imageCollectorView</code>ä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦éœ€è¦ç»è¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>éå†æ‰€æœ‰çš„æ–‡ä»¶å¤¹ï¼›</li>
<li>éå†æ–‡ä»¶å¤¹ä¸‹é¢æ‰€æœ‰çš„æ–‡ä»¶ï¼›</li>
<li>è¿‡æ»¤å‡ºâ€.pngâ€ç»“å°¾çš„æ–‡ä»¶ï¼›</li>
<li>ä»æ–‡ä»¶ä¸­è§£æå‡ºBitmapï¼›</li>
<li>æŠŠBitmapæ·»åŠ åˆ°<code>imageCollectorView</code>ä¸­å»ï¼›</li>
</ol>
<p>è¿™ä¸ªé“¾å¾ˆé•¿ï¼Œå¹¶ä¸”åµŒå¥—ç€å¤šå±‚å¾ªç¯ï¼Œå¦‚æœç›´æ¥ä»¥æ™®é€šçš„<code>for</code>å¾ªç¯æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œçœ‹ä¸Šå»ä¼šæ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯ä¿®æ”¹æˆ Rx çš„å½¢å¼ä¹‹åï¼Œå°±å˜å¾—æä¸ºæ•´é½ï¼Œä»¥ Lambda å½¢å¼æŸ¥çœ‹ä»£ç æ›´æ˜¯äº«å—ã€‚ä¸ä½†å¦‚æ­¤ï¼Œè¿™ä¸ªä¾‹å­è¿˜æ¶‰åŠåˆ°çº¿ç¨‹é—´åˆ‡æ¢ï¼š</p>
<ol>
<li>åœ¨è§£æå‡º Bitmap ä¹‹å‰ï¼Œæ•´ä¸ªè¿‡ç¨‹éƒ½åº”è¯¥å‘ç”Ÿåœ¨åå°çº¿ç¨‹ä¸­ï¼›</li>
<li>ç¬¬5æ­¥åˆ™éœ€è¦è°ƒåº¦åˆ°ä¸»çº¿ç¨‹ä¸­è¿›è¡Œï¼›</li>
</ol>
<p>ä¸€èˆ¬æ¥è¯´åœ¨çº¿ç¨‹é—´è¿›è¡Œåˆ‡æ¢çš„ä»£ç éƒ½éå¸¸ä¸‘é™‹ï¼Œå°¤å…¶æ˜¯éœ€è¦æ¥å›åˆ‡æ¢çš„æ—¶å€™ã€‚Rx ç®€åŒ–äº†è¿™ç§åˆ‡æ¢æ‰€éœ€è¦çš„å½¢å¼ï¼Œåªéœ€è¦ç®€å•çš„è°ƒç”¨ä¸€ä¸ª API å°±å¯ä»¥æå®šã€‚</p>
<p>ä¸ºä»€ä¹ˆæˆ‘ä¸€å®šè¦åœ¨è¾ƒé•¿çš„é€»è¾‘é“¾åé¢æ·»åŠ å‡ ä¸ªæ¡ä»¶å‘¢ï¼Ÿå› ä¸ºæˆ‘è§‰å¾— Rx å¯¹ä»£ç çš„å¯è¯»æ€§æ˜¯æœ‰æ‰€é™ä½çš„ï¼Œå¦‚æœä»…ä»…æ˜¯ä¸€äº›å¹³å¦çš„é€»è¾‘ï¼Œä½¿ç”¨æ™®é€šçš„ Java ä»£ç ä¼šæ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œä¸€å±‚åµŒå¥—ä¸éœ€è¦ï¼Œç®€å•çš„ä»åå°çº¿ç¨‹åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ï¼Œä½¿ç”¨ AsyncTask å¯èƒ½ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚è€Œå½“ä½¿ç”¨æ™®é€šçš„ Java ä»£ç å®ç°å‡ºæ¥çš„ä¸œè¥¿å·²ç»è®©ä½ æŠ“ç‹‚ï¼Œæˆ‘è§‰å¾—å¯ä»¥å»å°è¯•ä½¿ç”¨ Rxã€‚</p>
<p>å¹³æ—¶è¿›è¡Œä¸šåŠ¡å¼€å‘çš„æ—¶å€™ä¸€èˆ¬ä¸å¤ªä¼šé‡åˆ°è¿™ä¹ˆå¤æ‚çš„æƒ…å†µï¼Œå› ä¸ºæˆ‘ä»¬ä¼šç”¨åˆ°å¾ˆå¤šçš„åº“ï¼Œæ¯”å¦‚Volleyï¼Œè¿™äº›åº“é€šè¿‡å°è£…åå°çº¿ç¨‹æ“ä½œï¼Œå·²ç»æŠ¹é™¤äº†å¾ˆå¤§ä¸€éƒ¨åˆ†çš„å¤æ‚æ€§ï¼Œå› æ­¤ä¸šåŠ¡å±‚ä½¿ç”¨ Rx çš„å¯èƒ½æ€§å¥½åƒä¸å¤§ã€‚ä½†æ˜¯åƒ Retrofit è¿™æ ·çš„åº•å±‚åº“ï¼Œæ¶‰åŠåˆ°å¤æ‚çš„æµç¨‹æ“ä½œçš„ï¼Œä½¿ç”¨ Rx ä¼šæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå†ä¹Ÿä¸ç”¨æ‰‹åŠ¨ new é‚£ä¹ˆå¤šçš„ Handler äº†ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>äº‹å®ä¸Šï¼ŒRx çš„äº®ç‚¹å°±åœ¨äºçº¿ç¨‹çš„è°ƒåº¦ä»¥åŠä¸°å¯Œçš„ Operatorï¼Œä»¥ä¾¿äºå¼€å‘è€…é€šè¿‡ç®€å•çš„é“¾å¼è°ƒç”¨å°±å¯ä»¥å¾ˆä¼˜é›…çš„å®ç°ä¸€ä¸ªåŠŸèƒ½ã€‚</p>
<p>ç²—ç•¥çš„å­¦ä¹ ä¼šæœ‰ç²—ç•¥çš„è®ºæ–­ï¼Œå‰é¢ç»™å‡ºçš„æ¡ä»¶å¾ˆå¯èƒ½éå¸¸ç‰‡é¢ï¼Œç­‰æ·±å…¥å­¦ä¹ å„ç±»æ“ä½œç¬¦ä»¥åŠ Rx çš„å…¶ä½™ç‰¹æ€§ä¹‹åï¼Œå†æ¥è¡¥å……ä¿®æ­£ã€‚</p>
<h2 id="å…¶ä½™èµ„æ–™"><a href="#å…¶ä½™èµ„æ–™" class="headerlink" title="å…¶ä½™èµ„æ–™"></a>å…¶ä½™èµ„æ–™</h2><p>å…ˆå ä¸ªå‘ï¼Œåé¢æ…¢æ…¢è¡¥ä¸Šã€‚</p>
<ol>
<li><a href="http://reactivex.io/intro.html" target="_blank" rel="noopener">ReactiveX ç½‘ç«™</a></li>
<li><a href="https://github.com/ReactiveX" target="_blank" rel="noopener">GitHub ReactiveX Group</a></li>
</ol>
<p>ReactiveX ç½‘ç«™ä¸Šé¢æœ‰å¯¹å„ç±»æ“ä½œçš„å¸¦å›¾é‡Šä¹‰ã€‚</p>
<p><a href="https://www.gitbook.com/book/mcxiaoke/rxdocs/details" target="_blank" rel="noopener">æ–‡æ¡£ä¸­æ–‡ç¿»è¯‘</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Binderä¹‹ServiceæŸ¥è¯¢]]></title>
      <url>http://www.timebridge.space/2016/06/21/binder-service-lookup/</url>
      <content type="html"><![CDATA[<p>å‰ä¸€ç¯‡æ–‡ç« <a href="http://www.muzileecoding.com/framework/binder-service-register.html" target="_blank" rel="noopener">Binderä¹‹Serviceæ³¨å†Œ</a>æè¿°äº†ä¸€ä¸ª Service å¦‚ä½•åœ¨ SM ä¸­å®ŒæˆæœåŠ¡æ³¨å†Œï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦æ¢ç´¢å¦‚ä½•å‘ SM æŸ¥è¯¢è¿™ä¸ªæœåŠ¡ã€‚æœ‰å‰ä¸€ç¯‡çš„åŸºç¡€ï¼Œå¸Œæœ›è¿™ä¸€ç¯‡å¯ä»¥å¿«ä¸€äº›~</p>
<blockquote>
<p>ã€æ³¨æ„ã€‘æœåŠ¡æŸ¥è¯¢å’ŒæœåŠ¡æ³¨å†Œè¿‡ç¨‹å…¶å®éå¸¸æ¥è¿‘ï¼Œå› æ­¤æœ¬æ–‡ä¼šå¤§é‡å¼•ç”¨å‰ä¸€ç¯‡æ–‡ç« çš„åˆ†æè¿‡ç¨‹ï¼Œè¯»è€…å¯ä»¥ä»”ç»†é˜…è¯»ä¸Šä¸€ç¯‡æ–‡ç« ä¹‹åå†æ¥é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚</p>
</blockquote>
<p>æœ¬æ–‡å°†ä»¥ <strong>å‰æ–‡</strong> æŒ‡ä»£æ–‡ç« <a href="http://www.muzileecoding.com/framework/binder-service-register.html" target="_blank" rel="noopener">Binderä¹‹Serviceæ³¨å†Œ</a>ã€‚<a id="more"></a></p>
<h2 id="ç ”ç©¶å…¥å£"><a href="#ç ”ç©¶å…¥å£" class="headerlink" title="ç ”ç©¶å…¥å£"></a>ç ”ç©¶å…¥å£</h2><p>ä¸Šä¸€ç¯‡ç ”ç©¶çš„å¯¹è±¡æ˜¯ MediaServer å’Œ MediaPlayerServiceï¼Œå¯ä»¥çŒœæµ‹ä¸€ä¸‹åœ¨æ•´ä¸ªç³»ç»Ÿä¸­å¿…ç„¶æœ‰<code>getMediaPlayerService()</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œåœ¨ AndroidXRef ä¸­æœç´¢ â€œgetMediaPlayerServiceâ€ å­—ç¬¦ä¸²ï¼Œå¾ˆå¿«å°±å¯ä»¥å‘ç°æœ‰å¾ˆå¤šç±»ä¸­è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬é€‰æ‹© â€œIMediaDeathNotifier.cppâ€ ä¸­çš„ä¸€æ®µä»£ç ä½œä¸ºå…¥å£è¿›è¡Œç ”ç©¶ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// establish binder interface to MediaPlayerService</span></span><br><span class="line"><span class="comment">/*static*/</span><span class="keyword">const</span> sp&lt;IMediaPlayerService&gt;&amp;</span><br><span class="line">IMediaDeathNotifier::getMediaPlayerService()</span><br><span class="line">&#123;</span><br><span class="line">    LOGV(<span class="string">"getMediaPlayerService"</span>);</span><br><span class="line">    Mutex::Autolock _l(sServiceLock);</span><br><span class="line">    <span class="keyword">if</span> (sMediaPlayerService.get() == <span class="number">0</span>) &#123;</span><br><span class="line">        sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">        sp&lt;IBinder&gt; binder;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            binder = sm-&gt;getService(String16(<span class="string">"media.player"</span>));</span><br><span class="line">            <span class="keyword">if</span> (binder != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             usleep(<span class="number">500000</span>); <span class="comment">// 0.5 s</span></span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sDeathNotifier == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sDeathNotifier = <span class="keyword">new</span> DeathNotifier();</span><br><span class="line">    &#125;</span><br><span class="line">    binder-&gt;linkToDeath(sDeathNotifier);</span><br><span class="line">    sMediaPlayerService = interface_cast&lt;IMediaPlayerService&gt;(binder);</span><br><span class="line">    &#125;</span><br><span class="line">    LOGE_IF(sMediaPlayerService == <span class="number">0</span>, <span class="string">"no media player service!?"</span>);</span><br><span class="line">    <span class="keyword">return</span> sMediaPlayerService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä»£ç å…¶å®å°±æ˜¯<code>getMediaPlayerService</code>æ–¹æ³•çš„å®ç°ä»£ç ã€‚å¯ä»¥çœ‹åˆ°æ ¸å¿ƒä»£ç å…¶å®åªæœ‰ä¸‰è¡Œï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">binder = sm-&gt;getService(String16(<span class="string">"media.player"</span>));</span><br><span class="line">sMediaPlayerService = interface_cast&lt;IMediaPlayerService&gt;(binder);</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€è¡Œä»£ç æ˜¯è·å– SM å®ä¾‹çš„ï¼Œè¿™ä¸€ç‚¹åœ¨å‰æ–‡ä¸­å·²ç»æœ‰éå¸¸è¯¦ç»†çš„è§£æè¿‡ç¨‹ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤è§£æäº†ã€‚é‡ç‚¹æ˜¯åé¢ä¸¤å¥ã€‚</p>
<p><strong>ã€æ¶‰åŠæ–‡ä»¶ã€‘</strong></p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ä½ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td>IMediaDeathNotifier.cpp</td>
<td>/frameworks/base/media/libmedia/IMediaDeathNotifier.cpp</td>
</tr>
</tbody>
</table>
<p>åŒ…æ‹¬å‰æ–‡æ‰€æåˆ°çš„æ–‡ä»¶ã€‚</p>
<h2 id="å‘é€æœåŠ¡è·å–å‘½ä»¤"><a href="#å‘é€æœåŠ¡è·å–å‘½ä»¤" class="headerlink" title="å‘é€æœåŠ¡è·å–å‘½ä»¤"></a>å‘é€æœåŠ¡è·å–å‘½ä»¤</h2><p>æœåŠ¡è·å–è°ƒç”¨çš„ä»£ç æ˜¯:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binder = sm-&gt;getService(String16(<span class="string">"media.player"</span>));</span><br></pre></td></tr></table></figure>
<p><code>getService()</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">virtual</span> sp&lt;IBinder&gt; getService(<span class="keyword">const</span> String16&amp; name) <span class="keyword">const</span> &#123;</span><br><span class="line">	<span class="keyword">unsigned</span> n;</span><br><span class="line">	<span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; <span class="number">5</span>; n++)&#123;</span><br><span class="line">		<span class="comment">// è°ƒç”¨checkServiceæ–¹æ³•è·å–</span></span><br><span class="line">		sp&lt;IBinder&gt; svc = checkService(name);</span><br><span class="line">		<span class="keyword">if</span> (svc != <span class="literal">NULL</span>) <span class="keyword">return</span> svc;</span><br><span class="line">		LOGI(<span class="string">"Waiting for service %s...\n"</span>, String8(name).<span class="built_in">string</span>());</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">virtual</span> sp&lt;IBinder&gt; checkService( <span class="keyword">const</span> String16&amp; name) <span class="keyword">const</span> &#123;</span><br><span class="line">	Parcel data, reply;</span><br><span class="line">	data.writeInterfaceToken(IServiceManager::getInterfaceDescriptor());</span><br><span class="line">	data.writeString16(name);</span><br><span class="line">	remote()-&gt;transact(CHECK_SERVICE_TRANSACTION, data, &amp;reply);</span><br><span class="line">	<span class="keyword">return</span> reply.readStrongBinder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™äº›æ–¹æ³•åå­—è™½ç„¶ç¬¬ä¸€æ¬¡è§ï¼Œå¯æ˜¯å†…å®¹åº”è¯¥éå¸¸ç†Ÿæ‚‰äº† â€”â€” å’Œæ³¨å†ŒæœåŠ¡éå¸¸éå¸¸æ¥è¿‘ï¼Œåªä¸è¿‡è¿™ä¸€æ¬¡å‘½ä»¤æœ‰æ‰€å˜åŒ–ã€‚å…³äº<code>transact()</code>æ–¹æ³•çš„è¿½è¸ªï¼Œä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿæœ‰éå¸¸è¯¦ç»†çš„åˆ†æï¼Œè¯¦è§å‰æ–‡ 5.2 èŠ‚ã€‚æ ¹æ®å‰æ–‡ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šæ¥åˆ°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç : writeTransactionData(BC_TRANSACTION, flags, handle, code, data, NULL);</span></span><br><span class="line"><span class="comment">// å‚æ•°è§£é‡Š: handle ä¸º 0ï¼Œcode ä¸º CHECK_SERVICE_TRANSACTIONï¼Œ binderFlags æ˜¯ TF_ACCEPT_FDS;</span></span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::writeTransactionData(<span class="keyword">int32_t</span> cmd, <span class="keyword">uint32_t</span> binderFlags,</span><br><span class="line">    <span class="keyword">int32_t</span> handle, <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, <span class="keyword">status_t</span>* statusBuffer)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    binder_transaction_data tr;</span><br><span class="line"></span><br><span class="line">    tr.target.handle = handle;</span><br><span class="line">    tr.code = code;</span><br><span class="line">    tr.flags = binderFlags;</span><br><span class="line">    tr.cookie = <span class="number">0</span>;</span><br><span class="line">    tr.sender_pid = <span class="number">0</span>;</span><br><span class="line">    tr.sender_euid = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">status_t</span> err = data.errorCheck();</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    	<span class="comment">// å°†ä¹‹å‰å†™åœ¨ data ä¸­çš„æ•°æ®å†æ¢ä¸€ç§å½¢å¼å†™åˆ° binder_transaction_data ä¸­</span></span><br><span class="line">        tr.data_size = data.ipcDataSize(); </span><br><span class="line">        tr.data.ptr.buffer = data.ipcData(); </span><br><span class="line">        tr.offsets_size = data.ipcObjectsCount()*<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>);</span><br><span class="line">        tr.data.ptr.offsets = data.ipcObjects(); </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusBuffer) &#123;</span><br><span class="line">        tr.flags |= TF_STATUS_CODE;</span><br><span class="line">        *statusBuffer = err;</span><br><span class="line">        tr.data_size = <span class="keyword">sizeof</span>(<span class="keyword">status_t</span>);</span><br><span class="line">        tr.data.ptr.buffer = statusBuffer;</span><br><span class="line">        tr.offsets_size = <span class="number">0</span>;</span><br><span class="line">        tr.data.ptr.offsets = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (mLastError = err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mOut.writeInt32(cmd);<span class="comment">//BC_TRANSACTION</span></span><br><span class="line">    mOut.write(&amp;tr, <span class="keyword">sizeof</span>(tr));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº†å‘½ä»¤ä¸ä¸€æ ·ï¼Œæ•°æ®ä¸Šä¹Ÿæœ‰å·®åˆ«äº†ã€‚å‰æ–‡ä¸­æ˜¯è¿›è¡ŒæœåŠ¡æ³¨å†Œï¼Œæ‰€ä»¥æ•°æ®ä¸­æ˜¯æºå¸¦äº†ä¸€ä¸ªåºåˆ—åŒ–çš„æœåŠ¡èŠ‚ç‚¹çš„ï¼Œä½†è¿™é‡Œå¾ˆç®€å•ï¼Œåªæœ‰æƒ³è¦è·å–çš„æœåŠ¡åå­—è€Œå·²ã€‚</p>
<h2 id="SM-å¤„ç†å‘½ä»¤"><a href="#SM-å¤„ç†å‘½ä»¤" class="headerlink" title="SM å¤„ç†å‘½ä»¤"></a>SM å¤„ç†å‘½ä»¤</h2><p>ä¸­é—´çš„é©±åŠ¨å¤„ç†å’Œå‰æ–‡åŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œç•¥å»åˆ†æï¼Œä¸»è¦æ˜¯çœ‹ SM å¦‚ä½•å¤„ç†è¿™ä¸ªå‘½ä»¤ï¼Œå¤„ç†å‡½æ•°æ˜¯<code>svcmgr_handler</code>: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> svcmgr_id[] = &#123; </span><br><span class="line">    <span class="string">'a'</span>,<span class="string">'n'</span>,<span class="string">'d'</span>,<span class="string">'r'</span>,<span class="string">'o'</span>,<span class="string">'i'</span>,<span class="string">'d'</span>,<span class="string">'.'</span>,<span class="string">'o'</span>,<span class="string">'s'</span>,<span class="string">'.'</span>,</span><br><span class="line">    <span class="string">'I'</span>,<span class="string">'S'</span>,<span class="string">'e'</span>,<span class="string">'r'</span>,<span class="string">'v'</span>,<span class="string">'i'</span>,<span class="string">'c'</span>,<span class="string">'e'</span>,<span class="string">'M'</span>,<span class="string">'a'</span>,<span class="string">'n'</span>,<span class="string">'a'</span>,<span class="string">'g'</span>,<span class="string">'e'</span>,<span class="string">'r'</span> </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">svcmgr_handler</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_txn *txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_io *msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_io *reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> *s;</span><br><span class="line">    <span class="keyword">unsigned</span> len;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">    <span class="keyword">uint32_t</span> strict_policy;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// svcmgr_handle è¢«èµ‹å€¼ä¸º svcmgrï¼Œå³BINDER_SERVICE_MANAGERï¼Œå³0</span></span><br><span class="line">    <span class="keyword">if</span> (txn-&gt;target != svcmgr_handle)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Equivalent to Parcel::enforceInterface(), reading the RPC</span></span><br><span class="line">    <span class="comment">// header with the strict mode policy mask and the interface name.</span></span><br><span class="line">    <span class="comment">// Note that we ignore the strict_policy and don't propagate it</span></span><br><span class="line">    <span class="comment">// further (since we do no outbound RPCs anyway).</span></span><br><span class="line">    strict_policy = bio_get_uint32(msg);</span><br><span class="line">    s = bio_get_string16(msg, &amp;len);</span><br><span class="line">    <span class="comment">// svcmgr_idæ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œè§æœ€ä¸Šé¢ï¼Œè¿™é‡Œåˆ¤æ–­æ˜¯é€šè¿‡çš„ï¼Œå› ä¸ºsè¯»å–å‡ºæ¥å°±æ˜¯"android.os.IServiceManager"</span></span><br><span class="line">    <span class="keyword">if</span> ((len != (<span class="keyword">sizeof</span>(svcmgr_id) / <span class="number">2</span>)) ||</span><br><span class="line">        <span class="built_in">memcmp</span>(svcmgr_id, s, <span class="keyword">sizeof</span>(svcmgr_id))) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"invalid id %s\n"</span>, str8(s));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(txn-&gt;code) &#123;</span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_GET_SERVICE:</span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_CHECK_SERVICE:</span><br><span class="line">        s = bio_get_string16(msg, &amp;len); <span class="comment">// "media.player"</span></span><br><span class="line">        ptr = do_find_service(bs, s, len);</span><br><span class="line">        <span class="keyword">if</span> (!ptr)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        bio_put_ref(reply, ptr);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bio_put_uint32(reply, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œå…¶å®å¯ä»¥çœ‹åˆ°ï¼Œè·å–æœåŠ¡å’ŒæŸ¥è¯¢æœåŠ¡çš„å¤„ç†æµç¨‹æ˜¯ä¸€æ ·çš„ã€‚</p>
<blockquote>
<p>è‡³äºä¸ºä»€ä¹ˆä¼šè½åˆ°<code>SVC_MGR_CHECK_SERVICE</code>è¿™ä¸ªå‘½ä»¤ï¼Œå‰æ–‡ä¹Ÿæœ‰è§£é‡Šã€‚</p>
</blockquote>
<p>åœ¨è·å–æœåŠ¡åç§°ä¹‹åï¼Œè°ƒç”¨<code>do_find_service</code>æ–¹æ³•æ¥æŸ¥è¯¢æœåŠ¡: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">do_find_service</span><span class="params">(struct binder_state *bs, <span class="keyword">uint16_t</span> *s, <span class="keyword">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">    si = find_svc(s, len);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    LOGI("check_service('%s') ptr = %p\n", str8(s), si ? si-&gt;ptr : 0);</span></span><br><span class="line">    <span class="keyword">if</span> (si &amp;&amp; si-&gt;ptr) &#123;</span><br><span class="line">        <span class="keyword">return</span> si-&gt;ptr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct svcinfo *<span class="title">find_svc</span><span class="params">(<span class="keyword">uint16_t</span> *s16, <span class="keyword">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (si = svclist; si; si = si-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((len == si-&gt;len) &amp;&amp;</span><br><span class="line">            !<span class="built_in">memcmp</span>(s16, si-&gt;name, len * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> si;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°<code>find_svc</code>å‰æ–‡å·²ç»è§£æè¿‡äº†ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯æ‰¾åˆ°åœ¨ svclist ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„ svcinfo èŠ‚ç‚¹ï¼Œåç§°ä¸éœ€è¦æŸ¥æ‰¾çš„æœåŠ¡åç§°ä¸€è‡´ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿”å› svcinfo çš„ ptr å­—æ®µï¼Œptr å­—æ®µçš„æ¥æºå‰æ–‡ä¹Ÿæœ‰è§£é‡Š: æœåŠ¡åœ¨ SM ä¸­åˆ†é…å¾—åˆ°çš„ handle å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿”å›è¿™ä¸ª handle å€¼å°±å¥½äº†ã€‚</p>
<p>æ‰¾åˆ° ptr ä¹‹åï¼Œæˆ‘ä»¬å›åˆ°<code>do_find_service</code>ï¼Œåœ¨è¿™é‡Œä¼šè°ƒç”¨<code>bio_put_ref</code>æ–¹æ³•:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bio_put_ref</span><span class="params">(struct binder_io *bio, <span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_object</span> *<span class="title">obj</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ptr)</span><br><span class="line">        obj = bio_alloc_obj(bio);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        obj = bio_alloc(bio, <span class="keyword">sizeof</span>(*obj));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!obj)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    obj-&gt;flags = <span class="number">0x7f</span> | FLAT_BINDER_FLAG_ACCEPTS_FDS;</span><br><span class="line">    obj-&gt;type = BINDER_TYPE_HANDLE;</span><br><span class="line">    obj-&gt;pointer = ptr;</span><br><span class="line">    obj-&gt;cookie = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰å¿…è¦å¥½å¥½åˆ†æä¸€ä¸‹ binder_io è¿™ä¸ªç»“æ„ä½“ç›¸å…³çš„æ–¹æ³•äº†ï¼Œå®ƒä»¬é›†ä¸­åœ¨ â€œbinder.câ€ æ–‡ä»¶ä¸­ã€‚é¦–å…ˆæ¥çœ‹<code>bio_alloc_obj</code>æ–¹æ³•: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct binder_object *<span class="title">bio_alloc_obj</span><span class="params">(struct binder_io *bio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_object</span> *<span class="title">obj</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä¸‹é¢è§£é‡Š bio_alloc æ–¹æ³•</span></span><br><span class="line">    obj = bio_alloc(bio, <span class="keyword">sizeof</span>(*obj));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (obj &amp;&amp; bio-&gt;offs_avail) &#123;</span><br><span class="line">    	<span class="comment">// è¡¨ç¤ºåç§»æ•°æ®å¯è®°å½•æ•°ç›®åˆå°‘äº†1ï¼Œå› ä¸ºä¸‹é¢å³å°†è®°å½•æ–°çš„åç§»ä¿¡æ¯</span></span><br><span class="line">        bio-&gt;offs_avail--;</span><br><span class="line">        <span class="comment">// è®°å½•æ–°çš„ binder_object åœ¨ç»“æ„ä½“ä¸­çš„åç§»é‡</span></span><br><span class="line">        *bio-&gt;offs++ = ((<span class="keyword">char</span>*) obj) - ((<span class="keyword">char</span>*) bio-&gt;data0);</span><br><span class="line">        <span class="comment">// è¿”å› binder_object ç»“æ„ä½“çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bio-&gt;flags |= BIO_F_OVERFLOW;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å£°æ˜äº†ä¸€ä¸ª <code>binder_object</code> çš„ç»“æ„ä½“ï¼Œå®ä¾‹åŒ–æ–¹æ³•è°ƒç”¨çš„æ˜¯<code>bio_alloc</code>: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">bio_alloc</span><span class="params">(struct binder_io *bio, <span class="keyword">uint32_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    size = (size + <span class="number">3</span>) &amp; (~<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (size &gt; bio-&gt;data_avail) &#123;</span><br><span class="line">        bio-&gt;flags |= BIO_F_OVERFLOW;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> *ptr = bio-&gt;data;</span><br><span class="line">        bio-&gt;data += size;</span><br><span class="line">        bio-&gt;data_avail -= size;</span><br><span class="line">        <span class="keyword">return</span> ptr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•éå¸¸ç®€å•ï¼Œé¦–å…ˆæ£€æµ‹ä¼ å…¥çš„å‚æ•° binder_io æ˜¯å¦è¿˜æœ‰è¶³å¤Ÿçš„å®¹é‡åˆ†é… size çš„ç©ºé—´ï¼Œå¦‚æœè¶³å¤Ÿï¼Œå°±æ“ä½œ data å’Œ data_avail å˜é‡ï¼Œä»…è¿™æ ·æ¥è¡¨ç¤ºç©ºé—´åˆ†é…ã€‚æ–¹æ³•ä¼šè¿”å›åˆ†é…ç©ºé—´çš„èµ·å§‹åœ°å€ã€‚ç»¼ä¸Šï¼Œè¿™ç»„æ–¹æ³•ä»¥åŠ binder_io ç»“æ„ä½“å…¶å®æ˜¯å¯¹å†…å­˜åˆ†é…çš„ä¸€ä¸ªå°è£…ã€‚</p>
<p>å›åˆ°<code>bio_alloc_obj</code>æ–¹æ³•åçš„ä»£ç éƒ½æœ‰æ³¨é‡Šï¼Œä¸éš¾ç†è§£ã€‚å†å›åˆ°<code>bio_put_ref</code>æ–¹æ³•åï¼Œä¼šåœ¨è¯¥ç»“æ„ä½“ä¸­å¡«å……ä»¥ä¸‹æ•°æ®: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">obj-&gt;flags = <span class="number">0x7f</span> | FLAT_BINDER_FLAG_ACCEPTS_FDS;</span><br><span class="line">obj-&gt;type = BINDER_TYPE_HANDLE;</span><br><span class="line">obj-&gt;pointer = ptr;</span><br><span class="line">obj-&gt;cookie = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™éƒ¨åˆ†æ•°æ®å¾ˆé‡è¦ï¼Œåé¢è¿˜ä¼šç”¨åˆ°ã€‚å›åˆ°<code>svcmgr_handler</code>å‡½æ•°ï¼Œè¿˜ä¼šæ‰§è¡Œä¸‹é¢è¯­å¥æ‰ä¼šè¿”å›:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bio_put_uint32(reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bio_put_uint32</span><span class="params">(struct binder_io *bio, <span class="keyword">uint32_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> *ptr = bio_alloc(bio, <span class="keyword">sizeof</span>(n));</span><br><span class="line">    <span class="keyword">if</span> (ptr)</span><br><span class="line">        *ptr = n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯åœ¨ binder_io ç»“æ„ä½“ä¸­åˆ†é…ç©ºé—´å†™å…¥æ•°æ®ã€‚æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå›åˆ°å‡½æ•°<code>binder_parse</code>ä¸­:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_parse</span><span class="params">(struct binder_state *bs, struct binder_io *bio,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">uint32_t</span> *ptr, <span class="keyword">uint32_t</span> size, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> *end = ptr + (size / <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd = *ptr++;</span><br><span class="line">        <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">            ......</span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION: &#123;</span><br><span class="line">        	<span class="comment">//è¯¥ç»“æ„ä½“å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_txn</span> *<span class="title">txn</span> = (<span class="title">void</span> *) <span class="title">ptr</span>;</span></span><br><span class="line">            <span class="keyword">if</span> ((end - ptr) * <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>) &lt; <span class="keyword">sizeof</span>(struct binder_txn)) &#123;</span><br><span class="line">                LOGE(<span class="string">"parse: txn too small!\n"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            binder_dump_txn(txn);</span><br><span class="line">            <span class="keyword">if</span> (func) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> rdata[<span class="number">256</span>/<span class="number">4</span>];</span><br><span class="line">                <span class="comment">// è¯¥ç»“æ„ä½“å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">msg</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">reply</span>;</span></span><br><span class="line">                <span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">                bio_init(&amp;reply, rdata, <span class="keyword">sizeof</span>(rdata), <span class="number">4</span>);</span><br><span class="line">                bio_init_from_txn(&amp;msg, txn);</span><br><span class="line">                <span class="comment">// åˆšåˆšåœ¨è¿™é‡Œï¼Œä¸æ¸…æ¥šçš„å¯ä»¥çœ‹å‰æ–‡</span></span><br><span class="line">                res = func(bs, txn, &amp;msg, &amp;reply);</span><br><span class="line">                binder_send_reply(bs, &amp;reply, txn-&gt;data, res);</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(*txn) / <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹å»å°±æ˜¯è¦æ‰§è¡Œ<code>binder_send_reply</code>æ–¹æ³•å‘é€ reply æ•°æ®:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°è§£é‡Šï¼šstatus ä¸º0</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">binder_send_reply</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                       struct binder_io *reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> *buffer_to_free,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> status)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">uint32_t</span> cmd_free;</span><br><span class="line">        <span class="keyword">void</span> *buffer;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd_reply;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_txn</span> <span class="title">txn</span>;</span></span><br><span class="line">    &#125; __attribute__((packed)) data;</span><br><span class="line"></span><br><span class="line">    data.cmd_free = BC_FREE_BUFFER; <span class="comment">// æ³¨æ„å‘½ä»¤</span></span><br><span class="line">    data.buffer = buffer_to_free;</span><br><span class="line">    data.cmd_reply = BC_REPLY; <span class="comment">// æ³¨æ„å‘½ä»¤</span></span><br><span class="line">    data.txn.target = <span class="number">0</span>;</span><br><span class="line">    data.txn.cookie = <span class="number">0</span>;</span><br><span class="line">    data.txn.code = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (status) &#123;</span><br><span class="line">        data.txn.flags = TF_STATUS_CODE;</span><br><span class="line">        data.txn.data_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">        data.txn.offs_size = <span class="number">0</span>;</span><br><span class="line">        data.txn.data = &amp;status;</span><br><span class="line">        data.txn.offs = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// èµ°è¿™é‡Œï¼Œå’Œå‰é¢çš„åˆ†æä¸€å¯¹æ¯”å°±éå¸¸æ¸…æ™°</span></span><br><span class="line">        data.txn.flags = <span class="number">0</span>;</span><br><span class="line">        data.txn.data_size = reply-&gt;data - reply-&gt;data0;</span><br><span class="line">        data.txn.offs_size = ((<span class="keyword">char</span>*) reply-&gt;offs) - ((<span class="keyword">char</span>*) reply-&gt;offs0);</span><br><span class="line">        data.txn.data = reply-&gt;data0;</span><br><span class="line">        data.txn.offs = reply-&gt;offs0;</span><br><span class="line">    &#125;</span><br><span class="line">    binder_write(bs, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reply ä¸­çš„æ•°æ®éƒ¨åˆ†åŒ…å«ä¸¤ç»„æ•°æ®ï¼Œä¸€ä¸ªæ˜¯ä¸€ä¸ª binder_io ç»“æ„ä½“ï¼Œä¸€ä¸ªåˆ™æ˜¯æ•´æ•° 0ã€‚æ¥ä¸‹å»å°±ä¸åˆ†æäº†ï¼Œå’Œå‰æ–‡ä¸€æ ·ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥é©±åŠ¨ã€‚</p>
<h2 id="é©±åŠ¨èŠ‚ç‚¹ç”Ÿæˆ"><a href="#é©±åŠ¨èŠ‚ç‚¹ç”Ÿæˆ" class="headerlink" title="é©±åŠ¨èŠ‚ç‚¹ç”Ÿæˆ"></a>é©±åŠ¨èŠ‚ç‚¹ç”Ÿæˆ</h2><p>æ ¹æ®å‰æ–‡çš„åˆ†æï¼Œç­”å¤çš„å¤„ç†è‚¯å®šç»è¿‡æ–¹æ³•<code>binder_transaction</code>ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡åˆ†æçš„é‡ç‚¹ï¼Œæˆ‘ä»¬çœ‹çœ‹å’ŒæœåŠ¡æ³¨å†Œå…·ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line">    <span class="comment">// æ ¸å¿ƒä¸åŒï¼ç¡®å®æœ‰æ•°æ®ï¼Œæ˜¯é€šè¿‡ binder_object ç»“æ„ä½“å†™å…¥çš„</span></span><br><span class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</span><br><span class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">flat_binder_object</span> *<span class="title">fp</span>;</span></span><br><span class="line">        fp = (struct flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</span><br><span class="line">        <span class="keyword">switch</span> (fp-&gt;type) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">case</span> BINDER_TYPE_HANDLE:</span><br><span class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_HANDLE: &#123;</span><br><span class="line">            <span class="comment">// è·å–æœåŠ¡æ³¨å†Œçš„æ—¶å€™åœ¨ SM ä¸­ç”Ÿæˆçš„ binder_ref</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span> = <span class="title">binder_get_ref</span>(<span class="title">proc</span>, <span class="title">fp</span>-&gt;<span class="title">handle</span>);</span></span><br><span class="line">            <span class="comment">// æƒé™æ£€æµ‹</span></span><br><span class="line">            <span class="keyword">if</span> (security_binder_transfer_binder(proc-&gt;tsk, target_proc-&gt;tsk)) &#123;</span><br><span class="line">                return_error = BR_FAILED_REPLY;</span><br><span class="line">                <span class="keyword">goto</span> err_binder_get_ref_failed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ref-&gt;node-&gt;proc == target_proc) &#123;<span class="comment">// å¦‚æœè¯·æ±‚çš„æœåŠ¡èŠ‚ç‚¹çš„è¿›ç¨‹å°±æ˜¯è¯·æ±‚å‘èµ·çš„è¿›ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_HANDLE)</span><br><span class="line">                    fp-&gt;type = BINDER_TYPE_BINDER; <span class="comment">// ç›´æ¥æ›´æ”¹ä¸º binder å®ä½“èŠ‚ç‚¹ï¼Œä¸éœ€è¦å¼•ç”¨</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    fp-&gt;type = BINDER_TYPE_WEAK_BINDER;</span><br><span class="line">                fp-&gt;binder = ref-&gt;node-&gt;ptr;</span><br><span class="line">                fp-&gt;cookie = ref-&gt;node-&gt;cookie;</span><br><span class="line">                binder_inc_node(ref-&gt;node, fp-&gt;type == BINDER_TYPE_BINDER, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                trace_binder_transaction_ref_to_node(t, ref);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                struct binder_ref *new_ref;</span><br><span class="line">                <span class="comment">// â­ï¸åœ¨ç›®æ ‡è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚è¿›ç¨‹ä¸­æŸ¥çœ‹è¯¥èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œæ²¡æœ‰åˆ™æ–°å»º</span></span><br><span class="line">                new_ref = binder_get_ref_for_node(target_proc, ref-&gt;node);</span><br><span class="line">                <span class="comment">// æ‹¿åˆ°è¯¥æœåŠ¡èŠ‚ç‚¹åœ¨æœ¬è¿›ç¨‹ä¸­çš„ handle å€¼</span></span><br><span class="line">                fp-&gt;handle = new_ref-&gt;desc;</span><br><span class="line">                binder_inc_ref(new_ref, fp-&gt;type == BINDER_TYPE_HANDLE, <span class="literal">NULL</span>);</span><br><span class="line">                trace_binder_transaction_ref_to_ref(t, ref,</span><br><span class="line">                                    new_ref);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        BUG_ON(t-&gt;buffer-&gt;async_transaction != <span class="number">0</span>);</span><br><span class="line">        binder_pop_transaction(target_thread, in_reply_to);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŒ‚è½½èŠ‚ç‚¹</span></span><br><span class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</span><br><span class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br><span class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</span><br><span class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</span><br><span class="line">    <span class="keyword">if</span> (target_wait)</span><br><span class="line">        wake_up_interruptible(target_wait);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å‰åŠéƒ¨åˆ†çš„å¤„ç†å’ŒæœåŠ¡æ³¨å†Œéƒ½ç±»ä¼¼ï¼Œæ ¸å¿ƒä¸åŒåœ¨äºé©±åŠ¨å¯¹æ•°æ®çš„å¤„ç†ä¸Šï¼š</p>
<p><strong>æœåŠ¡æ³¨å†Œï¼Œbinder_transactionä¸­çš„ binder èŠ‚ç‚¹æ˜¯ä¸€ä¸ª binder_node å®ä½“èŠ‚ç‚¹ï¼Œåœ¨é©±åŠ¨ä¸­å®ƒä¼šå°†å®ƒæ¢æˆ BINDER_TYPE_HANDLE ç±»å‹ï¼Œå¹¶åœ¨è¯·æ±‚æ³¨å†Œçš„è¿›ç¨‹ä¸Šç”Ÿæˆæ–°çš„å®ä½“èŠ‚ç‚¹ï¼›ä½†æ˜¯æœåŠ¡æŸ¥è¯¢ä¸­ï¼Œå´åªä¼šåˆ¤æ–­è¯¥æœåŠ¡æ˜¯å¦å±äºå½“å‰è¿›ç¨‹ï¼Œå¦‚æœæœåŠ¡å±äºå½“å‰è¿›ç¨‹ï¼Œåˆ™ä¼šæ¢æˆ BINDER_TYPE_BINDER ç±»å‹ï¼›å¦åˆ™ä¼šä»¥ BINDER_TYPE_HANDLE ç±»å‹ç»§ç»­ä¼ é€’å¤„ç†ã€‚å°¤å…¶è¦æ³¨æ„â­ï¸çš„åœ°æ–¹ï¼</strong></p>
<p>ç»è¿‡æ•°æ®å¤„ç†ï¼Œbinder_transaction çš„æ•°æ®å†…å®¹å·²ç»å˜åŒ–ã€‚åˆ°è¿™é‡Œï¼ŒSM çš„å¤„ç†å…¨éƒ¨å®Œæˆã€‚</p>
<h2 id="æŸ¥è¯¢æ–¹çš„ç­‰å¾…"><a href="#æŸ¥è¯¢æ–¹çš„ç­‰å¾…" class="headerlink" title="æŸ¥è¯¢æ–¹çš„ç­‰å¾…"></a>æŸ¥è¯¢æ–¹çš„ç­‰å¾…</h2><p>æŸ¥è¯¢æ–¹æ­¤æ—¶å¿…ç„¶åœ¨<code>binder_thread_read</code>æ–¹æ³•ä¸­ç­‰å¾…: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo))</span><br><span class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo) &amp;&amp; wait_for_proc_work)</span><br><span class="line">            w = list_first_entry(&amp;proc-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ptr - buffer == <span class="number">4</span> &amp;&amp; !(thread-&gt;looper &amp; BINDER_LOOPER_STATE_NEED_RETURN)) <span class="comment">/* no data added */</span></span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (end - ptr &lt; <span class="keyword">sizeof</span>(tr) + <span class="number">4</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION: &#123;</span><br><span class="line">            t = container_of(w, struct binder_transaction, work);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!t)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// reply çš„æ—¶å€™ï¼Œè¯¥å­—æ®µèµ‹å€¼ä¸º NULL</span></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;buffer-&gt;target_node) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// èµ°è¿™é‡Œ</span></span><br><span class="line">            tr.target.ptr = <span class="literal">NULL</span>;</span><br><span class="line">            tr.cookie = <span class="literal">NULL</span>;</span><br><span class="line">            cmd = BR_REPLY;</span><br><span class="line">        &#125;</span><br><span class="line">        tr.code = t-&gt;code;</span><br><span class="line">        tr.flags = t-&gt;flags;</span><br><span class="line">        tr.sender_euid = t-&gt;sender_euid;</span><br><span class="line">        <span class="keyword">if</span> (t-&gt;from) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">sender</span> = <span class="title">t</span>-&gt;<span class="title">from</span>-&gt;<span class="title">proc</span>-&gt;<span class="title">tsk</span>;</span></span><br><span class="line">            tr.sender_pid = task_tgid_nr_ns(sender,</span><br><span class="line">                            current-&gt;nsproxy-&gt;pid_ns);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tr.sender_pid = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tr.data_size = t-&gt;buffer-&gt;data_size;</span><br><span class="line">        tr.offsets_size = t-&gt;buffer-&gt;offsets_size;</span><br><span class="line">        tr.data.ptr.buffer = (<span class="keyword">void</span> *)t-&gt;buffer-&gt;data +</span><br><span class="line">                    proc-&gt;user_buffer_offset;</span><br><span class="line">        tr.data.ptr.offsets = tr.data.ptr.buffer +</span><br><span class="line">                    ALIGN(t-&gt;buffer-&gt;data_size,</span><br><span class="line">                        <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">        <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(ptr, &amp;tr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line">        trace_binder_transaction_received(t);</span><br><span class="line">        binder_stat_br(proc, thread, cmd);</span><br><span class="line">        list_del(&amp;t-&gt;work.entry);</span><br><span class="line">        t-&gt;buffer-&gt;allow_user_free = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (cmd == BR_TRANSACTION &amp;&amp; !(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">            t-&gt;to_parent = thread-&gt;transaction_stack;</span><br><span class="line">            t-&gt;to_thread = thread;</span><br><span class="line">            thread-&gt;transaction_stack = t;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            t-&gt;buffer-&gt;transaction = <span class="literal">NULL</span>;</span><br><span class="line">            kfree(t);</span><br><span class="line">            binder_stats_deleted(BINDER_STAT_TRANSACTION);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰å¿…è¦è¯¦ç»†åˆ†æä¸€ä¸‹æ•°æ®å†…å®¹äº†ã€‚è¿™é‡Œé¢æœ‰ä¸€æ®µå¾ˆé‡è¦çš„æ•°æ®æ‹·è´: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tr.data_size = t-&gt;buffer-&gt;data_size;</span><br><span class="line">tr.offsets_size = t-&gt;buffer-&gt;offsets_size;</span><br><span class="line">tr.data.ptr.buffer = (<span class="keyword">void</span> *)t-&gt;buffer-&gt;data + proc-&gt;user_buffer_offset;</span><br><span class="line">tr.data.ptr.offsets = tr.data.ptr.buffer + ALIGN(t-&gt;buffer-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line"><span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">	<span class="keyword">return</span> -EFAULT;</span><br><span class="line">ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line"><span class="keyword">if</span> (copy_to_user(ptr, &amp;tr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">	<span class="keyword">return</span> -EFAULT;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå°†æ•°æ®å†…å®¹å’Œåç§»æ•°æ®å¤§å°è®°å½•ä¸‹æ¥ï¼Œæ¥ç€å°†æ•°æ®åœ°å€æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä»¥ä¾¿äºç”¨æˆ·ç©ºé—´å¯ä»¥ç›´æ¥è®¿é—®è¿™å—å†…å­˜ã€‚ä¹‹åæ‹·è´<code>BR_TRANSACTION</code>å‘½ä»¤ï¼Œæ‹·è´ binder_transaction_data ç»“æ„ä½“åè¿”å›ã€‚ä¸­é—´è¿‡ç¨‹æ¯”è¾ƒå†—é•¿ï¼Œåœ¨å‰æ–‡ä¸­ä¹Ÿåšäº†åˆ†æï¼Œæˆ‘ä»¬ç›´æ¥åˆ°å¤„ç†è¿”å›ç»“æœçš„åœ°æ–¹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::waitForResponse(Parcel *reply, <span class="keyword">status_t</span> *acquireResult)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> cmd;</span><br><span class="line">    <span class="keyword">int32_t</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err=talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        err = mIn.errorCheck();</span><br><span class="line">        <span class="keyword">if</span> (err &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (mIn.dataAvail() == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        cmd = mIn.readInt32();</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">            ......</span><br><span class="line">        <span class="keyword">case</span> BR_REPLY:</span><br><span class="line">            &#123;</span><br><span class="line">                binder_transaction_data tr;</span><br><span class="line">                err = mIn.read(&amp;tr, <span class="keyword">sizeof</span>(tr));</span><br><span class="line">                LOG_ASSERT(err == NO_ERROR, <span class="string">"Not enough command data for brREPLY"</span>);</span><br><span class="line">                <span class="keyword">if</span> (err != NO_ERROR) <span class="keyword">goto</span> finish;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((tr.flags &amp; TF_STATUS_CODE) == <span class="number">0</span>) &#123;</span><br><span class="line">                        reply-&gt;ipcSetDataReference(</span><br><span class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(tr.data.ptr.buffer),</span><br><span class="line">                            tr.data_size,</span><br><span class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">size_t</span>*&gt;(tr.data.ptr.offsets),</span><br><span class="line">                            tr.offsets_size/<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>),</span><br><span class="line">                            freeBuffer, <span class="keyword">this</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        err = *<span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">status_t</span>*&gt;(tr.data.ptr.buffer);</span><br><span class="line">                        freeBuffer(<span class="literal">NULL</span>,</span><br><span class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(tr.data.ptr.buffer),</span><br><span class="line">                            tr.data_size,</span><br><span class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">size_t</span>*&gt;(tr.data.ptr.offsets),</span><br><span class="line">                            tr.offsets_size/<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>), <span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ......</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> finish;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆä» mIn ä¸­æŠŠ binder_transaction_data ç»“æ„ä½“è¯»å‡ºæ¥ï¼Œç„¶åè°ƒç”¨<code>Parcel.ipcSetDataReference()</code>æ–¹æ³•æŠŠæ•°æ®å†™å…¥åˆ° reply ä¸­å»ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è°ƒç”¨ä»£ç :reply-&gt;ipcSetDataReference(</span></span><br><span class="line"><span class="comment"> *                          reinterpret_cast&lt;const uint8_t*&gt;(tr.data.ptr.buffer),</span></span><br><span class="line"><span class="comment"> *                          tr.data_size,</span></span><br><span class="line"><span class="comment"> *                          reinterpret_cast&lt;const size_t*&gt;(tr.data.ptr.offsets),</span></span><br><span class="line"><span class="comment"> *                          tr.offsets_size/sizeof(size_t),</span></span><br><span class="line"><span class="comment"> *                          freeBuffer, this);</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">void</span> Parcel::ipcSetDataReference(<span class="keyword">const</span> <span class="keyword">uint8_t</span>* data, <span class="keyword">size_t</span> dataSize,</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span>* objects, <span class="keyword">size_t</span> objectsCount, release_func relFunc, <span class="keyword">void</span>* relCookie)</span><br><span class="line">&#123;</span><br><span class="line">    freeDataNoInit();</span><br><span class="line">    mError = NO_ERROR;</span><br><span class="line">    mData = <span class="keyword">const_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(data);</span><br><span class="line">    mDataSize = mDataCapacity = dataSize;</span><br><span class="line">    mDataPos = <span class="number">0</span>;</span><br><span class="line">    LOGV(<span class="string">"setDataReference Setting data pos of %p to %d\n"</span>, <span class="keyword">this</span>, mDataPos);</span><br><span class="line">    mObjects = <span class="keyword">const_cast</span>&lt;<span class="keyword">size_t</span>*&gt;(objects);</span><br><span class="line">    mObjectsSize = mObjectsCapacity = objectsCount;</span><br><span class="line">    mNextObjectHint = <span class="number">0</span>;</span><br><span class="line">    mOwner = relFunc;</span><br><span class="line">    mOwnerCookie = relCookie;</span><br><span class="line">    scanForFds();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å‡ ä¸ªå‚æ•°å‰é¢åŸºæœ¬éƒ½è§è¿‡ï¼Œä¸å¤šåšè§£é‡Šï¼Œä½†æ˜¯ objectsCount çš„è®¡ç®—å¼æ˜¯<code>tr.offsets_size/sizeof(size_t)</code>ï¼Œå³åç§»æ•°æ®é‡å°ºå¯¸é™¤ä»¥åç§»è®°å½•å¤§å°ï¼Œå› æ­¤å°±æ˜¯åç§»è®°å½•çš„æ¡æ•°ï¼Œä¹Ÿå°±æ˜¯è®°å½•çš„å¯¹è±¡æ•°ï¼Œå› ä¸ºæ˜¯æŸ¥è¯¢æœåŠ¡ï¼Œä»å‰é¢çš„åˆ†ææ¥çœ‹ï¼Œè¿™é‡Œåªè¿”å›äº†ä¸€ä¸ªå¯¹è±¡ã€‚ç„¶åæ ¹æ® objects å‚æ•°ï¼Œå°±å¯ä»¥ä» data ä¸­è·å–åˆ°æ‰€æœ‰çš„ binder èŠ‚ç‚¹æ•°æ®ã€‚</p>
<p>è€Œ reply å‚æ•°æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿæ¥è‡ªè¿™é‡Œ:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remote()-&gt;transact(CHECK_SERVICE_TRANSACTION, data, &amp;reply);</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹å»ä¸€å¥ä¾¿æ˜¯: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> reply.readStrongBinder();</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šåˆ†æï¼Œæ­¤æ—¶ reply ä¸­å·²ç»æœ‰æœ‰å…³ binder çš„æ•°æ®äº†ï¼Œé‚£ä¹ˆæ˜¯æ€ä¹ˆè¯»å–çš„å‘¢ï¼Ÿ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; Parcel::readStrongBinder() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IBinder&gt; val;</span><br><span class="line">    unflatten_binder(ProcessState::self(), *<span class="keyword">this</span>, &amp;val);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> unflatten_binder(<span class="keyword">const</span> sp&lt;ProcessState&gt;&amp; proc,</span><br><span class="line">    <span class="keyword">const</span> Parcel&amp; in, sp&lt;IBinder&gt;* out)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> flat_binder_object* flat = in.readObject(<span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (flat) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (flat-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> BINDER_TYPE_BINDER:</span><br><span class="line">                *out = <span class="keyword">static_cast</span>&lt;IBinder*&gt;(flat-&gt;cookie);</span><br><span class="line">                <span class="keyword">return</span> finish_unflatten_binder(<span class="literal">NULL</span>, *flat, in);</span><br><span class="line">            <span class="keyword">case</span> BINDER_TYPE_HANDLE:</span><br><span class="line">                *out = proc-&gt;getStrongProxyForHandle(flat-&gt;handle);</span><br><span class="line">                <span class="keyword">return</span> finish_unflatten_binder(</span><br><span class="line">                    <span class="keyword">static_cast</span>&lt;BpBinder*&gt;(out-&gt;get()), *flat, in);</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BAD_TYPE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…çš„è¯»å–æ˜¯åœ¨<code>readObject</code>ä¸­è¿›è¡Œçš„:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flat_binder_object* Parcel::readObject(<span class="keyword">bool</span> nullMetaData) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> DPOS = mDataPos;</span><br><span class="line">    <span class="comment">// é¦–å…ˆåˆ¤æ–­å‰©ä½™æ•°æ®é‡æ˜¯å¦è¶³ä»¥è¯»å–å‡ºä¸€ä¸ª flat_binder_object</span></span><br><span class="line">    <span class="keyword">if</span> ((DPOS+<span class="keyword">sizeof</span>(flat_binder_object)) &lt;= mDataSize) &#123;</span><br><span class="line">        <span class="comment">// å¼ºè½¬è¯»å–</span></span><br><span class="line">        <span class="keyword">const</span> flat_binder_object* obj</span><br><span class="line">                = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> flat_binder_object*&gt;(mData+DPOS);</span><br><span class="line">        mDataPos = DPOS + <span class="keyword">sizeof</span>(flat_binder_object);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Ensure that this object is valid...</span></span><br><span class="line">        <span class="keyword">size_t</span>* <span class="keyword">const</span> OBJS = mObjects;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> N = mObjectsSize;</span><br><span class="line">        <span class="keyword">size_t</span> opos = mNextObjectHint;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOGV(<span class="string">"Parcel %p looking for obj at %d, hint=%d\n"</span>,</span><br><span class="line">                 <span class="keyword">this</span>, DPOS, opos);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Start at the current hint position, looking for an object at</span></span><br><span class="line">            <span class="comment">// the current data position.</span></span><br><span class="line">            <span class="keyword">if</span> (opos &lt; N) &#123;</span><br><span class="line">                <span class="keyword">while</span> (opos &lt; (N<span class="number">-1</span>) &amp;&amp; OBJS[opos] &lt; DPOS) &#123;</span><br><span class="line">                    opos++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                opos = N<span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (OBJS[opos] == DPOS) &#123;</span><br><span class="line">                mNextObjectHint = opos+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> obj;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// Look backwards for it...</span></span><br><span class="line">            <span class="keyword">while</span> (opos &gt; <span class="number">0</span> &amp;&amp; OBJS[opos] &gt; DPOS) &#123;</span><br><span class="line">                opos--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (OBJS[opos] == DPOS) &#123;</span><br><span class="line">                <span class="comment">// Found it!</span></span><br><span class="line">                LOGV(<span class="string">"Parcel found obj %d at index %d with backward search"</span>,</span><br><span class="line">                     <span class="keyword">this</span>, DPOS, opos);</span><br><span class="line">                mNextObjectHint = opos+<span class="number">1</span>;</span><br><span class="line">                LOGV(<span class="string">"readObject Setting data pos of %p to %d\n"</span>, <span class="keyword">this</span>, mDataPos);</span><br><span class="line">                <span class="keyword">return</span> obj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„è¯»å–ï¼Œä½†æ˜¯ä¼šåšä¸€äº›æ ¡éªŒã€‚åœ¨å½“å‰æƒ…å†µä¸‹ï¼Œå½“ç„¶å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ flat_binder_object ç»“æ„ä½“å¯¹è±¡ï¼Œæ¥ç€å›åˆ°<code>unflatten_binder</code>ï¼Œæ‰§è¡Œå¦‚ä¸‹ä»£ç : </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flat) &#123;</span><br><span class="line">	<span class="keyword">switch</span> (flat-&gt;type) &#123;</span><br><span class="line">		<span class="keyword">case</span> BINDER_TYPE_BINDER:</span><br><span class="line">				*out = <span class="keyword">static_cast</span>&lt;IBinder*&gt;(flat-&gt;cookie);</span><br><span class="line"> 				<span class="keyword">return</span> finish_unflatten_binder(<span class="literal">NULL</span>, *flat, in);</span><br><span class="line">		<span class="keyword">case</span> BINDER_TYPE_HANDLE:</span><br><span class="line">				*out = proc-&gt;getStrongProxyForHandle(flat-&gt;handle);</span><br><span class="line">				<span class="keyword">return</span> finish_unflatten_binder(</span><br><span class="line">                    	<span class="keyword">static_cast</span>&lt;BpBinder*&gt;(out-&gt;get()), *flat, in);</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬è¿”å›çš„ Binder ç±»å‹æ˜¯ BINDER_TYPE_HANDLE çš„ã€‚out æœ€åè¢«èµ‹å€¼ä¸º <code>proc-&gt;getStrongProxyForHandle(flat-&gt;handle);</code>ï¼Œ<code>getStrongProxyForHandle</code>è¿™ä¸ªå‡½æ•°æˆ‘ä»¬ä¹Ÿæ˜¯è§è¿‡çš„ï¼Œè¿™é‡Œå†åˆ†æä¸€æ¬¡ï¼Œå› ä¸ºæƒ…æ™¯æœ‰äº›ä¸åŒã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(<span class="keyword">int32_t</span> handle)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IBinder&gt; result;</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// handle ä¸º0</span></span><br><span class="line">    handle_entry* e = lookupHandleLocked(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// We need to create a new BpBinder if there isn't currently one, OR we</span></span><br><span class="line">        <span class="comment">// are unable to acquire a weak reference on this current one.  See comment</span></span><br><span class="line">        <span class="comment">// in getWeakProxyForHandle() for more info about this.</span></span><br><span class="line">        IBinder* b = e-&gt;binder;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span> || !e-&gt;refs-&gt;attemptIncWeak(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            b = <span class="keyword">new</span> BpBinder(handle); </span><br><span class="line">            e-&gt;binder = b;</span><br><span class="line">            <span class="keyword">if</span> (b) e-&gt;refs = b-&gt;getWeakRefs();</span><br><span class="line">            result = b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This little bit of nastyness is to allow us to add a primary</span></span><br><span class="line">            <span class="comment">// reference to the remote proxy when this team doesn't have one</span></span><br><span class="line">            <span class="comment">// but another team is sending the handle to us.</span></span><br><span class="line">            result.force_set(b);</span><br><span class="line">            e-&gt;refs-&gt;decWeak(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ProcessState::handle_entry* ProcessState::lookupHandleLocked(<span class="keyword">int32_t</span> handle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> N = mHandleToObject.size();</span><br><span class="line">    <span class="keyword">if</span> (N &lt;= (<span class="keyword">size_t</span>)handle) &#123;</span><br><span class="line">        handle_entry e;</span><br><span class="line">        e.binder = <span class="literal">NULL</span>;</span><br><span class="line">        e.refs = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">status_t</span> err = mHandleToObject.insertAt(e, N, handle+<span class="number">1</span>-N);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; NO_ERROR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;mHandleToObject.editItemAt(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ˜¯åˆæ¬¡è·å–è¿™ä¸ªæœåŠ¡ï¼Œå› æ­¤å®é™…ä¸Š<code>lookupHandleLocked</code>è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ªæ–°å»ºçš„ handle_entry ç»“æ„ä½“ï¼Œå› æ­¤å®é™…ä¸Š<code>getStrongProxyForHandle</code>è¿”å›çš„å¯¹è±¡å°±æ˜¯<code>new BpBinder(handle)</code>ï¼Œè¿™æ•´ä¸ªè¿‡ç¨‹è¿”å›çš„åˆ™æ˜¯<code>new BpBinder(flat-&gt;handle)</code>å¯¹è±¡ã€‚</p>
<h2 id="æœ€åçš„äº¤äº’"><a href="#æœ€åçš„äº¤äº’" class="headerlink" title="æœ€åçš„äº¤äº’"></a>æœ€åçš„äº¤äº’</h2><p>ç°åœ¨Clientå·²ç»æ‹¿åˆ°è¿™ä¸ª<code>new BpBinder(flat-&gt;handle)</code>äº†ï¼Œé‚£ä¹ˆæ€ä¹ˆå’Œè¿œç¨‹æœåŠ¡é€šä¿¡å‘¢ï¼Ÿè¿™ä¸ªå…¶å®åœ¨æ³¨å†ŒæœåŠ¡ä¸­ä¹Ÿåˆ†æè¿‡äº†ï¼Œåªä¸è¿‡é‚£æ—¶å€™<code>flat-&gt;handle</code>ä¸º 0 è€Œå·²ï¼Œè€Œåœ¨<code>binder_transaction</code>æ–¹æ³•ä¸­ï¼Œæ˜¯å¦ä¸º 0 æ˜¯æœ‰åŒºåˆ«çš„:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tr-&gt;target.handle) &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">	ref = binder_get_ref(proc, tr-&gt;target.handle);</span><br><span class="line">	target_node = ref-&gt;node;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	target_node = binder_context_mgr_node;</span><br><span class="line">	<span class="keyword">if</span> (target_node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		return_error = BR_DEAD_REPLY;</span><br><span class="line">		<span class="keyword">goto</span> err_no_context_mgr_node;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœ handle ä¸º 0ï¼Œé»˜è®¤ç›®æ ‡æœåŠ¡èŠ‚ç‚¹å°±æ˜¯<code>binder_context_mgr_node</code>ï¼Œä½†å¦‚æœä¸ä¸º 0ï¼Œåˆ™ä¼šåœ¨è¿›ç¨‹(<code>binder_proc</code>å¯¹è±¡)çš„çº¢é»‘æ ‘ä¸­å¯»æ‰¾ï¼Œè¿™ä¸ªå¯»æ‰¾ä¸€å®šæ˜¯OKçš„ï¼Œå› ä¸ºåœ¨æŸ¥è¯¢æœåŠ¡çš„æ—¶å€™å°±æŠŠ<code>binder_ref</code>èŠ‚ç‚¹æ’å…¥åˆ°çº¢é»‘æ ‘ä¸­å»äº†ã€‚è‡ªç„¶è€Œç„¶ä¹Ÿå°±èƒ½å®šä½åˆ°ç›®æ ‡è¿›ç¨‹ï¼Œä»è€Œå‘é€è¯·æ±‚ã€‚</p>
<h2 id="interface-cast"><a href="#interface-cast" class="headerlink" title="interface_cast"></a>interface_cast</h2><p>åœ¨å‘é€æœåŠ¡è¯·æ±‚ä¹‹å‰ï¼Œè¿˜éœ€è¦åšä¸€æ¬¡è½¬æ¢ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜ä¸çŸ¥é“è¿œç¨‹æœåŠ¡çš„APIæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œè¿™å°±æ˜¯<code>IMediaDeathNotifier::getMediaPlayerService()</code>æ–¹æ³•ä¸­æœ€åä¸€å¥çš„ä½œç”¨:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sMediaPlayerService = interface_cast&lt;IMediaPlayerService&gt;(binder);</span><br></pre></td></tr></table></figure>
<p><code>interface_cast</code>åœ¨å‰æ–‡å·²ç»åˆ†æè¿‡ä¸€æ¬¡äº†ï¼Œå¾ˆå®¹æ˜“æ¨æ–­å‡ºæœ€ç»ˆ<code>interface_cast&lt;IMediaPlayerService&gt;(binder);</code>è¿”å›çš„å€¼æ˜¯ï¼š<strong><code>new BpMediaPlayerService(new BpBinder(flat-&gt;handle))</code></strong>ã€‚</p>
<p>è¿™åœ¨ä¸‹å›¾ä¸­ä¹Ÿèƒ½çœ‹åˆ°è¯¥å¯¹è±¡:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Binder-Libå±‚æ¶æ„.png" alt="Binder Libå±‚æ¶æ„"></div>

<p>è¿™é‡Œå°±ä¸å¤šåšåˆ†æäº†ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼Œæœå¯»æœåŠ¡ä¹Ÿåˆ†æå®Œæ¯•ã€‚å¦‚æœè¯»è€…å¯¹è¿™å‡ ç¯‡æ–‡ç« éƒ½å·²ç»æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¢™è£‚å»ºè®®é˜…è¯»æ¨èæ–‡ç« â‘ å’Œæ–‡ç« â‘¢ä¸¤ç³»åˆ—åšå®¢ï¼æ•´ä¸ªåˆ†æä¸‹æ¥ï¼ŒBinder æœºåˆ¶æ‰€åšçš„é‡è¦äº‹æƒ…å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯åŠ¨ SMï¼Œå¹¶ä¸”å›ºå®š SM çš„ handle å€¼ä¸º0ï¼Œè¿™æ ·ä»»ä½•å…¶ä½™çš„æœåŠ¡éƒ½å¯ä»¥éšæ—¶è·å–åˆ° SM æœåŠ¡ï¼›</li>
<li>æœåŠ¡å¯åŠ¨åéƒ½ä¼šå» SM æ³¨å†Œï¼Œè¿™ä¸ªæ³¨å†Œçš„è¿‡ç¨‹æ˜¯ï¼šåœ¨é©±åŠ¨å±‚æœ¬è¿›ç¨‹çš„æ˜ å°„æ•°æ®ç»“æ„<code>binder_proc</code>ä¸­ç”Ÿæˆå¯¹åº”çš„<code>binder_node</code>èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹åœ¨ç©¿è¶Šé©±åŠ¨è¾¹ç•Œçš„æ—¶å€™ï¼Œä¼šåœ¨ç›®æ ‡è¿›ç¨‹ä¸­ç”Ÿæˆ<code>binder_ref</code>ç»“æ„ä½“ï¼Œæ³¨å†Œçš„æ—¶å€™ï¼Œè¿™ä¸ªç›®æ ‡è¿›ç¨‹å°±æ˜¯ SMï¼Œä¹Ÿå°±æ˜¯è¯´ SM ä¼šæŒæœ‰æ‰€æœ‰æœåŠ¡çš„å¼•ç”¨ï¼›</li>
<li>æœåŠ¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯é—®è¯¢ SM ï¼ŒSM å°±é€šè¿‡åå­—æŸ¥è¯¢å¯¹åº”çš„æœåŠ¡å¼•ç”¨ï¼Œåœ¨è¿”å›çš„æ—¶å€™åŒæ ·éœ€è¦ç©¿è¶Šé©±åŠ¨è¾¹ç•Œï¼Œé©±åŠ¨åˆä¼šæŸ¥è¯¢ç›®æ ‡è¿›ç¨‹æ˜¯å¦æœ‰è¯¥æœåŠ¡èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œæ²¡æœ‰çš„è¯åˆä¼šå»ç›®æ ‡è¿›ç¨‹ç”Ÿæˆä¸€ä¸ªï¼Œå¹¶ä¸”ç”Ÿæˆå¯¹åº”çš„ handle å€¼ï¼Œè¿™ä¸ªå€¼ä¼šæœ€æ€»è¿”å›åˆ° Libraries å±‚ï¼›</li>
<li>åœ¨ Librries å±‚ä¼šé€šè¿‡ <code>new BpXXXService(new BpBinder(handle))</code>çš„å½¢å¼ç”ŸæˆæœåŠ¡å¯¹è±¡è¿™å…¶å®æ˜¯ä¸€ä¸ªä»£ç†ï¼Œæœ€å¤–å±‚çš„<code>new BpXXXService()</code>æœ€ä¸»è¦çš„ç›®çš„æ˜¯æ‰¾åˆ°<code>XXXService</code>çš„æ¥å£ï¼Œè€Œå†…éƒ¨<code>new BpBinder(handle)</code>åˆ™æ˜¯ä¸ºäº†å°†è¯·æ±‚è½¬å‘ç»™çœŸæ­£çš„æœåŠ¡è¿›ç¨‹ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™æŒæœ‰ handleï¼Œå°±å¯ä»¥åœ¨é©±åŠ¨å±‚æŸ¥è¯¢åˆ°å¯¹åº”çš„<code>binder_node</code>èŠ‚ç‚¹ï¼Œä»è€Œå¯ä»¥å‘å¯¹æ–¹ proc/thread æŒ‚è½½ä»»åŠ¡å¹¶å”¤é†’å¯¹æ–¹ï¼›</li>
</ol>
<p>ä»¥ä¸Šã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Binderä¹‹Service Manager]]></title>
      <url>http://www.timebridge.space/2016/06/21/binder-servicemanager/</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><strong>Service Manager (ä»¥ä¸‹ç®€ç§° SM )åœ¨ Binder æ¡†æ¶ä¸­è´Ÿè´£çš„æ˜¯ç»´æŠ¤ Service çš„æŸ¥è¯¢å·¥ä½œï¼šç»™æˆ‘ä¸€ä¸ªåå­—ï¼Œç»™ä½ æƒ³è¦çš„æœåŠ¡ã€‚</strong>è¦æ³¨æ„çš„æ˜¯ï¼šè¿™é‡Œæ‰€è¯´çš„ SM å¹¶ä¸æ˜¯æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ç”¨åˆ°çš„ SMï¼Œé‚£ä¸ªæ˜¯ Java å±‚çš„å°è£…ï¼Œè¿™é‡Œæ‰€è®²çš„ SM ä½äº Libraries å±‚ã€‚</p>
<p><strong>ã€æ¶‰åŠæ–‡ä»¶ã€‘</strong></p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ä½ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td>service_manager.c</td>
<td>/frameworks/base/cmds/servicemanager/service_manager.c</td>
</tr>
<tr>
<td>Libraries å±‚ binder.c</td>
<td>/frameworks/base/cmds/servicemanager/binder.c</td>
</tr>
<tr>
<td>é©±åŠ¨å±‚ binder.c</td>
<td>kernel/common/drivers/staging/android/binder.c</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<p>##ä¸»è¦å‡½æ•°è°ƒç”¨<br>SM çš„å¯åŠ¨ main å‡½æ•°ä½äºâ€service_manager.câ€æ–‡ä»¶ä¸­:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line">    <span class="comment">// #define BINDER_SERVICE_MANAGER ((void*) 0) </span></span><br><span class="line">    <span class="keyword">void</span> *svcmgr = BINDER_SERVICE_MANAGER;</span><br><span class="line">    <span class="comment">// 1. æ‰“å¼€ Binder é©±åŠ¨</span></span><br><span class="line">    bs = binder_open(<span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ³¨å†Œæˆä¸º SM</span></span><br><span class="line">    <span class="keyword">if</span> (binder_become_context_manager(bs)) &#123;</span><br><span class="line">        LOGE(<span class="string">"cannot become context manager (%s)\n"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    svcmgr_handle = svcmgr;</span><br><span class="line">    <span class="comment">// 3. å¯åŠ¨å¾ªç¯ç›‘å¬</span></span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æ­¥éª¤å°±å¦‚ä»£ç ä¸­æ³¨é‡Šçš„é‚£æ ·ï¼Œåˆ†ä¸ºä¸‰æ­¥:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/service_manager_main.png" width="320" alt="SM mainå‡½æ•°è°ƒç”¨"></div>

<p>æˆ‘ä»¬å°±ä»è¿™ä¸‰æ­¥å…¥æ‰‹ï¼Œé€æ­¥è§£æ SM çš„å¯åŠ¨è¿‡ç¨‹ã€‚</p>
<h2 id="æ‰“å¼€-Binder-é©±åŠ¨"><a href="#æ‰“å¼€-Binder-é©±åŠ¨" class="headerlink" title="æ‰“å¼€ Binder é©±åŠ¨"></a>æ‰“å¼€ Binder é©±åŠ¨</h2><p><code>binder_open</code>ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æ‰“å¼€ binder é©±åŠ¨ï¼Œæ¥çœ‹çœ‹å®ƒåœ¨æ‰“å¼€æ—¶åšäº†ä»€ä¹ˆ:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è°ƒç”¨ä»£ç : bs = binder_open(128*1024);</span></span><br><span class="line"><span class="function">struct binder_state *<span class="title">binder_open</span><span class="params">(<span class="keyword">unsigned</span> mapsize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	 <span class="comment">// è¯¥ç»“æ„å¯åœ¨å­—å…¸ä¸­æŸ¥è¯¢</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line"></span><br><span class="line">    bs = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*bs));</span><br><span class="line">    <span class="keyword">if</span> (!bs) &#123;</span><br><span class="line">        errno = ENOMEM;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">// 1. æ‰“å¼€é©±åŠ¨</span></span><br><span class="line">    bs-&gt;fd = open(<span class="string">"/dev/binder"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (bs-&gt;fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"binder: cannot open device (%s)\n"</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> fail_open;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bs-&gt;mapsize = mapsize;</span><br><span class="line">    <span class="comment">// 2. å†…å­˜æ˜ å°„</span></span><br><span class="line">    bs-&gt;mapped = mmap(<span class="literal">NULL</span>, mapsize, PROT_READ, MAP_PRIVATE, bs-&gt;fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (bs-&gt;mapped == MAP_FAILED) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"binder: cannot map device (%s)\n"</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> fail_map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> check version */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bs;</span><br><span class="line"></span><br><span class="line">fail_map:</span><br><span class="line">    close(bs-&gt;fd);</span><br><span class="line">fail_open:</span><br><span class="line">    <span class="built_in">free</span>(bs);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æ³¨é‡Šæ‰€ç¤ºï¼Œä¸»è¦æ­¥éª¤åˆ†ä¸ºä¸¤æ­¥ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥çœ‹ã€‚</p>
<h3 id="é©±åŠ¨å±‚binder-open"><a href="#é©±åŠ¨å±‚binder-open" class="headerlink" title="é©±åŠ¨å±‚binder_open"></a>é©±åŠ¨å±‚<code>binder_open</code></h3><p>ç¨‹åº binder é©±åŠ¨è®¾å¤‡è°ƒç”¨çš„æ˜¯<code>open</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¼šè°ƒç”¨åˆ°é©±åŠ¨å±‚çš„<code>binder_open</code>æ–¹æ³•ï¼Œå°†æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦è®°å½•åˆ° binder_state çš„ fd å­—æ®µ: </p>
<blockquote>
<p>è‡³äºä¸ºä»€ä¹ˆä¼šæœ‰ Libraries çš„<code>open</code>æ–¹æ³•æ˜ å°„åˆ°é©±åŠ¨å±‚çš„<code>binder_open</code>æ–¹æ³•ï¼Œè¿™å±äºé©±åŠ¨çŸ¥è¯†ï¼Œä¸è¯¦ç»†è§£é‡Šï¼Œåé¢ä¹Ÿä¼šæœ‰å¾ˆå¤šè¿™æ ·çš„æ˜ å°„ä¾‹å­ï¼Œä¸€èˆ¬æ˜¯å‰é¢åŠ ä¸Š<code>binder_</code>åšæ˜ å°„ï¼Œè¿™ä¸ªå…³ç³»æ˜¯ binder é©±åŠ¨è‡ªå·±å®šä¹‰çš„ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">static int binder_open(struct inode *nodp, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">    //å£°æ˜procçš„æ•°æ®ç»“æ„ï¼Œå¯åœ¨å­—å…¸ä¸­æŸ¥è¯¢</span><br><span class="line">    struct binder_proc *proc;</span><br><span class="line">    proc = kzalloc(sizeof(*proc), GFP_KERNEL);</span><br><span class="line">    if (proc == NULL)</span><br><span class="line">        return -ENOMEM;</span><br><span class="line"></span><br><span class="line">    //å¢åŠ å¼•ç”¨è®¡æ•°</span><br><span class="line">    get_task_struct(current);</span><br><span class="line">    </span><br><span class="line">    //è®°å½•å½“å‰è¿›ç¨‹åˆ°procä¸­</span><br><span class="line">    proc-&gt;tsk = current;</span><br><span class="line"></span><br><span class="line">    //åˆå§‹åŒ–é“¾è¡¨</span><br><span class="line">    INIT_LIST_HEAD(&amp;proc-&gt;todo);</span><br><span class="line">    //åˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—</span><br><span class="line">    init_waitqueue_head(&amp;proc-&gt;wait);</span><br><span class="line">    //è®¾ç½®ä¼˜å…ˆçº§</span><br><span class="line">    proc-&gt;default_priority = task_nice(current);</span><br><span class="line">    binder_lock(__func__);</span><br><span class="line">    binder_stats_created(BINDER_STAT_PROC);</span><br><span class="line">    //æŠŠbinder_procæ·»åŠ åˆ°binder_procsé“¾è¡¨ä¸­å»</span><br><span class="line">    hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs);</span><br><span class="line">    //è®°å½•è¿›ç¨‹ID</span><br><span class="line">    proc-&gt;pid = current-&gt;group_leader-&gt;pid;</span><br><span class="line">    INIT_LIST_HEAD(&amp;proc-&gt;delivered_death);</span><br><span class="line"></span><br><span class="line">    //ä¿å­˜è¿›ç¨‹ä¿¡æ¯</span><br><span class="line">    filp-&gt;private_data = proc;</span><br><span class="line">    binder_unlock(__func__);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†é…<code>binder_proc</code>å¯¹è±¡ä¹‹åï¼Œåé¢çš„ä»£ç éƒ½æœ‰æ³¨é‡Šï¼Œè¿™é‡Œ current å…¶å®æ˜¯ä¸€ä¸ªå®ï¼ŒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå†…è”å‡½æ•°ï¼Œè¿”å›çš„ç»“æœæŒ‡å‘å½“å‰çš„è¿›ç¨‹ï¼Œå…·ä½“åœ¨ SOF çš„é—®é¢˜ <a href="http://stackoverflow.com/questions/12434651/what-is-the-current-in-linux-kernel-source" target="_blank" rel="noopener">what is the â€œcurrentâ€ in linux kernel source</a> ä¸‹é¢æœ‰è¯¦ç»†çš„è§£é‡Šã€‚æ¥ç€å°±æ˜¯åˆå§‹åŒ–ä¸€äº›é˜Ÿåˆ—ï¼Œè®°å½•ç¯å¢ƒå€¼ã€‚æœ€åä¼šå°† proc ä¿å­˜åˆ°<code>filp-&gt;private_data</code>ä¸­å»ï¼Œåé¢å°±å¯ä»¥ä»è¿™ä¸ªå­—æ®µä¸­å†æŠŠ proc è¯»å–å‡ºæ¥ã€‚</p>
<blockquote>
<p>è¿™é‡Œæ¶‰åŠåˆ°å¾ˆå¤šçš„C++ã€Linuxã€é©±åŠ¨çŸ¥è¯†ï¼Œæ¯”å¦‚å°† proc ä¿å­˜åˆ° <code>filp-&gt;private_data</code> ä¸­å»ã€‚</p>
</blockquote>
<p>è¿™ä¸ªå°±æ˜¯æ‰“å¼€ binder é©±åŠ¨åšçš„ä¸»è¦å·¥ä½œï¼Œä»¥ä¸‹æ˜¯è°ƒç”¨è·¯å¾„å›¾:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/binder_open.png" alt="æ‰“å¼€binderé©±åŠ¨"></div>

<h3 id="é©±åŠ¨å±‚binder-mmap"><a href="#é©±åŠ¨å±‚binder-mmap" class="headerlink" title="é©±åŠ¨å±‚binder_mmap"></a>é©±åŠ¨å±‚<code>binder_mmap</code></h3><p>æ¥ç€ç¨‹åºå°†ä¼ å…¥çš„ mapsize è®°å½•åˆ° binder_state çš„ mapsize å­—æ®µ( main å‡½æ•°ä¼ å…¥çš„å€¼æ˜¯ 128*1024)ï¼›æœ€åè°ƒç”¨<code>mmap</code>å‡½æ•°è¿›è¡Œå†…å­˜æ˜ å°„ã€‚<code>mmap</code>æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç†è§£ä¸ºä»é©±åŠ¨ä¸­åˆ’åˆ†ä¸€å—å†…å­˜å‡ºæ¥æ˜ å°„åˆ°æœ¬è¿›ç¨‹ä¸­ï¼Œä»è€Œ binder é©±åŠ¨å’Œæœ¬è¿›ç¨‹éƒ½å¯ä»¥æ“ä½œè¿™å—å†…å­˜ã€‚</p>
<p>è¿™å—è¾ƒå¤æ‚ï¼ŒåŠŸåŠ›ä¸è¶³æš‚æ—¶åˆ†æä¸äº†ï¼Œå¦‚æœè¯»è€…æœ‰å…´è¶£å¯ä»¥å»çœ‹è€ç½—çš„æ–‡ç« <a href="http://blog.csdn.net/luoshengyang/article/details/6621566" target="_blank" rel="noopener">æµ…è°ˆService Manageræˆä¸ºAndroidè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶Binderå®ˆæŠ¤è¿›ç¨‹ä¹‹è·¯</a>ï¼Œç›´æ¥æœ â€œbinder_mmapâ€ å°±å¥½ã€‚</p>
<p>è‡³æ­¤ï¼Œbinder é©±åŠ¨æ‰“å¼€ï¼Œå¹¶ä¸”åšå¥½äº†æ˜ å°„ï¼Œç»ˆäºå¯ä»¥ç›´æ¥å’Œé©±åŠ¨é€šä¿¡äº†ã€‚</p>
<blockquote>
<p>è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå®šä½å¥½äº†å†™å…¥ä½ç½®å’Œå¯ä»¥å†™å…¥çš„æ•°æ®é‡ï¼Œæ¥ä¸‹å»å°±å¯ä»¥å†™å…¥æ•°æ®äº†ã€‚</p>
</blockquote>
<h2 id="æˆä¸ºæœåŠ¡ç®¡ç†è€…"><a href="#æˆä¸ºæœåŠ¡ç®¡ç†è€…" class="headerlink" title="æˆä¸ºæœåŠ¡ç®¡ç†è€…"></a>æˆä¸ºæœåŠ¡ç®¡ç†è€…</h2><p>ç°åœ¨æˆ‘ä»¬å·²ç»æ‰“å¼€äº† binder é©±åŠ¨ï¼Œå¹¶ä¸”è®°å½•ä¸‹å®ƒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¥ç€ service_manager å¼€å§‹ç”³è¯·æˆä¸ºæœåŠ¡ç®¡ç†è€…äº†ï¼Œå®ƒè°ƒç”¨çš„æ–¹æ³•æ˜¯<code>binder_become_context_manager</code>ã€‚è¿™ä¸ªæ–¹æ³•åŒæ ·å­˜åœ¨äº Libraries å±‚ â€œbinder.câ€ æ–‡ä»¶ä¸­:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_become_context_manager</span><span class="params">(struct binder_state *bs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//#define BINDER_SET_CONTEXT_MGR  _IOW('b', 7, int) </span></span><br><span class="line">    <span class="keyword">return</span> ioctl(bs-&gt;fd, BINDER_SET_CONTEXT_MGR, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåªæœ‰ä¸€è¡Œå¾ˆç®€å•çš„è°ƒç”¨ã€‚<code>ioctl</code>ä¹Ÿæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæœ€ç»ˆè¿™ä¸ªè°ƒç”¨ä¼šæ˜ å°„åˆ° binder é©±åŠ¨çš„ <code>binder_ioctl</code>ã€‚</p>
<p>è¿™ä¹ˆä¸€æ¥å°±è¿›å…¥äº†é©±åŠ¨å±‚ï¼Œ<code>binder_ioctl</code>æ˜¯ä¸€ä¸ªè¾ƒå¤§çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥å¤„ç†å¾ˆå¤šçš„å‘½ä»¤ã€‚è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°å°±ä»£è¡¨å‘½ä»¤ï¼Œè€Œä¸Šé¢çš„è°ƒç”¨ä¼ è¿›æ¥çš„æ˜¯<code>BINDER_SET_CONTEXT_MGR</code>ï¼Œæˆ‘ä»¬å°±å…ˆçœ‹è¿™ä¸ªå‘½ä»¤çš„å¤„ç†è¿‡ç¨‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	 <span class="comment">// é€šè¿‡ filp-&gt;private_data è·å–è¿›ç¨‹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">    <span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">thread</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–åˆ°çº¿ç¨‹</span></span><br><span class="line">    thread = binder_get_thread(proc);</span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> BINDER_SET_CONTEXT_MGR:</span><br><span class="line">        <span class="comment">// binder_context_mgr_nodeæ˜¯ä¸€ä¸ªå…¨å±€é™æ€å˜é‡</span></span><br><span class="line">        <span class="keyword">if</span> (binder_context_mgr_node != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            printk(KERN_ERR <span class="string">"binder: BINDER_SET_CONTEXT_MGR already set\n"</span>);</span><br><span class="line">            ret = -EBUSY;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = security_binder_set_context_mgr(proc-&gt;tsk);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        <span class="keyword">if</span> (binder_context_mgr_uid != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (binder_context_mgr_uid != current-&gt;cred-&gt;euid) &#123;</span><br><span class="line">                printk(KERN_ERR <span class="string">"binder: BINDER_SET_"</span></span><br><span class="line">                       <span class="string">"CONTEXT_MGR bad uid %d != %d\n"</span>,</span><br><span class="line">                       current-&gt;cred-&gt;euid,</span><br><span class="line">                       binder_context_mgr_uid);</span><br><span class="line">                ret = -EPERM;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            binder_context_mgr_uid = current-&gt;cred-&gt;euid;</span><br><span class="line">        <span class="comment">// æ–°å»ºbinder_node</span></span><br><span class="line">        binder_context_mgr_node = binder_new_node(proc, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (binder_context_mgr_node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ret = -ENOMEM;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        binder_context_mgr_node-&gt;local_weak_refs++;</span><br><span class="line">        binder_context_mgr_node-&gt;local_strong_refs++;</span><br><span class="line">        binder_context_mgr_node-&gt;has_strong_ref = <span class="number">1</span>;</span><br><span class="line">        binder_context_mgr_node-&gt;has_weak_ref = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">    <span class="keyword">if</span> (thread)</span><br><span class="line">        thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_NEED_RETURN;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„:</strong> è¿™é‡Œæ˜¯åˆ é™¤äº†å¾ˆå¤šä»£ç çš„ï¼ŒåªæŠŠæ ¸å¿ƒç›¸å…³çš„éƒ¨åˆ†å±•ç¤ºå‡ºæ¥äº†ã€‚</p>
<p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä»£ç ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨<code>binder_get_thread</code>æ–¹æ³•æŸ¥æ‰¾ binder_thread:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct binder_thread *<span class="title">binder_get_thread</span><span class="params">(struct binder_proc *proc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">thread</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// threads: binder_procè¿›ç¨‹å†…ç”¨äºå¤„ç†ç”¨æˆ·è¯·æ±‚çš„çº¿ç¨‹ç»„æˆçš„çº¢é»‘æ ‘(å…³è”binder_thread-&gt;rb_node)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">p</span> = &amp;<span class="title">proc</span>-&gt;<span class="title">threads</span>.<span class="title">rb_node</span>;</span></span><br><span class="line">    <span class="comment">// éå†çº¢é»‘æ ‘å¯»æ‰¾çº¿ç¨‹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">while</span> (*p) &#123;</span><br><span class="line">        parent = *p;</span><br><span class="line">        thread = rb_entry(parent, struct binder_thread, rb_node);</span><br><span class="line">        <span class="keyword">if</span> (current-&gt;pid &lt; thread-&gt;pid)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current-&gt;pid &gt; thread-&gt;pid)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡æ‰¾åˆ°å°±æ–°å»ºï¼Œåˆå§‹åŒ–çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (*p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        thread = kzalloc(<span class="keyword">sizeof</span>(*thread), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (thread == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        binder_stats_created(BINDER_STAT_THREAD);</span><br><span class="line">        thread-&gt;proc = proc;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®°å½•è¿›ç¨‹çš„pid</span></span><br><span class="line">        thread-&gt;pid = current-&gt;pid;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–threadçš„ä¸¤ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        init_waitqueue_head(&amp;thread-&gt;wait);</span><br><span class="line">        INIT_LIST_HEAD(&amp;thread-&gt;todo);</span><br><span class="line">        <span class="comment">// æŒ‚è½½èŠ‚ç‚¹åˆ° &amp;proc-&gt;threads çº¢é»‘æ ‘ä¸Š</span></span><br><span class="line">        rb_link_node(&amp;thread-&gt;rb_node, parent, p);</span><br><span class="line">        rb_insert_color(&amp;thread-&gt;rb_node, &amp;proc-&gt;threads);</span><br><span class="line">        <span class="comment">// è®¾ç½®çŠ¶æ€</span></span><br><span class="line">        thread-&gt;looper |= BINDER_LOOPER_STATE_NEED_RETURN;</span><br><span class="line">        thread-&gt;return_error = BR_OK;</span><br><span class="line">        thread-&gt;return_error2 = BR_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼ é€’è¿›æ¥çš„æ˜¯å½“å‰è¿›ç¨‹çš„è®°å½•å¯¹è±¡<code>binder_proc</code>ï¼Œå…·ä½“çš„è§£é‡Šå·²ç»æ ‡æ³¨åœ¨ä»£ç ä¸­äº†ã€‚è¿™é‡Œæ ‡æ³¨ä¸€ä¸ª<strong>ã€ç–‘ç‚¹ã€‘</strong>ï¼šæŒ‰ç…§è¿™é‡Œçš„ç®—æ³•ï¼Œè¿™æ£µçº¢é»‘æ ‘æ˜¯å¦åªå¯èƒ½æœ‰ä¸€ä¸ªthreadï¼Ÿ</p>
<blockquote>
<p>è¿™é‡Œç»™å‡ºæŒ‚è½½çº¢é»‘æ ‘çš„ä¸¤ä¸ªæ“ä½œçš„è§£é‡Š:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">// å®ƒæŠŠ parent è®¾ä¸º node çš„çˆ¶ç»“ç‚¹ï¼Œå¹¶ä¸”è®© rb_link æŒ‡å‘ nodeã€‚</span></span><br><span class="line">&gt;<span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rb_link_node</span><span class="params">(struct rb_node * node, struct rb_node * parent, struct rb_node ** rb_link)</span></span>;</span><br><span class="line">&gt;</span><br><span class="line">&gt;<span class="comment">// å®ƒæŠŠå·²ç¡®å®šçˆ¶ç»“ç‚¹çš„ node ç»“ç‚¹èå…¥åˆ°ä»¥ root ä¸ºæ ¹çš„çº¢é»‘æ ‘ä¸­</span></span><br><span class="line">&gt;<span class="function"><span class="keyword">void</span> <span class="title">rb_insert_color</span><span class="params">(struct rb_node *node, struct rb_root *root)</span></span>;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>OKï¼Œå›åˆ°å‰é¢ï¼Œè·å–åˆ° binder_thread ä¹‹åï¼Œå°±è¿›å…¥å‘½ä»¤<code>BINDER_SET_CONTEXT_MGR</code>çš„å¤„ç†é˜¶æ®µï¼Œé¦–å…ˆæ˜¯å¦‚ä¸‹ä¸€ä¸ªåˆ¤æ–­:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (binder_context_mgr_node != <span class="literal">NULL</span>) &#123;</span><br><span class="line">	printk(KERN_ERR <span class="string">"binder: BINDER_SET_CONTEXT_MGR already set\n"</span>);</span><br><span class="line">	ret = -EBUSY;</span><br><span class="line">	<span class="keyword">goto</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>binder_context_mgr_node</code>æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">binder_context_mgr_node</span>;</span></span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ä¸ªå…¨å±€é™æ€çš„ binder_node ç»“æ„ä½“ï¼Œè¿™é‡Œçš„åˆ¤æ–­æ˜¯ä¿è¯å…¨å±€åªæœ‰ä¸€ä¸ª binder_context_mgr_nodeï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ä¸€ä¸ª SMã€‚ç¬¬ä¸€æ¬¡è¿›æ¥è¯¥å˜é‡æ²¡æœ‰æ–°å»ºè¿‡ï¼Œå³è¯¥å˜é‡ä¸º NULLï¼Œæ‰€ä»¥ä¼šå»è°ƒç”¨æ–¹æ³•<code>binder_new_node</code>æ–°å»ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç ï¼šbinder_context_mgr_node = binder_new_node(proc, NULL, NULL);</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct binder_node *<span class="title">binder_new_node</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> __user *ptr,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> __user *cookie)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">p</span> = &amp;<span class="title">proc</span>-&gt;<span class="title">nodes</span>.<span class="title">rb_node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span>;</span></span><br><span class="line">    <span class="keyword">while</span> (*p) &#123;</span><br><span class="line">        parent = *p;</span><br><span class="line">        node = rb_entry(parent, struct binder_node, rb_node)</span><br><span class="line">        <span class="keyword">if</span> (ptr &lt; node-&gt;ptr)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ptr &gt; node-&gt;ptr)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node = kzalloc(<span class="keyword">sizeof</span>(*node), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    binder_stats_created(BINDER_STAT_NODE);</span><br><span class="line">    rb_link_node(&amp;node-&gt;rb_node, parent, p);</span><br><span class="line">    rb_insert_color(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</span><br><span class="line">    node-&gt;debug_id = ++binder_last_id;</span><br><span class="line">    node-&gt;proc = proc;</span><br><span class="line">    node-&gt;ptr = ptr;</span><br><span class="line">    node-&gt;cookie = cookie;</span><br><span class="line">    node-&gt;work.type = BINDER_WORK_NODE;</span><br><span class="line">    INIT_LIST_HEAD(&amp;node-&gt;work.entry);</span><br><span class="line">    INIT_LIST_HEAD(&amp;node-&gt;async_todo);</span><br><span class="line">    binder_debug(BINDER_DEBUG_INTERNAL_REFS,</span><br><span class="line">             <span class="string">"binder: %d:%d node %d u%p c%p created\n"</span>,</span><br><span class="line">             proc-&gt;pid, current-&gt;pid, node-&gt;debug_id,</span><br><span class="line">             node-&gt;ptr, node-&gt;cookie);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç¬¬ä¸€è¡Œä»£ç å°±é‡åˆ°äº† binder_proc ä¸­çš„ç¬¬äºŒæ£µçº¢é»‘æ ‘ nodesã€‚nodes èŠ‚ç‚¹è®°å½•çš„æ˜¯å±äºè¯¥è¿›ç¨‹çš„æ‰€æœ‰ binder_node èŠ‚ç‚¹ï¼Œå‰é¢è¯´äº†ï¼Œbinder_node èŠ‚ç‚¹å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªæœåŠ¡å®ä½“ï¼Œå› æ­¤è¿™æ£µæ ‘ä¸Šè®°å½•çš„å°±æ˜¯è¯¥è¿›ç¨‹æä¾›çš„æ‰€æœ‰æœåŠ¡ã€‚æ–°å»ºå®Œæˆä¹‹åå°±æ˜¯ä¸€äº›èµ‹å€¼æ“ä½œä»¥åŠæŒ‚è½½ binder_node çš„åŠ¨ä½œï¼Œæ³¨æ„ï¼Œè¿™é‡Œä¼ è¿›æ¥çš„ ptr å’Œ cookie éƒ½æ˜¯ NULLã€‚</p>
<blockquote>
<p>åé¢å°±ä¼šçŸ¥é“ cookie ä¸º NULL å…¶å®è¡¨æ˜ Libraries å±‚æ²¡æœ‰å¯¹åº”çš„æœåŠ¡ã€‚è¿™æ˜¯ SM è¿™ä¸ªæœåŠ¡çš„ç‰¹æ®Šæ€§ã€‚</p>
</blockquote>
<p>æ‰¯åˆ°å“ªäº†ï¼Ÿå“¦ï¼Œå¯¹äº†ï¼Œæˆ‘ä»¬å·²ç»åœ¨é©±åŠ¨å±‚ä¸º SM åˆ›å»ºäº†ä¸€ä¸ªå…¨å±€çš„æœåŠ¡å®ä½“ï¼Œä»¥ä¸‹æ˜¯è°ƒç”¨å…³ç³»å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/binder_become_context_manager2.png" alt="æ‰“å¼€binderé©±åŠ¨"></div>

<p>æ¥ä¸‹å»æ˜¯å¯¹å¼ºå¼•ç”¨ã€å¼±å¼•ç”¨çš„ç»´æŠ¤ï¼Œè¿™ä¸ªæ¶‰åŠåˆ°æœåŠ¡å®ä½“çš„é‡Šæ”¾ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¤ªå…³å¿ƒã€‚ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤æ˜¯å·®ä¸å¤šçš„è·¯å­ï¼Œéƒ½æ˜¯ä» Libraries å±‚èµ°åˆ°é©±åŠ¨å±‚ï¼Œæ¥ä¸‹å»è¿˜æœ‰ä¸€ä¸ªæ­¥éª¤ï¼Œè¿˜å¾—æŠŠè¿™ä¸ªè¿‡ç¨‹å†èµ°ä¸€éã€‚</p>
<h2 id="å¯åŠ¨å¾ªç¯ç›‘å¬"><a href="#å¯åŠ¨å¾ªç¯ç›‘å¬" class="headerlink" title="å¯åŠ¨å¾ªç¯ç›‘å¬"></a>å¯åŠ¨å¾ªç¯ç›‘å¬</h2><p>å†å›åˆ° service_manager çš„<code>main</code>å‡½æ•°ï¼ŒSM ç¨‹åºè°ƒç”¨<code>binder_loop</code>è¿›å…¥å¾ªç¯ç›‘å¬:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">binder_loop</span><span class="params">(struct binder_state *bs, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> readbuf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    bwr.write_size = <span class="number">0</span>;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    readbuf[<span class="number">0</span>] = BC_ENTER_LOOPER;</span><br><span class="line">    <span class="comment">//å‘Šè¯‰Binderé©±åŠ¨ç¨‹åºï¼Œ Service Managerè¦è¿›å…¥å¾ªç¯äº†</span></span><br><span class="line">    binder_write(bs, readbuf, <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        bwr.read_size = <span class="keyword">sizeof</span>(readbuf);</span><br><span class="line">        bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">unsigned</span>) readbuf;</span><br><span class="line"></span><br><span class="line">        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"binder_loop: ioctl failed (%s)\n"</span>, strerror(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = binder_parse(bs, <span class="number">0</span>, readbuf, bwr.read_consumed, func);</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">0</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"binder_loop: unexpected reply?!\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"binder_loop: io error %d %s\n"</span>, res, strerror(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°è™½ç„¶çœ‹ä¸Šå»æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯è¦åˆ†æçš„ä¸œè¥¿éå¸¸å¤šã€‚</p>
<h3 id="çº¿ç¨‹çŠ¶æ€æ›´æ”¹"><a href="#çº¿ç¨‹çŠ¶æ€æ›´æ”¹" class="headerlink" title="çº¿ç¨‹çŠ¶æ€æ›´æ”¹"></a>çº¿ç¨‹çŠ¶æ€æ›´æ”¹</h3><p><code>for</code>å¾ªç¯å‰ä¸€æ®µä»£ç ç¨å¾®æœ‰ç‚¹å‡Œä¹±ï¼Œæ•´ç†ä¹‹åå¯ä»¥çœ‹å‡ºé¦–å…ˆæ‰§è¡Œçš„æ˜¯:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> readbuf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">readbuf[<span class="number">0</span>] = BC_ENTER_LOOPER;</span><br><span class="line">binder_write(bs, readbuf, <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>));</span><br></pre></td></tr></table></figure>
<p>bs æ˜¯ä¹‹å‰å£°æ˜çš„<code>binder_state</code>ç»“æ„ä½“ï¼Œè¿™é‡ŒæŠŠ<code>BC_ENTER_LOOPER</code>ä¼ é€’è¿›å»äº†ï¼Œæˆ‘ä»¬ç›´æ¥å»çœ‹<code>binder_write</code>å‡½æ•°æ˜¯æ€ä¹ˆä½¿ç”¨è¿™äº›å‚æ•°çš„:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç ï¼šbinder_write(bs, readbuf, sizeof(unsigned))</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_write</span><span class="params">(struct binder_state *bs, <span class="keyword">void</span> *data, <span class="keyword">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    bwr.write_size = len;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">unsigned</span>) data;</span><br><span class="line">    bwr.read_size = <span class="number">0</span>;</span><br><span class="line">    bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"binder_write: ioctl failed (%s)\n"</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç”¨åˆ°äº† binder_write_read ç»“æ„ä½“ï¼Œåœ¨å­—å…¸ä¸­æœ‰æåˆ°ï¼šè¿™ä¸ªç»“æ„ä½“åªæ˜¯è´Ÿè´£ä¼ è¾“æ•°æ®ï¼Œå…·ä½“è¯­ä¹‰ç”±ä¸Šä¸‹æ–‡ç¯å¢ƒè‡ªè¡Œå®šä¹‰ã€‚è¿™é‡Œå°±å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥è¿™ç§ç©æ³•ï¼šåˆšåˆšä¼ è¿›æ¥çš„ data å­—æ®µè¢«èµ‹å€¼åˆ°äº† bwr çš„ write éƒ¨åˆ†äº†ï¼Œå³ write_buffer å­—æ®µè¢«èµ‹äºˆäº†<code>BC_ENTER_LOOPER</code>å‘½ä»¤ï¼Œå¹¶ä¸” write_consumed ä¹Ÿè¢«èµ‹äºˆäº†0ï¼Œè¡¨ç¤º binder é©±åŠ¨æ²¡æœ‰è¯»å–ä»»ä½•æ•°æ®ï¼Œé€šè¿‡ wite_consumed å’Œ write_size ä¸¤ä¸ªå­—æ®µï¼Œå°±å¯ä»¥æŒ‡å®š write_buffer ä¸­çš„æ•°æ®å“ªä¸€æ®µæ˜¯æœ‰æ•ˆçš„ï¼Œbinder é©±åŠ¨ä¼šæ ¹æ®è¿™ä¸¤ä¸ªå€¼è¯»å–æœ‰æ•ˆæ•°æ®ã€‚æ•°æ®ä»¥åŠä½ç½®è®¾å®šå¥½ä¹‹åï¼Œå†è°ƒç”¨<code>ioctl</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å‰é¢æœ‰è¿‡ä¸€æ¬¡åˆ†æï¼Œå®ƒä¹Ÿä¼šæºå¸¦ä¸€ä¸ªå‘½ä»¤ï¼Œè¿™æ¬¡æºå¸¦çš„æ˜¯<code>BINDER_WRITE_READ</code>ï¼Œåˆ°å¯¹åº”é©±åŠ¨å‡½æ•°ä¸­çœ‹ä¸€ä¸‹è¿™ä¸ªå‘½ä»¤çš„å¤„ç†æ–¹å¼:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç ï¼šres = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = _IOC_SIZE(cmd);</span><br><span class="line">    <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">        <span class="comment">// éªŒè¯æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">        <span class="keyword">if</span> (size != <span class="keyword">sizeof</span>(struct binder_write_read)) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">            trace_binder_write_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</span><br><span class="line">            trace_binder_read_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</span><br><span class="line">                wake_up_interruptible(&amp;proc-&gt;wait);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        binder_debug(BINDER_DEBUG_READ_WRITE,</span><br><span class="line">                 <span class="string">"binder: %d:%d wrote %ld of %ld, read return %ld of %ld\n"</span>,</span><br><span class="line">                 proc-&gt;pid, thread-&gt;pid, bwr.write_consumed, bwr.write_size,</span><br><span class="line">                 bwr.read_consumed, bwr.read_size);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">    <span class="keyword">if</span> (thread)</span><br><span class="line">        thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_NEED_RETURN;</span><br><span class="line">    binder_unlock(__func__);</span><br><span class="line">    wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error &lt; <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &amp;&amp; ret != -ERESTARTSYS)</span><br><span class="line">        printk(KERN_INFO <span class="string">"binder: %d:%d ioctl %x %lx returned %d\n"</span>, proc-&gt;pid, current-&gt;pid, cmd, arg, ret);</span><br><span class="line">err_unlocked:</span><br><span class="line">    trace_binder_ioctl_done(ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥å¼€åŠ¨å°ç«è½¦åˆ†æ case çš„ä»£ç ã€‚é¦–å…ˆæ˜¯ä¸€ä¸ªåˆ¤æ–­ï¼Œè¿™æ˜¯åˆ¤æ–­æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚æ¥ç€è°ƒç”¨å‡½æ•°<code>copy_from_user</code>ï¼Œè¿™ä¸ªå‡½æ•°çš„ user æ˜¯ç”¨æˆ·ç©ºé—´çš„æ„æ€ï¼Œå®ƒçš„ç›®çš„æ˜¯ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®åˆ°å†…æ ¸ç©ºé—´ã€‚</p>
<p>æˆ‘ä»¬è°ƒç”¨<code>binder_ioctl</code>çš„æ—¶å€™ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯<code>&amp;bwr</code>ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª binder_write_read ç»“æ„ä½“ï¼Œè¿™é‡Œå°±æ˜¯å°†è¿™ä¸ªç»“æ„ä½“æ‹·è´åˆ°é©±åŠ¨å±‚çš„ bwr ç»“æ„ä½“ä¸­ã€‚</p>
<blockquote>
<p>è¯»è€…åº”å½“ç†Ÿæ‚‰è¿™ç§æ¨¡å¼ï¼Œè¿™å¾ˆç±»ä¼¼äºç½‘ç»œè¯·æ±‚ã€‚Httpè¯·æ±‚å®šä¹‰äº†å…«ç§æ–¹æ³•ï¼Œæœ€å¸¸è§çš„æ˜¯Postï¼ŒGetä¸¤ç§ï¼Œè¿™å°±ç±»ä¼¼äºè¯¥å‡½æ•°çš„ cmd å‚æ•°ï¼Œè€Œå…·ä½“çš„è¯­ä¹‰å…¶å®æ˜¯ç”±è¯·æ±‚å†…å®¹ç¡®å®šçš„ï¼Œè¿™åŒ…æ‹¬APIç»“æ„ï¼Œæ¯”å¦‚æˆ‘çš„æ¥å£å«åš<code>getorder.api</code>ï¼Œä¼´éšç€è¿™ä¸ªæ¥å£å‘å‡ºå»çš„è¿˜æœ‰ä¸€äº›æ•°æ®ï¼Œè¿™äº›å°±ç±»ä¼¼äº binder_write_read ç»“æ„ä½“äº†ã€‚å¤„ç†å®Œæˆä¹‹åï¼Œä¹Ÿåœ¨è¯¥è¯·æ±‚ä¸Šè¿”å›æ•°æ®ã€‚</p>
<p>åé¢è¿˜ä¼šè§åˆ°è¿™ç§æ¨¡å¼çš„åå¤ä½¿ç”¨ï¼Œå®ƒæ˜¯ binder æœºåˆ¶ Libraries å±‚å’Œé©±åŠ¨å±‚é€šä¿¡çš„ä¸€ç§å…¸å‹æ¨¡å¼ã€‚ </p>
</blockquote>
<p>ç†æ‰€åº”å½“çš„ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£ææ•°æ®çš„è¿‡ç¨‹ã€‚å› ä¸ºä¼ é€’å‚æ•°ä¸­åªæœ‰ write éƒ¨åˆ†æœ‰æ•°æ®ï¼Œé‚£ä¹ˆæ¥ä¸‹å»çš„ä¸¤ä¸ªåˆ¤æ–­åªæœ‰ä¸‹é¢è¿™ä¸ªä¼šæ‰§è¡Œ:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">	trace_binder_write_done(ret);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">			ret = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè°ƒç”¨äº†<code>binder_thread_write</code>æ¥å¤„ç† binder_write_read ç»“æ„ä½“çš„å†…å®¹ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„å‡½æ•°ï¼Œå› ä¸ºå®ƒéœ€è¦è§£æè¯¥ç»“æ„ä½“ä¸­å¯èƒ½ä¼ è¾“è¿‡æ¥çš„æ‰€æœ‰çš„å‘½ä»¤ï¼Œè¿™é‡Œæˆ‘ä»¬åªçœ‹å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å¤„ç†å‘½ä»¤<code>BC_ENTER_LOOPER</code>çš„åœ°æ–¹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, <span class="keyword">signed</span> <span class="keyword">long</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">    <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (get_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))<span class="comment">//è¯»å–cmd</span></span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">        trace_binder_command(cmd);</span><br><span class="line">        <span class="keyword">if</span> (_IOC_NR(cmd) &lt; ARRAY_SIZE(binder_stats.bc)) &#123;</span><br><span class="line">            binder_stats.bc[_IOC_NR(cmd)]++;</span><br><span class="line">            proc-&gt;stats.bc[_IOC_NR(cmd)]++;</span><br><span class="line">            thread-&gt;stats.bc[_IOC_NR(cmd)]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> BC_ENTER_LOOPER:<span class="comment">//Serviceå°†è¦è¿›å…¥LoopçŠ¶æ€æ—¶ï¼Œå‘é€æ­¤æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">if</span> (thread-&gt;looper &amp; BINDER_LOOPER_STATE_REGISTERED) &#123;</span><br><span class="line">                thread-&gt;looper |= BINDER_LOOPER_STATE_INVALID;</span><br><span class="line">                binder_user_error(<span class="string">"binder: %d:%d ERROR:"</span></span><br><span class="line">                    <span class="string">" BC_ENTER_LOOPER called after "</span></span><br><span class="line">                    <span class="string">"BC_REGISTER_LOOPER\n"</span>,</span><br><span class="line">                    proc-&gt;pid, thread-&gt;pid);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¡¨ç¤ºè¿›å…¥enterçŠ¶æ€ï¼Œlooperç”¨äºè®°å½•çŠ¶æ€</span></span><br><span class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_ENTERED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ³¨æ„!!!</span></span><br><span class="line">        *consumed = ptr - buffer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„å…¥å‚ buffer æŒ‡å‘çš„æ˜¯æˆ‘ä»¬åœ¨ç»“æ„ä½“ binder_write_read ä¸­å†™å…¥çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bwr.write_buffer = (<span class="keyword">unsigned</span>) data;</span><br></pre></td></tr></table></figure>
<p>è€Œ data å°±æ˜¯<code>BC_ENTER_LOOPER</code>ï¼Œæ‰€ä»¥ ptr å®é™…æ˜¯æŒ‡å‘è¿™æ®µæ•°æ®çš„å¼€å§‹ï¼Œend æŒ‡å‘çš„æ˜¯è¿™æ®µæ•°æ®çš„æœ«å°¾ã€‚<code>get_user</code>ä¹Ÿæ˜¯ä¸€ä¸ªå†…æ ¸å‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥è®¤ä¸ºå°±æ˜¯ä» ptr å¼€å§‹è¯»å–ä¸€ä¸ª uint32_t å€¼å­˜å‚¨åˆ° cmd ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª cmd å°±æ˜¯<code>BC_ENTER_LOOPER</code>ï¼Œæ¥ç€æŒ‡é’ˆåç§»ã€‚</p>
<blockquote>
<p>ä»è¿™é‡Œçš„è¯»å–æ–¹å¼æ¥çœ‹ï¼Œå¯ä»¥çŒœåˆ°è¿™æ˜¯ä¸€ç§éå¸¸å›ºå®šçš„â€å‘½ä»¤+æ•°æ®â€çš„æ¨¡å¼ï¼Œæ˜¯ä¸¤å±‚ä¹‹é—´çº¦å®šä¿—ç§°çš„åè®®ã€‚</p>
</blockquote>
<p>ä¹‹åå°±è¿›å…¥å¤„ç†é˜¶æ®µï¼Œå­—å…¸é‡Œé¢è¯´åˆ° binder_thread çš„ looper å­—æ®µè®°å½•æ˜¯çº¿ç¨‹å½“å‰çš„çŠ¶æ€ï¼Œè¿™é‡Œä¸»è¦è¿›è¡Œçš„å°±æ˜¯çŠ¶æ€è®¾ç½®ï¼Œåœ¨æ£€æµ‹å®ŒçŠ¶æ€æ˜¯å¦æ­£ç¡®ä¹‹åï¼Œè°ƒç”¨ä»¥ä¸‹è¯­å¥:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread-&gt;looper |= BINDER_LOOPER_STATE_ENTERED;</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®çŠ¶æ€<code>ENTERED</code>ï¼Œå°±è¡¨ç¤ºè¦è¿›å…¥å¾ªç¯çŠ¶æ€äº†ã€‚è®²å®Œè¿™ä¸ªå†å›åˆ°<code>binder_ioctl</code>æ–¹æ³•å»ï¼Œè¿˜æ²¡å®Œå‘¢ï¼Œæ­£å¸¸æ‰§è¡Œå®Œä¸Šé¢çš„æ–¹æ³•ä¹‹åï¼Œä¼šèµ°åˆ°è¿™æ®µä»£ç ä¸­å»:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (copy_to_user(ubuf, &amp;bwr, sizeof(bwr))) &#123;</span><br><span class="line">	ret = -EFAULT;</span><br><span class="line">	goto err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>copy_to_user</code>çœ‹åå­—å°±çŸ¥é“å’Œ<code>copy_from_user</code>å‡½æ•°ä»€ä¹ˆå…³ç³»äº†ï¼šè¿™ä¸ªå‡½æ•°æ˜¯ä»å†…æ ¸ç©ºé—´æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ã€‚è¿™é‡Œæ‹·è´çš„è¿˜æ˜¯ binder_write_read ç»“æ„ä½“ï¼Œè¦æŠŠå†…æ ¸ç©ºé—´çš„ä¿®æ”¹åæ˜ åˆ° Libraries å±‚ï¼šè¿™é‡Œå”¯ä¸€çš„æ”¹åŠ¨å°±æ˜¯ write_consumed çš„æŒ‡é’ˆçš„ç§»åŠ¨ï¼Œè¿™ä¸ªæŒ‡é’ˆåœ¨è¯»å®Œæ•°æ®ä¹‹åï¼Œè¢«æ‰§è¡Œäº†å¦‚ä¸‹æ“ä½œ:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">*consumed = ptr - buffer;</span><br></pre></td></tr></table></figure>
<p>ptr åŸæœ¬æŒ‡å‘ buffer æ•°æ®çš„å¼€å§‹ï¼Œæ ¹æ®ä¸Šé¢çš„å†™æ³•ï¼Œå®é™…ä¸Š<code>*consumed</code>å°±ç­‰äº<code>sizeof(uint32_t)</code>ï¼Œä¹Ÿå°±æ˜¯<code>BC_ENTER_LOOPER</code>çš„é•¿åº¦ï¼Œè¿™å°±è¡¨ç¤ºé©±åŠ¨å·²ç»è¯»å–äº† write éƒ¨åˆ†çš„æ•°æ®ã€‚</p>
<p>å¥½äº†åˆ°è¿™é‡Œæ€»ç®—åˆ†æå®Œæˆ<code>binder_write(bs, readbuf, sizeof(unsigned));</code>è¿™ä¸€å¥äº†ã€‚å®ƒåªåšä¸€ä»¶äº‹æƒ…ï¼šå‘Šè¯‰é©±åŠ¨å±‚æˆ‘è¦è¿›å…¥å¾ªç¯ç›‘å¬çŠ¶æ€äº†ã€‚è¯»è€…åŠ¡å¿…åº”ç†Ÿæ‚‰è¿™ç§äº¤äº’æ–¹å¼ï¼Œè¿™é‡Œæ˜¯æœ€ç®€å•æ¸…æ¥šçš„ä¸€ä¸ªä¾‹å­ã€‚è¿™é‡Œæ˜¯è°ƒç”¨å…³ç³»å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/binder_write.png" alt="å‘Šè¯‰binderé©±åŠ¨å³å°†è¿›å…¥å¾ªç¯ç›‘å¬"></div>

<h3 id="å¾ªç¯-amp-ç›‘å¬"><a href="#å¾ªç¯-amp-ç›‘å¬" class="headerlink" title="å¾ªç¯ &amp; ç›‘å¬"></a>å¾ªç¯ &amp; ç›‘å¬</h3><p>ç»ˆäºè¿›å…¥æ­£é¢˜äº†ï¼Œå‰é¢éƒ½æ˜¯çŠ¶æ€å‡†å¤‡è€Œå·²ã€‚åœ¨åˆ†æä»£ç ä¹‹å‰ï¼Œå¯ä»¥å…ˆä»çŒœæµ‹ä¸€ä¸‹å®ƒä¼šæ€ä¹ˆåšï¼Ÿåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒçŠ¶æ€éƒ½å·²ç»è®¾ç½®å®Œæ¯•ï¼Œé©±åŠ¨å±‚å’Œå½“å‰è¿›ç¨‹ä¹Ÿæœ‰å…±äº«å†…å­˜æ¥ä¼ è¾“æ•°æ®ï¼Œé‚£æ¯”è¾ƒåˆç†çš„åšæ³•å°±æ˜¯å»è¯»å–è¿™å—å…±äº«å†…å­˜ï¼Œçœ‹æ˜¯å¦æœ‰æ•°æ®å¯ä»¥å¤„ç†ï¼Œå¦‚æœæœ‰åˆ™è¯»å‡ºæ¥è¿›è¡Œå¤„ç†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®å†™å…¥ï¼Œè¢«é©±åŠ¨å±‚å”¤é†’å†è¿”å›ã€‚é‚£ä¹ˆå®é™…ä¸Šæ˜¯ä¸æ˜¯è¿™æ ·çš„å‘¢ï¼ŸRead the fucking code !</p>
<p><code>binder_loop</code>å‡½æ•°æ¥ä¸‹å»çš„æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå†è´´ä¸€ä¸‹ä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç ï¼šreadbuf[0] = BC_ENTER_LOOPER;</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">	bwr.read_size = <span class="keyword">sizeof</span>(readbuf);</span><br><span class="line">	bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">	bwr.read_buffer = (<span class="keyword">unsigned</span>) readbuf;</span><br><span class="line"></span><br><span class="line">	res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		LOGE(<span class="string">"binder_loop: ioctl failed (%s)\n"</span>, strerror(errno));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res = binder_parse(bs, <span class="number">0</span>, readbuf, bwr.read_consumed, func);</span><br><span class="line">	<span class="keyword">if</span> (res == <span class="number">0</span>) &#123;</span><br><span class="line">		LOGE(<span class="string">"binder_loop: unexpected reply?!\n"</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		LOGE(<span class="string">"binder_loop: io error %d %s\n"</span>, res, strerror(errno));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹å¾ªç¯çš„ç¬¬ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ã€‚é¦–å…ˆè¿˜æ˜¯åœ¨æ“ä½œ binder_write_read ç»“æ„ä½“ï¼Œåªä¸è¿‡è¿™é‡Œæ“ä½œçš„æ˜¯ read éƒ¨åˆ†ï¼šå®ƒå‘Šè¯‰é©±åŠ¨ï¼Œæˆ‘è¦è¯»å–æ•°æ®ï¼Œè¯»å–çš„æ•°æ®å¤§å°æ˜¯<code>sizeof(readbuf)</code>ã€‚æ‰§è¡Œçš„å‘½ä»¤ä¹Ÿæ˜¯åŒæ ·çš„<code>BINDER_WRITE_READ</code>ï¼Œå› æ­¤å®é™…ä¸Šè¿˜æ˜¯èµ°çš„è¿™æ®µä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = _IOC_SIZE(cmd);</span><br><span class="line">    <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (size != <span class="keyword">sizeof</span>(struct binder_write_read)) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">            trace_binder_write_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</span><br><span class="line">            trace_binder_read_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</span><br><span class="line">                wake_up_interruptible(&amp;proc-&gt;wait);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">    <span class="keyword">if</span> (thread)</span><br><span class="line">        thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_NEED_RETURN;</span><br><span class="line">    binder_unlock(__func__);</span><br><span class="line">    wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error &lt; <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &amp;&amp; ret != -ERESTARTSYS)</span><br><span class="line">        printk(KERN_INFO <span class="string">"binder: %d:%d ioctl %x %lx returned %d\n"</span>, proc-&gt;pid, current-&gt;pid, cmd, arg, ret);</span><br><span class="line">err_unlocked:</span><br><span class="line">    trace_binder_ioctl_done(ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œåœ¨è¿™é‡Œåˆ†æçš„æ—¶å€™ä¸è¦è¢«ä¹‹å‰<code>BC_ENTER_LOOPER</code>çš„ bwr ç»“æ„ä½“å½±å“ï¼Œé‚£ä¸ªå†™å…¥çš„ bwr æ˜¯åœ¨<code>binder_write</code>æ–¹æ³•ä¸­æ–°åˆ›å»ºçš„ï¼Œè¿™é‡Œçš„ bwr æ˜¯å¦å¤–ä¸€ä¸ªå˜é‡ï¼Œå°±æ˜¯åœ¨<code>binder_loop</code>ä¸­åˆ›å»ºçš„ã€‚å› æ­¤åœ¨<code>for</code>å¾ªç¯æ‰§è¡Œå‰ï¼Œbwr çš„çŠ¶æ€æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">bwr.write_size = <span class="number">0</span>;</span><br><span class="line">bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">bwr.write_buffer = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å‰é¢çš„ä»£ç ï¼Œæ­¤æ—¶<code>bwr.read_size</code>çš„å€¼æ˜¯<code>sizeof(readbuf)</code>ï¼Œå› æ­¤å®é™…æ‰§è¡Œçš„æ˜¯:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç ï¼šbwr.read_size = sizeof(readbuf);</span></span><br><span class="line"><span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</span><br><span class="line">	trace_binder_read_done(ret);</span><br><span class="line">	<span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</span><br><span class="line">		wake_up_interruptible(&amp;proc-&gt;wait);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">			ret = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆšè¿›æ¥å°±ç›´æ¥è°ƒç”¨<code>binder_thread_read</code>å‡½æ•°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * è°ƒç”¨ä»£ç ï¼šret = binder_thread_read(proc, thread, (void __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</span></span><br><span class="line"><span class="comment"> * å‚æ•°è§£é‡Šï¼š</span></span><br><span class="line"><span class="comment"> * bwr.read_size = sizeof(readbuf);</span></span><br><span class="line"><span class="comment"> * bwr.read_consumed = 0;</span></span><br><span class="line"><span class="comment"> * bwr.read_buffer = (unsigned) readbuf;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * non_block æ˜¯ false çš„ï¼Œå› ä¸ºæ‰“å¼€é©±åŠ¨çš„æ—¶å€™ä½¿ç”¨çš„ä»£ç æ˜¯ open("/dev/binder", O_RDWR);</span></span><br><span class="line"><span class="comment"> * å¹¶æ²¡æœ‰è®¾ç½® O_NONBLOCK æ ‡è¯†ï¼Œå› æ­¤è¿™ä¸ªæ“ä½œå°±æ˜¯é˜»å¡çš„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">    <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> wait_for_proc_work;</span><br><span class="line">    <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="comment">// æ‹·è´"BR_NOOP"å‘½ä»¤åˆ°prtåœ°å€ï¼Œä¹Ÿå°±æ˜¯readéƒ¨åˆ†çš„æ•°æ®åŒº</span></span><br><span class="line">    	<span class="keyword">if</span> (put_user(BR_NOOP, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        <span class="comment">// ç§»åŠ¨æŒ‡é’ˆ</span></span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">    &#125;</span><br><span class="line">retry:</span><br><span class="line">	 <span class="comment">// æˆç«‹ï¼Œå› æ­¤ wait_for_proc_work ä¸º true</span></span><br><span class="line">    wait_for_proc_work = thread-&gt;transaction_stack == <span class="literal">NULL</span> &amp;&amp; list_empty(&amp;thread-&gt;todo);</span><br><span class="line">    <span class="comment">// ä¸æˆç«‹ï¼Œthread-&gt;return_error åœ¨ binder_thread çš„ return_error å­—æ®µåœ¨åˆ›å»ºçš„æ—¶å€™å°±è¢«åˆå§‹åŒ–ä¸º BR_OKï¼Œ</span></span><br><span class="line">    <span class="comment">// å…·ä½“å¯è§æ–¹æ³•`binder_get_thread`æ–¹æ³•ä¸­æ–°å»º binder_thread ç»“æ„ä½“çš„éƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">// å¦å¤– ptr = end</span></span><br><span class="line">    <span class="keyword">if</span> (thread-&gt;return_error != BR_OK &amp;&amp; ptr &lt; end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (thread-&gt;return_error2 != BR_OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (put_user(thread-&gt;return_error2, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">            binder_stat_br(proc, thread, thread-&gt;return_error2);</span><br><span class="line">            <span class="keyword">if</span> (ptr == end)</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            thread-&gt;return_error2 = BR_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (put_user(thread-&gt;return_error, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">        binder_stat_br(proc, thread, thread-&gt;return_error);</span><br><span class="line">        thread-&gt;return_error = BR_OK;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®çŠ¶æ€ä¸ºç­‰å¾…</span></span><br><span class="line">    thread-&gt;looper |= BINDER_LOOPER_STATE_WAITING;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work)</span><br><span class="line">        proc-&gt;ready_threads++;</span><br><span class="line">    binder_unlock(__func__);</span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work) &#123;</span><br><span class="line">    	<span class="comment">// ä¹‹å‰å·²ç»è®¾ç½® BINDER_LOOPER_STATE_ENTERED çŠ¶æ€ï¼Œå› æ­¤åˆ¤æ–­ä¸æˆç«‹</span></span><br><span class="line">        <span class="keyword">if</span> (!(thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED |</span><br><span class="line">                    BINDER_LOOPER_STATE_ENTERED))) &#123;</span><br><span class="line">            binder_user_error(<span class="string">"binder: %d:%d ERROR: Thread waiting "</span></span><br><span class="line">                <span class="string">"for process work before calling BC_REGISTER_"</span></span><br><span class="line">                <span class="string">"LOOPER or BC_ENTER_LOOPER (state %x)\n"</span>,</span><br><span class="line">                proc-&gt;pid, thread-&gt;pid, thread-&gt;looper);</span><br><span class="line">            wait_event_interruptible(binder_user_error_wait,</span><br><span class="line">                         binder_stop_on_user_error &lt; <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        binder_set_nice(proc-&gt;default_priority);</span><br><span class="line">        <span class="comment">//æ‰“å¼€binderè®¾å¤‡çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯open("/dev/binder", O_RDWR)ï¼Œè€Œä¸æ˜¯open("/dev/ttys", O_RDWR|O_NONBLOCK)ï¼Œå› æ­¤æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥non_blockä¸ºfalse</span></span><br><span class="line">        <span class="keyword">if</span> (non_block) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!binder_has_proc_work(proc, thread))</span><br><span class="line">                ret = -EAGAIN;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">        	<span class="comment">// æœ€ç»ˆä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span></span><br><span class="line">            ret = wait_event_freezable_exclusive(proc-&gt;wait, binder_has_proc_work(proc, thread));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (non_block) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!binder_has_thread_work(thread))</span><br><span class="line">                ret = -EAGAIN;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            ret = wait_event_freezable(thread-&gt;wait, binder_has_thread_work(thread));</span><br><span class="line">    &#125;</span><br><span class="line">    binder_lock(__func__);</span><br><span class="line">    <span class="comment">// é˜»å¡é‡Šæ”¾ä¹‹åï¼Œå‡å°‘ä¸€ä¸ªå°±ç»ªçš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work)</span><br><span class="line">        proc-&gt;ready_threads--;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºçº¿ç¨‹ä¸åœ¨ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">    thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_WAITING;</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­ç›¸å…³æ³¨é‡Šéƒ½å·²ç»æ ‡æ˜å…·ä½“åœ¨åšä»€ä¹ˆï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°<code>wait_event_freezable_exclusive(proc-&gt;wait, binder_has_proc_work(proc, thread));</code>è¿™ä¸€å¥ã€‚ä»ç½‘ä¸Šæ‰¾çš„èµ„æ–™çœ‹<code>wait_event_freezable_exclusive</code>åŸºæœ¬ç­‰åŒäº<code>wait_event_interruptible_exclusive</code>ï¼Œè€ç½—çš„åˆ†æä¸­ä»£ç å°±æ˜¯å†™çš„è¿™ä¸ªå‡½æ•°ï¼ˆå®ƒçš„æºç ç‰ˆæœ¬æ¯”è¾ƒè€ï¼‰ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹‹åè¿›ç¨‹å°±è¢«é˜»å¡ï¼Œç›´åˆ°<code>binder_has_thread_work(thread)</code>ä¸º true:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_has_thread_work</span><span class="params">(struct binder_thread *thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !list_empty(&amp;thread-&gt;todo) || thread-&gt;return_error != BR_OK ||</span><br><span class="line">        (thread-&gt;looper &amp; BINDER_LOOPER_STATE_NEED_RETURN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>thread-&gt;todo</code>åˆ—è¡¨ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œè¯¥å‡½æ•°è¿”å›trueï¼Œè‡³äºè¿™ä¸ªåˆ—è¡¨ä¸­å­˜æ”¾çš„ä»€ä¹ˆï¼Œä¸‹ä¸¤ç¯‡æ–‡ç« ä¸­ä¼šè§£é‡Šã€‚</p>
<p>è¿™é‡Œè¯¦ç»†è§£é‡Šä¸€ä¸‹<code>wait_event_interruptible_exclusive</code>è¿™ä¸ªå‡½æ•°ï¼ŒLinuxä¸­è¿˜æœ‰ä¸€ä¸ªç±»ä¼¼çš„å‡½æ•°å«åš<code>wait_event_interruptible</code>ï¼Œexclusiveè¡¨ç¤ºæ’ä»–è¿›ç¨‹ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸å»è€ƒè™‘ï¼Œå®˜æ–¹æ–‡æ¡£ä¸Šå¯¹äºè¿™ä¸ªæ–¹æ³•çš„è§£é‡Šæ˜¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wait_event_interruptible â€” sleep until a condition gets true</span><br><span class="line"></span><br><span class="line">ã€Descriptionã€‘</span><br><span class="line">The process is put to sleep (TASK_INTERRUPTIBLE) until the condition evaluates to true or a signal is received. The condition is checked each time the waitqueue wq is woken up.</span><br><span class="line"></span><br><span class="line">wake_up has to be called after changing any variable that could change the result of the wait condition.</span><br><span class="line"></span><br><span class="line">The function will return -ERESTARTSYS if it was interrupted by a signal and 0 if condition evaluated to true.</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¦çœ‹çš„å…¶å®æ˜¯è¿™å¥ï¼š<strong>The function will return -ERESTARTSYS if it was interrupted by a signal and 0 if condition evaluated to true.</strong> æ¢å¥è¯è¯´ï¼Œå¦‚æœæ˜¯è¢«ä¸­æ–­çš„ï¼Œè¿”å›çš„æ˜¯<code>-ERESTARTSYS</code>ï¼Œå¦‚æœæ˜¯æ¡ä»¶æ»¡è¶³åè¿”å›çš„ï¼Œåˆ™è¿”å›0ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦è§£é‡Šè¿™ä¸ªå‘¢ï¼Ÿå› ä¸ºåœ¨é˜»å¡æ¢å¤ä»¥åï¼Œæœ‰è¿™æ ·ä¸€æ®µä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br></pre></td></tr></table></figure>
<p>ret æ­£æ˜¯è¯¥å‡½æ•°çš„è¿”å›å€¼ï¼Œå› æ­¤å¦‚æœæ˜¯æ¡ä»¶æ»¡è¶³åé˜»å¡æ¢å¤ï¼Œä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p>
<p>OKï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¹ŸæŠŠå¾ªç¯ç›‘å¬åˆ†æå®Œäº†ï¼Œä»¥ä¸‹æ˜¯è°ƒç”¨å…³ç³»å›¾:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/binder_read.png" alt="å‘Šè¯‰binderé©±åŠ¨è¿›å…¥å¾ªç¯ç›‘å¬"></div>

<h3 id="å¤„ç†å‘½ä»¤"><a href="#å¤„ç†å‘½ä»¤" class="headerlink" title="å¤„ç†å‘½ä»¤"></a>å¤„ç†å‘½ä»¤</h3><p>å½“å¾ªç¯ç›‘å¬åˆ°æ¶ˆæ¯ï¼Œå³æœ‰æ¶ˆæ¯è¿”å›çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šé€šè¿‡ä¸€ä¸ªwhileå¾ªç¯åˆæ­¥å¤„ç†æ•°æ®ï¼Œä¹‹åè¿”å›æ— é™å¾ªç¯ä¸­ï¼Œè°ƒç”¨æ–¹æ³•<code>binder_parse</code>è§£æè¯·æ±‚:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = binder_parse(bs, <span class="number">0</span>, readbuf, bwr.read_consumed, func);</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºè¿™é‡Œæ²¡æœ‰å®é™…çš„åœºæ™¯ï¼Œå°±æš‚ä¸åˆ†æè¯·æ±‚å¤„ç†è¿™å—çš„ä»£ç ï¼Œä¸‹é¢ä¸¤ç¯‡æ–‡ç« ä¸­éƒ½ä¼šæ¶‰åŠåˆ°è¯¥å‡½æ•°çš„åˆ†æã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç»¼ä¸Šï¼ŒSM å¯åŠ¨çš„è¿‡ç¨‹åˆ†æå®Œæ¯•ã€‚å®ƒç°åœ¨åœ¨ç­‰å¾…ç€<code>binder_has_thread_work</code>ä¸ºçœŸã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Binderä¹‹Serviceæ³¨å†Œ]]></title>
      <url>http://www.timebridge.space/2016/06/21/binder-service-register/</url>
      <content type="html"><![CDATA[<p>å‰æ–‡<a href="http://www.muzileecoding.com/framework/binder-servicemanager.html" target="_blank" rel="noopener">Binderä¹‹Service Manager</a>å·²ç»è®²è¿°äº† SM å¦‚ä½•å¯åŠ¨å¹¶å¾ªç¯ç›‘å¬æ¶ˆæ¯çš„ï¼Œæ¥ä¸‹å»æŒ‰ç…§é€»è¾‘åº”è¯¥æ˜¯å…ˆè¯´å¦‚ä½•æ³¨å†Œä¸€ä¸ªæœåŠ¡å†è¯´å¦‚ä½•è·å–ä¸€ä¸ªæœåŠ¡ï¼Œä½†æ˜¯ä»ä»£ç å±‚é¢æ¥è¯´ï¼Œå…ˆè¯´è·å–æœåŠ¡ä¼¼ä¹æ›´å¥½ï¼Œå¥½çº ç»“ã€‚è¿˜æ˜¯æŒ‰ç…§é€»è¾‘æ¥è®²å§~</p>
<h2 id="ç ”ç©¶å¯¹è±¡"><a href="#ç ”ç©¶å¯¹è±¡" class="headerlink" title="ç ”ç©¶å¯¹è±¡"></a>ç ”ç©¶å¯¹è±¡</h2><p>æ—¢ç„¶æ˜¯è®²è¿°æœåŠ¡æ³¨å†Œï¼Œæœ€å¥½çš„å½“ç„¶æ˜¯ä»ç°æœ‰çš„ç³»ç»Ÿä¸­æ‰¾å‡ºä¸€æšæœåŠ¡ï¼Œç ”ç©¶å®ƒçš„æ³¨å†Œè¿‡ç¨‹ã€‚<a href="http://www.muzileecoding.com/framework/binder.html" target="_blank" rel="noopener">æ€»çº²</a>ä¸­æ¨èçš„5ç¯‡æ–‡ç« æ­£å¥½æœ‰ä¸€ç¯‡æ˜¯ä»è¿™ä¸ªè§’åº¦åˆ‡å…¥åˆ†æBinderçš„ï¼šæ–‡ç« â‘¤<a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html" target="_blank" rel="noopener">Androidæ·±å…¥æµ…å‡ºä¹‹Binderæœºåˆ¶</a>ã€‚å®ƒæ˜¯ä» MediaServer æ¥åˆ‡å…¥åˆ†æçš„ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬ä¸»è¦æ˜¯çœ‹æ³¨å†Œçš„è¿‡ç¨‹ï¼Œé€‰æ‹©ä»€ä¹ˆæœåŠ¡æ˜¯æ¬¡è¦çš„ï¼Œå› æ­¤è¿™é‡Œä¹Ÿä»¥è¯¥æœåŠ¡ä¸ºåˆ†æå¯¹è±¡ã€‚<strong>ä»¥ä¸‹ MediaServer ç®€ç§° MS</strong>ã€‚MS æ˜¯ä¸ºç³»ç»Ÿæä¾›å¤šåª’ä½“åŠŸèƒ½çš„æœåŠ¡ï¼Œæ¯”å¦‚éŸ³é¢‘ã€è§†é¢‘ç­‰ã€‚</p>
<blockquote>
<p>å’Œå‰ä¸€ç¯‡æ–‡ç« ä¸€æ ·ï¼Œè¿™é‡Œä»ç„¶æ²¿ç”¨ SM æŒ‡ä»£ Service Managerã€‚</p>
</blockquote>
<a id="more"></a><strong>ã€æ¶‰åŠæ–‡ä»¶ã€‘</strong><br><br>| æ–‡ä»¶                      | ä½ç½®                                       |<br>| â€”â€”â€”â€”â€”â€”â€”â€“ | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- |<br>| main_mediaserver.cpp    | /frameworks/base/media/mediaserver/main_mediaserver.cpp |<br>| IServiceManager.h       | /frameworks/base/include/binder/IServiceManager.h |<br>| IServiceManager.cpp     | /frameworks/base/libs/binder/IServiceManager.cpp |<br>| IMediaPlayerService.cpp | /frameworks/base/media/libmedia/IMediaPlayerService.cpp |<br>| IPCThreadState.cpp      | /frameworks/base/libs/binder/IPCThreadState.cpp |<br>| ProcessState.cpp        | /frameworks/base/libs/binder/ProcessState.cpp |<br>| Binder.cpp              | /frameworks/base/libs/binder/Binder.cpp  |<br>| BpBinder.cpp            | /frameworks/base/libs/binder/BpBinder.cpp |<br>| Parcel.cpp              | /frameworks/base/libs/binder/Parcel.cpp  |<br>| IInterface.h            | /frameworks/base/include/binder/IInterface.h |<br>å…¶ä½™ä¸€äº›é›¶ç¢æ–‡ä»¶ã€å¤´æ–‡ä»¶ï¼Œè¿™é‡Œä¸ä¸€ä¸€åˆ—ä¸¾äº†ã€‚<br><br>## åˆè§ MS<br>MS çš„<code>main</code>å‡½æ•°ä½äº â€œmain_mediaserver.cppâ€ ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä»£ç å†…å®¹éå¸¸ç®€å•:<br><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    LOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">    AudioFlinger::instantiate();</span><br><span class="line">    MediaPlayerService::instantiate();</span><br><span class="line">    CameraService::instantiate();</span><br><span class="line">    AudioPolicyService::instantiate();</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°±åªæœ‰ä¸€ä¸ª<code>main</code>å‡½æ•°ã€‚è¯¥æ–¹æ³•ä¼šåˆå§‹åŒ–å¾ˆå¤šçš„å¤šåª’ä½“æœåŠ¡ï¼Œæˆ‘ä»¬é€‰æ‹©ä¸€ä¸ª â€”â€” <strong>MediaPlayerService</strong> åˆ†æå°±å¥½äº†ã€‚å› æ­¤ä»¥ä¸‹æ˜¯æˆ‘ä»¬æœ¬æ¬¡çš„ä»£ç åˆ†æè·¯å¾„:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/main_mediaserver_main.png" width="320" alt="MS mainå‡½æ•°è°ƒç”¨"></div>

<h2 id="æ‰“å¼€é©±åŠ¨-amp-å†…å­˜æ˜ å°„"><a href="#æ‰“å¼€é©±åŠ¨-amp-å†…å­˜æ˜ å°„" class="headerlink" title="æ‰“å¼€é©±åŠ¨ &amp; å†…å­˜æ˜ å°„"></a>æ‰“å¼€é©±åŠ¨ &amp; å†…å­˜æ˜ å°„</h2><p><code>main</code>å‡½æ•°çš„ç¬¬ä¸€è¡Œä»£ç æ ¸å¿ƒåœ¨äº<code>ProcessState::self()</code>è¿™ä¸€å¥:</p>
<blockquote>
<p><code>sp&lt;XXX&gt;</code> å¯ä»¥çœ‹æˆ <code>XXX *</code>ï¼Œå³æŒ‡é’ˆã€‚</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ProcessState&gt; ProcessState::self()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (gProcess != <span class="literal">NULL</span>) <span class="keyword">return</span> gProcess;</span><br><span class="line">    </span><br><span class="line">    AutoMutex _l(gProcessMutex);</span><br><span class="line">    <span class="keyword">if</span> (gProcess == <span class="literal">NULL</span>) gProcess = <span class="keyword">new</span> ProcessState;</span><br><span class="line">    <span class="keyword">return</span> gProcess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªå•ä¾‹æ–¹æ³•ï¼Œç¡®ä¿åªåˆ›å»ºä¸€ä¸ª ProcessState ï¼Œæˆ‘ä»¬çœ‹çœ‹ ProcessState çš„æ„é€ å‡½æ•°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ProcessState::ProcessState()</span><br><span class="line">    : mDriverFD(open_driver())</span><br><span class="line">    , mVMStart(MAP_FAILED)</span><br><span class="line">    , mManagesContexts(<span class="literal">false</span>)</span><br><span class="line">    , mBinderContextCheckFunc(<span class="literal">NULL</span>)</span><br><span class="line">    , mBinderContextUserData(<span class="literal">NULL</span>)</span><br><span class="line">    , mThreadPoolStarted(<span class="literal">false</span>)</span><br><span class="line">    , mThreadPoolSeq(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDriverFD &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// XXX Ideally, there should be a specific define for whether we</span></span><br><span class="line">        <span class="comment">// have mmap (or whether we could possibly have the kernel module</span></span><br><span class="line">        <span class="comment">// availabla).</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(HAVE_WIN32_IPC)</span></span><br><span class="line">        <span class="comment">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></span><br><span class="line">        mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (mVMStart == MAP_FAILED) &#123;</span><br><span class="line">            <span class="comment">// *sigh*</span></span><br><span class="line">            LOGE(<span class="string">"Using /dev/binder failed: unable to mmap transaction memory.\n"</span>);</span><br><span class="line">            close(mDriverFD);</span><br><span class="line">            mDriverFD = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        mDriverFD = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mDriverFD &lt; <span class="number">0</span>, <span class="string">"Binder driver could not be opened.  Terminating."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ å‡½æ•°å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯å…³é”®ç‚¹å¾ˆéšè”½ï¼š <strong><code>mDriverFD(open_driver())</code></strong> ï¼Œè¿™é‡Œå°†è°ƒç”¨å‡½æ•°<code>open_driver()</code>ï¼Œå¹¶å°†è¿”å›å€¼èµ‹å€¼ç»™<code>mDriverFD</code>ã€‚è‡ªç„¶è€Œç„¶æˆ‘ä»¬åˆè¦å»çœ‹çœ‹<code>open_driver()</code>å‡½æ•°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_driver</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/binder"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        fcntl(fd, F_SETFD, FD_CLOEXEC);</span><br><span class="line">        <span class="keyword">int</span> vers;</span><br><span class="line">        <span class="keyword">status_t</span> result = ioctl(fd, BINDER_VERSION, &amp;vers);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"Binder ioctl to obtain version failed: %s"</span>, strerror(errno));</span><br><span class="line">            close(fd);</span><br><span class="line">            fd = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span> || vers != BINDER_CURRENT_PROTOCOL_VERSION) &#123;</span><br><span class="line">            LOGE(<span class="string">"Binder driver protocol does not match user space protocol!"</span>);</span><br><span class="line">            close(fd);</span><br><span class="line">            fd = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">size_t</span> maxThreads = <span class="number">15</span>;</span><br><span class="line">        result = ioctl(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"Binder ioctl to set max threads failed: %s"</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOGW(<span class="string">"Opening '/dev/binder' failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçœ‹åˆ°äº†ç†Ÿæ‚‰çš„ä»£ç ï¼šå®ƒæ‰“å¼€äº† Binder é©±åŠ¨ã€‚å¦‚æœæ‰“å¼€æˆåŠŸï¼Œå®ƒä¼šå‘é©±åŠ¨å‘é€ä¸¤ä¸ªå‘½ä»¤ï¼Œä¸€ä¸ªæ˜¯<code>BINDER_VERSION</code>ï¼Œè¿™ä¸ªæ— å…³ç´§è¦ï¼Œç•¥è¿‡ï¼›ä¸€ä¸ªæ˜¯<code>BINDER_SET_MAX_THREADS</code>ï¼Œè¿™ä¸ªæœ€ç»ˆè¿˜æ˜¯ä¼šèµ°åˆ°<code>binder_ioctrl</code>ä¸­å»ï¼Œå¤šä½™ä»£ç å°±ä¸è´´äº†ï¼Œç›´æ¥çœ‹è¿™æ¡å‘½ä»¤çš„å¤„ç†case:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ubuf æŒ‡ä»£ä¼ é€’è¿›å…¥é©±åŠ¨çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">case</span> BINDER_SET_MAX_THREADS:</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(&amp;proc-&gt;max_threads, ubuf, <span class="keyword">sizeof</span>(proc-&gt;max_threads))) &#123;</span><br><span class="line">			ret = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¤„ç†å¾ˆç®€å•ï¼ŒprocæŒ‡å‘çš„æ˜¯<code>binder_proc</code>å®ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª max_threads å­—æ®µï¼Œè¿™é‡Œå°±æ˜¯å°†ä¼ é€’è¿›æ¥çš„å€¼èµ‹å€¼åˆ°è¿™ä¸ªå­—æ®µä¸Šï¼Œè‡³äºå­—æ®µå…·ä½“ä»€ä¹ˆä½œç”¨ï¼Œåé¢ä¼šè®²åˆ°ã€‚</p>
<p>å›åˆ°å‰é¢ï¼ŒProcessState å®ä¾‹åœ¨æ–°å»ºçš„æ—¶å€™å°±æ‰“å¼€äº† Binder é©±åŠ¨ï¼Œæ¥ä¸‹å»æœ‰ä¸€å¥å¾ˆé‡è¦çš„ä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></span><br><span class="line">mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p><code>mmap</code>è¿™ä¸ªå‡½æ•°ä¸æ˜¯ç¬¬ä¸€æ¬¡è§ï¼Œçœ‹æ³¨é‡Šå°±æ˜ç™½è¿™é‡Œæ˜¯åœ¨åšä»€ä¹ˆï¼šè¿™é‡Œå’Œ SM ä¸€æ ·ï¼Œä¹Ÿå» binder é©±åŠ¨ä¸­æŒ–ä¸€å—å†…å­˜ï¼Œä¾¿äº Service å’Œé©±åŠ¨è¿›è¡Œé€šä¿¡ã€‚æŒ‰æ³¨é‡Šçš„è¯´æ³•ï¼Œå°±æ˜¯ â€œreceive transactionsâ€ã€‚</p>
<p>å†å›åˆ° MS çš„<code>main</code>å‡½æ•°ï¼Œæ‰§è¡Œå®Œç¬¬ä¸€å¥ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª ProcessState å®ä¾‹ï¼Œåœ¨è¿™ä¸ªå®ä¾‹é‡Œé¢æ‰“å¼€äº† Binder é©±åŠ¨å¹¶åšäº†å†…å­˜æ˜ å°„ï¼Œæ˜ å°„èµ·å§‹åœ°å€è®°å½•åœ¨ mVMStart å˜é‡ä¸­ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸Šé¢åˆ†æçš„å‡½æ•°è°ƒç”¨çš„å…³ç³»å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/ProcessStateå®ä¾‹åŒ–.png" alt="ProcessStateå®ä¾‹åŒ–"></div>

<h2 id="è·å–-SM-å®ä¾‹"><a href="#è·å–-SM-å®ä¾‹" class="headerlink" title="è·å– SM å®ä¾‹"></a>è·å– SM å®ä¾‹</h2><p>ç¬¬äºŒè¡Œä»£ç æ˜¯:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br></pre></td></tr></table></figure>
<p>çœ‹å‡½æ•°åå­—ä»¥åŠè¿”å›çš„å˜é‡æŒ‡é’ˆï¼Œå°±çŸ¥é“è¿™å’Œ SM ç›¸å…³ â€”â€” è¿™é‡Œå®é™…ä¸Šå°±æ˜¯åœ¨è·å– SM å®ä¾‹ã€‚è¿™ä¸ªæ–¹æ³•æ¥è‡ªå“ªé‡Œå‘¢ï¼Ÿâ€IServiceManager.cppâ€:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IServiceManager&gt; defaultServiceManager()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (gDefaultServiceManager != <span class="literal">NULL</span>) <span class="keyword">return</span> gDefaultServiceManager;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        AutoMutex _l(gDefaultServiceManagerLock);</span><br><span class="line">        <span class="keyword">if</span> (gDefaultServiceManager == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            gDefaultServiceManager = interface_cast&lt;IServiceManager&gt;(</span><br><span class="line">                ProcessState::self()-&gt;getContextObject(<span class="literal">NULL</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> gDefaultServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆæ˜¯ä¸€ä¸ªå•ä¾‹æ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯<code>interface_cast&lt;IServiceManager&gt;(ProcessState::self()-&gt;getContextObject(NULL));</code>æ¥å®ä¾‹åŒ–è¿”å›å¯¹è±¡çš„ï¼Œè¿™ä¸ªæ–¹æ³•åŒ…å«å¾ˆå¤šå†…å®¹ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥çœ‹ã€‚</p>
<h3 id="ProcessState-self-gt-getContextObject-NULL"><a href="#ProcessState-self-gt-getContextObject-NULL" class="headerlink" title="ProcessState::self()-&gt;getContextObject(NULL)"></a><code>ProcessState::self()-&gt;getContextObject(NULL)</code></h3><p>é¦–å…ˆæ˜¯<code>ProcessState::self()-&gt;getContextObject(NULL)</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; ProcessState::getContextObject(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; caller)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> getStrongProxyForHandle(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(<span class="keyword">int32_t</span> handle)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IBinder&gt; result;</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// handle ä¸º0</span></span><br><span class="line">    handle_entry* e = lookupHandleLocked(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// We need to create a new BpBinder if there isn't currently one, OR we</span></span><br><span class="line">        <span class="comment">// are unable to acquire a weak reference on this current one.  See comment</span></span><br><span class="line">        <span class="comment">// in getWeakProxyForHandle() for more info about this.</span></span><br><span class="line">        IBinder* b = e-&gt;binder;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span> || !e-&gt;refs-&gt;attemptIncWeak(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            b = <span class="keyword">new</span> BpBinder(handle); </span><br><span class="line">            e-&gt;binder = b;</span><br><span class="line">            <span class="keyword">if</span> (b) e-&gt;refs = b-&gt;getWeakRefs();</span><br><span class="line">            result = b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This little bit of nastyness is to allow us to add a primary</span></span><br><span class="line">            <span class="comment">// reference to the remote proxy when this team doesn't have one</span></span><br><span class="line">            <span class="comment">// but another team is sending the handle to us.</span></span><br><span class="line">            result.force_set(b);</span><br><span class="line">            e-&gt;refs-&gt;decWeak(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šè°ƒç”¨çš„æ˜¯<code>getStrongProxyForHandle</code>è·å–çš„è¿”å›å€¼ï¼Œä¼ å…¥å‚æ•°0ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆåœ¨å¹²å•¥å‘¢ï¼Ÿæˆ‘æŠŠä»£ç è´´åœ¨ä¸€å—äº†ï¼Œå¾ˆæ˜æ˜¾å®ƒåˆè°ƒç”¨äº†å¦å¤–ä¸€ä¸ªæ–¹æ³•<code>lookupHandleLocked</code>ï¼Œç»§ç»­ä¼ é€’å‚æ•°0:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç ï¼šlookupHandleLocked(0);</span></span><br><span class="line">ProcessState::handle_entry* ProcessState::lookupHandleLocked(<span class="keyword">int32_t</span> handle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> N = mHandleToObject.size();</span><br><span class="line">    <span class="keyword">if</span> (N &lt;= (<span class="keyword">size_t</span>)handle) &#123;</span><br><span class="line">        handle_entry e;</span><br><span class="line">        e.binder = <span class="literal">NULL</span>;</span><br><span class="line">        e.refs = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">status_t</span> err = mHandleToObject.insertAt(e, N, handle+<span class="number">1</span>-N);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; NO_ERROR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;mHandleToObject.editItemAt(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mHandleToObject</code>æ˜¯ä¸€ä¸ª Vectorï¼Œå®ƒçš„å…ƒç´ æ˜¯ç»“æ„ä½“ handle_entryï¼Œå£°æ˜å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">handle_entry</span> &#123;</span></span><br><span class="line">	IBinder* binder;</span><br><span class="line">	RefBase::weakref_type* refs;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Vector&lt;handle_entry&gt; mHandleToObject;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºè¿›ç¨‹åˆšå¯åŠ¨ï¼Œå› æ­¤<code>mHandleToObject</code>æ˜¯ç©ºçš„ï¼Œå› æ­¤<code>N &lt;= (size_t)handle</code>åˆ¤æ–­æˆç«‹ï¼Œè¿™æ ·å°±ä¼šæ–°å»ºä¸€ä¸ª handle_entry ç»“æ„ä½“å®ä¾‹ï¼Œå®ƒçš„ binder å­—æ®µæ˜¯ NULL ã€‚</p>
<p>æ–°å»ºå®Œæˆåç»§ç»­å›åˆ°<code>getStrongProxyForHandle</code>æ–¹æ³•ï¼Œå®ƒä¼šå–å‡º binder å­—æ®µï¼Œå¹¶ä½œå¦‚ä¸‹åˆ¤æ–­:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (b == <span class="literal">NULL</span> || !e-&gt;refs-&gt;attemptIncWeak(<span class="keyword">this</span>))</span><br></pre></td></tr></table></figure>
<p>binder å­—æ®µä¸º NULLï¼Œå› æ­¤æœ€ç»ˆä¼šèµ°åˆ°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b = <span class="keyword">new</span> BpBinder(handle); </span><br><span class="line">e-&gt;binder = b;</span><br><span class="line"><span class="keyword">if</span> (b) e-&gt;refs = b-&gt;getWeakRefs();</span><br><span class="line">result = b;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šä»¥ handle ä¸ºå‚æ•°æ–°å»ºä¸€ä¸ª BpBinder å¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™ e çš„ binder å­—æ®µï¼Œæœ€åè¿™ä¸ª b å°±è¢«èµ‹å€¼ç»™ result å¹¶ä½œä¸ºæ–¹æ³•è¿”å›å€¼ï¼Œæœ€ç»ˆè¿”å›åˆ°äº†<code>defaultServiceManager</code>æ–¹æ³•ä¸­ã€‚</p>
<blockquote>
<p>BpBinder åé¢å†åšä»‹ç»ï¼Œæˆ‘ä»¬å…ˆæŠŠ SM çš„å®ä¾‹è·å–è®²å®Œã€‚</p>
</blockquote>
<p>å› æ­¤ä¸‹é¢è¿™å¥ä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">interface_cast&lt;IServiceManager&gt;(ProcessState::self()-&gt;getContextObject(<span class="literal">NULL</span>))</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šç­‰äº:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">interface_cast&lt;IServiceManager&gt;(<span class="keyword">new</span> BpBinder(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<h3 id="interface-cast"><a href="#interface-cast" class="headerlink" title="interface_cast"></a><code>interface_cast</code></h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å•ƒ<code>interface_cast</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªå†…è”çš„æ¨¡æ¿å‡½æ•°ï¼Œå®šä¹‰åœ¨ â€œIInterface.hâ€ä¸­: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="keyword">inline</span> sp&lt;INTERFACE&gt; interface_cast(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> INTERFACE::asInterface(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å‰é¢é‚£è¡Œä»£ç åˆç­‰ä»·äº:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IServiceManager::asInterface(<span class="keyword">new</span> BpBinder(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><code>asInterface</code>è¿™ä¸ªæ–¹æ³•å®é™…åˆä¸æ˜¯æ¥è‡ª<code>IServiceManager</code>ï¼Œè€Œæ˜¯æ¥è‡ª<code>IInterface</code>ï¼ˆ<code>IServiceManager</code>ç»§æ‰¿äº<code>IInterface</code>ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆå›åˆ°äº† â€œIInterface.hâ€ è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢åˆå‘ç°è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯å®šä¹‰åœ¨ä¸¤ä¸ªå®é‡Œé¢çš„:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_META_INTERFACE(INTERFACE)                               \</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> android::String16 descriptor;                          \</span><br><span class="line">    <span class="keyword">static</span> android::sp&lt;I##INTERFACE&gt; asInterface(                       \</span><br><span class="line">            <span class="keyword">const</span> android::sp&lt;android::IBinder&gt;&amp; obj);                  \</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> android::<span class="function">String16&amp; <span class="title">getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span></span>;    \</span><br><span class="line">    I##INTERFACE();                                                     \</span><br><span class="line">    <span class="keyword">virtual</span> ~I##INTERFACE();                                            \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                       \</span></span><br><span class="line">    <span class="keyword">const</span> android::String16 I##INTERFACE::descriptor(NAME);             \</span><br><span class="line">    <span class="keyword">const</span> android::String16&amp;                                            \</span><br><span class="line">            I##INTERFACE::getInterfaceDescriptor() <span class="keyword">const</span> &#123;              \</span><br><span class="line">        <span class="keyword">return</span> I##INTERFACE::descriptor;                                \</span><br><span class="line">    &#125;                                                                   \</span><br><span class="line">    android::sp&lt;I##INTERFACE&gt; I##INTERFACE::asInterface(                \</span><br><span class="line">            <span class="keyword">const</span> android::sp&lt;android::IBinder&gt;&amp; obj)                   \</span><br><span class="line">    &#123;                                                                   \</span><br><span class="line">        android::sp&lt;I##INTERFACE&gt; intr;                                 \</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;                                              \</span><br><span class="line">            intr = <span class="keyword">static_cast</span>&lt;I##INTERFACE*&gt;(                          \</span><br><span class="line">                obj-&gt;queryLocalInterface(                               \</span><br><span class="line">                        I##INTERFACE::descriptor).get());               \</span><br><span class="line">            <span class="keyword">if</span> (intr == <span class="literal">NULL</span>) &#123;                                         \</span><br><span class="line">                intr = <span class="keyword">new</span> Bp##INTERFACE(obj);                          \</span><br><span class="line">            &#125;                                                           \</span><br><span class="line">        &#125;                                                               \</span><br><span class="line">        <span class="keyword">return</span> intr;                                                    \</span><br><span class="line">    &#125;                                                                   \</span><br><span class="line">    I##INTERFACE::I##INTERFACE() &#123; &#125;                                    \</span><br><span class="line">    I##INTERFACE::~I##INTERFACE() &#123; &#125;                                   \</span><br></pre></td></tr></table></figure>
<p>æ©â€¦ä¸å‡ºæ„å¤–ï¼Œå­ç±»ä¸­åº”è¯¥æœ‰ç›¸å…³ä½¿ç”¨å£°æ˜ã€‚æˆ‘ä»¬å›åˆ° â€œIServiceManager.hâ€ æ–‡ä»¶ä¸­ï¼Œæœç„¶å‘ç°æœ‰è¿™ä¹ˆä¸€è¡Œä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_META_INTERFACE(ServiceManager);</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨ â€œIServiceManager.cppâ€ ä¸­ï¼Œåˆæœ‰è¿™ä¹ˆä¸€æ¡:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMPLEMENT_META_INTERFACE(ServiceManager, <span class="string">"android.os.IServiceManager"</span>);</span><br></pre></td></tr></table></figure>
<p>çœ‹æ ·å­ææ‡‚è¿™ä¸ªå®ï¼Œå°±çŸ¥é“<code>interface_cast</code>åˆ°åº•åœ¨å¹²ä»€ä¹ˆäº†ã€‚å…ˆæ¥çœ‹çœ‹æ·»åŠ è¿™æ¡è¯­å¥åå€’åœ°å¢åŠ äº†ä»€ä¹ˆæ ·çš„æ–¹æ³•:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> android::String16 IServiceManager::descriptor(NAME);</span><br><span class="line"><span class="keyword">const</span> android::String16&amp; IServiceManager::getInterfaceDescriptor() <span class="keyword">const</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> IServiceManager::descriptor;</span><br><span class="line">&#125; </span><br><span class="line">android::sp&lt;IServiceManager&gt; IServiceManager::asInterface(<span class="keyword">const</span> android::sp&lt;android::IBinder&gt;&amp; obj) &#123;</span><br><span class="line">	android::sp&lt;IServiceManager&gt; intr;</span><br><span class="line">	<span class="comment">//è¿˜è®°å¾—objæ˜¯å•¥ä¹ˆï¼Ÿnew BpBinder(0)ï¼Œæ‰€ä»¥è‚¯å®šä¸ä¸ºnull</span></span><br><span class="line">	<span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		intr = <span class="keyword">static_cast</span>&lt;IServiceManager*&gt;(obj-&gt;queryLocalInterface(IServiceManager::descriptor).get());</span><br><span class="line">		<span class="keyword">if</span> (intr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			intr = <span class="keyword">new</span> BpServiceManager(obj);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> intr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IServiceManager:: IServiceManager() &#123; &#125;</span><br><span class="line">IServiceManager::~ IServiceManager() &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>å“ˆï¼Œçœ‹åˆ°äº†æˆ‘ä»¬æœ€æƒ³çœ‹åˆ°çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>asInterface</code>ï¼Œè¿™åˆæ˜¯åœ¨å¹²å•¥å‘¢ï¼Ÿè¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ª <code>queryLocalInterface</code> æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹ BpBinder ä¸­çš„å®ç°ï¼Œåœ¨æ–‡ä»¶ â€œBinder.cppâ€ ä¸­å¯ä»¥æ‰¾åˆ°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IInterface&gt;  IBinder::queryLocalInterface(<span class="keyword">const</span> String16&amp; descriptor)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤è¿™é‡Œå°±ä¼šæ‰§è¡Œ<code>new BpServiceManager(obj)</code>å¹¶è¿”å›å¯¹è±¡ï¼Œå› æ­¤ä¸‹é¢è¿™å¥ä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">interface_cast&lt;IServiceManager&gt;(<span class="keyword">new</span> BpBinder(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå°±ç­‰äº:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> BpServiceManager(<span class="keyword">new</span> BpBinder(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™æ ·ä¸€ä¸ªè¯­å¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾—ä¸€ä¸ª SM å®ä¾‹ã€‚å®é™…ä¸Šåˆ°è¿™é‡Œæˆ‘ä»¬åªçŸ¥é“ <code>defaultServiceManager()</code> æ–¹æ³•è¿”å›äº†ä¸€ä¸ª<code>IServiceManager</code>çš„å¯¹è±¡ï¼Œå®é™…æŒ‡å‘çš„æ˜¯ BpServiceManager å®ä¾‹ï¼Œå…·ä½“è¿™ä¸ªå¯¹è±¡å’Œ SM ä»€ä¹ˆå…³ç³»ã€å¦‚ä½•å¸®åŠ©æˆ‘ä»¬å®ŒæˆæœåŠ¡æ³¨å†Œæˆ‘ä»¬å¹¶ä¸æ¸…æ¥šã€‚ä¸è¦æ‰æ€¥ï¼Œä¸‹é¢ä¸€èŠ‚è®²å®Œå°±æ¸…æ¥šäº†ã€‚</p>
<p>å¥½äº†ï¼Œå–˜å£æ°”ï¼Œä¸‹é¢æ˜¯è°ƒç”¨å…³ç³»å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/defaultServiceManager.png" alt="defaultServiceManagerè°ƒç”¨"></div>

<p>çœ‹ä¸Šå»æœ‰ç‚¹å¤æ‚ï¼Œä½†æ˜¯æ›´å¤æ‚çš„è¿˜åœ¨åé¢ã€‚</p>
<h2 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><p>è¿™é‡Œå†è´´ä¸€ä¸‹<code>main</code>å‡½æ•°çš„ä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	 <span class="comment">// å®ä¾‹åŒ– Process</span></span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å– SM</span></span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    LOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æœåŠ¡</span></span><br><span class="line">    AudioFlinger::instantiate();</span><br><span class="line">    MediaPlayerService::instantiate();</span><br><span class="line">    CameraService::instantiate();</span><br><span class="line">    AudioPolicyService::instantiate();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¾ˆé‡è¦çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåé¢åˆ†æ</span></span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»<code>main</code>å‡½æ•°çœ‹ï¼Œåˆ°è¿™é‡Œä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>åˆå§‹åŒ– ProcessState å˜é‡ï¼Œåˆå§‹åŒ–è¿‡ç¨‹ä¸»è¦æ˜¯æ‰“å¼€ binder é©±åŠ¨ï¼Œè¿›è¡Œå†…å­˜æ˜ å°„ï¼›</li>
<li>è·å– defaultServiceManagerï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ª BpServiceManager å¯¹è±¡ï¼›</li>
</ol>
<p>å¦‚æ³¨é‡Šæ‰€å†™ï¼Œæ¥ä¸‹å»å°±æ˜¯è¦åˆå§‹åŒ–æœåŠ¡äº†ã€‚è¿™ä¸‹é¢æœ‰å¾ˆå¤šçš„æœåŠ¡è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬éŸ³é¢‘ï¼Œè§†é¢‘ï¼Œç…§ç›¸æœºç­‰ï¼Œæˆ‘ä»¬æ‰¾<code>MediaPlayerService</code>ä¸ºä¾‹è¿›è¡Œç ”ç©¶ã€‚å› ä¸ºè¿™éƒ¨åˆ†åˆ†ææ¶‰åŠåˆ°çš„å‡½æ•°å¾ˆå¤šï¼Œè°ƒç”¨é“¾è¾ƒé•¿ï¼Œå› æ­¤è¿™é‡Œå…ˆè´´ä¸€ä¸‹ä¸»è¦å‡½æ•°è°ƒç”¨å…³ç³»å›¾ï¼ˆçœ‹ä¸æ¸…å¯ä»¥å³å‡»æŸ¥çœ‹å¤§å›¾ï¼‰ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/æœåŠ¡æ³¨å†Œå‡½æ•°è°ƒç”¨é“¾.png" alt="æœåŠ¡æ³¨å†Œå‡½æ•°è°ƒç”¨é“¾"></div>

<p>é¦–å…ˆæ¥çœ‹ MediaPlayerService çš„<code>instantiate()</code>æ–¹æ³•äº†:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MediaPlayerService::instantiate() &#123;</span><br><span class="line">    defaultServiceManager()-&gt;addService(</span><br><span class="line">            String16(<span class="string">"media.player"</span>), <span class="keyword">new</span> MediaPlayerService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ–¹æ³•<code>defaultServiceManager()</code>æ˜¯ä¸€ä¸ªå•ä¾‹æ–¹æ³•ï¼Œå› æ­¤è¿™é‡Œè·å–åˆ°çš„å…¶å®è¿˜æ˜¯å‰é¢æ–°å»ºçš„é‚£ä¸ªå®ä¾‹ã€‚æ¥ç€è°ƒç”¨çš„å°±æ˜¯å®ƒçš„<code>addService</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ç»ˆäºèµ°åˆ°äº† <strong>æœåŠ¡æ³¨å†Œ</strong> çš„åœ°æ–¹ï¼</p>
<p>æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼ˆä½äº â€œIServiceManager.cppâ€ ä¸­ï¼‰:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">addService</span><span class="params">(<span class="keyword">const</span> String16&amp; name, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; service)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Parcel data, reply;</span><br><span class="line">	data.writeInterfaceToken(IServiceManager::getInterfaceDescriptor());</span><br><span class="line">	data.writeString16(name);</span><br><span class="line">	data.writeStrongBinder(service);</span><br><span class="line">	<span class="keyword">status_t</span> err = remote()-&gt;transact(ADD_SERVICE_TRANSACTION, data, &amp;reply);</span><br><span class="line">	<span class="keyword">return</span> err == NO_ERROR ? reply.readExceptionCode() : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå‡ºäº†ä¸€ä¸ªå’Œ Android Java å±‚å¾ˆç›¸ä¼¼çš„æ¦‚å¿µ: Parcelï¼Œç”¨äºåºåˆ—åŒ–å¯¹è±¡ã€‚ä»ä»£ç çœ‹ï¼Œå®ƒå…ˆåºåˆ—åŒ–ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå†åºåˆ—åŒ– service ï¼Œæœ€åé€šè¿‡<code>remote()-&gt;transact()</code>å‘é€åˆ°æŸä¸ªåœ°æ–¹å»äº†ã€‚è®©æˆ‘ä»¬å¸å£æ°”ï¼Œä¸€æ­¥æ­¥æ½œä¸‹å»ç§ç§ã€‚</p>
<h3 id="Parcel-åºåˆ—åŒ–"><a href="#Parcel-åºåˆ—åŒ–" class="headerlink" title="Parcel åºåˆ—åŒ–"></a>Parcel åºåˆ—åŒ–</h3><p>è¿™é‡Œä½¿ç”¨ Parcel å¯¹è±¡å°†æ•°æ®å…¨éƒ¨æ‰“åŒ…ï¼Œç›¸å…³æ–¹æ³•éƒ½é›†ä¸­åœ¨<code>Parcel.cpp</code>ã€‚å‰é¢å†™å…¥äº†ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œç¬¬ä¸€ä¸ªæ˜¯ RPC å¤´éƒ¨ï¼Œä¸éœ€è¦å¤šå…³æ³¨ï¼Œå®é™…å†™å…¥å€¼æ˜¯ â€œandroid.os.IServiceManagerâ€ ï¼ˆè¿™ä¸ªæ–¹æ³•å»ºè®®è¯»è€…è‡ªè¡ŒæŸ¥çœ‹ï¼Œå…¶å®å‰é¢è¿˜å†™å…¥äº†ä¸€äº›ä¿¡æ¯ï¼Œä¼šåœ¨ä¸‹é¢æŒ‡å‡ºï¼‰ï¼Œç›¸å…³ä»£ç ç›´æ¥çœ‹ <code>IServiceManager::getInterfaceDescriptor()</code>å³å¯ï¼›æ¥ç€å†™å…¥å‚æ•° name çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä¼ å…¥çš„ â€œmedia.playerâ€ï¼›æœ€åå†™å…¥äº† Serviceï¼Œè¿™é‡Œæœ‰å¿…è¦å¥½å¥½çœ‹çœ‹æ–¹æ³•<code>writeStrongBinder</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Parcel::writeStrongBinder(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; val)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> flatten_binder(ProcessState::self(), val, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> flatten_binder(<span class="keyword">const</span> sp&lt;ProcessState&gt;&amp; proc,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; binder, Parcel* out)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    flat_binder_object obj;</span><br><span class="line">    </span><br><span class="line">    obj.flags = <span class="number">0x7f</span> | FLAT_BINDER_FLAG_ACCEPTS_FDS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¼ å…¥çš„æ˜¯new MediaPlayerService()ï¼Œå› æ­¤ä¸ä¸ºNULL</span></span><br><span class="line">    <span class="keyword">if</span> (binder != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    	  <span class="comment">// ä»€ä¹ˆé¬¼ï¼Ÿ</span></span><br><span class="line">        IBinder *local = binder-&gt;localBinder();</span><br><span class="line">        <span class="keyword">if</span> (!local) &#123;</span><br><span class="line">            BpBinder *proxy = binder-&gt;remoteBinder();</span><br><span class="line">            <span class="keyword">if</span> (proxy == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                LOGE(<span class="string">"null proxy"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int32_t</span> handle = proxy ? proxy-&gt;handle() : <span class="number">0</span>;</span><br><span class="line">            obj.type = BINDER_TYPE_HANDLE;</span><br><span class="line">            obj.handle = handle;</span><br><span class="line">            obj.cookie = <span class="literal">NULL</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            obj.type = BINDER_TYPE_BINDER;</span><br><span class="line">            obj.binder = local-&gt;getWeakRefs();</span><br><span class="line">            obj.cookie = local;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        obj.type = BINDER_TYPE_BINDER;</span><br><span class="line">        obj.binder = <span class="literal">NULL</span>;</span><br><span class="line">        obj.cookie = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> finish_flatten_binder(binder, obj, out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒå®é™…è°ƒç”¨çš„æ˜¯<code>flatten_binder</code>æ–¹æ³•ï¼Œçœ‹åå­—æ„æ€æ˜¯æŠŠä¸€ä¸ª binder å¯¹è±¡æ‰å¹³åŒ–ï¼Œçœ‹ä¸Šå»å¾ˆæœ‰åºåˆ—åŒ–çš„å‘³é“ï¼ˆæƒ³è±¡æŠŠä¸€ä¸ªå¯¹è±¡è½¬æˆ JSONï¼‰ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œè¿™ä¸ª binder å¯¹è±¡å°±æ˜¯æˆ‘ä»¬çš„<code>new MediaPlayerService()</code>ã€‚</p>
<p>åé¢è¿˜è°ƒç”¨äº†å¾ˆå¤š binder çš„æ–¹æ³•ï¼Œæ¯”å¦‚<code>localBinder()</code>ï¼Œ<code>remoteBinder()</code>ï¼Œå¼€å§‹å¤§é¢ç§¯å‡ºç° IBinderï¼ŒBpBinder ç­‰æ¦‚å¿µï¼Œè¿™é‡Œå¿…é¡»è¦åˆ†æä¸€ä¸‹ä¸€äº›ç±»ä¹‹é—´çš„å…³ç³»ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†æ–¹ä¾¿åé¢åˆ†æã€‚</p>
<p>Binder æœºåˆ¶åœ¨ Libraries å±‚é¢å»ºç«‹äº†ä¸€ç»„å¯¹è±¡ï¼Œå®ƒä»¬ååŒèµ·æ¥ä¸é©±åŠ¨äº¤äº’ï¼Œå®Œæˆ IPC åŠŸèƒ½ã€‚è¿™é‡Œå°±ä¸ä¸€æ­¥æ­¥çœ‹ä»£ç äº†ï¼Œç›´æ¥ä¸Šå…³ç³»å›¾:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Binder-Libå±‚æ¶æ„.png" alt="Binder Libå±‚æ¶æ„"></div>

<p>è¿™é‡Œç›´æ¥ç”»ä¸Šäº†<code>MediaPlayerService</code>æœåŠ¡å¹¶æ ‡æ³¨äº†ä¸€äº›é‡è¦çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¥½äº†ï¼Œçœ‹ç€å›¾æˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ã€‚</p>
<blockquote>
<p>PS: å‡¡æ˜¯å‡ºç°äº† MediaPlayerService çš„åœ°æ–¹ï¼Œå®é™…éƒ½å¯ä»¥ç”±åˆ«çš„ Service æ›¿æ¢ã€‚</p>
</blockquote>
<p>é¦–å…ˆæˆ‘ä»¬è¦çœ‹çš„æ˜¯<code>binder-&gt;localBinder();</code>ï¼Œè¿™ä¸ªæ–¹æ³•æœ€å…ˆå£°æ˜æ˜¯åœ¨ IBinder ä¸­ï¼Œæˆ‘æœç´¢ä»£ç åªèƒ½çœ‹åˆ°å…³äºè¯¥æ–¹æ³•å¦‚ä¸‹çš„å®ç°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BBinder* IBinder::localBinder()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BpBinder* IBinder::remoteBinder()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´è¿”å›ä¸º NULL ï¼Œä» MediaPlayerService åˆ° IBinder çš„ç»§æ‰¿æ ‘ä¸­å†ä¹Ÿæ²¡æœ‰åˆ«çš„å®ç°ï¼Œä½†æ˜¯è¿™ä¸ªä¸ç¬¦åˆå¸¸ç†ï¼šå› ä¸ºè¿™é‡Œç ”ç©¶çš„æ˜¯å¦‚ä½•æ³¨å†Œä¸€ä¸ª Serviceï¼Œä¸” MediaPlayerService ç¡®å®åˆæ˜¯æœ¬åœ°çš„ï¼ŒæŒ‰ç…§é“ç†<code>localBinder()</code>åº”è¯¥æœ‰è¿”å›ï¼Œç¿»çœ‹å‡ ç¯‡æ–‡ç« ï¼Œä¹Ÿæ²¡æœ‰å…³äº<code>localBinder()</code>æ–¹æ³•çš„å…¶ä½™å®ç°ä»£ç çš„å±•ç¤ºï¼Œè¿™é‡Œç•™ä½œä¸€ä¸ª<strong>ã€ç–‘ç‚¹ã€‘</strong>ã€‚</p>
<blockquote>
<p>æ‰¾çš„çœ¼ç›éƒ½å¿«çäº†ï¼</p>
</blockquote>
<p>é‚£ä¹ˆæŒ‰ç…§å¸¸ç†å®é™…ä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç æ‰å¯¹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj.type = BINDER_TYPE_BINDER;</span><br><span class="line">obj.binder = local-&gt;getWeakRefs();</span><br><span class="line">obj.cookie = local;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šäº§ç”Ÿä¸€ä¸ªtypeä¸º<code>BINDER_TYPE_BINDER</code>çš„<code>flat_binder_object</code>ç»“æ„ä½“å¯¹è±¡ï¼Œbinder å­—æ®µè®°å½•çš„æ˜¯æœ¬åœ° binder çš„å¼±å¼•ç”¨å¯¹è±¡ï¼Œ<strong>cookie ä¸­è®°å½•çš„åˆ™æ˜¯æœ¬åœ°æœåŠ¡å®ä½“çš„åœ°å€</strong>ã€‚æ¥ç€å°±è°ƒç”¨<code>finish_flatten_binder()</code>æ–¹æ³•:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> status_t <span class="title">finish_flatten_binder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; binder, <span class="keyword">const</span> flat_binder_object&amp; flat, Parcel* out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> out-&gt;writeObject(flat, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±åªæ˜¯å†™å…¥å¯¹è±¡äº†ï¼šåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬æŠŠ Service çš„åå­—å’Œ Service æœ¬èº«å†™å…¥åˆ°ä¸€ä¸ªParcelå¯¹è±¡ä¸­å»ã€‚ç°åœ¨ out é‡Œé¢çš„æ•°æ®åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/serviceæ³¨å†Œtransactæ•°æ®.png" width="600" alt="serviceæ³¨å†Œtransactæ•°æ®"></div>

<blockquote>
<p>data ä¸­è¿˜æœ‰ä¸€äº›å…ƒæ•°æ®ï¼Œæ¯”å¦‚å†™å…¥å­—ç¬¦ä¸²ä¹‹å‰ä¼šå†™å…¥å­—ç¬¦ä¸²é•¿åº¦ï¼Œå›¾ä¸­æ²¡æœ‰æ ‡æ³¨å‡ºæ¥ã€‚</p>
</blockquote>
<p>è¿™å¼ å›¾éå¸¸é‡è¦ï¼Œåé¢ç›´åˆ°æœåŠ¡æ³¨å†ŒæˆåŠŸï¼Œè¿™éƒ¨åˆ†æ•°æ®æ ¼å¼ã€å†…å®¹éƒ½ä¸ä¼šå˜åŒ–ï¼Œå› æ­¤åœ¨ SM ä¸­æ³¨å†Œæ—¶å€™ï¼Œæœ€åè§£æçš„æ ¼å¼è¿˜æ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œã€‚<strong>ä»¥ä¸‹ç§°è¿™å¹…å›¾ä¸º â€œæœåŠ¡æ³¨å†Œåˆå§‹æ•°æ®å›¾â€</strong> ã€‚</p>
<h3 id="ä¼ è¾“æ•°æ®"><a href="#ä¼ è¾“æ•°æ®" class="headerlink" title="ä¼ è¾“æ•°æ®"></a>ä¼ è¾“æ•°æ®</h3><p>åœ¨å‡†å¤‡å¥½æ•°æ®ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data å¤§è‡´å°±æ˜¯ä¸Šå›¾çš„æ ·å­ï¼Œreply ä¸ä¸ºç©º</span></span><br><span class="line"><span class="keyword">status_t</span> err = remote()-&gt;transact(ADD_SERVICE_TRANSACTION, data, &amp;reply);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¡¾åæ€ä¹‰æ˜¯åœ¨ä¼ è¾“æ•°æ®ã€‚<code>remote()</code>æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¦çŸ¥é“<code>addService()</code>è¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯æ¥è‡ªç±»<code>BpServiceManager</code>çš„ï¼Œå®ƒå’Œä¸Šé¢ç±»å›¾ä¸­çš„<code>BpMediaPlayerService</code>ä½ç½®ç±»ä¼¼ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•å®é™…æ¥è‡ªäº<code>BpRefBase</code>ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªç±»çš„ä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#############  BpServiceManager  ###############</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpServiceManager</span> :</span> <span class="keyword">public</span> BpInterface&lt;IServiceManager&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    BpServiceManager(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; impl)</span><br><span class="line">        : BpInterface&lt;IServiceManager&gt;(impl)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#############  BpInterface  ###############</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpInterface</span> :</span> <span class="keyword">public</span> INTERFACE, <span class="keyword">public</span> BpRefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">                                BpInterface(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; remote);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IBinder*            <span class="title">onAsBinder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#############  BpRefBase  ###############</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpRefBase</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">                            BpRefBase(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; o);</span><br><span class="line">    <span class="keyword">virtual</span>                 ~BpRefBase();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span>            <span class="title">onFirstRef</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span>            <span class="title">onLastStrongRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>            <span class="title">onIncStrongAttempted</span><span class="params">(<span class="keyword">uint32_t</span> flags, <span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  IBinder*        <span class="title">remote</span><span class="params">()</span>                </span>&#123; <span class="keyword">return</span> mRemote; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  IBinder*        <span class="title">remote</span><span class="params">()</span> <span class="keyword">const</span>          </span>&#123; <span class="keyword">return</span> mRemote; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">                            BpRefBase(<span class="keyword">const</span> BpRefBase&amp; o);</span><br><span class="line">    BpRefBase&amp;              <span class="keyword">operator</span>=(<span class="keyword">const</span> BpRefBase&amp; o);</span><br><span class="line"></span><br><span class="line">    IBinder* <span class="keyword">const</span>          mRemote;</span><br><span class="line">    RefBase::weakref_type*  mRefs;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int32_t</span>        mState;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>BpRefBase çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get() æ–¹æ³•åº”è¯¥æ˜¯ sp æŒæœ‰çš„ï¼Œå¯ä»¥ç±»æ¯” Java çš„å¼±å¼•ç”¨</span></span><br><span class="line">BpRefBase::BpRefBase(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; o)</span><br><span class="line">    : mRemote(o.get()), mRefs(<span class="literal">NULL</span>), mState(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    extendObjectLifetime(OBJECT_LIFETIME_WEAK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mRemote) &#123;</span><br><span class="line">        mRemote-&gt;incStrong(<span class="keyword">this</span>);           <span class="comment">// Removed on first IncStrong().</span></span><br><span class="line">        mRefs = mRemote-&gt;createWeak(<span class="keyword">this</span>);  <span class="comment">// Held for our entire lifetime.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·å¾ˆéšè”½ï¼ŒmRemoteçš„èµ‹å€¼æ¥è‡ª<code>o.get()</code>ï¼Œå› æ­¤<code>remote()</code>è¿”å›çš„å®é™…å°±æ˜¯æ–°å»º BpServiceManager æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯<code>new BpBinder(0)</code>ï¼Œæ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬åº”è¯¥å» BpBinder ä¸­å¯»æ‰¾<code>transact()</code>å‡½æ•°çš„å®ç°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç ï¼šstatus_t err = remote()-&gt;transact(ADD_SERVICE_TRANSACTION, data, &amp;reply);</span></span><br><span class="line"><span class="comment">// å‚æ•°è§£é‡Šï¼šdata å°±æ˜¯æœåŠ¡æ³¨å†Œåˆå§‹æ•°æ®å›¾æ‰€ç¤ºå†…å®¹ï¼Œreply æ˜¯ä¸€ä¸ª Parcel å¯¹è±¡ï¼Œflags é»˜è®¤æ˜¯ 0</span></span><br><span class="line"><span class="keyword">status_t</span> BpBinder::transact(</span><br><span class="line">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Once a binder has died, it will never come back to life.</span></span><br><span class="line">    <span class="keyword">if</span> (mAlive) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> status = IPCThreadState::self()-&gt;transact(</span><br><span class="line">            mHandle, code, data, reply, flags);</span><br><span class="line">        <span class="keyword">if</span> (status == DEAD_OBJECT) mAlive = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆè½¬åˆ°<code>IPCThreadState::self()</code>é‡Œé¢å»äº†ï¼Œçœ‹ä¸Šå»ä¼¼ä¹åˆæ˜¯ä¸€ä¸ªè·å–å•ä¾‹çš„æ–¹æ³•ï¼Œå®ƒçš„æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">IPCThreadState* IPCThreadState::self()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (gHaveTLS) &#123;</span><br><span class="line">restart:</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">pthread_key_t</span> k = gTLS;</span><br><span class="line">        IPCThreadState* st = (IPCThreadState*)pthread_getspecific(k);</span><br><span class="line">        <span class="keyword">if</span> (st) <span class="keyword">return</span> st;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IPCThreadState;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (gShutdown) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;gTLSMutex);</span><br><span class="line">    <span class="keyword">if</span> (!gHaveTLS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_key_create(&amp;gTLS, threadDestructor) != <span class="number">0</span>) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;gTLSMutex);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        gHaveTLS = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;gTLSMutex);</span><br><span class="line">    <span class="keyword">goto</span> restart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„å®ç°æ¶‰åŠåˆ°ä¸€äº› Linux å‡½æ•°ä»¥åŠçº¿ç¨‹çŸ¥è¯†ï¼šå®ƒå¹¶ä¸æ˜¯å‰é¢æ‰€è¯´çš„è·å–å•ä¾‹ï¼Œè€Œæ˜¯è·å–çº¿ç¨‹å˜é‡å‰¯æœ¬ã€‚ç›¸ä¼¼çš„æœºåˆ¶ Java ä¸­ä¹Ÿæœ‰ï¼Œå¯ä»¥æŸ¥çœ‹æ–‡ç«  <a href="http://www.muzileecoding.com/java/Java-threadlocal.html" target="_blank" rel="noopener">ThreadLocal æºç å‰–æ</a>ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªå˜é‡çš„å‰¯æœ¬ï¼Œä¿è¯çº¿ç¨‹ä¹‹é—´ä¸å…±äº«åŸæœ‰çš„å˜é‡ï¼Œä¿è¯çº¿ç¨‹å†…éƒ¨åªæœ‰ä¸€ä¸ªè¯¥å˜é‡çš„å‰¯æœ¬ã€‚å…³äºè¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°ä¸€ç¯‡æ–‡ç« :<a href="http://blog.csdn.net/lmh12506/article/details/8452700" target="_blank" rel="noopener">pthread_key_tå’Œpthread_key_create()è¯¦è§£</a>ï¼Œè¯»è€…è¯»å®Œè¿™ä¸¤ç¯‡æ–‡ç« ä¹‹åï¼Œå†çœ‹è¿™ä¸ªå‡½æ•°å°±ä¼šæ¯”è¾ƒæ¸…æ™°ï¼Œè¿™é‡Œå°±ä¸åšè¯¦ç»†åˆ†æäº†ã€‚æ€»ç»“ä¸€ä¸‹è¯¥å‡½æ•°: ä¸ºè¯¥è¿›ç¨‹ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå”¯ä¸€ä¸€ä¸ª IPCThreadState å¯¹è±¡ã€‚</p>
<blockquote>
<p>è¿™ä¸ªåˆ›å»ºå¹¶ä¸æ˜¯çº¿ç¨‹ä¸€å¯åŠ¨å°±è¿›è¡Œçš„ï¼Œè€Œæ˜¯åœ¨è¿™ä¸ªå˜é‡ä¸­è·å–è¯¥å˜é‡çš„æ—¶å€™è¿›è¡Œåˆ›å»ºçš„ã€‚</p>
</blockquote>
<p>å¥½ï¼Œå’±ç»§ç»­èµ°ï¼åˆ›å»ºä¹‹åè°ƒç”¨çš„æ˜¯ IPCThreadState çš„<code>transact()</code>å‡½æ•°: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç : status_t status = IPCThreadState::self()-&gt;transact(mHandle, code, data, reply, flags);</span></span><br><span class="line"><span class="comment">// å‚æ•°è§£é‡Š: handle æ˜¯ BpBinder çš„å®ä¾‹åŒ–å‚æ•°ï¼Œä¹Ÿå°±æ˜¯0ï¼Œcode æ˜¯ ADD_SERVICE_TRANSACTIONï¼Œflagsæ˜¯0</span></span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::transact(<span class="keyword">int32_t</span> handle,</span><br><span class="line">                                  <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data,</span><br><span class="line">                                  Parcel* reply, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">status_t</span> err = data.errorCheck();</span><br><span class="line"></span><br><span class="line">    flags |= TF_ACCEPT_FDS;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">// æ•°æ®æ²¡æœ‰é—®é¢˜ï¼Œåˆ¤æ–­é€šè¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        err = writeTransactionData(BC_TRANSACTION, flags, handle, code, data, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (reply) reply-&gt;setError(err);</span><br><span class="line">        <span class="keyword">return</span> (mLastError = err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; TF_ONE_WAY) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">            err = waitForResponse(reply);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Parcel fakeReply;</span><br><span class="line">            err = waitForResponse(&amp;fakeReply);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = waitForResponse(<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•åˆ é™¤ä¸€äº›Logå’Œæ— ç”¨ä»£ç ä¹‹åï¼Œå¤§è‡´å°±æ˜¯ä¸Šé¢è¿™ä¸ªæ ·å­ã€‚é¦–å…ˆè¿›æ¥è°ƒç”¨çš„å°±æ˜¯<code>writeTransactionData()</code>æ–¹æ³•:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ä»£ç : writeTransactionData(BC_TRANSACTION, flags, handle, code, data, NULL);</span></span><br><span class="line"><span class="comment">// å‚æ•°è§£é‡Š: handle ä¸º0ï¼Œcode ä¸º ADD_SERVICE_TRANSACTIONï¼Œ binderFlags æ˜¯ TF_ACCEPT_FDS;</span></span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::writeTransactionData(<span class="keyword">int32_t</span> cmd, <span class="keyword">uint32_t</span> binderFlags,</span><br><span class="line">    <span class="keyword">int32_t</span> handle, <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, <span class="keyword">status_t</span>* statusBuffer)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    binder_transaction_data tr;</span><br><span class="line"></span><br><span class="line">    tr.target.handle = handle;</span><br><span class="line">    tr.code = code;</span><br><span class="line">    tr.flags = binderFlags;</span><br><span class="line">    tr.cookie = <span class="number">0</span>;</span><br><span class="line">    tr.sender_pid = <span class="number">0</span>;</span><br><span class="line">    tr.sender_euid = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">status_t</span> err = data.errorCheck();</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">    	<span class="comment">// å°†ä¹‹å‰å†™åœ¨ data ä¸­çš„æ•°æ®å†æ¢ä¸€ç§å½¢å¼å†™åˆ° binder_transaction_data ä¸­</span></span><br><span class="line">        tr.data_size = data.ipcDataSize(); </span><br><span class="line">        tr.data.ptr.buffer = data.ipcData(); </span><br><span class="line">        tr.offsets_size = data.ipcObjectsCount()*<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>);</span><br><span class="line">        tr.data.ptr.offsets = data.ipcObjects(); </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusBuffer) &#123;</span><br><span class="line">        tr.flags |= TF_STATUS_CODE;</span><br><span class="line">        *statusBuffer = err;</span><br><span class="line">        tr.data_size = <span class="keyword">sizeof</span>(<span class="keyword">status_t</span>);</span><br><span class="line">        tr.data.ptr.buffer = statusBuffer;</span><br><span class="line">        tr.offsets_size = <span class="number">0</span>;</span><br><span class="line">        tr.data.ptr.offsets = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (mLastError = err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mOut.writeInt32(cmd);<span class="comment">//BC_TRANSACTION</span></span><br><span class="line">    mOut.write(&amp;tr, <span class="keyword">sizeof</span>(tr));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç»ˆäºé‡åˆ°ä¸€ç›´åœ¨ç­‰å¾…çš„é‡è¦ç»“æ„ä½“äº†: binder_transaction_dataã€‚</p>
<blockquote>
<p>å¦‚æœè¯»è€…çœ‹è¿‡æ¨èæ–‡ç« â‘ ï¼Œä¸€å®šçŸ¥é“ binder_transaction è¡¨ç¤ºIPCä¹‹é—´çš„ä¸€ä¸ªè¯·æ±‚ï¼Œè€Œ  binder_transaction_data å°±æ˜¯ä¸ºäº†è¿™æ ·ä¸€ä¸ªäº‹åŠ¡åŒ…è£…çš„ç»“æ„ä½“å¯¹è±¡ã€‚</p>
</blockquote>
<p>è¿™é‡Œä¸»è¦å°†ä¹‹å‰å†™å…¥ Parcel çš„æ•°æ®å†è®¾ç½®åˆ° binder_transaction_data ç»“æ„ä½“ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tr.data_size = data.ipcDataSize();  <span class="comment">//è®°å½•æ•°æ®å¤§å°</span></span><br><span class="line">tr.data.ptr.buffer = data.ipcData();  <span class="comment">// è®°å½•æ•°æ®å†…å®¹</span></span><br><span class="line">tr.offsets_size = data.ipcObjectsCount()*<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>);</span><br><span class="line">tr.data.ptr.offsets = data.ipcObjects();</span><br></pre></td></tr></table></figure>
<p>è¿™å››ä¸ªæ•°æ®æ˜¯æœ‰å¿…è¦è¯´é“è¯´é“çš„ï¼Œå‰ä¸¤ä¸ªå¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰å†™å…¥çš„æ•°æ®å°ºå¯¸ä»¥åŠå†…å®¹ï¼ˆæ³¨æ„ï¼Œå†…å®¹æ²¡æœ‰å˜ï¼‰ï¼Œå†…å®¹å°±æ˜¯â€æœåŠ¡æ³¨å†Œåˆå§‹æ•°æ®å›¾â€æ‰€ç»˜åˆ¶çš„ã€‚åä¸¤ä¸ªè¦æ³¨æ„äº†ï¼šè¿™ä¸¤ä¸ªæ•°æ®å°±æ˜¯ä¸ºäº† flat_binder_object å‡†å¤‡çš„ï¼Œåœ¨æœ€ç»ˆä¼ è¾“çš„æ•°æ®ä¸­ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦è®°å½•å“ªäº›ä½ç½®å­˜æ”¾ç€ flat_binder_object å¯¹è±¡çš„ï¼Œå…¶ä¸­<code>tr.data.ptr.offsets</code>ä¸­å­˜æ”¾çš„å°±æ˜¯æ¯ä¸ªå¯¹è±¡å®é™…çš„åç§»é‡ï¼Œ<code>tr.offsets_size</code>ä¸­å­˜æ”¾çš„å°±æ˜¯è¿™äº›åç§»æ•°æ®çš„å¤§å° â€”â€” è®°å½•è¿™äº›å…ƒæ•°æ®æ˜¯ä¸ºåé¢å¯ä»¥å†ååºåˆ—åŒ–å‡º flat_binder_object å¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒmOut æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿå®ƒä¹Ÿæ˜¯ä¸ª Parcel å¯¹è±¡ï¼Œå®ƒåœ¨<code>IPCThreadState</code>åˆå§‹åŒ–çš„æ—¶å€™è¢«è®¾ç½®ç›¸åº”çš„åˆå§‹å€¼ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IPCThreadState::IPCThreadState()</span><br><span class="line">    : mProcess(ProcessState::self()),</span><br><span class="line">      mMyThreadId(androidGetTid()),</span><br><span class="line">      mStrictModePolicy(<span class="number">0</span>),</span><br><span class="line">      mLastTransactionBinderFlags(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    pthread_setspecific(gTLS, <span class="keyword">this</span>);</span><br><span class="line">    clearCaller();</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå˜é‡çš„å®¹é‡éƒ½ä¸ä¸º0</span></span><br><span class="line">    mIn.setDataCapacity(<span class="number">256</span>);</span><br><span class="line">    mOut.setDataCapacity(<span class="number">256</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œæˆ<code>writeTransactionData</code>ä¹‹åæ•°æ®éƒ½è¢«å†™å…¥äº† mOut å†…ï¼Œé‚£æ˜¯åœ¨å“ªé‡Œå‘é€æ•°æ®åˆ°é©±åŠ¨å±‚çš„å‘¢ï¼Ÿå›åˆ°<code>IPCThreadState::transact()</code>æ–¹æ³•ï¼Œåœ¨è°ƒç”¨<code>writeTransactionData()</code>æ–¹æ³•ä¹‹åï¼Œåšäº†ä¸€äº›é”™è¯¯æ£€æµ‹ï¼Œä¹‹åå°±æ˜¯è°ƒç”¨å‡½æ•°<code>waitForResponse()</code>ï¼Œä»£ç åˆ å‡ä¸€ä¸‹å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::waitForResponse(Parcel *reply, <span class="keyword">status_t</span> *acquireResult)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> cmd;</span><br><span class="line">    <span class="keyword">int32_t</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        err = mIn.errorCheck();</span><br><span class="line">        <span class="keyword">if</span> (err &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (mIn.dataAvail() == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šä¸‹é¢æœ‰ä¸€æ®µå¾ˆé•¿çš„å‘½ä»¤è§£æï¼Œè¿™æ®µæ•°æ®æ¥è‡ªé©±åŠ¨ã€‚ç­‰åˆ†æå®Œæ•°æ®çš„å‘é€ä¹‹åï¼Œæˆ‘ä»¬è¿˜ä¼šå›åˆ°è¿™é‡Œ</span></span><br><span class="line">        cmd = mIn.readInt32();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            err = executeCommand(cmd);</span><br><span class="line">            <span class="keyword">if</span> (err != NO_ERROR) <span class="keyword">goto</span> finish;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆè°ƒç”¨äº†ä¸€ä¸ª<code>talkWithDriver()</code>å‡½æ•°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ³•å£°æ˜çš„æ—¶å€™é»˜è®¤ doReceive æ˜¯ true</span></span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::talkWithDriver(<span class="keyword">bool</span> doReceive)</span><br><span class="line">&#123;</span><br><span class="line">    LOG_ASSERT(mProcess-&gt;mDriverFD &gt;= <span class="number">0</span>, <span class="string">"Binder driver is not opened"</span>);</span><br><span class="line">    </span><br><span class="line">    binder_write_read bwr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Is the read buffer empty?</span></span><br><span class="line">    <span class="comment">// ä¸º true</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> needRead = mIn.dataPosition() &gt;= mIn.dataSize();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We don't want to write anything if we are still reading</span></span><br><span class="line">    <span class="comment">// from data left in the input buffer and the caller</span></span><br><span class="line">    <span class="comment">// has requested to read the next data.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.dataSize() : <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°† mOutä¸­ çš„æ•°æ®å†™å…¥åˆ°bwrä¸­</span></span><br><span class="line">    bwr.write_size = outAvail;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)mOut.data();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is what we'll read. è¿™ä¸¤ä¸ªå˜é‡åå–å¾—å¾ˆå¥½</span></span><br><span class="line">    <span class="keyword">if</span> (doReceive &amp;&amp; needRead) &#123;</span><br><span class="line">    	<span class="comment">//æ³¨æ„ï¼šå‰é¢è¯´äº†ï¼Œè¿™ä¸ª mIn åœ¨ IPCThreadState ä¸­åˆå§‹åŒ–çš„æ—¶å€™å°±è¢«è®¾ç½®ä¸º 256 çš„å®¹é‡</span></span><br><span class="line">        bwr.read_size = mIn.dataCapacity();</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)mIn.data();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bwr.read_size = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Return immediately if there is nothing to do.</span></span><br><span class="line">    <span class="keyword">if</span> ((bwr.write_size == <span class="number">0</span>) &amp;&amp; (bwr.read_size == <span class="number">0</span>)) <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(HAVE_ANDROID_OS)</span></span><br><span class="line">        <span class="keyword">if</span> (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</span><br><span class="line">            err = NO_ERROR;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            err = -errno;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        err = INVALID_OPERATION;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (err == -EINTR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err &gt;= NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bwr.write_consumed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bwr.write_consumed &lt; (<span class="keyword">ssize_t</span>)mOut.dataSize())</span><br><span class="line">                mOut.remove(<span class="number">0</span>, bwr.write_consumed);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                mOut.setDataSize(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bwr.read_consumed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mIn.setDataSize(bwr.read_consumed);</span><br><span class="line">            mIn.setDataPosition(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å’Œé©±åŠ¨äº¤äº’ä¹‹å‰ï¼Œè¿˜æ˜¯éœ€è¦æŠŠæ•°æ®å†™å…¥ binder_write_read ç»“æ„ä½“ä¸­ï¼Œç„¶åä½¿ç”¨<code>ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr)</code>å‘½ä»¤å°†æ•°æ®å†™å…¥é©±åŠ¨ã€‚</p>
<blockquote>
<p>è¿™é‡Œæ˜¯ç¬¬äºŒæ¬¡é‡åˆ°è¿™ç§æ¨¡å¼äº†ã€‚è¿™é‡Œåšäº†ä¸€ç‚¹å°ä¿®æ”¹ï¼šé€šè¿‡ä¸¤ä¸ª Parcel å¯¹è±¡è¿›è¡Œæ•°æ®è¯»å†™ï¼Œbwr æ˜¯è¿™ä¸¤ä¸ªå¯¹è±¡å’Œé©±åŠ¨å±‚äº¤äº’çš„ä»‹è´¨ã€‚</p>
</blockquote>
<p>å›æƒ³ä¸€ä¸‹è¿™ä¸ªæ—¶å€™ <code>mOut.data()</code>ï¼Œä¹Ÿå°±æ˜¯bwr.write_bufferä¸­æ˜¯ä»€ä¹ˆå†…å®¹ï¼Ÿ <strong>æ˜¯ä¸€ä¸ªå‘½ä»¤ <code>BC_TRANSACTION</code> + <code>binder_transaction_data</code>ç»“æ„ä½“ï¼Œ<code>binder_transaction_data</code>ç»“æ„ä½“ä¸­è®°å½•ç€æœåŠ¡æ³¨å†Œåˆå§‹æ•°æ®å›¾ä¸­æ‰€æè¿°çš„ data æ•°æ®ç»“æ„ä»¥åŠä¸€äº›å…ƒæ•°æ®(å…·ä½“è½¬æ¢éƒ½åœ¨<code>IPCThreadState::writeTransactionData()</code>æ–¹æ³•ä¸­)ã€‚</strong></p>
<p>æ¥ç€æ¥ï¼çœ‹æ¥è¦çŸ¥é“å¦‚ä½•æ³¨å†Œçš„ï¼Œé—®é¢˜å°±åœ¨äºè§£æ<code>ioctl</code>æœŸé—´åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é©±åŠ¨å±‚å¯¹äº<code>BINDER_WRITE_READ</code>çš„å‘½ä»¤çš„è§£æï¼Œä¹‹å‰å·²ç»æœ‰è¿‡ç±»ä¼¼çš„ä¾‹å­ï¼Œæ‰§è¡Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (size != <span class="keyword">sizeof</span>(struct binder_write_read)) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;<span class="comment">//å†™å…¥å†…å®¹</span></span><br><span class="line">            <span class="comment">//å‚æ•°ï¼šå‰ä¸¤ä¸ªè¡¨ç¤ºå‘èµ·ä¼ è¾“åŠ¨ä½œçš„è¿›ç¨‹å’Œçº¿ç¨‹</span></span><br><span class="line">            ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">            trace_binder_write_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// writeä¹‹åç´§æ¥ç€è°ƒç”¨read</span></span><br><span class="line">        <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;<span class="comment">//è¯»å–å†…å®¹</span></span><br><span class="line">            ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</span><br><span class="line">            trace_binder_read_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</span><br><span class="line">                wake_up_interruptible(&amp;proc-&gt;wait);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å†å†™å›å»</span></span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>bwr.write_size</code>å’Œ<code>bwr.read_size</code>éƒ½å¤§äº 0ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹<code>binder_thread_write</code>ã€‚è¿™ä¸ªå‡½æ•°è§£æçš„æ—¶å€™ä¼šé¦–å…ˆè¯»å–ä¸€ä¸ª cmd å‚æ•°ï¼Œä»å‰é¢çš„ä»£ç ä¸­ä¸éš¾å‘ç°ï¼Œè¿™ä¸ª cmd æ˜¯<code>BC_TRANSACTION</code>ï¼Œå®ƒçš„å¤„ç†å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BC_TRANSACTION:</span><br><span class="line"><span class="keyword">case</span> BC_REPLY: &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">		<span class="comment">// ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´</span></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(&amp;tr, ptr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		<span class="comment">// å·²ç»è¯»å–äº†trï¼Œå‘åç§»åŠ¨æŒ‡é’ˆ</span></span><br><span class="line">		ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line">		</span><br><span class="line">		binder_transaction(proc, thread, &amp;tr, cmd == BC_REPLY);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰é¢å‡ æ­¥éƒ½å·²ç»æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæ•°æ®è¯»å–å’Œå†™å…¥ä¸€ä¸€å¯¹åº”ï¼Œbinder_transaction_data å¯¹åº”æ•°æ®è¢«å¤åˆ¶åˆ°é©±åŠ¨å±‚ã€‚æœ€åè°ƒç”¨çš„æ˜¯<code>binder_transaction</code>å‡½æ•°è¿›è¡Œè§£æï¼Œå‰é¢ä¸¤ä¸ªå‚æ•°å¾ˆç†Ÿæ‚‰ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸º false ã€‚</p>
<blockquote>
<p>è®©æˆ‘å“­ä¸€ä¼šå„¿ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æºç é‡Œé¢æ˜¯ä¸€ä¸ª 400 å¤šè¡Œçš„å‡½æ•°â€¦.æˆ‘è¦ç½¢å·¥äº†ï¼</p>
</blockquote>
<p>åˆ åˆ åˆ ï¼Œåˆ å®Œä¹‹åè¿˜å‰©ä¸‹è¿™ä¹ˆå¤š: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tr çš„ write æ•°æ®ä¸­æœ‰ binder èŠ‚ç‚¹ä¿¡æ¯ï¼Œå°±æ˜¯ä¹‹å‰å†™å…¥mOutä¸­çš„æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">tcomplete</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> *offp, *off_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">target_proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">target_thread</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">target_list</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> *target_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">in_reply_to</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_log_entry</span> *<span class="title">e</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> return_error;</span><br><span class="line">    e = binder_transaction_log_add(&amp;binder_transaction_log);</span><br><span class="line">    e-&gt;call_type = reply ? <span class="number">2</span> : !!(tr-&gt;flags &amp; TF_ONE_WAY);</span><br><span class="line">    e-&gt;from_proc = proc-&gt;pid;</span><br><span class="line">    e-&gt;from_thread = thread-&gt;pid;</span><br><span class="line">    e-&gt;target_handle = tr-&gt;target.handle;</span><br><span class="line">    e-&gt;data_size = tr-&gt;data_size;</span><br><span class="line">    e-&gt;offsets_size = tr-&gt;offsets_size;</span><br><span class="line">    <span class="comment">// transaction å’Œ reply æ˜¯åŒä¸€ä¸ªå¤„ç†æµç¨‹ï¼Œä½†è¿™é‡Œæ˜¯transactionï¼Œå› æ­¤ reply ä¸ºfalse</span></span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// åœ¨ IPCThreadState::writeTransactionData å¯ä»¥çœ‹åˆ° handle è¢«èµ‹å€¼äº†ï¼Œ</span></span><br><span class="line">        <span class="comment">// è€Œä¸”è§£æä¸­ç‰¹æ„æŒ‡å‡ºè¿™ä¸ª handle ä¸º 0ï¼Œå› æ­¤è¿™ä¸ªåˆ¤æ–­ä¸æˆç«‹</span></span><br><span class="line">        <span class="keyword">if</span> (tr-&gt;target.handle) &#123;</span><br><span class="line">            struct binder_ref *ref;</span><br><span class="line">            ref = binder_get_ref(proc, tr-&gt;target.handle);</span><br><span class="line">            <span class="keyword">if</span> (ref == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                binder_user_error(<span class="string">"binder: %d:%d got "</span></span><br><span class="line">                    <span class="string">"transaction to invalid handle\n"</span>,</span><br><span class="line">                    proc-&gt;pid, thread-&gt;pid);</span><br><span class="line">                return_error = BR_FAILED_REPLY;</span><br><span class="line">                <span class="keyword">goto</span> err_invalid_target_handle;</span><br><span class="line">            &#125;</span><br><span class="line">            target_node = ref-&gt;node;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// target_node: ç›®æ ‡èŠ‚ç‚¹ï¼Œå‰é¢åˆ†æè¯´äº†ï¼Œbinder_node è¡¨ç¤ºä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œçš„ç›®æ ‡èŠ‚ç‚¹çš„å«ä¹‰å°±æ˜¯å‘é€è¯·æ±‚çš„ç›®æ ‡èŠ‚ç‚¹ï¼Œè¿™é‡Œæ˜¯åœ¨æ³¨å†ŒæœåŠ¡ï¼Œæ‰€ä»¥ç›®æ ‡</span></span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹å°±æ˜¯ binder_context_mgr_nodeï¼Œä¹Ÿå°±æ˜¯ SM æ³¨å†Œæˆä¸ºå®ˆæŠ¤è¿›ç¨‹çš„æ—¶</span></span><br><span class="line">            <span class="comment">// å€™ç”Ÿæˆçš„èŠ‚ç‚¹ï¼šè¿™ä¹Ÿå°±æ˜¯è¯´ handle = 0å°±ä»£è¡¨ç€æŒ‡å‘ SM æœåŠ¡èŠ‚ç‚¹ã€‚</span></span><br><span class="line">            target_node = binder_context_mgr_node;</span><br><span class="line">            <span class="keyword">if</span> (target_node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                return_error = BR_DEAD_REPLY;</span><br><span class="line">                <span class="keyword">goto</span> err_no_context_mgr_node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        e-&gt;to_node = target_node-&gt;debug_id;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç›®æ ‡èŠ‚ç‚¹æ‰€åœ¨çš„è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯ SM æœåŠ¡è¿›ç¨‹(åœ¨binder_new_node()æ–¹æ³•ä¸­æ–°å»ºnodeçš„æ—¶å€™è¿›è¡Œäº†èµ‹å€¼)</span></span><br><span class="line">        target_proc = target_node-&gt;proc;</span><br><span class="line">        <span class="keyword">if</span> (target_proc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            return_error = BR_DEAD_REPLY;</span><br><span class="line">            <span class="keyword">goto</span> err_dead_binder;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æƒé™æ£€æµ‹</span></span><br><span class="line">        <span class="keyword">if</span> (security_binder_transaction(proc-&gt;tsk, target_proc-&gt;tsk) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            return_error = BR_FAILED_REPLY;</span><br><span class="line">            <span class="keyword">goto</span> err_invalid_target_handle;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// thread-&gt;transaction_stack ä¸º nullï¼Œä¸æˆç«‹</span></span><br><span class="line">        <span class="keyword">if</span> (!(tr-&gt;flags &amp; TF_ONE_WAY) &amp;&amp; thread-&gt;transaction_stack) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">tmp</span>;</span></span><br><span class="line">            tmp = thread-&gt;transaction_stack;</span><br><span class="line">            <span class="keyword">if</span> (tmp-&gt;to_thread != thread) &#123;</span><br><span class="line">                binder_user_error(<span class="string">"binder: %d:%d got new "</span></span><br><span class="line">                    <span class="string">"transaction with bad transaction stack"</span></span><br><span class="line">                    <span class="string">", transaction %d has target %d:%d\n"</span>,</span><br><span class="line">                    proc-&gt;pid, thread-&gt;pid, tmp-&gt;debug_id,</span><br><span class="line">                    tmp-&gt;to_proc ? tmp-&gt;to_proc-&gt;pid : <span class="number">0</span>,</span><br><span class="line">                    tmp-&gt;to_thread ?</span><br><span class="line">                    tmp-&gt;to_thread-&gt;pid : <span class="number">0</span>);</span><br><span class="line">                return_error = BR_FAILED_REPLY;</span><br><span class="line">                <span class="keyword">goto</span> err_bad_call_stack;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (tmp) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tmp-&gt;from &amp;&amp; tmp-&gt;from-&gt;proc == target_proc)</span><br><span class="line">                    target_thread = tmp-&gt;from;</span><br><span class="line">                tmp = tmp-&gt;from_parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ‰¾åˆ°äº†åˆé€‚çš„çº¿ç¨‹ï¼Œè·å–ç›®æ ‡çº¿ç¨‹çš„ä¸¤ç»„Listï¼Œå®é™…è¿™é‡Œ target_thread ä¸º NULL</span></span><br><span class="line">    <span class="keyword">if</span> (target_thread) &#123;</span><br><span class="line">        e-&gt;to_thread = target_thread-&gt;pid;</span><br><span class="line">        target_list = &amp;target_thread-&gt;todo;</span><br><span class="line">        target_wait = &amp;target_thread-&gt;wait;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦åˆ™è·å–ç›®æ ‡è¿›ç¨‹çš„ä¸¤ç»„List</span></span><br><span class="line">        target_list = &amp;target_proc-&gt;todo;</span><br><span class="line">        target_wait = &amp;target_proc-&gt;wait;</span><br><span class="line">    &#125;</span><br><span class="line">    e-&gt;to_proc = target_proc-&gt;pid;</span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> reuse incoming transaction for reply */</span></span><br><span class="line">    <span class="comment">// t æ˜¯ binder_transaction ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å¯ä»¥åœ¨å­—å…¸ä¸­æŸ¥è¯¢</span></span><br><span class="line">    t = kzalloc(<span class="keyword">sizeof</span>(*t), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_t_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    binder_stats_created(BINDER_STAT_TRANSACTION);</span><br><span class="line">    <span class="comment">// tcomplete æ˜¯ binder_work ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å¯ä»¥åœ¨å­—å…¸ä¸­æŸ¥è¯¢</span></span><br><span class="line">    tcomplete = kzalloc(<span class="keyword">sizeof</span>(*tcomplete), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (tcomplete == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_tcomplete_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    binder_stats_created(BINDER_STAT_TRANSACTION_COMPLETE);</span><br><span class="line">    t-&gt;debug_id = ++binder_last_id;</span><br><span class="line">    e-&gt;debug_id = t-&gt;debug_id;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// reply ä¸º falseï¼Œ tr-flags ä¸º TF_ACCEPT_FDSï¼Œå› æ­¤æˆç«‹</span></span><br><span class="line">    <span class="keyword">if</span> (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY))</span><br><span class="line">        t-&gt;from = thread; <span class="comment">// æŒ‡å‘å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        t-&gt;from = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸º binder_transaction ç»“æ„ä½“è®¾ç½®å±æ€§ï¼ŒåŒ…æ‹¬æŠŠè¯¥ transaction äº¤ç»™å“ªä¸ª procï¼Œå“ªä¸ª thread</span></span><br><span class="line">    t-&gt;sender_euid = proc-&gt;tsk-&gt;cred-&gt;euid;</span><br><span class="line">    t-&gt;to_proc = target_proc;</span><br><span class="line">    t-&gt;to_thread = target_thread;</span><br><span class="line">    <span class="comment">// code ä¸º ADD_SERVICE_TRANSACTION</span></span><br><span class="line">    t-&gt;code = tr-&gt;code;</span><br><span class="line">    t-&gt;flags = tr-&gt;flags;</span><br><span class="line">    t-&gt;priority = task_nice(current);</span><br><span class="line">    trace_binder_transaction(reply, t, target_node);</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œè¿™æ˜¯åœ¨target_procä¸­è¿›è¡Œå†…å­˜åˆ†é…ï¼ŒåŒ…æ‹¬æ•°æ®å¡«å…¥</span></span><br><span class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</span><br><span class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_binder_alloc_buf_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    t-&gt;buffer-&gt;allow_user_free = <span class="number">0</span>;</span><br><span class="line">    t-&gt;buffer-&gt;debug_id = t-&gt;debug_id;</span><br><span class="line">    t-&gt;buffer-&gt;transaction = t;</span><br><span class="line">    t-&gt;buffer-&gt;target_node = target_node;</span><br><span class="line">    trace_binder_transaction_alloc_buf(t-&gt;buffer);</span><br><span class="line">    <span class="comment">// å¢åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (target_node)</span><br><span class="line">        binder_inc_node(target_node, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    offp = (<span class="keyword">size_t</span> *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‹·è´ transaction æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</span><br><span class="line">        binder_user_error(<span class="string">"binder: %d:%d got transaction with invalid "</span></span><br><span class="line">            <span class="string">"data ptr\n"</span>, proc-&gt;pid, thread-&gt;pid);</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_copy_data_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‹·è´ transaction offsetæŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</span><br><span class="line">        binder_user_error(<span class="string">"binder: %d:%d got transaction with invalid "</span></span><br><span class="line">            <span class="string">"offsets ptr\n"</span>, proc-&gt;pid, thread-&gt;pid);</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_copy_data_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// offsets æ•°æ®è®°å½•æœ«å°¾</span></span><br><span class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ flat_binder_object </span></span><br><span class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">flat_binder_object</span> *<span class="title">fp</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (*offp &gt; t-&gt;buffer-&gt;data_size - <span class="keyword">sizeof</span>(*fp) ||</span><br><span class="line">            t-&gt;buffer-&gt;data_size &lt; <span class="keyword">sizeof</span>(*fp) ||</span><br><span class="line">            !IS_ALIGNED(*offp, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))) &#123;</span><br><span class="line">            binder_user_error(<span class="string">"binder: %d:%d got transaction with "</span></span><br><span class="line">                <span class="string">"invalid offset, %zd\n"</span>,</span><br><span class="line">                proc-&gt;pid, thread-&gt;pid, *offp);</span><br><span class="line">            return_error = BR_FAILED_REPLY;</span><br><span class="line">            <span class="keyword">goto</span> err_bad_offset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æˆ‘ä»¬ä¹‹å‰å­˜è¿›å»çš„æ‰å¹³åŒ–çš„flat_binder_objectå¯¹è±¡</span></span><br><span class="line">        fp = (struct flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</span><br><span class="line">        <span class="keyword">switch</span> (fp-&gt;type) &#123;</span><br><span class="line">        <span class="keyword">case</span> BINDER_TYPE_BINDER:</span><br><span class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_BINDER: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">            <span class="comment">// è·å–Binderå®ä½“èŠ‚ç‚¹ï¼Œè¿™ä¸ªprocè¡¨ç¤ºå½“å‰è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯å‘èµ·å‘½ä»¤çš„è¿›ç¨‹ï¼Œ</span></span><br><span class="line">            <span class="comment">// åˆæ¬¡æ³¨å†Œï¼Œé€šè¿‡binder_get_nodeæ‹¿ä¸åˆ°BinderèŠ‚ç‚¹</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span> = <span class="title">binder_get_node</span>(<span class="title">proc</span>, <span class="title">fp</span>-&gt;<span class="title">binder</span>);</span></span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// æ–°å»ºbinderèŠ‚ç‚¹ï¼Œè¿™ä¸ªæ–¹æ³•ä¹‹å‰åˆ†æè¿‡äº†ï¼šä¼šåœ¨procçš„nodesçº¢é»‘æ ‘ä¸Š</span></span><br><span class="line">                <span class="comment">// åˆ›å»ºå¯¹åº”çš„binderèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè¯¥procæä¾›è¯¥æœåŠ¡ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå’Œ</span></span><br><span class="line">                <span class="comment">// SM ä¸åŒï¼Œè¿™é‡Œåé¢ä¸¤ä¸ªå‚æ•°éƒ½å®é™…ä¼ é€’äº†å€¼è¿›å»ï¼Œå› æ­¤ï¼Œbinder_node</span></span><br><span class="line">                <span class="comment">// å¯ä»¥æ ¹æ®cookieæ¥å¯»æ‰¾ Libraries å±‚çš„æœåŠ¡ä½ç½®ï¼Œä¹Ÿå°±æ˜¯</span></span><br><span class="line">                <span class="comment">// BBinder â€”â€” æˆ‘ä»¬è¦æ³¨å†Œçš„æœåŠ¡ã€‚</span></span><br><span class="line">                node = binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie);</span><br><span class="line">                <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    return_error = BR_FAILED_REPLY;</span><br><span class="line">                    <span class="keyword">goto</span> err_binder_new_node_failed;</span><br><span class="line">                &#125;</span><br><span class="line">                node-&gt;min_priority = fp-&gt;flags &amp; FLAT_BINDER_FLAG_PRIORITY_MASK;</span><br><span class="line">                node-&gt;accept_fds = !!(fp-&gt;flags &amp; FLAT_BINDER_FLAG_ACCEPTS_FDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¿è¯æŒ‡é’ˆå€¼ä¸€è‡´</span></span><br><span class="line">            <span class="keyword">if</span> (fp-&gt;cookie != node-&gt;cookie) &#123;</span><br><span class="line">                binder_user_error(<span class="string">"binder: %d:%d sending u%p "</span></span><br><span class="line">                    <span class="string">"node %d, cookie mismatch %p != %p\n"</span>,</span><br><span class="line">                    proc-&gt;pid, thread-&gt;pid,</span><br><span class="line">                    fp-&gt;binder, node-&gt;debug_id,</span><br><span class="line">                    fp-&gt;cookie, node-&gt;cookie);</span><br><span class="line">                <span class="keyword">goto</span> err_binder_get_ref_for_node_failed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (security_binder_transfer_binder(proc-&gt;tsk, target_proc-&gt;tsk)) &#123;</span><br><span class="line">                return_error = BR_FAILED_REPLY;</span><br><span class="line">                <span class="keyword">goto</span> err_binder_get_ref_for_node_failed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ›å»ºå¥½å¯¹åº”çš„ binder_node ä¹‹åï¼Œå»å¯¹åº”çš„ target_procä¸­å¯»æ‰¾æ˜¯å¦æœ‰è¯¥nodeçš„å¼•ç”¨</span></span><br><span class="line">            <span class="comment">// æ²¡æœ‰çš„è¯ï¼Œbinder_get_ref_for_node ä¼šæ–°å»ºä¸€ä¸ª binder_ref å¯¹è±¡ï¼Œæ’å…¥åˆ°æˆ‘ä»¬ä¹‹</span></span><br><span class="line">            <span class="comment">// å‰æåˆ°è¿‡çš„ binder_proc çš„å››æ£µçº¢é»‘æ ‘ä¸­çš„ä¸¤æ£µé‡Œé¢å»ï¼Œåˆ†åˆ«æ˜¯ refs_by_node å’Œ</span></span><br><span class="line">            <span class="comment">// refs_by_descã€‚æ³¨æ„ï¼Œbinder_ref ä¸­ä¹ŸåŒ…å«äº†è¯¥nodeçš„å¼•ç”¨ã€‚</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// binder_get_ref_for_node å¯»æ‰¾ binder_ref çš„è¿‡ç¨‹æ˜¯ç›´æ¥é€šè¿‡æ¯”è¾ƒnodeæ¥è¿›è¡Œçš„ã€‚</span></span><br><span class="line">            ref = binder_get_ref_for_node(target_proc, node);</span><br><span class="line">            <span class="keyword">if</span> (ref == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                return_error = BR_FAILED_REPLY;</span><br><span class="line">                <span class="keyword">goto</span> err_binder_get_ref_for_node_failed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å‰é¢æåˆ°è¿‡ï¼Œbinder é©±åŠ¨ä¼šæ›´æ”¹ç±»å‹</span></span><br><span class="line">            <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_BINDER)</span><br><span class="line">                fp-&gt;type = BINDER_TYPE_HANDLE;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                fp-&gt;type = BINDER_TYPE_WEAK_HANDLE;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åŒå‰é¢æåˆ°è¿‡ï¼Œè¿™é‡Œä¹Ÿä¼šæ›´æ”¹æ•°æ®ã€‚</span></span><br><span class="line">            <span class="comment">// desc å€¼ï¼Œå…¶å®å°±æ˜¯è¯¥ binder_node èŠ‚ç‚¹åœ¨ target_proc ä¸­çš„ handleï¼Œé€šè¿‡è¿™ä¸ªhandle</span></span><br><span class="line">            <span class="comment">// å¯ä»¥ç›´æ¥æ‰¾åˆ°å¯¹åº”çš„ binder_node èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡ï¼Œè¿™é‡Œè§£é‡Šçš„å¯èƒ½ä¸æ¸…æ¥šï¼Œç­‰</span></span><br><span class="line">            <span class="comment">// ä¸‹ä¸€ç¯‡æ–‡ç« è®²è¿°è·å–æœåŠ¡çš„æ—¶å€™ï¼Œè¿™é‡Œå°±å¾ˆæ¸…æ¥šäº†ã€‚</span></span><br><span class="line">            fp-&gt;handle = ref-&gt;desc;</span><br><span class="line">            binder_inc_ref(ref, fp-&gt;type == BINDER_TYPE_HANDLE,</span><br><span class="line">                       &amp;thread-&gt;todo);</span><br><span class="line">            trace_binder_transaction_node_to_ref(t, node, ref);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123; <span class="comment">// æˆç«‹</span></span><br><span class="line">        BUG_ON(t-&gt;buffer-&gt;async_transaction != <span class="number">0</span>);</span><br><span class="line">        t-&gt;need_reply = <span class="number">1</span>;</span><br><span class="line">        t-&gt;from_parent = thread-&gt;transaction_stack;</span><br><span class="line">        <span class="comment">// è®°å½•è¿™ä¸ªtransactionï¼Œç­‰ä¸‹ SM å›å¤çš„æ—¶å€™éœ€è¦ä½¿ç”¨è¿™ä¸ª transaction</span></span><br><span class="line">        thread-&gt;transaction_stack = t; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// t-&gt;work æ˜¯ binder_work ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥è¯¢</span></span><br><span class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</span><br><span class="line">    <span class="comment">// æ·»åŠ  t åˆ°ç›®æ ‡è¿›ç¨‹çš„todo listä¸­å»</span></span><br><span class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br><span class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ todo listä¸­å»</span></span><br><span class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</span><br><span class="line">    <span class="comment">// å”¤é†’é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (target_wait)</span><br><span class="line">        wake_up_interruptible(target_wait);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯æœ‰200å¤šè¡Œâ€¦è¿™é‡Œæˆ‘ç›´æ¥åœ¨ä»£ç é‡Œé¢æ·»åŠ æ³¨é‡Šæ¥è§£æä»£ç ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬åœ¨ç›®æ ‡çº¿ç¨‹ä¸­æ’å…¥äº†ä¸€ä¸ª<code>binder_transaction</code>ï¼Œè¿™é‡Œçš„ç›®æ ‡è¿›ç¨‹å°±æ˜¯ SM è¿›ç¨‹ï¼›å¹¶åœ¨è‡ªå·±çº¿ç¨‹çš„ todo åˆ—è¡¨ä¸­æ’å…¥äº†ä¸€ä¸ª<code>binder_work</code>ç»“æ„ä½“å®ä¾‹ï¼ˆè¿™ä¸ªç»“æ„ä½“ï¼Œç­‰ä¼šå„¿ SM å›å¤çš„æ—¶å€™éœ€è¦ä½¿ç”¨ï¼‰ã€‚</p>
<p>é‡Œé¢æœ‰ä¸€ä¸ªé‡è¦å‡½æ•°ï¼Œè¿™é‡Œä¹Ÿä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œåˆ†æ:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°è§£é‡Šï¼šproc æ˜¯ç›®æ ‡è¿›ç¨‹ï¼Œè¿™é‡Œå°±æ˜¯æŒ‡ SMï¼Œnode æ˜¯æŒ‡æœåŠ¡èŠ‚ç‚¹ï¼Œè¿™é‡Œä»£æŒ‡ MS æœåŠ¡ binder èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct binder_ref *<span class="title">binder_get_ref_for_node</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                          struct binder_node *node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">n</span>;</span></span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‘</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">p</span> = &amp;<span class="title">proc</span>-&gt;<span class="title">refs_by_node</span>.<span class="title">rb_node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="comment">// è¯¥ç»“æ„ä½“å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>, *<span class="title">new_ref</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡æ¯”è¾ƒ node æ¥å¯»æ‰¾å¯¹åº”çš„ binder_ref å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">while</span> (*p) &#123;</span><br><span class="line">        parent = *p;</span><br><span class="line">        ref = rb_entry(parent, struct binder_ref, rb_node_node);</span><br><span class="line">        <span class="keyword">if</span> (node &lt; ref-&gt;node)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node &gt; ref-&gt;node)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line">    new_ref = kzalloc(<span class="keyword">sizeof</span>(*ref), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (new_ref == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    binder_stats_created(BINDER_STAT_REF);</span><br><span class="line">    new_ref-&gt;debug_id = ++binder_last_id;</span><br><span class="line">    new_ref-&gt;proc = proc;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šbinder_ref ä¸­æ˜¯ç›´æ¥æºå¸¦ node å¼•ç”¨çš„ï¼Œå› ä¸ºåœ¨é©±åŠ¨ä¸­nodeä»¥åŠå¼•ç”¨éƒ½åœ¨</span></span><br><span class="line">    <span class="comment">// åŒä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œå› æ­¤è¿™æ ·çš„èµ‹å€¼æ˜¯å¯ä»¥çš„ã€‚</span></span><br><span class="line">    new_ref-&gt;node = node;</span><br><span class="line">    rb_link_node(&amp;new_ref-&gt;rb_node_node, parent, p);</span><br><span class="line">    <span class="comment">// å°†çº¢é»‘æ ‘èŠ‚ç‚¹æ’å…¥åˆ° refs_by_node ä¸­</span></span><br><span class="line">    rb_insert_color(&amp;new_ref-&gt;rb_node_node, &amp;proc-&gt;refs_by_node);</span><br><span class="line">    new_ref-&gt;desc = (node == binder_context_mgr_node) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆdescå€¼ï¼Œå®é™…å°±æ˜¯ä¸€ä¸ª binder_node èŠ‚ç‚¹åœ¨ target_proc ä¸­çš„ handle å€¼</span></span><br><span class="line">    <span class="keyword">for</span> (n = rb_first(&amp;proc-&gt;refs_by_desc); n != <span class="literal">NULL</span>; n = rb_next(n)) &#123;</span><br><span class="line">        ref = rb_entry(n, struct binder_ref, rb_node_desc);</span><br><span class="line">        <span class="keyword">if</span> (ref-&gt;desc &gt; new_ref-&gt;desc)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        new_ref-&gt;desc = ref-&gt;desc + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çº¢é»‘æ ‘æ“ä½œ</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> new_ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸€ä¸‹è¿™ä¸€æ®µä»£ç ä¸­æœ‰å…³ binder_node å’Œ binder_ref çš„æ“ä½œï¼š</p>
<p><strong>å½“ä¸€ä¸ª<code>BC_TRANSACTION</code>å‘½ä»¤è¢«å¤„ç†çš„æ—¶å€™ï¼Œbinder é©±åŠ¨ä¼šæ ¹æ®æºå¸¦çš„å…ƒæ•°æ®è§£ææ•°æ®å†…å®¹ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ binder èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨ binder èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šæ£€æµ‹å½“å‰è¿›ç¨‹çš„<code>binder_proc</code>ç»“æ„ä½“çš„çº¢é»‘æ ‘ä¸­æ˜¯å¦å­˜åœ¨ä»£è¡¨è¯¥èŠ‚ç‚¹çš„<code>binder_node</code>ç»“æ„ä½“ï¼Œå¦‚æœæ²¡æœ‰åˆ™éœ€è¦æ–°å»ºå¹¶æ”¾åˆ°çº¢é»‘æ ‘ä¸­å»ï¼Œå…¶æ¬¡ä¼šæ£€æµ‹ç›®æ ‡è¿›ç¨‹æ˜¯å¦æœ‰å¯¹è¯¥èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦æ–°å»º<code>binder_ref</code>ç»“æ„ä½“å¹¶æŒ‚è½½åˆ°ç›®æ ‡è¿›ç¨‹çš„çº¢é»‘æ ‘ä¸­</strong>ã€‚</p>
<h3 id="ä¸-SM-æ¥å¤´"><a href="#ä¸-SM-æ¥å¤´" class="headerlink" title="ä¸ SM æ¥å¤´"></a>ä¸ SM æ¥å¤´</h3><p>åˆ—å‡ºçš„<code>binder_transaction</code>æ–¹æ³•ä»£ç çš„æœ€åå‡ å¥å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å”¤é†’é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">if</span> (target_wait)</span><br><span class="line">	wake_up_interruptible(target_wait);</span><br></pre></td></tr></table></figure>
<p>è¿˜è®°å¾—æˆ‘ä»¬åˆ†æ SM çš„æ—¶å€™ï¼Œåœ¨å¾ªç¯ç›‘å¬éƒ¨åˆ†ï¼Œå®ƒåœ¨æœ€ååšçš„æ˜¯ä»€ä¹ˆå—ï¼Ÿ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = wait_event_freezable_exclusive(proc-&gt;wait, binder_has_proc_work(proc, thread));</span><br></pre></td></tr></table></figure>
<p>ä¸€çœ‹å°±æ˜¯å¯¹åº”çš„å¥½ä¹ˆï¼ç¢°å·§ä¸Šé¢çš„ target_wait å°±æ˜¯ SM çš„ wait é˜Ÿåˆ—ï¼Œå› æ­¤<code>wake_up_interruptible</code>å°±å”¤é†’äº†æ­£åœ¨ç­‰å¾…çš„ SM æœåŠ¡ã€‚æ‰€ä»¥æˆ‘ä»¬åˆè½¬å› SMã€‚ä½†åœ¨è½¬åˆ° SM ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—çŸ¥é“ MS åé¢ä¼šåšä»€ä¹ˆï¼Ÿ</p>
<h3 id="ç­‰å¾…-SM-çš„ç­”å¤"><a href="#ç­‰å¾…-SM-çš„ç­”å¤" class="headerlink" title="ç­‰å¾… SM çš„ç­”å¤"></a>ç­‰å¾… SM çš„ç­”å¤</h3><p><code>binder_transaction</code>æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ<code>binder_thread_write</code>å‡½æ•°ä¹Ÿæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›åˆ°<code>binder_ioctl</code>å‡½æ•°ã€‚æ¥ä¸‹å»è¦æ‰§è¡Œå¦‚ä¸‹ä»£ç : </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// writeä¹‹åç´§æ¥ç€è°ƒç”¨read</span></span><br><span class="line"><span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;<span class="comment">//è¯»å–å†…å®¹</span></span><br><span class="line">	ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</span><br><span class="line">	trace_binder_read_done(ret);</span><br><span class="line">	<span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</span><br><span class="line">		wake_up_interruptible(&amp;proc-&gt;wait);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">			ret = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å†å†™å›å»</span></span><br><span class="line"><span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">	ret = -EFAULT;</span><br><span class="line">	<span class="keyword">goto</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>bwr</code> å˜é‡åœ¨ä¼ å…¥ä¹‹å‰èµ‹å€¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bwr.read_size = mIn.dataCapacity(); <span class="comment">// 256</span></span><br><span class="line">bwr.read_buffer = (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)mIn.data();</span><br><span class="line">bwr.read_consumed = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><code>bwr.read_size &gt; 0</code>è¿™ä¸ªåˆ¤æ–­æ˜¯æˆç«‹çš„ï¼Œå› æ­¤æˆ‘ä»¬è¿›å…¥<code>binder_thread_read</code>å‡½æ•°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ptr æŒ‡å‘ read_bufferçš„èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">    <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> wait_for_proc_work;</span><br><span class="line">    <span class="comment">// å…¥å‚ä¸º0ï¼Œå†™å…¥å‘½ä»¤ BR_NOOP</span></span><br><span class="line">    <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (put_user(BR_NOOP, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">    &#125;</span><br><span class="line">retry:</span><br><span class="line">    <span class="comment">// æ ¹æ®å‰é¢ binder_transaction çš„ä»£ç ï¼Œä¸¤è€…éƒ½ä¸ä¸ºç©º</span></span><br><span class="line">    wait_for_proc_work = thread-&gt;transaction_stack == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">                list_empty(&amp;thread-&gt;todo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®çŠ¶æ€ä¸ºç­‰å¾…</span></span><br><span class="line">    thread-&gt;looper |= BINDER_LOOPER_STATE_WAITING;</span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work)</span><br><span class="line">        proc-&gt;ready_threads++;</span><br><span class="line">    binder_unlock(__func__);</span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (non_block) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!binder_has_thread_work(thread))</span><br><span class="line">                ret = -EAGAIN;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="comment">// æ‰§è¡Œè¿™é‡Œï¼Œä½†æ˜¯ binder_has_thread_work è¿”å› trueï¼Œå¯ä»¥è§ä¸‹é¢å‡½æ•°çš„è§£æ</span></span><br><span class="line">            ret = wait_event_freezable(thread-&gt;wait, binder_has_thread_work(thread));</span><br><span class="line">    &#125;</span><br><span class="line">    binder_lock(__func__);</span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work)</span><br><span class="line">        proc-&gt;ready_threads--;</span><br><span class="line">    thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_WAITING;</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo)) <span class="comment">// æ­¤æ—¶ä¸ä¸ºç©ºï¼Œè¿™é‡Œä¼šå–ä¸€ä¸ª binder_work å‡ºæ¥ï¼Œä¹‹åå˜ä¸ºç©º</span></span><br><span class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo) &amp;&amp; wait_for_proc_work)</span><br><span class="line">            w = list_first_entry(&amp;proc-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ptr - buffer == <span class="number">4</span> &amp;&amp; !(thread-&gt;looper &amp; BINDER_LOOPER_STATE_NEED_RETURN)) <span class="comment">/* no data added */</span></span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (end - ptr &lt; <span class="keyword">sizeof</span>(tr) + <span class="number">4</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION_COMPLETE: &#123; <span class="comment">// å¯ä»¥çœ‹ binder_transaction å‡½æ•°</span></span><br><span class="line">            cmd = BR_TRANSACTION_COMPLETE;</span><br><span class="line">            <span class="comment">// åˆå†™å…¥ä¸€ä¸ªæ–°çš„å‘½ä»¤ï¼šBR_TRANSACTION_COMPLETE</span></span><br><span class="line">            <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">            binder_stat_br(proc, thread, cmd);</span><br><span class="line">            <span class="comment">// èµ„æºé‡Šæ”¾</span></span><br><span class="line">            list_del(&amp;w-&gt;entry);</span><br><span class="line">            kfree(w);</span><br><span class="line">            binder_stats_deleted(BINDER_STAT_TRANSACTION_COMPLETE);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!t)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›¸å…³ä»£ç è§£æå·²ç»å†™ä½œä»£ç æ³¨é‡Šï¼Œå¯ä»¥çœ‹åˆ°å®ƒå¾€<code>bwr</code>ä¸­å‚æ•°å†™å…¥äº†ä¸¤ä¸ªå‘½ä»¤ï¼š<code>BR_NOOP</code>å’Œ<code>BR_TRANSACTION_COMPLETE</code>ï¼Œæ¥ç€è¿”å›åˆ°<code>binder_ioctl</code>å‡½æ•°ï¼Œæ‰§è¡Œ:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">	ret = -EFAULT;</span><br><span class="line">	<span class="keyword">goto</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†æ•°æ®åˆå†™å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œåœ¨ç”¨æˆ·ç©ºé—´ç­‰å¾…çš„ï¼Œè‡ªç„¶æ˜¯<code>IPCThreadState::talkWithDriver()</code>æ–¹æ³•ä¸­çš„å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (err &gt;= NO_ERROR) &#123;</span><br><span class="line">	<span class="keyword">if</span> (bwr.write_consumed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (bwr.write_consumed &lt; (<span class="keyword">ssize_t</span>)mOut.dataSize())</span><br><span class="line">			mOut.remove(<span class="number">0</span>, bwr.write_consumed);</span><br><span class="line">		<span class="keyword">else</span> <span class="comment">// å†™å…¥æ•°æ®å…¨éƒ¨è¯»å–å®Œæ¯•ï¼Œæ¸…é›¶</span></span><br><span class="line">			mOut.setDataSize(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (bwr.read_consumed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// è®¾ç½®æ•°æ®æ‰€åœ¨èŒƒå›´</span></span><br><span class="line">		mIn.setDataSize(bwr.read_consumed);</span><br><span class="line">		mIn.setDataPosition(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦æ˜¯æ•°æ®æ¸…ç†ä»¥åŠæ ‡è®°æœ‰æ•ˆæ•°æ®å­˜å‚¨åœ¨ mIn ä¸­çš„ä»€ä¹ˆä½ç½®ï¼Œè¿™é‡Œçš„æœ‰æ•ˆæ•°æ®å°±æ˜¯ä¸¤ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå°±åˆå›åˆ°äº†<code>IPCThreadState::waitForResponse</code>æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::waitForResponse(Parcel *reply, <span class="keyword">status_t</span> *acquireResult)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> cmd;</span><br><span class="line">    <span class="keyword">int32_t</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err=talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        err = mIn.errorCheck();</span><br><span class="line">        <span class="keyword">if</span> (err &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (mIn.dataAvail() == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        cmd = mIn.readInt32();</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION_COMPLETE:</span><br><span class="line">            <span class="keyword">if</span> (!reply &amp;&amp; !acquireResult) <span class="keyword">goto</span> finish;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            err = executeCommand(cmd); <span class="comment">// æ‰§è¡Œ executeCommand æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> (err != NO_ERROR) <span class="keyword">goto</span> finish;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">finish:</span><br><span class="line">    <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (acquireResult) *acquireResult = err;</span><br><span class="line">        <span class="keyword">if</span> (reply) reply-&gt;setError(err);</span><br><span class="line">        mLastError = err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::executeCommand(<span class="keyword">int32_t</span> cmd)</span><br><span class="line">&#123;</span><br><span class="line">    BBinder* obj;</span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> BR_NOOP: <span class="comment">// ä¸åšä»»ä½•å¤„ç†</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶å€™ mIn ç¬¬ä¸€ä¸ªè¯»å‡ºçš„å‘½ä»¤æ˜¯ <code>BR_NOOP</code>ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚<code>while</code>å¾ªç¯ç»§ç»­æ‰§è¡Œï¼Œæ‰§è¡Œçš„æ—¶å€™å‡ºç°äº†ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿåˆè¿›å…¥äº†<code>IPCThreadState::talkWithDriver()</code>ï¼šï¼ˆPSï¼šåˆå¾—èµ°ä¸€éï¼Ÿï¼‰</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// doReceive é»˜è®¤ä¸º true</span></span><br><span class="line"><span class="keyword">status_t</span> IPCThreadState::talkWithDriver(<span class="keyword">bool</span> doReceive)</span><br><span class="line">&#123;</span><br><span class="line">	binder_write_read bwr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Is the read buffer empty?</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> needRead = mIn.dataPosition() &gt;= mIn.dataSize();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We don't want to write anything if we are still reading</span></span><br><span class="line">    <span class="comment">// from data left in the input buffer and the caller</span></span><br><span class="line">    <span class="comment">// has requested to read the next data.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.dataSize() : <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    bwr.write_size = outAvail;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)mOut.data();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is what we'll read.</span></span><br><span class="line">    <span class="keyword">if</span> (doReceive &amp;&amp; needRead) &#123;</span><br><span class="line">        bwr.read_size = mIn.dataCapacity();</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)mIn.data();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// èµ°è¿™é‡Œ</span></span><br><span class="line">        bwr.read_size = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Return immediately if there is nothing to do.</span></span><br><span class="line">    <span class="keyword">if</span> ((bwr.write_size == <span class="number">0</span>) &amp;&amp; (bwr.read_size == <span class="number">0</span>)) <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mIn çš„æ•°æ®åœ¨é©±åŠ¨å±‚è¿”å›çš„æ—¶å€™è®¾ç½®è¿‡ä¸€æ¬¡ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mIn.setDataSize(bwr.read_consumed);</span><br><span class="line">mIn.setDataPosition(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>dataPosition ä»£è¡¨æœ‰æ•ˆæ•°æ®çš„èµ·å§‹ç‚¹ï¼ŒdataSize ä»£è¡¨æ•°æ®çš„å¤§å°ï¼Œå‰é¢è¯´è¿‡è¿™ä¸ªæ—¶å€™æ•°æ®åŒ…å«ä¸¤ä¸ªå‘½ä»¤ï¼Œç°åœ¨åªè¯»å–äº†ä¸€ä¸ªï¼Œè¿˜å‰©ä¸€ä¸ªï¼Œå› æ­¤<code>mIn.dataPosition() &lt; mIn.dataSize()</code>ï¼Œå› æ­¤<code>needRead</code>ä¸ºfalseï¼Œ<code>doReceive</code>ä¸ºfalseï¼Œå› æ­¤ outAvail æ˜¯ 0ï¼Œé‚£ä¹ˆ <code>(bwr.write_size == 0) &amp;&amp; (bwr.read_size == 0)</code>æˆç«‹ï¼Œç›´æ¥è¿”å› <code>NO_ERROR</code>ã€‚</p>
<p>å¥½äº†ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰èµ°çš„å¾ˆæ·±å…¥ï¼Œæˆ‘ä»¬åˆå›åˆ°<code>IPCThreadState::waitForResponse</code>æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::waitForResponse(Parcel *reply, <span class="keyword">status_t</span> *acquireResult)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> cmd;</span><br><span class="line">    <span class="keyword">int32_t</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err=talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        err = mIn.errorCheck();</span><br><span class="line">        <span class="keyword">if</span> (err &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (mIn.dataAvail() == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        cmd = mIn.readInt32();</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION_COMPLETE:</span><br><span class="line">        	<span class="comment">// reply æ˜¯ä¼ è¿›æ¥çš„ï¼Œè¿™é‡Œåªæ˜¯breakï¼Œå¾ªç¯ç»§ç»­</span></span><br><span class="line">            <span class="keyword">if</span> (!reply &amp;&amp; !acquireResult) <span class="keyword">goto</span> finish;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">finish:</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤è¯»å®Œå•¦ï¼Œç¬¬ä¸‰æ¬¡è¿›å…¥<code>talkWithDriver()</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> IPCThreadState::talkWithDriver(<span class="keyword">bool</span> doReceive)</span><br><span class="line">&#123;</span><br><span class="line">    LOG_ASSERT(mProcess-&gt;mDriverFD &gt;= <span class="number">0</span>, <span class="string">"Binder driver is not opened"</span>);</span><br><span class="line">    </span><br><span class="line">    binder_write_read bwr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Is the read buffer empty?</span></span><br><span class="line">    <span class="comment">// ä¸º trueï¼Œç»è¿‡ä¸¤è½®å¾ªç¯ä¹‹åï¼ŒmIn ä¸­çš„æ•°æ®å·²ç»è¯»å–å®Œæ¯•</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> needRead = mIn.dataPosition() &gt;= mIn.dataSize();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We don't want to write anything if we are still reading</span></span><br><span class="line">    <span class="comment">// from data left in the input buffer and the caller</span></span><br><span class="line">    <span class="comment">// has requested to read the next data.</span></span><br><span class="line">    <span class="comment">// mOut å‰é¢å·²ç»è¢«æ¸…é›¶ï¼Œå› æ­¤ outAvail ä¸º 0</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.dataSize() : <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    bwr.write_size = outAvail;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)mOut.data();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is what we'll read.</span></span><br><span class="line">    <span class="keyword">if</span> (doReceive &amp;&amp; needRead) &#123;</span><br><span class="line">        bwr.read_size = mIn.dataCapacity(); <span class="comment">// ä¸ä¸º 0</span></span><br><span class="line">        bwr.read_buffer = (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)mIn.data();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bwr.read_size = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return immediately if there is nothing to do.</span></span><br><span class="line">    <span class="keyword">if</span> ((bwr.write_size == <span class="number">0</span>) &amp;&amp; (bwr.read_size == <span class="number">0</span>)) <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// è¿›å…¥binderé©±åŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</span><br><span class="line">            err = NO_ERROR;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            err = -errno;</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == -EINTR);</span><br><span class="line"></span><br><span class="line">    .....</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç æ³¨é‡Šå¦‚ä¸Šï¼Œä¸å¤šè§£é‡Šï¼Œå’±åˆè¿›å…¥é©±åŠ¨å±‚äº†ï¼Œå› ä¸ºåªæœ‰<code>bwr.read_size</code>å¤§äº0ï¼Œå› æ­¤ç›´æ¥è¿›å…¥å‡½æ•°<code>binder_thread_read</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">signed</span> <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</span><br><span class="line">    <span class="keyword">void</span> __user *end = buffer + size;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> wait_for_proc_work;</span><br><span class="line">    <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123; <span class="comment">// åŒæ ·æ»´ï¼Œè¿™é‡Œè¿˜æ˜¯ 0</span></span><br><span class="line">        <span class="keyword">if</span> (put_user(BR_NOOP, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">    &#125;</span><br><span class="line">retry:</span><br><span class="line">    <span class="comment">// thread-&gt;transaction_stack ä¸ä¸ºç©ºï¼Œ&amp;thread-&gt;todo ä¸ºç©ºï¼Œå› æ­¤ wait_for_proc_work ä¸º false</span></span><br><span class="line">    wait_for_proc_work = thread-&gt;transaction_stack == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">                list_empty(&amp;thread-&gt;todo);</span><br><span class="line">    <span class="comment">//è®¾ç½®çŠ¶æ€ä¸ºç­‰å¾…</span></span><br><span class="line">    thread-&gt;looper |= BINDER_LOOPER_STATE_WAITING;</span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work)</span><br><span class="line">        proc-&gt;ready_threads++;</span><br><span class="line">    binder_unlock(__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wait_for_proc_work) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (non_block) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!binder_has_thread_work(thread))</span><br><span class="line">                ret = -EAGAIN;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œè¿™æ—¶å€™ thread çš„ todo åˆ—è¡¨ä¸ºç©ºï¼Œé˜»å¡</span></span><br><span class="line">            ret = wait_event_freezable(thread-&gt;wait, binder_has_thread_work(thread));</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œæœ€ç»ˆé˜»å¡åœ¨äº†<code>thread</code>çš„<code>todo</code>é˜Ÿåˆ—ä¸Šã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒMediaPlayerService åœ¨å‘èµ·ä¸€ä¸ªæ³¨å†Œè¯·æ±‚çš„åŒæ—¶ï¼Œé€šè¿‡å‘è‡ªå·±å½“å‰çº¿ç¨‹çš„<code>todo</code>é˜Ÿåˆ—ä¸ŠæŒ‚è½½ binder_work å¯¹è±¡ï¼Œå¯ä»¥å¾ˆé¡ºåˆ©çš„å‘ Libraries å±‚å‘é€æ¶ˆæ¯ã€‚è€Œ Libraries æ­¤æ—¶å¤„äºä¸€ä¸ªå¾ªç¯è¯»å–æ•°æ®çš„çŠ¶æ€ï¼Œåœ¨æ²¡æœ‰æ•°æ®å¯ä»¥è¯»å–çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šè¢«é˜»å¡ä½ï¼Œç›´åˆ°<code>todo</code>å†æ¬¡ä¸ä¸ºç©ºã€‚</p>
<h2 id="SM-çš„å¤„ç†"><a href="#SM-çš„å¤„ç†" class="headerlink" title="SM çš„å¤„ç†"></a>SM çš„å¤„ç†</h2><p>å¼€å§‹è¿™ä¸€èŠ‚ä¹‹å‰ï¼Œè¯»è€…å¯ä»¥å›é¡¾ä¸€ä¸‹æ–‡ç«  <a href="http://www.muzileecoding.com/framework/binder-servicemanager.html" target="_blank" rel="noopener">Binderä¹‹Service Manager</a> çš„ 5.3 å’Œ 5.4 å°èŠ‚ã€‚</p>
<p><strong>ã€æ³¨æ„ã€‘</strong> ä¸‹é¢çš„å‡½æ•°å’Œå‰é¢çš„åˆ†æå¾ˆç±»ä¼¼ï¼Œä½†æ˜¯éƒ½æ˜¯è¿è¡Œåœ¨ SM è¿›ç¨‹ä¸­çš„ï¼Œåƒä¸‡ä¸è¦æ··æ·†äº†ï¼</p>
<p>é¦–å…ˆè¿™é‡Œæ˜¯å› ä¸ºæ¡ä»¶ç¬¦åˆæ‰è¿”å›çš„ï¼Œå› æ­¤ä¼šèµ°åˆ°<code>binder_thread_read</code>å‡½æ•°çš„<code>while</code>å¾ªç¯ä¸­å»:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo))</span><br><span class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo) &amp;&amp; wait_for_proc_work)</span><br><span class="line">            w = list_first_entry(&amp;proc-&gt;todo, struct binder_work, entry);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ptr - buffer == <span class="number">4</span> &amp;&amp; !(thread-&gt;looper &amp; BINDER_LOOPER_STATE_NEED_RETURN)) <span class="comment">/* no data added */</span></span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (end - ptr &lt; <span class="keyword">sizeof</span>(tr) + <span class="number">4</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸åŒçš„ work ç±»å‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">	        <span class="keyword">case</span> BINDER_WORK_TRANSACTION: &#123;</span><br><span class="line">	        t = container_of(w, struct binder_transaction, work);</span><br><span class="line">	        &#125;<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä» thread/proc çš„<code>todo</code>é˜Ÿåˆ—ä¸­è·å– binder_work æ¥è¿›è¡Œå¤„ç†ï¼Œä»¥ä¸‹æ˜¯æ ¹æ®ä¸åŒçš„ work ç±»å‹è¿›è¡Œå¤„ç†ï¼Œå‰é¢æ’å…¥ binder_work çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t-&gt;work æ˜¯ binder_work ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥è¯¢</span></span><br><span class="line">t-&gt;work.type = BINDER_WORK_TRANSACTION;</span><br><span class="line"><span class="comment">// æ·»åŠ  t åˆ°ç›®æ ‡è¿›ç¨‹çš„todo listä¸­å»</span></span><br><span class="line">list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ç±»å‹æ˜¯â€BINDER_WORK_TRANSACTIONâ€ï¼Œæ‰€ä»¥æ¥ç€è°ƒç”¨<code>container_of</code>æ–¹æ³•è·å– tï¼Œå³ binder_transaction å¯¹è±¡ã€‚</p>
<blockquote>
<p><code>container_of</code>çš„ä½œç”¨ï¼šæ ¹æ®ç»“æ„ä½“çš„æˆå‘˜å˜é‡è·å–æ‰€åœ¨ç»“æ„ä½“çš„é¦–åœ°å€ã€‚</p>
<p>ä»£ç é‡Œé¢è—ç€å¾ˆå¤šè¿™æ ·çš„å‡½æ•°/å® â€”â€” å¼ºå¤§ä½†æ˜¯å¾ˆä¸å¥½é˜…è¯»ã€‚</p>
</blockquote>
<p>è·å–åˆ° binder_transaction å¯¹è±¡ä¹‹åï¼Œå‰©ä¸‹çš„å°±æ˜¯è§£æäº†:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tr æ˜¯ binder_transaction_data ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">w</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!t)<span class="comment">// é€šè¿‡</span></span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// èµ‹å€¼ï¼št-&gt;buffer-&gt;target_node = target_node; </span></span><br><span class="line"> <span class="comment">// å› æ­¤æ¡ä»¶æˆç«‹ï¼Œä¸”target_nodeæŒ‡å‘çš„æ˜¯ binder_context_mgr_node</span></span><br><span class="line"><span class="keyword">if</span> (t-&gt;buffer-&gt;target_node) &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">t</span>-&gt;<span class="title">buffer</span>-&gt;<span class="title">target_node</span>;</span></span><br><span class="line">	<span class="comment">// tr æ˜¯ binder_transaction_data ç±»å‹ï¼Œè¿˜è®°å¾—targetè¿™ä¸¤ä¸ªå˜é‡çš„å€¼ä¹ˆï¼Ÿ</span></span><br><span class="line">	tr.target.ptr = target_node-&gt;ptr;</span><br><span class="line">	tr.cookie =  target_node-&gt;cookie;</span><br><span class="line">	t-&gt;saved_priority = task_nice(current);</span><br><span class="line">	<span class="keyword">if</span> (t-&gt;priority &lt; target_node-&gt;min_priority &amp;&amp; !(t-&gt;flags &amp; TF_ONE_WAY))</span><br><span class="line">		binder_set_nice(t-&gt;priority);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY) || t-&gt;saved_priority &gt; target_node-&gt;min_priority)</span><br><span class="line">		binder_set_nice(target_node-&gt;min_priority);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//æ³¨æ„è¿™ä¸ªå‘½ä»¤çš„èµ‹å€¼</span></span><br><span class="line">	cmd = BR_TRANSACTION;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	tr.target.ptr = <span class="literal">NULL</span>;</span><br><span class="line">	tr.cookie = <span class="literal">NULL</span>;</span><br><span class="line">	cmd = BR_REPLY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tr.code = t-&gt;code;</span><br><span class="line">tr.flags = t-&gt;flags;</span><br><span class="line">tr.sender_euid = t-&gt;sender_euid;</span><br><span class="line"><span class="keyword">if</span> (t-&gt;from) &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">sender</span> = <span class="title">t</span>-&gt;<span class="title">from</span>-&gt;<span class="title">proc</span>-&gt;<span class="title">tsk</span>;</span></span><br><span class="line">	tr.sender_pid = task_tgid_nr_ns(sender, current-&gt;nsproxy-&gt;pid_ns);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	tr.sender_pid = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">tr.data_size = t-&gt;buffer-&gt;data_size;</span><br><span class="line">tr.offsets_size = t-&gt;buffer-&gt;offsets_size;</span><br><span class="line"><span class="comment">// æ ¹æ®è€ç½—çš„æ–‡ç« ï¼šè¿™é‡Œæ­£æ˜¯ binder æœºåˆ¶çš„ç²¾é«“ï¼Œå³å¦‚ä½•åšåˆ°å¤åˆ¶ä¸€æ¬¡çš„ã€‚</span></span><br><span class="line">tr.data.ptr.buffer = (<span class="keyword">void</span> *)t-&gt;buffer-&gt;data +  proc-&gt;user_buffer_offset;</span><br><span class="line">tr.data.ptr.offsets = tr.data.ptr.buffer + ALIGN(t-&gt;buffer-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line"></span><br><span class="line"><span class="comment">// @readæ•°æ®@ ä¸‹é¢å°±æ˜¯æŠŠcmd å’Œ tr ç»“æ„ä½“ copy åˆ°ç”¨æˆ·ç©ºé—´ï¼Œcmd = BR_TRANSACTION;</span></span><br><span class="line"><span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr))</span><br><span class="line">	<span class="keyword">return</span> -EFAULT;</span><br><span class="line">ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (copy_to_user(ptr, &amp;tr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">	<span class="keyword">return</span> -EFAULT;</span><br><span class="line">ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line"></span><br><span class="line">trace_binder_transaction_received(t);</span><br><span class="line">binder_stat_br(proc, thread, cmd);</span><br><span class="line"><span class="comment">// å¤„ç†å®Œæ¯•ï¼Œåˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">list_del(&amp;t-&gt;work.entry);</span><br><span class="line">t-&gt;buffer-&gt;allow_user_free = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ·»åŠ æœåŠ¡çš„æ—¶å€™æ˜¯éœ€è¦å›å¤çš„ï¼Œè¿™é‡Œåˆ¤æ–­æˆç«‹</span></span><br><span class="line"><span class="keyword">if</span> (cmd == BR_TRANSACTION &amp;&amp; !(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">	t-&gt;to_parent = thread-&gt;transaction_stack;</span><br><span class="line">	t-&gt;to_thread = thread;</span><br><span class="line">	thread-&gt;transaction_stack = t; <span class="comment">// æ”¾åˆ°æ ˆé¡¶ </span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	t-&gt;buffer-&gt;transaction = <span class="literal">NULL</span>;</span><br><span class="line">	kfree(t);</span><br><span class="line">	binder_stats_deleted(BINDER_STAT_TRANSACTION);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·³å‡ºå¾ªç¯</span></span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>ç›¸å…³è§£æéƒ½åœ¨æ³¨é‡Šä¸­ï¼Œä¹‹å‰ä¼ è¿‡æ¥çš„æ•°æ®éƒ½è¢«æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ä¸­å»äº†ï¼Œä¹‹åå°±è·³å‡ºå¾ªç¯ï¼Œå›åˆ°<code>binder_ioctl()</code>å‡½æ•°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size = _IOC_SIZE(cmd);</span><br><span class="line">    <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (size != <span class="keyword">sizeof</span>(struct binder_write_read)) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</span><br><span class="line">            trace_binder_write_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        	<span class="comment">// æ•°æ®éƒ½è¢«æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´äº†</span></span><br><span class="line">            ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</span><br><span class="line">            trace_binder_read_done(ret);</span><br><span class="line">            <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</span><br><span class="line">                wake_up_interruptible(&amp;proc-&gt;wait);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr)))</span><br><span class="line">                    ret = -EFAULT;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å†æ¬¡æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´</span></span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, <span class="keyword">sizeof</span>(bwr))) &#123;</span><br><span class="line">            ret = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œæ‰€æœ‰çš„æ•°æ®é¡ºåˆ©ä¼ è¾“åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼Œåœ¨ç”¨æˆ·ç©ºé—´ç­‰å¾…å®ƒçš„æ˜¯<code>binder_loop()</code>å‡½æ•°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">binder_loop</span><span class="params">(struct binder_state *bs, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> readbuf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    bwr.write_size = <span class="number">0</span>;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    readbuf[<span class="number">0</span>] = BC_ENTER_LOOPER;</span><br><span class="line">    <span class="comment">//å‘Šè¯‰Binderé©±åŠ¨ç¨‹åºï¼Œ Service Managerè¦è¿›å…¥å¾ªç¯äº†</span></span><br><span class="line">    binder_write(bs, readbuf, <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        bwr.read_size = <span class="keyword">sizeof</span>(readbuf);</span><br><span class="line">        bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">        bwr.read_buffer = (<span class="keyword">unsigned</span>) readbuf;</span><br><span class="line"></span><br><span class="line">        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"binder_loop: ioctl failed (%s)\n"</span>, strerror(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = binder_parse(bs, <span class="number">0</span>, readbuf, bwr.read_consumed, func);</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">0</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"binder_loop: unexpected reply?!\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOGE(<span class="string">"binder_loop: io error %d %s\n"</span>, res, strerror(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>ioctl()</code>è¿”å›ä¹‹åï¼Œè°ƒç”¨çš„å°±æ˜¯<code>binder_parse()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥å¤„ç†å¾ˆå¤šçš„å‘½ä»¤ï¼Œæˆ‘ä»¬å°±çœ‹ç›¸å…³éƒ¨åˆ†:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_parse</span><span class="params">(struct binder_state *bs, struct binder_io *bio,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">uint32_t</span> *ptr, <span class="keyword">uint32_t</span> size, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> *end = ptr + (size / <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd = *ptr++;</span><br><span class="line">        <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">            ......</span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION: &#123;</span><br><span class="line">        	<span class="comment">//è¯¥ç»“æ„ä½“å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_txn</span> *<span class="title">txn</span> = (<span class="title">void</span> *) <span class="title">ptr</span>;</span></span><br><span class="line">            <span class="keyword">if</span> ((end - ptr) * <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>) &lt; <span class="keyword">sizeof</span>(struct binder_txn)) &#123;</span><br><span class="line">                LOGE(<span class="string">"parse: txn too small!\n"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            binder_dump_txn(txn);</span><br><span class="line">            <span class="keyword">if</span> (func) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> rdata[<span class="number">256</span>/<span class="number">4</span>];</span><br><span class="line">                <span class="comment">// è¯¥ç»“æ„ä½“å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">msg</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">reply</span>;</span></span><br><span class="line">                <span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">                bio_init(&amp;reply, rdata, <span class="keyword">sizeof</span>(rdata), <span class="number">4</span>);</span><br><span class="line">                bio_init_from_txn(&amp;msg, txn);</span><br><span class="line">                res = func(bs, txn, &amp;msg, &amp;reply);</span><br><span class="line">                binder_send_reply(bs, &amp;reply, txn-&gt;data, res);</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(*txn) / <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¯»å‡ºæ¥çš„å‘½ä»¤å°±æ˜¯<code>BR_TRANSACTION</code>ï¼Œç„¶åå°†æ•°æ®éƒ¨åˆ†ï¼ˆä¸€ä¸ª binder_transaction_data ç»“æ„ä½“ï¼Œè¯»è€…å¯ä»¥æœâ€@readæ•°æ®@â€å®šä½ï¼‰è§£ææˆ<code>binder_txn</code>ç»“æ„ä½“(å¯¹æ¯”ç»“æ„ä½“å­—æ®µå°±å¯ä»¥çŸ¥é“è½¬æ¢ç¡®å®å¯è¡Œ)ã€‚æ¥ç€æ˜¯å£°æ˜äº†ä¸¤ä¸ª binder_io ç»“æ„ä½“ï¼Œåœ¨å­—å…¸ä¸­å¯æŸ¥ã€‚åœ¨è¿™é‡Œè¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¹Ÿä¸€å¹¶åˆ—ä¸¾ä¸€ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bio_init_from_txn</span><span class="params">(struct binder_io *bio, struct binder_txn *txn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bio-&gt;data = bio-&gt;data0 = txn-&gt;data;</span><br><span class="line">    bio-&gt;offs = bio-&gt;offs0 = txn-&gt;offs;</span><br><span class="line">    bio-&gt;data_avail = txn-&gt;data_size;</span><br><span class="line">    bio-&gt;offs_avail = txn-&gt;offs_size / <span class="number">4</span>;</span><br><span class="line">    bio-&gt;flags = BIO_F_SHARED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bio_init</span><span class="params">(struct binder_io *bio, <span class="keyword">void</span> *data,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">uint32_t</span> maxdata, <span class="keyword">uint32_t</span> maxoffs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> n = maxoffs * <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &gt; maxdata) &#123;</span><br><span class="line">        bio-&gt;flags = BIO_F_OVERFLOW;</span><br><span class="line">        bio-&gt;data_avail = <span class="number">0</span>;</span><br><span class="line">        bio-&gt;offs_avail = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bio-&gt;data = bio-&gt;data0 = data + n;</span><br><span class="line">    bio-&gt;offs = bio-&gt;offs0 = data;</span><br><span class="line">    bio-&gt;data_avail = maxdata - n;</span><br><span class="line">    bio-&gt;offs_avail = maxoffs;</span><br><span class="line">    bio-&gt;flags = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ä½“åœ¨è¿™é‡Œè§£é‡Šçš„æ„ä¹‰ä¸å¤§ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« <a href="http://www.muzileecoding.com/framework/binder-service-lookup.html" target="_blank" rel="noopener">Binderä¹‹ServiceæŸ¥è¯¢</a>ä¸­æœ‰è¾ƒè¯¦ç»†çš„è§£é‡Šã€‚</p>
<p>æœ€åè°ƒç”¨funcæ¥å¤„ç†å‘½ä»¤ï¼Œfuncæ˜¯ä» SM çš„<code>main</code>å‡½æ•°ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œå®ƒçœŸå®çš„æŒ‡å‘æ˜¯<code>svcmgr_handler</code>å‡½æ•°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> svcmgr_id[] = &#123; </span><br><span class="line">    <span class="string">'a'</span>,<span class="string">'n'</span>,<span class="string">'d'</span>,<span class="string">'r'</span>,<span class="string">'o'</span>,<span class="string">'i'</span>,<span class="string">'d'</span>,<span class="string">'.'</span>,<span class="string">'o'</span>,<span class="string">'s'</span>,<span class="string">'.'</span>,</span><br><span class="line">    <span class="string">'I'</span>,<span class="string">'S'</span>,<span class="string">'e'</span>,<span class="string">'r'</span>,<span class="string">'v'</span>,<span class="string">'i'</span>,<span class="string">'c'</span>,<span class="string">'e'</span>,<span class="string">'M'</span>,<span class="string">'a'</span>,<span class="string">'n'</span>,<span class="string">'a'</span>,<span class="string">'g'</span>,<span class="string">'e'</span>,<span class="string">'r'</span> </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">svcmgr_handler</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_txn *txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_io *msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_io *reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> *s;</span><br><span class="line">    <span class="keyword">unsigned</span> len;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">    <span class="keyword">uint32_t</span> strict_policy;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// svcmgr_handle è¢«èµ‹å€¼ä¸º svcmgrï¼Œå³BINDER_SERVICE_MANAGERï¼Œå³0</span></span><br><span class="line">    <span class="keyword">if</span> (txn-&gt;target != svcmgr_handle)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Equivalent to Parcel::enforceInterface(), reading the RPC</span></span><br><span class="line">    <span class="comment">// header with the strict mode policy mask and the interface name.</span></span><br><span class="line">    <span class="comment">// Note that we ignore the strict_policy and don't propagate it</span></span><br><span class="line">    <span class="comment">// further (since we do no outbound RPCs anyway).</span></span><br><span class="line">    strict_policy = bio_get_uint32(msg);</span><br><span class="line">    s = bio_get_string16(msg, &amp;len);</span><br><span class="line">    <span class="comment">// svcmgr_idæ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œè§æœ€ä¸Šé¢ï¼Œè¿™é‡Œåˆ¤æ–­æ˜¯é€šè¿‡çš„ï¼Œå› ä¸ºsè¯»å–å‡ºæ¥å°±æ˜¯"android.os.IServiceManager"</span></span><br><span class="line">    <span class="keyword">if</span> ((len != (<span class="keyword">sizeof</span>(svcmgr_id) / <span class="number">2</span>)) ||</span><br><span class="line">        <span class="built_in">memcmp</span>(svcmgr_id, s, <span class="keyword">sizeof</span>(svcmgr_id))) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"invalid id %s\n"</span>, str8(s));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(txn-&gt;code) &#123;</span><br><span class="line">		......</span><br><span class="line">    <span class="keyword">case</span> SVC_MGR_ADD_SERVICE:</span><br><span class="line">        s = bio_get_string16(msg, &amp;len); <span class="comment">// "media.player"</span></span><br><span class="line">        ptr = bio_get_ref(msg);</span><br><span class="line">        <span class="keyword">if</span> (do_add_service(bs, s, len, ptr, txn-&gt;sender_euid))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">	</span><br><span class="line">		......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bio_put_uint32(reply, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ code æœ€åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¯»è€…å¾€ä¸Šç¿»ç¿»å°±çŸ¥é“æ˜¯<code>ADD_SERVICE_TRANSACTION</code>ï¼Œå®ƒæ˜¯å®šä¹‰åœ¨ â€œIServiceManager.hâ€ ä¸­çš„ä¸€ä¸ªæšä¸¾å€¼ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">	GET_SERVICE_TRANSACTION = IBinder::FIRST_CALL_TRANSACTION,</span><br><span class="line">	CHECK_SERVICE_TRANSACTION,</span><br><span class="line">	ADD_SERVICE_TRANSACTION,</span><br><span class="line">	LIST_SERVICES_TRANSACTION,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>IBinder::FIRST_CALL_TRANSACTION</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š<code>FIRST_CALL_TRANSACTION  = 0x00000001</code>ï¼Œå³1ï¼Œé‚£ä¹ˆADD_SERVICE_TRANSACTIONå°±æ˜¯ 3ã€‚è€Œè¿™é‡Œ code çš„å‡ ä¸ªå¯èƒ½å€¼ç±»å‹ä¹Ÿæ˜¯æšä¸¾å€¼ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    SVC_MGR_GET_SERVICE = <span class="number">1</span>,</span><br><span class="line">    SVC_MGR_CHECK_SERVICE,</span><br><span class="line">    SVC_MGR_ADD_SERVICE,</span><br><span class="line">    SVC_MGR_LIST_SERVICES,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ï¼Œ<code>SVC_MGR_ADD_SERVICE</code>çš„å€¼ä¹Ÿæ˜¯ 3ï¼Œå³æ‰§è¡Œè¯¥ caseã€‚ä»ä»£ç çœ‹åº”è¯¥æ­£å¥½æœ‰å››å¥æ•°æ®è¯»å–ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">strict_policy = bio_get_uint32(msg); <span class="comment">// è¯»å– StrictModePolicyï¼Œä¸€ä¸ªintå€¼</span></span><br><span class="line">s = bio_get_string16(msg, &amp;len); <span class="comment">// â€œandroid.os.IServiceManagerâ€</span></span><br><span class="line">s = bio_get_string16(msg, &amp;len);</span><br><span class="line">ptr = bio_get_ref(msg);</span><br></pre></td></tr></table></figure>
<p>è¿˜è®°å¾—æœåŠ¡æ³¨å†Œåˆå§‹æ•°æ®å›¾ä¹ˆï¼Ÿå®ƒæ­£å¥½ä¹Ÿæ˜¯å››ä¸ªéƒ¨åˆ†ï¼Œä¸è¿™é‡Œæ˜¯ä¸€ä¸€å¯¹åº”ï¼Œè¿™éƒ¨åˆ†æ•°æ®ä»ä¸€å¼€å§‹çš„åˆ†æå°±å‡ºç°äº†ï¼Œä¸€ç›´åˆ°ç°åœ¨æ‰å¼€å§‹è§£æï¼Œè°ƒç”¨é“¾æé•¿ã€‚ç¬¬å››ä¸ªå˜é‡è¿˜éœ€è¦çœ‹ä¸€ä¸‹æ–¹æ³•<code>bio_get_ref</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">bio_get_ref</span><span class="params">(struct binder_io *bio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_object</span> *<span class="title">obj</span>;</span></span><br><span class="line"></span><br><span class="line">    obj = _bio_get_obj(bio);</span><br><span class="line">    <span class="keyword">if</span> (!obj)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;type == BINDER_TYPE_HANDLE)</span><br><span class="line">        <span class="keyword">return</span> obj-&gt;pointer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">binder_object</span> *_<span class="title">bio_get_obj</span>(<span class="title">struct</span> <span class="title">binder_io</span> *<span class="title">bio</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> n;</span><br><span class="line">    <span class="keyword">unsigned</span> off = bio-&gt;data - bio-&gt;data0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; bio-&gt;offs_avail; n++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bio-&gt;offs[n] == off)</span><br><span class="line">        	<span class="comment">//è·å– binder_object å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">return</span> bio_get(bio, <span class="keyword">sizeof</span>(struct binder_object));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bio-&gt;data_avail = <span class="number">0</span>;</span><br><span class="line">    bio-&gt;flags |= BIO_F_OVERFLOW;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¿˜æ˜¯å¾—çœ‹æœåŠ¡æ³¨å†Œåˆå§‹æ•°æ®å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/serviceæ³¨å†Œtransactæ•°æ®.png" width="600" alt="serviceæ³¨å†Œtransactæ•°æ®"></div>

<p>å®é™…ä¸Šæˆ‘ä»¬åœ¨è¿™ä¸ªä½ç½®å­˜å‚¨çš„å¯¹è±¡å¹¶ä¸æ˜¯ binder_object ç»“æ„ä½“ï¼Œè€Œæ˜¯ flat_binder_object ç»“æ„ä½“ï¼Œä½†æ˜¯å­—æ®µä¸Šçœ‹ï¼Œçš„ç¡®æ˜¯å¯ä»¥å¼ºè½¬çš„ã€‚å¦å¤–ä¸çŸ¥é“è¯»è€…è¿˜æ˜¯å¦è®°å¾—ï¼Œbinder é©±åŠ¨åœ¨ä¼ é€’ binder èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå·²ç»æŠŠ Type æ”¹æˆäº† BINDER_TYPE_HANDLE äº†ï¼Œå› æ­¤è¿™é‡Œçš„ ptr å®é™…å°±æ˜¯ SM ä¸º MediaPlayerService åˆ†é…çš„ handle å€¼ã€‚</p>
<p>æ¥ä¸‹å»å°±åˆ°äº†æ­£ä¸»å‡ºç°çš„æ—¶åˆ»ï¼š<code>do_add_service</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°è§£é‡Šï¼šs å°±æ˜¯ "media.player"</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_add_service</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">uint16_t</span> *s, <span class="keyword">unsigned</span> len,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">void</span> *ptr, <span class="keyword">unsigned</span> uid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// è¯¥ç»“æ„ä½“åœ¨å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> (!ptr || (len == <span class="number">0</span>) || (len &gt; <span class="number">127</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!svc_can_register(uid, s)) &#123;</span><br><span class="line">        LOGE(<span class="string">"add_service('%s',%p) uid=%d - PERMISSION DENIED\n"</span>,</span><br><span class="line">             str8(s), ptr, uid);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    si = find_svc(s, len);</span><br><span class="line">    <span class="keyword">if</span> (si) &#123;</span><br><span class="line">        <span class="keyword">if</span> (si-&gt;ptr) &#123;</span><br><span class="line">            LOGE(<span class="string">"add_service('%s',%p) uid=%d - ALREADY REGISTERED, OVERRIDE\n"</span>,</span><br><span class="line">                 str8(s), ptr, uid);</span><br><span class="line">            svcinfo_death(bs, si);</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;ptr = ptr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        si = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*si) + (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (!si) &#123;</span><br><span class="line">            LOGE(<span class="string">"add_service('%s',%p) uid=%d - OUT OF MEMORY\n"</span>,</span><br><span class="line">                 str8(s), ptr, uid);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;ptr = ptr;</span><br><span class="line">        si-&gt;len = len;</span><br><span class="line">        <span class="built_in">memcpy</span>(si-&gt;name, s, (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        si-&gt;name[len] = <span class="string">'\0'</span>;</span><br><span class="line">        si-&gt;death.func = svcinfo_death;</span><br><span class="line">        si-&gt;death.ptr = si;</span><br><span class="line">        si-&gt;next = svclist;</span><br><span class="line">        svclist = si;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binder_acquire(bs, ptr);</span><br><span class="line">    binder_link_to_death(bs, ptr, &amp;si-&gt;death);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä¸€è¿›æ¥é¦–å…ˆæ˜¯å‚æ•°åˆ¤æ–­ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå®é™…ä¸Š Service åå­—çš„é•¿åº¦æ˜¯æœ‰é™åˆ¶çš„ï¼Œè½¬æˆå­—ç¬¦æ•°ç»„å¿…é¡»åœ¨é•¿åº¦ 127 ä»¥å†…ï¼›ç¬¬äºŒæ­¥æ˜¯æƒé™æ£€æµ‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> uid;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">&#125; allowed[] = &#123;</span><br><span class="line">#ifdef LVMX</span><br><span class="line">    &#123; AID_MEDIA, <span class="string">"com.lifevibes.mx.ipc"</span> &#125;,</span><br><span class="line">#endif</span><br><span class="line">    &#123; AID_MEDIA, <span class="string">"media.audio_flinger"</span> &#125;,</span><br><span class="line">    &#123; AID_MEDIA, <span class="string">"media.player"</span> &#125;,</span><br><span class="line">    &#123; AID_MEDIA, <span class="string">"media.camera"</span> &#125;,</span><br><span class="line">    &#123; AID_MEDIA, <span class="string">"media.audio_policy"</span> &#125;,</span><br><span class="line">    &#123; AID_DRM,   <span class="string">"drm.drmManager"</span> &#125;,</span><br><span class="line">    &#123; AID_NFC,   <span class="string">"nfc"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"radio.phone"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"radio.sms"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"radio.phonesubinfo"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"radio.simphonebook"</span> &#125;,</span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> remove after phone services are updated: */</span></span><br><span class="line">    &#123; AID_RADIO, <span class="string">"phone"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"sip"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"isms"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"iphonesubinfo"</span> &#125;,</span><br><span class="line">    &#123; AID_RADIO, <span class="string">"simphonebook"</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">svc_can_register</span><span class="params">(<span class="keyword">unsigned</span> uid, <span class="keyword">uint16_t</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> n;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((uid == <span class="number">0</span>) || (uid == AID_SYSTEM))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; <span class="keyword">sizeof</span>(allowed) / <span class="keyword">sizeof</span>(allowed[<span class="number">0</span>]); n++)</span><br><span class="line">        <span class="keyword">if</span> ((uid == allowed[n].uid) &amp;&amp; str16eq(name, allowed[n].name))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰ root è¿›ç¨‹æˆ–è€… system server è¿›ç¨‹æˆ–è€…å…·æœ‰ç‰¹æ®Šåå­—çš„æœåŠ¡æ‰èƒ½æ³¨å†Œçš„ã€‚å†æ¥ç€å°±æ˜¯æŸ¥çœ‹æ˜¯å¦æœ‰åŒåæœåŠ¡æ³¨å†Œï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct svcinfo *<span class="title">find_svc</span><span class="params">(<span class="keyword">uint16_t</span> *s16, <span class="keyword">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (si = svclist; si; si = si-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((len == si-&gt;len) &amp;&amp;</span><br><span class="line">            !<span class="built_in">memcmp</span>(s16, si-&gt;name, len * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> si;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰å¿…è¦è§£é‡Šä¸€ä¸‹ svclist è¿™ä¸ªå˜é‡äº†ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå…ƒç´ å°±æ˜¯ svcinfoï¼Œæ‰€æœ‰æ³¨å†Œè¿‡æ¥çš„æœåŠ¡éƒ½ä»¥ svcinfo è®°å½•ä¸‹æ¥æ·»åŠ åœ¨ svclist ä¸­ï¼Œå› æ­¤å‡½æ•°<code>find_svc()</code>å®é™…åœ¨åšäº‹æƒ…æ˜¯éå†è¯¥é“¾è¡¨ï¼Œæ‰¾å‡ºæ˜¯å¦æœ‰åŒåçš„æœåŠ¡å·²ç»æ³¨å†Œè¿‡äº†ã€‚å¦‚æœæœ‰ï¼Œåˆ™æ›´æ–°æœåŠ¡ï¼Œç”¨æ–°çš„ ptr æ›¿æ¢æ—§æœ‰çš„ ptrï¼Œå¦åˆ™åˆ†é…æ–°çš„ svcinfo ç»“æ„ä½“ï¼Œè®°å½•æœåŠ¡ä¿¡æ¯ï¼Œå¹¶æŒ‚è½½åˆ° svclist é“¾è¡¨ä¸Šï¼Œæ‰§è¡Œå®Œæ¯•åè¿”å› 0ã€‚</p>
<p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œ<strong>æœåŠ¡ç»ˆäºæ³¨å†Œåˆ° SM äº†</strong>ã€‚å®é™…ä¸Šè¿˜æ²¡æœ‰å®Œç»“ï¼Œå› ä¸º MediaPlayerService è¿˜åœ¨ç­‰å¾…å›å¤å•Šï¼</p>
<h2 id="æ³¨å†Œç­”å¤"><a href="#æ³¨å†Œç­”å¤" class="headerlink" title="æ³¨å†Œç­”å¤"></a>æ³¨å†Œç­”å¤</h2><p>æ³¨å†Œç­”å¤çš„èµ·å§‹ç‚¹æˆ‘ä»¬è¿˜å¾—å›åˆ°<code>binder_parse</code>æ–¹æ³•ï¼š<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_parse</span><span class="params">(struct binder_state *bs, struct binder_io *bio,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">uint32_t</span> *ptr, <span class="keyword">uint32_t</span> size, binder_handler func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> *end = ptr + (size / <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd = *ptr++;</span><br><span class="line">        <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">            ......</span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION: &#123;</span><br><span class="line">        	<span class="comment">//è¯¥ç»“æ„ä½“å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">binder_txn</span> *<span class="title">txn</span> = (<span class="title">void</span> *) <span class="title">ptr</span>;</span></span><br><span class="line">            <span class="keyword">if</span> ((end - ptr) * <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>) &lt; <span class="keyword">sizeof</span>(struct binder_txn)) &#123;</span><br><span class="line">                LOGE(<span class="string">"parse: txn too small!\n"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            binder_dump_txn(txn);</span><br><span class="line">            <span class="keyword">if</span> (func) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> rdata[<span class="number">256</span>/<span class="number">4</span>];</span><br><span class="line">                <span class="comment">// è¯¥ç»“æ„ä½“å­—å…¸ä¸­å¯æŸ¥</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">msg</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span> <span class="title">reply</span>;</span></span><br><span class="line">                <span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">                bio_init(&amp;reply, rdata, <span class="keyword">sizeof</span>(rdata), <span class="number">4</span>);</span><br><span class="line">                bio_init_from_txn(&amp;msg, txn);</span><br><span class="line">                res = func(bs, txn, &amp;msg, &amp;reply);</span><br><span class="line">                binder_send_reply(bs, &amp;reply, txn-&gt;data, res);</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="keyword">sizeof</span>(*txn) / <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨è°ƒç”¨<code>svcmgr_handler</code>å‡½æ•°å¤„ç†è¯·æ±‚ä¹‹åï¼Œä¼šæ¥ç€è°ƒç”¨<code>binder_send_reply</code>å‘é€ç­”å¤ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°è§£é‡Šï¼šstatus ä¸º0</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">binder_send_reply</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                       struct binder_io *reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> *buffer_to_free,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> status)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">uint32_t</span> cmd_free;</span><br><span class="line">        <span class="keyword">void</span> *buffer;</span><br><span class="line">        <span class="keyword">uint32_t</span> cmd_reply;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_txn</span> <span class="title">txn</span>;</span></span><br><span class="line">    &#125; __attribute__((packed)) data;</span><br><span class="line"></span><br><span class="line">    data.cmd_free = BC_FREE_BUFFER; <span class="comment">// æ³¨æ„å‘½ä»¤</span></span><br><span class="line">    data.buffer = buffer_to_free;</span><br><span class="line">    data.cmd_reply = BC_REPLY; <span class="comment">// æ³¨æ„å‘½ä»¤</span></span><br><span class="line">    data.txn.target = <span class="number">0</span>;</span><br><span class="line">    data.txn.cookie = <span class="number">0</span>;</span><br><span class="line">    data.txn.code = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (status) &#123;</span><br><span class="line">        data.txn.flags = TF_STATUS_CODE;</span><br><span class="line">        data.txn.data_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">        data.txn.offs_size = <span class="number">0</span>;</span><br><span class="line">        data.txn.data = &amp;status;</span><br><span class="line">        data.txn.offs = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// èµ°è¿™é‡Œ</span></span><br><span class="line">        data.txn.flags = <span class="number">0</span>;</span><br><span class="line">        data.txn.data_size = reply-&gt;data - reply-&gt;data0;</span><br><span class="line">        data.txn.offs_size = ((<span class="keyword">char</span>*) reply-&gt;offs) - ((<span class="keyword">char</span>*) reply-&gt;offs0);</span><br><span class="line">        data.txn.data = reply-&gt;data0;</span><br><span class="line">        data.txn.offs = reply-&gt;offs0;</span><br><span class="line">    &#125;</span><br><span class="line">    binder_write(bs, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒåŒ…è£…äº†å¾ˆå¤šæ•°æ®ï¼Œé€šè¿‡<code>binder_write</code>åˆå†™å›åˆ° é©±åŠ¨ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_write</span><span class="params">(struct binder_state *bs, <span class="keyword">void</span> *data, <span class="keyword">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> <span class="title">bwr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    bwr.write_size = len;</span><br><span class="line">    bwr.write_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.write_buffer = (<span class="keyword">unsigned</span>) data;</span><br><span class="line">    bwr.read_size = <span class="number">0</span>;</span><br><span class="line">    bwr.read_consumed = <span class="number">0</span>;</span><br><span class="line">    bwr.read_buffer = <span class="number">0</span>;</span><br><span class="line">    res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"binder_write: ioctl failed (%s)\n"</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œåªæœ‰writeéƒ¨åˆ†æ˜¯æœ‰æ•°æ®çš„ï¼Œæ¥ç€åˆå›åˆ°äº†<code>binder_thread_write</code>æ–¹æ³•ä¸­ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼Œä¸€ä¸ªæ˜¯<code>BC_FREE_BUFFER</code>ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯<code>BC_REPLY</code>ï¼Œå‰è€…é¡¾åæ€ä¹‰å°±æ˜¯é‡Šæ”¾ç¼“å†²åŒºï¼Œæˆ‘ä»¬å°±ä¸å»çœ‹äº†ï¼Œåè€…æ¯”è¾ƒé‡è¦ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BC_TRANSACTION:</span><br><span class="line"><span class="keyword">case</span> BC_REPLY: &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> <span class="title">tr</span>;</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(&amp;tr, ptr, <span class="keyword">sizeof</span>(tr)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		ptr += <span class="keyword">sizeof</span>(tr);</span><br><span class="line">		binder_transaction(proc, thread, &amp;tr, cmd == BC_REPLY);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å·²ç»æ¥è¿‡ä¸€æ¬¡äº†ï¼Œåªä¸è¿‡ä¸Šæ¬¡æ˜¯<code>BC_TRANSACTION</code>å‘½ä»¤ã€‚è‡ªç„¶è€Œç„¶åˆè¦è¿›å…¥<code>binder_transaction</code>äº†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°è§£é‡Šï¼šreply æ˜¯ true</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">t</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> *<span class="title">tcomplete</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> *offp, *off_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">target_proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">target_thread</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">target_list</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> *target_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">in_reply_to</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_log_entry</span> *<span class="title">e</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> return_error;</span><br><span class="line">    e = binder_transaction_log_add(&amp;binder_transaction_log);</span><br><span class="line">    e-&gt;call_type = reply ? <span class="number">2</span> : !!(tr-&gt;flags &amp; TF_ONE_WAY);</span><br><span class="line">    e-&gt;from_proc = proc-&gt;pid;</span><br><span class="line">    e-&gt;from_thread = thread-&gt;pid;</span><br><span class="line">    e-&gt;target_handle = tr-&gt;target.handle;</span><br><span class="line">    e-&gt;data_size = tr-&gt;data_size;</span><br><span class="line">    e-&gt;offsets_size = tr-&gt;offsets_size;</span><br><span class="line">    <span class="keyword">if</span> (reply) &#123; <span class="comment">// true</span></span><br><span class="line">        in_reply_to = thread-&gt;transaction_stack; <span class="comment">// ä¹‹å‰æ”¾äº†ä¸€ä¸ªè¿›å»ï¼Œä¸ä¸ºnull</span></span><br><span class="line">        binder_set_nice(in_reply_to-&gt;saved_priority);</span><br><span class="line">        <span class="keyword">if</span> (in_reply_to-&gt;to_thread != thread) &#123;</span><br><span class="line">            .....</span><br><span class="line">            <span class="keyword">goto</span> err_bad_call_stack;</span><br><span class="line">        &#125;</span><br><span class="line">        thread-&gt;transaction_stack = in_reply_to-&gt;to_parent;</span><br><span class="line">        target_thread = in_reply_to-&gt;from; <span class="comment">// æ‰¾åˆ°å‘é€è¯·æ±‚çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (target_thread == <span class="literal">NULL</span>) &#123; </span><br><span class="line">            return_error = BR_DEAD_REPLY;</span><br><span class="line">            <span class="keyword">goto</span> err_dead_binder;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¡éªŒï¼Œä¿è¯æ˜¯åŒä¸€ä¸ª transaction</span></span><br><span class="line">        <span class="keyword">if</span> (target_thread-&gt;transaction_stack != in_reply_to) &#123;</span><br><span class="line">            <span class="keyword">goto</span> err_dead_binder;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœ¬æ¬¡å›å¤çš„ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">        target_proc = target_thread-&gt;proc;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (target_thread) &#123;</span><br><span class="line">        e-&gt;to_thread = target_thread-&gt;pid;</span><br><span class="line">        target_list = &amp;target_thread-&gt;todo;</span><br><span class="line">        target_wait = &amp;target_thread-&gt;wait;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        target_list = &amp;target_proc-&gt;todo;</span><br><span class="line">        target_wait = &amp;target_proc-&gt;wait;</span><br><span class="line">    &#125;</span><br><span class="line">    e-&gt;to_proc = target_proc-&gt;pid;</span><br><span class="line">    t = kzalloc(<span class="keyword">sizeof</span>(*t), GFP_KERNEL);</span><br><span class="line">    binder_stats_created(BINDER_STAT_TRANSACTION);</span><br><span class="line">    tcomplete = kzalloc(<span class="keyword">sizeof</span>(*tcomplete), GFP_KERNEL);</span><br><span class="line">    binder_stats_created(BINDER_STAT_TRANSACTION_COMPLETE);</span><br><span class="line">    t-&gt;debug_id = ++binder_last_id;</span><br><span class="line">    e-&gt;debug_id = t-&gt;debug_id;</span><br><span class="line">    <span class="keyword">if</span> (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY))</span><br><span class="line">        t-&gt;from = thread;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// èµ°è¿™é‡Œ</span></span><br><span class="line">        t-&gt;from = <span class="literal">NULL</span>; </span><br><span class="line">    t-&gt;sender_euid = proc-&gt;tsk-&gt;cred-&gt;euid;</span><br><span class="line">    t-&gt;to_proc = target_proc;</span><br><span class="line">    t-&gt;to_thread = target_thread;</span><br><span class="line">    t-&gt;code = tr-&gt;code;</span><br><span class="line">    t-&gt;flags = tr-&gt;flags;</span><br><span class="line">    t-&gt;priority = task_nice(current);</span><br><span class="line">    trace_binder_transaction(reply, t, target_node);</span><br><span class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</span><br><span class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</span><br><span class="line">    t-&gt;buffer-&gt;allow_user_free = <span class="number">0</span>;</span><br><span class="line">    t-&gt;buffer-&gt;debug_id = t-&gt;debug_id;</span><br><span class="line">    t-&gt;buffer-&gt;transaction = t;</span><br><span class="line">    t-&gt;buffer-&gt;target_node = target_node;</span><br><span class="line">    trace_binder_transaction_alloc_buf(t-&gt;buffer);</span><br><span class="line">    <span class="keyword">if</span> (target_node)</span><br><span class="line">        binder_inc_node(target_node, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    offp = (<span class="keyword">size_t</span> *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_copy_data_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_copy_data_failed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!IS_ALIGNED(tr-&gt;offsets_size, <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>))) &#123;</span><br><span class="line">        return_error = BR_FAILED_REPLY;</span><br><span class="line">        <span class="keyword">goto</span> err_bad_offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œpopï¼Œåˆ é™¤è¯¥ binder_transaction</span></span><br><span class="line">        binder_pop_transaction(target_thread, in_reply_to);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</span><br><span class="line">    <span class="comment">// åˆæ˜¯æŒ‚è½½ä»»åŠ¡</span></span><br><span class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br><span class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</span><br><span class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</span><br><span class="line">    <span class="comment">// å”¤é†’çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (target_wait)</span><br><span class="line">        wake_up_interruptible(target_wait);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨é‡Šå·²ç»æ·»åŠ ï¼Œå’Œä¹‹å‰è¿›æ¥å·®ä¸å¤šï¼Œåªä¸è¿‡è§’è‰²äº’æ¢äº†ï¼šSM å¾€ MediaPlayerService çš„ ç”³è¯·æœåŠ¡æ³¨å†Œçº¿ç¨‹ä¸Šé¢æŒ‚è½½äº†ä¸€ä¸ªä»»åŠ¡ã€‚æœ€ç»ˆ SM çš„çº¿ç¨‹å”¤é†’äº†åœ¨<code>target_wait</code>ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œå³æˆ‘ä»¬åœ¨ <strong>2.3.4 èŠ‚</strong> æè¿°çš„ MediaPlayerService çš„ç”³è¯·æœåŠ¡æ³¨å†Œçº¿ç¨‹ã€‚ç„¶å SM æ¬¢å¿«çš„å›å»è¿›è¡Œæ”¶å°¾å·¥ä½œã€‚</p>
<p>MediaPlayerService çš„ç”³è¯·æœåŠ¡æ³¨å†Œçº¿ç¨‹è¢«å”¤é†’åä¼šåšä»€ä¹ˆï¼Œè¿™é‡Œä¸åšåˆ†æäº†ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œåˆ†æï¼Œä¸‹ç¯‡æ–‡ç« ä¼šæ¶‰åŠã€‚</p>
<h2 id="ThreadPool"><a href="#ThreadPool" class="headerlink" title="ThreadPool"></a>ThreadPool</h2><p>åœ¨æœåŠ¡åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œâ€main_mediaserverâ€ ä¼šæ‰§è¡Œä¸‹é¢ä¸¤è¡Œä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">IPCThreadState::self()-&gt;joinThreadPool();</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢å°±æ¥è§£æä¸€ä¸‹è¿™ä¸¤è¡Œä»£ç ï¼š</p>
<h3 id="ProcessState-self-gt-startThreadPool"><a href="#ProcessState-self-gt-startThreadPool" class="headerlink" title="ProcessState::self()-&gt;startThreadPool()"></a><code>ProcessState::self()-&gt;startThreadPool()</code></h3><p>è¯¥æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ProcessState::startThreadPool()</span><br><span class="line">&#123;</span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line">    <span class="keyword">if</span> (!mThreadPoolStarted) &#123;</span><br><span class="line">        mThreadPoolStarted = <span class="literal">true</span>;</span><br><span class="line">        spawnPooledThread(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">``</span><br><span class="line">è®¾ç½®`mThreadPoolStarted`å±æ€§ä¹‹åï¼Œè°ƒç”¨æ–¹æ³•`spawnPooledThread`ï¼š</span><br><span class="line"></span><br><span class="line">â€‹```C++</span><br><span class="line"><span class="comment">// å‚æ•°è§£é‡Šï¼šisMainä¸ºtrue</span></span><br><span class="line"><span class="keyword">void</span> ProcessState::spawnPooledThread(<span class="keyword">bool</span> isMain)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mThreadPoolStarted) &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> s = android_atomic_add(<span class="number">1</span>, &amp;mThreadPoolSeq);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">"Binder Thread #%d"</span>, s);</span><br><span class="line">        LOGV(<span class="string">"Spawning new pooled thread, name=%s\n"</span>, buf);</span><br><span class="line">        sp&lt;Thread&gt; t = <span class="keyword">new</span> PoolThread(isMain);</span><br><span class="line">        t-&gt;run(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦å·¥ä½œæ˜¯æ–°å»ºäº† PoolThread å®ä¾‹ï¼Œå¹¶è°ƒç”¨<code>run()</code>æ–¹æ³•ï¼Œè¯¥ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PoolThread</span> :</span> <span class="keyword">public</span> Thread</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    PoolThread(<span class="keyword">bool</span> isMain)</span><br><span class="line">        : mIsMain(isMain)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">threadLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool(mIsMain);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> mIsMain;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>run()</code>æ¥æºäºçˆ¶ç±»ï¼Œä¼šè°ƒç”¨è™šæ–¹æ³•<code>threadLoop()</code>ï¼Œè€Œåœ¨<code>threadLoop()</code>ä¸­è°ƒç”¨çš„å´æ˜¯<code>IPCThreadState::self()-&gt;joinThreadPool(mIsMain)</code>ï¼Œå¥½äº†ï¼Œä¸‡å‰‘å½’å®—ï¼Œç›´æ¥çœ‹è¿™ä¸ªæ–¹æ³•å§ã€‚</p>
<h3 id="7-2-IPCThreadState-self-gt-joinThreadPool"><a href="#7-2-IPCThreadState-self-gt-joinThreadPool" class="headerlink" title="7.2 IPCThreadState::self()-&gt;joinThreadPool()"></a>7.2 <code>IPCThreadState::self()-&gt;joinThreadPool()</code></h3><p>è¯¥æ–¹æ³•çš„åœ¨ header æ–‡ä»¶ä¸­çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">joinThreadPool</span><span class="params">(<span class="keyword">bool</span> isMain = <span class="literal">true</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤å‚æ•°ä¸º trueã€‚</p>
<blockquote>
<p>è€ç½—çš„æ–‡ç« åœ¨è¿™é‡Œæœ‰ä¸ªå°é”™è¯¯ï¼Œé»˜è®¤å€¼ç¡®å®æ˜¯ trueï¼Œæˆ‘çœ‹äº†1.6ï¼Œ2.2.3ï¼Œ4.0.4å‡ ä¸ªç‰ˆæœ¬éƒ½æ˜¯trueã€‚</p>
</blockquote>
<p>è¿™ä¸ªæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> IPCThreadState::joinThreadPool(<span class="keyword">bool</span> isMain)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿›å…¥ Looper çŠ¶æ€</span></span><br><span class="line">    mOut.writeInt32(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// This thread may have been spawned by a thread that was in the background</span></span><br><span class="line">    <span class="comment">// scheduling group, so first we will make sure it is in the default/foreground</span></span><br><span class="line">    <span class="comment">// one to avoid performing an initial transaction in the background.</span></span><br><span class="line">    <span class="comment">// è°ƒåº¦çº¿ç¨‹çš„ä¼˜å…ˆçº§</span></span><br><span class="line">    androidSetThreadSchedulingGroup(mMyThreadId, ANDROID_TGROUP_DEFAULT);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">status_t</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int32_t</span> cmd;</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯»å–å‘½ä»¤</span></span><br><span class="line">        result = talkWithDriver();</span><br><span class="line">        <span class="keyword">if</span> (result &gt;= NO_ERROR) &#123;</span><br><span class="line">            <span class="keyword">size_t</span> IN = mIn.dataAvail();</span><br><span class="line">            <span class="keyword">if</span> (IN &lt; <span class="keyword">sizeof</span>(<span class="keyword">int32_t</span>)) <span class="keyword">continue</span>;</span><br><span class="line">            cmd = mIn.readInt32();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è°ƒç”¨è¯¥å‡½æ•°æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">            result = executeCommand(cmd);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒåº¦çº¿ç¨‹çš„ä¼˜å…ˆçº§</span></span><br><span class="line">        androidSetThreadSchedulingGroup(mMyThreadId, ANDROID_TGROUP_DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Let this thread exit the thread pool if it is no longer</span></span><br><span class="line">        <span class="comment">// needed and it is not the main process thread.</span></span><br><span class="line">        <span class="keyword">if</span>(result == TIMED_OUT &amp;&amp; !isMain) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (result != -ECONNREFUSED &amp;&amp; result != -EBADF);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€€å‡º Looper çŠ¶æ€</span></span><br><span class="line">    mOut.writeInt32(BC_EXIT_LOOPER);</span><br><span class="line">    <span class="comment">// ä¸å†æ¥å—æ•°æ®</span></span><br><span class="line">    talkWithDriver(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¿™é‡Œæ˜¯èµ·äº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸åœçš„ä»é©±åŠ¨ä¸­è¯»å–æ•°æ®ï¼Œå¹¶äº¤ç»™<code>executeCommand()</code>æ‰§è¡Œå‘½ä»¤ã€‚åœ¨å¤„ç†å„ç§å‘½ä»¤çš„æ—¶å€™ï¼Œæœ‰ä¸€æ®µå¦‚ä¸‹çš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tr.target.ptr) &#123;</span><br><span class="line">	sp&lt;BBinder&gt; b((BBinder*)tr.cookie);</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">status_t</span> error = b-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</span><br><span class="line">	<span class="keyword">if</span> (error &lt; NO_ERROR) reply.setError(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å¯è°“ç²¾åäº†ï¼è¿˜è®°å¾—<code>cookie</code>è®°å½•çš„æ˜¯ä»€ä¹ˆä¹ˆï¼ŸæœåŠ¡å®ä¾‹åœ¨ç”¨æˆ·ç©ºé—´çš„å¼•ç”¨åœ°å€ï¼æ‰€ä»¥è¿™é‡Œæ˜¯æ ¹æ®è¿™ä¸ªåœ°å€åˆæ‹¿åˆ°äº†è¯¥æœåŠ¡çš„å®ä¾‹ï¼Œç„¶åè¿˜è®°å¾—è¿™å¼ å›¾ä¹ˆï¼Ÿ</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Binder-Libå±‚æ¶æ„.png" alt="Binder Libå±‚æ¶æ„"></div>

<p>BBinderçš„<code>transact()</code>æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> BBinder::transact(</span><br><span class="line">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    data.setDataPosition(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = NO_ERROR;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> PING_TRANSACTION:</span><br><span class="line">            reply-&gt;writeInt32(pingBinder());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            err = onTransact(code, data, reply, flags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reply != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        reply-&gt;setDataPosition(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè°ƒç”¨çš„åˆæ˜¯<code>onTransact()</code>ï¼Œè€Œè¿™ä¸ªæ–¹æ³•åˆæ˜¯åœ¨BBinderçš„å­ç±»ï¼Œæ¯”å¦‚<code>BnMediaPlayerService</code>ä¸­å®ç°çš„ â€”â€” å³å¯ä»¥æ ¹æ®å…·ä½“çš„æœåŠ¡ API è¿›è¡Œä¸åŒçš„è§£æï¼Œå¹¶å®Œæˆç›¸å…³åŠŸèƒ½ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»£ç åˆ†æå®Œæ¯•ï¼Œè¯»è€…å¯èƒ½è§‰å¾—æ•´ä¸ªè¿‡ç¨‹æ— æ¯”ç¹æ‚ï¼Œæœ‰äº›æ–¹æ³•åˆè‡­åˆé•¿ï¼Œè¿˜ä¸æ­¢è°ƒç”¨ä¸€æ¬¡ã€‚ä½†å®é™…ä¸Šè¿™å—æœºåˆ¶å¹¶ä¸å¤æ‚ï¼Œç†è§£èµ·æ¥å›°éš¾å¯èƒ½æ˜¯å› ä¸ºï¼š</p>
<ol>
<li>C++ è¯­è¨€ç¼–å†™ï¼Œå¯¹äº Java å¼€å‘è€…æ¥è¯´è¯­è¨€ä¸ç†Ÿæ‚‰ï¼ŒC++ æœ¬èº«çš„è¯­è¨€ç‰¹æ€§ä¹Ÿå¯¼è‡´é˜…è¯»èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼›</li>
<li>æ¶‰åŠé©±åŠ¨å±‚ï¼Œé©±åŠ¨çŸ¥è¯†é€ æˆéšœç¢ï¼›</li>
<li>ä¸èƒ½è°ƒè¯•ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå¼€æºæ¡†æ¶ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥å†™ä¸€ä¸ª Demo å»è°ƒè¯•æŸä¸ªç‚¹çš„ï¼Œè¿™æ ·å°±ä¸ç”¨è´¹è¿™ä¹ˆå¤šç²¾åŠ›æŠŠè„‘å­å½“åšè®¡ç®—æœºä½¿ç”¨äº†ï¼›</li>
<li>å¯¹ Libraries å’Œ Binder é©±åŠ¨å±‚çš„äº¤äº’åè®®ä¸æ¸…æ¥šï¼Œè¿™æ ·åœ¨æ•°æ®ä¸Šå°±æ¯”è¾ƒéš¾ææ¸…æ¥šç»“æ„ï¼Œæ–¹æ³•è°ƒç”¨é“¾åˆé•¿ï¼Œè°ƒç”¨å‡ å±‚ä¹‹åå¯¹äºå‚æ•°çš„å†…å®¹å°±æ¨¡ç³Šäº†ï¼›</li>
<li>ä»£ç é—®é¢˜ï¼Œè¿™ä¸¤å±‚çš„ä»£ç å†™çš„å¹¶ä¸å¥½ï¼Œæ³¨é‡Šä¹Ÿå°‘ï¼Œç†è§£èµ·æ¥éå¸¸è´¹åŠ›ï¼›</li>
</ol>
<blockquote>
<p>å’Œ framework å±‚çš„ä»£ç æ¯”èµ·æ¥ï¼Œè¿™é‡Œçš„æ–¹æ³•è°ƒç”¨é“¾å…¶å®å¹¶ä¸ç®—é•¿ã€‚</p>
</blockquote>
<p>è¿™é‡Œç±»æ¯”ç½‘ç»œè¯·æ±‚åšä¸€äº›æ–‡å­—æè¿°ï¼Œå¸Œæœ›æœ‰åŠ©äºè¯»è€…ææ¸…æ¥š Binder çš„æœºç†ã€‚å¤§ä½“è¿‡ç¨‹ä¸Šæœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š</p>
<ol>
<li>ä½¿ç”¨<code>binder_write_read</code>ç»“æ„ä½“åœ¨ Libraries å±‚å’Œé©±åŠ¨å±‚ä¹‹é—´åšæ•°æ®ä¼ è¾“ä»‹è´¨ï¼Œç±»æ¯”ç½‘ç»œè¯·æ±‚ï¼Œè¯¥ç»“æ„ä½“å°±ç›¸å½“äº Request å’Œ Response çš„åˆä½“ï¼›</li>
<li>æœ‰ä¼ è¾“ä»‹è´¨ä¹‹åï¼Œä¼ è¾“ä½¿ç”¨çš„æ‰‹æ®µæ˜¯<code>ioctl</code>ã€<code>open</code>ç­‰å‡½æ•°ï¼Œç±»æ¯”ç½‘ç»œè¯·æ±‚ï¼Œå°±åƒ<code>openConnection()</code>ç­‰å‡½æ•°ï¼›</li>
<li>å¦‚æœæˆ‘ä»¬è¦å‘é€æ•°æ®ï¼Œåˆ™åœ¨<code>binder_write_read</code>ç»“æ„ä½“çš„ write éƒ¨åˆ†å†™å…¥æ•°æ®ï¼Œé©±åŠ¨å±‚ä¼š copy æ•°æ®åˆ°å†…æ ¸ç©ºé—´ï¼Œå¹¶è¯»å–æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå½“ç„¶ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿä¼šæºå¸¦ä¸€äº›å‘½ä»¤ï¼Œæ¯”å¦‚<code>BINDER_WRITE_READ</code>ï¼Œç±»æ¯”ç½‘ç»œè¯·æ±‚ï¼Œè¿™äº›å‘½ä»¤ç±»ä¼¼äº<code>GET</code>ï¼Œ<code>POST</code>ç­‰ï¼›</li>
<li>å¦‚æœ<code>binder_write_read</code>çš„ read éƒ¨åˆ†è¦æ±‚è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆé©±åŠ¨å±‚ä¼šæŸ¥çœ‹æœ‰æ²¡æœ‰äº‹åŠ¡è¦å¤„ç†ï¼Œæœ‰æ²¡æœ‰æ•°æ®è¦ä¼ è¾“ç»™ä¸Šå±‚ï¼ˆå…·ä½“ä¼ è¾“ä»€ä¹ˆæ•°æ®ï¼Œç”±åœºæ™¯ç¡®å®šï¼‰ï¼Œå¦‚æœæœ‰å°±å†™å…¥åˆ° read éƒ¨åˆ†å¹¶ copy åˆ° Libraries å±‚ï¼Œå‡½æ•°è¿”å›ï¼ŒLibraries å±‚è¯»å–æ•°æ®è¿›è¡Œå¤„ç†ï¼ŒåŒæ ·çš„è¿™ä¸ªæ—¶å€™æ•°æ®ä¸­ä¹Ÿä¼šæœ‰å‘½ä»¤ï¼Œç±»æ¯”ç½‘ç»œè¯·æ±‚ï¼Œè¿™äº›å‘½ä»¤å°±åƒâ€200â€ï¼Œâ€404â€ï¼Œâ€500â€ç­‰ Http Status Codeï¼›å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™ä¼šé˜»å¡åœ¨è‡ªå·±çš„äº‹åŠ¡å¤„ç†é˜Ÿåˆ—ä¸Šï¼Œ<ol>
<li>é©±åŠ¨å±‚æ‹¿åˆ°æ•°æ®ä¹‹åï¼Œä¼šåšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚ç”Ÿæˆ<code>binder_node</code>èŠ‚ç‚¹ï¼Œåœ¨ç›®æ ‡è¿›ç¨‹ä¸­ç”Ÿæˆ<code>binder_ref</code>èŠ‚ç‚¹ï¼Œå¹¶æ“ä½œçº¢é»‘æ ‘ã€æ’å…¥<code>binder_transaction</code>ç­‰ç­‰ï¼Œè¿™äº›è¿‡ç¨‹çœ‹ä¸Šå»æä¸ºå¤æ‚ï¼ŒåŸå› æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹å¹¶ä¸äº†è§£ binder å…·ä½“è¦åšä»€ä¹ˆã€‚å®é™…ä¸Š binder è®°å½•è¿™äº›æ•°æ®åªä¸ºä¸¤ä»¶äº‹ï¼šbinder_transaction èƒ½å¤Ÿæ­£ç¡®å‘é€åˆ°ç›®æ ‡è¿›ç¨‹å’Œç›®æ ‡è¿›ç¨‹å¤„ç†å®Œäº‹åŠ¡ä¹‹åèƒ½å¤Ÿæ­£ç¡®æ‰¾åˆ°å›å¤è¿›ç¨‹ã€‚è¿™æ˜¯ IPC çš„ä¸»è¦ä»»åŠ¡ï¼Œå…¶ä½™çš„æ•°æ®éƒ½æ˜¯ä¸ºäº†è¿™ä¸¤ä¸ªç›®æ ‡å‡†å¤‡çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚åœ¨æ³¨å†Œçš„æ—¶å€™åœ¨ç›®æ ‡è¿›ç¨‹çš„ transaction_stack ä¸­æ’å…¥ binder_transaction èŠ‚ç‚¹ï¼Œå°±æ˜¯ä¸ºäº†å¤„ç†å®Œäº‹åŠ¡ä¹‹åå¯ä»¥æ‰¾åˆ°å›å¤è¿›ç¨‹ï¼›</li>
</ol>
</li>
</ol>
<p>ä»¥ä¸Šå‰å››ç‚¹å’Œä¸€ä¸ªç½‘ç»œè¯·æ±‚å¹¶æ— äºŒè‡´ï¼Œåªæ˜¯æ•°æ®è§„åˆ™å˜äº†ä¸€ä¸‹ï¼Œæœ€åä¸€ç‚¹åˆ™æ˜¯æœºåˆ¶æœ¬èº«å¯¼è‡´çš„ç‰¹æ€§ã€‚å¦å¤–è¿™é‡Œæœ‰ä¸€ä¸ªæ ¸å¿ƒç‚¹ä¸€å®šè¦æ•´ç†ä¸€ä¸‹ï¼š</p>
<p><strong>æ¯ä¸€ä¸ªæœåŠ¡éƒ½ä¼šå¯¹åº”åœ¨é©±åŠ¨å±‚ç”Ÿæˆä¸€ä¸ª<code>binder_node</code>èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯è®°å½•åœ¨æœ¬æœåŠ¡è¿›ç¨‹åœ¨é©±åŠ¨å±‚çš„æ˜ å°„<code>binder_proc</code>ç»“æ„ä½“ä¸­çš„ï¼Œbinderé©±åŠ¨ä¼šç»´æŠ¤å¾ˆå¤šçš„<code>binder_proc</code>ç»“æ„ä½“ï¼Œåœ¨é™¤æœ¬è¿›ç¨‹å¤–çš„<code>binder_proc</code>ç»“æ„ä½“ä¸­ï¼Œå¼•ç”¨æœ¬è¿›ç¨‹çš„æœåŠ¡ï¼Œä¸€å¾‹ä½¿ç”¨çš„æ˜¯<code>binder_ref</code>ç»“æ„ä½“ï¼è‡³äºå¦‚ä½•é€šè¿‡<code>binder_ref</code>ç»“æ„ä½“è·å–åˆ°å¯¹åº”çš„æœåŠ¡ï¼Œæ­£æ˜¯ä¸‹ä¸€ç¯‡æ–‡ç« æ‰€è¦æ¢ç´¢çš„å†…å®¹ã€‚</strong></p>
<p>ä»¥ä¸Šï¼Œå¦‚æœè¯»è€…æƒ³è¦äº†è§£åŸç†çš„è¯ï¼Œç›´æ¥è¯»è¿™éƒ¨åˆ†å³å¯ã€‚å¦‚æœè¯»è€…æƒ³äº†è§£ä¸€äº›è¾ƒç»†è‡´çš„åŸç†çš„è¯ï¼Œå¢™è£‚å»ºè®®é˜…è¯»æ¨èæ–‡ç« â‘ å’Œæ–‡ç« â‘¢ä¸¤ç³»åˆ—åšå®¢ï¼Œè¿˜æ˜¯é‚£ä¸ªè¯„ä»·ï¼šæ•´ç†æœ‰åºï¼Œå›¾æ–‡å¹¶èŒ‚ã€‚å®ä¹ƒå¯¹ä»˜æ­¤ç­‰å·¨å…½çš„ç¥å…µä¹‹ä½œã€‚</p>
<p>è‡³æ­¤ï¼ŒæœåŠ¡æ³¨å†Œåˆ†æå®Œæˆã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è§‚å½±ã€Šè¾©æŠ¤äººã€‹]]></title>
      <url>http://www.timebridge.space/2016/06/19/paraclete/</url>
      <content type="html"><![CDATA[<p>è±†ç“£è¯„åˆ†9.1åˆ†ï¼Œåº”è¯¥å½’å…¥æå¥½çš„ç”µå½±ä¸€ç±»çš„äº†ï¼Œæ˜¯åœ¨å…¬å¸ç”µå½±ä¿±ä¹éƒ¨å’ŒåŒäº‹ä¸€èµ·è§‚çœ‹çš„ã€‚</p>
<p>çœ‹ä¹…äº†å›½å†…è¿™äº›â€œæç¬‘ã€æ— å˜å¤´ã€ç§€ç‰¹æ•ˆâ€çš„ç”µå½±ä¹‹åï¼Œå°±æ„Ÿè§‰æ˜¯åœ¨ä¸€å †ç»ç’ƒç§æ‰¾åˆ°äº†ä¸€å—ç‰çŸ³ï¼Œæ²‰ç”¸ç”¸çš„ã€‚</p>
<p>å½±ç‰‡æœ€å¤§çš„æ„Ÿå—æ˜¯ï¼š<strong>åˆ¤æ–­æ˜¯å¦å»åšä¸€ä»¶äº‹çš„æ ‡å‡†å†³ä¸æ˜¯å®ƒçš„é«˜ä½è´µè´±ï¼Œè€Œæ˜¯å®ƒæ˜¯å¦æ˜¯æ­£ç¡®çš„ï¼Œæ­£ç¡®çš„åˆ¤æ–­æ ‡å‡†æ˜¯æ˜¯å¦å¯¹ç»å¤§éƒ¨åˆ†äººæœ‰ç›Šã€‚</strong>æ˜ç™½è‡ªå·±çš„è´£ä»»ï¼Œä¸ç•ä»–äººçš„çœ¼å…‰ï¼Œåšå†³è´¯å½»è‡ªå·±çš„é€‰æ‹©ï¼Œso manä¸æ˜¯å—ï¼Ÿ<a id="more"></a></p>
<p>å®‹ä½‘ç¡•æ¬è¿‡ç –ï¼ˆæ˜¯çœŸçš„æ¬ç –ï¼‰ï¼Œä»¥é«˜ä¸­å­¦å†åšè¿‡æ³•å®˜ï¼Œä»¥å¾‹å¸ˆèº«ä»½è¿›è¡Œè¿‡ä¸åŠ¨äº§ä»£ä¹¦ï¼Œè¿™äº›éƒ½è¢«åˆ«äººç§ä¸èµ·ï¼Œä½†æ˜¯ä»–ä¸æ¯«æ²¡æœ‰åŠ¨æ‘‡ï¼Œä»–å¾ˆæ˜ç™½è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œè¦åšä»€ä¹ˆã€‚</p>
<p>åœ¨è¿™äº›é“ºå«ä¹‹åï¼Œç»ˆäºè¿›å…¥å›½å®‰æ³•å®˜å¸çš„ä¸»æƒ…èŠ‚ã€‚å› ä¸ºæœ‰è¿™æ ·çš„æ€§æ ¼å’Œä¸‰è§‚ï¼Œä»–æ‰èƒ½é¡¶ä½å„æ–¹å‹åŠ›ï¼Œä¸ç•æå“ï¼Œåšå®šè‡ªå·±çš„ä¿¡å¿µå®Œæˆé‚£åœºå®˜å¸ï¼ˆæ­¤å¤„èµæ¼”æŠ€ï¼‰ï¼Œæœç€è‡ªå·±çš„æœ€ç»ˆç›®æ ‡ï¼ˆæœ´é•‡å®‡æ— ç½ªï¼‰ä¸€æ­¥æ­¥è¿ˆè¿›ï¼Œæœ€ç»ˆèµ¢å¾—åŒè¡Œçš„å°Šé‡ã€‚</p>
<p>ç”µå½±æƒ…èŠ‚å¹³ç¼“æœ‰åºï¼Œç»“å°¾è¿ç»­ä¸‰ä¸ªé«˜æ½®ï¼ŒæˆåŠŸå¡‘é€ äº†å®‹ä½‘ç¡•çš„å½¢è±¡ï¼Œèµçš„ä¸€é€¼ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—åä¸‰ï¼šå®æˆ˜]]></title>
      <url>http://www.timebridge.space/2016/06/18/gradle-advaced-usage/</url>
      <content type="html"><![CDATA[<h4 id="ç”Ÿæˆé¡¹ç›®æŠ¥å‘Š"><a href="#ç”Ÿæˆé¡¹ç›®æŠ¥å‘Š" class="headerlink" title="ç”Ÿæˆé¡¹ç›®æŠ¥å‘Š"></a>ç”Ÿæˆé¡¹ç›®æŠ¥å‘Š</h4><p>å¯ä»¥ä½¿ç”¨æ’ä»¶ <strong>project-report</strong> ï¼Œå…·ä½“è§<a href="https://docs.gradle.org/current/userguide/project_reports_plugin.html" target="_blank" rel="noopener">The Project Report Plugin</a>ã€‚</p>
<p>è¿™é‡Œé¢åŒ…å«ä¾èµ–ï¼ˆæ–‡æœ¬æ ¼å¼ã€HTMLæ ¼å¼ï¼‰ã€Taskã€å±æ€§ç­‰çš„æŠ¥å‘Š<a id="more"></a></p>
<h4 id="æŒ‡å®šJDKç‰ˆæœ¬"><a href="#æŒ‡å®šJDKç‰ˆæœ¬" class="headerlink" title="æŒ‡å®šJDKç‰ˆæœ¬"></a>æŒ‡å®šJDKç‰ˆæœ¬</h4><p>åœ¨â€œgradle.propertiesâ€æ–‡ä»¶å¤¹ä¸‹é¢æ·»åŠ å¦‚ä¸‹è¯­å¥:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.gradle.java.home=/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home</span><br></pre></td></tr></table></figure>
<p>å€¼æ˜¯<code>JAVA_HOME</code>ã€‚</p>
<h4 id="å…³äºâ€providedâ€"><a href="#å…³äºâ€providedâ€" class="headerlink" title="å…³äºâ€providedâ€"></a>å…³äºâ€providedâ€</h4><p>è¿™ç¯‡æ–‡ç« æœ‰æ¯”è¾ƒæ·±å…¥è¯¦ç»†çš„è§£é‡Šï¼š<a href="https://sinking.in/blog/provided-scope-in-gradle/" target="_blank" rel="noopener">PROVIDED SCOPE IN GRADLE</a>ã€‚å®é™…ä¸Šç¼–è¯‘å’Œæ‰“åŒ…è¿™ä¸¤ä¸ªè¿‡ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œè¿™å¯ä»¥é€šè¿‡ SourceSet çš„å±æ€§æ¥æ§åˆ¶ï¼šé¦–å…ˆå®šä¹‰â€providedâ€ configurationï¼Œå°†ç”±å®ƒé…ç½®çš„æ–‡ä»¶åŠ åˆ°compileClasspathï¼Œè¿™æ ·ç¼–è¯‘å³å¯é€šè¿‡ï¼Œä½†æ˜¯åœ¨runtimeClasspathä¸­æˆ‘ä»¬å¹¶ä¸åŠ å…¥ â€œprovidedâ€ é…ç½®çš„æ–‡ä»¶ï¼Œè¿™å°±OKäº†ã€‚</p>
<blockquote>
<p>æ—¥äº†ç‹—ï¼ŒJavan Pluginçš„<code>compile</code>å±…ç„¶ä¸ä¼šæŠŠä¾èµ–æ‰“åŒ…å…¥æœ€ç»ˆçš„jaråŒ…ï¼Œä¸è®¾æƒ³çš„å¾ˆä¸ä¸€æ ·ã€‚</p>
</blockquote>
<h4 id="å¼ºåˆ¶åˆ·æ–°ç¼“å­˜"><a href="#å¼ºåˆ¶åˆ·æ–°ç¼“å­˜" class="headerlink" title="å¼ºåˆ¶åˆ·æ–°ç¼“å­˜"></a>å¼ºåˆ¶åˆ·æ–°ç¼“å­˜</h4><p>å‘½ä»¤ï¼š<code>gradle build --refresh-dependencies</code>ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—å…«ï¼šç”Ÿå‘½å‘¨æœŸ]]></title>
      <url>http://www.timebridge.space/2016/06/18/gradle-lifecycle/</url>
      <content type="html"><![CDATA[<p>Gradle çš„æ ¸å¿ƒæ˜¯ä¸€é—¨ä»¥ä¾èµ–ä¸ºåŸºç¡€çš„ DSLã€‚å¼€å‘è€…é€šè¿‡å®šä¹‰ Task ä»¥åŠ Task ä¹‹é—´çš„ä¾èµ–æ¥å®Œæˆä»»åŠ¡ã€‚Gradle ç¡®è®¤ä¼šæ ¹æ®ä¾èµ–å…³ç³»æ¥æ‰§è¡Œ Taskï¼Œå¹¶ä¸”æ¯ä¸€ä¸ª Task éƒ½åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼ŒGradle ä¼šåœ¨æ‰§è¡Œ Task ä¹‹å‰å…ˆæ„å»ºä¸€ä¸ªä¾èµ–å…³ç³»å›¾ã€‚</p>
<blockquote>
<p>æ„å»ºè„šæœ¬å°±æ˜¯ç”¨äºé…ç½®è¿™ä¸ªä¾èµ–å…³ç³»å›¾ï¼Œå› æ­¤æ„å»ºè„šæœ¬å®é™…ä¸Šæ˜¯é…ç½®è„šæœ¬ã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="ä¸€ã€æ„å»ºæ­¥éª¤"><a href="#ä¸€ã€æ„å»ºæ­¥éª¤" class="headerlink" title="ä¸€ã€æ„å»ºæ­¥éª¤"></a>ä¸€ã€æ„å»ºæ­¥éª¤</h2><p>Gradle æ„å»ºæœ‰ä¸‰ä¸ªæ­¥éª¤ã€‚</p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Initialization</strong></td>
<td>Gradle æ”¯æŒå•é¡¹ç›®æˆ–è€…å¤šé¡¹ç›®æ„å»ºï¼Œåœ¨è¯¥é˜¶æ®µï¼ŒGradle ç¡®è®¤å“ªäº›é¡¹ç›®ä¼šå‚ä¸æ„å»ºï¼Œç„¶åä¸ºæ¯ä¸€ä¸ªé¡¹ç›®åˆ›å»º Project å¯¹è±¡</td>
</tr>
<tr>
<td><strong>Configuration</strong></td>
<td>è¿™ä¸ªé˜¶æ®µå°±æ˜¯é…ç½® Initialization é˜¶æ®µåˆ›å»ºçš„ Project å¯¹è±¡ï¼Œæ‰€æœ‰çš„é…ç½®è„šæœ¬éƒ½ä¼šè¢«æ‰§è¡Œ</td>
</tr>
<tr>
<td><strong>Execution</strong></td>
<td>è¿™ä¸ªé˜¶æ®µ Gradle ä¼šç¡®è®¤å“ªäº›åœ¨ Configuration é˜¶æ®µåˆ›å»ºå’Œé…ç½®çš„ Task ä¼šè¢«æ‰§è¡Œï¼Œå“ªäº› Task ä¼šè¢«æ‰§è¡Œå–å†³äº<code>gradle</code>å‘½ä»¤çš„å‚æ•°ä»¥åŠå½“å‰çš„ç›®å½•ï¼Œç¡®è®¤ä¹‹åä¾¿ä¼šæ‰§è¡Œ</td>
</tr>
</tbody>
</table>
<h2 id="äºŒã€ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹"><a href="#äºŒã€ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹" class="headerlink" title="äºŒã€ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹"></a>äºŒã€ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹</h2><p>å¦‚æœæˆ‘ä»¬åœ¨ä¸€ä¸ªç›®å½•ä¸‹é¢æ‰§è¡Œ<code>gradle init</code>å‘½ä»¤ï¼Œé‚£ä¹ˆæ ‡å‡†çš„ gradle æ„å»ºé¡¹ç›®ä¸‹æ˜¯ä¼šåˆ›å»º â€œsettings.gradleâ€ æ–‡ä»¶çš„ã€‚å¯¹äºå•é¡¹ç›®æ„å»ºï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯å¯é€‰çš„ï¼Œä½†å¯¹äºå¤šé¡¹ç›®æ„å»ºï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯å¿…é¡»çš„ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šåœ¨ initialization é˜¶æ®µè¢«æ‰§è¡Œï¼Œè¿™ä¸ªæ–‡ä»¶ä¼šæ ¹æ®å‘½åè§„èŒƒåˆ—å‡ºéœ€è¦å‚ä¸æ„å»ºçš„é¡¹ç›®ã€‚</p>
<p>åœ¨ä¸€ä¸ª â€œsettings.gradleâ€ æ–‡ä»¶ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">println <span class="string">'This is executed during the initialization phase.'</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ â€œbuild.gradleâ€ æ–‡ä»¶ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">println <span class="string">'This is executed during the configuration phase.'</span></span><br><span class="line"></span><br><span class="line">task configured &#123;</span><br><span class="line">    println <span class="string">'This is also executed during the configuration phase.'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task test &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'This is executed during the execution phase.'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task testBoth &#123;</span><br><span class="line">    doFirst &#123;</span><br><span class="line">      println <span class="string">'This is executed first during the execution phase.'</span></span><br><span class="line">    &#125;</span><br><span class="line">    doLast &#123;</span><br><span class="line">      println <span class="string">'This is executed last during the execution phase.'</span></span><br><span class="line">    &#125;</span><br><span class="line">    println <span class="string">'This is executed during the configuration phase as well.'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå‘½ä»¤<code>gradle test testBoth</code>ï¼Œå°±ä¼šå¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; gradle test testBoth</span><br><span class="line">This is executed during the initialization phase.</span><br><span class="line">This is executed during the configuration phase.</span><br><span class="line">This is also executed during the configuration phase.</span><br><span class="line">This is executed during the configuration phase as well.</span><br><span class="line">:test</span><br><span class="line">This is executed during the execution phase.</span><br><span class="line">:testBoth</span><br><span class="line">This is executed first during the execution phase.</span><br><span class="line">This is executed last during the execution phase.</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL</span><br><span class="line"></span><br><span class="line">Total time: <span class="number">1</span> secs</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æ–‡æ¡ˆæç¤ºï¼Œå…·ä½“çš„åŠ¨ä½œå‘ç”Ÿçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µéƒ½æ˜¯å¾ˆæ¸…æ¥šçš„ã€‚</p>
<blockquote>
<p>å¯¹äºæ„å»ºè„šæœ¬(å³ â€œbuild.gradleâ€)æ¥è¯´ï¼Œå±æ€§è·å–å’Œæ–¹æ³•è°ƒç”¨éƒ½è¢«ä»£ç†åˆ° Project å¯¹è±¡ï¼Œè€ŒåŒæ ·çš„ï¼Œåœ¨ â€œsettings.gradleâ€ ä¸­è¿›è¡Œçš„å±æ€§è·å–å’Œæ–¹æ³•è°ƒç”¨éƒ½ä¼šè¢«ä»£ç†åˆ° Settingså¯¹è±¡ã€‚</p>
<p>è¿™ä¸€ç‚¹ä¼šåœ¨åœ¨<a href="http://www.muzileecoding.com/gradlestudy/gradle-advaced-do.html" target="_blank" rel="noopener">Gradle DOæ¨¡å‹</a>ä¸­è¯¦ç»†è§£é‡Šã€‚</p>
</blockquote>
<h2 id="ä¸‰ã€Initialization"><a href="#ä¸‰ã€Initialization" class="headerlink" title="ä¸‰ã€Initialization"></a>ä¸‰ã€Initialization</h2><p>Gradle å¦‚ä½•çŸ¥é“è‡ªå·±åœ¨æ„å»ºçš„æ˜¯ä¸€ä¸ªå•é¡¹ç›®æ„å»ºé¡¹ç›®è¿˜æ˜¯ä¸€ä¸ªé¡¹ç›®æ„å»ºé¡¹ç›®å‘¢ï¼Ÿå¦‚æœå®ƒæ˜¯åœ¨ä¸€ä¸ªæœ‰ â€œsettings.gradleâ€ çš„æ–‡ä»¶å¤¹ä¸‹é¢è¿è¡Œï¼Œäº‹æƒ…å°±å˜å¾—å¾ˆç®€å•ï¼Œä½†æ˜¯ Gradle å…è®¸åœ¨ä»»ä½•ä¸€ä¸ªå­é¡¹ç›®ä¸‹é¢æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥è¿™æ¶‰åŠåˆ°ä¸€ä¸ªå¯»æ‰¾ â€œbuild.gradleâ€ æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œæœå¯»è·¯å¾„å¦‚ä¸‹:</p>
<ol>
<li>It looks in a directory called master which has the same nesting level as the current dir.</li>
<li>If not found yet, it searches parent directories.</li>
<li>If not found yet, the build is executed as a single project build.</li>
<li>If a settings.gradle file is found, Gradle checks if the current project is part of the multiproject hierarchy defined in the found settings.gradle file. If not, the build is executed as a single project build. Otherwise a multiproject build is executed.</li>
</ol>
<blockquote>
<p>è¿™ä¸ªæœç´¢è¿‡ç¨‹å¾ˆå¥‡æ€ªï¼Œå› ä¸ºå®é™…ä¸Š Gradle çš„æ„å»ºé¡¹ç›®å¹¶ä¸ä¸€å®šåªåµŒå¥—ä¸¤å±‚ã€‚</p>
</blockquote>
<p>ä¸ºä»€ä¹ˆè¦è¿›è¡Œè¿™æ ·çš„æœç´¢å‘¢ï¼ŸGradle åœ¨æ‰§è¡Œæ„å»ºçš„æ—¶å€™æ˜¯éœ€è¦ç¡®è®¤æ˜¯ä¸æ˜¯åœ¨å¤šé¡¹ç›®ä¸‹çš„å­é¡¹ç›®ä¸­ã€‚å¦‚æœæ˜¯åœ¨å­é¡¹ç›®ä¸­ï¼Œé‚£ä¹ˆåªæœ‰å­é¡¹ç›®ä»¥åŠå®ƒä»¬ä¾èµ–çš„å­é¡¹ç›®ä¼šè¢«æ„å»ºï¼Œä½†æ˜¯ä¸€äº›é…ç½®ä»¥åŠä¾èµ–å…³ç³»æ˜¯éœ€è¦ä»å¤šé¡¹ç›®æ„å»ºé…ç½®ä¸­è¯»å–çš„ï¼Œå› æ­¤è¿˜æ˜¯éœ€è¦ç¡®è®¤ç©¶ç«Ÿæ˜¯ä¸æ˜¯å¤šé¡¹ç›®ã€‚å¼€å‘è€…å¯ä»¥ä½¿ç”¨<code>-u</code>å‘½ä»¤æ¥å‘Šè¯‰ Gradle ä¸è¦è¿›è¡Œæœç´¢ï¼Œé‚£ä¹ˆå½“å‰é¡¹ç›®å°±ä¼šè¢«å½“åšå•é¡¹ç›®è¿›è¡Œæ„å»ºï¼Œå¦‚æœå½“å‰é¡¹ç›®åŒ…å« â€œsettings.gradleâ€ æ–‡ä»¶ï¼Œåˆ™<code>-u</code>æ— æ•ˆã€‚</p>
<p>å¦å¤–ï¼Œä»¥ä¸Šçš„æœç´¢æ–¹æ³•åªé€‚åˆäº physical hierarchical æˆ–è€… flat layout ç±»å‹çš„æ„å»ºé¡¹ç›®ã€‚</p>
<blockquote>
<p>ä¸äº†è§£è¿™ä¸¤ä¸ªæ¦‚å¿µçš„ï¼Œå¯ä»¥åœ¨æ–‡ç« <a href="http://www.muzileecoding.com/gradlestudy/gradle-project-and-script.html" target="_blank" rel="noopener">Gradle é¡¹ç›®å’Œè„šæœ¬</a>ä¸­æŸ¥è¯¢åˆ°ã€‚</p>
</blockquote>
<h2 id="å››ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#å››ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å››ã€ç”Ÿå‘½å‘¨æœŸ"></a>å››ã€ç”Ÿå‘½å‘¨æœŸ</h2><p>Gradle çš„æ„å»ºåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œåœ¨è¿™äº›é˜¶æ®µä¹‹é—´ï¼Œå¼€å‘è€…æ˜¯å¯ä»¥æ”¶åˆ°ä¸€äº›å›è°ƒçš„ï¼Œå›è°ƒåˆ†ä¸ºä¸¤ç±»: </p>
<ol>
<li>å®ç°æŸä¸€ç±»å‹çš„ç›‘å¬æ¥å£ï¼›</li>
<li>æä¾›ä¸€ä¸ªå›è°ƒé—­åŒ…ä»¥ä¾›è°ƒç”¨ï¼›</li>
</ol>
<p>ä¸‹é¢éƒ½æ˜¯ä»¥é—­åŒ…çš„å½¢å¼ä¸¾å¾—ä¾‹å­ï¼Œå¹¶ä¸”ä¹Ÿä¸å…¨é¢ï¼Œå»ºè®®ç›´æ¥é˜…è¯» API æ–‡æ¡£è·å–æ›´å¤šçš„æ–¹æ³•ã€‚</p>
<h4 id="4-1-Project-evaluation"><a href="#4-1-Project-evaluation" class="headerlink" title="4.1 Project evaluation"></a>4.1 Project evaluation</h4><p>åœ¨ä¸€ä¸ª Project è¢« evaluate(è¿™ä¸ªè¯å§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°å¥½çš„ç¿»è¯‘ï¼Œå®è·µä¸­å®ƒæ˜¯æŒ‡å‘ Configuration ä¹‹åï¼ŒExecution ä¹‹å‰çš„ä¸€ä¸ªé˜¶æ®µï¼Œæ‰€ä»¥åº”è¯¥æ˜¯æŒ‡Projectè¢«é…ç½®å¥½) ä¹‹åï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªå›è°ƒï¼Œé€šè¿‡è¿™ä¸ªå›è°ƒå¯ä»¥æ·»åŠ é¢å¤–çš„é…ç½®ï¼Œæˆ–è€…æ‰“ä¸€äº› Log:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    afterEvaluate &#123; project -&gt;</span><br><span class="line">        <span class="keyword">if</span> (project.hasTests) &#123;</span><br><span class="line">            println <span class="string">"Adding test task to $project"</span></span><br><span class="line">            project.task(<span class="string">'test'</span>) &lt;&lt; &#123;</span><br><span class="line">                println <span class="string">"Running tests for $project"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œåœ¨æœ‰<code>hasTests</code>å±ç›¸çš„Projectä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>test</code>çš„ Taskã€‚è¿™å°±æ˜¯é€šè¿‡æä¾›é—­åŒ…çš„å½¢å¼åœ¨ç”Ÿå‘½å‘¨æœŸçš„æŸä¸ªèŠ‚ç‚¹ä¸Šæ·»åŠ åŠ¨ä½œçš„æ•ˆæœã€‚</p>
<p>ä½†æœ‰æ—¶å€™ evaluate ä¼šå¤±è´¥ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™éœ€è¦æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±åº”è¯¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªå›è°ƒ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gradle.afterProject &#123;project, projectState -&gt;</span><br><span class="line">    <span class="keyword">if</span> (projectState.failure) &#123;</span><br><span class="line">        println <span class="string">"Evaluation of $project FAILED"</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        println <span class="string">"Evaluation of $project succeeded"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥å¯¹ Gradle å¯¹è±¡æ·»åŠ  <code>ProjectEvaluationListener</code> æ¥ç›‘å¬è¿™äº›äº‹ä»¶ã€‚</p>
<h4 id="4-2-Task-creation"><a href="#4-2-Task-creation" class="headerlink" title="4.2 Task creation"></a>4.2 Task creation</h4><p>åœ¨ä¸€ä¸ª Task è¢«æ·»åŠ åˆ° Project çš„æ—¶å€™ï¼ˆä¹Ÿå°±æ˜¯åˆ›å»ºçš„æ—¶å€™ï¼‰ï¼Œä¹Ÿå¯ä»¥æ”¶åˆ°å›è°ƒï¼Œè¿™å¯ä»¥è¢«ç”¨æ¥è®¾ç½®ä¸€äº›é»˜è®¤å€¼æˆ–è€…æ·»åŠ è¡Œä¸º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks.whenTaskAdded &#123; task -&gt;</span><br><span class="line">    task.ext.srcDir = <span class="string">'src/main/java'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task a</span><br><span class="line"></span><br><span class="line">println <span class="string">"source dir is $a.srcDir"</span></span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡åœ¨<code>TaskContainer</code>ä¸­æ·»åŠ  Action æ¥è¾¾åˆ°ç›®çš„ã€‚</p>
<h5 id="4-2-1-Task-execution-graph-ready"><a href="#4-2-1-Task-execution-graph-ready" class="headerlink" title="4.2.1 Task execution graph ready"></a>4.2.1 Task execution graph ready</h5><p>å‰é¢è¯´äº†ï¼Œå¼€å‘è€…å®šä¹‰å®Œ Task ä»¥åŠå®ƒä»¬çš„ä¾èµ–å…³ç³»ä¹‹åï¼Œåœ¨æ‰§è¡Œå‰ä¼šç”Ÿæˆ Task execution graphã€‚åœ¨ç”Ÿæˆå®Œè¿™å¼ å›¾ï¼ˆConfiguration é˜¶æ®µå®Œæˆï¼‰ä¹‹åä¹Ÿä¼šæ”¶åˆ°ä¸€ä¸ªå›è°ƒï¼Œåˆ©ç”¨è¿™ä¸ªå›è°ƒï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ˜¯å¦æœ‰æˆ‘ä»¬éœ€è¦çš„ Taskï¼Œä»¥åŠæ•´ä¸ª Graph çš„çŠ¶æ€æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œæ¯”å¦‚:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">task distribution &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">"We build the zip with version=$version"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">task <span class="title">release</span><span class="params">(dependsOn: <span class="string">'distribution'</span>)</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'We release now'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.whenReady &#123;taskGraph -&gt;</span><br><span class="line">    <span class="keyword">if</span> (taskGraph.hasTask(release)) &#123;</span><br><span class="line">        version = <span class="string">'1.0'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        version = <span class="string">'1.0-SNAPSHOT'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>gradle -q distribution</code>ä¹‹åï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt;gradle -q distribution
We build the zip with version=1.0-SNAPSHOT
</code></pre><p>æ‰§è¡Œ<code>gradle -q release</code>ä¹‹åï¼Œè¾“å‡ºåˆ™å¦‚ä¸‹:</p>
<pre><code>&gt;gradle -q release
We build the zip with version=1.0
We release now
</code></pre><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸€ä¸ª Task è¢«æ‰§è¡Œä¹‹å‰æ ¹æ®ç¯å¢ƒå¯¹å®ƒè¿›è¡Œæ§åˆ¶ã€‚</p>
<p>å¦å¤–ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ <code>TaskExecutionGraphListener</code>ç›‘å¬åˆ°<code>TaskExecutionGraph</code>æ¥æ¥æ”¶äº‹ä»¶ã€‚</p>
<h5 id="4-2-2-Task-execution"><a href="#4-2-2-Task-execution" class="headerlink" title="4.2.2 Task execution"></a>4.2.2 Task execution</h5><p>åœ¨ Task æ‰§è¡Œå‰åä¹Ÿå¯ä»¥æ¥å—å›è°ƒäº‹ä»¶ï¼Œå¹¶ä¸”æ— è®ºæ˜¯å¦æ‰§è¡ŒæˆåŠŸéƒ½èƒ½æ”¶åˆ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">task ok</span><br><span class="line"></span><br><span class="line"><span class="function">task <span class="title">broken</span><span class="params">(dependsOn: ok)</span> &lt;&lt; </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'broken'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.beforeTask &#123; Task task -&gt;</span><br><span class="line">    println <span class="string">"executing $task ..."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.afterTask &#123; Task task, TaskState state -&gt;</span><br><span class="line">    <span class="keyword">if</span> (state.failure) &#123;</span><br><span class="line">        println <span class="string">"FAILED"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        println <span class="string">"done"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸€ä¸‹<code>gradle -q broken</code>ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt; gradle -q broken
executing task &apos;:ok&apos; ...
done
executing task &apos;:broken&apos; ...
FAILED
</code></pre><h2 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h2><p>Gradle æ‰§è¡Œæ„å»ºçš„ä¸‰ä¸ªé˜¶æ®µéå¸¸æ¸…æ¥šï¼Œæä¾›äº†å¤šç§æ–¹å¼è®©å¼€å‘è€…æœ‰æœºä¼šç›‘å¬ã€æ›´æ”¹æ„å»ºçŠ¶æ€ï¼Œè¿™ä¹Ÿæ˜¯ Gradle å¼ºå¤§ã€çµæ´»çš„åŸå› ä¹‹ä¸€ã€‚</p>
<p>é™¤äº†ä¸Šé¢æåˆ°çš„è¿™äº›æ–¹æ³•ï¼Œç›‘å¬å£°æ˜å‘¨æœŸçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¸»è¦é›†ä¸­åœ¨<code>TaskExecutionGraph</code>ã€<code>Gradle</code>å’Œ<code>Project</code>ä¸‰ä¸ªç±»ä¸­ï¼Œå…¨éƒ¨åˆ—å‡ºæ¥æ„ä¹‰ä¸å¤§ï¼Œå»ºè®®è¯»è€…åœ¨æœ‰éœ€æ±‚çš„æ—¶å€™å¯ä»¥å°†ç›¸å…³æ–¹æ³•éƒ½ç ”ç©¶ä¸€ä¸‹ï¼Œæ³¨é‡Šè¿˜æ˜¯æ¯”è¾ƒå…¨é¢çš„ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—åä¸€ï¼šDaemon]]></title>
      <url>http://www.timebridge.space/2016/06/18/gradle-daemon/</url>
      <content type="html"><![CDATA[<p>ç»´åŸºç™¾ç§‘å®šä¹‰:</p>
<blockquote>
<p>A daemon is a computer program that runs as a background process, rather than being under the direct control of an interactive user.</p>
</blockquote>
<p>Gradle è¿è¡Œåœ¨ JVM ä¸Šï¼Œéœ€è¦è€—è´¹ä¸€å®šçš„æ—¶é—´è¿è¡Œå¤šä¸ªæ”¯æŒåº“ï¼Œå› æ­¤çœ‹ä¸Šå»è¿è¡Œèµ·æ¥æ¯”è¾ƒæ…¢ï¼ŒGradle ä½¿ç”¨ Daemon æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š<strong>é€šè¿‡ä¸€ä¸ªé•¿æœŸè¿è¡Œåœ¨åå°æ¥æ‰§è¡Œæ„å»ºçš„è¿›ç¨‹ï¼Œå¯ä»¥ç¼“å­˜ä¸€äº›æ„å»ºæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œåˆ©ç”¨ JVM åœ¨è¿è¡Œä»£ç æœŸé—´å¯¹ä»£ç çš„ä¼˜åŒ–ï¼ˆé¿å…æ¯æ¬¡è¿è¡Œéƒ½åšä¼˜åŒ–ï¼‰æ¥æé«˜æ„å»ºé€Ÿåº¦</strong>ã€‚</p>
<p>å†³å®šæ˜¯å¦ä½¿ç”¨ Daemon åªéœ€è¦ç®€å•çš„é…ç½®å³å¯ï¼Œä¸”ä½¿ç”¨å’Œä¸ä½¿ç”¨ Daemon çš„æ—¶å€™æ„å»ºæ²¡æœ‰ä»»ä½•ä¸åŒã€‚<a id="more"></a></p>
<h3 id="1-æ‰“å¼€Daemon"><a href="#1-æ‰“å¼€Daemon" class="headerlink" title="1. æ‰“å¼€Daemon"></a>1. æ‰“å¼€Daemon</h3><p><strong>é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸æ‰“å¼€ Daemon çš„ï¼Œä½†æ˜¯å¼ºçƒˆå»ºè®®åœ¨å¼€å‘æœºå™¨ä¸Šæ‰“å¼€è¿™ä¸ªé…ç½®ï¼ˆæŒç»­é›†æˆæœåŠ¡å™¨ä¸Šå…³é—­ï¼‰ã€‚</strong> æœ‰å¾ˆå¤šæ–¹å¼æ‰“å¼€ Daemonï¼Œä½†æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼æ˜¯åœ¨<code>Â«USER_HOMEÂ»/.gradle/gradle.properties</code>ä¸­åŠ å…¥ä¸‹é¢ä¸€è¡Œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.gradle.daemon=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Â«USER_HOMEÂ» é€šå¸¸çš„ç›®å½•æ˜¯:</p>
<ol>
<li>C:\Users\<username> (Windows Vista &amp; 7+)</username></li>
<li>/Users/<username> (Mac OS X)</username></li>
<li>/home/<username> (Linux)</username></li>
</ol>
<p>å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”æ–‡ä»¶ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªã€‚</p>
</blockquote>
<p>ä¸€æ—¦æ‰“å¼€ Daemonï¼Œä¸è®º Gradle æ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼Œæ‰€æœ‰çš„æ„å»ºéƒ½ä¼šå¾—åˆ°é€Ÿåº¦çš„æå‡ã€‚</p>
<p>é™¤äº†ä¸Šé¢çš„æ–¹æ³•ï¼Œè¿˜å¯ä»¥é€šè¿‡æ·»åŠ <code>--daemon</code>æˆ–è€…<code>--no-daemon</code>æ¥å¯¹å•æ¬¡æ„å»ºè¿›è¡Œé…ç½®ã€‚</p>
<h3 id="2-å…³é—­Daemon"><a href="#2-å…³é—­Daemon" class="headerlink" title="2. å…³é—­Daemon"></a>2. å…³é—­Daemon</h3><p>æ¯ä¸€ä¸ª Gradle Daemon è¿›ç¨‹åœ¨3å°æ—¶æ— æ´»åŠ¨çš„æƒ…å†µä¸‹éƒ½ä¼šè‡ªåŠ¨å…³é—­ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ‰§è¡Œ<code>gradle --stop</code>å‘½ä»¤æ˜¾ç¤ºçš„å…³é—­å®ƒ â€”â€” è¿™ä¸ªå‘½ä»¤ä¼šå…³é—­æ‰€æœ‰çš„æ‰§è¡Œè¯¥å‘½ä»¤æ‰€ç”¨åŒä¸€ç‰ˆæœ¬çš„ Gradle å”¤èµ·çš„ Daemon è¿›ç¨‹ã€‚</p>
<blockquote>
<p>å¦‚æœå®‰è£…äº† JDKï¼Œå¯ä»¥å¾ˆç®€å•ä½¿ç”¨<code>jps</code>å‘½ä»¤æŸ¥çœ‹å…³é—­æƒ…å†µã€‚</p>
<p>æœ‰æ—¶å€™ä¼šæœ‰å¤šä¸ª Gradle Daemon è¿›ç¨‹ï¼ŒåŸå› å¯èƒ½æ˜¯å› ä¸º Gradle æ‰¾ä¸åˆ°ç©ºé—²çš„ Daemon è¿›ç¨‹å’Œ Compatible è¿›ç¨‹ï¼ˆæ¯”å¦‚ JVM é…ç½®ä¸ç¬¦åˆå½“å‰æ„å»ºçš„è¦æ±‚ï¼‰â€”â€” å…³äºè¿™å—ï¼Œæ–‡æ¡£ä¸­æœ‰è¯¦ç»†çš„æè¿°ã€‚</p>
<p>å®é™…åœ¨å…³é—­ä¹‹åè¿˜æ˜¯ä¼šçœ‹åˆ°<code>GradleDaemon</code>å‘½åçš„è¿›ç¨‹ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—åï¼šWarpper]]></title>
      <url>http://www.timebridge.space/2016/06/18/gradle-wrapper/</url>
      <content type="html"><![CDATA[<p>å¤§éƒ¨åˆ†çš„è½¯ä»¶éƒ½éœ€è¦æå‰å®‰è£…æ‰èƒ½ä½¿ç”¨ï¼Œå¦‚æœå®‰è£…å¾ˆç®€å•é‚£ä¹ˆè¿˜å¯ä»¥æ¥å—ï¼Œä½†æ˜¯æœ‰æ—¶å€™å®‰è£…éœ€è¦è€ƒè™‘ç‰ˆæœ¬é—®é¢˜ã€é…ç½®ç¯å¢ƒï¼Œæ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚æ„å»ºè½¯ä»¶çš„å·¥å…·ç‰ˆæœ¬æœ‰æ—¶å€™è¿˜æ˜¯éšç€è½¯ä»¶çš„è¿­ä»£è¿›è¡Œå‡çº§çš„ï¼Œè¿™æ ·å®‰è£…æ„å»ºå·¥å…·æ›´åŠ éº»çƒ¦ã€‚</p>
<p>Wrapper æ˜¯ Gradle æä¾›æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚<a id="more"></a></p>
<h3 id="æ·»åŠ Wrapper"><a href="#æ·»åŠ Wrapper" class="headerlink" title="æ·»åŠ Wrapper"></a>æ·»åŠ Wrapper</h3><p>åœ¨ä¸Šé¢è®²<code>gradle tasks</code>å‘½ä»¤çš„æ—¶å€™ï¼Œæœ‰ä¸€ç»„ Task è¢«å½’ç±»ä¸º<code>Build Setup tasks</code>ï¼Œå®ƒä»¬æ˜¯ç”¨æ¥åˆå§‹åŒ–ä¸€ä¸ªæ„å»ºé¡¹ç›®çš„ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹é¢æ‰§è¡Œ<code>gradle init</code>å‘½ä»¤ï¼Œå†æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶å¤¹çš„å†…å®¹ï¼Œä¼šå‘ç°å†…å®¹å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/gradleé¡¹ç›®åˆå§‹çŠ¶æ€.png" alt="gradleé¡¹ç›®åˆå§‹çŠ¶æ€"></div>

<p>å¦‚å›¾ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Gradle æ„å»ºé¡¹ç›®çš„é…ç½®ã€‚</p>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªå‘½ä»¤æ˜¯<code>gradle wrapper</code>ï¼Œåœ¨æˆ‘ä»¬æœ€å¼€å§‹çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ–°å»ºäº†ä¸€ä¸ª<code>build.gradle</code>æ–‡ä»¶ï¼Œæ‰§è¡Œè¯¥å‘½ä»¤ä¹‹åï¼Œä¹Ÿèƒ½å¾—åˆ°å¦‚ä¸Šçš„æ–‡ä»¶ç»“æ„(ä¸è¿‡æ²¡æœ‰<code>settings.gradle</code>æ–‡ä»¶)ã€‚è¿™ä¸ªå‘½ä»¤å®é™…å¯ä»¥æŒ‡å®šéœ€è¦é…ç½®çš„ Wrapper çš„ç‰ˆæœ¬ï¼Œå¦‚ä¸‹:<code>gradle wrapper --gradle-version 2.0</code>å³å¯ã€‚</p>
<p>åœ¨è¿™äº›æ–‡ä»¶ä¸­ï¼Œæœ‰å››ä¸ªæ–‡ä»¶å°±æ˜¯ä¸º Wrapper åŠŸèƒ½ç”Ÿæˆçš„:</p>
<ol>
<li>gradlew (Unix Shell script)</li>
<li>gradlew.bat (Windows batch file)</li>
<li>gradle/wrapper/gradle-wrapper.jar (Wrapper JAR)</li>
<li>gradle/wrapper/gradle-wrapper.properties (Wrapper properties)</li>
</ol>
<h3 id="Wrapperä½¿ç”¨"><a href="#Wrapperä½¿ç”¨" class="headerlink" title="Wrapperä½¿ç”¨"></a>Wrapperä½¿ç”¨</h3><p>å¦‚æœé¡¹ç›®é…ç½®äº† Gradle Wrapper (å­˜åœ¨ä¸Šé¢çš„ç›®å½•ç»“æ„)ï¼Œå°±å¯ä»¥åœ¨æ ¹ç›®å½•ä¸‹é¢æ‰§è¡Œä¸‹é¢ä¸¤ä¸ªå‘½ä»¤:</p>
<ul>
<li><strong><code>./gradlew &lt;task&gt;</code></strong> ï¼ˆåœ¨ç±»Unixæœºå™¨ä¸Šï¼Œæ¯”å¦‚Linuxæˆ–è€…Macï¼‰</li>
<li><strong><code>gradlew &lt;task&gt;</code></strong> ï¼ˆåœ¨Windowsæœºå™¨ä¸Šï¼‰</li>
</ul>
<p>å› ä¸ºæ¯ä¸€ä¸ª Wrapper éƒ½æŒ‡å®šäº†ä¸€ä¸ªç‰¹å®šç‰ˆæœ¬çš„ Gradleï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡æ‰§è¡Œä»¥ä¸Šå‘½ä»¤çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šå»ä¸‹è½½å¯¹åº”ç‰ˆæœ¬ Gradleï¼Œç„¶åç”¨è¿™ä¸ªç‰ˆæœ¬å»æ„å»ºé¡¹ç›®â€”â€”ä¸‹è½½çš„ Gradle å­˜æ”¾åœ¨<code>$USER_HOME/.gradle/wrapper/dists</code>ã€‚</p>
<blockquote>
<p>Wrapperæä¾›äº†ç»‘å®š Gradle ç‰ˆæœ¬åˆ°é¡¹ç›®ä»¥åŠä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ Gradle çš„èƒ½åŠ›ï¼Œè¿™æ ·åªéœ€è¦æŠŠ Wrapper ç›¸å…³æ–‡ä»¶å’Œé¡¹ç›®ä¸€èµ·æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶å·¥å…·ä¸­ï¼Œå°±å¯ä»¥ä¿è¯ä»¥åæ„å»ºè¿™ä¸ªé¡¹ç›®çš„æ—¶å€™ï¼Œå§‹ç»ˆä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªç‰ˆæœ¬çš„æ„å»ºå·¥å…·ã€‚</p>
</blockquote>
<p>å¦‚æœä½¿ç”¨ Wrapper æ„å»ºï¼Œé‚£ä¹ˆæœ¬æœºä¸Šçš„ä»»ä½•æ„å»ºç‰ˆæœ¬éƒ½ä¼šè¢«å¿½ç•¥ã€‚</p>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>åœ¨<code>gradle-wrapper.properties</code>æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªé…ç½®é¡¹å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distributionUrl=https\:<span class="comment">//services.gradle.org/distributions/gradle-2.3-bin.zip</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª Url æŒ‡å®šäº† Gradle çš„ä¸‹è½½åœ°å€ï¼Œå¯ä»¥ä¿®æ”¹è¿™ä¸ªåœ°å€ä¸‹è½½ä¸åŒç‰ˆæœ¬çš„ Gradleã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—å…­ï¼šå‘½ä»¤è¡Œ]]></title>
      <url>http://www.timebridge.space/2016/06/18/gradle-command/</url>
      <content type="html"><![CDATA[<p>å½“çœ‹å®Œ Task å…¥é—¨ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å†™ä¸€äº›ç®€å•çš„è„šæœ¬äº†ã€‚ä¸‹é¢æ¥ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹ Gradle å‘½ä»¤è¡Œç›¸å…³å†…å®¹ã€‚</p>
<p>ä»¥ä¸‹é¢è„šæœ¬ä¸ºä¾‹ï¼š<a id="more"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">task compile &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'compiling source'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">task <span class="title">compileTest</span><span class="params">(dependsOn: compile)</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'compiling unit tests'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¾èµ–ä¸¤ä¸ªTask</span></span><br><span class="line"><span class="function">task <span class="title">test</span><span class="params">(dependsOn: [compile, compileTest])</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'running unit tests'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">task <span class="title">dist</span><span class="params">(dependsOn: [compile, test])</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'building the distribution'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¾èµ–å…³ç³»å¦‚ä¸‹:<br><img src="https://docs.gradle.org/current/userguide/img/commandLineTutorialTasks.png" alt="è„šæœ¬ä¾èµ–å…³ç³»"></p>
<h3 id="1-Excluding-tasks"><a href="#1-Excluding-tasks" class="headerlink" title="1. Excluding tasks"></a>1. Excluding tasks</h3><p>å¯ä»¥ä½¿ç”¨<code>-x</code>é€‰é¡¹å‰”é™¤ä¸€ä¸ª Task çš„æ‰§è¡Œï¼Œæ¯”å¦‚é’ˆå¯¹ä»¥ä¸Šè„šæœ¬ï¼Œæˆ‘ä»¬è¿è¡Œ<code>gradle dist -x test</code>ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt; gradle dist -x test
:compile
compiling source
:dist
building the distribution

BUILD SUCCESSFUL

Total time: 1 secs
</code></pre><p>åªæœ‰ compile å’Œ dist ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œäº†ï¼Œtest ä»¥åŠè¢« test ä¾èµ–çš„ compileTest éƒ½æ²¡æœ‰æ‰§è¡Œã€‚å¦å¤–è™½ç„¶ test æ²¡æœ‰æ‰§è¡Œï¼Œä½†æ˜¯ä¾èµ– test çš„ dist è¿˜æ˜¯æ‰§è¡Œå®Œæˆäº†ï¼Œè¿™è¯´æ˜<code>dependOn</code>å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªå¼ºä¾èµ–ã€‚</p>
<h3 id="2-Task-name-abbreviation"><a href="#2-Task-name-abbreviation" class="headerlink" title="2. Task name abbreviation"></a>2. Task name abbreviation</h3><p>æ‰§è¡ŒTaskçš„æ—¶å€™å¯ä»¥ä½¿ç”¨ Task åå­—ç¼©å†™ï¼Œæ¯”å¦‚æ‰§è¡Œ dist å¯ä»¥ä½¿ç”¨<code>gradle -q di</code>ï¼Œæ‰§è¡Œ compileTest å¯ä»¥ä½¿ç”¨<code>gradle compTest</code>æˆ–è€…<code>gradle cT</code>ã€‚</p>
<h3 id="3-Selecting-which-build-to-execute"><a href="#3-Selecting-which-build-to-execute" class="headerlink" title="3. Selecting which build to execute"></a>3. Selecting which build to execute</h3><p>ä¸€èˆ¬æˆ‘ä»¬æ‰§è¡Œ<code>gradle</code>å‘½ä»¤çš„æ—¶å€™ï¼ŒGradle ä¼šåœ¨å½“å‰ç›®å½•ä¸‹å¯»æ‰¾è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>-b</code>é€‰é¡¹æ¥æŒ‡å®šå…¶ä½™è·¯å¾„ä¸‹é¢çš„è„šæœ¬æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle -q -b subdir/myproject.gradle hello</span><br></pre></td></tr></table></figure>
<p>ä¸€æ—¦ä½¿ç”¨äº†<code>-b</code>é€‰é¡¹ï¼Œé‚£ä¹ˆ â€œsettings.gradleâ€ æ–‡ä»¶å°†ä¸ä¼šè¢«ä½¿ç”¨ã€‚å¯¹äºå¤šé¡¹ç›®è„šæœ¬ï¼Œå¯ä»¥ä½¿ç”¨<code>-p</code>æŒ‡å®šç›®å½•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle -q -p subdir hello</span><br></pre></td></tr></table></figure>
<h3 id="4-è·å–è„šæœ¬æ–‡ä»¶ä¿¡æ¯"><a href="#4-è·å–è„šæœ¬æ–‡ä»¶ä¿¡æ¯" class="headerlink" title="4. è·å–è„šæœ¬æ–‡ä»¶ä¿¡æ¯"></a>4. è·å–è„šæœ¬æ–‡ä»¶ä¿¡æ¯</h3><p>é€šè¿‡<code>gradle tasks</code>å‘½ä»¤èƒ½çœ‹åˆ°å½“å‰å¯æ‰§è¡Œçš„æ‰€æœ‰ Taskã€‚æ¯ä¸€ä¸ª Task åé¢éƒ½ä¼šè·Ÿä¸Š description ç”¨äºæè¿° Task çš„å…·ä½“åŠŸèƒ½ï¼ˆç­‰è®²åˆ°è„šæœ¬çš„ç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™ï¼Œä¼šæåˆ°å¦‚ä½•ä¸ºä¸€ä¸ª Task æ·»åŠ æè¿°ï¼‰ã€‚åœ¨æˆ‘çš„è„šæœ¬ä¸­æ‰§è¡Œ<code>gradle -q tasks</code>ï¼Œå¯ä»¥è·å¾—å¦‚ä¸‹è¾“å‡º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------</span><br><span class="line">All tasks runnable from root project</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build Setup tasks</span><br><span class="line">-----------------</span><br><span class="line">init - Initializes a <span class="keyword">new</span> Gradle build. [incubating]</span><br><span class="line">wrapper - Generates Gradle wrapper files. [incubating]</span><br><span class="line"></span><br><span class="line">Help tasks</span><br><span class="line">----------</span><br><span class="line">components - Displays the components produced by root project <span class="string">'gradle'</span>. [incubating]</span><br><span class="line">dependencies - Displays all dependencies declared in root project <span class="string">'gradle'</span>.</span><br><span class="line">dependencyInsight - Displays the insight into a specific dependency in root project <span class="string">'gradle'</span>.</span><br><span class="line">help - Displays a help message.</span><br><span class="line">projects - Displays the sub-projects of root project <span class="string">'gradle'</span>.</span><br><span class="line">properties - Displays the properties of root project <span class="string">'gradle'</span>.</span><br><span class="line">tasks - Displays the tasks runnable from root project <span class="string">'gradle'</span>.</span><br><span class="line"></span><br><span class="line">To see all tasks and more detail, run gradle tasks --all</span><br><span class="line"></span><br><span class="line">To see more detail about a task, run gradle help --task &lt;task&gt;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥æ‰“å°å‡ºæ‰€æœ‰å¯æ‰§è¡Œçš„ Taskï¼ŒåŒ…æ‹¬å­ Project ä¸­çš„ Taskã€‚æ¯ä¸€ä¸ª Task åé¢éƒ½è·Ÿç€è¿™ä¸ª Task çš„åŠŸèƒ½æè¿°ã€‚</p>
<p>å…¶ä¸­<code>Help tasks</code>ä¸­çš„ Task å¯ä»¥è·å–å…³äºæœ¬è„šæœ¬çš„å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚<code>gradle dependencies</code>å¯ä»¥åˆ—å‡ºæ ¹é¡¹ç›®æ‰€ä¾èµ–çš„é¡¹ç›®ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JavaåŠ¨æ€ä»£ç†å®ç°]]></title>
      <url>http://www.timebridge.space/2016/06/14/aidl-demo/</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><strong>AIDL</strong> ï¼Œå…¨ç§° Android Interface Definition Languageï¼Œæ˜¯ç”¨äºå®šä¹‰ IPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„äº¤äº’æ¥å£çš„ã€‚</p>
<p>åœ¨ Android ä¸Šï¼Œè¿›ç¨‹ä¹‹é—´æ˜¯ä¸èƒ½ç›´æ¥é€šä¿¡çš„ï¼Œå¿…é¡»é€šè¿‡æ“ä½œç³»ç»Ÿå¯¹æ•°æ®è¿›è¡Œè½¬åŒ–ä¼ è¾“ï¼Œæ‰èƒ½æ‰“ç ´è¿›ç¨‹è¾¹ç•Œï¼Œå®Œæˆè¿›è¡Œé€šä¿¡ã€‚è¿™ä¸ªè¿‡ç¨‹å¦‚æœæ‰‹åŠ¨å®Œæˆä¼šæ¯”è¾ƒæ¯ç‡¥å¤æ‚ï¼Œ Android ä¸Šçš„ IPC å®é™…ä¾èµ–çš„æ˜¯åº•å±‚ Binder æ¡†æ¶ï¼Œè€Œ <strong>AIDL</strong> æ˜¯ Android åœ¨ Java å±‚å¯¹ Binder æœºåˆ¶çš„å°è£…ã€‚<a id="more"></a></p>
<p>å®˜ç½‘ä»‹ç» <strong>AIDL</strong> çš„åœ°å€æ˜¯ <a href="https://developer.android.com/guide/components/aidl.html" target="_blank" rel="noopener">Android Interface Definition Language (AIDL)</a>ã€‚æœ¬æ–‡ä¸»è¦æ˜¯å®è·µä¸€ä¸ªä¾‹å­ï¼Œå…·ä½“è¯¦ç»†çš„å†…å®¹è¯»è€…å¯ä»¥ç›´æ¥çœ‹å®˜ç½‘ï¼Œæœ¬æ–‡ä¸åšä»‹ç»ï¼Œä¸»è¦åŒ…æ‹¬:</p>
<ol>
<li><strong>AIDL</strong> æ”¯æŒçš„æ•°æ®ç±»å‹ï¼ˆä¸‹é¢ä¾‹å­ä¸­ä¹Ÿèƒ½çœ‹åˆ°ï¼‰ï¼›</li>
<li>ä»€ä¹ˆæ—¶å€™åº”å½“ä½¿ç”¨ <strong>AIDL</strong>ï¼ˆè¿˜æœ‰Messengerç­‰IPCæ–¹å¼ï¼‰ï¼›</li>
</ol>
<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><h4 id="AIDL-æ–‡ä»¶çš„åˆ›å»º"><a href="#AIDL-æ–‡ä»¶çš„åˆ›å»º" class="headerlink" title="AIDL æ–‡ä»¶çš„åˆ›å»º"></a>AIDL æ–‡ä»¶çš„åˆ›å»º</h4><p>é¦–å…ˆåœ¨é¡¹ç›®<code>A</code>ä¸‹é¢å³å‡»ä¸€ä¸ª module ï¼Œé€‰æ‹©â€Newâ€ -&gt; â€œFolderâ€ -&gt; â€œAIDL Folderâ€ï¼Œå°±å¯ä»¥åœ¨ module ä¸‹é¢æ–°å»ºä¸€ä¸ª aidl æ–‡ä»¶å¤¹ï¼Œå…·ä½“å¦‚ä¸‹:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/aidl_foler.png" width="250" alt="AIDL æ–‡ä»¶å¤¹"></div>

<p>ç„¶åæˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢æ–°å»ºä¸€ä¸ªåŒ…ï¼Œæ¯”å¦‚â€com.footprint.littleshellâ€ï¼Œç„¶åé€‰æ‹©â€Newâ€ -&gt; â€œAIDLâ€ -&gt; â€œAIDL Fileâ€ï¼Œè¾“å…¥æ–‡ä»¶åï¼Œå°±å¯ä»¥æ–°å»ºä¸€ä¸ª aidl æ–‡ä»¶å‡ºæ¥äº†ï¼Œåœ¨æ–‡ä»¶ä¸­è¾“å…¥å¦‚ä¸‹å†…å®¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.footprint.littleshell.MyRect;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IMyAidlInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">double</span> aDouble, String aString)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MyRect <span class="title">newRect</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªæ¥å£ä»¥åŠ<code>MyRect</code>éƒ½æ˜¯ä»¿ç…§å®˜ç½‘ä¸Šçš„ä¾‹å­å†™çš„ï¼Œå¹¶ä¸”<code>basicTypes</code>æ–¹æ³•åœ¨æ–‡ä»¶åˆ›å»ºçš„æ—¶å€™å°±é»˜è®¤è¢«æ·»åŠ äº†ï¼Œè¡¨æ˜ <strong>AIDL</strong> æ”¯æŒçš„å‡ ç§åŸºæœ¬ç±»å‹ï¼Œè¿™é‡Œæ²¡æœ‰åˆ æ‰ï¼Œç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼Œè€Œ<code>newRect</code>çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¤æ‚å¯¹è±¡ã€‚</p>
<p>Android IPC æˆ–è€…è¯´ <strong>ADIL</strong> ä¼ è¾“å¤æ‚å¯¹è±¡æ˜¯éœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†çš„ï¼Œè¿™ä¸€ç‚¹åœ¨<a href="https://developer.android.com/guide/components/aidl.html#PassingObjects" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸Šæœ‰ç‰¹åˆ«æè¿°ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥:</p>
<ol>
<li>å¤æ‚å¯¹è±¡ç±»å¿…é¡»å®ç°<code>Parcelable</code>æ¥å£(è¿™é‡Œå°±ä¸ç»†è¯´äº†)ï¼›</li>
<li>åˆ›å»º<code>.aidl</code>æ–‡ä»¶æ¥å£°æ˜è¯¥ç±»ï¼›</li>
</ol>
<p>æˆ‘ä»¬ä¸€æ­¥æ­¥ç…§åšï¼Œé¦–å…ˆåˆ›å»º<code>MyRect</code>ç±»ï¼Œå®ƒçš„ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.footprint.littleshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Parcel;</span><br><span class="line"><span class="keyword">import</span> android.os.Parcelable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRect</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> left;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> top;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> right;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bottom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;MyRect&gt; CREATOR = <span class="keyword">new</span></span><br><span class="line">            Parcelable.Creator&lt;MyRect&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> MyRect <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> MyRect(in);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> MyRect[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> MyRect[size];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MyRect</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">        readFromParcel(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">        left = in.readInt();</span><br><span class="line">        top = in.readInt();</span><br><span class="line">        right = in.readInt();</span><br><span class="line">        bottom = in.readInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        dest.writeInt(left);</span><br><span class="line">        dest.writeInt(top);</span><br><span class="line">        dest.writeInt(right);</span><br><span class="line">        dest.writeInt(bottom);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŒ‰è¦æ±‚å®ç°äº†ç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ä¿è¯è¿™ä¸ªç±»å¯ä»¥åœ¨ Android ç³»ç»Ÿä¸Šè¢«åºåˆ—åŒ–ååºåˆ—åŒ–ï¼Œä»è€Œèƒ½å¤Ÿåœ¨è¿›ç¨‹é—´ä¼ é€’ã€‚</p>
<p>ç¬¬äºŒæ­¥å°±æ˜¯åˆ›å»º â€œaidlâ€ æ–‡ä»¶ï¼Œå…·ä½“ä½ç½®å‰é¢çš„æˆªå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ–‡ä»¶åä¸º â€œMyRect.aidlâ€ï¼Œå†…å®¹ä¸º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyRect.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.footprint.littleshell;</span><br><span class="line"></span><br><span class="line">parcelable MyRect;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±å¯ä»¥ç¼–è¯‘é¡¹ç›®äº†ï¼Œç¼–è¯‘å®Œæˆä¹‹åï¼Œå¯ä»¥åœ¨ä¸‹å›¾ä½ç½®æ‰¾åˆ°ç”Ÿæˆçš„æ¥å£æ–‡ä»¶:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/AIDLç”Ÿæˆæ–‡ä»¶ä½ç½®.png" width="250" alt="AIDLç”Ÿæˆæ–‡ä»¶ä½ç½®"></div>

<p>æ–‡ä»¶çš„å…·ä½“å†…å®¹å°±è¯¦ç»†å»çœ‹äº†ï¼Œåé¢ä¼šæœ‰æ–‡ç« è¯¦ç»†å‰–æå®ƒçš„å†…å®¹ï¼Œæœ¬æ–‡ä¸»è¦è®²è¿°å¦‚ä½•å»ç”¨ã€‚</p>
<h4 id="IPC-è°ƒç”¨"><a href="#IPC-è°ƒç”¨" class="headerlink" title="IPC è°ƒç”¨"></a>IPC è°ƒç”¨</h4><p>æ—¢ç„¶æ˜¯ IPCï¼Œå°±å¿…ç„¶æœ‰ Client å’Œ Server ã€‚å…ˆæ¥å†™ä¸€ä¸ª Service:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Return the interface</span></span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">// è¿”å›Stubçš„å®ä¾‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IMyAidlInterface.Stub mBinder = <span class="keyword">new</span> IMyAidlInterface.Stub() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1024</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MyRect <span class="title">newRect</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            MyRect myRect = <span class="keyword">new</span> MyRect();</span><br><span class="line">            myRect.bottom = <span class="number">1</span>;</span><br><span class="line">            myRect.top = <span class="number">2</span>;</span><br><span class="line">            myRect.left = <span class="number">3</span>;</span><br><span class="line">            myRect.right = <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">return</span> myRect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ«å¿˜äº†åœ¨ â€œAndroidManifest.xmlâ€ æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œ:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">	<span class="attr">android:name</span>=<span class="string">".RemoteService"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å†™å®Œå°±å¯ä»¥ run åˆ°ä½ çš„æ‰‹æœºä¸Šäº†ã€‚æ¥ä¸‹æ¥å°±æ¥å†™ Clientã€‚</p>
<p>æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼ŒæŒ‰ç…§å‰é¢åˆ›å»ºæ–‡ä»¶çš„æ­¥éª¤ï¼Œåˆ›å»ºä¸€éåŒæ ·çš„ <strong>AIDL</strong> æ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥ Copy ä¹Ÿå¯ä»¥ã€‚</p>
<p>æ–°å»º<code>AIDLActivity</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.footprint.androidaircraftcarrier.lab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.ComponentName;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.content.ServiceConnection;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.footprint.androidaircraftcarrier.R;</span><br><span class="line"><span class="keyword">import</span> com.footprint.littleshell.IMyAidlInterface;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AIDLActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    Button ipcButton;</span><br><span class="line"></span><br><span class="line">    IMyAidlInterface mService;</span><br><span class="line">    ServiceConnection serviceConnection;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_aidl);</span><br><span class="line"></span><br><span class="line">        serviceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">                mService = IMyAidlInterface.Stub.asInterface(service);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Toast.makeText(AIDLActivity.<span class="keyword">this</span>, mService.newRect().right + <span class="string">""</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ipcButton = (Button)findViewById(R.id.button_service);</span><br><span class="line">        ipcButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">                intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">"com.footprint.littleshell"</span>, <span class="string">"com.footprint.littleshell.RemoteService"</span>));</span><br><span class="line">                bindService(intent, serviceConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ç‚¹å‡» Button ä¹‹åï¼Œè¯¥ App å°±ä¼šå°è¯•è°ƒç”¨<code>RemoteService</code>ï¼Œè€Œ<code>RemoteService</code>å­˜åœ¨äºå¦å¤–ä¸€ä¸ª App ä¸­ï¼Œè¿è¡Œè¯¥ Appï¼Œç‚¹å‡»æŒ‰é’®ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœ:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/IPCè°ƒç”¨.png" width="250" alt="IPCè°ƒç”¨"></div>

<p>å®ƒç¡®å®æ‹¿åˆ°äº†è¿œç¨‹ Service åˆ›å»ºçš„<code>MyRect</code>å®ä¾‹å¯¹è±¡å¹¶è·å–äº†å…¶ä¸­çš„å±æ€§ã€‚è¿™æ ·å°±å®Œæˆäº† IPC è°ƒç”¨ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—åäºŒï¼šé«˜çº§ä¸»é¢˜åˆ—è¡¨]]></title>
      <url>http://www.timebridge.space/2016/06/13/gradle-advaced-topiclist/</url>
      <content type="html"><![CDATA[<p>ä»¥ä¸‹è¿™äº›ä¸»é¢˜ï¼Œæ˜¯è¿›é˜¶Gradleçš„å¿…å¤‡ä¸»é¢˜ï¼Œä½†æ˜¯å®˜ç½‘ä¸Šå…¶å®æœ‰å¯¹åº”çš„å·²ç»æè¿°å¾ˆå¥½çš„æ–‡æ¡£äº†ï¼Œå› æ­¤è¿™é‡Œå°±ä¸é‡å¤åŠ³åŠ¨äº†ï¼Œè¯»è€…å¯ä»¥ä»”ç»†é˜…è¯»è¿™å‡ ç¯‡æ–‡ç« :</p>
<ol>
<li><a href="https://docs.gradle.org/current/userguide/custom_plugins.html" target="_blank" rel="noopener">è‡ªå®šä¹‰Plugin</a></li>
<li><a href="https://docs.gradle.org/current/userguide/custom_tasks.html" target="_blank" rel="noopener">è‡ªå®šä¹‰Taskç±»å‹</a></li>
<li><a href="https://docs.gradle.org/current/userguide/gradle_daemon.html" target="_blank" rel="noopener">Gradle Daemon</a></li>
<li><a href="https://docs.gradle.org/current/userguide/organizing_build_logic.html" target="_blank" rel="noopener">ç»„ç»‡æ„å»ºé€»è¾‘</a></li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—ä¹ï¼šDOæ¨¡å‹]]></title>
      <url>http://www.timebridge.space/2016/06/13/gradle-advaced-do/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€Domain-Object"><a href="#ä¸€ã€Domain-Object" class="headerlink" title="ä¸€ã€Domain Object"></a>ä¸€ã€Domain Object</h2><p>Gradle è„šæœ¬å®é™…ä¸Šæ˜¯é…ç½®è„šæœ¬ï¼Œåœ¨è„šæœ¬æ‰§è¡Œçš„æ—¶å€™ï¼ŒGradleä¼šé…ç½®ä¸€äº›ç‰¹å®šç±»å‹çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å°±è¢«ç§°ä¸ºè„šæœ¬çš„ delegate å¯¹è±¡ï¼Œä¹Ÿæ˜¯æ„å»ºé¢†åŸŸçš„é¢†åŸŸå¯¹è±¡ï¼Œä¸‹æ–‡ç®€ç§° <strong>DO</strong>ã€‚</p>
<blockquote>
<p>è¦ç†è§£delegateï¼Œå¯ä»¥æŸ¥çœ‹æ–‡ç« <a href="http://www.muzileecoding.com/gradlestudy/groovy.html" target="_blank" rel="noopener">Groovy è¯­æ³•</a>ã€‚</p>
</blockquote>
<p><strong>DO çš„æ„ä¹‰å°±åœ¨äºè„šæœ¬å¯ä»¥ä½¿ç”¨è¢«ä»£ç†çš„å¯¹è±¡çš„æ–¹æ³•</strong>â€”â€”è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œæ˜¯è„šæœ¬ä¸­å¯è°ƒç”¨æ–¹æ³•çš„é‡è¦æ¥æºã€‚<a id="more"></a></p>
<h2 id="äºŒã€é¡¶çº§DO"><a href="#äºŒã€é¡¶çº§DO" class="headerlink" title="äºŒã€é¡¶çº§DO"></a>äºŒã€é¡¶çº§DO</h2><p>Gradle æœ‰ä¸‰ç§è„šæœ¬ç±»å‹ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤º:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/é¡¶çº§DO.png" width="480" alt="é¡¶çº§DO"></div>

<p>æˆ‘ä»¬æœ€å¸¸é…ç½®çš„è„šæœ¬æ–‡ä»¶å°±æ˜¯<code>build.gradle</code>å’Œ<code>settings.gradle</code>ï¼Œè¿™ä¸¤ç±»è„šæœ¬æ–‡ä»¶ä¼šåˆ†åˆ«è¢« delegate åˆ° Project å®ä¾‹å’Œ Settings ï¼Œã€‚äº†ã€å®ä¾‹ã€‚</p>
<blockquote>
<p>â€œdelegateåˆ°â€çš„æ„æ€å°±æ˜¯è„šæœ¬ä¸­çš„é…ç½®ä»¥åŠæ–¹æ³•è°ƒç”¨éƒ½ä¼šè¢«è½¬ç§»åˆ°ä»£ç†å¯¹è±¡ä¸Šã€‚</p>
</blockquote>
<p>ä½†æ˜¯å®é™…ä¸Šæ¯ä¸€ä¸ªè„šæœ¬æ–‡ä»¶æœ€ç›´æ¥å¯¹åº”çš„ DO æ˜¯ Script å¯¹è±¡ï¼ŒScript å¯¹è±¡æ ¹æ®è„šæœ¬æ–‡ä»¶ç±»å‹æ¥åˆ¤æ–­å°†è„šæœ¬ä¸­çš„é…ç½®ä»£ç†åˆ°ä»€ä¹ˆç±»å‹çš„å¯¹è±¡ä¸Šå»ã€‚</p>
<h3 id="2-1-DOåˆ›å»ºè¿‡ç¨‹"><a href="#2-1-DOåˆ›å»ºè¿‡ç¨‹" class="headerlink" title="2.1 DOåˆ›å»ºè¿‡ç¨‹"></a>2.1 DOåˆ›å»ºè¿‡ç¨‹</h3><p>è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹ä¸€ä¸ªè„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ç›¸å…³é¡¶çº§ DO çš„åˆ›å»ºè¿‡ç¨‹:</p>
<ol>
<li>ä¸ºæ„å»ºåˆ›å»ºä¸€ä¸ª Settings å¯¹è±¡ï¼›</li>
<li>æœå¯» settings.gradle è„šæœ¬æ–‡ä»¶ï¼Œå¦‚æœæœ‰ï¼Œé€šè¿‡è¯¥è„šæœ¬é…ç½®Settingså¯¹è±¡ï¼›</li>
<li>æ ¹æ®é…ç½®å¥½çš„ settings.gradle å¯¹è±¡åˆ›å»º Project æ ‘ï¼›</li>
<li>æ ¹æ®æ¯ä¸€ä¸ª build.gradle æ–‡ä»¶é…ç½®å¯¹åº”çš„ Project å¯¹è±¡ï¼›</li>
</ol>
<p>è¿™é‡Œçœç•¥äº† Script å¯¹è±¡å’Œ Gradle å¯¹è±¡çš„åˆ›å»ºï¼Œå‰è€…åœ¨æ‰«æåˆ°è„šæœ¬æ–‡ä»¶çš„æ—¶å€™å°±è¢«åˆ›å»ºäº†ï¼Œåè€…åˆ™æ˜¯åœ¨æ„å»ºè¿‡ç¨‹åˆå§‹åŒ–çš„æ—¶å€™è¢«åˆ›å»ºã€‚</p>
<h2 id="ä¸‰ã€Projectè¿›é˜¶"><a href="#ä¸‰ã€Projectè¿›é˜¶" class="headerlink" title="ä¸‰ã€Projectè¿›é˜¶"></a>ä¸‰ã€Projectè¿›é˜¶</h2><p>è¿™é‡Œè®²åˆ° DO ä¹‹åï¼Œå°±å»ºç«‹äº† Gradle è¿™é—¨ DSL è¯­è¨€ä¸ Java ç±»çš„å…³è”ï¼Œä»è¿™ä¸ªè§’åº¦ï¼Œå¯ä»¥è¿›ä¸€æ­¥è§£é‡Šå¾ˆå¤šçš„é—®é¢˜ã€‚</p>
<h3 id="3-1-æ–¹æ³•å’Œå±æ€§"><a href="#3-1-æ–¹æ³•å’Œå±æ€§" class="headerlink" title="3.1 æ–¹æ³•å’Œå±æ€§"></a>3.1 æ–¹æ³•å’Œå±æ€§</h3><p>è¿™é‡Œä»¥ä¸€ä¸ª Android é¡¹ç›®çš„<code>build.gradle</code>æ–‡ä»¶å†…å®¹ä¸ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:2.0.0'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä» Groovy çš„è§’åº¦çœ‹ï¼Œè¿™æ ·çš„è¯­æ³•å°±æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªç±»ä¼¼å¦‚ä¸‹å®šä¹‰çš„æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="keyword">void</span> <span class="title">buildscript</span><span class="params">(Closure closure)</span></span>&#123;</span><br><span class="line">	<span class="comment">//method body</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="keyword">void</span> <span class="title">allprojects</span><span class="params">(Closure closure)</span></span>&#123;</span><br><span class="line">	<span class="comment">//method body</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ˜¯æ¥è‡ªå“ªé‡Œçš„å‘¢ï¼Ÿå®é™…ä¸Šå°±æ˜¯æ¥è‡ª Projectï¼Œæ‰“å¼€<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html" target="_blank" rel="noopener">Projectçš„APIæ–‡æ¡£</a>ï¼Œå°±å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•:  </p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/project-api.png" width="4800" alt="é¡¶çº§DO"></div>

<p>å±æ€§ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p>
<h3 id="3-2-æœå¯»è·¯å¾„"><a href="#3-2-æœå¯»è·¯å¾„" class="headerlink" title="3.2 æœå¯»è·¯å¾„"></a>3.2 æœå¯»è·¯å¾„</h3><p>åœ¨å®é™…çš„è„šæœ¬æ–‡ä»¶ä»¥åŠæ¥è‡ªç½‘ä¸Šçš„å¾ˆå¤šè„šæœ¬æ¡ˆä¾‹ä¸­ï¼Œé™¤äº†ä»¥ä¸Šå¯ä»¥ä» Project çš„ API æ–‡æ¡£ä¸­æŸ¥è¯¢åˆ°çš„æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ–¹æ³•æ˜¯æ— æ³•æ‰¾åˆ°çš„ï¼Œæ¯”å¦‚ä¹‹å‰ä»‹ç»çš„å¾ˆé‡è¦çš„å£°æ˜å±æ€§çš„ extï¼Œå®ƒçš„å½¢å¼ä¹Ÿè¡¨æ˜å®ƒæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯ Project ä¸­ç¡®å®æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ã€‚</p>
<blockquote>
<p>åœ¨å®è·µä¸­æˆ‘ä½¿ç”¨åå°„æ¥å¯»æ‰¾è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‰¾åˆ°ï¼šå®ƒä¸å±äº Project æˆ–è€… Task ç±»ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ¥è‡ªå“ªé‡Œå‘¢ï¼Ÿå½“æˆ‘ä»¬åœ¨è„šæœ¬ä¸­è°ƒç”¨ä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå®ƒæ˜¯æœ‰ä¸€ä¸ªæœç´¢è·¯å¾„çš„:</p>
<ol>
<li>Project æœ¬èº«</li>
<li>build file</li>
<li>æ·»åŠ è¿›æ¥çš„ extension äº§ç”Ÿçš„åŒåæ–¹æ³•</li>
<li>convention methods</li>
<li>æ·»åŠ è¿›æ¥çš„ Task äº§ç”Ÿçš„åŒåæ–¹æ³•</li>
<li>çˆ¶ Project çš„æ–¹æ³•ï¼Œç›´åˆ°æ ¹ Project ä¸ºæ­¢</li>
</ol>
<p>è¿™é‡Œæ˜¯å®˜ç½‘ä¸Šåˆ—å‡ºçš„å…­ä¸ªæœå¯»ç‚¹ï¼Œä½†<strong>åœ¨å®è·µä¸­å‘ç°ï¼Œæœ€åˆçš„æœç´¢ç‚¹åº”è¯¥æ˜¯ Script å¯¹è±¡ï¼Œæ¥ç€æ‰æ˜¯ Project æœ¬èº«</strong>ã€‚</p>
<p>å¯¹äºå±æ€§ï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„æœç´¢è·¯å¾„:</p>
<ol>
<li>Project æœ¬èº«</li>
<li>extra property</li>
<li>æ·»åŠ  extensions äº§ç”Ÿçš„åŒåå±æ€§</li>
<li>convention æ·»åŠ çš„å±æ€§</li>
<li>æ·»åŠ  Task äº§ç”Ÿçš„åŒåå±æ€§</li>
<li>ä»çˆ¶ Project ç»§æ‰¿çš„ extra å±æ€§å’Œ convention å±æ€§ï¼Œç›´åˆ°æ ¹é¡¹ç›®</li>
</ol>
<p>é‰´äºä¸¤ç§åŸå› ï¼Œå¯¼è‡´æ–¹æ³•å’Œå±æ€§çš„å®šä½éå¸¸ä¸å®¹æ˜“:</p>
<ol>
<li>Groovy å¯ä»¥è½»æ¾åœ°åŠ¨æ€åˆ›å»ºç±»ï¼Œå¹¶ä¸ºç±»æ·»åŠ å±æ€§å’Œæ–¹æ³•ã€‚ä¸¾ä¸ªæ —å­ï¼Œè™½ç„¶æ–‡æ¡£ä¸­å†™æ˜<code>build.gradle</code>ä¸­çš„é…ç½®ä¼šä»£ç†åˆ° Project å¯¹è±¡ï¼Œä½†åœ¨å®é™…è¿è¡Œçš„æ—¶å€™ï¼ŒGradle åˆ›å»ºäº†ä¸€ä¸ª Project çš„ Default å®ç°ç±»æ¥ä½œä¸ºä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªç±»çš„å…·ä½“å®ç°åœ¨æ–‡æ¡£ä¸­æ˜¯ä¸å¯æŸ¥çš„ï¼ˆä½†æ˜¯å¯ä»¥åˆ©ç”¨åå°„è¿›è¡Œæ¢ç´¢ï¼‰ï¼›</li>
<li>å¦‚æœå¯»è·¯å¾„ä¸­å†™æ˜çš„ï¼ŒGradle å…è®¸é€šè¿‡ extensionã€conventionç­‰å¤šç§æ‰‹æ®µæ¥æ·»åŠ æ–¹æ³•å’Œå±æ€§ï¼Œè¿™ä¼šéšç€ Gradle å¯¹ DSL çš„å®šä¹‰å’Œå®ç°ã€æ’ä»¶çš„ä½¿ç”¨ç­‰å˜åŒ–ï¼Œè¿™éƒ¨åˆ†ä¹Ÿå¾ˆéš¾æŸ¥ï¼›</li>
</ol>
<p>å› æ­¤ï¼Œé™¤äº†é˜…è¯» API æ–‡æ¡£ä¹‹å¤–ï¼Œè¿˜éœ€è¦é˜…è¯» User Guide ç­‰æ–‡æ¡£æ¥å¯»æ‰¾ä¸€äº›ç‰¹æ®Šçš„ç”¨æ³•ã€‚</p>
<h3 id="3-2-Container"><a href="#3-2-Container" class="headerlink" title="3.2 Container"></a>3.2 Container</h3><p>Project å…è®¸é…ç½®å¾ˆå¤šçš„å†…å®¹ï¼Œæ¯”å¦‚å£°æ˜ä¸€ç»„ Taskã€åˆ›å»ºä¸€ç»„æ‰©å±•ã€å®šä¹‰ä¸€ç»„é…ç½®ç­‰ç­‰ï¼Œåœ¨ Gradle ä¸­ï¼Œæœ‰ä¸€ç»„ Container æ¥ç®¡ç†è¿™äº›å…ƒç´ ã€‚</p>
<h4 id="3-2-1-TaskContainer"><a href="#3-2-1-TaskContainer" class="headerlink" title="3.2.1 TaskContainer"></a>3.2.1 TaskContainer</h4><p>è´Ÿè´£ç®¡ç†æ‰€æœ‰çš„ Task å®ä¾‹ï¼Œé€šè¿‡ Project çš„ task æ–¹æ³•å³å¯åˆ›å»º Task å®ä¾‹æ”¾å…¥å…¶ä¸­ã€‚</p>
<p><a href="https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html" target="_blank" rel="noopener">Project</a> ç±»æœ‰ä¸€ä¸ªæ–¹æ³•<code>getTasks()</code>ï¼Œå®ƒè¿”å›çš„å°±æ˜¯<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html" target="_blank" rel="noopener">TaskContainer</a>å¯¹è±¡ï¼Œè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥é˜…è¿™ä¸ªç±»ï¼Œå¯ä»¥å‘ç°å¾ˆå¤šæœ‰å…³ Task çš„æ–°ç©æ³•ã€‚</p>
<h4 id="3-2-2-ConfigurationContainer"><a href="#3-2-2-ConfigurationContainer" class="headerlink" title="3.2.2 ConfigurationContainer"></a>3.2.2 ConfigurationContainer</h4><ol>
<li>A Configuration represents a group of artifacts and their dependencies.</li>
<li>Configuration is an instance of a FileCollection that contains all dependencies but not artifacts. If you want to refer to the artifacts declared in this configuration please use getArtifacts() or getAllArtifacts().</li>
</ol>
<p>å…³äº Configurationï¼Œåœ¨<a href="http://www.muzileecoding.com/gradlestudy/gradle-advaced-dependency-management.html" target="_blank" rel="noopener">Gradle ä¾èµ–ç®¡ç†</a>æœ‰æè¿°ã€‚å¦å¤–åœ¨å®˜æ–¹ä¾‹å­ä¸­ä¹Ÿæœ‰ä¸€äº›ä¸æ­¤ç›¸å…³ï¼Œæ¯”å¦‚<a href="https://docs.gradle.org/current/userguide/dependency_management.html#defineConfiguration" target="_blank" rel="noopener">Definition of a configuration</a>ã€‚è¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚</p>
<h4 id="3-2-3-ExtensionContainer"><a href="#3-2-3-ExtensionContainer" class="headerlink" title="3.2.3 ExtensionContainer"></a>3.2.3 ExtensionContainer</h4><p>ä¸å…¶ä½™ä¸¤ä¸ª Container ä¸åŒï¼ŒExtensionContainer æ˜¯ä¸€ä¸ªé¡¶çº§æ¥å£ï¼Œæ— çˆ¶æ¥å£ã€‚ç‰¹æ€§æ˜¯ä¼šåœ¨ Project ä¸­åˆ›å»ºåŒåçš„å±æ€§å’Œæ–¹æ³•ã€‚é‡è¦çš„å­æ¥å£ â€”â€” Conventionã€‚</p>
<p>å…³äº Extension çš„ç”¨æ³•ï¼Œåœ¨<a href="https://docs.gradle.org/current/userguide/custom_plugins.html" target="_blank" rel="noopener">Writing Custom Plugins</a>ä¸€ç« ä¸­æ­£å¥½æœ‰ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: GreetingPlugin</span><br><span class="line"></span><br><span class="line">greeting &#123;</span><br><span class="line">    message = <span class="string">'Hi'</span></span><br><span class="line">    greeter = <span class="string">'Gradle'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreetingPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project project)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// å¯ä»¥åˆ›å»ºæ‰©å±•ï¼Œä»è€Œåœ¨å¤–éƒ¨è·å¾—é…ç½®</span></span><br><span class="line">        project.extensions.create(<span class="string">"greeting"</span>, GreetingPluginExtension)</span><br><span class="line">        project.task(<span class="string">'hello'</span>) &lt;&lt; &#123;</span><br><span class="line">            println <span class="string">"$&#123;project.greeting.message&#125; from $&#123;project.greeting.greeter&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreetingPluginExtension</span> </span>&#123;</span><br><span class="line">    String message</span><br><span class="line">    String greeter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>project æœ‰ä¸€ä¸ª extensions å±æ€§ï¼ˆä¹Ÿæœ‰ä¸€ä¸ª<code>getExtensions()</code>ï¼‰ï¼Œå®ƒçš„ç±»å‹å°±æ˜¯ ExtensionContainer ï¼ŒåŒæ ·ï¼Œè¯»è€…ä¹Ÿèƒ½åœ¨è¿™é‡Œæ‰¾åˆ°å„ç§ç©æ³•ã€‚è¿™å…¶ä¸­æ˜¯æœ‰ä¸€ä¸ªéå¸¸ç‰¹åˆ«çš„æ–¹æ³•çš„: <code>getExtraProperties()</code>ï¼Œå®ƒè¿”å›çš„å¯¹è±¡ç±»å‹ä¸º<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/plugins/ExtraPropertiesExtension.html" target="_blank" rel="noopener">ExtraPropertiesExtension</a>ï¼Œå‰é¢è¯´äº†<code>ext()</code>æ–¹æ³•ä¸å¯æŸ¥ï¼Œä½†æ˜¯è¯»è€…æŸ¥çœ‹è¿™ä¸ªç±»çš„ç›¸å…³æ–‡æ¡£ä¹‹åï¼Œä¼šæœ‰æ„å¤–æ”¶è·çš„ã€‚</p>
<p>å®ƒçš„å­ç±» Convention æ›´åŠ ç‰›é€¼ï¼Œå®˜æ–¹è§£é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>A Convention manages a set of convention objects. When you add a convention object to a Convention, and the properties and methods of the convention object become available as properties and methods of the object which the convention is associated to. A convention object is simply a POJO or POGO. Usually, a Convention is used by plugins to extend a Project or a Task.</p>
</blockquote>
<p>è¿™ä¸ªç›®å‰åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ²¡æœ‰å‘ç°ç›¸å…³ä½¿ç”¨æŒ‡å¯¼(å‘)ï¼Œä½†æ˜¯ç½‘ä¸Šæœ‰<a href="http://aetomation.aestasit.com/posts/injecting-utility-methods-in-gradle-projects-using-plugin-conventions/#.V3e1TZN95TY" target="_blank" rel="noopener">å¤§ç‰›</a>æ¢ç´¢å‡ºäº†ç”¨æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This line will enable our plugin for</span></span><br><span class="line"><span class="comment">// the build that imports this script.</span></span><br><span class="line">apply plugin: UtilitiesPlugin</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a plugin.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UtilitiesPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line">	<span class="function">def <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project project)</span> </span>&#123;</span><br><span class="line">		project.convention.plugins.utilities =</span><br><span class="line">			<span class="keyword">new</span> UtilitiesPluginConvention(project)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Plugin convention class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UtilitiesPluginConvention</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Project project</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">UtilitiesConvention</span><span class="params">(Project project)</span>  </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.project = project</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DEFINE YOUR UTILITY METHODS HERE */</span></span><br><span class="line">	<span class="function">def <span class="title">printMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		println <span class="string">"Message from "</span> + project.name</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä½¿ç”¨å®Œå…¨ç¬¦åˆ Convention çš„æ¥å£å®šä¹‰ã€‚</p>
<h2 id="å››ã€DOæ€»ç»“"><a href="#å››ã€DOæ€»ç»“" class="headerlink" title="å››ã€DOæ€»ç»“"></a>å››ã€DOæ€»ç»“</h2><p>æ ¹æ®ä»¥ä¸Šåˆ†æï¼ŒGradle çš„ DO æ ‘å¦‚ä¸‹:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/gradle-do.png" width="480" alt="Gradle DO æ ‘"></div>

<p>è¿™äº› DO å…±åŒæ­å»ºäº†ä¸€ä¸ªæ„å»ºæ¡†æ¶ï¼Œå¼€å‘è€…é€šè¿‡åœ¨è„šæœ¬ä¸­å¯¹è¿™äº› DO åšå‡ºé…ç½®æ¥æ§åˆ¶æ„å»ºè¿‡ç¨‹ã€‚å½“ç„¶è¿™é‡Œåªæ˜¯åˆ—å‡ºäº†ä¸€äº›é‡è¦çš„ DOï¼Œåœ¨ å®˜ç½‘çš„ Java Doc ä¸­ï¼Œè¿˜æœ‰è®¸è®¸å¤šå¤šçš„ DO æœ‰å¾…æ¢ç´¢ï¼Œä½†è¿™é‡Œæ„å»ºçš„æ˜¯æ•´ä¸ª Gradle DO åŸºç¡€ï¼Œå»ºç«‹äºæ­¤ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œå­¦ä¹ å…¶ä½™çš„ç”¨æ³•ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—ä¸‰ï¼šé¡¹ç›®å’Œè„šæœ¬]]></title>
      <url>http://www.timebridge.space/2016/06/13/gradle-project-and-script/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€åˆè§Gradleè„šæœ¬"><a href="#ä¸€ã€åˆè§Gradleè„šæœ¬" class="headerlink" title="ä¸€ã€åˆè§Gradleè„šæœ¬"></a>ä¸€ã€åˆè§Gradleè„šæœ¬</h2><p>è¯»è€…å¯ä»¥åœ¨ä»»æ„ç›®å½•ä¸‹é¢å»ºç«‹ä¸€ä¸ª<code>build.gradle</code>æ–‡ä»¶ï¼Œå°†ä»¥ä¸‹å†…å®¹æ‹·è´è¿›å»:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">task compile &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'compiling source'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æœ¬ç›®å½•ä¸‹é¢æ‰§è¡Œå‘½ä»¤<code>gradle -q compile</code>ï¼Œå°±å¯ä»¥çœ‹åˆ°å‘½ä»¤è¡Œè¾“å‡ºâ€compiling sourceâ€å­—ç¬¦:<a id="more"></a></p>
<pre><code>&gt;gradle -q compile
compiling source
</code></pre><p><code>build.gradle</code>å°±æ˜¯ä¸€ä¸ª Gradle è„šæœ¬æ–‡ä»¶ï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚è™½ç„¶ä¾‹å­å’Œæ„å»ºæ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä½†æ˜¯è¿™å°±æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ï¼Œç”±å•ä¸ªè„šæœ¬æ–‡ä»¶ç»„æˆçš„æ„å»ºé¡¹ç›®ã€‚</p>
<blockquote>
<p>è¿™é‡Œçš„ <strong>æ„å»ºé¡¹ç›®</strong> å¯èƒ½æœ‰æ­§ä¹‰ï¼šGradle å…¶å®æ˜¯å†…åµŒåœ¨å¼€å‘é¡¹ç›®ä¸­çš„ä¸€ç»„æ–‡ä»¶ã€‚Gradle æ„å»ºå·¥å…·é€šè¿‡è¯»å–è¿™äº›æ–‡ä»¶ï¼Œäº†è§£å¼€å‘è€…å¯¹é¡¹ç›®çš„é…ç½®ï¼Œå®Œæˆé¡¹ç›®çš„æ„å»ºï¼Œè¿™é‡Œè®² Gradle çš„è¿™ç»„æ–‡ä»¶ç§°ä¸ºâ€œæ„å»ºé¡¹ç›®â€ã€‚</p>
</blockquote>
<h2 id="äºŒã€Project-å’Œ-Task"><a href="#äºŒã€Project-å’Œ-Task" class="headerlink" title="äºŒã€Project å’Œ Task"></a>äºŒã€Project å’Œ Task</h2><p>æˆ‘ä»¬åœ¨è„šæœ¬æ–‡ä»¶ä¸­å†™å…¥çš„å†…å®¹æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®ƒæ˜¯ä¸€ä¸ª <strong>Task</strong>ï¼Œå®ƒçš„è¯­æ³•ä»¥åŠç”¨æ³•ä¼šåœ¨<a href="http://www.muzileecoding.com/gradlestudy/gradle-task.html" target="_blank" rel="noopener">Gradle Task</a>ä¸­ç»†è¯´ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼æ–¹æ³•çš„ä»£ç ç‰‡æ®µå°± OK äº†ã€‚</p>
<p>å€ŸåŠ©è¿™ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œæˆ‘ä»¬å…ˆé‡ç‚¹çœ‹ä¸€ä¸‹ Gradle ç›¸å…³çš„å‡ ä¸ªé‡è¦æ¦‚å¿µï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Gradleé¡¹ç›®æ¦‚å¿µæ¨¡å‹.png" height="400" alt="Gradleé¡¹ç›®æ¦‚å¿µæ¨¡å‹"></div>

<p>ä¸Šå›¾å±•ç¤ºäº†ä¸€ä¸ª Gradle æ„å»ºé¡¹ç›®çš„æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹ï¼ˆå…¶ä½™æ¦‚å¿µå°†åœ¨ <a href="http://www.muzileecoding.com/gradlestudy/gradle-advaced-do.html" target="_blank" rel="noopener">Gradle DO æ¨¡å‹</a>ä¸­æè¿°ï¼‰ã€‚è¿™ä¸ªå›¾ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„æ¦‚å¿µï¼š<strong>Project</strong>ã€<strong>Task</strong> å’Œ <strong>Action</strong>ã€‚Gradle çš„æ„å»ºæ ¸å¿ƒå°±æ˜¯åŸºäº Project å’Œ Task çš„ï¼ˆAction åœ¨è®²è¿° Task çš„æ—¶å€™ä¼šè¯¦ç»†è§£é‡Šï¼Œè¿™é‡Œä¸å½±å“ç†è§£ï¼Œç•¥è¿‡ï¼‰ã€‚</p>
<p>æ¯ä¸€ä¸ª Gradle æ„å»ºé¡¹ç›®åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª Project â€”â€” è¿™ä¸ª Project æ˜¯ä¸€ä¸ªå¾ˆä¸æ˜ç¡®çš„æ¦‚å¿µï¼Œå®ƒå’Œä¸€ä¸ª<code>build.gradle</code>æ–‡ä»¶ä¸€ä¸€å¯¹åº”ï¼Œå®ƒå¯ä»¥ä»€ä¹ˆéƒ½ä¸åšï¼Œæ¯”å¦‚æˆ‘ä»¬å‰é¢ä¸¾çš„ä¾‹å­ï¼Œåªæ˜¯æ‰“å°ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥å®Œæˆç±»ä¼¼ç¼–è¯‘ä¸€ä¸ª Java åº”ç”¨â€”â€”æ‰“ Jar åŒ…â€”â€”ä¸Šä¼ åˆ° Maven ä»“åº“è¿™æ ·å¤æ‚çš„æ“ä½œï¼Œè¿™å®Œå…¨å–å†³äºä½ åœ¨<code>build.gradle</code>æ–‡ä»¶ä¸­å®ç°çš„åŠŸèƒ½ã€‚</p>
<p>æ¯ä¸€ä¸ª Project åˆç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ª Task ç»„æˆï¼Œå‰é¢çš„ä¾‹å­å°±æ˜¯ç”±ä¸€ä¸ªå«åš<code>compile</code>çš„ Task ç»„æˆçš„ï¼Œä¸€ä¸ª Task ä»£è¡¨ä¸€å°æ®µå¯ä»¥æ‰§è¡Œçš„æ„å»ºä»£ç ï¼Œåœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œä¸€ä¸ª Task å¯èƒ½å®Œæˆç¼–è¯‘ä¸€ç»„ç±»ã€æ‰“ä¸€ä¸ª Jar åŒ…ã€ç”Ÿæˆ Javadoc æ–‡æ¡£ã€ä¸Šä¼ å½’æ¡£æ–‡ä»¶åˆ°ä»“åº“ç­‰åŠŸèƒ½ã€‚</p>
<blockquote>
<p>æœ‰ Android ç»éªŒçš„å°ä¼™ä¼´å¯ä»¥å°† Project æ˜ å°„åˆ°ä¸€ä¸ª Android é¡¹ç›®ï¼Œå­ Project æ˜ å°„åˆ° Module å»ç†è§£ã€‚</p>
<p>å¦‚æœæŠŠProjectçœ‹æˆæ˜¯ä¸€ä¸ªç±»ï¼Œè€ŒTaskçœ‹æˆæ˜¯ä¸€ä¸ªä¸ªæ–¹æ³•ï¼Œç†è§£èµ·æ¥ä¼šæ›´åŠ å½¢è±¡ã€‚</p>
</blockquote>
<h2 id="ä¸‰ã€å¤šé¡¹ç›®æ–‡ä»¶ç»“æ„"><a href="#ä¸‰ã€å¤šé¡¹ç›®æ–‡ä»¶ç»“æ„" class="headerlink" title="ä¸‰ã€å¤šé¡¹ç›®æ–‡ä»¶ç»“æ„"></a>ä¸‰ã€å¤šé¡¹ç›®æ–‡ä»¶ç»“æ„</h2><p>å‰é¢ä¸¾å¾—ä¾‹å­éå¸¸ç®€å•ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¤š Project å½¢å¼çš„é¡¹ç›®æ˜¯éå¸¸æ™®éçš„ï¼Œæ¯”å¦‚ Android ä¸­ä¸€ä¸ªä¸»é¡¹ç›®å¾€å¾€æœ‰å¤šä¸ª Module ï¼Œæœ€åçš„ APK æ‰“åŒ…å…¶å®å°±æ˜¯å°†è¿™äº› Module çš„äº§ç‰©æ‰“åŒ…åœ¨ä¸€èµ·çš„è¿‡ç¨‹ã€‚è™½ç„¶é¡¹ç›®çš„åµŒå¥—å½¢å¼ä¸ä¸€å®šä¸€æ ·ï¼Œä½†æ˜¯å®ƒçš„ Gradle é…ç½®åº”å½“å…·å¤‡ä»¥ä¸‹ç‰¹å¾ï¼š</p>
<ol>
<li>åœ¨é¡¹ç›®æ ¹ç›®å½•/ä¸»ç›®å½•ä¸‹é¢æœ‰ä¸€ä¸ª<code>settings.gradle</code>æ–‡ä»¶ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€ä¸ª<code>build.gradle</code>æ–‡ä»¶ â€”â€” å¯¹åº”ç€ä¸Šå›¾ä¸­æœ€é¡¶å±‚çš„ Projectï¼›</li>
<li>æ¯ä¸€ä¸ªå­é¡¹ç›®ä¹Ÿæœ‰è‡ªå·±çš„<code>build.gradle</code>æ–‡ä»¶ï¼›</li>
</ol>
<p><code>settings.gradle</code>æ˜¯ç”¨äºå‘Šè¯‰ Gradleï¼šæ„å»ºé¡¹ç›®ç”±å“ªäº›å¼€å‘é¡¹ç›®ç»„æˆï¼Œå®ƒä»¬æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚åœ¨è¿™æ ·ä¸€ä¸ªå¤æ‚çš„ç›®å½•ç»“æ„ä¸‹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨<code>gradle projects</code>å‘½ä»¤æ¥æŸ¥çœ‹é¡¹ç›®ç»“æ„ã€‚</p>
<p>åœ¨ â€œGRADLE_HOME/samples/javaâ€ ç›®å½•ä¸‹é¢ï¼Œæ‰¾åˆ° â€œmultiprojectâ€ ç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹é¢æ‰§è¡Œ<code>gradle -q projects</code>ï¼Œå°±ä¼šå¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; gradle -q projects</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Root project</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Root project <span class="string">'multiproject'</span></span><br><span class="line">+--- Project <span class="string">':api'</span></span><br><span class="line">+--- Project <span class="string">':services'</span></span><br><span class="line">|    +--- Project <span class="string">':services:shared'</span></span><br><span class="line">|    \--- Project <span class="string">':services:webservice'</span></span><br><span class="line">\--- Project <span class="string">':shared'</span></span><br><span class="line"></span><br><span class="line">To see a list of the tasks of a project, run gradle &lt;project-path&gt;:tasks</span><br><span class="line">For example, <span class="keyword">try</span> running gradle :api:tasks</span><br></pre></td></tr></table></figure>
<p>è¿™è¯´æ˜:</p>
<ol>
<li><code>multiproject</code>é¡¹ç›®åŒ…å«ä¸‰ä¸ªç›´ç³»å­Projectï¼š<code>api</code>, <code>services</code>å’Œ<code>shared</code>ï¼›</li>
<li>å­é¡¹ç›®<code>services</code>åˆåŒ…å«<code>shared</code>å’Œ<code>webservice</code>ä¸¤ä¸ªå­é¡¹ç›®ï¼›</li>
</ol>
<p>å¯¹æ¯”å®é™…æ–‡ä»¶ç›®å½•ç»“æ„ï¼Œå¾ˆå®¹æ˜“ç†è§£è¿™äº›é¡¹ç›®çš„ç»„ç»‡è¿‡ç¨‹ã€‚è€Œå®ƒçš„<code>settings.gradle</code>æ–‡ä»¶å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">"shared"</span>, <span class="string">"api"</span>, <span class="string">"services:webservice"</span>, <span class="string">"services:shared"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>â€œmultiprojectâ€ ä¸‹é¢å…¶å®è¿˜æœ‰ä¸€ä¸ª<code>buildSrc</code>ç›®å½•ï¼Œé‡Œé¢ä¹Ÿæœ‰<code>build.gradle</code>æ–‡ä»¶ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨å‘½ä»¤è¡Œä¸­æ‰“å°å‡ºæ¥ï¼Œè¿™æ˜¯å› ä¸º<code>settings.gradle</code>æ–‡ä»¶ä¸­æ²¡æœ‰é…ç½®è¯¥é¡¹ç›®ã€‚</p>
</blockquote>
<p>æ ¹ç›®å½•ä¸‹é¢çš„<code>build.gradle</code>æ–‡ä»¶é€šå¸¸ä¼šæœ‰ä¸€äº›å­é¡¹ç›®å…±æœ‰çš„é…ç½®ï¼Œæ¯”å¦‚å…±äº«çš„ä¾èµ–ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œä¹Ÿå¯ä»¥å¯¹å­é¡¹ç›®è¿›è¡Œé…ç½®ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹<a href="https://docs.gradle.org/current/userguide/organizing_build_logic.html" target="_blank" rel="noopener">ç»„ç»‡æ„å»ºé€»è¾‘</a>ã€‚</p>
<blockquote>
<p><code>build.gradle</code>æ–‡ä»¶ä¸ä¸€å®šè¦å«è¿™ä¸ªåå­—ï¼Œå¯ä»¥ä»¥å­æ¨¡å—çš„åå­—å‘½åã€‚</p>
</blockquote>
<h2 id="å››ã€å¤šé¡¹ç›®æ„å»º"><a href="#å››ã€å¤šé¡¹ç›®æ„å»º" class="headerlink" title="å››ã€å¤šé¡¹ç›®æ„å»º"></a>å››ã€å¤šé¡¹ç›®æ„å»º</h2><p>ä¸Šé¢å·²ç»çœ‹åˆ°ä¸€ä¸ªå¤šé¡¹ç›®æ„å»ºæ˜¯å¦‚ä½•é…ç½®çš„äº†ï¼Œä¸‹é¢è¿›ä¸€æ­¥é˜è¿°ã€‚</p>
<h3 id="4-1-é¡¹ç›®å®šä½"><a href="#4-1-é¡¹ç›®å®šä½" class="headerlink" title="4.1 é¡¹ç›®å®šä½"></a>4.1 é¡¹ç›®å®šä½</h3><p>å¤šé¡¹ç›®æ„å»ºæ˜¯ä»¥ä¸€æ£µæ ‘çš„å½¢å¼å±•ç°çš„ï¼Œæ ‘ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä»£è¡¨ç€ä¸€ä¸ª projectï¼ˆæ˜¯ä¸æ˜¯å¾ˆç±»ä¼¼å‰é¢çš„ç»“æ„å›¾ï¼Ÿï¼‰ï¼Œæ¯ä¸€ä¸ª project éƒ½æœ‰ä¸€ä¸ªä»£è¡¨è‡ªå·±ä½ç½®çš„è·¯å¾„ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¿™ä¸ªä½ç½®å’Œé¡¹ç›®æ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›¸å¯¹ä½ç½®æ˜¯ä¸€è‡´çš„ï¼Œç„¶è€Œï¼Œè¿™æ˜¯å¯é…ç½®çš„ã€‚ project æ ‘æ˜¯æ ¹æ® â€œsettings.gradleâ€ æ–‡ä»¶æ¥åˆ›å»ºçš„ï¼Œè¿™ä¸ªæ–‡ä»¶é»˜è®¤æ˜¯æ”¾åœ¨æ ¹ project ç›®å½•ä¸‹é¢ï¼Œä½†æ˜¯å®é™…ä¸Šæ ¹ç›®å½•çš„ä½ç½®ä¹Ÿå¯ä»¥åœ¨è¯¥æ–‡ä»¶ä¸­é‡æ–°å®šä¹‰ã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œ <strong>åªè¦æœ‰ â€œsettings.gradleâ€ æ–‡ä»¶ï¼Œåªè¦å¯ä»¥å®šä¹‰å‡ºä¸€ä¸ª project æ ‘å‡ºæ¥å°±å¥½</strong> ã€‚</p>
<h3 id="4-2-æ„å»º-Project-æ ‘"><a href="#4-2-æ„å»º-Project-æ ‘" class="headerlink" title="4.2 æ„å»º Project æ ‘"></a>4.2 æ„å»º Project æ ‘</h3><p>åœ¨ settings.gradle æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ç»„æ–¹æ³•å¯ä»¥ç”¨äºæ„å»º project æ ‘ã€‚ä¸»è¦æœ‰ â€œHierarchical layoutsâ€ å’Œ â€œflat physical layoutsâ€ ã€‚</p>
<h4 id="4-2-1-Hierarchical-layout"><a href="#4-2-1-Hierarchical-layout" class="headerlink" title="4.2.1 Hierarchical layout"></a>4.2.1 Hierarchical layout</h4><p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ â€œsettings.gradleâ€ ä¸­å†™å…¥å¦‚ä¸‹è„šæœ¬:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">'project1'</span>, <span class="string">'project2:child'</span>, <span class="string">'project3:child1'</span></span><br></pre></td></tr></table></figure>
<p><code>include</code>æ–¹æ³•ä½¿ç”¨è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œè·¯å¾„æ˜¯æ ¹æ®ç›¸å¯¹è·¯å¾„å¾—å‡ºçš„ï¼Œåªä¸è¿‡è·¯å¾„åˆ†éš”ç¬¦å˜æˆäº†<code>:</code>ã€‚æˆ‘ä»¬åªéœ€è¦æ ‡æ³¨å‡ºå¶å­èŠ‚ç‚¹é¡¹ç›®å³å¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬åŒ…å«é¡¹ç›® â€˜services:hotels:apiâ€™ï¼Œé‚£æ„å»ºçš„æ—¶å€™å°±ä¼šåˆ›å»ºä¸‰ä¸ª projects: â€˜servicesâ€™, â€˜services:hotelsâ€™ å’Œ â€˜services:hotels:apiâ€™ã€‚</p>
<h4 id="4-2-2-Flat-physical-layouts"><a href="#4-2-2-Flat-physical-layouts" class="headerlink" title="4.2.2 Flat physical layouts"></a>4.2.2 Flat physical layouts</h4><p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ â€œsettings.gradleâ€ ä¸­å†™å…¥å¦‚ä¸‹è„šæœ¬:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">includeFlat <span class="string">'project3'</span>, <span class="string">'project4'</span></span><br></pre></td></tr></table></figure>
<p><code>includeFlat</code>æ–¹æ³•ä»¥ç›®å½•ä½œä¸ºå‚æ•°ï¼Œè¿™äº›ç›®å½•å¿…é¡»æ˜¯æ ¹ project çš„å…„å¼Ÿç›®å½•ï¼Œä¹Ÿå°±æ˜¯è¯´å’Œé¡¹ç›®æ ¹ç›®å½•å¹³çº§ã€‚åœ¨å¤š project æ ‘ä¸­ï¼Œè¿™äº›ç›®å½•çš„ä½ç½®æ˜¯ä½œä¸ºæ ¹ project çš„å­é¡¹ç›®å­˜åœ¨ã€‚</p>
<h3 id="4-3-é¡¹ç›®ä¿¡æ¯ä¿®æ”¹"><a href="#4-3-é¡¹ç›®ä¿¡æ¯ä¿®æ”¹" class="headerlink" title="4.3 é¡¹ç›®ä¿¡æ¯ä¿®æ”¹"></a>4.3 é¡¹ç›®ä¿¡æ¯ä¿®æ”¹</h3><p>å¤šé¡¹ç›®æ„å»ºæ ‘æ˜¯ç”± â€œproject descriptorsâ€ æ„æˆçš„ï¼Œå¯ä»¥åœ¨ settings æ–‡ä»¶ä¸­éšæ—¶æ›´æ”¹è¿™äº› descriptorsï¼ŒåŒ…æ‹¬æ›´æ”¹ project åç§°ï¼Œproject ç›®å½•ï¼Œä»¥åŠ project æ„å»ºåç§°ã€‚ä¾‹å­å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–å±æ€§</span></span><br><span class="line">println rootProject.name</span><br><span class="line"><span class="function">println <span class="title">project</span><span class="params">(<span class="string">':projectA'</span>)</span>.name</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//æ›´æ”¹å±æ€§</span></span></span><br><span class="line"><span class="function">rootProject.name </span>= <span class="string">'main'</span></span><br><span class="line">project(<span class="string">':projectA'</span>).projectDir = <span class="keyword">new</span> File(settingsDir, <span class="string">'../my-project-a'</span>)</span><br><span class="line">project(<span class="string">':projectA'</span>).buildFileName = <span class="string">'projectA.gradle'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>åˆå§‹åŒ–è„šæœ¬çš„ä»£ç†å¯¹è±¡ Settings çš„<code>project</code>æ–¹æ³•è¿”å›çš„æ˜¯ ProjectDescriptor å¯¹è±¡ã€‚</p>
</blockquote>
<h2 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯ä¸€äº›å…³äºé¡¹ç›®ç»“æ„ä»¥åŠé‡è¦æ–‡ä»¶é…ç½®çš„è¯´æ˜ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—äº”ï¼šå±æ€§]]></title>
      <url>http://www.timebridge.space/2016/06/13/gradle-property/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><p>æ— è®ºæ˜¯é…ç½®æ„å»ºç¯å¢ƒã€æ§åˆ¶æ„å»ºè¿‡ç¨‹è¿˜æ˜¯è®°å½•æ„å»ºä¸­é—´ä¿¡æ¯ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ç”¨åˆ°å±æ€§ã€‚Gradleä¸ºæˆ‘ä»¬æä¾›äº†å¤šç§å±æ€§å£°æ˜æ–¹å¼ï¼Œä¸‹é¢è¯¦ç»†é˜è¿°ã€‚</p>
<h2 id="äºŒã€ext"><a href="#äºŒã€ext" class="headerlink" title="äºŒã€ext"></a>äºŒã€ext</h2><p>åœ¨Gradleä¸­æœ€å¸¸è§çš„å®šä¹‰å±æ€§çš„æ–¹å¼å°±æ˜¯é€šè¿‡extå®šä¹‰ï¼Œæ¯”å¦‚åœ¨<code>build.gradle</code>ä¸­å†™å…¥ï¼š<a id="more"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">	developer_name = <span class="string">"bigfootprint"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">println developer_name</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>gradle -q</code>å‘½ä»¤ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bigfootprint</span><br></pre></td></tr></table></figure>
<p>åœ¨extä¸­å£°æ˜çš„å±æ€§ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ï¼Œä¸ç”¨å¸¦ä»»ä½•çš„å‰ç¼€ã€‚</p>
<blockquote>
<p>è¯»è€…å¯èƒ½æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œå¯ä»¥é€šè¿‡extæ¥å®šä¹‰è¿™æ ·çš„å±æ€§ï¼Ÿè¿™ä¸ªå°†åœ¨<a href="http://www.muzileecoding.com/gradlestudy/gradle-advaced-do.html" target="_blank" rel="noopener">Gradle DOæ¨¡å‹</a>ä¸­é˜è¿°ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“è¿™ç§å†™æ³•æ˜¯å¯ä»¥å£°æ˜å±æ€§çš„å°±å¥½ã€‚</p>
</blockquote>
<p>ä¸ä»…ä»…å¯ä»¥ä½¿ç”¨ ext ä¸ºæ„å»ºé¡¹ç›®æ·»åŠ å±æ€§ï¼Œè¿˜å¯ä»¥ç”¨ ext ä¸º Task æ·»åŠ å±æ€§ï¼Œæ¯”å¦‚åœ¨<code>build.gradle</code>æ–‡ä»¶ä¸­å¯ä»¥å†™å…¥å¦‚ä¸‹å†…å®¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">task taskExt&#123;</span><br><span class="line">	ext&#123;</span><br><span class="line">		taskowner = <span class="string">"bigfootprint"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">println taskExt.taskowner</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>gradle -q</code>å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bigfootprint</span><br></pre></td></tr></table></figure>
<h2 id="ä¸‰ã€å…¶ä½™æ–¹å¼"><a href="#ä¸‰ã€å…¶ä½™æ–¹å¼" class="headerlink" title="ä¸‰ã€å…¶ä½™æ–¹å¼"></a>ä¸‰ã€å…¶ä½™æ–¹å¼</h2><p>ext æ˜¯å£°æ˜å±æ€§æœ€æ–¹ä¾¿çš„æ–¹å¼ï¼Œä½†æ˜¯ Gradle è¿˜æä¾›äº†åˆ«çš„æ–¹å¼è¿›è¡Œå±æ€§å£°æ˜ã€‚</p>
<h4 id="3-1-gradle-properties"><a href="#3-1-gradle-properties" class="headerlink" title="3.1 gradle.properties"></a>3.1 gradle.properties</h4><p>åœ¨è¿™ç±»æ–‡ä»¶ä¸­æ·»åŠ çš„å±æ€§é…ç½®ï¼Œåœ¨æ„å»ºä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚è¯¥æ–‡ä»¶æœ‰ä¸¤ä¸ªåœ°æ–¹å¯ä»¥æ”¾ç½®ï¼š</p>
<ol>
<li>ç¯å¢ƒå˜é‡â€GRADLE_USER_HOMEâ€æŒ‡å‘çš„ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œé»˜è®¤æ˜¯åœ¨â€USER_HOME/.gradleâ€ä¸‹é¢ï¼›</li>
<li>é¡¹ç›®æ ¹ç›®å½•ä¸‹é¢â€”â€”å¯¹äºå¤šé¡¹ç›®çš„æ„å»ºæ¥è¯´ï¼Œè¯¥æ–‡ä»¶å¯ä»¥å­˜æ”¾åœ¨ä»»æ„çš„å­é¡¹ç›®æ–‡ä»¶å¤¹ä¸‹ï¼›</li>
</ol>
<p>å¦‚æœä»¥ä¸Šä¸¤ä¸ªä½ç½®éƒ½æœ‰è¯¥æ–‡ä»¶ä¸”å®šä¹‰æœ‰ç›¸åŒçš„å±æ€§ï¼Œåˆ™ â€œUSER_HOMEâ€ ä¸‹é¢çš„å®šä¹‰å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚</p>
<blockquote>
<p>é¡¹ç›®ä¸­å¦‚æœæœ‰å¤šä¸ªç›®å½•çš„ â€œgradle.propertiesâ€ æ–‡ä»¶ä¸­æœ‰åŒæ ·çš„å±æ€§ï¼Œä¸” â€œUSER_HOMEâ€ ä¸‹é¢æ²¡æœ‰è¯¥å±æ€§å®šä¹‰ï¼Œåˆ™ä¼˜å…ˆæŸ¥æ‰¾å‘½ä»¤æ‰§è¡Œçš„å½“å‰ç›®å½•ä¸‹çš„å±æ€§æ–‡ä»¶ï¼Œæ‰¾ä¸åˆ°åˆ™å»çˆ¶é¡¹ç›®ä¸­å¯»æ‰¾ã€‚</p>
</blockquote>
<h4 id="3-2-å‘½ä»¤è¡Œ"><a href="#3-2-å‘½ä»¤è¡Œ" class="headerlink" title="3.2 å‘½ä»¤è¡Œ"></a>3.2 å‘½ä»¤è¡Œ</h4><p>ä½¿ç”¨<code>-D</code>å‘½ä»¤è¡Œé€‰é¡¹ï¼Œå¯ä»¥ç»™è¿è¡ŒGradleè¿›ç¨‹çš„JVMä¼ é€’ç³»ç»Ÿå±æ€§ï¼Œåœ¨æ‰§è¡Œ<code>gradle</code>ä½¿ç”¨<code>-D</code>é€‰é¡¹ä¹Ÿæœ‰åŒæ ·çš„æ•ˆæœã€‚</p>
<p>é™¤äº†ä½¿ç”¨<code>-D</code>å‘½ä»¤è¡Œé€‰é¡¹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>-P</code>é€‰é¡¹ã€‚ä½¿ç”¨è§åé¢çš„ç¤ºä¾‹ã€‚</p>
<p>ä½¿ç”¨å‘½ä»¤è¡Œä¼ é€’çš„å±æ€§ä¼˜å…ˆçº§æœ€é«˜ã€‚</p>
<h4 id="3-3-ç‰¹æ®Šå‘½åçš„ç³»ç»Ÿå±æ€§æˆ–è€…ç¯å¢ƒå˜é‡"><a href="#3-3-ç‰¹æ®Šå‘½åçš„ç³»ç»Ÿå±æ€§æˆ–è€…ç¯å¢ƒå˜é‡" class="headerlink" title="3.3 ç‰¹æ®Šå‘½åçš„ç³»ç»Ÿå±æ€§æˆ–è€…ç¯å¢ƒå˜é‡"></a>3.3 ç‰¹æ®Šå‘½åçš„ç³»ç»Ÿå±æ€§æˆ–è€…ç¯å¢ƒå˜é‡</h4><p>Gradle å¯ä»¥æ ¹æ®ç‰¹æ®Šå‘½åçš„ç³»ç»Ÿå±æ€§æˆ–è€…ç¯å¢ƒå˜é‡æ¥ä¸ºæ„å»ºè®¾ç½®å±æ€§ã€‚è¿™ä¸ªç‰¹æ€§åœ¨æˆ‘ä»¬æ²¡æœ‰ CI æœåŠ¡å™¨çš„ç®¡ç†æƒé™ï¼ŒåŒæ—¶åˆéœ€è¦ä¸ºæ„å»ºè®¾ç½®ä¸€äº›ä¸èƒ½è½»æ˜“æš´éœ²çš„å±æ€§çš„æ—¶å€™éå¸¸æœ‰ç”¨ã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œä¸èƒ½ä½¿ç”¨<code>-P</code>é€‰é¡¹ï¼Œä¹Ÿä¸èƒ½æ›´æ”¹ç³»ç»Ÿçº§åˆ«çš„é…ç½®æ–‡ä»¶ã€‚æ­£ç¡®çš„ç­–ç•¥æ˜¯ä¿®æ”¹ CI æœåŠ¡å™¨çš„æ„å»ºä»»åŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªç¬¦åˆæŸç§æ¨¡å¼çš„å˜é‡â€”â€”è¿™ä¸ªå˜é‡å¯¹ç³»ç»Ÿå†…çš„æ™®é€šç”¨æˆ·ä¸å¯è§ï¼š</p>
<ol>
<li>ç¯å¢ƒå˜é‡çš„æ ¼å¼å¦‚ä¸‹: <code>ORG_GRADLE_PROJECT_prop=somevalue</code>;</li>
<li>ç³»ç»Ÿå±æ€§çš„æ ¼å¼å¦‚ä¸‹: <code>org.gradle.project.prop</code>;</li>
</ol>
<blockquote>
<p>æ¯”å¦‚ç­¾åä¿¡æ¯ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œå±æ€§è®¾ç½®ã€‚</p>
</blockquote>
<h4 id="3-4-è®¾ç½®ç³»ç»Ÿå±æ€§"><a href="#3-4-è®¾ç½®ç³»ç»Ÿå±æ€§" class="headerlink" title="3.4 è®¾ç½®ç³»ç»Ÿå±æ€§"></a>3.4 è®¾ç½®ç³»ç»Ÿå±æ€§</h4><p>ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸€é¡¹ä¸å±äºè¯¥ä¸»é¢˜ã€‚å®ƒæ˜¯é€šè¿‡ç‰¹æ®Šçš„å‘½åè§„èŒƒï¼Œåœ¨<code>gradle.properties</code>æ–‡ä»¶ä¸­è®¾ç½®ç‰¹æ®Šæ ¼å¼çš„å±æ€§æ¥è®¾ç½®ç³»ç»Ÿå±æ€§â€”â€”è¿™ç§æ–¹å¼åªæœ‰åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„<code>gradle.properties</code>æ–‡ä»¶ä¸­æ‰æœ‰æ•ˆï¼Œå®ƒçš„æ ¼å¼æ˜¯<code>systemProp.propName</code>ã€‚</p>
<h4 id="3-5-ç¤ºä¾‹"><a href="#3-5-ç¤ºä¾‹" class="headerlink" title="3.5 ç¤ºä¾‹"></a>3.5 ç¤ºä¾‹</h4><p>æ¯”å¦‚åœ¨<code>gradle.properties</code>ä¸­è®¾ç½®å¦‚ä¸‹å±æ€§: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gradlePropertiesProp=gradlePropertiesValue</span><br><span class="line">sysProp=shouldBeOverWrittenBySysProp</span><br><span class="line">envProjectProp=shouldBeOverWrittenByEnvProp</span><br><span class="line">systemProp.system=systemValue</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>build.gradle</code>æ–‡ä»¶ä¸­åˆ›å»ºå¦‚ä¸‹Task:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">task printProps &lt;&lt; &#123;</span><br><span class="line">    println commandLineProjectProp</span><br><span class="line">    println gradlePropertiesProp</span><br><span class="line">    println systemProjectProp</span><br><span class="line">    println envProjectProp</span><br><span class="line">    println System.properties[&apos;system&apos;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤: <code>gradle -q -PcommandLineProjectProp=commandLineProjectPropValue -Dorg.gradle.project.systemProjectProp=systemPropertyValue printProps</code>ï¼Œåˆ™å¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">commandLineProjectPropValue</span><br><span class="line">gradlePropertiesValue</span><br><span class="line">systemPropertyValue</span><br><span class="line">envPropertyValue</span><br><span class="line">systemValue</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ã€æ³¨æ„ã€‘<code>-P</code>å‘½ä»¤ç›´æ¥ä½¿ç”¨é”®å€¼å¯¹çš„å½¢å¼å°±å¥½ï¼Œä½†æ˜¯<code>-D</code>çš„å±æ€§åå‰é¢åˆ™è¦åŠ ä¸Š<code>org.gradle.project.</code>å‰ç¼€ã€‚</p>
</blockquote>
<h2 id="å››ã€å±æ€§æŸ¥çœ‹"><a href="#å››ã€å±æ€§æŸ¥çœ‹" class="headerlink" title="å››ã€å±æ€§æŸ¥çœ‹"></a>å››ã€å±æ€§æŸ¥çœ‹</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>gradle properties</code>å‘½ä»¤æŸ¥çœ‹æŸä¸ªprojectçš„å±æ€§ï¼Œä¸‹é¢æ˜¯åœ¨æŸä¸ªæ„å»ºé¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤çš„è¾“å‡ºç‰‡æ®µ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; gradle -q api:properties</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Project :api - The shared API <span class="keyword">for</span> the application</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">allprojects: [project <span class="string">':api'</span>]</span><br><span class="line">ant: org.gradle.api.internal.project.DefaultAntBuilder@<span class="number">12345</span></span><br><span class="line">antBuilderFactory: org.gradle.api.internal.project.DefaultAntBuilderFactory@<span class="number">12345</span></span><br><span class="line">artifacts: org.gradle.api.internal.artifacts.dsl.DefaultArtifactHandler_Decorated@<span class="number">12345</span></span><br><span class="line">asDynamicObject: org.gradle.api.internal.ExtensibleDynamicObject@<span class="number">12345</span></span><br><span class="line">baseClassLoaderScope: org.gradle.api.internal.initialization.DefaultClassLoaderScope@<span class="number">12345</span></span><br><span class="line">buildDir: /home/user/gradle/samples/userguide/tutorial/projectReports/api/build</span><br><span class="line">buildFile: /home/user/gradle/samples/userguide/tutorial/projectReports/api/build.gradle</span><br></pre></td></tr></table></figure>
<p>åœ¨è„šæœ¬ä¸­ï¼Œå¦‚æœä½¿ç”¨äº†ä¸€ä¸ªæœªå®šä¹‰çš„å±æ€§ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœæ„å»ºè¿‡ç¨‹ä¾èµ–äºä¸€ä¸ªå¯é€‰çš„å±æ€§ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨<code>hasProperty(&#39;propertyName&#39;)</code>æ¥åˆ¤æ–­æŸä¸ªå±æ€§æ˜¯å¦è¢«è®¾ç½®ï¼Œæœªè®¾ç½®çš„æƒ…å†µä¸‹ä¸è¦ä½¿ç”¨ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—å…«ï¼šç®€ä»‹&å®‰è£…]]></title>
      <url>http://www.timebridge.space/2016/06/12/gradle-basic/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><p>å’Œ Mavenã€Ant ç±»ä¼¼ï¼ŒGradle æ˜¯ä¸€ä¸ªä¼˜ç§€çš„æ„å»ºå·¥å…·ã€‚å®ƒåŸºäºä¸€é—¨ JVM è„šæœ¬è¯­è¨€â€”â€”<a href="http://www.muzileecoding.com/gradlestudy/groovy.html" target="_blank" rel="noopener">Groovy</a>ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>æ”¯æŒå¤šç§è¯­è¨€ï¼Œå®˜ç½‘è¯´åˆ°ï¼ŒLinkedIn ä½¿ç”¨ Gradle å®Œæˆå¯¹60å¤šç§è¯­è¨€çš„ç¼–è¯‘ï¼ŒåŒ…æ‹¬ Javaã€Scalaã€Python ç­‰ï¼›</li>
<li>æ”¯æŒ Eclipseã€Android Studioã€IntelliJ ä»¥åŠ Jekins ç­‰å·¥å…·æ’ä»¶ï¼›</li>
<li>æ”¯æŒ Mavenã€Ivyã€flat æ–‡ä»¶ç­‰å¤šç§ä¾èµ–å¤„ç†ï¼Œå¹¶ä¸”æ”¯æŒä¾èµ–ä¼ é€’ï¼›</li>
<li>å¯¹æ•´ä¸ªæ„å»ºè¿‡ç¨‹çš„ç²¾ç»†åŒ–æ§åˆ¶ï¼›</li>
<li>é€šè¿‡å¢é‡å¼æ„å»ºä»¥ã€æ„å»ºç¼“å­˜å’Œå¹¶è¡Œæ„å»ºä¸‰ç§æ–¹å¼æœ€å¤§é™åº¦çš„æé«˜äº†Gradle Daemon çš„ç¼–è¯‘é€Ÿåº¦ï¼›</li>
<li>æä¾›å¯¹ç¼–è¯‘è¿‡ç¨‹çš„æ•°æ®åˆ†æï¼Œä¾¿äºå¼€å‘è€…ä¼˜åŒ–ç¼–è¯‘æ­¥éª¤å’Œæ¨¡å—ï¼Œè§£å†³ç¼–è¯‘é—®é¢˜ï¼›<a id="more"></a></li>
</ol>
<blockquote>
<p><a href="http://gradle.org/whygradle-build-automation/" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸Šå¯ä»¥çœ‹åˆ°è¯¦æƒ…ï¼Œåœ¨<a href="https://docs.gradle.org/current/userguide/overview.html" target="_blank" rel="noopener">User Guideç¬¬äºŒç« </a>ä¸­ä¹Ÿæœ‰ç›¸å…³çš„æè¿°ã€‚</p>
</blockquote>
<h2 id="äºŒã€ç¯å¢ƒ"><a href="#äºŒã€ç¯å¢ƒ" class="headerlink" title="äºŒã€ç¯å¢ƒ"></a>äºŒã€ç¯å¢ƒ</h2><p>å¦‚æœä½ çš„è®¾å¤‡å·²ç»æœ‰å®Œå–„çš„ Java ç¯å¢ƒ(JDK 6ä»¥åŠä¸Š)ï¼Œé‚£ä¹ˆä»¥ä¸‹ç®€å•çš„å‡ æ­¥å°±å¯ä»¥é…ç½®å¥½ Gradle ç¯å¢ƒ:</p>
<ol>
<li>ä»å®˜ç½‘ä¸‹è½½ ZIP åŒ…: <a href="http://gradle.org/gradle-download/" target="_blank" rel="noopener">é“¾æ¥</a>ï¼›</li>
<li>è§£å‹ ZIP åŒ…åˆ°æŸä¸ªæ–‡ä»¶å¤¹ï¼Œåœ°å€ Aï¼›</li>
<li>åœ¨ç¯å¢ƒå˜é‡ä¸­æ·»åŠ <code>GRADLE_HOME</code>å˜é‡ï¼ŒæŒ‡å‘ Aï¼›</li>
<li>æŠŠ<code>GRADLE_HOME/bin</code>æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡ä¸­å»ï¼›</li>
</ol>
<p>è¿™å‡ æ­¥å°±è¶³ä»¥è¿è¡Œ Gradle äº†ã€‚åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ<code>gradle -v</code>å‘½ä»¤ï¼Œå¦‚æœèƒ½æ­£ç¡®æ‰“å°å‡º Gradle çš„ç‰ˆæœ¬ï¼Œå°± OK äº†ã€‚</p>
<p>å¦å¤–è¦æ³¨æ„ä¸‹è½½çš„ ZIP åŒ…ä¸­ï¼Œé™¤äº†æˆ‘ä»¬éœ€è¦çš„ Gradle Binary ï¼Œè¿˜æœ‰ä»¥ä¸‹å†…å®¹:</p>
<ol>
<li>User Guideï¼ˆPDF &amp; HTMLï¼‰</li>
<li>DSL Reference</li>
<li>API Documentation(Java Doc and Goovydoc)</li>
<li>Sample</li>
<li>Binary source</li>
</ol>
<blockquote>
<p>å®˜ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°éå¸¸å®Œæ•´çš„è¡¨è¿°: <a href="https://docs.gradle.org/current/userguide/installation.html" target="_blank" rel="noopener">Installing Gradle</a>ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—ä¸ƒï¼šä¾èµ–ç®¡ç†]]></title>
      <url>http://www.timebridge.space/2016/05/21/gradle-advaced-dependency-management/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><p>ä¾èµ–ç®¡ç†åˆ†ä¸ºä¸¤éƒ¨åˆ†: </p>
<ol>
<li><strong>dependencies(ä¾èµ–)</strong> Gradle éœ€è¦çŸ¥é“å“ªäº›ä¸œè¥¿æ˜¯æ„å»ºä½ é¡¹ç›®çš„å¿…éœ€å“ä»¥ä¾¿äºæ‰¾åˆ°å®ƒä»¬ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨è¿›è¡Œå•å…ƒæµ‹è¯•çš„æ—¶å€™å°±éœ€è¦ä¾èµ– junit jar åŒ…ï¼›</li>
<li><strong>publications(å‘å¸ƒ)</strong> Gradle åœ¨æ„å»ºå®Œæˆé¡¹ç›®ä¹‹åï¼Œå¯èƒ½éœ€è¦ä¸Šä¼ æ„å»ºäº§ç‰©ï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰“åŒ…å‡ºæ¥çš„ aar æ–‡ä»¶ã€jar åŒ…ï¼›</li>
</ol>
<p>å¾ˆå¤šé¡¹ç›®éƒ½éœ€è¦ä¾èµ–åˆ«çš„èµ„æºä»¥å®ŒæˆåŠŸèƒ½ï¼Œæ¯”å¦‚ä»¥ SSH æ¶æ„æ­å»º J2EE é¡¹ç›®æ‰“å‡º war åŒ…ï¼Œå°±å¿…é¡»ä¾èµ– spring ç­‰æ¡†æ¶æä¾›çš„ jar åŒ… â€”â€” è¿™äº›å°±æ„æˆä¸€ä¸ªé¡¹ç›®çš„ä¾èµ–ã€‚<a id="more"></a></p>
<p>Gradle å…è®¸å¼€å‘è€…å‘Šè¯‰å®ƒé¡¹ç›®æ„å»ºä¾èµ–å“ªäº›èµ„æºï¼Œå®ƒå°±ä¼šè´Ÿè´£å¸®ä½ è§£å†³è¿™äº›ä¾èµ–ï¼ŒåŒ…æ‹¬ä¸‹è½½å®ƒä»¬ã€å°†å®ƒä»¬åŠ å…¥åˆ°æ„å»ºä¸­ï¼Œå…¶ä¸­æ ¹æ®ä¸€å®šçš„æ ¼å¼å»è§£æä¾èµ–èµ„æºå¹¶å¯»æ‰¾å®ƒä»¬çš„è¿‡ç¨‹å°±ç§°ä¸º <strong>dependency resolution</strong>ï¼Œå³<strong>ä¾èµ–è§£æ</strong>ã€‚</p>
<blockquote>
<p>è¿™ä¸€ç‚¹èƒœè¿‡ Antï¼ŒAnt åªèƒ½ç»™å‡ºéœ€è¦åŠ è½½çš„èµ„æºçš„ç»å¯¹æˆ–è€…ç›¸å¯¹è·¯å¾„ï¼Œå¦åˆ™å°±è¦ä½¿ç”¨ Ivyã€‚</p>
</blockquote>
<p>é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªé¡¹ç›®çš„ä¾èµ–ä¹Ÿä¼šä¾èµ–åˆ«çš„èµ„æºï¼ŒGradle ä¹Ÿéœ€è¦ç…§é¡¾åˆ°è¿™äº›ä¾èµ–â€”â€”è¿™è¢«ç§°ä¸º <strong>transitive dependencies</strong>ï¼Œå³<strong>ä¼ é€’ä¾èµ–</strong>ã€‚</p>
<p>å¤§éƒ¨åˆ†é¡¹ç›®æ˜¯ä¸ºäº†æ„å»ºå‡ºä¸€äº›å¯ä»¥ç»™åˆ«çš„é¡¹ç›®ä½¿ç”¨çš„æ–‡ä»¶ï¼Œå°†è¿™äº›æ–‡ä»¶äº¤ç»™å…¶ä½™é¡¹ç›®ä½¿ç”¨çš„æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯é€šè¿‡å‘å¸ƒï¼ŒGradle ä¼šä¸ºä½ å®Œæˆè¿™ä¸ªå·¥ä½œâ€”â€”å¸®åŠ©ä½ å®Œæˆæ„å»ºï¼Œå¾—åˆ°äº§å‡ºæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ åˆ°æŸä¸ªåˆ«äººå¯ä»¥è·å–åˆ°çš„åœ°æ–¹ã€‚å‘å¸ƒçš„å…·ä½“ä½ç½®å†³å®šäºå¼€å‘è€…ï¼šå¯èƒ½åªæ˜¯ç®€å•çš„å°†æ–‡ä»¶æ‹·è´åˆ°ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œæˆ–è€…ä¸Šä¼ åˆ°ä¸€ä¸ªè¿œç¨‹Mavenä»“åº“ï¼Œæˆ–è€…ä¼šåœ¨åŒä¸€ä¸ªé¡¹ç›®çš„å­é¡¹ç›®ä¸­è¿ç”¨è¿™ä¸ªè¾“å‡ºï¼Œè¿™å°±æ˜¯ <strong>publication</strong>ï¼Œå³<strong>å‘å¸ƒ</strong>ã€‚</p>
<h2 id="äºŒã€å…¥é—¨"><a href="#äºŒã€å…¥é—¨" class="headerlink" title="äºŒã€å…¥é—¨"></a>äºŒã€å…¥é—¨</h2><p>æ¥çœ‹ä¸€ä¸ªè„šæœ¬:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'java'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile group: <span class="string">'org.hibernate'</span>, name: <span class="string">'hibernate-core'</span>, version: <span class="string">'3.6.7.Final'</span></span><br><span class="line">    testCompile group: <span class="string">'junit'</span>, name: <span class="string">'junit'</span>, version: <span class="string">'4.+'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªè„šæœ¬åšäº†ä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆå®ƒå£°æ˜<code>Hibernate core 3.6.7.Final</code>åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ˜¯å¿…é¡»çš„ï¼Œå½“ç„¶ï¼Œè¯¥æ–‡ä»¶ä¾èµ–çš„æ–‡ä»¶ä¹Ÿæ˜¯å¿…é¡»çš„ã€‚å…¶æ¬¡è¯¥è„šæœ¬å£°æ˜äº†å¤§äºç­‰äº4.0ç‰ˆæœ¬çš„junitåŒ…æ˜¯ç¼–è¯‘æµ‹è¯•æ—¶å¿…é¡»çš„ã€‚æœ€åï¼Œå®ƒæŒ‡æ˜è¿™äº›æ–‡ä»¶åº”å½“åœ¨Mavençš„ä¸­å¤®ä»“åº“å»å¯»æ‰¾ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ã€‚</p>
<h2 id="ä¸‰ã€ä¾èµ–ä¸Configuration"><a href="#ä¸‰ã€ä¾èµ–ä¸Configuration" class="headerlink" title="ä¸‰ã€ä¾èµ–ä¸Configuration"></a>ä¸‰ã€ä¾èµ–ä¸Configuration</h2><p>ä¾èµ–çš„æœ¬è´¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåœ¨ Gradle ä¸­ï¼Œä¾èµ–å…¶å®æ˜¯ä¸€ç»„ç»„çš„ Configuration ï¼ŒConfigutation è¿™ä¸ªåå­—èµ·çš„éå¸¸ä¸å‹å¥½ï¼Œå®ƒçš„æœ¬æ„åº”è¯¥æ˜¯ Dependency-Group ï¼Œè€Œä¸€ä¸ªä¾èµ–æœ¬èº«å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¹Ÿå¯èƒ½ä¾èµ–åˆ«çš„æ–‡ä»¶ï¼‰ã€‚</p>
<p>é¦–å…ˆæ¥è¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šæœ‰åˆ†ç»„çš„æ¦‚å¿µï¼Œä»¥åŠä»ä»€ä¹ˆç»´åº¦è¿›è¡Œåˆ†ç»„å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­å°±æ˜ç™½äº†ï¼šæ¯”å¦‚æˆ‘å¼€å‘äº†ä¸€ä¸ª Java é¡¹ç›®ï¼Œåœ¨æˆ‘ç¼–è¯‘çš„æ—¶å€™ï¼Œæˆ‘æœ‰ä¸€ç»„éœ€è¦ä¾èµ–çš„å¤–éƒ¨èµ„æºï¼Œå½“æˆ‘è¿›è¡Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘è¿˜éœ€è¦ä¾èµ–å¦å¤–ä¸€ç»„èµ„æºï¼Œæ¯”å¦‚ Junit jar åŒ…ï¼ŒMockito jar åŒ…ï¼Œä½†æ˜¯å½“æˆ‘æµ‹è¯•å®Œæˆæ­£å¼å‘å¸ƒçš„æ—¶å€™ï¼Œæµ‹è¯•æ‰€ä¾èµ–çš„èµ„æºå…¶å®æ˜¯ä¸éœ€è¦æ‰“åŒ…è¿›å»çš„ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è‡³å°‘åº”è¯¥æŠŠä¾èµ–çš„èµ„æºåˆ†ä¸ºä¸¤ç»„ï¼šæ­£å¸¸æ‰“åŒ…æ‰€ä¾èµ–çš„èµ„æºå’Œæµ‹è¯•éœ€è¦ä¾èµ–çš„èµ„æºã€‚åœ¨ Java æ’ä»¶ä¸­ï¼Œå‰è€…ç»Ÿä¸€å½’å…¥ â€œcompileâ€ åˆ†ç»„ä¸‹ï¼Œåè€…ç»Ÿä¸€å½’å…¥ â€œtestCompileâ€ åˆ†ç»„ä¸‹ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œæ‰€æœ‰çš„ä¾èµ–æœ€åçš„ç”¨å¤„ä¸ä¸€å®šä¸€è‡´ï¼Œä¹Ÿä¸ä¸€å®šéœ€è¦æ‰“åŒ…åˆ°æœ€åçš„äº§ç‰©ä¸­å»ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹ä¾èµ–è¿›è¡Œåˆ†ç»„ï¼Œå¹¶å¯¹ç»„è¿›è¡Œç®¡ç†ã€‚</p>
<p>å¾ˆå¤šçš„æ’ä»¶éƒ½ä¼šå£°æ˜è‡ªå·±çš„ configuration ï¼Œä¾‹å­å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configurations &#123;</span><br><span class="line">    compile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å¯ä»¥å¯¹ä¸€ä¸ª Configuration è¿›è¡Œé…ç½®:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">configurations &#123;</span><br><span class="line">    compile &#123;</span><br><span class="line">        description = <span class="string">'compile classpath'</span></span><br><span class="line">        transitive = <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    runtime &#123;</span><br><span class="line">        extendsFrom compile</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">configurations.compile &#123;</span><br><span class="line">    description = <span class="string">'compile classpath'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>configuration çš„é…ç½®æœ‰å¾ˆå¤šå¯ä»¥è®²è¿°çš„åœ°æ–¹ï¼Œé™äºç¯‡å¹…å’Œä¸»é¢˜ï¼Œè¿™é‡Œä¸å±•å¼€ç»†è¯´ï¼Œç›¸ä¿¡è¯»è€…çœ‹å®Œ<a href="http://www.muzileecoding.com/gradlestudy/gradle-advaced-do.html" target="_blank" rel="noopener">Gradle DOæ¨¡å‹</a>æ˜¯å¯ä»¥è‡ªè¡Œå®Œæˆç›¸å…³å­¦ä¹ çš„ã€‚</p>
<p>æ–‡æ¡£ <a href="https://docs.gradle.org/current/userguide/dependency_management.html#sec:working_with_dependencies" target="_blank" rel="noopener">Dependency Management 23.5èŠ‚</a> ä¹Ÿè®²è¿°äº†ä¸€äº› Configuration çš„ç”¨æ³•ï¼Œè¯»è€…å¯ä»¥å…³æ³¨ã€‚</p>
<h2 id="å››ã€ä¾èµ–é…ç½®"><a href="#å››ã€ä¾èµ–é…ç½®" class="headerlink" title="å››ã€ä¾èµ–é…ç½®"></a>å››ã€ä¾èµ–é…ç½®</h2><p>ä¾èµ–é…ç½®åˆ†ä¸ºä¸¤éƒ¨åˆ†:</p>
<ol>
<li>å‘Šè¯‰ Gradle ä¾èµ–ä»€ä¹ˆï¼›</li>
<li>å‘Šè¯‰ Gradle å»å“ªé‡Œå¯»æ‰¾è¿™äº›ä¾èµ–ï¼›</li>
</ol>
<h4 id="4-1-ä¾èµ–ä»€ä¹ˆ"><a href="#4-1-ä¾èµ–ä»€ä¹ˆ" class="headerlink" title="4.1 ä¾èµ–ä»€ä¹ˆ"></a>4.1 ä¾èµ–ä»€ä¹ˆ</h4><p>Gradle æ”¯æŒçš„ä¾èµ–åˆ†ä¸ºä»¥ä¸‹å‡ ç±»:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>External module dependency</td>
<td>å¯¹ä»“åº“ä¸­çš„æŸä¸ªå¤–éƒ¨ module çš„ä¾èµ–</td>
</tr>
<tr>
<td>Project dependency</td>
<td>å¯¹åŒé¡¹ç›®ä¸‹çš„æŸä¸ªå­é¡¹ç›®çš„ä¾èµ–</td>
</tr>
<tr>
<td>File dependency</td>
<td>å¯¹æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ç»„æ–‡ä»¶çš„ä¾èµ–</td>
</tr>
<tr>
<td>Client module dependency</td>
<td>ä¹Ÿæ˜¯å¯¹ä»“åº“ä¸­çš„æŸä¸ªå¤–éƒ¨ module çš„ä¾èµ–ï¼Œä¸è¿‡ module çš„åŸå§‹ä¿¡æ¯ä¼šåœ¨ build æ–‡ä»¶ä¸­é‡æ–°å£°æ˜ï¼Œæ¯”å¦‚ä¾èµ–çš„æŸä¸ªåŒ…çš„ç‰ˆæœ¬ï¼Œæ˜¯å¦éœ€è¦å¯¹æŸä¸ªä¾èµ–åŒ…è¿›è¡Œä¼ é€’ä¾èµ–è§£æï¼Œå½“æˆ‘ä»¬éœ€è¦è¦†å†™æŸä¸ªmoduleçš„åŸå§‹ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±ä½¿ç”¨è¿™ç±»ä¾èµ–</td>
</tr>
<tr>
<td>Gradle API dependency</td>
<td>ä¾èµ–å½“å‰ Gradle ç‰ˆæœ¬çš„ APIï¼Œä¸€èˆ¬åªæœ‰åœ¨å¼€å‘ Gradle æ’ä»¶æˆ–è€… Task ç±»å‹çš„æ—¶å€™æ‰ä¼šä½¿ç”¨è¯¥ç±»ä¾èµ–</td>
</tr>
<tr>
<td>Local Groovy dependency</td>
<td>ä¾èµ–å½“å‰ Gradle ç‰ˆæœ¬ä½¿ç”¨çš„ Groovy ç‰ˆæœ¬ï¼Œä¸€èˆ¬åªæœ‰åœ¨å¼€å‘ Gradle æ’ä»¶æˆ–è€… Task ç±»å‹çš„æ—¶å€™æ‰ä¼šä½¿ç”¨è¯¥ç±»ä¾èµ–</td>
</tr>
</tbody>
</table>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªä¼šç”¨åˆ°å‰ä¸‰ç§é…ç½®ï¼Œè€Œä¸”è¿™ç§é…ç½®æ˜¯æä¸ºç®€å•çš„ï¼Œå®ƒä»¬çš„ä½¿ç”¨ä¾‹å­å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">	<span class="comment">// External module dependency</span></span><br><span class="line">   runtime group: <span class="string">'org.springframework'</span>, name: <span class="string">'spring-core'</span>, version: <span class="string">'2.5'</span></span><br><span class="line">   runtime <span class="string">'org.springframework:spring-core:2.5'</span>,</span><br><span class="line">            <span class="string">'org.springframework:spring-aop:2.5'</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// Project dependency</span></span><br><span class="line">   <span class="function">compile <span class="title">project</span><span class="params">(<span class="string">':shared'</span>)</span></span></span><br><span class="line"><span class="function">   </span></span><br><span class="line"><span class="function">   <span class="comment">// File dependencies</span></span></span><br><span class="line"><span class="function">   runtime <span class="title">files</span><span class="params">(<span class="string">'libs/a.jar'</span>, <span class="string">'libs/b.jar'</span>)</span></span></span><br><span class="line"><span class="function">   runtime <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: <span class="string">'*.jar'</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>ç¬¬å››ç§ä¸æ˜¯å¾ˆå¸¸è§ï¼Œå®ƒçš„ä¾‹å­å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="function">runtime <span class="title">module</span><span class="params">(<span class="string">"org.codehaus.groovy:groovy:2.4.4"</span>)</span> </span>&#123;</span><br><span class="line">        dependency(<span class="string">"commons-cli:commons-cli:1.0"</span>) &#123;</span><br><span class="line">        	  <span class="comment">// æ›´æ”¹ä¼ é€’æ€§</span></span><br><span class="line">            transitive = <span class="keyword">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">module</span>(group: <span class="string">'org.apache.ant'</span>, name: <span class="string">'ant'</span>, version: <span class="string">'1.9.6'</span>) &#123;</span><br><span class="line">        	  <span class="comment">// æ›´æ”¹ä¾èµ–åŒ…</span></span><br><span class="line">            dependencies <span class="string">"org.apache.ant:ant-launcher:1.9.6@jar"</span>,</span><br><span class="line">                         <span class="string">"org.apache.ant:ant-junit:1.9.6"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¤§éƒ¨åˆ†æ—¶å€™éœ€è¦æŒ‡å®šä¾èµ–ä»€ä¹ˆï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦æŒ‡å‡ºæˆ‘ä»¬ä¸èƒ½ä¾èµ–ä»€ä¹ˆï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">configurations &#123;</span><br><span class="line">    compile.exclude <span class="keyword">module</span>: <span class="string">'commons'</span></span><br><span class="line">    all*.exclude group: <span class="string">'org.gradle.test.excludes'</span>, <span class="keyword">module</span>: <span class="string">'reports'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile(<span class="string">"org.gradle.test.excludes:api:1.0"</span>) &#123;</span><br><span class="line">        exclude <span class="keyword">module</span>: <span class="string">'shared'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€ç§æ˜¯é€šè¿‡ Configurationï¼Œä¸€ç§æ˜¯é€šè¿‡ Dependencyã€‚å‰è€…å¯ä»¥æŒ‡å®šæŸä¸€ Confuration è¿˜æ˜¯æ‰€æœ‰çš„ Configuration éƒ½æ’é™¤å¯¹æŸä¸€èµ„æºçš„ä¾èµ–ã€‚</p>
<h4 id="4-2-å»å“ªé‡Œå¯»æ‰¾ä¾èµ–"><a href="#4-2-å»å“ªé‡Œå¯»æ‰¾ä¾èµ–" class="headerlink" title="4.2 å»å“ªé‡Œå¯»æ‰¾ä¾èµ–"></a>4.2 å»å“ªé‡Œå¯»æ‰¾ä¾èµ–</h4><p>Gradle ä»ä»“åº“ä¸­å¯»æ‰¾ä¾èµ–çš„æ–‡ä»¶ï¼Œä»“åº“åªæ˜¯ä¸€å †æ–‡ä»¶çš„é›†åˆï¼Œé€šè¿‡â€groupâ€ã€â€nameâ€å’Œâ€versionâ€ä¸‰ä¸ªç»´åº¦æ¥ç»„ç»‡ã€‚Gradle å¯ä»¥è§£æå¤šç§ä»“åº“æ ¼å¼ï¼Œæ¯”å¦‚ Maven å’Œ Ivyï¼Œå¹¶ä¸”æä¾›å¤šç§ä¸åŒçš„è®¿é—®ä»“åº“çš„æ–¹å¼ï¼Œæ¯”å¦‚ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæˆ–è€… HTTPã€‚</p>
<p>Gradle é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šå®šä¹‰ä»»ä½•çš„ä»“åº“ï¼Œåœ¨ä½¿ç”¨å¤–éƒ¨ä»“åº“ä¹‹å‰ï¼Œå¼€å‘è€…è€Œå¿…é¡»è‡³å°‘é…ç½®ä¸€ä¸ªä»“åº“ï¼Œå…¶ä¸­ä¸€ä¸ªé€‰æ‹©å°±æ˜¯ä½¿ç”¨ Maven ä¸­å¤®ä»“åº“:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ JCenter:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™¤äº†è¿™äº›é»˜è®¤çš„å¯ä»¥å¿«æ·æŒ‡å®šçš„ä»“åº“ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç”¨ä¸€ä¸‹æ–¹å¼æŒ‡å®šä¸€äº›å…¶ä½™çš„ä»“åº“:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    maven &#123;</span><br><span class="line">        url <span class="string">"http://repo.mycompany.com/maven2"</span></span><br><span class="line">    &#125;</span><br><span class="line">    ivy &#123;</span><br><span class="line">        url <span class="string">"http://repo.mycompany.com/repo"</span></span><br><span class="line">    &#125;</span><br><span class="line">    ivy &#123;</span><br><span class="line">        <span class="comment">// URL can refer to a local directory</span></span><br><span class="line">        url <span class="string">"../local-repo"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šé…ç½®æ‰€ç¤ºï¼ŒGradle ä¼šæŒ‰ç…§é¡ºåºæ¥æœå¯»ä¸€ä¸ªä¾èµ–ï¼Œç›´åˆ°æ‰¾åˆ°ä¾èµ–ä½ç½®ã€‚å…³äºGradleæ”¯æŒçš„ä»“åº“é…ç½®æ–¹å¼ï¼ŒåŒæ ·åœ¨ <a href="https://docs.gradle.org/current/userguide/dependency_management.html#sec:repositories" target="_blank" rel="noopener">Dependency Management 23.6èŠ‚</a> ä¸­æœ‰è¯¦ç»†çš„æè¿°ï¼ŒåŒ…æ‹¬å¯¹äºä¸€äº›éœ€è¦å¯†ç çš„ä»“åº“åº”å½“å¦‚ä½•é…ç½®éƒ½æœ‰è¯¦ç»†è¯´æ˜ã€‚</p>
<h2 id="äº”ã€ä¾èµ–ç‰ˆæœ¬"><a href="#äº”ã€ä¾èµ–ç‰ˆæœ¬" class="headerlink" title="äº”ã€ä¾èµ–ç‰ˆæœ¬"></a>äº”ã€ä¾èµ–ç‰ˆæœ¬</h2><h4 id="5-1-åŠ¨æ€ç‰ˆæœ¬-Dynamic-Versions-å’Œå˜åŒ–æ¨¡å—-Changing-Modules"><a href="#5-1-åŠ¨æ€ç‰ˆæœ¬-Dynamic-Versions-å’Œå˜åŒ–æ¨¡å—-Changing-Modules" class="headerlink" title="5.1 åŠ¨æ€ç‰ˆæœ¬(Dynamic Versions)å’Œå˜åŒ–æ¨¡å—(Changing Modules)"></a>5.1 åŠ¨æ€ç‰ˆæœ¬(Dynamic Versions)å’Œå˜åŒ–æ¨¡å—(Changing Modules)</h4><p>ç»å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç¡®å†™å‡ºæˆ‘ä»¬æƒ³è¦ä¾èµ–çš„ Module çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runtime group: <span class="string">'org.springframework'</span>, name: <span class="string">'spring-core'</span>, version: <span class="string">'2.5'</span></span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯æŒ‡å®šä¾èµ–2.5ç‰ˆæœ¬çš„ spring-coreã€‚ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬æœ‰ä¸€äº›åˆ«çš„éœ€æ±‚ï¼š</p>
<ol>
<li><strong>ä¾èµ–æŸä¸ªModuleæœ€æ–°çš„ç‰ˆæœ¬ï¼Œæˆ–è€…æŸä¸ªèŒƒå›´å†…çš„æœ€æ–°ç‰ˆæœ¬ã€‚</strong> è¿™ç§æœ€æ–°ç‰ˆæœ¬çš„è·å¾—ä¸æ˜¯é€šè¿‡æ‰‹åŠ¨æ›´æ”¹ç‰ˆæœ¬å·æ¥è·å¾—çš„ï¼Œè€Œæ˜¯ä½¿ç”¨â€2.+â€è¿™æ ·çš„ç¬¦å·ï¼Œç”±ä¾èµ–ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨è·å–çš„ï¼Œå¦‚æœè¿™æ—¶å€™æœ€æ–°ç‰ˆæœ¬æ˜¯2.5ï¼Œé‚£å°±ä½¿ç”¨2.5ï¼Œå¦‚æœæœ‰2.6ï¼Œå°±ä½¿ç”¨2.6ï¼Œè€Œæˆ‘çš„é…ç½®å§‹ç»ˆæ˜¯â€2.+â€ï¼Œè¿™å°±æ˜¯ <strong>Dynamic Versions</strong> ã€‚</li>
<li><strong>ä¾èµ–æŸä¸ªç‰ˆæœ¬çš„æœ€æ–°ä¸€ç‰ˆã€‚</strong> è¿™å¬ä¸Šå»æœ‰ç‚¹å¥‡æ€ªã€‚æœ€ä½³çš„ä¾‹å­å…¶å®å°±æ˜¯ Maven çš„ <strong>SNAPSHOT</strong>ï¼Œæˆ‘å¯ä»¥æŒ‡å®šä¾èµ–æŸä¸€ä¸ªç‰ˆæœ¬çš„ <strong>SNAPSHOT</strong> ç‰ˆæœ¬ï¼Œæ¯”å¦‚â€2.5-SNAPSHOTâ€ï¼Œè¿™æ ·åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸Šæœ‰ä»»ä½•çš„ä¿®æ”¹ä¾èµ–æ–¹éƒ½å¯ä»¥å°½å¿«å¾—çŸ¥ï¼ŒåŒæ—¶ Module çš„å¼€å‘è€…ä¹Ÿå¯ä»¥å»å¼€å‘2.6ç‰ˆæœ¬ï¼Œè€Œä¸ä¼šå½±å“åˆ°2.5ç‰ˆæœ¬ï¼Œè¿™å°±æ˜¯ <strong>Changing Modules</strong> ã€‚</li>
</ol>
<p>é»˜è®¤æ¥è¯´ï¼ŒGradle ç¼“å­˜è¿™ä¸¤ç§ç‰ˆæœ¬ 24hã€‚</p>
<h4 id="5-2-ç‰ˆæœ¬å†²çª"><a href="#5-2-ç‰ˆæœ¬å†²çª" class="headerlink" title="5.2 ç‰ˆæœ¬å†²çª"></a>5.2 ç‰ˆæœ¬å†²çª</h4><p>å¦‚æœåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¾èµ–åŒä¸€ä¸ª Module çš„ä¸¤ä¸ªä¸åŒç‰ˆæœ¬ï¼Œå°±ä¼šå¸¦æ¥ç‰ˆæœ¬å†²çªï¼Œç‰ˆæœ¬å†²çªä¸ä½†ä¼šå¯¼è‡´ç¼–è¯‘ä¸é€šè¿‡ï¼Œé”™è¯¯çš„è§£å†³æ–¹å¼ä¹Ÿä¼šå½±å“äº§å“çš„åŠŸèƒ½ã€‚Gradle æä¾›ä¸¤ç§ä¾èµ–å†²çªè§£å†³ç­–ç•¥ï¼š</p>
<ol>
<li><strong>Newest</strong> ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ä¾èµ–ï¼Œè¿™æ˜¯ Gradle çš„é»˜è®¤ç­–ç•¥ï¼Œåªè¦ä¾èµ–çš„åŒ…æ˜¯å‘åå…¼å®¹çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªç­–ç•¥é€šå¸¸å°±æ˜¯åˆé€‚çš„ï¼›</li>
<li><strong>Fail</strong> ä¸€æ—¦ç‰ˆæœ¬å†²çªï¼Œæ„å»ºå°±å¤±è´¥ã€‚è¿™ä¸ªç­–ç•¥è¦æ±‚åœ¨è„šæœ¬ä¸­è§£å†³æ‰€æœ‰çš„å†²çªâ€”â€”å¯ä»¥å‚ç…§<a href="https://docs.gradle.org/current/dsl/org.gradle.api.artifacts.ResolutionStrategy.html" target="_blank" rel="noopener">ResolutionStrategy</a>æä¾›çš„è§£å†³æ–¹æ¡ˆï¼›</li>
</ol>
<p>å°½ç®¡ä¸Šé¢ä¸¤é¡¹ç­–ç•¥å·²ç»å¯ä»¥è§£å†³å¤§éƒ¨åˆ†çš„å†²çªé—®é¢˜ï¼Œä½†æ˜¯ Gradle ä»ç„¶åšçš„æ›´å¤šï¼Œæä¾›ä¸€äº›æ›´ç²¾ç»†çš„æ‰‹æ®µæ¥è§£å†³ç‰ˆæœ¬å†²çªï¼šå¯ä»¥å°†ç¬¬ä¸€çº§æˆ–è€…æ‰€æœ‰çš„ä¾èµ–ï¼ˆåŒ…æ‹¬ä¼ é€’ä¾èµ–ï¼‰è®¾ç½®ä¸º<code>forced</code>æ¥æŒ‡å®šä¸€ä¸ªç‰ˆæœ¬ï¼Œä¾‹å­å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'java'</span> <span class="comment">//so that there are some configurations</span></span><br><span class="line"></span><br><span class="line">configurations.all &#123;</span><br><span class="line">  resolutionStrategy &#123;</span><br><span class="line">    <span class="comment">// fail eagerly on version conflict (includes transitive dependencies)</span></span><br><span class="line">    <span class="comment">// e.g. multiple different versions of the same dependency (group and name are equal)</span></span><br><span class="line">    failOnVersionConflict()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// force certain versions of dependencies (including transitive)</span></span><br><span class="line">    <span class="comment">//  *append new forced modules:</span></span><br><span class="line">    force <span class="string">'asm:asm-all:3.3.1'</span>, <span class="string">'commons-io:commons-io:1.4'</span></span><br><span class="line">    <span class="comment">//  *replace existing forced modules with new ones:</span></span><br><span class="line">    forcedModules = [<span class="string">'asm:asm-all:3.3.1'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add dependency substitution rules</span></span><br><span class="line">    dependencySubstitution &#123;</span><br><span class="line">      <span class="function">substitute <span class="title">module</span><span class="params">(<span class="string">'org.gradle:api'</span>)</span> with <span class="title">project</span><span class="params">(<span class="string">':api'</span>)</span></span></span><br><span class="line"><span class="function">      substitute <span class="title">project</span><span class="params">(<span class="string">':util'</span>)</span> with <span class="title">module</span><span class="params">(<span class="string">'org.gradle:util:3.0'</span>)</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="comment">// cache dynamic versions for 10 minutes</span></span></span><br><span class="line"><span class="function">    cacheDynamicVersionsFor 10*60, 'seconds'</span></span><br><span class="line"><span class="function">    <span class="comment">// don't cache changing modules at all</span></span></span><br><span class="line"><span class="function">    cacheChangingModulesFor 0, 'seconds'</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å‰é¢æè¿°çš„<code>exclude</code>å½¢å¼ä¹Ÿæ˜¯ä¸€ç§è§£å†³å†²çªçš„åŠæ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ ¹é¡¹ç›®ä¸‹ç§»é™¤å¯¹æŸä¸ªèµ„æºæ‰€æœ‰ç‰ˆæœ¬çš„ä¾èµ–ï¼Œç»Ÿä¸€ä¾èµ–ä¸€ä¸ªæœ€æ–°ç‰ˆæœ¬çš„åŒ…ï¼Œä½†è¿™ç§æ–¹å¼æ¯”è¾ƒç²—æš´ï¼Œä¸ä¸€å®šæ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚</p>
</blockquote>
<h2 id="å…­ã€é«˜çº§é…ç½®"><a href="#å…­ã€é«˜çº§é…ç½®" class="headerlink" title="å…­ã€é«˜çº§é…ç½®"></a>å…­ã€é«˜çº§é…ç½®</h2><p>ä¸Šé¢è®²è¿°çš„æ˜¯ä¸€äº›åŸºæœ¬çš„é…ç½®æ–¹æ¡ˆï¼Œ99%çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ç®€å•çš„é…ç½®ä¸€ä¸‹å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œä½†æ˜¯ Gradle å¯¹é…ç½®çš„æ”¯æŒè¿œä¸æ­¢å¦‚æ­¤ã€‚</p>
<h4 id="6-1-ä¾èµ–æ›¿æ¢"><a href="#6-1-ä¾èµ–æ›¿æ¢" class="headerlink" title="6.1 ä¾èµ–æ›¿æ¢"></a>6.1 ä¾èµ–æ›¿æ¢</h4><p>è¿™é‡Œä¸¾å‡ ä¸ªä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">configurations.all &#123;</span><br><span class="line">    resolutionStrategy.eachDependency &#123; DependencyResolveDetails details -&gt;</span><br><span class="line">        <span class="keyword">if</span> (details.requested.group == <span class="string">'org.software'</span> &amp;&amp; details.requested.name == <span class="string">'some-library'</span> &amp;&amp; details.requested.version == <span class="string">'1.2'</span>) &#123;</span><br><span class="line">            <span class="comment">//prefer different version which contains some necessary fixes</span></span><br><span class="line">            details.useVersion <span class="string">'1.2.1'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ˜¯ç‰ˆæœ¬æ›¿æ¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">configurations.all &#123;</span><br><span class="line">    resolutionStrategy.eachDependency &#123; DependencyResolveDetails details -&gt;</span><br><span class="line">        <span class="keyword">if</span> (details.requested.name == <span class="string">'groovy-all'</span>) &#123;</span><br><span class="line">            <span class="comment">//prefer 'groovy' over 'groovy-all':</span></span><br><span class="line">            details.useTarget group: details.requested.group, name: <span class="string">'groovy'</span>, version: details.requested.version</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (details.requested.name == <span class="string">'log4j'</span>) &#123;</span><br><span class="line">            <span class="comment">//prefer 'log4j-over-slf4j' over 'log4j', with fixed version:</span></span><br><span class="line">            details.useTarget <span class="string">"org.slf4j:log4j-over-slf4j:1.7.10"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ˜¯åŒ…æ›¿æ¢ï¼Œç›´æ¥å°†ä¸€ä¸ªä¾èµ–æ›¿æ¢æˆå¯å…¼å®¹çš„å¦å¤–ä¸€ä¸ªåŒ…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">configurations.all &#123;</span><br><span class="line">    resolutionStrategy.dependencySubstitution &#123;</span><br><span class="line">        <span class="function">substitute <span class="title">module</span><span class="params">(<span class="string">"org.utils:api"</span>)</span> with <span class="title">project</span><span class="params">(<span class="string">":api"</span>)</span></span></span><br><span class="line"><span class="function">        substitute <span class="title">module</span><span class="params">(<span class="string">"org.utils:util:2.5"</span>)</span> with <span class="title">project</span><span class="params">(<span class="string">":util"</span>)</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ˜¯ç”¨ project æ›¿æ¢ moduleã€‚</p>
<p>ä¾èµ–ç®¡ç†æœ‰ä¸€ç»„è§£æè§„åˆ™ï¼Œä¸€ç»„æ›¿æ¢è§„åˆ™ï¼Œè¿˜æœ‰ä¸€ç»„æ˜ å°„è§„åˆ™ï¼ˆå¯èƒ½æœ‰å¤šä¸ª module ç¬¦åˆæ¡ä»¶ï¼‰ï¼Œè¯»è€…çŸ¥é“æœ‰è¿™äº›å°±è¶³å¤Ÿäº†ï¼Œå…·ä½“çš„å†…å®¹å¯ä»¥å‚è€ƒ<a href="https://docs.gradle.org/current/userguide/dependency_management.html" target="_blank" rel="noopener">Dependency Management 23.8èŠ‚</a>ã€‚</p>
<h4 id="6-2-ä¾èµ–ç¼“å­˜"><a href="#6-2-ä¾èµ–ç¼“å­˜" class="headerlink" title="6.2 ä¾èµ–ç¼“å­˜"></a>6.2 ä¾èµ–ç¼“å­˜</h4><p>ä¸ºäº†åŠ å¿«æ„å»ºé€Ÿåº¦ï¼ŒGradle ä¼šå¯¹ä¸‹è½½ä¸‹æ¥çš„ä¾èµ–èµ„æºè¿›è¡Œç¼“å­˜ï¼Œé¿å…æ¯æ¬¡éƒ½å»ä¸‹è½½ã€‚</p>
<p>Gradle çš„ä¾èµ–ç¼“å­˜åˆ†ä¸ºä¸¤ç§ç±»å‹çš„å­˜å‚¨:</p>
<ol>
<li>ä¸‹è½½ä¸‹æ¥çš„ä¾èµ–èµ„æºæ–‡ä»¶(artifacts)ï¼ŒåŒ…æ‹¬äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚jaråŒ…ä»¥åŠ meta-dataï¼Œæ¯”å¦‚ POM æ–‡ä»¶å’Œ Ivy æ–‡ä»¶ã€‚æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ä¸ŠåŒ…å«ç€ SHA1 æ ¡éªŒå€¼ï¼Œè¿™æ„å‘³ç€ä¸¤ä¸ªåŒåä¸åŒå†…å®¹çš„æ–‡ä»¶ä¸ä¼šå¯ä»¥åŒæ—¶è¢«ç¼“å­˜ï¼›</li>
<li>è§£æå‡ºæ¥çš„ module meta-data çš„äºŒè¿›åˆ¶å­˜å‚¨ï¼ŒåŒ…æ‹¬è§£æå‡ºæ¥çš„åŠ¨æ€ç‰ˆæœ¬çš„ç»“æœï¼Œmodule çš„æè¿°ä¿¡æ¯ï¼Œä»¥åŠæ–‡ä»¶ï¼›</li>
</ol>
<p>åˆ†å¼€å­˜å‚¨çš„ä¸»è¦ç›®çš„æ˜¯å°†ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶ä¸ç¼“å­˜ metadata åˆ†å¼€ã€‚ä»<a href="https://docs.gradle.org/current/userguide/dependency_management.html#sec:dependency_cache" target="_blank" rel="noopener">å®˜ç½‘æ–‡æ¡£</a>ä»¥åŠå®é™…è®¾å¤‡çš„ç¼“å­˜å†…å®¹æ¥çœ‹ï¼Œç¼“å­˜åˆ’åˆ†çš„ç»´åº¦å¾ˆå¤šï¼ŒåŒ…æ‹¬ï¼šGradle ç‰ˆæœ¬ï¼ŒRepositoryï¼ŒChecksum ç­‰ï¼Œä¼šåœ¨è®¾å¤‡ä¸Šç•™ä¸‹æ•°é‡åºå¤§çš„ç¼“å­˜çš„ä¿¡æ¯ã€‚</p>
<blockquote>
<p>ç¼“å­˜çš„ artifacts æ˜¯ä»¥ SHA1 æ ¡éªŒå€¼ä½œä¸ºèº«ä»½æ ‡è¯†çš„ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å€¼æ ¡éªŒæœ¬åœ°èµ„æºæ–‡ä»¶ä¸è¿œç¨‹æ˜¯å¦ä¸€è‡´ã€‚</p>
<p>ç¼“å­˜å¯èƒ½åŒæ—¶è¢«å¤šä¸ªè¿›ç¨‹æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ Gradle ä½¿ç”¨æ–‡ä»¶é”æ¥ä¿è¯ä¸€è‡´æ€§ã€‚</p>
</blockquote>
<p>è™½ç„¶é»˜è®¤ä¼šä½¿ç”¨ç¼“å­˜ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¸»åŠ¨æ§åˆ¶è¿™ä¸€è¡Œä¸º: </p>
<ol>
<li><strong><code>--offline</code></strong> å‘Šè¯‰ Gradle åªèƒ½ä½¿ç”¨ç¼“å­˜ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œä¸éœ€è¦å»æ£€æµ‹èµ„æºæ–‡ä»¶æ˜¯å¦å·²ç»è¢«æ›´æ–°ï¼Œå¦‚æœæœ¬åœ°ç¼“å­˜ä¸­æ‰¾ä¸åˆ°èµ„æºæ–‡ä»¶ï¼Œåˆ™æ„å»ºå¤±è´¥ï¼›</li>
<li><strong><code>--refresh-dependencies</code></strong> Gradle å¯èƒ½å› ä¸ºé…ç½®é—®é¢˜æˆ–è€…æ‹‰å–äº†é”™è¯¯çš„èµ„æºæ–‡ä»¶ï¼Œå¯¼è‡´ç”¨æˆ·éœ€è¦å†æ¬¡å»æœåŠ¡ç«¯æ‹‰å–æœ€æ–°çš„æ–‡ä»¶ï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ·»åŠ è¯¥é€‰é¡¹ï¼Œå®ƒä¼šä½¿å¾— Gradle å¿½ç•¥æœ¬åœ°çš„æ‰€æœ‰ç¼“å­˜ï¼Œå¹¶æ›´æ–°ç›¸å…³çš„æ‰€æœ‰é…ç½®ã€æ–‡ä»¶ã€‚</li>
</ol>
<p>å¦å¤–ï¼ŒGradle è¿˜æä¾›äº† ResolutionStrategy æ¥æ›´ç²¾ç»†åŒ–çš„æ§åˆ¶ç¼“å­˜ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤æƒ…å†µä¸‹ Gradle ç¼“å­˜åŠ¨æ€ç‰ˆæœ¬ (dynamic version) çš„æ—¶é—´æ˜¯24hï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç æ›´æ”¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configurations.all &#123;</span><br><span class="line">    resolutionStrategy.cacheDynamicVersionsFor <span class="number">10</span>, <span class="string">'minutes'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥æ›´æ”¹å˜åŒ–æ¨¡å— (changing module) çš„æ—¶é—´:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configurations.all &#123;</span><br><span class="line">    resolutionStrategy.cacheChangingModulesFor <span class="number">4</span>, <span class="string">'hours'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸ƒã€å‘å¸ƒ"><a href="#ä¸ƒã€å‘å¸ƒ" class="headerlink" title="ä¸ƒã€å‘å¸ƒ"></a>ä¸ƒã€å‘å¸ƒ</h2><p>ä¾èµ–é…ç½®ä¹Ÿå¯ä»¥ç”¨äºé…ç½®äº§ç‰©å‘å¸ƒï¼Œå‘å¸ƒçš„äº§ç‰©è¢«ç§°ä¸º <strong>publication artifacts</strong>ã€‚</p>
<p>äº‹å®ä¸Šï¼Œæ’ä»¶å·²ç»å®šä¹‰å¥½ä¸€ä¸ªé¡¹ç›®çš„äº§ç‰©äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…·ä½“ä¸Šä¼ ä»€ä¹ˆï¼Œä¸éœ€è¦å¼€å‘è€…å†å‘Šè¯‰ Gradleã€‚</p>
<blockquote>
<p>è¿™é‡Œæåˆ°ä¸€ä¸ªä¹‹å‰æ²¡æœ‰æè¿‡çš„æ¦‚å¿µ: æ’ä»¶ã€‚å¯ä»¥è®¤ä¸ºè¿™ä¸ªå°±æ˜¯æŸä¸€ç±»é¡¹ç›®çš„æ„å»ºè„šæœ¬ï¼Œæ¯”å¦‚ä¸“é—¨æŠŠ J2EE é¡¹ç›®æ„å»ºæˆ war åŒ…ã€‚</p>
</blockquote>
<p>å‰©ä¸‹çš„å°±æ˜¯å‘Šè¯‰ Gradle æŠŠæ„å»ºäº§ç‰©å‘å¸ƒåˆ°ä»€ä¹ˆåœ°æ–¹äº†ï¼Œå…·ä½“åšæ³•å°±æ˜¯æŠŠä¸€ä¸ªä»“åº“ä¼ é€’ç»™<code>uploadArchives</code>Task:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">uploadArchives &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        ivy &#123;</span><br><span class="line">            credentials &#123;</span><br><span class="line">                username <span class="string">"username"</span></span><br><span class="line">                password <span class="string">"pw"</span></span><br><span class="line">            &#125;</span><br><span class="line">            url <span class="string">"http://repo.mycompany.com"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é…ç½®å¥½ä¹‹åï¼Œæ‰§è¡Œ<code>gradle uploadArchives</code>å‘½ä»¤å°±å¯ä»¥ä¸Šä¼ å‘å¸ƒäº§ç‰©äº†â€”â€” Gradle ä¼šä¸ºä½ è´Ÿè´£å…¶ä½™çš„ä¸€åˆ‡ï¼Œæ¯”å¦‚æ·»åŠ  Maven éœ€è¦çš„ pom.xmlæ–‡ä»¶ã€‚</p>
<blockquote>
<p>å‘å¸ƒåˆ° Maven ä»“åº“éœ€è¦ä½¿ç”¨ Maven æ’ä»¶ï¼Œå…·ä½“è§<a href="https://docs.gradle.org/current/userguide/publishing_maven.html" target="_blank" rel="noopener">Maven Publishing</a>ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—å››ï¼šTask]]></title>
      <url>http://www.timebridge.space/2016/05/19/gradle-task/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><p><strong>Task</strong>ï¼Œæ˜¯ä¸€å°æ®µå¯ä»¥æ‰§è¡Œçš„è„šæœ¬ä»£ç ï¼Œå®ƒæ˜¯ç»„æˆ Gradle è„šæœ¬æ–‡ä»¶çš„é‡è¦å†…å®¹ã€‚</p>
<p>ç±»æ¯”èµ·æ¥ï¼Œå¯ä»¥å°† Gradle è„šæœ¬æ–‡ä»¶çœ‹æˆä¸€ä¸ªç±»ï¼Œå°† Task çœ‹æˆè¿™ä¸ªç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<blockquote>
<p>å®é™…ä¸Šè„šæœ¬æ–‡ä»¶ä»¥åŠ Task ç¡®å®æ˜ å°„åˆ° Java ç±»ï¼Œè¿™ä¸€ç‚¹ä¼šåœ¨<a href="http://www.muzileecoding.com/gradlestudy/gradle-advaced-do.html" target="_blank" rel="noopener">Gradle DOæ¨¡å‹</a>ä¸­è¯´æ˜ã€‚<a id="more"></a></p>
</blockquote>
<h2 id="äºŒã€å…¥é—¨"><a href="#äºŒã€å…¥é—¨" class="headerlink" title="äºŒã€å…¥é—¨"></a>äºŒã€å…¥é—¨</h2><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªç›®å½•ä¸‹æ‰§è¡Œ<code>gradle</code>å‘½ä»¤çš„æ—¶å€™ï¼Œ<code>gradle</code>å‘½ä»¤ä¼šé¦–å…ˆåœ¨å½“å‰ç›®å½•ä¸‹å¯»æ‰¾<code>build.gradle</code>æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ Gradle è„šæœ¬æ–‡ä»¶â€”â€”é€šè¿‡è¿™ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª Project å’Œä¸€ç³»åˆ— Taskã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬åœ¨ä¸€ä¸ª<code>build.gradle</code>æ–‡ä»¶ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">task hello &#123;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        println <span class="string">'Hello world!'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ<code>gradle -q hello:</code>ï¼Œå°±ä¼šæœ‰å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt; gradle -q hello
Hello world!
</code></pre><p>è¿™ä¸ªä¾‹å­éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå«åšâ€helloâ€çš„ Taskï¼Œåœ¨è¿™ä¸ª Task ä¸­ï¼Œæˆ‘ä»¬æ’å…¥äº†ä¸€ä¸ª Action â€”â€” Actionä¹Ÿæ˜¯ä¸€å°æ®µå¯æ‰§è¡Œçš„ Groovy è„šæœ¬æ–‡ä»¶ï¼Œå®ƒæ˜¯ç»„æˆ Task çš„åŸºæœ¬å…ƒç´ ï¼Œä»¥é—­åŒ…çš„å½¢å¼å£°æ˜ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·å®ç° Task å‘¢ï¼Ÿè¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†æ›´åŠ çµæ´»çš„æ§åˆ¶ Task çš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>ä¸äº†è§£é—­åŒ…çš„è¯å¯ä»¥çœ‹æ–‡ç« : <a href="http://www.muzileecoding.com/gradlestudy/groovy.html" target="_blank" rel="noopener">Groovy è¯­æ³•</a>ã€‚</p>
<p>å®˜ç½‘ä¸Šè¯´ Groovy çš„ Task å’Œ Ant çš„ Target åœ¨æ¦‚å¿µä¸Šæ˜¯ä¸€è‡´çš„ã€‚æœ‰ Ant ç»éªŒçš„å°ä¼™ä¼´å¯ä»¥ç±»æ¯”ç†è§£ã€‚</p>
</blockquote>
<h2 id="ä¸‰ã€Taskæ¨¡å‹"><a href="#ä¸‰ã€Taskæ¨¡å‹" class="headerlink" title="ä¸‰ã€Taskæ¨¡å‹"></a>ä¸‰ã€Taskæ¨¡å‹</h2><p><strong>Task æ˜¯ä¸€ç»„ Action çš„ç»„åˆï¼Œè¿™ç»„ Action å­˜å‚¨åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ Task çš„æ—¶å€™ï¼Œå…¶å®æ˜¯åœ¨é¡ºåºæ‰§è¡Œè¿™ç»„ Actionã€‚</strong></p>
<p>Task æä¾›äº†ä¸€ç»„é«˜çº§åŠŸèƒ½ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨ Action é“¾è¡¨å‰åæ’å…¥ Action ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'Hello A'</span></span><br><span class="line">&#125;</span><br><span class="line">hello.doFirst &#123;</span><br><span class="line">    println <span class="string">'Hello B'</span></span><br><span class="line">&#125;</span><br><span class="line">hello.doLast &#123;</span><br><span class="line">    println <span class="string">'Hello C'</span></span><br><span class="line">&#125;</span><br><span class="line">hello.doFirst &#123;</span><br><span class="line">    println <span class="string">'Hello D'</span></span><br><span class="line">&#125;</span><br><span class="line">hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'Hello E'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>Hello D
Hello B
Hello A
Hello C
Hello E
</code></pre><p>è¿™ä¸ªé¡ºåºæ˜¯æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Ÿè§£é‡Šä¸€ä¸‹è¯­æ³•å°±æ˜ç™½äº†:</p>
<p><strong>Task å¯ä»¥æ‰§è¡Œä¸¤ç§æ–¹æ³•: <code>doLast</code>å’Œ<code>doFirst</code>ï¼Œå…¶ä¸­<code>&lt;&lt;</code>ç¬¦å·å’Œ<code>doLast</code>ç­‰æ•ˆã€‚å‰é¢è¯´äº†ï¼Œå¯ä»¥æƒ³è±¡Taskå†…éƒ¨æœ‰ä¸€ä¸ª Action é“¾è¡¨ï¼Œ<code>doLast</code>è´Ÿè´£åœ¨è¿™ä¸ªé“¾è¡¨çš„æœ€åé¢æ’å…¥å…ƒç´ ï¼Œ<code>doFirst</code>è´Ÿè´£åœ¨é“¾è¡¨çš„æœ€å‰é¢æ’å…¥å…ƒç´ ã€‚æœ€åæ‰§è¡Œçš„æ—¶å€™ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ Action é“¾è¡¨ã€‚</strong></p>
<p>å¯¹æ¯”ä»¥ä¸Šä»£ç ï¼Œè¾“å‡ºæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚</p>
<h2 id="å››ã€TaskåŸºç¡€è¯­æ³•"><a href="#å››ã€TaskåŸºç¡€è¯­æ³•" class="headerlink" title="å››ã€TaskåŸºç¡€è¯­æ³•"></a>å››ã€TaskåŸºç¡€è¯­æ³•</h2><blockquote>
<p>Task å†…éƒ¨æ˜¯å¯ä»¥ä½¿ç”¨ä»»ä½•çš„ Groovy è¯­æ³•çš„ï¼Œå…³äº Groovy è¯­æ³•ï¼Œå¯ä»¥æŸ¥çœ‹ <a href="http://www.muzileecoding.com/gradlestudy/groovy.html" target="_blank" rel="noopener">Groovy è¯­æ³•</a></p>
</blockquote>
<h3 id="4-1-ä¾èµ–"><a href="#4-1-ä¾èµ–" class="headerlink" title="4.1 ä¾èµ–"></a>4.1 ä¾èµ–</h3><p>å½“æˆ‘ä»¬å†™ä¸€ä¸ªç±»ï¼Œå¹¶åœ¨å…¶ä¸­å†™äº†è¯¸å¤šæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦ä¸€ä¸ªåœ°æ–¹ç»„åˆè¿™äº›æ–¹æ³•å®ç°ç›®æ ‡åŠŸèƒ½çš„ï¼Œè¿™å°±åƒ Java ä¸­çš„<code>main</code>å‡½æ•°ï¼Œç»™æ•´ä¸ªç¨‹åºä¸€ä¸ªå…¥å£ï¼Œä»è€Œä¾¿äºå…¶ä½™çš„ç±»å’Œæ–¹æ³•æŒ‰ç…§ä¸€å®šçš„é€»è¾‘è¿è¡Œèµ·æ¥ã€‚é‚£ä¹ˆåœ¨Gradle è„šæœ¬æ–‡ä»¶ä¸­ï¼Œæ˜¯å¦‚ä½•ç»„ç»‡è¿™äº› Task çš„è”ç³»çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <strong>ä¾èµ–</strong> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'Hello world!'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">task <span class="title">intro</span><span class="params">(dependsOn: hello)</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">"I'm Gradle"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ª Task ï¼Œå¹¶é€šè¿‡<code>dependsOn</code>å…³é”®å­—å£°æ˜<code>intro</code>ä¾èµ–<code>hello</code>ï¼Œæ‰§è¡Œä¸€ä¸‹<code>gradle -q intro</code>å‘½ä»¤ï¼Œè¾“å‡ºå¦‚ä¸‹:</p>
<pre><code>&gt; gradle -q intro
Hello world!
I&apos;m Gradle
</code></pre><p>è™½ç„¶æ‰§è¡Œçš„æ˜¯<code>intro</code>Taskï¼Œä½†æ˜¯å®é™…å…ˆæ‰§è¡Œçš„æ˜¯<code>hello</code>ï¼Œå› ä¸ºå‰è€…ä¾èµ–åè€…çš„æ‰§è¡Œã€‚ä¸‹é¢è¿™ç§æ–¹å¼å’Œä¸Šé¢ç­‰æ•ˆ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'Hello world!'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">task <span class="title">intro</span><span class="params">()</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">"I'm Gradle"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">intro.dependsOn hello</span><br></pre></td></tr></table></figure>
<p>é™¤äº†ä¾èµ–å·²çŸ¥çš„ Taskï¼Œä¾èµ–è¿˜èƒ½ä»¥å¦‚ä¸‹å½¢å¼è¿›è¡Œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">task <span class="title">taskX</span><span class="params">(dependsOn: <span class="string">'taskY'</span>)</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'taskX'</span></span><br><span class="line">&#125;</span><br><span class="line">task taskY &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'taskY'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ª Task å¯ä»¥ä¾èµ–ä¸€ä¸ªè¿˜æœªå£°æ˜çš„ Taskï¼Œåªéœ€è¦ä»¥å­—ç¬¦ä¸²å½¢å¼è¡¨ç¤º Task åå­—å³å¯ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">task compile &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'compiling source'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">task <span class="title">compileTest</span><span class="params">(dependsOn: compile)</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'compiling unit tests'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¾èµ–ä¸¤ä¸ªTask</span></span><br><span class="line"><span class="function">task <span class="title">test</span><span class="params">(dependsOn: [compile, compileTest])</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'running unit tests'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">task <span class="title">dist</span><span class="params">(dependsOn: [compile, test])</span> &lt;&lt; </span>&#123;</span><br><span class="line">    println <span class="string">'building the distribution'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ<code>gradle dist test</code>ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt; gradle dist test
:compile
compiling source
:compileTest
compiling unit tests
:test
running unit tests
:dist
building the distribution

BUILD SUCCESSFUL

Total time: 1 secs
</code></pre><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®º: <strong>æ— è®ºä¸€ä¸ªTaskåœ¨ä¸€æ¬¡æ‰§è¡Œä¸­å¦‚ä½•è¢«ä¾èµ–ï¼Œå®ƒéƒ½åªä¼šæ‰§è¡Œä¸€æ¬¡</strong> ã€‚</p>
<h3 id="4-2-åˆ›å»º"><a href="#4-2-åˆ›å»º" class="headerlink" title="4.2 åˆ›å»º"></a>4.2 åˆ›å»º</h3><p>ç›´æ¥ä½¿ç”¨<code>task</code>å…³é”®å­—å£°æ˜ä¸€ä¸ªTaskæ˜¯æœ€å¸¸è§çš„æ–¹å¼ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬è¿˜å¯ä»¥åŠ¨æ€åˆ›å»º Task ï¼Œæ¯”å¦‚åœ¨è„šæœ¬æ–‡ä»¶ä¸­å†™å…¥:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>.times &#123; counter -&gt;</span><br><span class="line">    task <span class="string">"task$counter"</span> &lt;&lt; &#123;</span><br><span class="line">        println <span class="string">"I'm task number $counter"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>gradle -q task1</code>ï¼Œå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt; gradle -q task1
I&apos;m task number 1
</code></pre><p>åŠ¨æ€ç”Ÿæˆçš„ Task ä¹Ÿèƒ½ä»¥ä¸Šé¢çš„ä»»æ„ä¸€ç§ä¾èµ–å½¢å¼è¿›è¡Œ Task ä¾èµ–å£°æ˜ã€‚</p>
<h3 id="4-3-è·å–"><a href="#4-3-è·å–" class="headerlink" title="4.3 è·å–"></a>4.3 è·å–</h3><p>è¿™ä¸ªç‚¹å…¶å®å‰é¢å·²ç»ç”¨åˆ°äº†ï¼Œå¯èƒ½å› ä¸ºæ¯”è¾ƒç¬¦åˆæ€ç»´ï¼Œå› æ­¤ä¸ä¸€å®šèƒ½æ³¨æ„åˆ°ï¼Œè¿™é‡Œç‰¹æ„æä¸€ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">task hello &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'Hello world!'</span></span><br><span class="line">&#125;</span><br><span class="line">hello.doLast &#123;</span><br><span class="line">    println <span class="string">"Greetings from the $hello.name task."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œåœ¨å¾€<code>hello</code>ä¸­æ’å…¥ Action çš„æ—¶å€™ï¼Œç›´æ¥å¯ä»¥ä½¿ç”¨<code>hello</code>å»å¼•ç”¨ Task ï¼Œå®é™…ä¸Šï¼Œæ¯ä¸€ä¸ªå£°æ˜å‡ºæ¥çš„ Task éƒ½è¢«å½“æˆ Gradle è„šæœ¬æ–‡ä»¶çš„ä¸€ä¸ªå±æ€§ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡è¿™ç§æ–¹å¼å­˜å–ï¼ˆå°±åƒç±»ä¸­å£°æ˜çš„ä¸€ä¸ªå˜é‡ï¼‰ã€‚</p>
<blockquote>
<p>è¿˜æœ‰ä¸€ç§åŠæ³•æ˜¯é€šè¿‡<code>Project.getTasks().findByPath()</code>æˆ–è€…<code>Project.getTasks().getByPath()</code>æ–¹æ³•æ‹¿ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œæ²¡æœ‰è®²åˆ° Domain Objectï¼Œå› æ­¤ç•¥è¿‡ã€‚</p>
</blockquote>
<h3 id="4-4-é¢å¤–å±æ€§"><a href="#4-4-é¢å¤–å±æ€§" class="headerlink" title="4.4 é¢å¤–å±æ€§"></a>4.4 é¢å¤–å±æ€§</h3><p>åœ¨å†™ä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šå»å£°æ˜ä¸€äº›æœ¬åœ°å˜é‡ï¼ŒTask ä¹Ÿå…·å¤‡è¿™äº›åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">task myTask &#123;</span><br><span class="line">    ext.myProperty = <span class="string">"myValue"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task printTaskProperties &lt;&lt; &#123;</span><br><span class="line">    println myTask.myProperty</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Task ä¸­å¯ä»¥å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œä¿å­˜åˆ° ext ä¸­å»ï¼Œä¹‹ååœ¨å…³äºè¿™ä¸ª Taskçš„ä»»ä½•æ“ä½œä¸­å°±éƒ½å¯ä»¥ä½¿ç”¨å®ƒäº†ï¼Œå¦‚ä¸Šï¼Œæ‰§è¡Œå‘½ä»¤<code>gradle -q printTaskProperties</code>å°±æœ‰å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt; gradle -q printTaskProperties
myValue
</code></pre><blockquote>
<p>ç»†å¿ƒçš„è¯»è€…å¯èƒ½æ¯”è¾ƒå¥‡æ€ªï¼Œè¿™é‡Œçš„<code>myTask</code>å£°æ˜æ¯”è¾ƒå¥‡æ€ªï¼Œå£°æ˜çš„æ—¶å€™æ²¡æœ‰ä½¿ç”¨<code>doLast</code>ï¼Œ<code>doFirst</code>ï¼Œ<code>&lt;&lt;</code>ä¸­çš„ä»»ä½•ä¸€ç§ï¼Œåœ¨é—­åŒ…é‡Œé¢ä¹Ÿåªæ˜¯ç®€å•çš„ä¸€è¡Œ Groovy ä»£ç ï¼Œè¿™æ˜¯ä¸€ç§ä»€ä¹ˆå£°æ˜æ–¹å¼ï¼Ÿ</p>
<p>è¿™ä¸ªå…¶å®å’Œè„šæœ¬çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³ï¼Œä¼šåœ¨<a href="http://www.muzileecoding.com/gradlestudy/gradle-lifecycle.html" target="_blank" rel="noopener">Gradle ç”Ÿå‘½å‘¨æœŸ</a>è®²è§£ï¼Œè¿™æ®µä»£ç åœ¨é…ç½®é˜¶æ®µæ‰§è¡Œã€‚è¿™é‡Œåªéœ€è¦çŸ¥é“<strong>ä»¥è¿™ç§æ–¹å¼å£°æ˜çš„ Task ä¸­çš„ä»£ç ä¼šå…ˆäºå…¶ä½™ Action æ‰§è¡Œ</strong>å°±å¥½äº†ã€‚</p>
</blockquote>
<h3 id="4-5-é»˜è®¤Task"><a href="#4-5-é»˜è®¤Task" class="headerlink" title="4.5 é»˜è®¤Task"></a>4.5 é»˜è®¤Task</h3><p>å‰é¢æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ª Task çš„æ—¶å€™ï¼Œéƒ½éœ€è¦æŒ‡å®š Task åå­—ï¼Œå…¶å® Gradle è„šæœ¬æ–‡ä»¶ä¸­æ˜¯å¯ä»¥é€šè¿‡<code>defaultTasks</code>æŒ‡å®šé»˜è®¤ Task çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">defaultTasks <span class="string">'clean'</span>, <span class="string">'run'</span></span><br><span class="line"></span><br><span class="line">task clean &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'Default Cleaning!'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task run &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">'Default Running!'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task other &lt;&lt; &#123;</span><br><span class="line">    println <span class="string">"I'm not a default task!"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨åªéœ€è¦æ‰§è¡Œ<code>gradle -q</code>å‘½ä»¤ï¼Œå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<pre><code>&gt; gradle -q
Default Cleaning!
Default Running!
</code></pre><p>è¿™ç§æƒ…å†µä¸‹æ”¹åäº†å°±ç­‰ä»·äº<code>gradle -q clean run</code>ã€‚</p>
<h2 id="äº”ã€Task-é«˜çº§è¯­æ³•"><a href="#äº”ã€Task-é«˜çº§è¯­æ³•" class="headerlink" title="äº”ã€Task é«˜çº§è¯­æ³•"></a>äº”ã€Task é«˜çº§è¯­æ³•</h2><p>å®˜æ–¹æ–‡æ¡£ä¸­æœ‰ä¸€ç« æ˜¯ä¸“é—¨ä¸ºæ·±å…¥ Task åšè®²è§£çš„: <a href="https://docs.gradle.org/current/userguide/more_about_tasks.html" target="_blank" rel="noopener">More about Tasks</a>ã€‚è¿™é‡Œå› ä¸ºæ²¡æœ‰è®²åˆ° DOï¼Œä¸èƒ½å¾ˆå¥½çš„è§£é‡Šä¸€äº›æ¦‚å¿µï¼Œè¿™é‡Œå°±ç•¥è¿‡äº†ï¼Œç­‰è®²å®Œ<a href="http://www.muzileecoding.com/gradlestudy/gradle-advaced-do.html" target="_blank" rel="noopener">Gradle DOæ¨¡å‹</a>è¯»è€…å¯ä»¥è‡ªè¡Œå­¦ä¹ è¿™ä¸€ç« èŠ‚ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—ä¸€ï¼šGroovyè¯­æ³•]]></title>
      <url>http://www.timebridge.space/2016/05/18/groovy/</url>
      <content type="html"><![CDATA[<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/groovy-icon.png" height="250" alt="One Piece"></div>

<h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><p><a href="http://www.groovy-lang.org/" target="_blank" rel="noopener">Groovy</a> æ˜¯ Java å¹³å°ä¸Šè®¾è®¡çš„é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ã€‚å®ƒæ‹¥æœ‰ç±»ä¼¼ Pythonã€Ruby å’Œ Smalltalk çš„ä¸€äº›ç‰¹æ€§ï¼Œå¯ä»¥ä½œä¸º Java å¹³å°çš„è„šæœ¬è¯­è¨€ä½¿ç”¨ã€‚<a id="more"></a></p>
<p>Groovy çš„è¯­æ³•ä¸ Java éå¸¸ç›¸ä¼¼ï¼Œå¤šæ•°çš„ Java ä»£ç åŒæ—¶ä¹Ÿæ˜¯æ­£ç¡®çš„ Groovy ä»£ç ï¼Œä¸¤è€…å¯ä»¥æ··ç¼–ï¼Œ<strong>Groovy ä»£ç æœ€ç»ˆè¿˜æ˜¯ä¼šè¢«ç¼–è¯‘ä¸ºå­—èŠ‚ç è¿è¡Œåœ¨ JVM ä¸Š</strong>ã€‚å®ƒä¸ Java çš„å…³ç³»å¯ä»¥æè¿°å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/groovy&java.png" height="160" alt="Groovyå’ŒJavaçš„å…³ç³»"></div>

<p>ç®€è€Œè¨€ä¹‹ï¼Œ<strong>ä¸¤è€…æ˜¯äº’è¡¥çš„è€Œéæ›¿ä»£çš„</strong>ã€‚</p>
<h2 id="äºŒã€ç»„æˆ"><a href="#äºŒã€ç»„æˆ" class="headerlink" title="äºŒã€ç»„æˆ"></a>äºŒã€ç»„æˆ</h2><div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Groovyç»„æˆ.png" alt="Groovyç»„æˆ"></div>

<p>å¦‚å›¾ï¼Œæ˜¯ Groovy è¯­è¨€ä¸»è¦çš„ç»„æˆéƒ¨åˆ†:</p>
<ol>
<li><strong>GDK</strong>  ä¸»è¦æ˜¯é’ˆå¯¹ Java åŸæœ‰çš„åº“çš„åŠŸèƒ½æ‰©å……ï¼Œæ˜¯çš„ä¸€äº›æ“ä½œæ›´åŠ çš„æ–¹ä¾¿ï¼›</li>
<li><strong>Library</strong>  æ‰©å±•åŠŸèƒ½ï¼Œä¸ºå¸¸ç”¨åŠŸèƒ½å¼€å‘äº†ä¸€ç»„å·¥å…·ç±»ï¼Œæ¯”å¦‚è¯»å–XMLï¼ŒSQLæŸ¥è¯¢ç­‰ï¼›</li>
<li><strong>Language</strong>  æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œä¼˜åŒ–äº† Java åŸæœ‰çš„è¯­æ³•ï¼Œæ¯”å¦‚<code>switch</code>å¯ä»¥è¿ç”¨åœ¨ä»»ä½•ç±»å‹çš„å¯¹è±¡ä¸Šï¼›æ·»åŠ æ–°å‹çš„è¯­æ³•å†…å®¹ï¼Œæ¯”å¦‚é—­åŒ…ï¼›</li>
</ol>
<h2 id="ä¸‰ã€ç¯å¢ƒæ­å»º"><a href="#ä¸‰ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸‰ã€ç¯å¢ƒæ­å»º"></a>ä¸‰ã€ç¯å¢ƒæ­å»º</h2><p>å…³äºç¯å¢ƒæ­å»ºï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="http://www.muzileecoding.com/groovy/Groovy-install-and-ide-plugin.html" target="_blank" rel="noopener">Groovyå®‰è£…å’ŒEclipseæ’ä»¶å®‰è£…</a>ã€‚</p>
<h2 id="å››ã€å¸¸è§è¯­æ³•"><a href="#å››ã€å¸¸è§è¯­æ³•" class="headerlink" title="å››ã€å¸¸è§è¯­æ³•"></a>å››ã€å¸¸è§è¯­æ³•</h2><p><strong>ã€çº¦å®šã€‘</strong> ä»¥ä¸‹ç¤ºä¾‹ä¸­ç»™å‡ºçš„<code>assert</code>è¯­å¥å…¨éƒ¨éƒ½ä¸º trueã€‚</p>
<h3 id="4-1-ç±»å£°æ˜"><a href="#4-1-ç±»å£°æ˜" class="headerlink" title="4.1 ç±»å£°æ˜"></a>4.1 ç±»å£°æ˜</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String title</span><br><span class="line">	</span><br><span class="line">	Book (String theTitle)&#123;</span><br><span class="line">     	title = theTitle</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getTitle</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> title</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å’Œ Java å¾ˆåƒï¼Œåªæ˜¯è¯­å¥åé¢ä¸éœ€è¦å†æ·»åŠ åˆ†å·ã€‚</p>
<h3 id="4-2-æ–¹æ³•å’Œå˜é‡"><a href="#4-2-æ–¹æ³•å’Œå˜é‡" class="headerlink" title="4.2 æ–¹æ³•å’Œå˜é‡"></a>4.2 æ–¹æ³•å’Œå˜é‡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Book gina = <span class="keyword">new</span> Book(<span class="string">'Groovy Study'</span>)</span><br><span class="line">def hello = <span class="string">'Hello, '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> gina.getTitle() == <span class="string">'Groovy Study'</span></span><br><span class="line"><span class="keyword">assert</span> hello + getTitleBackwards(gina) == <span class="string">'Hello, ydutS yvoorG'</span></span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="title">getTitleBackwards</span><span class="params">(book)</span></span>&#123;</span><br><span class="line">	String title = book.getTitle()</span><br><span class="line">	title.reverse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–¹æ³•è°ƒç”¨å½¢å¼</span></span><br><span class="line">println (<span class="string">'Groovy is great!'</span>)</span><br><span class="line">println <span class="string">'Groovy is great'</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ç±»çš„åˆå§‹åŒ–å’Œ Java å¹¶æ— ä¸åŒ(å…ˆå¿½ç•¥ String ï¼Œåé¢ç»†è¯´)ï¼Œå’Œ Java ä¸ä¸€æ ·çš„æ˜¯ï¼Œå®šä¹‰/å£°æ˜å˜é‡å’Œæ–¹æ³•ä½¿ç”¨<code>def</code>å…³é”®å­—ï¼Œä¸éœ€è¦å†æŒ‡æ˜ç±»å‹äº†ã€‚</p>
<h3 id="4-3-GroovyBean"><a href="#4-3-GroovyBean" class="headerlink" title="4.3 GroovyBean"></a>4.3 GroovyBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookBean</span></span>&#123;</span><br><span class="line">	String title</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def groovyBook = <span class="keyword">new</span> BookBean()</span><br><span class="line"></span><br><span class="line">groovyBook.setTitle(<span class="string">'Groovy conquers the world'</span>)</span><br><span class="line"><span class="keyword">assert</span> groovyBook.getTitle() == <span class="string">'Groovy conquers the world'</span></span><br></pre></td></tr></table></figure>
<p>Groovy ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ  getter å’Œ setter ï¼Œä¼šä¸ºç±»è‡ªåŠ¨ç”Ÿæˆ â€”â€” å£°æ˜ Bean æˆä¸ºä¸€ä»¶ç®€å•æ¸…çˆ½çš„äº‹æƒ…ã€‚</p>
<h3 id="4-4-GString"><a href="#4-4-GString" class="headerlink" title="4.4 GString"></a>4.4 GString</h3><p><strong>è¿™ä¸ªæ˜¯é‡ç‚¹ï¼ï¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def nick = <span class="string">'ReGina'</span></span><br><span class="line">def book = <span class="string">'Groovy Study'</span></span><br><span class="line"><span class="keyword">assert</span> <span class="string">"$nick is $book"</span> == <span class="string">'ReGina is Groovy Study'</span></span><br><span class="line"></span><br><span class="line">def language = <span class="string">'groovy'</span></span><br><span class="line">def improvedSentence = <span class="string">"$&#123;language.capitalize()&#125; is awesome!â€</span></span><br><span class="line"><span class="string">assert improvedSentence == 'Groovy is awesome!'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">assert "</span>abc<span class="string">" - "</span>a<span class="string">" == "</span>bc<span class="string">"</span></span><br></pre></td></tr></table></figure>
<p>String çš„å®šä¹‰æ—¢å¯ä»¥ä½¿ç”¨å•å¼•å·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒå¼•å·ï¼Œæ“ä½œä¹Ÿå˜å¾—æ›´åŠ ä¸°å¯Œï¼šæ·»åŠ äº†å˜é‡æ›¿æ¢ã€æ–¹æ³•è°ƒç”¨ï¼ˆå€¼è®¡ç®—ï¼‰ã€åŠ å‡æ“ä½œç­‰å¼ºå¤§å½¢è±¡çš„åŠŸèƒ½ã€‚</p>
<p>å…¶å® Groovy ä¸­çš„ String ä¸æ­¢ä»¥ä¸Šä¸¤ç§å½¢å¼ï¼Œä»¥ä¸‹æ˜¯æ±‡æ€»è¡¨æ ¼:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/groovy-string.png" alt="Groovyå­—ç¬¦ä¸²å½¢å¼"></div>

<p>å¦‚å›¾ï¼Œé™¤äº†å•å¼•å·ï¼ŒåŒå¼•å·ï¼Œè¿˜æœ‰ä¸‰ä¸ªå•å¼•å·ï¼Œä¸‰ä¸ªåŒå¼•å·çš„å½¢å¼ï¼Œä¸‰ä¸ªå¼•å·æ˜¯ç”¨äºå¤šè¡Œå±•ç¤ºçš„ï¼Œæ¯”Javaè¦æ–¹ä¾¿å¾ˆå¤šã€‚å…¶ä¸­<code>Placeholder resolved</code>è¡¨ç¤ºæ˜¯å¦æ”¯æŒå˜é‡è®¡ç®—æ›¿æ¢ï¼Œ<code>Backslash escape</code>è¡¨ç¤ºæ˜¯å¦æ”¯æŒè½¬ä¹‰ã€‚</p>
<h3 id="4-5-Number"><a href="#4-5-Number" class="headerlink" title="4.5 Number"></a>4.5 Number</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def x = <span class="number">1</span></span><br><span class="line">def y = <span class="number">2</span></span><br><span class="line"><span class="keyword">assert</span> x + y == <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> x.plus(y) == <span class="number">3</span></span><br><span class="line"><span class="keyword">assert</span> x <span class="keyword">instanceof</span> Integer</span><br></pre></td></tr></table></figure>
<p>æ•°å­—é™¤äº†ç›¸åŠ ï¼Œè¿˜èƒ½è°ƒç”¨æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸º<strong>åœ¨ Groovy ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼Œæ²¡æœ‰åŸºæœ¬ç±»å‹</strong>ï¼ŒåŸºæœ¬ç±»å‹éƒ½ä¼šå‡çº§æˆåŒ…è£…ç±»å‹è¿è¡Œã€‚</p>
<h3 id="4-6-Range"><a href="#4-6-Range" class="headerlink" title="4.6 Range"></a>4.6 Range</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def x = <span class="number">1</span>..<span class="number">10</span></span><br><span class="line"><span class="keyword">assert</span> x.contains(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">assert</span> x.contains(<span class="number">15</span>) == <span class="keyword">false</span></span><br><span class="line"><span class="keyword">assert</span> x.size() == <span class="number">10</span></span><br><span class="line"><span class="keyword">assert</span> x.from == <span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> x.to == <span class="number">10</span></span><br><span class="line"><span class="keyword">assert</span> x.reverse() == <span class="number">10</span>..<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªæ–°çš„ç±»ï¼Œç”¨äºè¡¨è¾¾ä¸€ä¸ªèŒƒå›´ã€‚å®ƒå…·å¤‡å¾ˆå¤šç¥å¥‡çš„åŠŸèƒ½ï¼Œä¸‹é¢çš„ä¸€äº›ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°å®ƒçš„ä¸€äº›ç”¨æ³•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<a href="http://www.groovy-lang.org/documentation.html" target="_blank" rel="noopener">å®˜æ–¹Doc</a>ã€</p>
<h3 id="4-7-List"><a href="#4-7-List" class="headerlink" title="4.7 List"></a>4.7 List</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">def num = [<span class="string">'ä¸€'</span>, <span class="string">'äºŒ'</span>, <span class="string">'ä¸‰'</span>, <span class="string">'å››'</span>, <span class="string">'äº”'</span>, <span class="string">'å…­'</span>, <span class="string">'ä¸ƒ'</span>, <span class="string">'å…«'</span>, <span class="string">'ä¹'</span>, <span class="string">'å'</span>]</span><br><span class="line"><span class="keyword">assert</span> num[<span class="number">4</span>] == <span class="string">'äº”'</span></span><br><span class="line"></span><br><span class="line">num[<span class="number">10</span>] = <span class="string">'åä¸€'</span></span><br><span class="line"><span class="keyword">assert</span> num.size() == <span class="number">11</span></span><br><span class="line"></span><br><span class="line">def list = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">list.each() &#123; item -&gt;</span><br><span class="line">	<span class="keyword">assert</span> item == list[item]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List list2 = [<span class="number">1</span>, <span class="number">2</span>, *list, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="keyword">assert</span> list2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">def myList = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> myList[<span class="number">0</span>..<span class="number">2</span>] == [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="keyword">assert</span> myList[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>] == [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'e'</span>]</span><br><span class="line"></span><br><span class="line">myList[<span class="number">0</span>..<span class="number">2</span>] = [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line"><span class="keyword">assert</span> myList == [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>]</span><br><span class="line"></span><br><span class="line">myList[<span class="number">3</span>..<span class="number">5</span>] = []</span><br><span class="line"><span class="keyword">assert</span> myList == [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line"></span><br><span class="line">myList[<span class="number">1</span>..<span class="number">1</span>] = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="keyword">assert</span> myList == [<span class="string">'x'</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="string">'z'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> myList[-<span class="number">1</span>] == <span class="string">'z'</span></span><br><span class="line"></span><br><span class="line">List myList = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'x'</span>, <span class="string">'c'</span>].grep(myList) == <span class="string">'a'</span></span><br><span class="line"></span><br><span class="line">def kings = [<span class="string">'Dierk'</span>, <span class="string">'Paul'</span>]</span><br><span class="line">kings = kings.sort&#123; item -&gt; </span><br><span class="line">	item.size()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> kings = [<span class="string">'Paul'</span>, <span class="string">'Dierk'</span>]</span><br><span class="line"></span><br><span class="line">def odd = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].findAll &#123;item -&gt;</span><br><span class="line">	item % <span class="number">2</span> == <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> odd == [<span class="number">1</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p>List æ˜¯æˆ‘ä»¬é¦–å…ˆä»‹ç»çš„ä¸€ä¸ªé›†åˆ ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„å£°æ˜ã€ä½¿ç”¨æ–¹å¼å’Œæˆ‘ä»¬ç†Ÿæ‚‰çš„æ•°ç»„éå¸¸ç±»ä¼¼ï¼Œé…åˆ range ä½¿ç”¨ï¼Œæ›´åŠ ç‚«é…·å™¢(çœ‹ä¸æ‡‚çš„åœ°æ–¹è¯­æ³•å¯ä»¥åé¢å†çœ‹)ï¼</p>
<p>è¿™æ˜¯ GDK å¯¹ Java å¢å¼ºçš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚</p>
<h3 id="4-8-Map"><a href="#4-8-Map" class="headerlink" title="4.8 Map"></a>4.8 Map</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def http = [</span><br><span class="line">	<span class="number">100</span> : <span class="string">'CONTINUE'</span>,</span><br><span class="line">	<span class="number">200</span> : <span class="string">'OK'</span>,</span><br><span class="line">	<span class="number">400</span> : <span class="string">'BAD REQUEST'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> http[<span class="number">200</span>] == <span class="string">'OK'</span></span><br><span class="line"><span class="keyword">assert</span> http.200 == <span class="string">'OK'</span></span><br><span class="line">http[<span class="number">500</span>] = <span class="string">'INTERNAL SERVER ERROR'</span></span><br><span class="line"><span class="keyword">assert</span> http.size() == <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå±•ç¤ºçš„æ˜¯ Map çš„å¢å¼ºä½¿ç”¨ï¼Œéå¸¸ç¬¦åˆäººçš„ç›´è§‰æ€ç»´ï¼Œæ¯” Java çš„é˜…è¯»æ€§ä¹Ÿæ›´é«˜ã€‚</p>
<h3 id="4-9-Control-Structure"><a href="#4-9-Control-Structure" class="headerlink" title="4.9 Control Structure"></a>4.9 Control Structure</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(index in <span class="number">1</span>..<span class="number">10</span>)&#123;</span><br><span class="line">	println index</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def list = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="keyword">for</span>(index in list)&#123;</span><br><span class="line">	println index</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def age = <span class="number">36</span></span><br><span class="line"><span class="keyword">switch</span>(age)&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">16</span>..<span class="number">20</span> : <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">21</span>..<span class="number">50</span> : <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶ç»“æ„ä¹Ÿå¾—åˆ°è¿›ä¸€æ­¥å¢å¼ºï¼Œæ¯”å¦‚ä¾‹å­ä¸­ï¼Œfor å¯ä»¥ä¸ range é…åˆä½¿ç”¨ï¼Œ<code>switch...case...</code>ä¹Ÿå¯ä»¥å’Œ range ç»“åˆã€‚</p>
<h3 id="4-10-Other"><a href="#4-10-Other" class="headerlink" title="4.10 Other"></a>4.10 Other</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span> code = <span class="string">'1 + 49.0'</span></span><br><span class="line"><span class="keyword">assert</span> <span class="number">50.0</span> == evaluate(code)</span><br><span class="line"></span><br><span class="line">value ?: <span class="keyword">default</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>(candidate)&#123;</span><br><span class="line">	<span class="keyword">case</span> classifier1: handle1() ; <span class="keyword">break</span>;</span><br><span class="line">c	ase classifier2: handle2() ; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™äº›æ˜¯ä¸€äº›é¢å¤–çš„ä¾‹å­ï¼Œæ¯”å¦‚è®¡ç®—è¡¨è¾¾å¼çš„å€¼ï¼Œä¸‰ç›®æ“ä½œç¬¦çš„ç®€åŒ–ï¼ˆç©ºåˆ™ç”¨ default å€¼ï¼‰ï¼Œä¸»è¦ç›®çš„æ˜¯å±•ç°ä¸€ä¸‹ Groovy æ‰€åšçš„ä¼˜åŒ–ä»¥åŠä¸€äº›â€å¥‡æŠ€æ·«å·§â€ã€‚</p>
<h3 id="4-11-æ€»ç»“"><a href="#4-11-æ€»ç»“" class="headerlink" title="4.11 æ€»ç»“"></a>4.11 æ€»ç»“</h3><p>Groovy å¯¹åŸ Java çš„è¯­æ³•ä»¥åŠé›†åˆç­‰åšäº†å¤§é‡çš„æ‰©å……ï¼Œä¸ä½†å¢å¼ºäº†åŸæœ‰åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ å¿«é€Ÿè‡ªç„¶ï¼Œä¹Ÿæ·»åŠ æ–°çš„è¯­æ³•ï¼Œä½¿å¾—è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›æ›´å¼ºã€‚</p>
<p>ä¸Šé¢çš„ä¾‹å­å¹¶ä¸ç³»ç»Ÿï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è®©è¯»è€…å¯¹ Groovy è¿™é—¨è¯­è¨€æœ‰å¤§æ¦‚çš„è®¤çŸ¥ã€‚ç³»ç»Ÿå­¦ä¹ çš„è¯è¿˜æ˜¯å»ºè®®çœ‹<a href="http://www.groovy-lang.org/documentation.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h2 id="äº”ã€Closure"><a href="#äº”ã€Closure" class="headerlink" title="äº”ã€Closure"></a>äº”ã€Closure</h2><p>æœ¬èŠ‚æ‰€è¦ä»‹ç»çš„ <strong>Closure(é—­åŒ…)</strong> æ˜¯è¯­æ³•çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå› ä¸ºéå¸¸é‡è¦ï¼Œå› æ­¤å•ç‹¬æ‹‰å‡ºæ¥ä½œä¸ºä¸€èŠ‚é˜è¿°ã€‚</p>
<blockquote>
<p>è¦å­¦ä¹  Gradleï¼Œé—­åŒ…çš„æ¦‚å¿µå¿…é¡»ç†è§£ã€‚</p>
</blockquote>
<h3 id="5-1-Closureæ˜¯ä»€ä¹ˆ-ï¼Ÿ"><a href="#5-1-Closureæ˜¯ä»€ä¹ˆ-ï¼Ÿ" class="headerlink" title="5.1 Closureæ˜¯ä»€ä¹ˆ ï¼Ÿ"></a>5.1 Closureæ˜¯ä»€ä¹ˆ ï¼Ÿ</h3><p>å¯¹äº Java ç¨‹åºå‘˜æ¥è¯´ï¼ŒClosure æ˜¯ä¸€ä¸ªæ¯”è¾ƒé™Œç”Ÿçš„æ¦‚å¿µ: </p>
<ol>
<li>A closure is a piece of code wrapped up as an object. </li>
<li>It acts like a method in that it can take parameters and it can return a value. </li>
<li>Itâ€™s a normal object in that you can pass a reference to it around just as you can a reference to any other object. </li>
</ol>
<p>è¿™å°±æ˜¯ Closureï¼Œä¸­æ–‡ç§°ä¸ºé—­åŒ…ã€‚ä»æ¦‚å¿µä¸Šç±»æ¯”ä¸€ä¸‹ï¼Œé—­åŒ…å°±æ˜¯ C++ ä¸­çš„å‡½æ•°ï¼ˆå¯ä»¥é€šè¿‡å‡½æ•°æŒ‡é’ˆå¼•ç”¨ï¼‰ï¼ŒOC ä¸­çš„ Blockï¼ŒJavaScript ä¸­çš„ Closureã€‚</p>
<p>é€šä¿—çš„è¯´ï¼š<strong>é—­åŒ…å°±æ˜¯ä¸€æ®µä»£ç ï¼Œå¯ä»¥æ¥å—å‚æ•°ï¼Œå¯ä»¥åœ¨ç¨‹åºä¸­åƒå˜é‡ä¸€æ ·ä¼ é€’ã€‚</strong></p>
<h3 id="5-2-å£°æ˜å’Œä½¿ç”¨"><a href="#5-2-å£°æ˜å’Œä½¿ç”¨" class="headerlink" title="5.2 å£°æ˜å’Œä½¿ç”¨"></a>5.2 å£°æ˜å’Œä½¿ç”¨</h3><p>å…ˆæ¥ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Closure printer = &#123;line -&gt; println line&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªç®€å•çš„é—­åŒ…å£°æ˜ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‚æ•° lineã€‚ä½¿ç”¨ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Closure printer = &#123;line -&gt; println line&#125;</span><br><span class="line">printer(<span class="string">"Hello world"</span>)</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œå°±å¯ä»¥çœ‹åˆ°å‘½ä»¤è¡Œä¸­æ‰“å°å‡º â€œHello worldâ€ã€‚å¯ä»¥çœ‹åˆ°é—­åŒ…çš„ä½¿ç”¨å’Œæ–¹æ³•è°ƒç”¨æå…¶ç±»ä¼¼ã€‚ä¸‹é¢æ¥å±•ç¤ºæ›´å¤šçš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def adder = &#123;x, y -&gt; <span class="keyword">return</span> x+y&#125; <span class="comment">//é—­åŒ…adder</span></span><br><span class="line"><span class="function"><span class="keyword">assert</span> <span class="title">adder</span><span class="params">(<span class="number">4</span>, <span class="number">3</span>)</span> </span>== <span class="number">7</span></span><br><span class="line"><span class="keyword">assert</span> adder.call(<span class="number">2</span>,<span class="number">6</span>) == <span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>ä¸€ç›®äº†ç„¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">benchmark</span><span class="params">(<span class="keyword">int</span> repeat, Closure worker)</span> </span>&#123;</span><br><span class="line">	def start = System.nanoTime()</span><br><span class="line">	repeat.times&#123; worker(it) &#125;</span><br><span class="line"></span><br><span class="line">	def stop = System.nanoTime()</span><br><span class="line">	<span class="keyword">return</span> stop - start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def slow = benchmark(<span class="number">10000</span>,  &#123;(<span class="keyword">int</span>)it/<span class="number">2</span>&#125;)</span><br><span class="line">def fast = benchmark(<span class="number">10000</span>) &#123;it.intdiv(<span class="number">2</span>)&#125;</span><br><span class="line"><span class="keyword">assert</span> fast * <span class="number">15</span> &lt; slow</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¾‹å­æ¯”è¾ƒå¤æ‚ä¸€äº›:</p>
<ol>
<li>é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•<code>benchmark</code>ï¼Œå®ƒæ¥å—ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°ï¼›</li>
<li>è°ƒç”¨çš„æ—¶å€™ç›´æ¥ä¼ é€’è¿›å»ä¸¤ä¸ªé—­åŒ…: <code>{(int)it/2}</code>å’Œ<code>{it.intdiv(2)}</code>ï¼›</li>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œé€šè¿‡<code>worker(it)</code>çš„æ–¹å¼è°ƒç”¨é—­åŒ…ï¼›</li>
</ol>
<h3 id="5-3-é—­åŒ…è¦ç‚¹"><a href="#5-3-é—­åŒ…è¦ç‚¹" class="headerlink" title="5.3 é—­åŒ…è¦ç‚¹"></a>5.3 é—­åŒ…è¦ç‚¹</h3><p>å…³äºé—­åŒ…ï¼Œè¿˜æœ‰å‡ ä¸ªè¦ç‚¹æ˜¯å¿…é¡»è¦äº†è§£çš„ï¼š</p>
<ol>
<li>å½“çœ‹åˆ° {} çš„æ—¶å€™ï¼Œåº”å½“è®¤ä¸ºç­‰åŒäº:new Closure(){}ï¼›</li>
<li>ä»»ä½•ä¸€ä¸ª closure éƒ½æœ‰ä¸€ä¸ªé»˜è®¤çš„å‚æ•°ï¼šitï¼Œå®ƒæŒ‡å‘ä¼ é€’ç»™ closure çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’å‚æ•°ï¼Œåˆ™ it ä¸º nullï¼›</li>
<li>closure æ€»æ˜¯æœ‰è¿”å›å€¼ï¼Œå¦‚æœæ²¡æœ‰å†™ returnï¼Œåˆ™è¿”å›æœ€åä¸€è¡Œä»£ç çš„å·¦å€¼ï¼›å¦‚æœæ²¡æœ‰å€¼ï¼Œåˆ™æ˜¯ nullï¼›</li>
</ol>
<p>ä¸‹é¢ç»™ä¸€ä¸ªä¾‹å­è§£é‡Šä¸€ä¸‹ç¬¬äºŒç‚¹å’Œç¬¬ä¸‰ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰é—­åŒ…ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°it</span></span><br><span class="line">def odd = &#123; it % <span class="number">2</span> == <span class="number">1</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†Listä¸­çš„æ•°ä¼ é€’è¿›å…¥é—­åŒ…ï¼Œå¦‚æœé—­åŒ…è¿”å›trueï¼Œåˆ™æ”¾åˆ°ç»“æœListä¸­å»</span></span><br><span class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].grep(odd) == [<span class="number">1</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†switchçš„å‚æ•°ä¼ ç»™é—­åŒ…ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™æ‰§è¡Œcase</span></span><br><span class="line"><span class="keyword">switch</span>(<span class="number">10</span>)&#123;</span><br><span class="line">	<span class="keyword">case</span> odd : <span class="keyword">assert</span> <span class="keyword">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="number">2</span> in odd)</span><br><span class="line">	<span class="keyword">assert</span> <span class="keyword">false</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¾‹å­å±•ç¤ºçš„ç”¨æ³•æ¯”è¾ƒåï¼Œä½†æ­£å±•ç¤ºäº† Groovy çš„å¼ºå¤§åŠŸèƒ½ï¼Œå…¶ä¸­é—­åŒ… odd çš„è¿”å›å€¼å°±æ˜¯<code>it % 2 == 1</code>ã€‚</p>
<h3 id="5-4-ä¸æ–¹æ³•çš„å…³ç³»"><a href="#5-4-ä¸æ–¹æ³•çš„å…³ç³»" class="headerlink" title="5.4 ä¸æ–¹æ³•çš„å…³ç³»"></a>5.4 ä¸æ–¹æ³•çš„å…³ç³»</h3><p>Closure ç¡®å®æ˜¯ä¸€ç§æ–°çš„è¯­æ³•æœºåˆ¶ï¼Œä½†æ˜¯ Groovy æä¾›äº†ä¸€ç§åŠæ³•ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ–¹æ³•è½¬æ¢æˆé—­åŒ…:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/grrovy-closure&method.png" height="188" alt="Groovyæ–¹æ³•è½¬æ¢æˆé—­åŒ…"></div>

<p>å…¶ä¸­<code>receiver</code>ä»£è¡¨çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼Œ<code>.&amp;</code>æ˜¯å›ºå®šæ ¼å¼ï¼Œ<code>someMethod</code>æ˜¯å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•åã€‚æ¥çœ‹ä¸ªä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiMethodSample</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">mysteryMethod</span> <span class="params">(String value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span>  value.length()</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">mysteryMethod</span><span class="params">(List list)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> list.size()</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">mysteryMethod</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> x + y;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MultiMethodSample instance = <span class="keyword">new</span> MultiMethodSample()</span><br><span class="line">Closure multi = instance.&amp;mysteryMethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="number">10</span> == multi (<span class="string">'string arg'</span>) </span><br><span class="line"><span class="keyword">assert</span> <span class="number">3</span> = multi ([<span class="string">'list'</span>, <span class="string">'of'</span>, <span class="string">'values'</span>])</span><br><span class="line"><span class="keyword">assert</span> <span class="number">14</span> = multi (<span class="number">6</span>, <span class="number">8</span>)</span><br></pre></td></tr></table></figure>
<p>å¦‚å›¾ï¼Œé€šè¿‡<code>instance.&amp;mysteryMethod</code>å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ªé—­åŒ…ï¼Œè¿™ä¸ªé—­åŒ…ä¸ä¸€èˆ¬å®šä¹‰çš„è¿˜ä¸åŒï¼Œå®ƒå¯ä»¥æ ¹æ®å‚æ•°çš„ä¸åŒæ‰§è¡Œåˆ°ä¸åŒçš„æ–¹æ³•ï¼Œä¿ç•™äº†æ–¹æ³•çš„é‡è½½æœºåˆ¶ â€”â€” ä»è¿™ä¸ªè§’åº¦è¯´ï¼š<strong>é—­åŒ…å’Œæ–¹æ³•æœ¬è´¨ä¸Šå°±æ˜¯ä¸€æ ·çš„</strong>ã€‚</p>
<h3 id="5-5-Scope"><a href="#5-5-Scope" class="headerlink" title="5.5 Scope"></a>5.5 Scope</h3><p>è¿™é‡Œè¦è®²ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿: <strong>Scope</strong>ï¼Œä»€ä¹ˆæ˜¯ Scope å‘¢ï¼Ÿ</p>
<blockquote>
<p>The environment available inside a closure is called its <strong>scope</strong>.</p>
</blockquote>
<p>å…·ä½“æ¥è¯´ï¼ŒScope å°±æ˜¯è€ƒå¯Ÿ:</p>
<ol>
<li>thisæŒ‡å‘ä»€ä¹ˆï¼Ÿ</li>
<li>å¯ä»¥è·å–å“ªäº›å¤–éƒ¨å˜é‡å’Œæ–¹æ³•? </li>
</ol>
<h4 id="5-5-1-thisæŒ‡é’ˆ"><a href="#5-5-1-thisæŒ‡é’ˆ" class="headerlink" title="5.5.1 thisæŒ‡é’ˆ"></a>5.5.1 <code>this</code>æŒ‡é’ˆ</h4><p>æ¥çœ‹ä¸ªä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def x = <span class="number">0</span></span><br><span class="line"><span class="number">10</span>.times &#123;</span><br><span class="line">	x ++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> x == <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p><code>times</code>æ–¹æ³•æœ¬èº«å¹¶ä¸çŸ¥é“ x çš„å­˜åœ¨ï¼Œä½† Closure å´å¯ä»¥å¯¹<code>x</code>è¿›è¡Œè¯»å†™ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œåˆè¦å¼•å…¥ä¸€ä¸ªæ–°çš„æ¦‚å¿µ <strong>Birthday Context</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The closure somehow remembers the context at the point of its declaration and carries it along throughout its lifetime. That way, it can work on that original context whenever the situation calls <span class="keyword">for</span> it. This is called the __birthday context__ of the closures.</span><br></pre></td></tr></table></figure>
<p>å³ï¼šé—­åŒ…ä¼šâ€è®°ä½â€å®ƒå£°æ˜çš„æ—¶å€™çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œåœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸæœŸé—´å†…ä¸€ç›´å¼•ç”¨ç€è¿™ä¸ªç¯å¢ƒï¼Œè¿™æ ·ï¼Œé—­åŒ…å°±èƒ½éšæ—¶æ“ä½œåŸæ¥çš„ç¯å¢ƒ(åŒ…æ‹¬å˜é‡)ï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒå°±ç§°ä¸ºé—­åŒ…çš„ <strong>Birthday Context</strong> ã€‚</p>
<p>è¿˜æ˜¯ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºå‚è€ƒï¼Œå¼•ç”¨å…³ç³»å¦‚ä¸‹:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/é—­åŒ…birthday-context.png" height="150" alt="Groovyçš„Birthday Contextå¼•ç”¨å…³ç³»"></div>

<p>å¦‚å›¾ï¼ŒScript å°±æ˜¯ä»£è¡¨è„šæœ¬æ–‡ä»¶æœ¬èº«ï¼Œ<code>x</code>å°±æ˜¯å£°æ˜åœ¨è„šæœ¬æ–‡ä»¶ä¸­çš„ï¼ŒåŒæ—¶è„šæœ¬æ–‡ä»¶ä¸­æœ‰å£°æ˜äº†é—­åŒ…<code>{x++}</code>ï¼Œè¿™ä¸ªé—­åŒ…å°±æŒæœ‰å¯¹å¤–éƒ¨ç¯å¢ƒçš„å¼•ç”¨ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°å°±æ˜¯<code>x</code>ï¼Œå½“æŠŠé—­åŒ…ä¼ ç»™<code>times</code>å‡½æ•°çš„æ—¶å€™ï¼Œé—­åŒ…ä¾ç„¶å¯ä»¥è·å¾—<code>x</code>çš„å¼•ç”¨ã€‚</p>
<p>åœ¨ Java ä¸­ï¼Œåœ¨ä¸€ä¸ªæ–¹æ³•ä¸­è°ƒç”¨<code>this</code>æŒ‡å‘çš„æ˜¯å½“å‰å¯¹è±¡æœ¬èº«ï¼Œé‚£ä¹ˆåœ¨é—­åŒ…ä¸­ä½¿ç”¨<code>this</code>ä¹Ÿæ˜¯æŒ‡å‘å½“å‰å¯¹è±¡ä¹ˆï¼Ÿéä¹Ÿ:</p>
<blockquote>
<p>its owner: the object in whose scope the closure was declared.</p>
</blockquote>
<p><strong>é—­åŒ…ä¸­çš„<code>this</code>æŒ‡å‘çš„æ˜¯å®ƒçš„ ownerï¼Œå³åˆ›å»ºå®ƒçš„å¯¹è±¡</strong>ã€‚è¿˜æ˜¯æ¥çœ‹ä¸ªä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mother</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> field = <span class="number">1</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">method</span> <span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span> &#125;</span><br><span class="line">	<span class="function">Closure <span class="title">birth</span><span class="params">(param)</span></span>&#123;</span><br><span class="line">		def local = <span class="number">3</span></span><br><span class="line">		def closure = &#123;caller -&gt;</span><br><span class="line">     		[ self : <span class="keyword">this</span>, field:field, method: method(),</span><br><span class="line">     		local : local, param : param, caller : caller,</span><br><span class="line">     		owner : owner,  delegate: delegate</span><br><span class="line">     		]</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> closure</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Mother julia = <span class="keyword">new</span> Mother()</span><br><span class="line">def closure = julia.birth(<span class="number">4</span>)</span><br><span class="line">def context = closure.call(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> context.self == julia</span><br><span class="line"><span class="keyword">assert</span> context.field == <span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> context.method == <span class="number">2</span></span><br><span class="line"><span class="keyword">assert</span> context.local == <span class="number">3</span></span><br><span class="line"><span class="keyword">assert</span> context.param == <span class="number">4</span></span><br><span class="line"><span class="keyword">assert</span> context.caller == <span class="keyword">this</span></span><br><span class="line"><span class="keyword">assert</span> context.owner == julia</span><br></pre></td></tr></table></figure>
<p>è¯»è€…å¯ä»¥è‡ªå·±è·‘ä¸€ä¸‹çœ‹çœ‹ï¼šä¾‹å­ä¸­çš„ closure ä¸­çš„ this æŒ‡å‘çš„å°±æ˜¯å®ƒçš„åˆ›å»ºè€… motherã€‚</p>
<blockquote>
<p>ã€æ³¨æ„ã€‘æ–¹æ³•ä¸æ˜¯å¯¹è±¡ï¼Œå› æ­¤ä¾‹å­ä¸­çš„ closure çš„åˆ›å»ºè€…ä¸æ˜¯<code>birth</code>æ–¹æ³•ï¼Œè€Œæ˜¯ julia å¯¹è±¡ã€‚</p>
</blockquote>
<h4 id="5-5-2-å¤–éƒ¨å˜é‡å’Œæ–¹æ³•"><a href="#5-5-2-å¤–éƒ¨å˜é‡å’Œæ–¹æ³•" class="headerlink" title="5.5.2 å¤–éƒ¨å˜é‡å’Œæ–¹æ³•"></a>5.5.2 å¤–éƒ¨å˜é‡å’Œæ–¹æ³•</h4><p>è¿˜æ˜¯ä»å‰é¢çš„ä¾‹å­çœ‹ï¼Œ<code>method()</code>æ–¹æ³•å’Œ field å˜é‡æ˜¯å¦‚ä½•è§£æåˆ°çš„å‘¢ï¼Ÿ</p>
<p>åœ¨ Closure ä¸­ï¼Œç±»ä¼¼ method() å’Œ field è¿™æ ·çš„ç±»æˆå‘˜ç§°ä¸º <strong>vanilla reference</strong> ã€‚vanilla reference è§£æçš„æ—¶å€™ï¼Œé»˜è®¤å‰é¢æ˜¯åŠ ä¸Š<code>this.</code>å¼•ç”¨çš„ï¼Œå³å®ƒä»¬çš„è§£ææ˜¯é’ˆå¯¹ owner çš„ã€‚</p>
<h4 id="5-5-3-delegate"><a href="#5-5-3-delegate" class="headerlink" title="5.5.3 delegate"></a>5.5.3 delegate</h4><p><strong>delegate</strong> æ˜¯ä»ä¾‹å­ä¸­çœ‹åˆ°çš„ï¼Œå®ƒæ˜¯é—­åŒ…çš„ä¸€ä¸ªé»˜è®¤å±æ€§ï¼Œå®ƒæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‡è®¾Listä¸­æœ‰è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span></span>&#123;</span><br><span class="line">	<span class="function">def <span class="title">with</span><span class="params">(Closure doit)</span> </span>&#123;</span><br><span class="line">		doit.delegate = <span class="keyword">this</span></span><br><span class="line">		doit()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def list = []</span><br><span class="line">def expected = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">list.with&#123;</span><br><span class="line">	<span class="comment">// birth context ä¸­å¹¶æ²¡æœ‰ add æ–¹æ³•</span></span><br><span class="line">	add <span class="number">1</span></span><br><span class="line">	add <span class="number">2</span></span><br><span class="line">	<span class="keyword">assert</span> delegate == expected</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾åœ¨<code>List</code>ç±»ä¸­æœ‰ä¸€ä¸ª<code>with()</code>æ–¹æ³•ï¼Œé—­åŒ…ä¼ é€’ç»™å®ƒä¹‹åï¼Œå…ˆä¿®æ”¹ delegate ä¸º thisï¼Œç„¶åå†æ‰§è¡Œé—­åŒ…ã€‚é‚£ä¹ˆä¸Šé¢çš„ assert å°±æˆç«‹ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å› ä¸º <strong>delegate å®é™…æ˜¯ç”¨äºæ›´æ”¹ vanilla reference çš„è§£æå¯¹è±¡çš„</strong>ã€‚å‰é¢è¯´äº†ï¼Œåœ¨é—­åŒ…ä¸­è°ƒç”¨æ–¹æ³•ï¼Œé»˜è®¤å‰é¢æ˜¯åŠ ä¸Š this çš„ï¼Œä½†æ˜¯ delegate å¯ä»¥ä¿®æ”¹è¿™ä¸ªé»˜è®¤å€¼ï¼Œåœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®é™…æŠŠ delegate ä¿®æ”¹æŒ‡å‘äº† thisï¼Œè¿™ä¸ª this å®é™…æŒ‡å‘çš„æ˜¯ List æœ¬èº«ï¼Œå› æ­¤è¿™ä¸ª<code>add()</code>æ–¹æ³•è°ƒç”¨çš„æ˜¯ List æœ¬èº«çš„<code>add()</code>æ–¹æ³•ï¼Œæ‰€ä»¥æœ€å<code>assert delegate == expected</code>æ˜¯æˆç«‹çš„ã€‚</p>
<h4 id="5-5-4-Vanilla-Referenceè§£æ"><a href="#5-5-4-Vanilla-Referenceè§£æ" class="headerlink" title="5.5.4 Vanilla Referenceè§£æ"></a>5.5.4 Vanilla Referenceè§£æ</h4><p>å‰é¢è¯´äº† <strong>Vanilla Reference</strong> çš„è§£ææ–¹å¼ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p>
<ol>
<li>The closure itself : æ¯”å¦‚ä¾‹å­ä¸­çš„ local å˜é‡ï¼›</li>
<li>The owner : æ¯”å¦‚ç¬¬äºŒä¸ªä¾‹å­ä¸­çš„ expectedï¼›</li>
<li>The delegate : æ¯”å¦‚<code>add()</code>æ–¹æ³•çš„è§£æï¼›</li>
</ol>
<p>æ—¢ç„¶æœ‰ä¸‰ä¸ªè§£æé€”å¾„ï¼Œé‚£ä¹ˆè§£æé¡ºåºæ˜¯å¦‚ä½•çš„å‘¢ï¼Ÿæ˜¯ä¸æ˜¯è®¾ç½®äº† delegate å°±ä¸€å®šä¼šæ”¹å˜ <strong>Vanilla Reference</strong> çš„è§£æå¯¹è±¡å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆè‚¯å®šæ˜¯æœ¬åœ°å˜é‡è§£æä¼˜å…ˆçš„ï¼Œå‰©ä¸‹çš„ owner å’Œ delegate çš„è§£æé¡ºåºï¼Œåˆ™æ˜¯å†³å®šäº<code>resolveStrategy</code>ï¼Œæ€»å…±æœ‰å››ç§æƒ…å†µ:</p>
<ol>
<li>delegate first // ä¼˜å…ˆé’ˆå¯¹ delegate è§£æ</li>
<li>delegate only // åªå¯¹ delegate è§£æ</li>
<li>owner first // ä¼˜å…ˆé’ˆå¯¹ owner è§£æ</li>
<li>owner only // åªé’ˆå¯¹ owner è§£æ</li>
</ol>
<p>ä¿®æ”¹ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">closure.resolveStrategy = Closure.DELEGATE_ONLY</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ›´æ”¹è§£æç­–ç•¥ï¼Œå°±å¯ä»¥æ§åˆ¶è§£æå¯¹è±¡å’Œé¡ºåºã€‚</p>
<h2 id="å…­ã€æ€»ç»“"><a href="#å…­ã€æ€»ç»“" class="headerlink" title="å…­ã€æ€»ç»“"></a>å…­ã€æ€»ç»“</h2><p>Groovy ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œä¸ Java ä¿æŒæå¤§çš„ç›¸ä¼¼æ€§å’Œå…¼å®¹æ€§ï¼Œå­¦ä¹ æˆæœ¬å¾ˆä½ï¼Œå¹¶ä¸”æå¤§çš„æ‰©å±•äº† Java è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›ï¼</p>
<p>è¿™é‡Œåˆ†æ Groovyï¼Œä¸»è¦æ˜¯ä¸ºå­¦ä¹  Gradle æä¾›ä¸€ä¸ªåŸºç¡€ï¼Œå› æ­¤è¿™é‡Œçš„åˆ—ä¸¾æ—¢ä¸ç³»ç»Ÿä¹Ÿä¸æ·±å…¥ï¼Œå¦‚æœè¦æ·±å…¥å­¦ä¹ ï¼Œæ¨èä»¥ä¸‹èµ„æ–™:</p>
<ol>
<li><a href="http://www.groovy-lang.org/documentation.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼ŒGroovyçš„å®˜æ–¹èµ„æ–™è¿˜æ˜¯å¾ˆå…¨é¢çš„ï¼›</li>
<li>ã€ŠGroovy In Actionã€‹ï¼Œè¿™ä¸ªç³»åˆ—ä¹¦å¯¹äºå…¥é—¨ä»¥åŠç¨å¾®æ·±å…¥ä¸€é—¨æŠ€æœ¯éƒ½è¿˜æŒºä¸é”™çš„ï¼›</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Gradleç³»åˆ—æ€»]]></title>
      <url>http://www.timebridge.space/2016/05/18/Gradle-Outline/</url>
      <content type="html"><![CDATA[<p>æœ¬ç³»åˆ—æ–‡ç« é€‚åˆä¸¤ç±»è¯»è€…ï¼š</p>
<ol>
<li>å¯¹ Gradle æœ‰æ‰€äº†è§£ï¼›</li>
<li>çœ‹äº†å¾ˆå¤š Gradle èµ„æ–™ï¼Œä½†æ˜¯ä»ç„¶æä¸æ˜ç™½ Gradle æ˜¯æ€ä¹ˆå›äº‹ï¼›</li>
</ol>
<p>è¿™ç³»åˆ—æ–‡ç« å¯ä»¥ä¸ºè¿™ä¸¤ç±»è¯»è€…ç†æ¸…æ€è·¯ï¼Œä¸ºåç»­çš„ Gradle å­¦ä¹ æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Linux é©±åŠ¨å¼€å‘]]></title>
      <url>http://www.timebridge.space/2016/05/16/linux-driver-dev/</url>
      <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ¬ç« è¯´æ˜é‡Œé¢è¯´æœ¬ç« çš„å†…å®¹ä¼šæ³¨é‡äº Application å±‚ï¼Œçœ‹äº†å‡ å¤© Binder çš„æºç ï¼Œå‘ç°å·²ç»æ‰è¿› Library å±‚çš„å‘äº†ï¼Œæ‚²å‰§çš„æ˜¯ï¼Œä¸çœ‹ä¸€ä¸‹ Binder é©±åŠ¨ï¼Œè²Œä¼¼è¿ Binder è¿™å…³éƒ½è¿‡ä¸äº†ï¼Œæ²¡åŠæ³•ï¼Œåªèƒ½çœ‹çœ‹é©±åŠ¨åˆ°åº•æ€ä¹ˆå†™ã€‚</p>
<p>ç½‘ä¸Šæ•™å­¦å†™å…¥é—¨çº§ Linux é©±åŠ¨çš„ä¾‹å­å¾ˆå¤šï¼Œæ¯”å¦‚<a href="http://liucw.blog.51cto.com/6751239/1218461" target="_blank" rel="noopener">ã€é©±åŠ¨ã€‘linuxè®¾å¤‡é©±åŠ¨Â·å…¥é—¨</a>ã€<a href="http://jp.51studyit.com/article/details/53732.htm" target="_blank" rel="noopener">linuxé©±åŠ¨ç¼–å†™ï¼ˆè™šæ‹Ÿå­—ç¬¦è®¾å¤‡ç¼–å†™ï¼‰</a>ï¼Œè¿™ä¸¤ä¸ªä¾‹å­æ­¥éª¤æ¯”è¾ƒå…¨ï¼Œä½†æ˜¯ä¾‹å­æœ¬èº«å¤ªç®€å•ï¼Œæ‰€ä»¥åˆæ‰¾åˆ°ä¸€æšï¼š<a href="http://www.cnblogs.com/lknlfy/archive/2012/04/27/2473804.html" target="_blank" rel="noopener">Linuxå†…å­˜æ˜ å°„ï¼ˆmmapï¼‰</a>ã€‚è¿™ç¯‡æ–‡ç« ç®€ç›´å°±æ˜¯ä¸ºå­¦ä¹ Binderè€Œç”Ÿï¼Œä½†æ˜¯å®ƒçš„æ­¥éª¤å¾ˆç®€ç•¥ã€‚å› æ­¤ç»“åˆå‰é¢ä¸¤ä¸ªä¾‹å­æä¾›çš„æ­¥éª¤ä»¥åŠç¬¬ä¸‰ç¯‡æ–‡ç« çš„å†…å®¹ï¼Œè¿™è¾¹è®²è¿°ä¸€ä¸‹æœ€ç»ˆçš„å®è·µç»å†ã€‚<a id="more"></a></p>
<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p><strong>å®è·µç¯å¢ƒå¦‚ä¸‹ï¼šMac OS + VirtualBox 5.0.14 + Ubuntu-12.04.5</strong></p>
<blockquote>
<p>åœ¨Macæœ¬èº«ç¯å¢ƒä¸‹è²Œä¼¼ä¸è¡Œï¼Œç›®å½•ç»“æ„ä¸ä¸€è‡´ã€‚</p>
</blockquote>
<h4 id="1-é©±åŠ¨ç¨‹åº"><a href="#1-é©±åŠ¨ç¨‹åº" class="headerlink" title="1. é©±åŠ¨ç¨‹åº"></a>1. é©±åŠ¨ç¨‹åº</h4><p>åœ¨Ubuntuç³»ç»Ÿæ¡Œé¢ä¸Šæ–°å»ºæ–‡ä»¶<code>mymap.c</code>ï¼Œå°†<a href="http://www.cnblogs.com/lknlfy/archive/2012/04/27/2473804.html" target="_blank" rel="noopener">Linuxå†…å­˜æ˜ å°„ï¼ˆmmapï¼‰</a>ä¸­å¦‚ä¸‹å†…å®¹æ‹·è´è¿›å»:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/list.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pci.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">"mymap"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="built_in">array</span>[<span class="number">10</span>]=&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buffer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_map</span><span class="params">(struct file *filp, struct vm_area_struct *vma)</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> page;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)vma-&gt;vm_start;</span><br><span class="line">    <span class="comment">//unsigned long end =  (unsigned long)vma-&gt;vm_end;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(vma-&gt;vm_end - vma-&gt;vm_start);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¾—åˆ°ç‰©ç†åœ°å€</span></span><br><span class="line">    page = virt_to_phys(buffer);    </span><br><span class="line">    <span class="comment">//å°†ç”¨æˆ·ç©ºé—´çš„ä¸€ä¸ªvmaè™šæ‹Ÿå†…å­˜åŒºæ˜ å°„åˆ°ä»¥pageå¼€å§‹çš„ä¸€æ®µè¿ç»­ç‰©ç†é¡µé¢ä¸Š</span></span><br><span class="line">    <span class="keyword">if</span>(remap_pfn_range(vma,start,page&gt;&gt;PAGE_SHIFT,size,PAGE_SHARED))<span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯é¡µå¸§å·ï¼Œç”±ç‰©ç†åœ°å€å³ç§»PAGE_SHIFTå¾—åˆ°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¾€è¯¥å†…å­˜å†™10å­—èŠ‚æ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">        buffer[i] = <span class="built_in">array</span>[i];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">dev_fops</span> = &#123;</span></span><br><span class="line">    .owner    = THIS_MODULE,</span><br><span class="line">    .open    = my_open,</span><br><span class="line">    .mmap   = my_map,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">misc</span> = &#123;</span></span><br><span class="line">    .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">    .name = DEVICE_NAME,</span><br><span class="line">    .fops = &amp;dev_fops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">dev_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;    </span><br><span class="line">	 printk(KERN_ALERT <span class="string">"(init)Hello,World!\n"</span>);</span><br><span class="line">    <span class="comment">//æ³¨å†Œæ··æ‚è®¾å¤‡</span></span><br><span class="line">    ret = misc_register(&amp;misc);</span><br><span class="line">    <span class="comment">//å†…å­˜åˆ†é…</span></span><br><span class="line">    buffer = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)kmalloc(PAGE_SIZE,GFP_KERNEL);</span><br><span class="line">    <span class="comment">//å°†è¯¥æ®µå†…å­˜è®¾ç½®ä¸ºä¿ç•™</span></span><br><span class="line">    SetPageReserved(virt_to_page(buffer));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">dev_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//æ³¨é”€è®¾å¤‡</span></span><br><span class="line">    misc_deregister(&amp;misc);</span><br><span class="line">    <span class="comment">//æ¸…é™¤ä¿ç•™</span></span><br><span class="line">    ClearPageReserved(virt_to_page(buffer));</span><br><span class="line">    <span class="comment">//é‡Šæ”¾å†…å­˜</span></span><br><span class="line">    kfree(buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(dev_init);</span><br><span class="line">module_exit(dev_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"LKN@SCUT"</span>);</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´æ‹·è´ï¼Œä¸éœ€è¦ä»»ä½•çš„ä¿®æ”¹ã€‚</p>
<blockquote>
<p>æ¯”èµ·åŸåšå®¢çš„ä»£ç ï¼Œåœ¨<code>dev_init()</code>å‡½æ•°ä¸­å¢åŠ äº†ä¸€è¡Œä»£ç ï¼š<code>printk(KERN_ALERT &quot;(init)Hello,World!\n&quot;);</code>ï¼Œç”¨äºæ£€æµ‹å®‰è£…ã€‚</p>
</blockquote>
<h4 id="2-Makefileæ–‡ä»¶"><a href="#2-Makefileæ–‡ä»¶" class="headerlink" title="2. Makefileæ–‡ä»¶"></a>2. Makefileæ–‡ä»¶</h4><p>åœ¨æ¡Œé¢ä¸Šæ–°å»ºä¸€ä¸ªæ–‡ä»¶<code>Makefile</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">obj-m := mymap.o</span><br><span class="line">PWD := $(shell pwd)</span><br><span class="line">KDIR := /lib/modules/$(shell uname -r)/build</span><br><span class="line">all:</span><br><span class="line">    $(MAKE) -C $(KDIR) M=$(PWD) modules</span><br></pre></td></tr></table></figure>
<p><strong>ã€æ³¨æ„ï¼ã€‘</strong> æœ€åä¸€è¡Œå¼€å¤´æ˜¯ä¸€ä¸ªTabï¼Œä¸è¦ç”¨ç©ºæ ¼ä»£æ›¿ï¼Œå®è·µçš„æ—¶å€™è¢«å‘äº†ã€‚å…·ä½“é—®é¢˜å¯è§<a href="http://ubuntuforums.org/showthread.php?t=1795434" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p>
<blockquote>
<p>KDIRä¹Ÿæœ‰èµ‹å€¼ä¸º<code>/usr/src/linux-source-2.6.24/</code>çš„ï¼Œå³ç›®å½•æ˜¯åœ¨<code>/usr/src/</code>ä¸‹é¢ï¼Œè¯»è€…å¯ä½œå‚è€ƒï¼Œæˆ‘è¿™ä¸ªç›®å½•ä¸‹é¢æ˜¯æ‰¾ä¸åˆ°sourceç›®å½•çš„ã€‚</p>
</blockquote>
<h4 id="3-é…ç½®ç¯å¢ƒ"><a href="#3-é…ç½®ç¯å¢ƒ" class="headerlink" title="3. é…ç½®ç¯å¢ƒ"></a>3. é…ç½®ç¯å¢ƒ</h4><p>åœ¨ç¼–è¯‘å‡ºé©±åŠ¨æ–‡ä»¶ä¹‹å‰ï¼Œéœ€è¦é¦–å…ˆåœ¨ç³»ç»Ÿå‘½ä»¤è¡Œshellä¸‹å®‰è£…å½“å‰ç‰ˆæœ¬çš„linuxå†…æ ¸æºä»£ç ï¼š<code>sudo apt-get install linux-source</code>ã€‚</p>
<h4 id="4-ç¼–è¯‘"><a href="#4-ç¼–è¯‘" class="headerlink" title="4. ç¼–è¯‘"></a>4. ç¼–è¯‘</h4><p>è¿›å…¥æ¡Œé¢æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<code>make</code>ã€‚å³å¯å¾—åˆ°å¦‚ä¸‹è¾“å…¥ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/driver-make.png" width="400" alt="Makeé©±åŠ¨"></div>

<p>è¿™ä¸ªå‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œä¼šåœ¨æ¡Œé¢ä¸Šç”Ÿæˆå¾ˆå¤šæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯<code>mymap.ko</code>ï¼Œè¿™ä¸ªå°±æ˜¯é©±åŠ¨ã€‚</p>
<h4 id="5-å®‰è£…å¸è½½"><a href="#5-å®‰è£…å¸è½½" class="headerlink" title="5. å®‰è£…å¸è½½"></a>5. å®‰è£…å¸è½½</h4><p>æ‰§è¡Œ<code>sudo insmod ./mymap.ko</code>å‘½ä»¤å°±èƒ½å®‰è£…è¯¥é©±åŠ¨ï¼Œæ‰§è¡Œ<code>dmesg | tail -n 1</code>åˆ™å¯ä»¥çœ‹åˆ°è¾“å…¥â€(init)Hello, world!â€çš„è¾“å‡ºï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/driver-install.png" width="400" alt="é©±åŠ¨å®‰è£…"></div>

<p>å¦å¤–æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ<code>lsmod</code>å‘½ä»¤ï¼Œæ˜¯å¯ä»¥æ‰¾åˆ°ä¸€è¡Œ<code>mymap</code>é©±åŠ¨çš„è¾“å‡ºçš„ã€‚</p>
<p>å¸è½½é©±åŠ¨çš„å‘½ä»¤æ˜¯<code>rmmod</code>ã€‚</p>
<h4 id="6-éªŒè¯"><a href="#6-éªŒè¯" class="headerlink" title="6. éªŒè¯"></a>6. éªŒè¯</h4><p>å®‰è£…å¸è½½ä¸­å·²ç»æåˆ°ä¸€äº›éªŒè¯æ–¹æ³•ï¼Œä½†æ˜¯<a href="http://www.cnblogs.com/lknlfy/archive/2012/04/27/2473804.html" target="_blank" rel="noopener">Linuxå†…å­˜æ˜ å°„ï¼ˆmmapï¼‰</a>åˆ™æ˜¯ç”¨ç¨‹åºå»éªŒè¯çš„ã€‚</p>
<p>åœ¨æ¡Œé¢ä¸Šæ–°å»ºä¸€ä¸ª<code>test.c</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p_map;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ‰“å¼€è®¾å¤‡</span></span><br><span class="line">    fd = open(<span class="string">"/dev/mymap"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"open fail\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å†…å­˜æ˜ å°„</span></span><br><span class="line">    p_map = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)mmap(<span class="number">0</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED,fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(p_map == MAP_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"mmap fail\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> here;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“å°æ˜ å°„åçš„å†…å­˜ä¸­çš„å‰10ä¸ªå­—èŠ‚å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,p_map[i]);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">here:</span><br><span class="line">    munmap(p_map, PAGE_SIZE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ç”¨åšä»»ä½•çš„æ›´æ”¹ã€‚</p>
<p>æ‰§è¡Œå‘½ä»¤<code>gcc -o test test.c</code>å³å¯åœ¨æ¡Œé¢ä¸Šç”Ÿæˆ<code>test</code>å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>
<p><div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/driver-verify.png" width="400" alt="é©±åŠ¨å®‰è£…éªŒè¯"></div><br>ä¸åŸåšå®¢çš„ç»“æœä¸€è‡´ã€‚</p>
<blockquote>
<p>å¦‚æœæ‰“å°å‡ºæ¥çš„æ˜¯â€open failâ€ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æƒé™æ˜¯å¦è¶³å¤Ÿï¼Œå¯ä»¥åœ¨rootæƒé™ä¸‹å°è¯•æ‰§è¡Œã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸ªå®è·µéå¸¸ç®€å•ï¼ˆå°±æ˜¯ç¯å¢ƒå’Œæ‰§è¡Œè¿‡ç¨‹å‘ï¼‰ï¼Œå¯¹äºMakefileé‡Œé¢çš„é…ç½®ï¼Œä»¥åŠé©±åŠ¨çš„å†™æ³•ï¼Œè¿™é‡Œéƒ½æ²¡æœ‰åšè¿‡å¤šçš„è§£é‡Šï¼Œä½†æ˜¯æ¨èçš„æ–‡ç« é‡Œé¢æœ‰è¡¨è¿°ï¼Œåšè¿™ä¸ªå®è·µä¸»è¦çš„ç›®çš„æ˜¯ï¼š</p>
<ol>
<li>æ„Ÿå—ä¸€ä¸‹å†™é©±åŠ¨çš„è¿‡ç¨‹ï¼›</li>
<li>ä½“éªŒä¸€ä¸‹è™šæ‹Ÿè®¾å¤‡ï¼ˆæŒ‚è½½ã€è¯»å†™ï¼‰ã€mmapå†…å­˜æ˜ å°„ï¼›</li>
</ol>
<p>äº†è§£è¿™äº›å¯¹äºç†è§£Binderé©±åŠ¨éå¸¸æœ‰ç”¨ï¼Œè¯¦ç»†çš„é©±åŠ¨ç›¸å…³çš„çŸ¥è¯†å¯ä»¥é˜…è¯»ã€ŠLinuxè®¾å¤‡é©±åŠ¨ç¨‹åºã€‹è¿™æœ¬ä¹¦ã€‚</p>
<p>PSï¼šå…³äºæ–‡ä»¶æè¿°ç¬¦å’Œè¿›ç¨‹çš„å…³ç³»ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« : <a href="http://blog.csdn.net/cywosp/article/details/38965239" target="_blank" rel="noopener">Linuxä¸­çš„æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€æ–‡ä»¶ä¹‹é—´çš„å…³ç³»</a>ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Binderæ€»çº²]]></title>
      <url>http://www.timebridge.space/2016/05/16/binder/</url>
      <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>å…³äº Binder çš„æ–‡ç« ï¼Œç½‘ä¸Šå·²ç»æœ‰éå¸¸å¤šçš„èµ„æ–™ï¼Œä¸‹é¢æ¨èå‡ ç¯‡ï¼š</p>
<table>
<thead>
<tr>
<th>ç¼–å·</th>
<th>æ–‡ç« </th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>â‘ </td>
<td><a href="http://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">Android Banderè®¾è®¡ä¸å®ç° - è®¾è®¡ç¯‡</a></td>
<td>è¢«å¾ˆå¤šåšå®¢æ¨èçš„åšå®¢ï¼Œåªè®²è®¾è®¡ä¸è®²ä»£ç ã€‚ä»‹ç»äº† Binder æœºåˆ¶ä¸­çš„å¾ˆå¤šæ¦‚å¿µä»¥åŠå¾ˆå¤šå…³é”®ç‚¹çš„é€»è¾‘ï¼Œéå¸¸å€¼å¾—ä¸€è¯»ï¼Œæœ€ä¸»è¦çš„æ˜¯é‡Œé¢æœ‰ä¸€å¼ ç¥å›¾ï¼Œæ¸…æ¥šçš„å±•ç¤ºäº†ç›¸å…³æ¦‚å¿µä¹‹é—´çš„å…³ç³»ã€‚</td>
</tr>
<tr>
<td>â‘¡</td>
<td><a href="http://weishu.me/2016/01/12/binder-index-for-newer/" target="_blank" rel="noopener">Binderå­¦ä¹ æŒ‡å—</a></td>
<td>å¦‚æ ‡é¢˜æ‰€è¨€ï¼Œæœ‰å­¦ä¹ æŒ‡å—ï¼Œä¹Ÿæ¨èäº†ç¬¬ä¸€ç¯‡åšå®¢ï¼Œç›®å‰è¿˜åªæ˜¯åœç•™åœ¨ Java å±‚ï¼Œæœ‰å¾…æ·±å…¥ã€‚ä½†æ˜¯å¼€å¤´çš„ Linux ç³»ç»Ÿç›¸å…³çŸ¥è¯†çš„è®²è§£æ¯”è¾ƒæœ‰ç”¨ï¼Œå¦å¤–æ¯”å–»ä¹Ÿéå¸¸æ°å½“ã€‚</td>
</tr>
<tr>
<td>â‘¢</td>
<td><a href="http://blog.csdn.net/codefly/article/category/1054447" target="_blank" rel="noopener">çº¢èŒ¶ä¸€æ¯è¯Binder</a></td>
<td>è¿™ç¯‡æ–‡ç« çœŸæ­£çš„åšåˆ°äº†æœ‰å›¾æœ‰çœŸç›¸ï¼è™½ç„¶æ˜¯è®²ä»£ç ï¼Œä½†æ˜¯è§£æå›¾ç”»çš„å¤ªæ£’äº†ï¼Œä¸€ç›®äº†ç„¶ï¼Œä¸€å®šè¦åšæŒçœ‹å®Œä¸Šä¸­ä¸‹ä¸‰ç¯‡ï¼Œè®²è§£éå¸¸ç²¾å½©ã€‚</td>
</tr>
<tr>
<td>â‘£</td>
<td><a href="http://blog.csdn.net/luoshengyang/article/details/6618363" target="_blank" rel="noopener">Androidè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶Binderç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’</a></td>
<td>è€ç½—çš„æ–‡ç« ã€‚é¦–å…ˆæ˜¯åˆ†å·¥æ˜ç¡®ï¼Œå››ç¯‡æ–‡ç« è®²è¿°Binderæœºåˆ¶çš„å››ä¸ªè¦ç‚¹ï¼›å…¶æ¬¡æ˜¯è®²è§£çš„éå¸¸ç»†è‡´æ·±å…¥ï¼Œå¯ä»¥å½“åšå­—å…¸æŸ¥çœ‹ã€‚</td>
</tr>
<tr>
<td>â‘¤</td>
<td><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html" target="_blank" rel="noopener">Androidæ·±å…¥æµ…å‡ºä¹‹Binderæœºåˆ¶</a></td>
<td>é‚“å‡¡å¹³å¤§ç¥çš„åšå®¢ï¼Œä¹Ÿæ˜¯è€ç½—æ¨èçš„åšå®¢ã€‚è¿™ç¯‡æ–‡ç« ç›´æ¥ä» MediaPlayerService åˆ‡å…¥ï¼Œè®²è§£ç»†è‡´ï¼Œå¨“å¨“é“æ¥ã€‚å»ºè®®åœ¨çœ‹å®Œå‰é¢å‡ ç¯‡æ–‡ç« ä¹‹åå†æ¥çœ‹è¿™ç¯‡æ–‡ç« ã€‚</td>
</tr>
</tbody>
</table>
<a id="more"></a><strong>å› ä¸ºæœ‰å¤§ç¥çš„æ–‡ç« ï¼Œæ‰èƒ½å…¥å¾— Binder çš„å¤§é—¨ä¸€æ¢ç©¶ç«Ÿï¼Œéå¸¸æ„Ÿè°¢ï¼</strong><br><br>è¯´å®è¯ï¼Œå‡ ç¯‡æ–‡ç« åŠ èµ·æ¥è¯¥è®²çš„ä¹Ÿéƒ½è®²å¾—å·®ä¸å¤šäº†ã€‚æœ¬æ–‡åªæ˜¯è¯•ç€æŒ‰ç…§è‡ªå·±çš„æ€è·¯å»æ¢³ç†ä¸€ä¸‹ Binder çš„æœºåˆ¶ï¼Œå¯¹ä¸Šé¢å‡ ç¯‡æ–‡ç« çš„æœ‰å¼•ç”¨çš„åœ°æ–¹ä¼šæ ‡è®°å‡ºæ¥ã€‚<br><br>è¿™é‡Œä¹Ÿçœå»ä¸€äº›èƒŒæ™¯ä»‹ç»ï¼ŒåŒ…æ‹¬ä¸ºä»€ä¹ˆé€‰æ‹© Binderã€Binder çš„è®¾è®¡æ€æƒ³ç­‰ç­‰ï¼Œè¿™äº›åœ¨æ–‡ç« â‘ ä¸­éƒ½æœ‰é˜è¿°ã€‚<br><br>## Binderç»“æ„<br>è€ç½—çš„æ–‡ç« ä¸­å¯¹æ­¤çš„è§£ææœ€ä¸ºæ¸…æ™°ï¼Œå› ä¸ºä»–åœ¨<a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html" target="_blank" rel="noopener">å­¦ä¹ è®¡åˆ’</a>ä¸­ç”»äº†ä¸ªå›¾ã€‚å›¾ä¸­å¯ä»¥æ¸…æ™°çš„çœ‹åˆ° Binder åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†:<br><br>1. Client â€”â€” æœåŠ¡ä½¿ç”¨æ–¹<br>2. Server â€”â€” æœåŠ¡æä¾›æ–¹<br>3. Binder Driver â€”â€” åº•å±‚é©±åŠ¨<br>4. Service Manager â€”â€” æœåŠ¡ç®¡ç†æ–¹<br><br>ä¸‹é¢è¿™ä¸ªå›¾æ˜¯ Android çš„ç³»ç»Ÿæ¶æ„å›¾:<br><br><div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Android-Arc.png" alt="Androidç³»ç»Ÿæ¶æ„"></div><br><br>äº‹å®ä¸Šè€ç½—çš„å›¾æ˜¯åˆ†å¸ƒåœ¨ Libraries å’Œ Linux Kernel å±‚çš„ï¼Œå³ Clientã€Serverä»¥åŠ Service Manager ä¸‰éƒ¨åˆ†å±äº Librariesï¼Œè€ŒBinder Driverå±äº Linux Kernel å±‚ã€‚<br><br>å¤§éƒ¨åˆ†æ–‡ç« åˆ†æ Binder çš„æ—¶å€™ä¹Ÿæ˜¯è¿™æ ·ï¼Œè„±ç¦»äº†æˆ‘ä»¬æœ€å¸¸æ¥è§¦çš„ Application Framework å±‚åœ¨è®²è¿°ï¼Œå¯¼è‡´ä¸å®¹æ˜“ç†è§£ã€‚ä½† Binder çš„æ ¸å¿ƒé€»è¾‘ç¡®å®ä¸åœ¨ Java å±‚ï¼ŒJavaå±‚åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨è€Œè¿›è¡Œçš„ä¸€å±‚åŒ…è£…ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå…ˆææ¸…æ¥šä»¥ä¸Šå››ä¸ªæ¦‚å¿µï¼Œç„¶åå†å»ç¢ç£¨Javaå±‚ã€‚<br><br>#### ç»“æ„è§£é‡Š<br>çœ‹å®Œæ–‡ç« â‘¡å…³äºLinuxçŸ¥è¯†çš„è§£é‡Šå†æ¥çœ‹è¿™å››ä¸ªéƒ¨åˆ†çš„å…³ç³»ï¼Œå¯èƒ½ç†è§£èµ·æ¥è¿˜ä¸æ˜¯å¾ˆå®¹æ˜“ã€‚è¿™é‡Œç”¨ä¸€ç§é€šä¿—ä¸€ç‚¹çš„æ–¹å¼æ¥è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå½¢æˆè¿™å››ä¸ªéƒ¨åˆ†ã€‚<br><br>é¦–å…ˆè¦çŸ¥é“çš„ä¸€ç‚¹æ˜¯ï¼šè¿›ç¨‹ä¸åƒçº¿ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´çš„å†…å­˜æ˜¯ä¸å…±äº«çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åˆ›é€ å¤šç§å¤šæ ·çš„æ–¹å¼æ¥å®ç°è¿›ç¨‹é—´é€šè®¯çš„åŸå› ã€‚ä»¥ Android å¼€å‘ä¸ºä¾‹ï¼Œå¯ä»¥æƒ³è±¡ä¸¤ä¸ª Activityï¼Œæœ‰æ—¶å€™åœ¨è·³è½¬çš„æ—¶å€™ï¼ŒIntent éœ€è¦æºå¸¦çš„æ•°æ®è¿‡äºå¤æ‚ï¼Œåºåˆ—åŒ–å·²ç»ä¸ä¸å¯èƒ½ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ<br><br>ä¸€ç§åŠæ³•å°±æ˜¯å°†æ•°æ®è®¾ç½®ä¸ºé™æ€å˜é‡ï¼Œè¿˜æœ‰ä¸€ç§åŠæ³•å°±æ˜¯å­˜åˆ° Application ç±»ä¸­ï¼ˆå½“ç„¶è¿˜æœ‰å…¶ä»–åŠæ³•ï¼‰ã€‚ä»¥ä¸Šä¸¤ç§åŠæ³•æ€»ç»“ä¸€ä¸‹æ— éæ˜¯æ‰¾ä¸€ä¸ªä¸¤ä¸ª Activity éƒ½èƒ½è®¿é—®åˆ°çš„ç¬¬ä¸‰æ–¹å˜é‡æ¥ä¸­è½¬æ•°æ®ã€‚å¯¹äºè¿›ç¨‹æ¥è¯´ï¼Œé‡‡å–çš„åŠæ³•ä¹Ÿç±»ä¼¼ï¼šè™½ç„¶è¿›ç¨‹ä¹‹é—´ç›´æ¥é€šè®¯æ˜¯è¢«ç¦æ­¢çš„ï¼Œä½†æ˜¯é€šè¿‡å†…æ ¸æ˜¯å¯ä»¥çš„ã€‚å†…æ ¸æ˜¯æ‰€æœ‰è¿›ç¨‹è¿è¡Œçš„ç¯å¢ƒï¼Œå¯ä»¥æŠŠæ•°æ®äº¤ç»™å†…æ ¸ï¼Œè®©å†…æ ¸å‘é€ç»™å¯¹åº”çš„è¿›ç¨‹ï¼Œå¯¹æ–¹è¿›ç¨‹ä¹Ÿä»¥åŒæ ·çš„æ–¹å¼å°†ç»“æœè¿”å›å›æ¥ã€‚<br>&gt;å†…æ ¸ç†è§£èµ·æ¥å¤ªæŠ½è±¡çš„è¯ï¼Œå¯ä»¥æƒ³è±¡ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¢«ä»»ä½•çš„åº”ç”¨è¯»å–ï¼Œå› æ­¤æˆ‘å¯ä»¥è®©ä¸€ä¸ªåº”ç”¨åœ¨æ–‡ä»¶ä¸­å†™å…¥ä¸€æ®µè¯ï¼Œå¦å¤–ä¸€ä¸ªåº”ç”¨å»è¯»å–è¿™æ®µè¯ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®Œæˆä¸€æ¬¡é€šä¿¡ã€‚<br><br>è¿™å°±æ˜¯ Clientï¼ŒServerï¼ŒBinder Driver ä¹‹é—´çš„å…³ç³»ï¼Œåªä¸è¿‡ Client/Server å’Œ Binder Driver ä¹‹é—´çš„è°ƒç”¨ä¸æ˜¯ä¸€èˆ¬çš„æ–¹æ³•è°ƒç”¨ï¼Œè€Œæ˜¯ <strong>ç³»ç»Ÿè°ƒç”¨</strong> ã€‚<br><br>é‚£ä¹ˆ Service Manager åˆæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼Ÿè¿™ä¸€ç‚¹æ–‡ç« â‘¡æè¿°çš„å¾ˆæ¸…æ™°ã€‚ç®€å•æ¥è¯´ï¼Œä¸€ä¸ª Service å¯åŠ¨èµ·æ¥ä¹‹åï¼Œç»™è‡ªå·±å–ä¸€ä¸ªåå­—ï¼Œæ³¨å†Œåˆ° ServiceManager ä¸­å»ï¼Œå‘Šè¯‰ Service Managerï¼šå¦‚æœæœ‰äººæ‰¾â€XXXXâ€ï¼Œä½ è®©å®ƒæ¥æ‰¾æˆ‘å¥½äº†ï¼ŒService Manager å°±è®°ä¸‹äº†ï¼Œè¿™å°±æ˜¯<strong>æœåŠ¡çš„æ³¨å†Œè¿‡ç¨‹</strong>ã€‚è¿™ä¸ªæ—¶å€™æœ‰ä¸ª Client å¬è¯´æœ‰ä¸ªå«â€XXXXâ€çš„ Service èƒ½å¹²æŸäº‹å„¿ï¼Œå°±é—® Service Manager ï¼Œæœ‰è¿™ä¸ªå«â€XXXXâ€çš„ Service æ²¡æœ‰ï¼Ÿ Service Manager ä¸€æŸ¥è‡ªå·±çš„è®°å½•è¡¨ï¼Œå°±æ‰¾åˆ°äº†è¿™ä¸ª Service ï¼Œæ¬¢å¿«åœ°æŠŠå®ƒäº¤ç»™äº† Clientï¼Œè¿™å°±æ˜¯<strong>æœåŠ¡çš„æŸ¥è¯¢è¿‡ç¨‹</strong>ã€‚Client æ‹¿åˆ° Service ä¹‹åå°±å¯ä»¥äº«å— Service æä¾›çš„æœåŠ¡äº†ã€‚æ²¡æœ‰ Service Managerï¼ŒClients å°±ä¸çŸ¥é“å»å“ªé‡Œå¯»æ‰¾æƒ³è¦çš„æœåŠ¡ã€‚<br><br>è¿™ä¹ˆä¸€æ¥ï¼Œæˆ‘ä»¬å°±ææ¸…æ¥šäº† Binder æœºåˆ¶æ¯ä¸ªéƒ¨åˆ†çš„èŒè´£ä»¥åŠå¤§ä½“çš„äº¤äº’æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚å®é™…çš„é—®é¢˜è¦å¤æ‚å¾ˆå¤šï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦æ·±ç©¶<strong>ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜</strong>:<br><br>1. Service Manager æ˜¯å¦‚ä½•å¯åŠ¨å¹¶æˆä¸ºæœåŠ¡ç®¡ç†è€…çš„ï¼Ÿ<br>2. Service æ˜¯å¦‚ä½•å°†è‡ªå·±æ³¨å†Œåˆ° Service Manager ä¸­å»çš„ï¼Ÿ<br>3. Client æ˜¯å¦‚ä½•å¯»æ‰¾å¯¹åº”çš„ Service çš„ï¼Ÿ<br><br>è¿™ä¸‰ä¸ªç‚¹æ˜¯ Binder æœºåˆ¶äº¤äº’çš„æ ¸å¿ƒï¼Œææ¸…æ¥šè¿™ä¸‰ä¸ªç‚¹ï¼Œå°±å¯ä»¥æ¯”è¾ƒå¥½çš„ç†è§£ Binder æœºåˆ¶äº†ã€‚<br><br>### å»ºè®®<br>åœ¨å¼€å§‹ä»‹ç»ä¹‹å‰ï¼Œå»ºè®®è¯»è€…å…ˆæ ¹æ®æ–‡ç« <a href="http://www.muzileecoding.com/framework/linux-driver-dev.html" target="_blank" rel="noopener">Linux é©±åŠ¨å¼€å‘</a>è‡ªå·±åŠ¨æ‰‹å†™ä¸ªé©±åŠ¨ï¼Œå¯¹Linuxç³»ç»Ÿä¸é™Œç”Ÿçš„ç«¥é‹èŠ±ä¸äº†å¤šå°‘æ—¶é—´ï¼Œæ–‡ç« ä¸­ç»™å‡ºçš„å‡ ç¯‡æ–‡ç« é“¾æ¥ä¹Ÿå»ºè®®èŠ±æ—¶é—´çœ‹ä¸€ä¸‹ã€‚äº†è§£ä¸€ä¸ªç®€å•é©±åŠ¨æ˜¯å¦‚ä½•ç¼–å†™çš„ï¼Œå¯¹äºåé¢è®²è§£ Binder é©±åŠ¨å¤§æœ‰è£¨ç›Šã€‚<br><br>å¦å¤–æ—¢ç„¶è¦åˆ†ææºç ï¼Œä»£ç æ–‡ä»¶è‡ªç„¶å°‘ä¸äº†ï¼Œè¿™é‡Œæ¨èä¸€ä¸ªç½‘ç«™:<a href="http://androidxref.com/" target="_blank" rel="noopener">AndroidXref</a>ã€‚å¯ä»¥æ–¹ä¾¿æŸ¥çœ‹å¤šä¸ª Android ç‰ˆæœ¬çš„ç³»ç»Ÿæºä»£ç ã€‚<br><br>###vå£°æ˜<br>åœ¨é˜…è¯»<a href="http://blog.csdn.net/codefly/article/category/1054447" target="_blank" rel="noopener">@æ‚ ç„¶çº¢èŒ¶</a>çš„åšå®¢æ—¶ï¼Œæ·±æ„Ÿç”»å›¾çš„é‡è¦æ€§ï¼Œå°¤å…¶æ˜¯å‡½æ•°çš„è°ƒç”¨å…³ç³»å›¾ï¼Œåœ¨åˆ†æå¤æ‚ç³»ç»Ÿçš„æ—¶å€™æ˜¾å¾—ç‰¹åˆ«æœ‰ç”¨ï¼šå¯ä»¥æ¸…æ™°çš„å®šä½åˆ°ç›®å‰æ­£åœ¨åˆ†æå“ªä¸€å—ã€‚å› æ­¤æ¥ä¸‹å»çš„æ–‡ç« ä¼šå€Ÿç”¨è¿™ç§æ–¹å¼è¿›è¡Œåˆ†æã€‚<br><br>## Binder ç»“æ„ä½“å­—å…¸<br>å› ä¸º binder çš„å®ç°ä¸­æ¶‰åŠåˆ°éå¸¸å¤šçš„æ•°æ®ç»“æ„ï¼Œæœ¬æ¥åˆ†æèµ·æ¥æ–¹æ³•è°ƒç”¨é“¾å°±å¾ˆé•¿ï¼Œä¸´æ—¶å†å»åˆ†ææ•°æ®ç»“æ„ä¼šè®©åˆ†æå˜å¾—ä¸æ¸…æ¥šï¼Œå› æ­¤è¿™é‡Œä¼šåˆ—å‡ºé‡åˆ°çš„æ‰€æœ‰çš„æ•°æ®ç»“æ„ä»¥ä¾¿äºè¯»è€…æŸ¥è¯¢ã€‚<strong>åœ¨åç»­çš„æ–‡ç« ä¸­ï¼Œå¦‚æœä¸€ä¸ªç»“æ„ä½“åˆ—åœ¨è¿™é‡Œï¼Œä¼šæ ‡æ³¨å‡ºæ¥ï¼Œè¡¨æ˜åœ¨å­—å…¸ä¸­å¯æŸ¥ã€‚</strong><br><br><strong>ã€æ³¨æ„ã€‘</strong> è¿™äº›ç»“æ„ä½“æœ‰çš„éå¸¸å¤æ‚ï¼ŒåŒ…å«åˆ«çš„ç»“æ„ä½“ï¼›æœ‰çš„æœ‰äº›å­—æ®µå«ä¹‰æ˜ç¡®ï¼Œæœ‰çš„åˆ™éå¸¸æ¨¡ç³Šï¼›æœ‰çš„ç”šè‡³åªæ˜¯ä¸å¦å¤–ä¸€ä¸ªç»“æ„ä½“ä¿æŒåŒæ„ã€‚å› æ­¤åœ¨å­—å…¸ä¸­è§£é‡Šå…¨éƒ¨çš„å­—æ®µä¸ç°å®ï¼Œæ›´ä½•å†µæœ‰äº›éœ€è¦ç»“åˆä»£ç ä¸Šä¸‹æ–‡è¿›è¡Œåˆ†æï¼Œå› æ­¤è¿™é‡Œå¾ˆå¤šç»“æ„ä½“åªæ˜¯ç®€å•çš„æšä¸¾ï¼Œä¸å­˜åœ¨åˆ†æã€‚<br><br>### <code>binder_state</code><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">void</span> *mapped;</span><br><span class="line">    <span class="keyword">unsigned</span> mapsize;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ä½“æœ‰ä¸‰ä¸ªå±æ€§ï¼šfd ä»£è¡¨æ‰“å¼€çš„ binder é©±åŠ¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œmapped æ˜¯å†…å­˜æ˜ å°„çš„å…¶å®åœ°å€ï¼Œmapsize æ˜¯å†…å­˜æ˜ å°„çš„å¤§å°ã€‚</p>
<h3 id="binder-proc"><a href="#binder-proc" class="headerlink" title="binder_proc"></a><code>binder_proc</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">proc_node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">threads</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">nodes</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">refs_by_desc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">refs_by_node</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vma_vm_mm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">deferred_work_node</span>;</span></span><br><span class="line">    <span class="keyword">int</span> deferred_work;</span><br><span class="line">    <span class="keyword">void</span> *buffer;</span><br><span class="line">    <span class="keyword">ptrdiff_t</span> user_buffer_offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">buffers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">free_buffers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">allocated_buffers</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> free_async_space;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> **<span class="title">pages</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> buffer_size;</span><br><span class="line">    <span class="keyword">uint32_t</span> buffer_free;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">todo</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> wait; <span class="comment">// Linuxä¸­å¾ˆé‡è¦çš„æ•°æ®ç»“æ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_stats</span> <span class="title">stats</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">delivered_death</span>;</span></span><br><span class="line">    <span class="keyword">int</span> max_threads;</span><br><span class="line">    <span class="keyword">int</span> requested_threads;</span><br><span class="line">    <span class="keyword">int</span> requested_threads_started;</span><br><span class="line">    <span class="keyword">int</span> ready_threads;</span><br><span class="line">    <span class="keyword">long</span> default_priority;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debugfs_entry</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ä½“éå¸¸é‡è¦ï¼Œå®ƒå®é™…å’Œ Libraries å±‚çš„è¿›ç¨‹ä¸€ä¸€å¯¹åº”ï¼Œé™¤äº†è®°å½•è¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿˜åˆ›å»ºäº†å¾ˆå¤šçš„å±æ€§ç”¨äºå®ç° binder æœºåˆ¶ç›¸å…³çš„åŠŸèƒ½ï¼Œè¿™ä¸ªç»“æ„ä½“å°†è¢«ä¿å­˜åœ¨<code>filp-&gt;private_data</code>ä¸­ï¼Œä»¥åä¹Ÿå¯ä»¥ä»è¿™ä¸ªå˜é‡ä¸­å–å‡º binder_proc å˜é‡ã€‚å®ƒæ ¸å¿ƒçš„ä¸€ç»„å±æ€§æ˜¯:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">threads</span>;</span> <span class="comment">// è®°å½•å±äºè¯¥è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">nodes</span>;</span> <span class="comment">// è®°å½•å±äºè¯¥è¿›ç¨‹çš„æ‰€æœ‰ binder_nodeï¼Œè¡¨ç¤ºè¯¥è¿›ç¨‹æä¾›çš„æœåŠ¡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">refs_by_desc</span>;</span> <span class="comment">// è®°å½•å±äºè¯¥è¿›ç¨‹å¼•ç”¨çš„æœåŠ¡ï¼ŒèŠ‚ç‚¹æ˜¯ binder_refï¼Œæ ¹æ® handle è¿›è¡ŒæŸ¥æ‰¾</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">refs_by_node</span>;</span> <span class="comment">// åŒä¸Šï¼Œä½†æ˜¯æ ¹æ® binder_node è¿›è¡ŒæŸ¥æ‰¾</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å››æ£µçº¢é»‘æ ‘ï¼Œåé¢æœ‰æ³¨é‡Šã€‚</p>
<h3 id="binder-thread"><a href="#binder-thread" class="headerlink" title="binder_thread"></a><code>binder_thread</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span></span><br><span class="line">	<span class="keyword">int</span> pid;</span><br><span class="line">	<span class="keyword">int</span> looper;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">transaction_stack</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">todo</span>;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> return_error; <span class="comment">/* Write failed, return error code in read buf */</span></span><br><span class="line">	<span class="keyword">uint32_t</span> return_error2; <span class="comment">/* Write failed, return error code in read */</span></span><br><span class="line">		<span class="comment">/* buffer. Used when sending a reply to a dead process that */</span></span><br><span class="line">		<span class="comment">/* we are also waiting on */</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> wait;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">binder_stats</span> <span class="title">stats</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>é¡¾åæ€ä¹‰ï¼Œå’Œ<code>binder_proc</code>ç±»ä¼¼ï¼Œè¿™ä¸ªç»“æ„ä½“è®°å½•çš„å…¶å®æ˜¯æ˜ å°„åˆ°ä¸€ä¸ª Libraries çº¿ç¨‹ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°<code>binder_proc</code>ç»“æ„å±æ€§ï¼Œè¡¨æ˜è¿™ä¸ªçº¿ç¨‹æ˜¯å±äºå“ªä¸ªè¿›ç¨‹çš„ï¼›è¿˜æœ‰ä¸€ä¸ªå±æ€§æ˜¯ rb_nodeï¼Œè¿˜è®°å¾—å‰é¢ä»‹ç»<code>binder_proc</code>æ—¶è¯´åˆ°å®ƒæœ‰å››æ£µé‡è¦çš„çº¢é»‘æ ‘ä¹ˆï¼Ÿå…¶ä¸­ä¸€æ£µå°±å«åš<code>threads</code>ï¼Œè®°å½•çš„æ˜¯å±äºè¿™ä¸ªè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè¿™é‡Œçš„ rb_node å±æ€§å°±æ˜¯æŒ‡å‘å…¶ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼›å¦å¤– looper å±æ€§è®°å½•çš„æ˜¯å½“å‰çº¿ç¨‹çš„çŠ¶æ€ã€‚</p>
<h3 id="binder-node"><a href="#binder-node" class="headerlink" title="binder_node"></a><code>binder_node</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> debug_id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">dead_node</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">refs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> internal_strong_refs;</span><br><span class="line">    <span class="keyword">int</span> local_weak_refs;</span><br><span class="line">    <span class="keyword">int</span> local_strong_refs;</span><br><span class="line">    <span class="keyword">void</span> __user *ptr;</span><br><span class="line">    <span class="keyword">void</span> __user *cookie;</span><br><span class="line">    <span class="keyword">unsigned</span> has_strong_ref:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> pending_strong_ref:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> has_weak_ref:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> pending_weak_ref:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> has_async_transaction:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> accept_fds:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> min_priority:<span class="number">8</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">async_todo</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä»£è¡¨ç€ä¸€ä¸ª Service æœåŠ¡åœ¨é©±åŠ¨å±‚çš„å®ä½“èŠ‚ç‚¹ï¼Œé©±åŠ¨å±‚å†…éƒ¨é€šè¿‡å®ƒä¾¿å¯ä»¥æ‰¾åˆ° Libraries å±‚çš„æœåŠ¡å®ä½“ã€‚å®ƒçš„ cookie å­—æ®µè®°å½•ç€æœåŠ¡åœ¨ Libraries å±‚çš„å¼•ç”¨ä½ç½®ã€‚procåˆ™è¡¨ç¤ºè¯¥èŠ‚ç‚¹æ‰€ä»£è¡¨çš„æœåŠ¡å±äºé‚£ä¸ªè¿›ç¨‹ã€‚å…¶ä½™çš„å±æ€§ä¸»è¦æ˜¯å¼•ç”¨è®¡æ•°ã€‚</p>
<h3 id="binder-ref"><a href="#binder-ref" class="headerlink" title="binder_ref"></a><code>binder_ref</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Lookups needed: */</span></span><br><span class="line">    <span class="comment">/*   node + proc =&gt; ref (transaction) */</span></span><br><span class="line">    <span class="comment">/*   desc + proc =&gt; ref (transaction, inc/dec ref) */</span></span><br><span class="line">    <span class="comment">/*   node =&gt; refs + procs (proc exit) */</span></span><br><span class="line">    <span class="keyword">int</span> debug_id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node_desc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node_node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">node_entry</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> desc;</span><br><span class="line">    <span class="keyword">int</span> strong;</span><br><span class="line">    <span class="keyword">int</span> weak;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="binder-write-read"><a href="#binder-write-read" class="headerlink" title="binder_write_read"></a><code>binder_write_read</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_write_read</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> write_size; <span class="comment">/* bytes to write */</span>  </span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> write_consumed; <span class="comment">/* bytes consumed by driver */</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   write_buffer;  </span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> read_size;  <span class="comment">/* bytes to read */</span>  </span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> read_consumed;  <span class="comment">/* bytes consumed by driver */</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   read_buffer;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ä½“å¹¶ä¸å¤æ‚ï¼Œåªæœ‰å…­ä¸ªå¯¹ç§°çš„å­—æ®µï¼šæ—¢å¯ä»¥æ”¯æŒè¯»çš„æ•°æ®ä¹Ÿå¯ä»¥æ”¯æŒå†™çš„æ•°æ®ï¼Œå¹¶ä¸”çœ‹æ³¨é‡Šï¼Œè¿™ä¸ªç»“æ„ä½“æœ€ç»ˆåº”è¯¥ä¼šä¼ é€’ç»™ binder é©±åŠ¨ã€‚å®é™…ä¸Š <strong>è¿™ä¸ªç»“æ„ä½“åªè´Ÿè´£æ•°æ®ä¼ è¾“ï¼Œä¸è´Ÿè´£æ•°æ®è¯­ä¹‰ï¼Œå…·ä½“ write_buffer å’Œ read_buffer é‡Œé¢æ‰¿è½½ä»€ä¹ˆæ•°æ®ï¼Œä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Œæ˜¯ç”±ä¸Šä¸‹æ–‡ç¯å¢ƒç¡®å®šçš„</strong>ã€‚</p>
<h3 id="flat-binder-object"><a href="#flat-binder-object" class="headerlink" title="flat_binder_object"></a><code>flat_binder_object</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * This is the flattened representation of a Binder object for transfer </span><br><span class="line"> * between processes.  The &apos;offsets&apos; supplied as part of a binder transaction </span><br><span class="line"> * contains offsets into the data where these structures occur.  The Binder </span><br><span class="line"> * driver takes care of re-writing the structure type and data as it moves </span><br><span class="line"> * between processes. </span><br><span class="line"> */  </span><br><span class="line">struct flat_binder_object &#123;  </span><br><span class="line">    /* 8 bytes for large_flat_header. */  </span><br><span class="line">    unsigned long       type;  </span><br><span class="line">    unsigned long       flags;  </span><br><span class="line">  </span><br><span class="line">    /* 8 bytes of data. */  </span><br><span class="line">    union &#123;  </span><br><span class="line">        void        *binder;    /* local object */  </span><br><span class="line">        signed long handle;     /* remote object */  </span><br><span class="line">    &#125;;  </span><br><span class="line">  </span><br><span class="line">    /* extra data associated with local object */  </span><br><span class="line">    void            *cookie;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ³¨é‡Šé‡Œé¢è¯´çš„å¾ˆæ¸…æ¥šï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ä»£è¡¨ä¸€ä¸ª binder å¯¹è±¡ï¼Œç”¨äºåœ¨è¿›ç¨‹ä¹‹é—´ä¼ è¾“çš„ï¼Œåœ¨binder transactionä¸­æœ‰ä¸€ä¸ªâ€offsetsâ€å­—æ®µè¡¨æ˜å“ªäº›åœ°æ–¹å­˜å‚¨ç€è¯¥ç»“æ„ä½“ï¼Œbinder é©±åŠ¨è´Ÿè´£é‡å†™ç»“æ„ä½“ä¸­çš„ type å­—æ®µå’Œæ•°æ®ã€‚å¦å¤–ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ unionï¼Œè¿™ä¸ª union ä¸­æœ‰ä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«å¯ä»¥æŒ‡å‘ä¸€ä¸ªæœ¬åœ°çš„binderå’Œä¸€ä¸ªè¿œç¨‹çš„binderï¼Œè¿œç¨‹binderæ˜¯é€šè¿‡handleå­—æ®µæ¥æŒ‡å‘çš„ã€‚</p>
<blockquote>
<p>è¿™æ®µè¯ç°åœ¨å¬ä¸Šå»ä¸å¤§å¥½ç†è§£ï¼Œå› ä¸ºé¦–å…ˆä¸çŸ¥é“binder transactionä»£è¡¨ä»€ä¹ˆï¼Œå…¶æ¬¡ä¹Ÿä¸æ˜ç™½ binder ä¸ºä»€ä¹ˆè¦é‡å†™è¿™ä¸ªç»“æ„å†…å®¹ã€‚è¿™ä¸ªåœ¨å…·ä½“åˆ†æ binder é©±åŠ¨çš„æ—¶å€™ä¼šé€ä¸ªè§£é‡Šã€‚</p>
</blockquote>
<h3 id="binder-transaction-data"><a href="#binder-transaction-data" class="headerlink" title="binder_transaction_data"></a><code>binder_transaction_data</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction_data</span> &#123;</span></span><br><span class="line">	<span class="comment">/* The first two are only used for bcTRANSACTION and brTRANSACTION,</span></span><br><span class="line"><span class="comment">	 * identifying the target and contents of the transaction.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="keyword">size_t</span>	handle;	<span class="comment">/* target descriptor of command transaction */</span></span><br><span class="line">		<span class="keyword">void</span>	*ptr;	<span class="comment">/* target descriptor of return transaction */</span></span><br><span class="line">	&#125; target;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span>		*cookie;	<span class="comment">/* target object cookie */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	code;		<span class="comment">/* transaction command */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* General information about the transaction. */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	flags;</span><br><span class="line">	<span class="keyword">pid_t</span>		sender_pid;</span><br><span class="line">	<span class="keyword">uid_t</span>		sender_euid;</span><br><span class="line">	<span class="keyword">size_t</span>		data_size;	<span class="comment">/* number of bytes of data */</span></span><br><span class="line">	<span class="keyword">size_t</span>		offsets_size;	<span class="comment">/* number of bytes of offsets */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If this transaction is inline, the data immediately</span></span><br><span class="line"><span class="comment">	 * follows here; otherwise, it ends with a pointer to</span></span><br><span class="line"><span class="comment">	 * the data buffer.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* transaction data */</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">void</span>	*buffer;</span><br><span class="line">			<span class="comment">/* offsets from buffer to flat_binder_object structs */</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">void</span>	*offsets;</span><br><span class="line">		&#125; ptr;</span><br><span class="line">		<span class="keyword">uint8_t</span>	buf[<span class="number">8</span>];</span><br><span class="line">	&#125; data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æœ‰äº›å­—æ®µæ˜¯æœ‰æ³¨é‡Šçš„ï¼Œè¿™é‡Œæœ€é‡è¦çš„ä¸€ä¸ªå­—æ®µèµ‹å€¼æ˜¯<code>tr.target.handle = handle;</code>ï¼Œè¿™ä¸ª handle å°±æ˜¯æˆ‘ä»¬éœ€è¦è°ƒç”¨çš„æœåŠ¡çš„å¥æŸ„ï¼Œå½“è¿™ä¸ªæœåŠ¡ä¸º SM çš„æ—¶å€™ï¼Œhandle å°±ä¸º0__ã€‚</p>
<h3 id="binder-transaction"><a href="#binder-transaction" class="headerlink" title="binder_transaction"></a><code>binder_transaction</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> debug_id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">from</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">from_parent</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">to_proc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">to_thread</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">to_parent</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> need_reply:<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* unsigned is_dead:1; */</span>   <span class="comment">/* not used at the moment */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_buffer</span> *<span class="title">buffer</span>;</span> <span class="comment">/* è¯¥ç»“æ„ä½“è§ä¸‹é¢æ‰€åˆ— */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    code;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    flags;</span><br><span class="line">    <span class="keyword">long</span>    priority;</span><br><span class="line">    <span class="keyword">long</span>    saved_priority;</span><br><span class="line">    <span class="keyword">uid_t</span>   sender_euid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="binder-buffer"><a href="#binder-buffer" class="headerlink" title="binder_buffer"></a><code>binder_buffer</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span> <span class="comment">/* free and allocated entries by address */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span> <span class="comment">/* free entry by size or allocated entry */</span></span><br><span class="line">                <span class="comment">/* by address */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="built_in">free</span>:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> allow_user_free:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> async_transaction:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> debug_id:<span class="number">29</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_transaction</span> *<span class="title">transaction</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">target_node</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> data_size;</span><br><span class="line">    <span class="keyword">size_t</span> offsets_size;</span><br><span class="line">    <span class="keyword">uint8_t</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="binder-work"><a href="#binder-work" class="headerlink" title="binder_work"></a><code>binder_work</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_work</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        BINDER_WORK_TRANSACTION = <span class="number">1</span>,</span><br><span class="line">        BINDER_WORK_TRANSACTION_COMPLETE,</span><br><span class="line">        BINDER_WORK_NODE,</span><br><span class="line">        BINDER_WORK_DEAD_BINDER,</span><br><span class="line">        BINDER_WORK_DEAD_BINDER_AND_CLEAR,</span><br><span class="line">        BINDER_WORK_CLEAR_DEATH_NOTIFICATION,</span><br><span class="line">    &#125; type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="binder-txn"><a href="#binder-txn" class="headerlink" title="binder_txn"></a><code>binder_txn</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_txn</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *target;</span><br><span class="line">    <span class="keyword">void</span> *cookie;</span><br><span class="line">    <span class="keyword">uint32_t</span> code;</span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> sender_pid;</span><br><span class="line">    <span class="keyword">uint32_t</span> sender_euid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> data_size;</span><br><span class="line">    <span class="keyword">uint32_t</span> offs_size;</span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="keyword">void</span> *offs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>binder_transaction_data çš„åŒæ„ä½“ã€‚</p>
<h3 id="binder-io"><a href="#binder-io" class="headerlink" title="binder_io"></a><code>binder_io</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_io</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *data;            <span class="comment">/* pointer to read/write from */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> *offs;        <span class="comment">/* array of offsets */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> data_avail;   <span class="comment">/* bytes available in data buffer */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> offs_avail;   <span class="comment">/* entries available in offsets array */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *data0;           <span class="comment">/* start of data buffer */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> *offs0;       <span class="comment">/* start of offsets buffer */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> unused;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªå®šä¹‰å¾ˆä¸æ˜ç¡®çš„ç»“æ„ä½“ï¼ŒåŠŸèƒ½å¤§ä½“æè¿°å¦‚ä¸‹ï¼šå¯ä»¥å®šä¹‰è¯¥ç»“æ„ä½“å¯ä»¥å®¹çº³çš„æ•°æ®å¤§å°ã€å‰©ä½™é‡ã€èµ·å§‹ä½ç½®ï¼›å¹¶å¯ä»¥å®šä¹‰ä¸€äº›ç‰¹æ®Šæ•°æ®çš„åç§»é‡ï¼Œåç§»é‡æ•°æ®åŒæ ·ä¹Ÿæœ‰èµ·å§‹ä½ç½®å’Œæ•°æ®å¤§å°ã€‚</p>
<h3 id="binder-object"><a href="#binder-object" class="headerlink" title="binder_object"></a><code>binder_object</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_object</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> type;</span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">void</span> *pointer;</span><br><span class="line">    <span class="keyword">void</span> *cookie;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸ flat_binder_object ç»“æ„ä½“å¯¹åº”ï¼Œæ˜¯å®ƒçš„ååºåˆ—åŒ–ç»“æ„ä½“ã€‚</p>
<h3 id="svcinfo"><a href="#svcinfo" class="headerlink" title="svcinfo"></a><code>svcinfo</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_death</span> <span class="title">death</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> len;</span><br><span class="line">    <span class="keyword">uint16_t</span> name[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ptr è®°å½•çš„æ˜¯ç³»ç»Ÿserviceå¯¹åº”çš„binderå¥æŸ„å€¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JNI ç®€ä»‹]]></title>
      <url>http://www.timebridge.space/2016/05/14/jni/</url>
      <content type="html"><![CDATA[<p>ä»æœ¬ç« çš„ä»‹ç»ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼ŒAndroid çš„ä¸Šå±‚ä½¿ç”¨ Java è¯­è¨€æ¥è¿›è¡Œåº”ç”¨ç¨‹åºå¼€å‘ï¼Œä½†æ˜¯æœ¬åœ°åº“éƒ½æ˜¯ä½¿ç”¨ C/C++ æ¥å®ç°ï¼Œè¿™ä¸­é—´æ˜¯éœ€è¦ç²˜åˆçš„ï¼Œè¿™ç§ç²˜åˆæ–¹å¼å°±æ˜¯ JNI ã€‚</p>
<p>JNI æ˜¯ Java Native Interface çš„ç¼©å†™ï¼Œå®ƒæä¾›äº†è‹¥å¹²çš„ API å®ç°äº† Java å’Œå…¶ä»–è¯­è¨€çš„é€šä¿¡ï¼ˆä¸»è¦æ˜¯ C&amp;C++ ï¼‰ã€‚</p>
<p>åœ¨ã€Š Android æŠ€æœ¯å†…å¹•(ç³»ç»Ÿå·)ã€‹è¿™æœ¬ä¹¦é‡Œé¢ï¼Œæœ‰ä¸€å¹…å›¾å¯ä»¥å¾ˆå¥½çš„å±•ç°è¿™å±‚å…³ç³»ï¼š<a id="more"></a></p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Android-JNI.png" height="300" alt="Android-JNI"></div>

<p>è¿™ä¸ªå›¾å¯ä»¥æ˜ å°„åˆ° Android ç³»ç»Ÿçš„æ¡†æ¶å›¾å»çœ‹ï¼Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°ï¼š<strong>JNI æ˜¯ç²˜åˆæ¡†æ¶å±‚å’Œåº“å±‚çš„é‡è¦ç»„ä»¶</strong>ã€‚</p>
<h2 id="JNIçš„åŸºç¡€ç”¨æ³•"><a href="#JNIçš„åŸºç¡€ç”¨æ³•" class="headerlink" title="JNIçš„åŸºç¡€ç”¨æ³•"></a>JNIçš„åŸºç¡€ç”¨æ³•</h2><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><p>å…ˆæ¥çœ‹ä¸€ä¸ª Android ä¸Šç®€å•çš„JNIä½¿ç”¨ğŸŒ°ã€‚</p>
<p>å…ˆå†™å¦‚ä¸‹è¿™æ ·ä¸€ä¸ªç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.footprint.littleshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by liquanmin on 16/5/11.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> EditText et;</span><br><span class="line">    <span class="keyword">protected</span> Button button;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">static</span>&#123;</span><br><span class="line">		 System.loadLibrary(<span class="string">"test_jni"</span>);</span><br><span class="line">	 &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">getMessage</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.setContentView(R.layout.activity_test);</span><br><span class="line">        initView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (view.getId() == R.id.button) &#123;</span><br><span class="line">            et.setText(getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        et = (EditText) findViewById(R.id.et);</span><br><span class="line">        button = (Button) findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(TestActivity.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç æ‰€ç¤ºï¼Œè¿™ä¸ªç±»å£°æ˜äº†ä¸€ä¸ª native æ–¹æ³•<code>getMessage()</code>ï¼Œç„¶åç¼–è¯‘è¿™ä¸ªç±»ï¼ˆåœ¨ IDE é‡Œé¢å¯ä»¥ç®€å•çš„ä½¿ç”¨<code>Build-&gt;Rebuild Project</code>æ¥è¿›è¡Œï¼‰ã€‚</p>
<p>è¿™ä¸ªç±»æ˜¯å£°æ˜åœ¨<code>com.footprint.littleshell</code>ï¼Œæˆ‘ä»¬è¿›å…¥<code>com</code>æ‰€åœ¨ç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<code>javah -jni com.footprint.littleshell.TestActivity</code>ï¼Œå°±å¯åœ¨<code>com</code>æ‰€åœ¨ç›®å½•ä¸‹é¢å¾—åˆ°å¦‚ä¸‹æ–‡ä»¶ï¼š<code>com_footprint_littleshell_TestActivity.h</code>ã€‚</p>
<blockquote>
<p>ä¸€å®šè¦æ˜¯åŒ…æ‰€åœ¨ç›®å½•ï¼Œè€Œä¸æ˜¯ç¼–è¯‘å‡ºæ¥çš„ class æ–‡ä»¶æ‰€åœ¨ç›®å½•ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨ Mac ä¸‹ï¼Œå‘½ä»¤æ‰§è¡Œå¯èƒ½ä¼šå‡ºç°ä¸­æ–‡ä¹±ç ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è§£å†³ï¼š<code>export JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF-8</code>ã€‚</p>
<p>åœ¨ Android Studio é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡é€‰æ‹©å¯¹åº”çš„classæ–‡ä»¶ï¼Œå³å‡» -&gt; â€œAndroid toolsâ€ -&gt; â€œjavahâ€ç”Ÿæˆå¤´æ–‡ä»¶ï¼›</p>
</blockquote>
<p>è¿™ä¸ª<code>.h</code>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class com_footprint_littleshell_TestActivity */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_com_footprint_littleshell_TestActivity</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_com_footprint_littleshell_TestActivity</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_footprint_littleshell_TestActivity</span></span><br><span class="line"><span class="comment"> * Method:    getMessage</span></span><br><span class="line"><span class="comment"> * Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_footprint_littleshell_TestActivity_getMessage</span><br><span class="line">  (JNIEnv *, jobject);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨ Android ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ NDK æ¥å®Œæˆæ•´ä¸ª JNI çš„å¼€å‘ï¼š</p>
<ol>
<li>å³å‡» Moduleï¼Œé€‰æ‹©â€Newâ€ -&gt; â€œFolderâ€ -&gt; â€œJNI Folderâ€ã€‚è¿™æ ·å°±ä¼šåœ¨å¯¹åº”çš„ Moudle ä¸­ä¸<code>java</code>åŒçº§ç›®å½•å¤„ç”Ÿæˆ<code>jni</code>ç›®å½•ï¼›</li>
<li>å°†åˆšåˆšç”Ÿæˆçš„<code>.h</code>æ–‡ä»¶æ‹·è´åˆ°è¿™ä¸ªç›®å½•ä¸‹é¢ï¼›</li>
<li>åœ¨é¡¹ç›®ä¸­çš„<code>local.properties</code>æ–‡ä»¶ä¸­é…ç½® NDK çš„ä½ç½®ï¼Œæ¯”å¦‚åœ¨æˆ‘çš„ç”µè„‘ä¸Šï¼Œå°±éœ€è¦å¢åŠ å¦‚ä¸‹ä¸€è¡Œ:<code>ndk.dir=/Users/xxx/Documents/xxxx/Software/NDK/android-ndk-r10d</code>ï¼›</li>
</ol>
<p>å®Œæˆä»¥ä¸Šæ­¥éª¤ä¹‹åï¼Œåœ¨<code>jni</code>ç›®å½•ä¸‹é¢æ–°å»ºä¸€ä¸ª<code>.c</code>æ–‡ä»¶å®ç°ä»¥ä¸Šçš„<code>.h</code>æ–‡ä»¶ï¼Œåå­—éšæ„ï¼Œæ¯”å¦‚<code>test_jni.c</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include "com_footprint_littleshell_TestActivity.h"</span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_footprint_littleshell_TestActivity_getMessage</span><br><span class="line">  (JNIEnv *env, jobject obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">"Hello World! It's JNI"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼šæ–‡ä»¶ä¸è¦å†™æˆ<code>cpp</code>æ–‡ä»¶ï¼Œå¦åˆ™ä¼šå‘ç”Ÿé”™è¯¯ï¼Œå…·ä½“å¯ä»¥è§<a href="http://stackoverflow.com/questions/15764948/error-base-operand-of-has-non-pointer-type-jnienv" target="_blank" rel="noopener">error: base operand of â€˜-&gt;â€™ has non-pointer type â€˜JNIEnvâ€™</a>ã€‚</p>
</blockquote>
<p>ä¹‹åï¼Œæˆ‘ä»¬åœ¨è¯¥æ¨¡å—çš„<code>build.gradle</code>ä¸­è¿›è¡Œ ndk çš„é…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">defaultConfig &#123;</span><br><span class="line">	applicationId <span class="string">"com.footprint.littleshell"</span></span><br><span class="line">	minSdkVersion <span class="number">14</span></span><br><span class="line">	targetSdkVersion <span class="number">22</span></span><br><span class="line">	versionCode <span class="number">1</span></span><br><span class="line">	versionName <span class="string">"1.0"</span></span><br><span class="line"></span><br><span class="line">	ndk&#123;</span><br><span class="line">		moduleName <span class="string">"test_jni"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™é‡Œé…ç½® moduleName ä¸ºâ€test_jniâ€â€”â€”æœ€åç”Ÿæˆçš„<code>.so</code>åˆ†äº«åº“çš„åå­—ï¼Œå®é™…ä¼šåœ¨å‰é¢åŠ ä¸Š lib ï¼Œåé¢åŠ ä¸Š .soï¼Œå³æœ€ç»ˆç”Ÿæˆ<code>libtest_jni.so</code>åº“ã€‚</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Android-NDK.png" height="360" alt="Android-NDK"></div>

<p>å¦‚å›¾ï¼Œåœ¨ä¸Šé¢æ–¹æ¡†çš„æ–‡ä»¶å¤¹ä¸­å°±ç”Ÿæˆäº†å¯¹åº”çš„<code>.so</code>åº“ï¼Œåœ¨ä¸<code>java</code>åŒçº§çš„ç›®å½•ä¸­å»ºç«‹ jniLibs ç›®å½•ï¼ŒæŠŠä¸Šé¢æ–¹æ¡† lib ç›®å½•ä¸‹é¢çš„æ–‡ä»¶å¤¹å…¨éƒ¨æ‹·è´è¿‡æ¥(å®é™…å¼€å‘ä¸­ä»¥æ”¯æŒçš„CPUæ¶æ„ä¸ºæ ‡å‡†)ï¼Œè¿™æ ·ï¼Œå°±å®Œæˆäº†<code>.so</code>åº“çš„å¼€å‘ï¼Œåœ¨ Java ä»£ç é‡Œé¢ï¼ŒåŠ ä¸Šå¦‚ä¸‹ä»£ç å³å¯ä½¿ç”¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span>&#123;</span><br><span class="line">	System.loadLibrary(<span class="string">"test_jni"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/jni-demo.png" height="320" alt="JNI demo"></div>

<blockquote>
<p>å…³äºä½¿ç”¨ Android Studio è¿›è¡Œ NDK å¼€å‘ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<a href="http://www.race604.com/android-studio-with-ndk/" target="_blank" rel="noopener">Android Studioä¸­NDKå¼€å‘</a>è¿™ç¯‡æ–‡ç« ã€‚ä»ä¾‹å­çœ‹ï¼Œè¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚</p>
</blockquote>
<h4 id="è§£é‡Š"><a href="#è§£é‡Š" class="headerlink" title="è§£é‡Š"></a>è§£é‡Š</h4><p>ç”Ÿæˆçš„<code>.h</code>å‡½æ•°ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•: <code>JNIEXPORT jstring JNICALL Java_com_footprint_littleshell_TestActivity_getMessage
  (JNIEnv *, jobject);</code>ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆæ˜¯æ–¹æ³•åï¼šè¿™ä¸ªåå­—çœ‹ç€å¾ˆçœ¼ç†Ÿï¼šå®ƒæ˜¯åœ¨ Java å£°æ˜çš„ native æ–¹æ³•åå­—å‰é¢åŠ ä¸Šäº†æ–¹æ³•æ‰€åœ¨ç±»çš„å…¨é™å®šåï¼Œå¹¶å°†åŒ…åˆ†éš”ç¬¦<code>.</code>æ¢æˆ<code>_</code>ï¼Œæœ€ååœ¨å‰é¢åŠ ä¸Š<code>Java_</code>æ¥è¡¨ç¤ºçš„ï¼Œè¯»è€…å¯ä»¥å¤šå†™å‡ ä¸ªå‡½æ•°ï¼Œå°±ä¼šå‘ç°è¿™æ˜¯ä¸€ä¸ªæ™®éè§„å¾‹ã€‚</p>
<p>ä¼ è¿›æ¥çš„ä¸¤ä¸ªå‚æ•°ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<ol>
<li><code>JNIEnv *</code> è¿™ä»£è¡¨ä¸€ä¸ª Java è™šæ‹Ÿæœº(JVM)æ‰€è¿è¡Œçš„ç¯å¢ƒï¼Œä»å®ƒå¯ä»¥è®¿é—®åˆ° JVM å†…éƒ¨çš„å„ç§å¯¹è±¡ï¼›</li>
<li><code>jobject</code> è°ƒç”¨è¯¥å‡½æ•°çš„å¯¹è±¡ï¼Œä¾‹å­ä¸­æ‰€æŒ‡çš„å°±æ˜¯<code>TestActivity</code>ï¼›</li>
</ol>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>æœ¬ç« è¯´æ˜è¯´æåˆ°çš„ä¸‰æœ¬ä¹¦éƒ½æœ‰å…³äº JNI çš„ä»‹ç»ã€‚</p>
<h4 id="é™æ€æ³¨å†Œ"><a href="#é™æ€æ³¨å†Œ" class="headerlink" title="é™æ€æ³¨å†Œ"></a>é™æ€æ³¨å†Œ</h4><p>ä»å‰é¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åœ¨ Java ä¸­è°ƒç”¨ native æ–¹æ³•<code>getMessage()</code>æ—¶ï¼Œå®é™…æ˜¯è¢«æ˜ å°„åˆ°äº†<code>Java_com_footprint_littleshell_TestActivity_getMessage</code>ä¸Šï¼Œé‚£ä¹ˆè¿™ç§æ˜ å°„å…³ç³»æ˜¯å¦‚ä½•å»ºç«‹çš„å‘¢ï¼Ÿ</p>
<p>å‰é¢æè¿°äº†<code>javah</code>å‘½ä»¤ç”Ÿæˆçš„ native å‡½æ•°åç§°çš„ç”±æ¥ï¼Œè¿™å…¶å®æ˜¯ä¸€ç§è§„èŒƒï¼Œè¿™ç§æ˜ å°„å…³ç³»çš„å»ºç«‹ç§°ä¸ºé™æ€æ˜ å°„ï¼šåœ¨<code>.h</code>æ–‡ä»¶ç”Ÿæˆæ—¶ï¼Œå°±æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ç”Ÿæˆæœ¬åœ°æ–¹æ³•åç§°ï¼Œä»è€ŒJVMä¹Ÿèƒ½æ ¹æ®è¿™ç§è§„åˆ™åœ¨ Java è°ƒç”¨ native å‡½æ•°æ—¶ï¼Œæ‰¾åˆ°å¯¹åº”çš„æœ¬åœ°æ–¹æ³•ã€‚</p>
<p>è¿™ç§æ–¹å¼äº§ç”Ÿçš„ native æ–¹æ³•åå­—å¾ˆé•¿ï¼Œä¸ä¾¿äºç®¡ç†ï¼Œå› æ­¤ JNI è¿˜å¯ä»¥è¿›è¡ŒåŠ¨æ€æ³¨å†Œâ€”â€”å¼€å‘è€…å¯ä»¥ä»»æ„å‘½å native å‡½æ•°åç§°ã€‚</p>
<h4 id="åŠ¨æ€æ³¨å†Œ"><a href="#åŠ¨æ€æ³¨å†Œ" class="headerlink" title="åŠ¨æ€æ³¨å†Œ"></a>åŠ¨æ€æ³¨å†Œ</h4><p>é™æ€æ³¨å†Œç”Ÿæˆçš„nativeå‡½æ•°åå­—å†—é•¿ï¼Œè‡ªå·±å»å†™å¤ªéº»çƒ¦ï¼Œè€Œå¦‚æœç›´æ¥ä» class æ–‡ä»¶ç”Ÿæˆï¼Œåˆ™æ¯ä¸€ä¸ª class æ–‡ä»¶éƒ½è¦æ‰§è¡Œ<code>javah</code>å‘½ä»¤ï¼ˆè™½ç„¶å¯èƒ½ä¸æ˜¯å¾ˆå¤šï¼‰ï¼Œè¿™é‡Œæä¾›å¦å¤–ä¸€ç§é€‰æ‹©ï¼šåŠ¨æ€æ³¨å†Œã€‚ä½¿ç”¨è¿™ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»»æ„å‘½å native å‡½æ•°åï¼Œæ‰‹åŠ¨å»ºç«‹ native å‡½æ•°åˆ° Java å‡½æ•°çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>å…ˆæ¥çœ‹çœ‹å¦‚ä½•å®ç°åŠ¨æ€æ³¨å†Œï¼šå¤§è‡´åšæ³•å’Œå‰é¢ä¸€è‡´ï¼Œåªæ˜¯ä¸å†éœ€è¦æ‰§è¡Œ<code>javah</code>å‘½ä»¤ç”Ÿæˆå¤´æ–‡ä»¶ï¼Œåœ¨<code>jni</code>ç›®å½•ä¸‹é¢ï¼Œæˆ‘ä»¬åªéœ€è¦å»ºç«‹ä¸€ä¸ª test_jni.c æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•ä¸€å®šè¦å£°æ˜åœ¨gMethodsä¹‹å‰ï¼Œå¦åˆ™ä¼šæŠ¥æ‰¾ä¸åˆ°æ–¹æ³•çš„é”™è¯¯</span></span><br><span class="line"><span class="function">JNIEXPORT jstring  JNICALL <span class="title">getMessageNative</span><span class="params">(JNIEnv *env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">"Hello World! It's JNI"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">        &#123;<span class="string">"getMessage"</span>,  <span class="string">"()Ljava/lang/String;"</span>,  (<span class="keyword">void</span>*) getMessageNative&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span> *reserved)</span> <span class="comment">//è¿™æ˜¯JNI_OnLoadçš„å£°æ˜ï¼Œå¿…é¡»æŒ‰ç…§è¿™æ ·çš„æ–¹å¼å£°æ˜</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//æ³¨å†Œæ—¶åœ¨JNIEnvä¸­å®ç°çš„ï¼Œæ‰€ä»¥å¿…é¡»é¦–å…ˆè·å–å®ƒ</span></span><br><span class="line">	JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//ä»JavaVMè·å–JNIEnvï¼Œä¸€èˆ¬ä½¿ç”¨1.4çš„ç‰ˆæœ¬</span></span><br><span class="line">	<span class="keyword">if</span>((*vm)-&gt;GetEnv(vm, (<span class="keyword">void</span>**)&amp;env, JNI_VERSION_1_4) != JNI_OK) </span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	jclass clazz;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> clsName=<span class="string">"com/footprint/littleshell/TestActivity"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è¿™é‡Œå¯ä»¥æ‰¾åˆ°è¦æ³¨å†Œçš„ç±»ï¼Œå‰ææ˜¯è¿™ä¸ªç±»å·²ç»åŠ è½½åˆ°javaè™šæ‹Ÿæœºä¸­ã€‚ è¿™é‡Œè¯´æ˜ï¼ŒåŠ¨æ€åº“å’Œæœ‰nativeæ–¹æ³•çš„ç±»ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å¯¹åº”å…³ç³»ã€‚</span></span><br><span class="line">	clazz = (*env)-&gt;FindClass(env, clsName); </span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"cannot get class:%s\n"</span>, clsName);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è¿™é‡Œå°±æ˜¯å…³é”®äº†ï¼ŒæŠŠæœ¬åœ°å‡½æ•°å’Œä¸€ä¸ªjavaç±»æ–¹æ³•å…³è”èµ·æ¥ã€‚ä¸ç®¡ä¹‹å‰æ˜¯å¦å…³è”è¿‡ï¼Œä¸€å¾‹æŠŠä¹‹å‰çš„æ›¿æ¢æ‰ï¼</span></span><br><span class="line">	<span class="keyword">if</span>((*env)-&gt;RegisterNatives(env, clazz, gMethods, <span class="keyword">sizeof</span>(gMethods)/<span class="keyword">sizeof</span>(gMethods[<span class="number">0</span>]))!= JNI_OK)  &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"register native method failed!\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> JNI_VERSION_1_4; <span class="comment">//å¿…é¡»è¿”å›ç‰ˆæœ¬ï¼Œå¦åˆ™åŠ è½½ä¼šå¤±è´¥ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é…ç½®å¥½ gradleï¼ˆå‚è§ä¸Šé¢ï¼‰ï¼Œbuild å·¥ç¨‹ï¼Œæ‹·è´ç”Ÿæˆçš„<code>.so</code>æ–‡ä»¶ï¼Œè¿è¡Œå³å¯ã€‚ä¸‹é¢æˆ‘ä»¬æ¥é‡ç‚¹è§£æè¿™ä¸ª c æ–‡ä»¶çš„å†…å®¹ã€‚</p>
<blockquote>
<p>PS: ä¾‹å­å†…å®¹ä»¥åŠæ³¨é‡Šæ¥è‡ª<a href="http://blog.csdn.net/imyfriend/article/details/9117917" target="_blank" rel="noopener">Java JNI_OnLoadçš„å¦™ç”¨</a>ã€‚</p>
</blockquote>
<p>åŠ¨æ€æ³¨å†ŒåŸºäºä»¥ä¸‹å†…å®¹å®ç°ï¼š</p>
<ol>
<li>å½“ Java å±‚é€šè¿‡<code>System.loadLibrary()</code>åŠ è½½å®ŒJNIåŠ¨æ€åº“åï¼Œç´§æ¥ç€ä¼šæŸ¥æ‰¾è¯¥åº“ä¸­ä¸€ä¸ªå«<code>JNI_OnLoad()</code>çš„å‡½æ•°ï¼Œå¦‚æœæœ‰ï¼Œå°±è°ƒç”¨å®ƒï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢è¿›è¡Œä¸€äº›é¢„å¤‡å·¥ä½œï¼Œæ¯”å¦‚ï¼šé™æ€æ³¨å†Œï¼ˆä¹Ÿå¯ä»¥æ‰‹åŠ¨æš´éœ²ä¸€ä¸ª init æ–¹æ³•å‡ºæ¥ï¼Œåœ¨åŠ è½½å®Œæˆä¹‹åæ‰‹åŠ¨è°ƒç”¨ï¼‰</li>
<li>Java å‡½æ•°åˆ° native å‡½æ•°çš„æ˜ å°„å¯ä»¥ç”±æ•°æ®ç»“æ„<code>JNINativeMethod</code>æ¥è¡¨ç¤ºã€‚</li>
</ol>
<p><code>JNINativeMethod</code>ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">   	<span class="comment">//Javaä¸­nativeå‡½æ•°çš„åå­—ï¼Œä¸ç”¨æºå¸¦åŒ…çš„è·¯å¾„ã€‚ä¾‹å¦‚â€œnative_initâ€œã€‚</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* name;</span><br><span class="line">	<span class="comment">//Javaå‡½æ•°çš„ç­¾åä¿¡æ¯ï¼Œç”¨å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œæ˜¯å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹çš„ç»„åˆã€‚</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* signature;</span><br><span class="line">	<span class="comment">//JNIå±‚å¯¹åº”å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œæ³¨æ„å®ƒæ˜¯void*ç±»å‹ã€‚</span></span><br><span class="line">	<span class="keyword">void</span>*  fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„çš„ä¸‰ä¸ªå­—æ®µçš„å«ä¹‰éƒ½å·²ç»æ³¨é‡Šæ¸…æ¥šï¼Œæ ¹æ®ä¾‹å­æˆ‘ä»¬å†è§£é‡Šä¸€ä¸‹ï¼š</p>
<ol>
<li><code>const char* name;</code> åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å°±æ˜¯<code>getMessage</code>ï¼›</li>
<li><code>const char* signature;</code> è¿™ä¸ªæ˜¯ Java å‡½æ•°çš„ç­¾åä¿¡æ¯ï¼Œå¦‚æœè¦å…¨é¢äº†è§£ï¼Œå»ºè®®è¯»è€…å¯ä»¥å»é˜…è¯»ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹ï¼Œå› ä¸ºæˆ‘ä»¬çš„ class æ–‡ä»¶ä¹Ÿä½¿ç”¨åŒæ ·çš„æ•°æ®ç»“æ„æ¥æè¿°ä¸€ä¸ªæ–¹æ³•ï¼Œè§„èŒƒä¸­æœ‰è¯¦ç»†è¯´æ˜ï¼›</li>
<li><code>void*  fnPtr;</code> æŒ‡å‘æœ¬åœ°æ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆï¼ŒæŠŠ fnPtr æ¢æˆ native å‡½æ•°åç§°å°±å¥½ï¼Œè¿™ä¸ªåå­—ä¸éœ€è¦å†éµå¾ªé™æ€æ³¨å†Œçš„è§„èŒƒï¼›</li>
</ol>
<p>ä»è¿™ä¸ªå…³ç³»å°±å¯ä»¥çœ‹å‡ºæ˜¯è¦ä» Java çš„å“ªä¸ªå‡½æ•°æ˜ å°„åˆ° native çš„å“ªä¸ªå‡½æ•°ã€‚ä¹‹åçš„äº‹æƒ…å¾ˆç®€å•ï¼š<strong>é€šè¿‡ JNIEnv çš„<code>RegisterNatives</code>æ–¹æ³•å‘Šè¯‰ JVM è™šæ‹Ÿæœºæˆ‘è¦ç»™æŸä¸ªç±»ï¼ˆé€šè¿‡ç±»åæŒ‡å®šï¼‰æ³¨å†Œå“ªäº›å‡½æ•°æ˜ å°„ï¼ˆé€šè¿‡ JNINativeMethod æ•°ç»„è¡¨ç¤ºï¼‰ã€‚</strong></p>
<p>æ¯”å¯¹ç¤ºä¾‹ä»£ç åº”è¯¥å¾ˆå¥½ç†è§£ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>JNIå­¦ä¹ é‡ç‚¹ï¼š</p>
<ol>
<li>åŠ è½½åº“â€”â€”ä¸¤ç§æ–¹æ³• &amp; å®ƒä»¬çš„åŒºåˆ«ï¼›</li>
<li>æ–¹æ³•æ˜ å°„â€”â€”æ–¹æ³•å®šä¹‰æ–¹å¼ï¼Œæ–¹æ³•æ˜ å°„æ–¹å¼ï¼›</li>
<li>æ•°æ®ç±»å‹æ˜ å°„â€”â€”é‡ç‚¹æ˜¯å­—ç¬¦ä¸²å’Œæ•°ç»„ï¼›</li>
<li>åå‘è°ƒç”¨â€”â€”C++å±‚è°ƒç”¨Javaå±‚æ–¹æ³•å’Œå±æ€§ï¼Œè°ƒç”¨æ–¹æ³•åŒ…æ‹¬è°ƒç”¨å®ä¾‹æ–¹æ³•ã€é™æ€æ–¹æ³•ã€æ„é€ æ–¹æ³•ã€çˆ¶ç±»æ–¹æ³•ç­‰ï¼›</li>
<li>å¼•ç”¨ç±»å‹å’Œç®¡ç†â€”â€”å±€éƒ¨å¼•ç”¨ï¼Œå…¨å±€å¼•ç”¨ï¼Œå…¨å±€å¼±å¼•ç”¨ä¸‰ç§ï¼›</li>
<li>å¼‚å¸¸å¤„ç†;</li>
</ol>
<p>è¿™é‡Œæ¨èä¸€ä¸ªåšå®¢ç³»åˆ—: <a href="http://blog.csdn.net/xyang81/article/category/2759987" target="_blank" rel="noopener">CSDN@xyang0917â€”â€”JNI</a>ã€‚åšå®¢è®²è¿°æ¯”è¾ƒå…¨ï¼Œè€Œä¸”æœ‰æ¯”è¾ƒè¯¦ç»†çš„ä¾‹å­ï¼Œå¯¹äºå…¥é—¨ &amp; ç†Ÿæ‚‰JNIæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚å½“ç„¶æœ€å…¨é¢çš„æ•™ç¨‹è¿˜æ˜¯åœ¨å®˜ç½‘: <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/design.html" target="_blank" rel="noopener">JNI Interface Functions and Pointers</a>ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android Frameworkå­¦ä¹ é¢„å¤‡]]></title>
      <url>http://www.timebridge.space/2016/05/14/Android-Framewok-Base/</url>
      <content type="html"><![CDATA[<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Android-Arc.png" alt="Androidæ¶æ„å›¾"></p>
<blockquote>
<p>ä»<a href="http://www.webtag123.com/android/index.html" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‰¾åˆ°çš„è¿™å¹…å›¾ï¼Œä¾µåˆ ã€‚</p>
</blockquote>
<p>å¦‚ä¸Šå›¾ï¼Œæ˜¯Androidç³»ç»Ÿçš„æ•´ä½“æ¶æ„å›¾ï¼Œå¼€å‘è€…æ—¥å¸¸ä¸»è¦æ˜¯åŸºäº<strong>Application Framework</strong>æä¾›çš„æ¥å£è¿›è¡Œåº”ç”¨å¼€å‘ã€‚<a id="more"></a></p>
<p>æœ¬ç« è¦ç ”ç©¶çš„å†…å®¹é›†ä¸­äº<strong>Application Framework</strong>ï¼Œä¹Ÿä¼šæ¶‰åŠåˆ°ä¸€äº›<strong>Libraries</strong>çš„å†…å®¹ã€‚å‚è€ƒèµ„æ–™:</p>
<h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><ol>
<li>ã€Šæ·±å…¥ç†è§£Androidå·Iã€‹(é‚“å‡¡å¹³è‘—)ï¼›</li>
<li>ã€ŠAndroidæŠ€æœ¯å†…å¹•(ç³»ç»Ÿå·)ã€‹ï¼ˆæ¨ä¸°ç››è‘—ï¼‰ï¼›</li>
<li>ã€ŠAndroidå†…æ ¸å‰–æã€‹ï¼ˆæŸ¯å…ƒæ—¦è‘—ï¼‰ï¼›</li>
<li><a href="http://my.csdn.net/Luoshengyang" target="_blank" rel="noopener">è€ç½—çš„CSDNåšå®¢</a>ï¼›</li>
</ol>
<h4 id="è¾…åŠ©å‚è€ƒ"><a href="#è¾…åŠ©å‚è€ƒ" class="headerlink" title="è¾…åŠ©å‚è€ƒ"></a>è¾…åŠ©å‚è€ƒ</h4><ol>
<li>ã€ŠLinuxç¨‹åºè®¾è®¡ï¼ˆç¬¬4ç‰ˆï¼‰ã€‹ï¼ˆNeil Matthew &amp; Richard Stonesè‘—ï¼Œé™ˆå¥ &amp; å®‹å¥å»ºè¯‘ï¼‰</li>
</ol>
<blockquote>
<p>é‚“å‡¡å¹³çš„CSDNåšå®¢åœ¨<a href="http://blog.csdn.net/innost" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼ŒåŒæ—¶è¿™é‡Œä¹Ÿæœ‰ã€Šæ·±å…¥ç†è§£Androidã€‹å·Iè‡³å·IIIçš„å…¨éƒ¨å†…å®¹ï¼Œè‰¯å¿ƒåšå®¢ï¼</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Proguard]]></title>
      <url>http://www.timebridge.space/2016/05/12/Android-proguard/</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><strong>Proguard</strong> ä¸»è¦æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ol>
<li>åˆ›å»ºæ›´åŠ ç´§å‡‘çš„ä»£ç ï¼Œè®©æœ€ç»ˆçš„ä»£ç æ›´åŠ å°å·§ï¼Œå¯ä»¥æ›´å¿«çš„åœ¨ç½‘ç»œä¸Šä¼ è¾“ã€åŠ è½½ï¼Œè¿è¡Œæ—¶å¯ä»¥æ¶ˆè€—æ›´å°çš„å†…å­˜ï¼›</li>
<li>æ··æ·†ä»£ç ï¼Œä½¿å¾—ç¨‹åºé€†å‘å·¥ç¨‹èµ·æ¥æ›´åŠ å›°éš¾ï¼›</li>
<li>åˆ—å‡ºæ— ç”¨çš„ä»£ç ï¼Œä»¥ä¾¿äºå¯ä»¥ç§»é™¤å®ƒä»¬ï¼›</li>
<li>é‡æ–°å®šä½ä»¥åŠæ ¡éªŒ Java 6 ä»¥åŠä»¥ä¸Šç‰ˆæœ¬çš„ class æ–‡ä»¶ï¼šæ·»åŠ é¢„æ ¡éªŒä¿¡æ¯åˆ°classæ–‡ä»¶ä¸­å»ï¼Œå‡è½» ClassLoader çš„æ ¡éªŒè´Ÿæ‹…â€”â€”è¯¦ç»†è§£é‡Šå¯è§<a href="http://proguard.sourceforge.net/FAQ.html#preverification" target="_blank" rel="noopener">What is preverification?</a>ï¼›</li>
</ol>
<a id="more"></a><strong>Proguard</strong> æ‰§è¡Œèµ·æ¥çš„é€Ÿåº¦éå¸¸å¿«ï¼Œæ•ˆæœæ˜¾è‘—ï¼Œå¹¶ä¸”åœ¨ Antã€Gradle ç­‰å·¥å…·ä¸Šå·²æœ‰æ’ä»¶å®ç°ã€‚é€šè¿‡ç®€å•çš„æ¨¡æ¿åŒ–çš„é…ç½®åŠ ä¸Šç®€å•çš„å‘½ä»¤è¡Œé€‰é¡¹ï¼Œé€šå¸¸å°±è¶³å¤Ÿå¯¹æˆ‘ä»¬çš„ä»£ç åšå‡ºå‡ºè‰²çš„ä¼˜åŒ–ã€‚<br><br>&gt;1. å…·ä½“çš„ä¼˜åŒ–ç»“æœå¯ä»¥æŸ¥çœ‹<a href="http://proguard.sourceforge.net/results.html" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼›<br>&gt;2. é€šè¿‡åˆ é™¤æ— ç”¨çš„ä»£ç (åŒ…æ‹¬ä¼˜åŒ–åº“æ–‡ä»¶)ä»¥åŠå°†å˜é‡åç±»åç®€åŒ–ï¼Œå¯ä»¥å¤§å¹…åº¦å‡å°åŒ…çš„ä½“ç§¯ï¼›<br>&gt;3. Proguard ä¸“é—¨ä¸º Android å®šåˆ¶äº†ä¸€ä¸ªä¼˜åŒ–å’Œæ··æ·†ç‰ˆæœ¬: <strong>DexGuard</strong>ã€‚å®ƒä¸“æ³¨äº App çš„ä¿æŠ¤ï¼Œå¦å¤–æä¾›è¯¸å¦‚èµ„æºæ··æ·†ã€å­—ç¬¦ä¸²åŠ å¯†ã€ç±»åŠ å¯†ã€dexåˆ‡åˆ†ç­‰åŠŸèƒ½ã€‚å®ƒç›´æ¥åˆ›å»º Dalvik å­—èŠ‚ç ã€‚<br><br><strong>Proguard</strong>å¯¹ä»£ç çš„å¤„ç†è¿‡ç¨‹å¦‚ä¸‹:<br><br><img src="http://7xktd8.com1.z0.glb.clouddn.com/Proguardä¼˜åŒ–è¿‡ç¨‹.png" alt="Proguardä¼˜åŒ–è¿‡ç¨‹"><br>å¦‚å›¾æ‰€ç¤ºï¼Œ<strong>Proguard</strong> è¯»å– Input jarsï¼Œç»è¿‡ä¸€ç³»åˆ—å¤„ç†ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ª Output jarsã€‚ä¼˜åŒ–è¿‡ç¨‹æ˜¯å¯ä»¥å¤šæ¬¡è¿›è¡Œçš„ã€‚<br><br>Proguard è¦æ±‚æŒ‡æ˜ Input jars çš„ Library jars â€”â€” å®ƒä»¬æ˜¯ä½ ç”¨æ¥ç¼–è¯‘ä»£ç çš„åº“æ–‡ä»¶ã€‚åº“æ–‡ä»¶å§‹ç»ˆä¿æŒä¸å˜ã€‚<br><br>### Entry points<br>ä¸ºäº†ç¡®å®šå“ªäº›ä»£ç åº”è¯¥è¢«ä¿ç•™ï¼Œå“ªäº›åº”è¯¥è¢«ä¸¢å¼ƒæˆ–è€…æ··æ·†ï¼Œå¼€å‘è€…åº”è¯¥ä¸ºä»£ç æŒ‡å®šè‹¥å¹²<strong><code>entry points</code></strong>ã€‚è¿™äº› entry points é€šå¸¸æ˜¯æ‹¥æœ‰ main æ–¹æ³•çš„ç±»ï¼Œæˆ–è€…æ˜¯ appletï¼Œmidletsï¼Œactivities ç­‰ç­‰ã€‚<br><br>1. åœ¨å‹ç¼©é˜¶æ®µï¼Œ<strong>Proguard</strong> ä»è¿™äº› entry points å‡ºå‘ï¼ŒæŸ¥æ‰¾ç¡®è®¤å“ªäº›ç±»å’Œå˜é‡æ˜¯è¢«ä½¿ç”¨çš„ï¼Œæ‰€æœ‰å…¶ä½™çš„ç±»ä»¥åŠå˜é‡éƒ½ä¼šè¢«ä¸¢å¼ƒï¼›<br>2. åœ¨ä¼˜åŒ–é˜¶æ®µï¼Œ<strong>Proguard</strong> è¿›ä¸€æ­¥ä¼˜åŒ–ä»£ç ï¼Œé‚£äº›ä¸æ˜¯ entry points çš„ç±»å’Œæ–¹æ³•å¯ä»¥è¢«è®¾ç½®æˆ privateã€final æˆ–è€… static çš„ï¼Œæ²¡æœ‰è¢«ç”¨åˆ°çš„å‚æ•°ä¼šè¢«ç§»é™¤ï¼Œä¸€äº›æ–¹æ³•ä¹Ÿä¼šè¢«å†…è”ï¼›<br>3. åœ¨æ··æ·†é˜¶æ®µï¼Œ<strong>Proguard</strong> é‡å‘½åé‚£äº›é entry points çš„ç±»å’Œæˆå‘˜å˜é‡ï¼Œåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šä¿æŒå®ƒä»¬çš„åå­—ä¸å˜ï¼›<br>4. é¢„éªŒè¯é˜¶æ®µæ˜¯å”¯ä¸€ä¸€ä¸ªä¸éœ€è¦çŸ¥é“ entry points çš„é˜¶æ®µï¼›<br><br>### åå°„<br>è‡ªåŠ¨å¤„ç†ä»£ç åœ¨é¢å¯¹åå°„å’Œè‡ªçœæ—¶éƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚åœ¨ä½¿ç”¨<strong>Proguard</strong> çš„æ—¶å€™ï¼Œé‚£äº›ä¼šè¢«åŠ¨æ€è°ƒç”¨ï¼ˆå³é€šè¿‡åå­—è°ƒç”¨ï¼‰çš„ç±»å’Œå˜é‡éƒ½åº”è¯¥è¢«æ ‡è®°ä¸º entry pointsã€‚ä¸¾ä¸ªğŸŒ° ï¼š<code>Class.forName()</code>å¯èƒ½ä¼šæŒ‡å‘ä»»ä½•çš„è¿è¡Œæ—¶çš„ç±»ï¼Œä¸å¤ªå¯èƒ½çŸ¥é“å“ªäº›ç±»åº”è¯¥ä¿æŒåŸæ¥çš„åå­—ä»¥ä¾›è¿™ä¸ªæ–¹æ³•è°ƒç”¨ï¼ˆç±»åå¯èƒ½æ¥æºäºä»»ä½•åœ°æ–¹ï¼‰ã€‚å› æ­¤å¼€å‘è€…å°±å¿…é¡»åœ¨é…ç½®æ–‡ä»¶ä¸­é€šè¿‡<code>-keep</code>æŒ‡å®šè¿™ä¸ªç±»ã€‚<br><br>ä½†æ˜¯ï¼Œ<strong>Proguard</strong>ä¼šè‡ªåŠ¨æ¢æµ‹å¹¶å¤„ç†ä»¥ä¸‹æƒ…å†µï¼š<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»¥ä¸‹ç±»åæˆ–è€…å˜é‡åéƒ½æ˜¯é€šè¿‡å­—ç¬¦ä¸²å†™æ­»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªéšæ—¶å¯ä»¥æ”¹å˜çš„å˜é‡</span></span><br><span class="line">Class.forName(<span class="string">"SomeClass"</span>)</span><br><span class="line">SomeClass.class</span><br><span class="line">SomeClass.class.getField(<span class="string">"someField"</span>)</span><br><span class="line">SomeClass.class.getDeclaredField(<span class="string">"someField"</span>)</span><br><span class="line">SomeClass.class.getMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> Class[] &#123;&#125;)</span><br><span class="line">SomeClass.class.getMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> Class[] &#123; A.class &#125;)</span><br><span class="line">SomeClass.class.getMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> Class[] &#123; A.class, B.class &#125;)</span><br><span class="line">SomeClass.class.getDeclaredMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> Class[] &#123;&#125;)</span><br><span class="line">SomeClass.class.getDeclaredMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> Class[] &#123; A.class &#125;)</span><br><span class="line">SomeClass.class.getDeclaredMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> Class[] &#123; A.class, B.class &#125;)</span><br><span class="line">AtomicIntegerFieldUpdater.newUpdater(SomeClass.class, <span class="string">"someField"</span>)</span><br><span class="line">AtomicLongFieldUpdater.newUpdater(SomeClass.class, <span class="string">"someField"</span>)</span><br><span class="line">AtomicReferenceFieldUpdater.newUpdater(SomeClass.class, SomeType.class, <span class="string">"someField"</span>)</span><br></pre></td></tr></table></figure>
<p>ç±»åæˆ–è€…å˜é‡çš„åå­—å½“ç„¶å¯èƒ½ä¸åŒï¼Œä½†æ˜¯è¿™ç§æ„å»ºæ¨¡å¼<strong>Proguard</strong>æ˜¯å¯ä»¥è¯†åˆ«çš„ï¼Œå› æ­¤é€šè¿‡ä»¥ä¸Šæ–¹å¼å¼•ç”¨çš„ç±»ä»¥åŠå˜é‡åœ¨å‹ç¼©é˜¶æ®µä¼šè¢«ä¿ç•™ï¼Œè€ŒStringå‚æ•°(æŒ‡çš„æ˜¯è¿™äº›æ–¹æ³•çš„å‚æ•°)ä¼šåœ¨æ··æ·†é˜¶æ®µè¢«æ›¿æ¢ã€‚</p>
<blockquote>
<p>å³<strong>Proguard</strong>ä¼šè¯†åˆ«ä¸€äº›æ¨¡å¼ä¸‹å¯¹ç±»å’Œå˜é‡çš„å¼•ç”¨ï¼Œå¹¶æœºæ™ºçš„åˆ¤æ–­å‡ºå“ªäº›ç±»å’Œå˜é‡éœ€è¦ä¿ç•™æˆ–è€…æ›¿æ¢ã€‚</p>
</blockquote>
<p>å¦å¤–ï¼Œ<strong>Proguard</strong>ä¼šå¯¹ä¿ç•™å“ªäº›ç±»æ˜¯æœ‰å¿…è¦çš„ç»™å‡ºæ„è§ã€‚ä¸¾ä¸ªğŸŒ°ï¼š<strong>Proguard</strong>ä¼šæ³¨æ„åˆ°å¦‚ä¸‹çš„æ„å»ºè¿‡ç¨‹:<code>(SomeClass)Class.forName(variable).newInstance()</code>ï¼Œè¿™æœ‰å¯èƒ½æ„å‘³ç€<code>SomeClass</code>è¿™ä¸ªç±»/æ¥å£ä»¥åŠå®ƒçš„å®ç°éƒ½åº”è¯¥è¢«ä¿ç•™ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œå¹¶ä¸å±äºå‰é¢è¯´åˆ°çš„<strong>Proguard</strong>å¯ä»¥è‡ªåŠ¨è¯†åˆ«çš„æ¨¡å¼ï¼‰ã€‚</p>
<blockquote>
<p>å¸¦æœ‰åå°„çš„ä»£ç è¿˜æ˜¯è¦å¤šåŠ å°å¿ƒã€‚</p>
</blockquote>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>ä½¿ç”¨<strong>Proguard</strong>é€šå¸¸éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œé’ˆå¯¹ä»¥ä¸Šæ¯ä¸€ä¸ªæ­¥éª¤ï¼Œ<strong>Proguard</strong>éƒ½æä¾›äº†ä¸°å¯Œçš„é…ç½®é¡¹ï¼Œå…·ä½“çš„é…ç½®é€‰é¡¹<a href="http://proguard.sourceforge.net/manual/usage.html" target="_blank" rel="noopener">è¿™é‡Œ</a>å¯ä»¥æŸ¥è¯¢ï¼ŒåŒæ—¶ä¹Ÿæœ‰å¾ˆå¤š<a href="http://proguard.sourceforge.net/manual/examples.html" target="_blank" rel="noopener">ä¾‹å­</a>å¯ä»¥å‚è€ƒã€‚å¦å¤–<strong>Proguard</strong>è¿˜æœ‰ä¸€ä¸ªGUIç»„ä»¶å¯ä»¥ä½¿ç”¨ï¼Œ<a href="http://proguard.sourceforge.net/manual/gui.html" target="_blank" rel="noopener">è¿™é‡Œ</a>å¯æŸ¥çœ‹è¯¦ç»†ã€‚</p>
<p>é‡åˆ°é—®é¢˜å¯ä»¥åœ¨<a href="http://proguard.sourceforge.net/manual/troubleshooting.html" target="_blank" rel="noopener">å®˜ç½‘çš„é—®é¢˜åˆ—è¡¨</a>é‡Œé¢æœç´¢ä¸€ä¸‹ã€‚</p>
<h4 id="å…³äºkeep"><a href="#å…³äºkeep" class="headerlink" title="å…³äºkeep"></a>å…³äºkeep</h4><p>keepé€‰é¡¹ï¼Œæ€»å…±æœ‰ä»¥ä¸‹å‡ ç§:</p>
<table>
<thead>
<tr>
<th>Keep</th>
<th>From being removed or renamed</th>
<th>From being renamed</th>
</tr>
</thead>
<tbody>
<tr>
<td>Classes and class members</td>
<td>-keep</td>
<td>-keepnames</td>
</tr>
<tr>
<td>Class members only</td>
<td>-keepclassmembers</td>
<td>-keepclassmembernames</td>
</tr>
<tr>
<td>Classes and class members, if class members present</td>
<td>-keepclasseswithmembers</td>
<td>-keepclasseswithmembernames</td>
</tr>
</tbody>
</table>
<p>å¦‚æœä¸ç¡®è®¤ä½¿ç”¨å“ªä¸€ä¸ªå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨<code>-keep</code>ï¼šè¿™ä¼šä¿è¯æŒ‡å®šçš„ç±»ä»¥åŠç±»æˆå‘˜ä¸ä¼šåœ¨å‹ç¼©é˜¶æ®µè¢«ç§»é™¤æ‰ï¼Œåœ¨æ··æ·†é˜¶æ®µä¸ä¼šè¢«é‡å‘½åã€‚</p>
<blockquote>
<p>ã€æ³¨æ„ï¼ï¼ã€‘  </p>
<ol>
<li>å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªç±»è€Œæ²¡æœ‰æŒ‡å®škeepå®ƒçš„ç±»æˆå‘˜ï¼Œé‚£ä¹ˆ<strong>Proguard</strong>ä»…ä»…ä¼šä¿ç•™ç±»ä»¥åŠå®ƒçš„æ— å‚æ„é€ æ–¹æ³•ä½œä¸ºentry pointsï¼Œå®ƒä»ç„¶å¯èƒ½ä¼šç§»é™¤ã€ä¼˜åŒ–æˆ–è€…æ··æ·†å®ƒçš„ç±»æˆå‘˜ï¼›</li>
<li>å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆ<strong>Proguard</strong>åªä¼šä¿ç•™æ–¹æ³•ä¸ºentry pointsï¼Œå®ƒçš„ä»£ç ä»ç„¶å¯èƒ½è¢«ä¼˜åŒ–æˆ–è€…ä¿®æ”¹ï¼›</li>
</ol>
</blockquote>
<h4 id="Class-Specifications"><a href="#Class-Specifications" class="headerlink" title="Class Specifications"></a>Class Specifications</h4><p><code>keep</code>åé¢è‚¯å®šè·Ÿçš„æ˜¯ä¸€ä¸ªç±»æˆ–è€…ç±»æˆå‘˜çš„æè¿°ç¬¦ï¼Œä»è€Œè¡¨è¾¾<code>keep</code>åº”è¯¥åº”ç”¨åœ¨å“ªäº›åœ°æ–¹ã€‚è¿™ä¸ªæè¿°ç¬¦æ˜¯æœ‰è§„èŒƒçš„ï¼ˆæˆ–è€…ç§°ä¸ºæ¨¡æ¿ï¼‰ï¼Œå³Class Specificationsã€‚</p>
<p>å®ƒçš„æ ¼å¼å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">@annotationtype</span>] [[!]<span class="keyword">public</span>|<span class="keyword">final</span>|<span class="keyword">abstract</span>|@ ...] [!]<span class="class"><span class="keyword">interface</span>|<span class="title">class</span>|<span class="title">enum</span> <span class="title">classname</span></span></span><br><span class="line">    [extends|implements [@annotationtype] classname]</span><br><span class="line">[&#123;</span><br><span class="line">    [<span class="meta">@annotationtype</span>] [[!]<span class="keyword">public</span>|<span class="keyword">private</span>|<span class="keyword">protected</span>|<span class="keyword">static</span>|<span class="keyword">volatile</span>|<span class="keyword">transient</span> ...] &lt;fields&gt; |</span><br><span class="line">                                                                      (fieldtype fieldname);</span><br><span class="line">    [<span class="meta">@annotationtype</span>] [[!]<span class="keyword">public</span>|<span class="keyword">private</span>|<span class="keyword">protected</span>|<span class="keyword">static</span>|<span class="keyword">synchronized</span>|<span class="keyword">native</span>|<span class="keyword">abstract</span>|<span class="keyword">strictfp</span> ...] &lt;methods&gt; |</span><br><span class="line">                                                                                           &lt;init&gt;(argumenttype,...) |</span><br><span class="line">                                                                                           classname(argumenttype,...) |</span><br><span class="line">                                                                                           (<span class="function">returntype <span class="title">methodname</span><span class="params">(argumenttype,...)</span>)</span>;</span><br><span class="line">    [<span class="meta">@annotationtype</span>] [[!]<span class="keyword">public</span>|<span class="keyword">private</span>|<span class="keyword">protected</span>|<span class="keyword">static</span> ... ] *;</span><br><span class="line">    ...</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>æ ¼å¼é‡Œé¢æ¶‰åŠåˆ°ä¸€äº›ç¬¦å·ï¼Œè§£é‡Šå¦‚ä¸‹:</p>
<table>
<thead>
<tr>
<th>ç¬¦å·</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>[]</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td>â€¦</td>
<td>å‰é¢åˆ—å‡ºçš„é€‰é¡¹å¯èƒ½ä»¥ä»»æ„æ•°é‡å‡ºç°</td>
</tr>
<tr>
<td>\</td>
<td></td>
<td>éš”ç¦»ä¸€ç»„å¯é€‰é¡¹</td>
</tr>
<tr>
<td>()</td>
<td>æŠŠæŸä¸€å—è¯´æ˜ç»„åˆåˆ°ä¸€å—</td>
</tr>
</tbody>
</table>
<p><code>class</code>å…³é”®å­—æŒ‡å‘ä»»ä½•çš„æ¥å£æˆ–è€…ç±»ï¼Œ<code>interface</code>åªæŒ‡å‘æ¥å£ã€‚<code>enum</code>åªæŒ‡å‘æšä¸¾ç±»ï¼Œ<code>interface</code>æˆ–è€…<code>enmu</code>åŠ ä¸Š<code>!</code>è¡¨ç¤ºéæ¥å£æˆ–è€…éç±»ã€‚</p>
<p>æ¯ä¸€ä¸ªç±»éƒ½å¿…é¡»ä»¥å…¨é™å®šåå‡ºç°ï¼Œæ¯”å¦‚<code>java.lang.String</code>ï¼Œå†…éƒ¨ç±»åˆ™ä»¥<strong>$</strong>åˆ†å‰²ï¼Œæ¯”å¦‚<code>java.lang.Thread$State</code>ï¼Œç±»åçš„è¡¨è¾¾å¯ä»¥å¸¦æœ‰æ­£åˆ™æè¿°:</p>
<table>
<thead>
<tr>
<th>ç¬¦å·</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>?</td>
<td>åŒ¹é…ä»»ä½•ä¸€ä¸ªå•ä¸€å­—ç¬¦ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬åŒ…ååˆ†å‰²ç¬¦ï¼Œå³<code>.</code>ï¼Œæ¯”å¦‚<code>mypackage.Test?</code>åŒ¹é…<code>mypackage.Test1</code>ï¼Œä½†æ˜¯ä¸åŒ¹é…<code>mypackage.Test12</code></td>
</tr>
<tr>
<td>*</td>
<td>åŒ¹é…ç±»åçš„ä»»ä½•ä¸€éƒ¨åˆ†ï¼Œä½†ä¸åŒ…æ‹¬åŒ…ååˆ†éš”ç¬¦ï¼Œå³<code>.</code>ï¼Œæ¯”å¦‚<code>mypackage.*Test*</code>åŒ¹é…<code>mypackage.Test</code>å’Œ<code>mypackage.YourTestApplication</code>ï¼Œä½†æ˜¯ä¸åŒ¹é…<code>mypackage.mysubpackage.MyTest</code>ï¼Œæˆ–è€…æ›´ç®€å•çš„è¯´ï¼Œ<code>mypackage.*</code>åŒ¹é…<code>mypackage</code>ä¸‹é¢çš„æ‰€æœ‰ç±»ï¼Œä½†ä¸åŒ…æ‹¬å­packageä¸‹é¢çš„ç±»</td>
</tr>
<tr>
<td>**</td>
<td>åŒ¹é…ç±»åçš„ä»»ä½•ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¯ä»¥åŒ…å«ä»»ä½•æ•°é‡çš„åŒ…ååˆ†éš”ç¬¦ï¼Œå³<code>.</code>ï¼Œæ¯”å¦‚<code>**.Test</code>åŒ¹é…é™¤äº†æ ¹åŒ…ä¸‹é¢çš„æ‰€æœ‰çš„åŒ…ä¸­çš„<code>Test</code>ç±»ï¼Œ<code>mypackage.**</code>åŒ¹é…<code>mypackage</code>åŒ…ä»¥åŠå­åŒ…ä¸‹é¢çš„æ‰€æœ‰ç±»ã€‚</td>
</tr>
</tbody>
</table>
<p>å¦å¤–ï¼Œå•ç‹¬çš„<code>*</code>å¯ä»¥è¡¨ç¤ºä»»ä½•ç±»ã€‚</p>
<p><code>extends</code>å’Œ<code>implements</code>é€šå¸¸ç”¨äºé™å®šç±»ï¼Œç›®å‰å®ƒä»¬æ˜¯ç­‰æ•ˆçš„ï¼Œç”¨äºè¡¨è¿°åªæœ‰ç»§æ‰¿/å®ç°æŸä¸ªç±»/æ¥å£çš„ç±»ï¼Œä½†æ˜¯è¿™ä¸ªæ¥å£/ç±»æœ¬èº«ä¸åœ¨è¿™ä¸ªæè¿°ä»¥å†…ã€‚</p>
<p><code>@</code>æè¿°ç¬¦ç”¨äºé™å®šå“ªäº›ä½¿ç”¨ç‰¹å®šçš„æ³¨è§£æè¿°çš„ç±»/ç±»æˆå‘˜ï¼Œ<code>annotationtype</code>çš„æè¿°å’Œç±»åä¸€è‡´ã€‚</p>
<p>å˜é‡å’Œæ–¹æ³•çš„æè¿°å’ŒJavaä¸­çš„å¾ˆåƒï¼Œé™¤äº†æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸åŒ…æ‹¬å‚æ•°åï¼ˆç±»ä¼¼äºJava Docä¸­çš„è¡¨è¿°ï¼‰ï¼Œæè¿°ç¬¦ä¸­å¯ä»¥åŒ…å«ä»¥ä¸‹é€šé…ç¬¦ï¼š</p>
<ol>
<li><strong><code>&lt;init&gt;</code></strong> åŒ¹é…ä»»ä½•ä¸€ä¸ªæ„é€ å‡½æ•°ï¼›</li>
<li><strong><code>&lt;fields&gt;</code></strong> åŒ¹é…ä»»ä½•ä¸€ä¸ªå˜é‡ï¼›</li>
<li><strong><code>&lt;methods&gt;</code></strong> åŒ¹é…ä»»ä½•çš„æ–¹æ³•ï¼›</li>
<li><strong><code>*</code></strong> åŒ¹é…ä»»ä½•çš„å˜é‡å’Œæ–¹æ³•ï¼› </li>
</ol>
<p>ä»¥ä¸Šè¿™äº›æè¿°ä¸åŒ…å«ä»»ä½•çš„è¿”å›å€¼ï¼Œåªæœ‰<code>&lt;init&gt;</code>æœ‰ä¸€ä¸ªå‚æ•°åˆ—è¡¨ã€‚å˜é‡å’Œæ–¹æ³•åå­—å¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥åŒ…å«<code>?</code>å’Œ<code>*</code>ï¼Œå«ä¹‰å’Œå‰é¢ä¸€è‡´ï¼Œæè¿°ç¬¦ä¸­çš„ç±»å‹ä¹Ÿå¯ä»¥åŒ…å«ä»¥ä¸‹é€šé…ç¬¦ï¼š</p>
<ol>
<li><strong><code>%</code></strong> åŒ¹é…ä»»ä½•ä¸€ä¸ªåŸå§‹ç±»å‹ï¼ˆbooleanã€intç­‰ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬voidï¼‰ï¼›</li>
<li><strong><code>?</code></strong> åœ¨ç±»ï¼ˆæ¯”å¦‚å‚æ•°ã€è¿”å›å€¼ï¼‰åä¸­åŒ¹é…ä»»ä½•ä¸€ä¸ªå­—ç¬¦ï¼›</li>
<li><strong><code>*</code></strong> ä¹Ÿæ˜¯ç”¨äºç±»åï¼Œå’Œå‰é¢ç±»åçš„æè¿°ä¸­å…³äº<code>*</code>çš„æè¿°ä¸€è‡´ï¼›</li>
<li><strong><code>**</code></strong> ä¹Ÿæ˜¯ç”¨äºç±»åï¼Œå’Œå‰é¢ç±»åçš„æè¿°ä¸­å…³äº<code>**</code>çš„æè¿°ä¸€è‡´ï¼›</li>
<li><strong><code>***</code></strong> åŒ¹é…ä»»ä½•ç±»å‹ï¼šåŸå§‹ç±»å‹ã€éåŸå§‹ç±»å‹ã€æ•°ç»„ç­‰ï¼›</li>
<li><strong><code>Â·Â·Â·</code></strong> åŒ¹é…ä»»ä½•æ•°é‡çš„ä»»ä½•ç±»å‹å‚æ•°ï¼›</li>
</ol>
<p>è¦æ³¨æ„: <code>?</code>ã€<code>*</code>å’Œ<code>**</code>æ°¸è¿œä¸ä¼šåŒ¹é…åŸå§‹ç±»å‹ï¼Œåªæœ‰<code>***</code>å¯ä»¥åŒ¹é…ä¸Šä»»ä½•ç»´åº¦çš„æ•°ç»„ã€‚ä¸¾ä¸ªä¾‹å­ï¼š<code>** get*()</code>åŒ¹é…<code>java.lang.Object getObject()</code>ï¼Œä½†æ˜¯ä¸ä¼šåŒ¹é…<code>float getFloat()</code>æˆ–è€…<code>java.lang.Object[] getObjects()</code>ã€‚</p>
<p>æ„é€ å‡½æ•°æ˜¯å¯ä»¥ç›´æ¥åªç”¨ç±»åæˆ–è€…å…¨é™å®šç±»åè¿›è¡Œæè¿°çš„ï¼Œå› ä¸ºåœ¨Javaä¸­ï¼Œæ„é€ å‡½æ•°æœ‰å‚æ•°åˆ—è¡¨ï¼Œå´æ²¡æœ‰è¿”å›å€¼ã€‚</p>
<p>ç±»å’Œå˜é‡è®¿é—®æ§åˆ¶ç¬¦é€šå¸¸æ˜¯ç”¨æ¥ç»™æ›´ä¸¥æ ¼çš„é™åˆ¶é€šé…ç¬¦â€”â€”ç±»å’Œå˜é‡å¿…é¡»æœ‰ä¸€è‡´çš„è®¿é—®æ§åˆ¶ç¬¦ï¼ŒåŒæ ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>!</code>æ¥è¡¨ç¤ºä¸èƒ½è®¾ç½®è¿™æ ·çš„è®¿é—®æ§åˆ¶ç¬¦ã€‚</p>
<p>Proguardç”šè‡³æ”¯æŒåªæœ‰ç¼–è¯‘å™¨æ‰å¯ä»¥è®¾ç½®çš„æ§åˆ¶ç¬¦ï¼š<code>synthetic</code>ï¼Œ<code>bridge</code>å’Œ<code>varargs</code>ã€‚</p>
<blockquote>
<p>ã€æ³¨ã€‘ä»¥ä¸Šç¿»è¯‘è‡ª<a href="http://proguard.sourceforge.net/manual/usage.html" target="_blank" rel="noopener">å®˜ç½‘Usage</a>ã€‚å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡å‡ºã€‚</p>
</blockquote>
<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><p>åœ¨Androidä¸Šï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å¯ç”¨<strong>Proguard</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            shrinkResources <span class="keyword">true</span></span><br><span class="line">            <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(â€˜proguard-android.txt<span class="string">'),</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">                    '</span>proguard-rules.pro<span class="string">'</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    ...</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">&#125;</span></span></span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>minifyEnabled</code>çš„è®¾ç½®ï¼Œå¯ä»¥å¯¹ä»£ç è¿›è¡Œå‹ç¼©ä¼˜åŒ–ï¼›é€šè¿‡<code>shrinkResources</code>çš„è®¾ç½®ï¼Œå¯ä»¥å¯¹ä»£ç è¿›è¡Œèµ„æºä¼˜åŒ–ï¼›<code>proguardFiles</code>è®¾ç½®åˆ™ç”¨äºæä¾›å‹ç¼©è§„åˆ™ï¼š</p>
<ol>
<li><code>getDefaultProguardFile(â€˜proguard-android.txt&#39;)</code>æ–¹æ³•ä¼šä»Android SDKä¸‹çš„<code>tools/proguard/</code>ç›®å½•è¯»å–<strong>Proguard</strong>çš„é»˜è®¤é…ç½®ï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶<code>proguard-android-optimize.txt</code>ï¼Œå®ƒä¸ä»…åŒ…å«ç›¸åŒçš„è§„åˆ™ï¼Œè€Œä¸”ä¼šåœ¨å­—èŠ‚ç å±‚çº§å¯¹APKè¿›è¡Œåˆ†æï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–APKæ–‡ä»¶ï¼Œå¯ä»¥å°è¯•ï¼›</li>
<li><code>proguard-rules.pro</code>æ–‡ä»¶æ˜¯å¼€å‘è€…è‡ªå®šä¹‰è§„åˆ™çš„åœ°æ–¹ï¼Œè¯¥æ–‡ä»¶é»˜è®¤ä¸<code>build.gradle</code>æ–‡ä»¶åŒçº§ï¼›</li>
</ol>
<p>èµ„æºä¼˜åŒ–åœ¨ä»£ç å‹ç¼©ä¹‹åï¼Œå› ä¸ºåªæœ‰ç§»é™¤ä¸éœ€è¦çš„ä»£ç ä¹‹åæ‰å¯ä»¥åˆ¤æ–­å“ªäº›èµ„æºæ— ç”¨ã€‚</p>
<blockquote>
<p>ç›®å‰èµ„æºä¼˜åŒ–å¯¹äº<code>values/</code>æ–‡ä»¶å¤¹ä¸‹é¢çš„èµ„æºä¸åšç§»é™¤ï¼Œå› ä¸ºAAPTï¼ˆAndroid Asset Packaging Toolï¼‰ä¸å…è®¸ã€‚</p>
</blockquote>
<p>ä»¥ä¸‹è¿™ç§æ–¹å¼å¯ä»¥ä¸ºæŸç§ç‰¹æ®Šçš„build variantæ·»åŠ æ–°çš„æ··æ·†è§„åˆ™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>,</span></span><br><span class="line"><span class="function">                   'proguard-rules.pro'</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    productFlavors </span>&#123;</span><br><span class="line">        flavor1 &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        flavor2 &#123;</span><br><span class="line">            proguardFile <span class="string">'flavor2-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Build Type  + Product Flavor = Build Variant</p>
<p>æ³¨æ„ï¼Œè¿™é‡Œåœ¨flavor2ä¸­è®¾ç½®çš„é…ç½®æ–‡ä»¶ä¸buildTypesä¸­çš„æ˜¯è¿½åŠ å…³ç³»ï¼Œä¸æ˜¯æ›¿ä»£å…³ç³»ã€‚</p>
</blockquote>
<h3 id="è¾“å‡ºæ–‡ä»¶"><a href="#è¾“å‡ºæ–‡ä»¶" class="headerlink" title="è¾“å‡ºæ–‡ä»¶"></a>è¾“å‡ºæ–‡ä»¶</h3><p>æ··æ·†åï¼Œä¼šåœ¨<code>&lt;module-name&gt;/build/outputs/mapping/release/</code>ç›®å½•ä¸‹è¾“å‡ºä¸‹é¢çš„æ–‡ä»¶ï¼š</p>
<ol>
<li><strong>dump.txt</strong> æè¿°apkæ–‡ä»¶ä¸­æ‰€æœ‰ç±»æ–‡ä»¶é—´çš„å†…éƒ¨ç»“æ„ï¼›</li>
<li><strong>mapping.txt</strong> æä¾›äº†åŸå§‹çš„ç±»ï¼Œæ–¹æ³•ï¼Œå’Œå­—æ®µåä¸æ··æ·†åä»£ç ä¹‹é—´çš„æ˜ å°„ï¼›</li>
<li><strong>seeds.txt</strong> åˆ—å‡ºäº†æœªè¢«æ··æ·†çš„ç±»å’Œæˆå‘˜ï¼›</li>
<li><strong>usage.txt</strong> åˆ—å‡ºäº†ä»apkä¸­åˆ é™¤çš„ä»£ç ï¼›</li>
</ol>
<h3 id="å®šä¹‰ä»£ç ä¿ç•™"><a href="#å®šä¹‰ä»£ç ä¿ç•™" class="headerlink" title="å®šä¹‰ä»£ç ä¿ç•™"></a>å®šä¹‰ä»£ç ä¿ç•™</h3><p>æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨é»˜è®¤çš„<strong>Proguard</strong>é…ç½®æ–‡ä»¶<code>proguard-android.txt</code>å°±è¶³å¤Ÿäº†ï¼Œ<strong>Proguard</strong>ä»…ä»…ä¼šç§»é™¤æ‰€æœ‰çš„æœªä½¿ç”¨ä»£ç ï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µ<strong>Proguard</strong>å¾ˆéš¾åˆ¤æ–­ï¼Œå¯èƒ½ä¼šç§»é™¤ä¸€äº›ä¸è¯¥è¢«ç§»é™¤çš„ä»£ç ï¼Œæ¯”å¦‚:</p>
<ol>
<li>ä¸€ä¸ªä»…ä»…åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­ä½¿ç”¨çš„ç±»ï¼›</li>
<li>ä»JNIè°ƒç”¨çš„æ–¹æ³•ï¼›</li>
<li>è¿è¡Œæ—¶æ“ä½œçš„ä»£ç ï¼ˆæ¯”å¦‚åå°„å’Œè‡ªçœï¼‰ï¼›</li>
</ol>
<p>è¿™éƒ¨åˆ†ä»£ç éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸Šæåˆ°çš„è¾“å‡ºæ–‡ä»¶è¾…åŠ©æ’æŸ¥ã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸‹é…ç½®è¯­å¥è¿›è¡Œä»£ç ä¿ç•™:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ç§åŠæ³•å°±æ˜¯ä½¿ç”¨<code>@Keep</code>æ³¨è§£ï¼Œåœ¨ç±»ä¸Šä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œæ•´ä¸ªç±»éƒ½ä¼šä¿æŒåŸæ ·ï¼Œåœ¨æ–¹æ³•/å˜é‡ä¸Šä½¿ç”¨è¯¥æ³¨è§£ï¼Œåˆ™è¢«æ³¨è§£çš„æ–¹æ³•/å˜é‡ä»¥åŠå®ƒä»¬çš„æ‰€åœ¨ç±»éƒ½ä¼šä¿æŒåŸå°ä¸åŠ¨ï¼Œä¸è¿‡è¿™ä¸ªä½¿ç”¨è¿™ä¸ªæ³¨è§£éœ€è¦æ·»åŠ <code>Annotations Support Library</code>ä¾èµ–ã€‚</p>
<p>å…³äºèµ„æºçš„ä¼˜åŒ–ï¼Œ<a href="http://developer.android.com/intl/zh-cn/tools/help/proguard.html" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸Šæœ‰æ¯”è¾ƒè¯¦ç»†çš„æè¿°ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä¸æ•´ç†äº†ã€‚åŒä»£ç ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥å¯¹èµ„æºè¿›è¡Œä¿ç•™ï¼Œä½†æ˜¯å¯¹äºé‡å¤çš„èµ„æºã€å¤šè¯­è¨€èµ„æºã€é€šè¿‡Idå¼•ç”¨çš„èµ„æºéƒ½æœ‰å¯é€‰çš„é…ç½®ã€‚</p>
<p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªé…ç½®ä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">-injars      bin/classes</span><br><span class="line">-injars      libs</span><br><span class="line">-outjars     bin/classes-processed.jar</span><br><span class="line">-libraryjars /usr/local/java/android-sdk/platforms/android-<span class="number">9</span>/android.jar</span><br><span class="line"></span><br><span class="line">-dontpreverify</span><br><span class="line">-repackageclasses <span class="string">''</span></span><br><span class="line">-allowaccessmodification</span><br><span class="line">-optimizations !code/simplification/arithmetic</span><br><span class="line">-keepattributes *Annotation*</span><br><span class="line"></span><br><span class="line">-keep <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> * <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Activity</span></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">public</span> <span class="title">class</span> * <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Application</span></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">public</span> <span class="title">class</span> * <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Service</span></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">public</span> <span class="title">class</span> * <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">BroadcastReceiver</span></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">public</span> <span class="title">class</span> * <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">ContentProvider</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">-<span class="title">keep</span> <span class="title">public</span> <span class="title">class</span> * <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">view</span>.<span class="title">View</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(android.content.Context);</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(android.content.Context, android.util.AttributeSet);</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(android.content.Context, android.util.AttributeSet, <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> set*(...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclasseswithmembers <span class="class"><span class="keyword">class</span> * </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(android.content.Context, android.util.AttributeSet);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclasseswithmembers <span class="class"><span class="keyword">class</span> * </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(android.content.Context, android.util.AttributeSet, <span class="keyword">int</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> * <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">Context</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> *(android.view.View);</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> *(android.view.MenuItem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> * <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ** CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> **.<span class="title">R</span>$* </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;fields&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> * </span>&#123;</span><br><span class="line">    <span class="meta">@android</span>.webkit.JavascriptInterface &lt;methods&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åæ··æ·†"><a href="#åæ··æ·†" class="headerlink" title="åæ··æ·†"></a>åæ··æ·†</h3><p>å¯¹äºæ‰“å°å‡ºçš„Crash Logç­‰ä¿¡æ¯ï¼Œå› ä¸ºè¢«æ··æ·†çš„åŸå› ï¼Œå¯¼è‡´è¿™äº›ä¿¡æ¯é˜…è¯»èµ·æ¥éå¸¸å›°éš¾ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·<strong>ç¿»è¯‘</strong>ä¸€ä¸‹è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retrace.bat|retrace.sh [-verbose] mapping.txt [&lt;stacktrace_file&gt;]</span><br></pre></td></tr></table></figure>
<p><code>retrace</code>æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œä½äº<code>&lt;sdk-root&gt;/tools/proguard/</code>ç›®å½•ä¸‹é¢(åœ¨Windowsä¸Šæ˜¯<code>retrace.bat</code>ï¼Œåœ¨Mac/Linuxä¸Šæ˜¯<code>retrace.sh</code>ã€‚)ã€‚</p>
<p><a href="http://proguard.sourceforge.net/" target="_blank" rel="noopener">å®˜ç½‘</a>ä¹Ÿæœ‰ç›¸å…³çš„æ–‡æ¡£ï¼Œç‚¹å‡»Retrace Manualä¸‹é¢çš„ä¸‰ä¸ªTabå°±å¯ä»¥çœ‹åˆ°ä»‹ç»ã€ä½¿ç”¨æ–¹å¼ä»¥åŠä¾‹å­ã€‚</p>
<blockquote>
<p>Google Playè‡ªåŠ¨åœ¨æ”¯æŒåæ··æ·†ï¼Œå¯è§<a href="https://support.google.com/googleplay/android-developer/answer/6295281" target="_blank" rel="noopener">å¸®åŠ©ä¸­å¿ƒ</a>ã€‚</p>
</blockquote>
<h2 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h2><p>ä½¿ç”¨<strong>Proguard</strong>çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ä¸€äº›æŠ€æœ¯é—®é¢˜ï¼Œå®ƒä»¬éƒ½å¾ˆå®¹æ˜“è§„é¿æˆ–è€…è§£å†³:</p>
<ol>
<li><strong>Proguard</strong>çš„ä¼˜åŒ–ç®—æ³•ä¼šå‡è®¾è¢«å¤„ç†çš„ä»£ç ä¸ä¼šæ•…æ„æŠ›å‡ºNPE/ArrayIndexOutOfBoundsExceptions/OutOfMemoryErrors/StackOverflowErrorsæ¥è¾¾åˆ°æŸä¸ªç›®çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ<code>myObject.myMethod()</code>è¿™æ ·çš„æ–¹æ³•è°ƒç”¨å®Œå…¨æ— æ•ˆï¼Œå®ƒå¯èƒ½ä¼šç§»é™¤å®ƒï¼Œå®ƒå¿½ç•¥<code>myObject</code>æ˜¯nullçš„å¯èƒ½æ€§ï¼ˆä¹Ÿå³ï¼šå¿½ç•¥å¼€å‘è€…é€šè¿‡è¿™ç§æ–¹å¼æŠ›å‡ºNPEé”™è¯¯çš„æ„å›¾ï¼‰ã€‚æŸäº›æ—¶å€™è¿™æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œä¼˜åŒ–åçš„ä»£ç ä¼šæŠ›å‡ºæ›´å°‘çš„å¼‚å¸¸ã€‚ä½†å¦‚æœè¿™ä¸ªå‡è®¾æ˜¯é”™è¯¯çš„ï¼Œå¼€å‘è€…åº”è¯¥ä½¿ç”¨<code>-dontoptimize</code>å…³é—­ä¼˜åŒ–åŠŸèƒ½ï¼›</li>
<li><strong>Proguard</strong>çš„ä¼˜åŒ–ç®—æ³•ä¹Ÿä¼šå‡è®¾è¢«å¤„ç†çš„ä»£ç ä¸ä¼šæœ‰<code>busy-waiting loops without at least testing on a volatile field</code>(ç¿»è¯‘ä¸å¥½ï¼Œå¤§æ¦‚æ˜¯è¯´é€šè¿‡ä¸€ä¸ªæ— é™å¾ªç¯å»æ£€æµ‹ä¸€ä¸ªévolatileå˜é‡)ï¼Œå› æ­¤å®ƒä¹Ÿä¼šç§»é™¤æ­¤ç±»ä»£ç ã€‚å¦‚æœè¿™é¡¹å‡è®¾æ˜¯é”™è¯¯çš„ï¼Œå¼€å‘è€…åº”è¯¥ä½¿ç”¨<code>-dontoptimize</code>å…³é—­ä¼˜åŒ–åŠŸèƒ½ï¼›</li>
<li>å¦‚æœInput jarså’ŒLibrary jarsåœ¨æœ‰classåœ¨åŒä¸€ä¸ªåŒ…ä¸‹é¢ï¼Œåˆ™æ··æ·†åçš„Output jarsæœ‰å¯èƒ½ä¼šåŒ…å«ä¸€äº›ä¸Library jarsåŒåçš„ç±»æ–‡ä»¶ï¼Œå°¤å…¶å½“Library jarsä¹‹å‰å°±è¢«æ··æ·†è¿‡ã€‚å› æ­¤Input jarså’ŒLibrary jarsä¸åº”è¯¥å…±äº«ä¸€ä¸ªåŒ…ï¼›</li>
</ol>
<h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><p>å…·ä½“è§<a href="http://proguard.sourceforge.net/FAQ.html" target="_blank" rel="noopener">å®˜ç½‘</a>ã€‚è¿™é‡Œæ•´ç†å‡ ä¸ªé‡è¦çš„ç»“è®ºï¼š</p>
<ol>
<li><strong>Proguard</strong>ä¼šè‡ªåŠ¨å¤„ç†<code>Class.forName(&quot;SomeClass&quot;)</code>å’Œ<code>SomeClass.class</code>çš„å¤„ç†æƒ…å†µï¼Œåœ¨å‹ç¼©é˜¶æ®µï¼Œè¿™äº›ç±»ä¼šè¢«ä¿ç•™ï¼Œåœ¨æ··æ·†é˜¶æ®µï¼Œè¿™äº›ç±»ä¹Ÿä¼šè¢«æ›¿æ¢æ‰ï¼›</li>
<li>å¯¹äºèµ„æºã€Stringä»¥åŠæµç¨‹æ§åˆ¶çš„æ··æ·†ï¼Œç›´æ¥çœ‹å®˜ç½‘ï¼›</li>
<li><strong>Proguard</strong>æ”¯æŒå¢é‡å¼æ··æ·†â€”â€”å³æä¾›ä¸€ä¸ªä¹‹å‰çš„mappingæ–‡ä»¶è¿›è¡Œä¸€æ¬¡æ–°çš„æ··æ·†ï¼›</li>
<li><strong>Proguard</strong>å…è®¸è‡ªå®šä¹‰æ··æ·†å­—å…¸ï¼›</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Systrace]]></title>
      <url>http://www.timebridge.space/2016/05/10/Android-Systrace/</url>
      <content type="html"><![CDATA[<p>å½“æˆ‘ä»¬å¼€å‘åº”ç”¨ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›åº”ç”¨ä½¿ç”¨èµ·æ¥éå¸¸é¡ºç•…ï¼Œåˆ·æ–°é¡µé¢çš„æ—¶å€™å§‹ç»ˆå¯ä»¥è¾¾åˆ°60å¸§æ¯ç§’çš„é€Ÿåº¦ã€‚ä½†æ˜¯å¦‚æœå› ä¸ºæŸäº›åŸå› å¯¼è‡´ä¸¢å¸§ï¼Œæˆ‘ä»¬è¦åšçš„ç¬¬ä¸€æ­¥äº‹æƒ…å°±æ˜¯ææ¸…æ¥šç³»ç»Ÿåˆ°åº•åœ¨åšä»€ä¹ˆã€‚</p>
<blockquote>
<p>Systraceå…è®¸è·å–Androidç³»ç»Ÿçš„ä¿¡æ¯ï¼Œç§°ä¸º<strong>trace</strong>ã€‚å®ƒä¼šå±•ç°æ—¶é—´ä»¥åŠCPUæ—¶é—´ç‰‡è¢«ç”¨åˆ°äº†å“ªé‡Œï¼Œåœ¨ç»™å®šçš„æ—¶é—´å†…ï¼Œæ¯ä¸ªè¿›ç¨‹å’Œçº¿ç¨‹åœ¨åšä»€ä¹ˆäº‹æƒ…ï¼Œå®ƒè¿˜ä¼šé«˜äº®æœ‰é—®é¢˜çš„traceä¿¡æ¯ï¼Œå¹¶ç»™å‡ºä¿®å¤æ„è§ã€‚<a id="more"></a></p>
</blockquote>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><img src="http://7xktd8.com1.z0.glb.clouddn.com/systrace_overview.png" alt="An example Systrace, showing 5 seconds of scrolling an app when it is not performing well."></p>
<p>ä¸Šå›¾å±•ç¤ºäº†ä¸€ä¸ªæ¸²æŸ“èµ·æ¥å¹¶ä¸é¡ºç•…çš„Appæ‰€è¢«æ•æ‰åˆ°çš„traceä¿¡æ¯ï¼Œå±•ç¤ºçš„ä¿¡æ¯ç»„æœ‰Kernelã€SurfaceFlingerï¼ˆAndroidçš„compositorè¿›ç¨‹ï¼‰ï¼Œç„¶åæ˜¯Appè¿›ç¨‹ï¼ˆå¯ä»¥çœ‹åˆ°è¿›ç¨‹åï¼‰ï¼Œæ¯ä¸€ä¸ªAppè¿›ç¨‹éƒ½åŒ…å«æ‰€æœ‰å®ƒæ‰€å«æœ‰çš„çº¿ç¨‹çš„traceä¿¡å·ã€‚</p>
<p>å…³äºå¦‚ä½•äº§ç”Ÿä¸€ä¸ªtraceæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹<a href="http://developer.android.com/intl/zh-cn/tools/performance/systrace/index.html" target="_blank" rel="noopener">å®˜ç½‘</a>ã€‚è¿™é‡Œæœ‰ä¸ª<a href="http://7xktd8.com1.z0.glb.clouddn.com/trace.html" target="_blank" rel="noopener">ç¤ºä¾‹æ–‡ä»¶</a>ï¼Œå¯ä»¥ä¸‹è½½ã€‚</p>
<h2 id="Analyzing-a-Trace"><a href="#Analyzing-a-Trace" class="headerlink" title="Analyzing a Trace"></a>Analyzing a Trace</h2><p><img src="http://7xktd8.com1.z0.glb.clouddn.com/traceè§†å›¾.png" alt="Traceæ–‡ä»¶è§†å›¾"></p>
<p>å½“äº§ç”Ÿtraceæ–‡ä»¶ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€htmlæ–‡ä»¶äº†ã€‚</p>
<blockquote>
<p>å®é™…ä½¿ç”¨chromeç›´æ¥æ‰“å¼€traceæ–‡ä»¶çš„æ—¶å€™ï¼Œé‡åˆ°å¦‚ä¸‹é”™è¯¯: <code>Could not find an importer for the provided eventData.</code>ã€‚è§£å†³æ–¹æ¡ˆæ˜¯:</p>
<ol>
<li>åœ¨chromeä¸­æ‰“å¼€é“¾æ¥<code>chrome://tracing</code>;</li>
<li>åœ¨æ‰“å¼€çš„é¡µé¢çš„å·¦ä¸Šè§’æœ‰ä¸€ä¸ªLoadæŒ‰é’®(è§å›¾ä¸­<code>A</code>å¤„)ï¼Œç‚¹å‡»é€‰æ‹©traceæ–‡ä»¶ï¼Œæ‰“å¼€å³å¯ï¼›</li>
</ol>
<p>å¦å¤–ï¼Œçœ‹å›¾çš„æ—¶å€™è®°ä½ä¸€å¥è¯ï¼š A well-behaved application executes many small operations quickly and with a regular rhythm, with individual operations completing within few milliseconds, depending on the device and the processes being performedã€‚</p>
</blockquote>
<p>æ¯ä¸€ä¸ªæ¸²æŸ“å¸§çš„Appéƒ½ä¼šå±•ç°ä¸€è¡Œframeåœ†åœˆï¼ˆè§<code>C</code>å¤„ï¼‰â€”â€”é€šå¸¸æ˜¯ç»¿è‰²çš„ï¼Œå¦‚æœåœ†åœˆæ˜¯é»„è‰²æˆ–è€…çº¢è‰²çš„ï¼Œé‚£å°±è¡¨æ˜è¿™ä¸€å¸§è¶…è¿‡äº†16.6msçš„å¸§æ¸²æŸ“æ—¶é—´é™åˆ¶ã€‚æ”¾å¤§è§†å›¾å°±å¯ä»¥çœ‹æ¸…æ¥šå“ªäº›å½±å“Appé¡ºæ»‘çš„å¸§äº†ï¼ˆè§<code>D</code>å¤„ï¼‰ã€‚</p>
<blockquote>
<p><a href="http://developer.android.com/intl/zh-cn/tools/help/systrace.html" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸Šåˆ—å‡ºäº†å…³äºè¯¥å·¥å…·çš„ä¸€äº›å‘½ä»¤è¡Œå’Œå¿«æ·é”®ã€‚</p>
</blockquote>
<p>ç‚¹å‡»æŸä¸€ä¸ªframeåœ†åœˆï¼Œè¿™ä¸ªåœ†åœˆå°±ä¼šè¢«é«˜äº®ï¼Œä»è€Œèšç„¦åˆ°ç»˜åˆ¶è¿™ä¸€å¸§çš„æ—¶å€™æ‰€åšçš„å·¥ä½œä¸Šã€‚åœ¨è¿è¡Œç€5.0ä»¥åŠæ›´é«˜ç‰ˆæœ¬ç³»ç»Ÿçš„è®¾å¤‡ä¸Šï¼Œå·¥ä½œå‘—åˆ†ä¸ºUIçº¿ç¨‹å’ŒReaderçº¿ç¨‹ï¼Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸Šï¼Œåˆ›å»ºå¸§çš„æ‰€æœ‰å·¥ä½œéƒ½æ˜¯åœ¨UIçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ã€‚</p>
<p>åœ¨è¿™ä¸€å¸§ä¸Šç‚¹å‡»ä¸åŒçš„éƒ¨åˆ†ï¼ˆå³<code>D</code>å¤„ä¸åŒçš„è‰²å—ï¼‰ï¼Œå¯ä»¥æŸ¥çœ‹å®ƒä»¬è€—æ—¶å¤šå°‘ã€‚é€‰ä¸­frameåœ†åœˆæˆ–è€…æŸä¸€ä¸ªéƒ¨åˆ†ï¼Œåœ¨<code>E</code>å¤„éƒ½å¯ä»¥çœ‹åˆ°ç›¸å…³çš„æœ‰ç”¨ä¿¡æ¯ï¼Œå³Alertã€‚</p>
<h3 id="Investigating-Alerts"><a href="#Investigating-Alerts" class="headerlink" title="Investigating Alerts"></a>Investigating Alerts</h3><p>Systraceä¼šå¯¹traceä¸­çš„ä¿¡æ¯åšä¸€äº›è‡ªåŠ¨åˆ†æï¼Œç„¶åå°†å­˜åœ¨çš„æ€§èƒ½é—®é¢˜ä½œä¸ºalertå±•ç¤ºå‡ºæ¥ï¼Œä»è€Œä¸ºè§£å†³é—®é¢˜æä¾›æŒ‡å¯¼ã€‚</p>
<p>å½“é€‰ä¸­æŸä¸ªå­˜åœ¨é—®é¢˜çš„å¸§ä¹‹åï¼Œalertå°±å¯èƒ½åœ¨<code>E</code>å¤„å±•ç°ï¼šå¦‚æœæ˜¯UIçº¿ç¨‹ç¬¦åˆå¤ªé‡ï¼Œå°±å¯ä»¥ä½¿ç”¨<a href="http://www.muzileecoding.com/androidoptimize/Android-traceview.html" target="_blank" rel="noopener">TraceView</a>æ¥è¯Šæ–­å…·ä½“æ˜¯ä»€ä¹ˆå¯¼è‡´çš„é—®é¢˜ã€‚</p>
<p>åœ¨æ•´ä¸ªé¢æ¿çš„å³ä¾§ï¼Œè¿˜æœ‰ä¸€ä¸ªAlert Tabï¼Œä½ å¯ä»¥é€šè¿‡å®ƒæŸ¥çœ‹traceæ–‡ä»¶ä¿¡æ¯ä¸­çš„æ‰€æœ‰çš„Alertä»¥åŠå®ƒçš„æ•°é‡ã€‚å¦‚ä¸‹:<br><img src="http://7xktd8.com1.z0.glb.clouddn.com/å¸§é—®é¢˜è¯Šæ–­.png" alt="å¸§é—®é¢˜è¯Šæ–­"><br>ä¸‹é¢çš„çº¢æ¡†å±•ç°äº†æˆ‘æ‰€é€‰å½“å‰é—®é¢˜å¸§æš´éœ²å‡ºæ¥çš„ä¸‰ä¸ªAlertï¼Œè€Œå³ä¾§çº¢æ¡†åˆ™å±•ç°äº†å½“å‰traceæ–‡ä»¶ä¸­çš„æ‰€æœ‰alertçš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<blockquote>
<p>è¿™ä¸ªéå¸¸æœ‰ç”¨ï¼Œå½“æ“ä½œæ¯”è¾ƒé›†ä¸­æ—¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“å‘ç°é—®é¢˜ï¼Œé…åˆTraceViewå¯ä»¥æ¯”å€¨å‚²å®¹æ˜“æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚å®˜ç½‘å»ºè®®æŠŠç»Ÿè®¡å‡ºæ¥çš„é—®é¢˜å½“åšBugä¿®æ‰ã€‚</p>
</blockquote>
<h2 id="Tracing-Application-Code"><a href="#Tracing-Application-Code" class="headerlink" title="Tracing Application Code"></a>Tracing Application Code</h2><p>frameworkå®šä¹‰çš„traceä¿¡å·å¹¶ä¸èƒ½å…¨é¢å±•ç°appæ‰€åšçš„æ‰€æœ‰äº‹æƒ…ï¼Œæ‰€ä»¥ä½ å¯èƒ½éœ€è¦æ·»åŠ ä½ è‡ªå·±çš„ä¿¡å·ï¼Œåœ¨Android4.3ä»¥åŠæ›´é«˜çš„ç‰ˆæœ¬ä¸Šï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨<code>Trace</code>ç±»æ¥ç»™ä»£ç æ·»åŠ ä¿¡å·ï¼Œè¿™ä¸ªæŠ€æœ¯å¯ä»¥å¸®åŠ©ä½ è§‚å¯Ÿä»»ä½•æ—¶å€™Appæ‰€åšçš„å·¥ä½œã€‚Traceå¼€å§‹å’Œç»“æŸæœ¬èº«ä¹Ÿä¼šé€ æˆä¸€å®šçš„å½±å“ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPeople</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Trace.beginSection(<span class="string">"ProcessPeople"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.beginSection(<span class="string">"Processing Jane"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// code for Jane task...</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.endSection(); <span class="comment">// ends "Processing Jane"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.beginSection(<span class="string">"Processing John"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// code for John task...</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.endSection(); <span class="comment">// ends "Processing John"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.endSection(); <span class="comment">// ends "ProcessPeople"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¦æ³¨æ„: <code>beginSection()</code>å’Œ<code>endSection()</code>è¦æˆå¯¹å‡ºç°ã€‚è€Œä¸”ä¸¤ä¸ªæ–¹æ³•è¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹å‡ºç°ã€‚</p>
</blockquote>
<p>å½“ä½¿ç”¨Appçº§åˆ«çš„traceï¼Œå°±å¿…é¡»è¦åœ¨ç”¨æˆ·UIæˆ–è€…å‘½ä»¤è¡Œä¸­ä½¿ç”¨<code>-a</code>/<code>--app=</code>æŒ‡å®šåŒ…åã€‚</p>
<p>å½“profile appçš„æ—¶å€™ï¼Œæœ€å¥½æ‰“æ¥appçº§åˆ«çš„traceåŠŸèƒ½ï¼Œè¿™æ ·ä¸€äº›æ¡†æ¶å°†é€šè¿‡traceæä¾›ä¸€äº›éå¸¸é‡è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚<code>RecyclerView</code>ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[UIä¼˜åŒ–]]></title>
      <url>http://www.timebridge.space/2016/05/10/Android-ui-optimize/</url>
      <content type="html"><![CDATA[<h2 id="Overdraw-Debugger"><a href="#Overdraw-Debugger" class="headerlink" title="Overdraw Debugger"></a>Overdraw Debugger</h2><p>è¿‡åº¦ç»˜åˆ¶çš„è¯Šæ–­å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰‹æœºçš„å¼€å‘äººå‘˜åŠŸèƒ½æ”¯æŒï¼š</p>
<ol>
<li>æ‰“å¼€è®¾ç½®â€”â€”&gt;å¼€å‘äººå‘˜é€‰é¡¹ï¼›</li>
<li>æ‰¾åˆ°â€Debug GPU Overdrawâ€ï¼›</li>
<li>ç‚¹å‡»è¯¥é¡¹ï¼Œé€‰æ‹©â€Show ovedraw areasâ€ï¼›</li>
</ol>
<p>è¿™ä¸ªæ—¶å€™ä½ çš„å±å¹•å°±å˜å¾—äº”é¢œå…­è‰²äº†ï¼š</p>
<ol>
<li>çœŸå®è‰²å½©ï¼šæ²¡æœ‰è¿‡åº¦ç»˜åˆ¶ï¼›</li>
<li>è“è‰²ï¼šè¿‡åº¦ç»˜åˆ¶ä¸€æ¬¡ï¼›</li>
<li>ç»¿è‰²ï¼šè¿‡åº¦ç»˜åˆ¶ä¸¤æ¬¡ï¼›</li>
<li>ç²‰è‰²ï¼šè¿‡åº¦ç»˜åˆ¶ä¸‰æ¬¡ï¼›</li>
<li>çº¢è‰²ï¼šè¿‡åº¦ç»˜åˆ¶å››æ¬¡ä»¥åŠä»¥ä¸Šï¼›</li>
</ol>
<p>æœ‰äº›è¿‡åº¦ç»˜åˆ¶æ˜¯ä¸å¯é¿å…çš„ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯å°½é‡è®©æˆ‘ä»¬çš„Appå±•ç°çœŸå®è‰²å½©æˆ–è€…è“è‰²ã€‚<a id="more"></a></p>
<h2 id="Rendering-Profiler"><a href="#Rendering-Profiler" class="headerlink" title="Rendering Profiler"></a>Rendering Profiler</h2><p>Profile GPU Renderingä½¿å¾—å¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°çŸ¥é“ç³»ç»Ÿæ˜¯å¦æ­£åœ¨ä»¥16msæ¯å¸§çš„é€Ÿåº¦ç»˜åˆ¶å½“å‰UIï¼Œå¹¶ä¸”å¯ä»¥æŸ¥çœ‹æ˜¯å“ªä¸€ä¸ªç»˜åˆ¶çš„æ­¥éª¤è¶…æ—¶ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:</p>
<ol>
<li>æ‰“å¼€è®¾ç½®â€”â€”&gt;å¼€å‘äººå‘˜é€‰é¡¹ï¼›</li>
<li>æ‰¾åˆ°â€Profile GPU Renderingâ€ï¼›</li>
<li>ç‚¹å‡»æ‰“å¼€å¼¹çª—ï¼Œé€‰æ‹©â€On screen as barsâ€ï¼›</li>
</ol>
<p>ä½ çš„å±å¹•ä¸Šåº•éƒ¨å°±ä¼šå‡ºç°å½©è‰²çš„çº¿æ¡:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/gettingstarted_image002.png" height="320" alt="Screen when Profile GPU Rendering is on"></div>

<p>è¯¦ç»†çš„å«ä¹‰å¦‚ä¸‹:</p>
<p><div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/gettingstarted_image003.png" height="160" alt="Screen when Profile GPU Rendering is on"></div><br>ç»¿è‰²çš„æ¨ªçº¿ä»£è¡¨16ms/å¸§çš„ä¸Šé™ï¼ˆæ‰€æœ‰çš„ç«–çº¿éƒ½åº”è¯¥åœ¨è¿™æ¡çº¿ä¹‹ä¸‹ï¼Œè¶…è¿‡è¿™æ¡çº¿åˆ™å¯èƒ½æ„å‘³ç€åŠ¨ç”»çš„å¡é¡¿ï¼‰ï¼Œè€Œæ¯æ¡ç«–çº¿åˆ™åŒ…å«ç€è“è‰²ï¼Œç´«è‰²(åªæœ‰4.0ä»¥åŠä»¥ä¸Šç‰ˆæœ¬æ‰æœ‰)ï¼Œçº¢è‰²ä»¥åŠæ©™è‰²ï¼Œå®ƒä»¬ä»£è¡¨ç€ä¸€æ¬¡ç»˜åˆ¶çš„å‡ ä¸ªè¿‡ç¨‹</p>
<ol>
<li>è“çº¿ä»£è¡¨ç”¨äºåˆ›å»º/æ›´æ–°Viewçš„display listçš„æ—¶é—´ï¼Œå¦‚æœä¸€æ ¹ç«–çº¿çš„è¿™éƒ¨åˆ†å¾ˆé«˜ï¼Œå¯èƒ½å°±æ„å‘³ç€æœ‰å¾ˆå¤šçš„è‡ªå®šä¹‰Viewéœ€è¦ç»˜åˆ¶ï¼Œæˆ–è€…åœ¨<code>onDraw()</code>æ–¹æ³•é‡Œé¢æ‰§è¡Œäº†å¤ªå¤šçš„ä»»åŠ¡ï¼›</li>
<li>ç´«è‰²(åªæœ‰4.0ä»¥åŠä»¥ä¸Šç‰ˆæœ¬æ‰æœ‰)ä»£è¡¨å°†èµ„æºä¼ é€åˆ°renderçº¿ç¨‹æ‰€èŠ±è´¹æ—¶é—´ï¼›</li>
<li>çº¢è‰²ä»£è¡¨Androidçš„2D renderå‘é€å‘½ä»¤åˆ°OpenGLæ¥ç»˜åˆ¶æˆ–è€…é‡ç»˜display listæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œè¶Šå¤šçš„display listæ„å‘³ç€æ›´é«˜çš„çº¢çº¿ï¼›</li>
<li>æ©™è‰²ä»£è¡¨CPUç­‰å¾…GPUå®Œæˆä»»åŠ¡çš„æ—¶é—´ï¼Œå¦‚æœè¿™æ®µçº¿å¾ˆé•¿ï¼Œé‚£å°±æ„å‘³ç€Appåœ¨GPUä¸Šåšäº†å¤ªå¤šçš„å·¥ä½œï¼›</li>
</ol>
<blockquote>
<p>è™½ç„¶è¿™ä¸ªå·¥å…·å«åš<code>Profile GPU Rendering</code>ï¼Œä½†å®é™…ä¸Šç›‘æ§çš„ä»»åŠ¡éƒ½åœ¨CPUä¸Šé¢ï¼Œæ¸²æŸ“æ˜¯é€šè¿‡æäº¤å‘½ä»¤ç»™GPUæ¥å®ç°çš„ï¼ŒGPUå¼‚æ­¥å»æ¸²æŸ“å±å¹•ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒGPUæœ‰å¤ªå¤šçš„ä»»åŠ¡éœ€è¦å»åšï¼Œå°±éœ€è¦CPUç­‰å¾…ä¸€æ®µæ—¶é—´å†å»æäº¤å‘½ä»¤ï¼Œå½“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ—¶å€™ï¼Œå°±å¯ä»¥çœ‹åˆ°å¾ˆé•¿çš„Process(æ©™è‰²)å’ŒExecute(çº¢è‰²)çº¿ï¼Œå‘½ä»¤çš„æäº¤ä¼šé˜»å¡ï¼Œç›´åˆ°GPUå‘½ä»¤é˜Ÿåˆ—é‡Œé¢æœ‰è¶³å¤Ÿçš„ç©ºé—´å®¹çº³æ–°çš„å‘½ä»¤ã€‚</p>
</blockquote>
<p>ä¼˜åŒ–é€šç”¨æ‰‹æ³•ï¼šé™ä½ViewTreeå±‚çº§ã€‚</p>
<h2 id="Hierarchy-Viewer"><a href="#Hierarchy-Viewer" class="headerlink" title="Hierarchy Viewer"></a>Hierarchy Viewer</h2><p>è¿™ä¸ªå·¥å…·å¯ä»¥å¯è§†åŒ–Appçš„Viewç»“æ„ï¼Œå¹¶ä¸”æ ‡æ³¨æ¯ä¸€ä¸ªViewçš„æ¸²æŸ“é€Ÿåº¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼š</p>
<ol>
<li>é™ä½å±‚çº§ï¼Œå‡å°‘è¿‡åº¦ç»˜åˆ¶ï¼›</li>
<li>æ‰¾åˆ°æ½œåœ¨çš„æ¸²æŸ“æ€§èƒ½ç“¶é¢ˆï¼›</li>
</ol>
<p>ä½¿ç”¨å‰ææ¡ä»¶:</p>
<ol>
<li>å¿…é¡»ä½¿ç”¨çœŸæœºæ¥è·å¾—å‡†ç¡®æ•°æ®ï¼›</li>
<li>åœ¨æœºå™¨ä¸Šè®¾ç½®ä¸€ä¸ª<code>ANDROID_HVPROTO</code>å˜é‡ï¼ˆ<a href="http://developer.android.com/intl/zh-cn/tools/performance/hierarchy-viewer/setup.html" target="_blank" rel="noopener">é…ç½®æ–‡æ¡£</a>ï¼‰ï¼›</li>
</ol>
<p>å…·ä½“çš„è¿‡ç¨‹å‚è§<a href="http://developer.android.com/intl/zh-cn/tools/performance/hierarchy-viewer/profiling.html" target="_blank" rel="noopener">å®˜ç½‘</a>ã€‚</p>
<p>æ¯ä¸€ä¸ªViewéƒ½å¯ä»¥é€šè¿‡Profileäº§ç”Ÿä¸‰ä¸ªå°ç‚¹ï¼Œåˆ†åˆ«ä»£è¡¨Drawã€Layoutã€Executeä¸‰ä¸ªè¿‡ç¨‹ã€‚ä¸‰ä¸ªç‚¹éƒ½å¯ä»¥ç”±ä¸‰ç§é¢œè‰²ï¼Œç»¿è‰²è¡¨ç¤ºè‡³å°‘æ¯”å…¶ä½™ä¸€åŠçš„Viewå¿«ï¼Œé»„è‰²è¡¨ç¤ºä¸æ˜¯æœ€æ…¢çš„é‚£ä¸€åŠViewï¼Œçº¢è‰²è¡¨ç¤ºæ˜¯æœ€æ…¢çš„é‚£ä¸€åŠViewã€‚</p>
<h4 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h4><p>å› ä¸ºHierarchy Viewerè¡¡é‡çš„æ˜¯ç›¸å¯¹æ€§èƒ½ï¼Œå› æ­¤æ•´ä¸ªTreeä¸­æ€»æ˜¯æœ‰çº¢ç‚¹ï¼Œå› æ­¤çº¢è‰²å¹¶ä¸ä»£è¡¨å¾ˆæ…¢ã€‚ä¸‹é¢è®²è¿°ä¸€äº›å¤„ç†çº¢ç‚¹Viewçš„åŠæ³•:</p>
<ol>
<li>æ‰¾åˆ°é‚£äº›å¤„äºå¶å­èŠ‚ç‚¹æˆ–è€…æ‹¥æœ‰å¾ˆå°‘å­Viewçš„ViewGroupï¼Œè¿™ç±»Viewå¾ˆå¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œä½¿ç”¨Systraceæˆ–è€…TraceViewå¯ä»¥è·å¾—æ›´å¤šä¿¡æ¯ï¼›</li>
<li>å¦‚æœä¸€ä¸ªViewGroupå¸¦æœ‰å¾ˆå¤šçš„å­Viewï¼Œå¹¶ä¸”æ˜¾ç¤ºçº¢è‰²ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å­Viewçš„æ€§èƒ½å¦‚ä½•ï¼›</li>
<li>ä¸€ä¸ªæ˜¾ç¤ºé»„è‰²ç”šè‡³çº¢è‰²çš„Viewåœ¨è®¾å¤‡ä¸Šè¿è¡Œå¹¶ä¸ä¸€å®šæ…¢ï¼›</li>
<li>æ ¹Viewæœ‰ä¸€ä¸ªçº¢è‰²çš„measureé˜¶æ®µï¼Œçº¢è‰²çš„layouté˜¶æ®µä»¥åŠé»„è‰²çš„ç»˜åˆ¶é˜¶æ®µæ˜¯å¾ˆæ­£å¸¸çš„ï¼›</li>
<li>å¦‚æœä¸€ä¸ªå¶å­ç»“ç‚¹åœ¨ä¸€ä¸ªæœ‰20ä¸ªä»¥ä¸Šçš„Viewçš„Treeä¸­æ˜¾ç¤ºçº¢è‰²ï¼Œè¿™å¾ˆå¯èƒ½å°±æ„å‘³ç€å‘ç”Ÿäº†é—®é¢˜ï¼Œå¯ä»¥å¥½å¥½çœ‹ä¸€ä¸‹<code>onDraw()</code>æ–¹æ³•ï¼›</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Memory Profilers]]></title>
      <url>http://www.timebridge.space/2016/05/09/Android-Memory-Profilers/</url>
      <content type="html"><![CDATA[<p>å…³äºå†…å­˜ï¼ŒAndroidæä¾›äº†ä¸‰ä¸ªå·¥å…·ï¼š</p>
<ol>
<li>Memory Monitor: å¯ä»¥æ‰¾å‡ºæ˜¯å¦æœ‰å¼‚å¸¸çš„GCæ“ä½œå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼› </li>
<li>Heap Viewer: å¯ä»¥æ‰¾å‡ºè¢«æ„å¤–åˆ†é…æˆ–è€…å†…å­˜æ³„éœ²çš„å¯¹è±¡ï¼›</li>
<li>Allocation Tracker: æ‰¾å‡ºå­˜åœ¨å†…å­˜é—®é¢˜çš„ä»£ç ï¼›</li>
</ol>
<p>ç°åœ¨Android Stuidoçš„Android Monitoré¢æ¿å·²ç»é›†æˆäº†è¿™ä¸‰ä¸ªå·¥å…·ï¼Œæ¯”èµ·ä½¿ç”¨Android Device Monitoræ¥æ›´åŠ æ–¹ä¾¿å¿«æ·ã€‚å¦‚ä¸‹å›¾:<a id="more"></a></p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Android-Monitor.png" alt="Android Monitor"></p>
<blockquote>
<p>Android Monitorä¸ä»…å¯ä»¥æŸ¥çœ‹å†…å­˜åˆ†é…ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹CPUã€GPUã€Networkæ´»åŠ¨ã€‚</p>
</blockquote>
<h2 id="Memory-Monitor"><a href="#Memory-Monitor" class="headerlink" title="Memory Monitor"></a>Memory Monitor</h2><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å·¥å…·ï¼Œå°±åœ¨Android Studioçš„Android Monitoré‡Œé¢ï¼Œä¹Ÿå³ä¸Šå›¾ä¸­çš„<code>D</code>å¤„ã€‚åœ¨<code>A</code>å¤„é€‰ä¸­è®¾å¤‡ï¼Œåœ¨<code>B</code>å¤„é€‰ä¸­è¿›ç¨‹ï¼Œå°±å¯ä»¥åœ¨<code>D</code>å¤„æŸ¥çœ‹åº”ç”¨çš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚æ›´è¯¦ç»†çš„æ•™ç¨‹å¯ä»¥çœ‹<a href="http://developer.android.com/intl/zh-cn/tools/performance/memory-monitor/index.html" target="_blank" rel="noopener">å®˜ç½‘æ–‡æ¡£</a>ã€‚</p>
<p>åœ¨<a href="http://www.csdn.net/article/2015-01-20/2823621-android-performance-patterns/2" target="_blank" rel="noopener">Androidæ€§èƒ½ä¼˜åŒ–å…¸èŒƒï¼ˆä¸€ï¼‰</a>ç¬¬ä¹æ®µä¸­ä¸“é—¨æåˆ°äº†ä¸€ç§å†…å­˜ç°è±¡ï¼Œæ˜¯å¯ä»¥ä»Memory Monitorä¸­å¾ˆå®¹æ˜“çœ‹å‡ºæ¥çš„â€”â€”å†…å­˜æŠ–åŠ¨ï¼šçŸ­æ—¶é—´å‘ç”Ÿäº†å¤šæ¬¡å†…å­˜çš„æ¶¨è·Œã€‚</p>
<h2 id="Heap-Viewer"><a href="#Heap-Viewer" class="headerlink" title="Heap Viewer"></a>Heap Viewer</h2><p>Heap Viewerå±•ç°äº†æŸä¸€æ—¶åˆ»å†…å­˜åˆ†é…çš„å¯¹è±¡çš„å¿«ç…§ï¼Œå¯ä»¥ç”¨äºå‘ç°å“ªäº›å¯¹è±¡å‘ç”Ÿäº†å†…å­˜æ³„éœ²ã€‚</p>
<p>åœ¨<a href="http://developer.android.com/intl/zh-cn/tools/performance/heap-viewer/index.html#WhatYouNeed" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸Šæ˜¯å±•ç¤ºäº†è¯¥å·¥å…·çš„ä½¿ç”¨æ­¥éª¤ï¼Œç®€è¿°å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆå®‰è£…MAT(<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a>)ï¼›</li>
<li>åœ¨Android Studioä¸­æ‰“å¼€Android Device Monitoræˆ–è€…DDMSï¼›</li>
<li>é€‰æ‹©éœ€è¦æµ‹è¯•çš„è¿›ç¨‹ï¼›</li>
<li>åœ¨è¿›ç¨‹åˆ—è¡¨ä¸Šæ–¹ç‚¹å‡»Update HeapæŒ‰é’®ï¼›</li>
<li>åœ¨å³è¾¹çš„é¢æ¿ä¸­é€‰æ‹©Heap Tabï¼›</li>
<li>ç‚¹å‡»Cause GCï¼›</li>
<li>ç‚¹å‡»è¿›ç¨‹åˆ—è¡¨ä¸Šæ–¹çš„Dump HPROFæŒ‰é’®ï¼Œä¿å­˜HPROFæ–‡ä»¶ï¼›</li>
<li>è¿è¡Œå‘½ä»¤è¿›è¡Œæ–‡ä»¶è½¬æ¢ï¼š<code>./hprof-conv path/file.hprof exitPath/heap-converted.hprof</code>ï¼ˆhprof-convå‘½ä»¤åœ¨sdkçš„platform-toolsç›®å½•ä¸‹é¢ï¼‰</li>
<li>ä½¿ç”¨MATæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼›</li>
</ol>
<blockquote>
<p>ç¿»è¯‘è‡ª: <a href="http://stackoverflow.com/questions/24547555/how-to-analyze-memory-using-android-studio" target="_blank" rel="noopener">How to analyze memory using android studio-StackOverFlow</a></p>
</blockquote>
<p>ä½†æ˜¯Android Studio 1.2.xå·²ç»å°†è¯¥åŠŸèƒ½é›†åˆåˆ°Android Monitoré¢æ¿ä¸­äº†ï¼š<code>C</code>å¤„æœ‰ä¸‰ä¸ªæŒ‰é’®ï¼Œç¬¬ä¸€ä¸ªæŒ‰é’®å°±å¯ä»¥è§¦å‘GCæ“ä½œï¼Œç¬¬äºŒä¸ªæŒ‰é’®å°±æ˜¯Dump Java Heapã€‚ç”Ÿæˆçš„æ–‡ä»¶æ˜¯ä¸Šé¢ç¬¬7æ­¥ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä½†æ˜¯è½¬æ¢ä¸éœ€è¦è¿›è¡Œç¬¬8æ­¥ï¼Œå¦‚å›¾:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/hprof.png" height="160" alt="HPROF"></div>

<p>åªéœ€è¦ç‚¹å‡»Capturesè¾¹æ ï¼Œé€‰ä¸­ç”Ÿæˆçš„åŸå§‹hprofæ–‡ä»¶ï¼Œå³å‡»é€‰æ‹©â€Export to standard .hprofâ€æ–‡ä»¶å³å¯ç”Ÿæˆæ ‡å‡†çš„hprofæ–‡ä»¶ï¼Œç„¶ååœ¨ç”¨MATæ‰“å¼€æ–‡ä»¶å³å¯ã€‚</p>
<p>å…·ä½“çš„åˆ†æè¿‡ç¨‹å¯ä»¥å‚è§:</p>
<ol>
<li><a href="http://wiki.eclipse.org/MemoryAnalyzer" target="_blank" rel="noopener">MemoryAnalyzer</a></li>
<li><a href="http://www.jianshu.com/p/d8e247b1e7b2" target="_blank" rel="noopener">MATä½¿ç”¨å…¥é—¨</a></li>
<li><a href="http://kohlerm.blogspot.jp/" target="_blank" rel="noopener">Markus Kohleråšå®¢</a></li>
<li><a href="http://android-developers.blogspot.jp/2011/03/memory-analysis-for-android.html" target="_blank" rel="noopener">Memory Analysis for Android Applications</a></li>
<li><a href="http://eclipsesource.com/blogs/2013/01/21/10-tips-for-using-the-eclipse-memory-analyzer/" target="_blank" rel="noopener">10 Tips for using the Eclipse Memory Analyzer</a></li>
</ol>
<p>ä½¿ç”¨è¿™ä¸ªå·¥å…·æ‰¾å¯»å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ²¡æœ‰ä¸€ä¸ªå‡†åˆ™çš„ï¼Œéœ€è¦å¯¹è‡ªå·±çš„ç¨‹åºæ¯”è¾ƒäº†è§£ï¼ˆå‚è§<a href="https://www.youtube.com/watch?v=_CruQY55HOk" target="_blank" rel="noopener">Google I/Oè§†é¢‘</a>ï¼‰ã€‚ä»å®é™…å¼€å‘ç»éªŒæ¥è¯´ï¼Œéµå¾ªä¸€å®šçš„å¼€å‘è§„åˆ™ï¼Œåœ¨ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹ã€é™æ€å˜é‡ã€å†…éƒ¨ç±»ç­‰æŠ€æœ¯çš„æ—¶å€™å¤šåŠ æ³¨æ„æ˜¯æ›´å¥½çš„åŠæ³•ã€‚</p>
<h2 id="Allocation-Tracker"><a href="#Allocation-Tracker" class="headerlink" title="Allocation Tracker"></a>Allocation Tracker</h2><p>ä¸€å¤§åˆ©å™¨ï¼Œå¯ä»¥åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š</p>
<ol>
<li>å±•ç¤ºåœ¨ä»€ä¹ˆæ—¶å€™ä»€ä¹ˆåœ°æ–¹åˆ†é…äº†ä»€ä¹ˆæ ·å­çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„å¤§å°ï¼Œåˆ†é…çš„çº¿ç¨‹ä»¥åŠæ ˆä¿¡æ¯ï¼›</li>
<li>é€šè¿‡é‡å¤è¿›è¡Œåˆ†é…ã€é‡Šæ”¾åŠ¨ä½œå¸®åŠ©åˆ†æå†…å­˜æŠ–åŠ¨ï¼›</li>
<li>å¯ä»¥å’ŒHeap Viewerç»“åˆåˆ†æå†…å­˜æ³„éœ²ï¼›</li>
</ol>
<p>ä½†æ˜¯æ˜¯éœ€è¦æ—¶é—´æ¥å­¦ä¹ åˆ†æç»Ÿè®¡æ•°æ®å’ŒæŠ¥è¡¨çš„ã€‚</p>
<p>å®ƒçš„ä½¿ç”¨åŒæ ·æ˜¯æ—¢å¯ä»¥åœ¨Android Monitorä¸­è¿›è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨Android Device Monitorä¸­è¿›è¡Œçš„ã€‚å‰è€…åªéœ€è¦ä¸¤æ¬¡ç‚¹å‡»<code>C</code>å¤„çš„ç¬¬ä¸‰ä¸ªæŒ‰é’®å³å¯ï¼Œåè€…åˆ™ç¨å¾®éº»çƒ¦ä¸€äº›ã€‚å…·ä½“å¯å‚è€ƒ:</p>
<ol>
<li><a href="http://developer.android.com/intl/zh-cn/tools/performance/allocation-tracker/index.html" target="_blank" rel="noopener">å®˜ç½‘</a></li>
<li><a href="http://blog.csdn.net/p106786860/article/details/9248693" target="_blank" rel="noopener">ä½¿ç”¨Allocation trackerè·Ÿè¸ªAndroidåº”ç”¨å†…å­˜åˆ†é…</a></li>
</ol>
<p>åœ¨Android Device Monitorä¸­æŸ¥çœ‹æ•°æ®ï¼Œä¸ªäººæ„Ÿè§‰æ¯”è¾ƒæ¸…æ™°ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Allocaition-TrackerB.png" alt="Android Monitor"><br>å¯ä»¥çœ‹åˆ°ä¸­é—´çº¢æ¡†å±•ç°äº†æ‰€æœ‰åˆ†é…çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„åˆ†é…é¡ºåºã€å¤§å°ã€ç±»å‹ã€æ‰€å±çº¿ç¨‹ï¼Œåœ¨å“ªä¸ªç±»çš„å“ªä¸ªæ–¹æ³•ä¸­è¢«åˆ†é…ï¼Œéƒ½éå¸¸æ¸…æ¥šã€‚</p>
<p>é€‰ä¸­ä¸€è¡Œä¹‹åï¼Œå°±å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°è¯¦ç»†çš„å †æ ˆä¿¡æ¯ã€‚è€Œå…³äºAndroid Monitorçš„å›¾æ ‡è§£æï¼Œå¯ä»¥æŸ¥çœ‹<a href="http://blog.csdn.net/itfootball/article/details/48750849" target="_blank" rel="noopener">Androidæ€§èƒ½ä¸“é¡¹æµ‹è¯•ä¹‹Allocation Tracker(Android Studio)</a>ã€‚</p>
<h2 id="å†…å­˜ä½¿ç”¨åˆ†æ"><a href="#å†…å­˜ä½¿ç”¨åˆ†æ" class="headerlink" title="å†…å­˜ä½¿ç”¨åˆ†æ"></a>å†…å­˜ä½¿ç”¨åˆ†æ</h2><p>å…·ä½“å¯ä»¥å‚è€ƒ<a href="http://developer.android.com/intl/zh-cn/tools/debugging/debugging-memory.html" target="_blank" rel="noopener">å®˜ç½‘æ–‡ç« </a>ï¼Œè¿™é‡Œè¿˜æœ‰<a href="http://android.jobbole.com/80926/" target="_blank" rel="noopener">ç¿»è¯‘</a>ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œä¸»è¦åˆ†ææ‰‹æ®µæœ‰ï¼š</p>
<ol>
<li>è§£æGCæ—¥å¿—ä¿¡æ¯ï¼šä¸»è¦å…³æ³¨<code>&lt;Heap_stats&gt;</code>ï¼Œå¦‚æœå€¼ä¸€ç›´å¢å¤§å¹¶ä¸”ä¸ä¼šå‡å°ä¸‹æ¥ï¼Œé‚£ä¹ˆå°±å¯èƒ½æœ‰å†…å­˜æ³„éœ²äº†ï¼›</li>
<li>æŸ¥çœ‹å †çš„æ›´æ–°ï¼šHeapè§†å›¾æ˜¾ç¤ºäº†å †å†…å­˜ä½¿ç”¨çš„åŸºæœ¬çŠ¶å†µï¼Œæ¯æ¬¡åƒåœ¾å›æ”¶åä¼šæ›´æ–°ï¼Œå¯ä»¥çœ‹åˆ†é…çš„å†…å­˜æ˜¯å¦åœ¨å¢é•¿ï¼›</li>
<li>è·Ÿè¸ªå†…å­˜åˆ†é…ï¼šæŸ¥çœ‹å¯¹è±¡çš„åˆ†é…æƒ…å†µï¼›</li>
<li>æŸ¥çœ‹æ€»ä½“å†…å­˜åˆ†é…ï¼šé€šè¿‡å‘½ä»¤<code>adb shell dumpsys meminfo &lt;package_name|pid&gt; [-d]</code>å¯ä»¥æŸ¥çœ‹è¿›ç¨‹ä¸­æ´»åŠ¨çš„æ ¹è§†å›¾çš„æ•°é‡å’Œå½“å‰é©»ç•™åœ¨è¿›ç¨‹ä¸­çš„Contextå’ŒActivityå¯¹è±¡çš„æ•°é‡ï¼›</li>
<li>è·å–å †è½¬å‚¨ï¼šæŸ¥çœ‹æŒä¹…å¼•ç”¨ï¼Œè´¹é™æ€å†…éƒ¨ç±»ä»¥åŠä¸å¿…è¦çš„å¯¹è±¡ç¼“å­˜ï¼›</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[æ€§èƒ½ä¼˜åŒ–æ€»è§ˆ]]></title>
      <url>http://www.timebridge.space/2016/05/09/Android-Performance-Outline/</url>
      <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨æ•´ç†Systraceçš„æ—¶å€™çœ‹åˆ°äº†ä¸€å¥è¯:</p>
<p><strong>After building features, eliminating bugs and cleaning up your code, you should spend some time looking at the performance of your application.</strong></p>
<p>é“å‡ºäº†ç¨‹åºçŒ¿ä»å§‹è‡³ç»ˆçš„å·¥ä½œå•Šã€‚</p>
<p><a href="http://developer.android.com/intl/zh-cn/tools/performance/index.html" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸Šæä¾›äº†ä¸€äº›åˆ—å·¥å…·ç”¨äºè¾…åŠ©æé«˜ç¨‹åºçš„æ€§èƒ½ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ–¹é¢:<a id="more"></a></p>
<ol>
<li>UIï¼›</li>
<li>å†…å­˜ï¼›</li>
<li>ç”µé‡ï¼›</li>
</ol>
<p>è™½ç„¶æ²¡æœ‰æåŠæµé‡ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨Android Monitorä¸Šå·²ç»æœ‰æ‰€æ”¯æŒï¼Œä¸”åœ¨<a href="http://www.muzileecoding.com/android/Android-performance.html" target="_blank" rel="noopener">Androidæ€§èƒ½ä¼˜åŒ–ç³»åˆ—è§†é¢‘</a>ä¸­ä¹Ÿæåˆ°ç›¸å…³å·¥å…·ï¼Œæ¯”å¦‚<a href="http://developer.android.com/intl/zh-cn/tools/debugging/ddms.html#network" target="_blank" rel="noopener">Network Traffic tool</a>ã€‚</p>
<p>ä»å®é™…å¼€å‘çš„è§’åº¦ï¼ŒUIå’Œå†…å­˜æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸¤å—ï¼ŒAndroidåœ¨è¿™ä¸¤å—æä¾›çš„æ”¯æŒä¹Ÿæœ€å¤š:</p>
<ol>
<li>UIä¸Šçš„è¿‡åº¦ç»˜åˆ¶ï¼ŒåµŒå¥—å±‚æ¬¡è¿‡æ·±ï¼Œä¼šå¯¼è‡´é¡µé¢çš„å¡é¡¿ï¼Œè¿›è€Œå½±å“ç”¨æˆ·ä½“éªŒï¼›</li>
<li>å†…å­˜ä½¿ç”¨ä¸åˆç†ï¼Œè¯¸å¦‚å†…å­˜æ³„éœ²ã€æŠ–åŠ¨ç­‰é—®é¢˜ä¼šå¯¼è‡´ç¨‹åºä¸ç¨³å®šï¼›</li>
</ol>
<p>ä»¥ä¸‹æ˜¯æä¾›çš„å·¥å…·å›¾ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Androidè°ƒä¼˜å·¥å…·æ±‡æ€».png" height="188" alt="Androidè°ƒä¼˜å·¥å…·æ±‡æ€»"></div>

<p>å…³äºæµé‡ï¼Œéµå¾ªä¸€å®šçš„ç­–ç•¥ï¼ˆæ¯”å¦‚æ•°æ®å‹ç¼©ï¼Œæ•°æ®ç¼“å­˜ï¼‰ï¼Œé—®é¢˜ä¸ä¼šå¾ˆå¤§â€”â€”é‡è¦çš„æ˜¯è¯·æ±‚çš„æ—¶é—´ã€‚</p>
<p>å…³äºç”µé‡ï¼Œ<a href="http://www.muzileecoding.com/android/Android-performance.html" target="_blank" rel="noopener">Androidæ€§èƒ½ä¼˜åŒ–ç³»åˆ—è§†é¢‘</a>ä¸­ä¹Ÿæœ‰æ‰€æåŠâ€”â€”æ¯”å¦‚ä¸è¦é‡‡ç”¨è½®è¯¢æœºåˆ¶ä¸æœåŠ¡ç«¯ä¿æŒé€šä¿¡ï¼Œå› ä¸ºç½‘ç»œè¯·æ±‚ä¼šå”¤é†’æ— çº¿ç”µé€šä¿¡æ¨¡å—ï¼Œè¿™æ˜¯éå¸¸è€—ç”µçš„æ“ä½œï¼Œè¿˜æœ‰é€šè¿‡WakeLockå”¤é†’å±å¹•ç­‰æ“ä½œï¼Œä¹Ÿéœ€è¦æ…é‡ã€‚</p>
<blockquote>
<p>å½“å‡ºç°å¡é¡¿é—®é¢˜ï¼Œè¿™äº›å·¥å…·å¯ä»¥ä½œä¸ºä¸€ä¸ªå…¥å£å‘ç°é—®é¢˜æ‰€åœ¨ï¼šé”å®šè¶…æ—¶å‡½æ•°ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[TraceView]]></title>
      <url>http://www.timebridge.space/2016/05/09/Android-traceview/</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><a href="http://developer.android.com/intl/zh-cn/tools/debugging/debugging-tracing.html" target="_blank" rel="noopener">å®˜ç½‘ä»‹ç»</a></p>
<h2 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><p><img src="http://7xktd8.com1.z0.glb.clouddn.com/TraceView.png" alt="TraceViewæ“ä½œé¡µé¢"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®Œæˆæ•°æ®è·å–å’Œå±•ç¤ºï¼š<a id="more"></a></p>
<ol>
<li>ç‚¹å‡»<code>A</code>å¤„çš„Androidå°äººIconæ‰“å¼€TraceViewæ“ä½œé¡µé¢ï¼›</li>
<li>åœ¨<code>C</code>å¤„é€‰æ‹©éœ€è¦ç›‘æ§çš„è¿›ç¨‹ï¼Œé€‰æ‹©å®Œæ¯•åï¼Œ<code>B</code>å¤„çš„Iconå°±ä¼šäº®èµ·ï¼›</li>
<li>å‡†å¤‡å¥½åº”ç”¨ç¨‹åºï¼Œç‚¹å‡»<code>B</code>å¤„çš„æŒ‰é’®ï¼Œæ“ä½œåº”ç”¨ç¨‹åºï¼Œå†æ¬¡ç‚¹å‡»<code>B</code>å¤„çš„æŒ‰é’®ï¼Œå³å¯ç”Ÿæˆtraceæ–‡ä»¶ï¼›</li>
<li>Android Studioè‡ªåŠ¨åœ¨æ“ä½œé¡µé¢çš„å³è¾¹æ‰“å¼€traceæ–‡ä»¶ï¼›</li>
</ol>
<p>æ‰§è¡Œå®Œæ¯•åå°±å¯ä»¥è§åˆ°å¦‚å›¾æ‰€ç¤ºçš„ç•Œé¢ã€‚å¦å¤–ï¼Œèƒ½ç¿»å¢™çš„ç«¥é‹å¯ä»¥æŸ¥çœ‹<a href="http://developer.android.com/intl/zh-cn/tools/performance/traceview/index.html" target="_blank" rel="noopener">å®˜ç½‘æŒ‡å¯¼</a>ã€‚</p>
<blockquote>
<p>è¿˜æœ‰ä¸€ç§åŠæ³•æ˜¯é€šè¿‡æ’å…¥Debugä»£ç è·å–traceæ–‡ä»¶ï¼Œè¯¦ç»†å¯å‚è€ƒ<a href="http://www.cnblogs.com/devinzhang/archive/2011/12/18/2291592.html" target="_blank" rel="noopener">Androidè°ƒè¯•å·¥å…·ä¹‹Traceview</a>ã€‚</p>
<p>åœ¨é—®é¢˜æ²¡æœ‰ç¡®å®šï¼Œä¸çŸ¥é“å…·ä½“å‡ºé—®é¢˜çš„ä»£ç åœ¨å“ªé‡Œæ—¶ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•å®šä½æ¯”è¾ƒç¹çã€‚å¯ä»¥ä½¿ç”¨å›¾å½¢åŒ–æ“ä½œæ–¹å¼å¤§è‡´ç¡®å®šå‡½æ•°ï¼ˆè¿™ç§æ–¹å¼ç›‘æ§çš„å‡½æ•°å¾ˆå¤šï¼Œåˆ†æèµ·æ¥æ¯”è¾ƒå›°éš¾ï¼‰ï¼Œç„¶åå†é€šè¿‡ä»£ç æ’å…¥æ–¹å¼è¿›ä¸€æ­¥åˆ†æã€‚</p>
</blockquote>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>ä»ä¸Šå›¾æ‰“å¼€çš„traceè§†å›¾æ¥çœ‹ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>ä¸ŠåŠéƒ¨åˆ†ç§°ä¸ºâ€Timeline Panelâ€ï¼šæè¿°äº†æ¯ä¸€ä¸ªçº¿ç¨‹çš„æ¯ä¸€ä¸ªæ–¹æ³•çš„å¯åŠ¨å’Œç»“æŸæ—¶é—´ï¼›</li>
<li>ä¸‹åŠéƒ¨åˆ†ç§°ä¸ºâ€Profile Panelâ€ï¼šåˆ†æäº†æ¯ä¸€ä¸ªæ–¹æ³•æ‰€åšçš„äº‹æƒ…ä»¥åŠè€—è´¹çš„æ—¶é—´ï¼›</li>
</ol>
<p><code>E</code>å¤„åˆ—å‡ºäº†ä¸»çº¿ç¨‹è¿™æ®µæ—¶é—´æ‰§è¡Œçš„æ‰€æœ‰å‡½æ•°ï¼Œç‚¹å‡»æœ€å·¦è¾¹çš„ç®­å¤´å¯ä»¥å±•å¼€ï¼Œçœ‹åˆ°è¯¥å‡½æ•°æ˜¯è¢«è°å”¤èµ·è°ƒç”¨çš„(Parents)ï¼Œåˆè°ƒç”¨äº†å“ªäº›å­å‡½æ•°ï¼ˆChildrenï¼‰ã€‚</p>
<p><code>F</code>å¤„åˆ™å±•ç°äº†å„ä¸ªç»Ÿè®¡ç»´åº¦ä¸‹çš„å€¼ã€‚ä¸‹é¢å°±è¯¦ç»†æ¥è¯´è¯´è¿™å—ã€‚</p>
<h3 id="ç»Ÿè®¡ç»´åº¦"><a href="#ç»Ÿè®¡ç»´åº¦" class="headerlink" title="ç»Ÿè®¡ç»´åº¦"></a>ç»Ÿè®¡ç»´åº¦</h3><p>Profile Panelå…±å±•ç°äº†ä¸€ä¸ªæ–¹æ³•çš„ä»¥ä¸‹ç»Ÿè®¡æ•°æ®:</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>Incl Cpu Time</td>
<td>å‡½æ•°æœ¬èº«è¿è¡Œå ç”¨çš„CPUæ—¶é—´ï¼ŒåŒ…æ‹¬å­å‡½æ•°</td>
</tr>
<tr>
<td>Excl Cpu Time</td>
<td>å‡½æ•°è¿è¡Œå ç”¨çš„CPUæ—¶é—´ï¼Œä¸åŒ…æ‹¬å­å‡½æ•°</td>
</tr>
<tr>
<td>Incl Real Time</td>
<td>å‡½æ•°æœ¬èº«è¿è¡Œçš„çœŸå®æ—¶é—´ï¼ŒåŒ…æ‹¬å­å‡½æ•°</td>
</tr>
<tr>
<td>Excl Real Time</td>
<td>å‡½æ•°è¿è¡Œçš„çœŸå®æ—¶é—´ï¼Œä¸åŒ…æ‹¬å­å‡½æ•°</td>
</tr>
<tr>
<td>Call+Recur Calls/Total</td>
<td>å‡½æ•°è¢«è°ƒç”¨çš„æ€»æ¬¡æ•°ä»¥åŠé€’å½’è°ƒç”¨å æ€»æ¬¡æ•°çš„ç™¾åˆ†æ¯”</td>
</tr>
<tr>
<td>Cpu Time/Call</td>
<td>å‡½æ•°å¹³å‡æ¯æ¬¡è°ƒç”¨æ‰€ç”¨çš„CPUæ—¶é—´</td>
</tr>
<tr>
<td>Real Time/Call</td>
<td>å‡½æ•°å¹³å‡æ¯æ¬¡è°ƒç”¨æ‰€ç”¨çš„çœŸå®æ—¶é—´</td>
</tr>
</tbody>
</table>
<blockquote>
<p>å…³äºCPUæ—¶é—´å’ŒçœŸå®æ—¶é—´ä¹‹é—´çš„åŒºåˆ«ï¼Œå¯ä»¥çœ‹StackOverFlowä¸Šçš„ä¸€ä¸ª<a href="http://stackoverflow.com/questions/15760447/what-is-the-meaning-of-incl-cpu-time-excl-cpu-time-incl-real-cpu-time-excl-re" target="_blank" rel="noopener">å¸–å­</a>: çœŸå®æ—¶é—´å…¶å®åŒ…æ‹¬äº†è¯¸å¦‚I/Oç­‰å¾…æ—¶é—´ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´ç­‰å¾…ç­‰ã€‚</p>
<p>ä»æ•°æ®çœ‹ï¼Œè¿™ä¸ªæ¨æ–­æ˜¯æˆç«‹çš„ï¼Œç¬¬ä¸€ä¸ªè®ºæ®å°±æ˜¯æ‰€æœ‰å‡½æ•°çš„CPUæ—¶é—´éƒ½å°äºçœŸå®æ—¶é—´ã€‚å¦å¤–ä¸€ä¸ªè¯æ®ï¼Œåé¢å†è¯´ã€‚</p>
</blockquote>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>æŒ‰ç…§è¿™ä¸ªè§£é‡Šï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªğŸŒ°ã€‚æˆ‘åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨äº†ä¸€ä¸ªå¦‚ä¸‹æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testForPer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Thread.sleep(<span class="number">300</span>);</span><br><span class="line">		Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"Done"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªå†™æ³•æ˜¯æœ‰é—®é¢˜çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆæ‰¾å‡ºå®ƒå‘¢ï¼Ÿæ ¹æ®çœŸå®æ—¶é—´å’ŒCPUæ—¶é—´çš„å·®åˆ«ï¼Œå¾ˆå®¹æ˜“ç¡®å®šä¸€ç‚¹ï¼šè¿™ä¸ªæ–¹æ³•è™½ç„¶çœŸå®æ—¶é—´å¾ˆé•¿ï¼Œè¾¾300ms+ï¼Œä½†æ˜¯CPUæ—¶é—´å¾ˆçŸ­ï¼Œå› ä¸ºæœ‰300mså¤„äºç¡çœ çŠ¶æ€ã€‚æ‰€ä»¥è¦æ•æ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•ï¼Œåº”è¯¥ä»çœŸå®æ—¶é—´å‡ºå‘ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•æ‰§è¡Œæ—¶é—´é•¿ï¼Œæ˜¯å› ä¸ºè°ƒç”¨äº†Threadçš„<code>sleep()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•300msæ‰è¿”å›ï¼Œå› æ­¤åº”å½“é€‰æ‹©åŒ…å«å­å‡½æ•°çš„ç»´åº¦ï¼Œå¦åˆ™è¯¥æ–¹æ³•æ²¡æœ‰ç‰¹æ®Šçš„åœ°æ–¹ã€‚</p>
<p>ç¬¦åˆä»¥ä¸Šåˆ¤æ–­çš„æŒ‡æ ‡æœ‰: Incl Real Timeã€Real Time/Callã€‚<br>åœ¨ä¸Šå›¾çš„<code>E</code>å¤„é€‰æ‹©åˆ°è¿™ä¸¤ä¸ªç»´åº¦ï¼Œç‚¹å‡»Headerï¼Œä½¿å¾—å…¶ä¸­ä¸€é¡¹æ˜¯é€’å‡æ’åˆ—çš„ã€‚</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/TraceViewåˆ†æ.png" alt="TraceViewåˆ†æ"><br>å¦‚å›¾å¾ˆå¿«å°±å¯ä»¥æŠ“å‡ºè¿™ä¸ªå‡½æ•°ã€‚å†çœ‹ä¸‹é¢è¿™ä¸ªå›¾ï¼Œæœ‰å…¨éƒ¨ç»´åº¦çš„æ•°æ®ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/TraceViewåˆ†æ2.png" alt="TraceViewåˆ†æ"><br>å¯ä»¥çœ‹åˆ°Incl Real Time(303.390ms)æ¯”Incl CPU Time(2.285)å¤§çº¦å°±é•¿äº†300msï¼Œæ­£æ˜¯sleepçš„æ—¶é—´ï¼Œä½è¯äº†å‰é¢å…³äºçœŸå®æ—¶é—´å’ŒCPUæ—¶é—´çš„çŒœæµ‹ã€‚</p>
<blockquote>
<p>PSï¼šè¿™ä¸ªä¾‹å­ä¸­çš„çœŸå®æ—¶é—´å’ŒCPUæ—¶é—´çš„å·®è·æ¯”è¾ƒé è°±æ˜¯å› ä¸ºæ­¤æ—¶CPUæ—¶é—´æ¯”è¾ƒå……è£•ï¼Œè¯»è€…å¯ä»¥è€ƒè™‘ä¸€ä¸‹å¦‚æœå½“å‰æœ‰æ•°åä¸ªçº¿ç¨‹ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸Šé¢çš„å®æˆ˜æ˜¯ä¸€ä¸ªå€’æ¨çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å…ˆçŸ¥é“äº†é—®é¢˜çš„æ‰€åœ¨ï¼Œå†å»æ•æ‰å®ƒï¼Œä½†å®é™…å¼€å‘ä¸­æˆ‘ä»¬æ— æ³•å¾—çŸ¥é—®é¢˜æ‰€åœ¨ï¼Œæ›´ä¸èƒ½åšå‡ºå¦‚ä¸Šçš„åˆ¤æ–­ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•ä¸‹æ‰‹å‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šå¼€å‘ä¸­å¸¸è§çš„ä¸¤ç±»é—®é¢˜å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ol>
<li>è°ƒç”¨æ¬¡æ•°éå¸¸é¢‘ç¹çš„å‡½æ•°â€”â€”è¿™ç±»å‡½æ•°å¿…é¡»å…³æ³¨æ•ˆç‡ï¼Œå¹¶ä¸”é˜²æ­¢è¿‡å¤šçš„åˆ†é…å†…å­˜ï¼›</li>
<li>æ‰§è¡Œæ—¶é—´å¾ˆé•¿çš„å‡½æ•°â€”â€”æ¯”å¦‚æˆ‘ä»¬çš„ä¾‹å­ä¸­å±•ç°çš„<code>testForPer()</code>ï¼›</li>
</ol>
<p>å‰è€…æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡Call + Recur Calls/Totalç»´åº¦å»çœ‹ï¼ŒæŸ¥æ‰¾å‡ºè°ƒç”¨æ¬¡æ•°éå¸¸å¤šçš„å‡½æ•°ï¼Œæ‰¾å‡ºè¿™äº›å‡½æ•°åï¼Œå¦‚æœå®ƒä»¬å ç”¨çš„CPUæ—¶é—´éå¸¸å¤šï¼ˆå¯ä»¥é€šè¿‡Incl CPU Timeåˆ¤æ–­ï¼‰ï¼Œåˆ™éœ€è¦ä¼˜åŒ–ï¼Œå¦å¤–å†…å­˜è¿™å—å¯èƒ½éœ€è¦æ‰‹åŠ¨checkä»£ç ï¼Œæˆ–è€…é€šè¿‡åˆ«çš„å·¥å…·æ£€æµ‹ã€‚</p>
<p>ç¬¬äºŒç§æƒ…å†µç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œé™¤äº†ä¾‹å­ä¸­å±•ç°çš„è¿™ç±»å‡½æ•°ï¼Œçš„çš„ç¡®ç¡®æ˜¯æœ‰å¦å¤–ä¸€ç±»å‡½æ•°ï¼Œè‡ªèº«æ‰§è¡Œæ—¶é—´éå¸¸è€—æ—¶ï¼Œæ¯”å¦‚è§£æä¸€ä¸ªè¶…é•¿çš„æ–‡æœ¬æ–‡ä»¶å°±ä¼šå¯¼è‡´å‡½æ•°æœ¬èº«è€—æ—¶å¾ˆä¹…ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨CPUæ—¶é—´æ¥åˆ¤æ–­äº†ã€‚</p>
<blockquote>
<p>å¯ä»¥ç»“åˆå‰é¢çš„é—®é¢˜è¿›è¡Œæ€è€ƒã€‚</p>
</blockquote>
<p>å› ä¸ºæ— æ³•åˆ¤æ–­å…·ä½“é—®é¢˜æ‰€åœ¨ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦ä»å¤šä¸ªç»´åº¦å¯¹å‡½æ•°è¿›è¡Œæ’åºï¼Œè§‚å¯Ÿæ˜¯å¦æœ‰å‡½æ•°å‡ºç°â€œä¸æ­£å¸¸â€æƒ…å†µï¼Œå¹¶åšå‡ºç›¸åº”çš„å¤„ç†ã€‚</p>
<p>æœ€åè¿™é‡Œä¹Ÿæœ‰ä¸€ç¯‡æ–‡ç« å†™çš„æ¯”è¾ƒæ¸…æ™°: <a href="http://bxbxbai.github.io/2014/10/25/use-trace-view/" target="_blank" rel="noopener">æ­£ç¡®ä½¿ç”¨Androidæ€§èƒ½åˆ†æå·¥å…·â€”â€”TraceView</a>ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidæ€§èƒ½ä¼˜åŒ–ç³»åˆ—é˜…è¯»ç¬”è®°]]></title>
      <url>http://www.timebridge.space/2016/05/03/Android-performance/</url>
      <content type="html"><![CDATA[<blockquote>
<p>æ„Ÿè°¢<a href="http://hukai.me" target="_blank" rel="noopener">@èƒ¡å‡¯</a>çš„è¾›å‹¤åŠ³åŠ¨ã€‚</p>
</blockquote>
<h3 id="ç¬¬ä¸€å­£"><a href="#ç¬¬ä¸€å­£" class="headerlink" title="ç¬¬ä¸€å­£"></a>ç¬¬ä¸€å­£</h3><h5 id="1-Render-Performance"><a href="#1-Render-Performance" class="headerlink" title="1.Render Performance"></a>1.Render Performance</h5><p>UIè¿™å—ç›´æ¥çœ‹<a href="http://www.csdn.net/article/2015-01-20/2823621-android-performance-patterns" target="_blank" rel="noopener">åŸæ–‡</a>ã€‚</p>
<h5 id="2-Memory-Churn-and-performance"><a href="#2-Memory-Churn-and-performance" class="headerlink" title="2.Memory Churn and performance"></a>2.Memory Churn and performance</h5><p>å¯¼è‡´GCé¢‘ç¹æ‰§è¡Œæœ‰ä¸¤ä¸ªåŸå› ï¼š</p>
<ol>
<li>Memory Churnå†…å­˜æŠ–åŠ¨ï¼Œå†…å­˜æŠ–åŠ¨æ˜¯å› ä¸ºå¤§é‡çš„å¯¹è±¡è¢«åˆ›å»ºåˆåœ¨çŸ­æ—¶é—´å†…é©¬ä¸Šè¢«é‡Šæ”¾ã€‚</li>
<li>ç¬é—´äº§ç”Ÿå¤§é‡çš„å¯¹è±¡ä¼šä¸¥é‡å ç”¨Young Generationçš„å†…å­˜åŒºåŸŸï¼Œå½“è¾¾åˆ°é˜€å€¼ï¼Œå‰©ä½™ç©ºé—´ä¸å¤Ÿçš„æ—¶å€™ï¼Œä¹Ÿä¼šè§¦å‘GCã€‚å³ä½¿æ¯æ¬¡åˆ†é…çš„å¯¹è±¡å ç”¨äº†å¾ˆå°‘çš„å†…å­˜ï¼Œä½†æ˜¯ä»–ä»¬å åŠ åœ¨ä¸€èµ·ä¼šå¢åŠ Heapçš„å‹åŠ›ï¼Œä»è€Œè§¦å‘æ›´å¤šå…¶ä»–ç±»å‹çš„GCã€‚è¿™ä¸ªæ“ä½œæœ‰å¯èƒ½ä¼šå½±å“åˆ°å¸§ç‡ï¼Œå¹¶ä½¿å¾—ç”¨æˆ·æ„ŸçŸ¥åˆ°æ€§èƒ½é—®é¢˜ã€‚</li>
</ol>
<a id="more"></a>è§£å†³ä¸Šé¢çš„é—®é¢˜æœ‰ç®€æ´ç›´è§‚æ–¹æ³•ï¼Œå¦‚æœä½ åœ¨Memory Monitoré‡Œé¢æŸ¥çœ‹åˆ°çŸ­æ—¶é—´å‘ç”Ÿäº†å¤šæ¬¡å†…å­˜çš„æ¶¨è·Œï¼Œè¿™æ„å‘³ç€å¾ˆæœ‰å¯èƒ½å‘ç”Ÿäº†å†…å­˜æŠ–åŠ¨ã€‚å¯ä»¥é€šè¿‡Heapå’ŒAllocation Trackerå·¥å…·æ¥æŸ¥çœ‹æ­¤æ—¶å†…å­˜ä¸­åˆ†é…çš„åˆ°åº•æœ‰å“ªäº›å¯¹è±¡ã€‚<br><div align="center"><img src="http://img.ptcms.csdn.net/article/201501/20/54bdcc0ed72c1.jpg" width="320" alt="å†…å­˜æŠ–åŠ¨"></div><br><br>æ¯”å¦‚åœ¨forå¾ªç¯ä¸­æ‰§è¡Œäº†åˆ›å»ºå¯¹è±¡çš„æ“ä½œã€‚<br><br>##### 3.Understanding Battery Drain on Android<br>ä»Android 5.0å¼€å§‹å‘å¸ƒäº†Battery History Toolï¼Œå®ƒå¯ä»¥æŸ¥çœ‹ç¨‹åºè¢«å”¤é†’çš„é¢‘ç‡ï¼Œåˆè°å”¤é†’çš„ï¼ŒæŒç»­äº†å¤šé•¿çš„æ—¶é—´ï¼Œè¿™äº›ä¿¡æ¯éƒ½å¯ä»¥è·å–åˆ°ã€‚<br><br>è¦æ³¨æ„WakeLockçš„ç”¨æ³•ã€‚<br><br>### ç¬¬äºŒå­£<br>&gt;åŒ…æ‹¬çš„å†…å®¹å¤§è‡´æœ‰ï¼šç”µé‡ä¼˜åŒ–ã€ç½‘ç»œä¼˜åŒ–ã€Android Wearä¸Šå¦‚ä½•åšä¼˜åŒ–ã€ä½¿ç”¨å¯¹è±¡æ± æ¥æé«˜æ•ˆç‡ã€LRU Cacheã€Bitmapçš„ç¼©æ”¾ã€ç¼“å­˜ã€é‡ç”¨ã€PNGå‹ç¼©ã€è‡ªå®šä¹‰Viewçš„æ€§èƒ½ã€æå‡è®¾ç½®alphaä¹‹åViewçš„æ¸²æŸ“æ€§èƒ½ï¼Œä»¥åŠLintã€StictModeç­‰å·¥å…·çš„ä½¿ç”¨æŠ€å·§ã€‚<br><br>##### 1.To Index or Iterate?<br>å¾ªç¯éå†çš„æ–¹å¼ï¼š1ï¼‰forï¼›2ï¼‰forâ€¦eachâ€¦ï¼›3ï¼‰Iteratorä¸‰ç§çš„æ•ˆç‡ä¸ä¸€æ ·ï¼Œforæ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯è¿™ä¸ªå’Œç¼–è¯‘å™¨æœ‰å…³ï¼Œéœ€è¦å®é™…æ£€éªŒã€‚<br><br>##### 2.Hidden Cost of Transparency<br>alphaä¼šè¦æ±‚Viewè¿›è¡ŒBlendæ··è‰²å¤„ç†ï¼Œè§¦å‘äº†é¢å¤–çš„ç»˜åˆ¶ä»»åŠ¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸å°‘æ€§èƒ½é—®é¢˜ã€‚<br><br>å¦‚ä½•æ¸²æŸ“æ‰èƒ½å¤Ÿå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å…ˆæŒ‰ç…§é€šå¸¸çš„æ–¹å¼æŠŠViewä¸Šçš„å…ƒç´ æŒ‰ç…§ä»ååˆ°å‰çš„æ–¹å¼ç»˜åˆ¶å‡ºæ¥ï¼Œä½†æ˜¯ä¸ç›´æ¥æ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œè€Œæ˜¯ä½¿ç”¨GPUé¢„å¤„ç†ä¹‹åï¼Œå†åˆGPUæ¸²æŸ“åˆ°å±å¹•ä¸Šï¼ŒGPUå¯ä»¥å¯¹ç•Œé¢ä¸Šçš„åŸå§‹æ•°æ®ç›´æ¥åšæ—‹è½¬ï¼Œè®¾ç½®é€æ˜åº¦ç­‰ç­‰æ“ä½œã€‚ä½¿ç”¨GPUè¿›è¡Œæ¸²æŸ“ï¼Œè™½ç„¶ç¬¬ä¸€æ¬¡æ“ä½œç›¸æ¯”èµ·ç›´æ¥ç»˜åˆ¶åˆ°å±å¹•ä¸Šæ›´åŠ è€—æ—¶ï¼Œå¯æ˜¯ä¸€æ—¦åŸå§‹çº¹ç†æ•°æ®ç”Ÿæˆä¹‹åï¼Œæ¥ä¸‹å»çš„æ“ä½œå°±æ¯”è¾ƒçœæ—¶çœåŠ›ã€‚<br><br>å¦‚ä½•æ‰èƒ½å¤Ÿè®©GPUæ¥æ¸²æŸ“æŸä¸ªViewå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡setLayerTypeçš„æ–¹æ³•æ¥æŒ‡å®šViewåº”è¯¥å¦‚ä½•è¿›è¡Œæ¸²æŸ“ï¼Œä»SDK 16å¼€å§‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ViewPropertyAnimator.alpha().withLayer()æ¥æŒ‡å®šã€‚<br><br>å¦å¤–ä¸€ä¸ªä¾‹å­æ˜¯<strong>åŒ…å«é˜´å½±åŒºåŸŸçš„View</strong>ï¼Œè¿™ç§ç±»å‹çš„Viewå¹¶ä¸ä¼šå‡ºç°æˆ‘ä»¬å‰é¢æåˆ°çš„é—®é¢˜ï¼Œå› ä¸ºä»–ä»¬å¹¶ä¸å­˜åœ¨å±‚å çš„å…³ç³»ã€‚ä¸ºäº†èƒ½å¤Ÿè®©æ¸²æŸ“å™¨çŸ¥é“è¿™ç§æƒ…å†µï¼Œé¿å…ä¸ºè¿™ç§Viewå ç”¨é¢å¤–çš„GPUå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬é€šè¿‡è®¾ç½®Viewçš„<code>hasOverlappingRendering()</code>æ–¹æ³•è¿”å›falseæ¥å®ç°ã€‚<br><br>##### 3.Custom Views and Performance<br>é€šå¸¸æ¥è¯´ï¼Œé’ˆå¯¹è‡ªå®šä¹‰Viewï¼Œæˆ‘ä»¬å¯èƒ½çŠ¯ä¸‹é¢ä¸‰ä¸ªé”™è¯¯ï¼š<br><br>1. Useless calls to onDraw()ï¼šæˆ‘ä»¬çŸ¥é“è°ƒç”¨View.invalidate()ä¼šè§¦å‘Viewçš„é‡ç»˜ï¼Œæœ‰ä¸¤ä¸ªåŸåˆ™éœ€è¦éµå®ˆï¼Œç¬¬1ä¸ªæ˜¯ä»…ä»…åœ¨Viewçš„å†…å®¹å‘ç”Ÿæ”¹å˜çš„æ—¶å€™æ‰å»è§¦å‘invalidateæ–¹æ³•ï¼Œç¬¬2ä¸ªæ˜¯å°½é‡ä½¿ç”¨ClipRectç­‰æ–¹æ³•æ¥æé«˜ç»˜åˆ¶çš„æ€§èƒ½ã€‚<br>2. Useless pixelsï¼šå‡å°‘ç»˜åˆ¶æ—¶ä¸å¿…è¦çš„ç»˜åˆ¶å…ƒç´ ï¼Œå¯¹äºé‚£äº›ä¸å¯è§çš„å…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦å°½é‡é¿å…é‡ç»˜ã€‚<br>3. Wasted CPU cyclesï¼šå¯¹äºä¸åœ¨å±å¹•ä¸Šçš„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨Canvas.quickRejectæŠŠä»–ä»¬ç»™å‰”é™¤ï¼Œé¿å…æµªè´¹CPUèµ„æºã€‚å¦å¤–å°½é‡ä½¿ç”¨GPUæ¥è¿›è¡ŒUIçš„æ¸²æŸ“ï¼Œè¿™æ ·èƒ½å¤Ÿæå¤§çš„æé«˜ç¨‹åºçš„æ•´ä½“è¡¨ç°æ€§èƒ½ã€‚<br><br>æ€»çš„æ¥è¯´ï¼šå°½é‡å°‘ç»˜åˆ¶ï¼Œç»˜åˆ¶çš„æ—¶å€™å°½é‡é™ä½æˆæœ¬ã€‚<br><br>### ç¬¬ä¸‰å­£<br>&gt;åŒ…æ‹¬çš„å†…å®¹å¤§è‡´æœ‰ï¼šæ›´é«˜æ•ˆçš„ArrayMapå®¹å™¨ï¼Œä½¿ç”¨Androidç³»ç»Ÿæä¾›çš„ç‰¹æ®Šå®¹å™¨æ¥é¿å…è‡ªåŠ¨è£…ç®±ï¼Œé¿å…ä½¿ç”¨æšä¸¾ç±»å‹ï¼Œæ³¨æ„onLowMemoryä¸onTrimMemoryçš„å›è°ƒï¼Œé¿å…å†…å­˜æ³„æ¼ï¼Œé«˜æ•ˆçš„ä½ç½®æ›´æ–°æ“ä½œï¼Œé‡å¤layoutæ“ä½œçš„æ€§èƒ½å½±å“ï¼Œä»¥åŠä½¿ç”¨Batchingï¼ŒPrefetchingä¼˜åŒ–ç½‘ç»œè¯·æ±‚ï¼Œå‹ç¼©ä¼ è¾“æ•°æ®ç­‰ç­‰ä½¿ç”¨æŠ€å·§ã€‚<br><br>##### 1. Fun with ArrayMaps<br>å’ŒSpareArrayç­‰å®¹å™¨ä¸€æ ·ï¼Œæ˜¯åœ¨ç©ºé—´ä¸æ—¶é—´ä¹‹é—´åšçš„ä¸€ä¸ªæƒè¡¡ï¼šå®ƒä»¬é€Ÿåº¦ä¸å¦‚HashMap(é‡‡å–çš„æ˜¯æŠ˜åŠæŸ¥æ‰¾)ï¼Œä½†å ç”¨æ›´å°‘çš„å†…å­˜ã€‚<br><br>å¯¹è±¡ä¸ªæ•°ä¹Ÿæœ€å¥½æ¯”è¾ƒå°‘ï¼ŒåŸæ–‡è¯´çš„æ˜¯åƒä»¥å†…ï¼šè¿‡å¤šçš„è¯ï¼Œç”±äºå®ç°é—®é¢˜ï¼Œä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™ã€‚<br><br>è¿™äº›å®¹å™¨é¡ºå¸¦ç€ä¹Ÿç…§é¡¾äº†è‡ªåŠ¨è£…ç®±æ‹†ç®±é—®é¢˜â€”â€”ä¹Ÿä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¹¶ä¸”ä¼šåˆ›å»ºå‡ºå¾ˆå¤šçš„å¯¹è±¡ã€‚<br><br>##### 2.The price of ENUMs<br>å®˜æ–¹åŸæ–‡:<br>&gt;Enums often require more than twice as much memory as static constants. You should strictly avoid using enums on Android.<br><br>æšä¸¾ä¼šå¤§å¤§å¢åŠ åŒ…ä½“ç§¯å¤§å°ï¼Œäº§ç”Ÿé¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œå®˜ç½‘å¼ºçƒˆå»ºè®®ä¸è¦å†Androidç¨‹åºä¸­ä½¿ç”¨æšä¸¾ã€‚<br><br>##### 3.Trimming and Sharing Memory<br>å¯ä»¥å‚è€ƒ<a href="http://hukai.me/android-training-managing_your_app_memory/" target="_blank" rel="noopener">Android Training - ç®¡ç†åº”ç”¨çš„å†…å­˜</a>ã€‚<br><br>ä»Android 4.4å¼€å§‹ï¼ŒActivityManageræä¾›äº†isLowRamDevice()çš„APIï¼Œé€šå¸¸æŒ‡çš„æ˜¯Heap Sizeä½äº512Mæˆ–è€…å±å¹•å¤§å°&lt;=800*480çš„è®¾å¤‡ã€‚<br><br>##### 4.Location &amp; Battery Drain<br>å‡¡æ˜¯è¯·æ±‚è€—èµ„æºçš„èµ„æºï¼Œéƒ½å¯ä»¥é€šè¿‡å†å²çš„æ•°æ®æ”¹å˜è¯·æ±‚é—´éš”ï¼Œå°½é‡å‡å°‘è¯·æ±‚æ¬¡æ•°ã€‚<br><br>å®šä½å¯ä»¥é€šè¿‡<code>LocationRequest.setPriority()</code>åœ¨è€—ç”µé‡å’Œç²¾ç¡®æ€§ä¹‹é—´åšå‡ºæƒè¡¡ã€‚<br><br>##### 5.Double Layout Taxation<br>1. å°½é‡ä¿æŒView Hierarchyçš„å±‚çº§æ¯”è¾ƒæµ…ï¼Œè¿™æ ·å³ä½¿å‘ç”Ÿé‡å¤layoutï¼Œä¹Ÿä¸ä¼šå› ä¸ºå¸ƒå±€çš„å±‚çº§æ¯”è¾ƒæ·±è€Œå¢å¤§äº†é‡å¤layoutçš„å€æ•°;<br>2. åœ¨ä»»ä½•æ—¶å€™éƒ½è¯·é¿å…è°ƒç”¨requestLayout()çš„æ–¹æ³•ï¼Œå› ä¸ºä¸€æ—¦è°ƒç”¨äº†requestLayoutï¼Œä¼šå¯¼è‡´è¯¥layoutçš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹éƒ½å‘ç”Ÿé‡æ–°layoutçš„æ“ä½œ;<br><br>##### 6.Network Performance 101<br>ä¸¤ä¸ªåŸåˆ™:<br><br>1. å‡å°‘ç§»åŠ¨ç½‘ç»œè¢«æ¿€æ´»çš„æ—¶é—´ä¸æ¬¡æ•°;<br>2. å‹ç¼©ä¼ è¾“æ•°æ®;<br><br>ç”Ÿç½‘ç»œè¡Œä¸ºå¯ä»¥åˆ’åˆ†ä¸ºä¸‰ç§ç±»å‹:<br><br>1. ç”¨æˆ·ä¸»åŠ¨è§¦å‘çš„è¯·æ±‚;<br>2. è¢«åŠ¨æ¥æ”¶æœåŠ¡å™¨çš„è¿”å›æ•°æ®;<br>3. æœ€åä¸€ä¸ªæ˜¯æ•°æ®ä¸ŠæŠ¥ï¼Œè¡Œä¸ºä¸ŠæŠ¥ï¼Œä½ç½®æ›´æ–°ç­‰ç­‰è‡ªå®šä¹‰çš„åå°æ“ä½œ;<br><br>åº”è¯¥éµå¾ªä¸‹é¢çš„è§„åˆ™æ¥å¤„ç†æ•°æ®åŒæ­¥çš„é—®é¢˜:<br><br>1. åœ¨æŸäº›å¿…é¡»åšåŒæ­¥çš„åœºæ™¯ä¸‹ï¼Œéœ€è¦é¿å…ä½¿ç”¨å›ºå®šçš„é—´éš”é¢‘ç‡æ¥è¿›è¡Œæ›´æ–°æ“ä½œï¼Œæˆ‘ä»¬åº”è¯¥åœ¨è¿”å›çš„æ•°æ®æ— æ›´æ–°çš„æ—¶å€™ï¼Œä½¿ç”¨åŒå€çš„é—´éš”æ—¶é—´æ¥è¿›è¡Œä¸‹ä¸€æ¬¡åŒæ­¥ï¼ˆç­–ç•¥è°ƒæ•´ï¼‰;<br>2. ä½¿ç”¨Batching(æ‰¹å¤„ç†)çš„æ–¹å¼æ¥é›†ä¸­å‘å‡ºè¯·æ±‚ï¼Œé¿å…é¢‘ç¹çš„é—´éš”è¯·æ±‚;<br>3. ä½¿ç”¨Prefetchingï¼ˆé¢„å–ï¼‰çš„æŠ€æœ¯æå‰æŠŠä¸€äº›æ•°æ®æ‹¿åˆ°ï¼Œé¿å…åé¢é¢‘ç¹å†æ¬¡å‘èµ·ç½‘ç»œè¯·æ±‚;<br>4. å¯¹ç½‘ç»œè¡Œä¸ºè¿›è¡Œåˆ†ç±»ï¼ŒåŒºåˆ†éœ€è¦ç«‹å³æ›´æ–°æ•°æ®çš„è¡Œä¸ºå’Œå…¶ä»–å¯ä»¥è¿›è¡Œå»¶è¿Ÿçš„æ›´æ–°è¡Œä¸ºï¼Œä¸ºä¸åŒçš„åœºæ™¯è¿›è¡Œå·®å¼‚åŒ–å¤„ç†ï¼›<br>5. è¦é¿å…å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„è½®è¯¢æ“ä½œï¼Œè¿™æ ·ä¼šæµªè´¹å¾ˆå¤šçš„ç”µé‡ä¸å¸¦å®½æµé‡ã€‚è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Google Cloud Messageæ¥å¯¹æ›´æ–°çš„æ•°æ®è¿›è¡Œæ¨é€ï¼›<br>6. è¿˜å¯ä»¥é€šè¿‡åˆ¤æ–­å½“å‰è®¾å¤‡çš„çŠ¶æ€æ¥å†³å®šåŒæ­¥çš„é¢‘ç‡ï¼Œä¾‹å¦‚åˆ¤æ–­è®¾å¤‡å¤„äºä¼‘çœ ï¼Œè¿åŠ¨ç­‰ä¸åŒçš„çŠ¶æ€è®¾è®¡å„è‡ªä¸åŒæ—¶é—´é—´éš”çš„åŒæ­¥é¢‘ç‡ï¼›<br>7. å¯ä»¥é€šè¿‡åˆ¤æ–­è®¾å¤‡æ˜¯å¦è¿æ¥ä¸ŠWi-Fiï¼Œæ˜¯å¦æ­£åœ¨å……ç”µæ¥å†³å®šæ›´æ–°çš„é¢‘ç‡ã€‚ä¸ºäº†èƒ½å¤Ÿæ–¹ä¾¿çš„å®ç°è¿™ä¸ªåŠŸèƒ½ï¼ŒAndroidä¸ºæˆ‘ä»¬æä¾›äº†GCMNetworkManageræ¥åˆ¤æ–­è®¾å¤‡å½“ä¸‹çš„çŠ¶æ€ï¼Œä»è€Œè®¾è®¡æ›´åŠ é«˜æ•ˆçš„ç½‘ç»œåŒæ­¥æ“ä½œï¼›<br><br>##### 7.Effective Network Batching<br>å‘èµ·ç½‘ç»œè¯·æ±‚ä¸æ¥æ”¶è¿”å›æ•°æ®éƒ½æ˜¯æ¯”è¾ƒè€—ç”µçš„ï¼Œåœ¨ç½‘ç»œç¡¬ä»¶æ¨¡å—è¢«æ¿€æ´»ä¹‹åï¼Œä¼šç»§ç»­ä¿æŒå‡ åç§’çš„ç”µé‡æ¶ˆè€—ï¼Œç›´åˆ°æ²¡æœ‰æ–°çš„ç½‘ç»œæ“ä½œè¡Œä¸ºä¹‹åï¼Œæ‰ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚å‰é¢ä¸€ä¸ªæ®µè½ä»‹ç»äº†ä½¿ç”¨Batchingçš„æŠ€æœ¯æ¥æ†ç»‘ç½‘ç»œè¯·æ±‚ï¼Œä»è€Œè¾¾åˆ°å‡å°‘ç½‘ç»œè¯·æ±‚çš„é¢‘ç‡ã€‚é‚£ä¹ˆå¦‚ä½•å®ç°BatchingæŠ€æœ¯å‘¢ï¼Ÿé€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä¼šæŠŠé‚£äº›å‘å‡ºçš„ç½‘ç»œè¯·æ±‚ï¼Œå…ˆæš‚å­˜åˆ°ä¸€ä¸ªPendingQueueé‡Œé¢ï¼Œç­‰åˆ°æ¡ä»¶åˆé€‚çš„æ—¶å€™å†è§¦å‘Queueé‡Œé¢çš„ç½‘ç»œè¯·æ±‚ã€‚<br><br>å¯æ˜¯ä»€ä¹ˆæ—¶å€™æ‰ç®—æ˜¯æ¡ä»¶åˆé€‚äº†å‘¢ï¼Ÿæœ€ç®€å•ç²—æš´çš„ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åœ¨Queueå¤§å°åˆ°10çš„æ—¶å€™è§¦å‘ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å½“æ‰‹æœºå¼€å§‹å……ç”µï¼Œæˆ–è€…æ˜¯æ‰‹æœºè¿æ¥åˆ°WiFiç­‰æƒ…å†µä¸‹æ‰è§¦å‘é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚æ‰‹åŠ¨ç¼–å†™ä»£ç å»å®ç°è¿™äº›åŠŸèƒ½ä¼šæ¯”è¾ƒå¤æ‚ç¹çï¼ŒGoogleä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†GCMNetworkManageræ¥å¸®åŠ©å®ç°é‚£äº›åŠŸèƒ½ï¼Œä»…ä»…åªéœ€è¦è°ƒç”¨APIï¼Œè®¾ç½®è§¦å‘æ¡ä»¶ï¼Œç„¶åå°±OKäº†ã€‚<br><br>é¢„å–ä»¥åŠç½‘ç»œè¡Œä¸ºè¿˜è¦è€ƒè™‘å½“å‰çš„ç½‘ç»œçŠ¶æ€æ˜¯å¦è‰¯å¥½â€”â€”æ ¹æ®ç½‘ç»œçŠ¶æ€è°ƒæ•´è¡Œä¸ºã€‚<br><br>Androidå®˜æ–¹ä¸ºäº†å¸®åŠ©æˆ‘ä»¬è®¾è®¡è‡ªå·±çš„ç½‘ç»œè¯·æ±‚ç­–ç•¥ï¼Œæä¾›äº†æ¨¡æ‹Ÿå™¨çš„ç½‘ç»œæµé‡æ§åˆ¶åŠŸèƒ½æ¥å¯¹å®é™…ç¯å¢ƒè¿›è¡Œæ¨¡æ‹Ÿæµ‹é‡ï¼Œæˆ–è€…è¿˜å¯ä»¥ä½¿ç”¨AT&amp;Tæä¾›çš„<a href="http://developer.att.com/developer/legalAgreementPage.jsp?passedItemId=14500040" target="_blank" rel="noopener">AT&amp;T Network Attenuator</a>æ¥å¸®åŠ©é¢„ä¼°ç½‘ç»œå»¶è¿Ÿã€‚<br><br>ä½¿ç”¨<a href="http://developer.android.com/intl/zh-cn/tools/debugging/ddms.html#network" target="_blank" rel="noopener">Network Traffic tool</a>å¯ä»¥æŸ¥çœ‹ç½‘ç»œè¯·æ±‚å‘ç”Ÿçš„æ—¶é—´ï¼Œæ¯æ¬¡è¯·æ±‚çš„æ•°æ®é‡ç­‰ç­‰ä¿¡æ¯ã€‚<br><br>##### 8.Effective Prefetching<br>é¢„å…ˆè·å–å¤šå°‘æ•°æ®é‡æ˜¯å¾ˆå€¼å¾—è€ƒé‡çš„ï¼Œå› ä¸ºå¦‚æœé¢„å–æ•°æ®é‡åå°‘ï¼Œå°±èµ·ä¸åˆ°å‡å°‘é¢‘ç¹è¯·æ±‚çš„ä½œç”¨ï¼Œå¯æ˜¯å¦‚æœé¢„å–æ•°æ®è¿‡å¤šï¼Œå°±ä¼šé€ æˆèµ„æºçš„æµªè´¹ã€‚<br><br>æˆ‘ä»¬å¯ä»¥å‚è€ƒåœ¨WiFiï¼Œ4Gï¼Œ3Gç­‰ä¸åŒçš„ç½‘ç»œä¸‹è®¾è®¡ä¸åŒå¤§å°çš„é¢„å–æ•°æ®é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯æŒ‰ç…§å›¾ç‰‡æ•°é‡æˆ–è€…æ“ä½œæ—¶é—´æ¥ä½œä¸ºé˜€å€¼ã€‚è¿™éœ€è¦æˆ‘ä»¬éœ€è¦æ ¹æ®ç‰¹å®šçš„åœºæ™¯ï¼Œä¸åŒçš„ç½‘ç»œæƒ…å†µè®¾è®¡åˆé€‚çš„æ–¹æ¡ˆã€‚<br><br>### ç¬¬å››å­£<br>&gt;æ¶‰åŠçš„å†…å®¹æœ‰ï¼šä¼˜åŒ–ç½‘ç»œè¯·æ±‚çš„è¡Œä¸ºï¼Œä¼˜åŒ–å®‰è£…åŒ…çš„èµ„æºæ–‡ä»¶ï¼Œä¼˜åŒ–æ•°æ®ä¼ è¾“çš„æ•ˆç‡ï¼Œæ€§èƒ½ä¼˜åŒ–çš„å‡ å¤§åŸºç¡€åŸç†ç­‰ç­‰ã€‚<br><br>##### 1.Cachematters for networking<br>Androidç³»ç»Ÿä¸Šå…³äºç½‘ç»œè¯·æ±‚çš„Http Response Cacheæ˜¯é»˜è®¤å…³é—­çš„ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¯æ¬¡å³ä½¿è¯·æ±‚çš„æ•°æ®å†…å®¹æ˜¯ä¸€æ ·çš„ä¹Ÿä¼šéœ€è¦é‡å¤è¢«è°ƒç”¨æ‰§è¡Œï¼Œæ•ˆç‡ä½ä¸‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ç¤ºä¾‹å¼€å¯HttpResponseCacheã€‚<br><br>å¼€å¯Http Response Cacheä¹‹åï¼ŒHttpæ“ä½œç›¸å…³çš„è¿”å›æ•°æ®å°±ä¼šç¼“å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œä¸ä»…ä»…æ˜¯ä¸»ç¨‹åºè‡ªå·±ç¼–å†™çš„ç½‘ç»œè¯·æ±‚ç›¸å…³çš„æ•°æ®ä¼šè¢«ç¼“å­˜ï¼Œå¦å¤–å¼•å…¥çš„libraryåº“ä¸­çš„ç½‘ç»œç›¸å…³çš„è¯·æ±‚æ•°æ®ä¹Ÿä¼šè¢«ç¼“å­˜åˆ°è¿™ä¸ªCacheä¸­ã€‚<br><br>Httpè‡ªå·±æœ‰ç¼“å­˜æœºåˆ¶ï¼Œä½†æ˜¯æœ‰å¯èƒ½å¤±æ•ˆï¼ˆä¸æ˜¯æ¯ä¸€ä¸ªæœåŠ¡ç«¯éƒ½ä¼šè¿”å›æ­£å¸¸çš„ç¼“å­˜Headerï¼‰ï¼Œå› æ­¤æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦è‡ªå·±ç®¡ç†ç¼“å­˜ï¼Œå¼€æºæ¡†æ¶è¿™ä¸ªæ—¶å€™å°±æ¯”è¾ƒæœ‰ç”¨äº†ã€‚<br><br>å¯ä»¥ä½¿ç”¨Android Studioé‡Œé¢çš„Network Traffic Toolsæ¥æŸ¥çœ‹ç½‘ç»œæ•°æ®çš„è¯·æ±‚ä¸è¿”å›æƒ…å†µï¼Œå¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<a href="https://developer.att.com/application-resource-optimizer" target="_blank" rel="noopener">AT&amp;T AROå·¥å…·</a>æ¥æŠ“å–ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œåˆ†ææŸ¥çœ‹ã€‚<br><br>##### 2.Optimizing Network Request Frequencies<br>è¿™éƒ¨åˆ†é›†ä¸­åˆ°ç¬¬ä¸‰å­£æœ‰å…³ç½‘ç»œçš„éƒ¨åˆ†ã€‚<br><br>##### 3.Minimizing Asset Payload<br>ä¸»è¦æ˜¯å›¾ç‰‡ä¸ªåºåˆ—åŒ–æ•°æ®ã€‚<br><br>å›¾ç‰‡å¯ä»¥ä»æ ¼å¼å…¥æ‰‹:<br><div align="center"><img src="http://img.blog.csdn.net/20160112164609185" width="160" alt="PNG,JPEG,WEBPä¸‰ç§ä¸»æµæ ¼å¼åœ¨å ç”¨ç©ºé—´ä¸å›¾ç‰‡è´¨é‡ä¹‹é—´çš„å¯¹æ¯”"></div><br><br>&gt;Webpï¼Œå®ƒæ˜¯ç”±Googleæ¨å‡ºçš„ä¸€ç§æ—¢ä¿ç•™pngæ ¼å¼çš„ä¼˜ç‚¹ï¼Œåˆèƒ½å¤Ÿå‡å°‘å›¾ç‰‡å¤§å°çš„ä¸€ç§æ–°å‹å›¾ç‰‡æ ¼å¼ã€‚å…³äºWebpçš„æ›´å¤šç»†èŠ‚<br><br>å°½é‡å‡å°‘PNGå›¾ç‰‡çš„å¤§å°æ˜¯Androidé‡Œé¢å¾ˆé‡è¦çš„ä¸€æ¡è§„èŒƒã€‚ç›¸æ¯”èµ·JPEGï¼ŒPNGèƒ½å¤Ÿæä¾›æ›´åŠ æ¸…æ™°æ— æŸçš„å›¾ç‰‡ï¼Œä½†æ˜¯PNGæ ¼å¼çš„å›¾ç‰‡ä¼šæ›´å¤§ï¼Œå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ã€‚åˆ°åº•æ˜¯ä½¿ç”¨PNGè¿˜æ˜¯JPEGï¼Œéœ€è¦è®¾è®¡å¸ˆä»”ç»†è¡¡é‡ï¼Œå¯¹äºé‚£äº›ä½¿ç”¨JPEGå°±å¯ä»¥è¾¾åˆ°è§†è§‰æ•ˆæœçš„ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨JPEGå³å¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Googleæœç´¢åˆ°å¾ˆå¤šå…³äºPNGå‹ç¼©çš„å·¥å…·ã€‚<br><br>å¦å¤–ï¼šæœåŠ¡å™¨åº”è¯¥æ”¯æŒåˆ°ä¸ºä¸åŒçš„ä½¿ç”¨åœºæ™¯åˆ†åˆ«å‡†å¤‡å¤šå¥—æ¸…æ™°åº¦ä¸ä¸€æ ·çš„å›¾ç‰‡ï¼Œä»¥ä¾¿åœ¨å¯¹åº”çš„åœºæ™¯ä¸‹èƒ½å¤Ÿè·å–åˆ°æœ€é€‚åˆè‡ªå·±çš„å›¾ç‰‡ã€‚<br><br>&gt;äº†è§£Bitmapçš„4ç§è§£ç æ ¼å¼ï¼ŒinBitmapå±æ€§ã€‚<br><br>Googleä»‹ç»äº†ä¸€ä¸ªå¼€æºçš„åŠ è½½bitmapçš„åº“ï¼š<strong>Glide</strong>ï¼Œè¿™é‡Œé¢åŒ…å«äº†å„ç§å¯¹bitmapçš„ä¼˜åŒ–æŠ€å·§ã€‚<br><br>æ•°æ®å¯ä»¥ä»åºåˆ—åŒ–æ–¹å¼å…¥æ‰‹ï¼Œåº”è¯¥ä½¿ç”¨Protocal Buffersï¼ŒNano-Proto-Buffersï¼ŒFlatBufferæ¥å‡å°åºåˆ—åŒ–çš„æ•°æ®çš„å¤§å°ã€‚<br><br>1. <strong>ã€Protocal Buffersã€‘</strong>å¼ºå¤§ï¼Œçµæ´»ï¼Œä½†æ˜¯å¯¹å†…å­˜çš„æ¶ˆè€—ä¼šæ¯”è¾ƒå¤§ï¼Œå¹¶ä¸æ˜¯ç§»åŠ¨ç»ˆç«¯ä¸Šçš„æœ€ä½³é€‰æ‹©ã€‚<br>2. <strong>ã€Nano-Proto-Buffersã€‘</strong>åŸºäºProtocalï¼Œä¸ºç§»åŠ¨ç»ˆç«¯åšäº†ç‰¹æ®Šçš„ä¼˜åŒ–ï¼Œä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼Œå†…å­˜ä½¿ç”¨æ•ˆç‡æ›´ä½³ã€‚<br>3. <strong>ã€FlatBuffersã€‘</strong>è¿™ä¸ªå¼€æºåº“æœ€å¼€å§‹æ˜¯ç”±Googleç ”å‘çš„ï¼Œä¸“æ³¨äºæä¾›æ›´ä¼˜ç§€çš„æ€§èƒ½ã€‚<br><br>å¯¹æ¯”æ•°æ®å¦‚ä¸‹:<br><div align="center"><img src="http://img.blog.csdn.net/20160112165416290" width="320" alt="æ€§èƒ½å¯¹æ¯”æ•°æ®"></div><br><br><div align="center"><img src="http://img.blog.csdn.net/20160112165503594" width="320" alt="æ€§èƒ½å¯¹æ¯”æ•°æ®"></div><br><br>å¦å¤–ï¼š<strong>æ•°æ®å‘ˆç°çš„é¡ºåºä»¥åŠç»“æ„ä¼šå¯¹åºåˆ—åŒ–ä¹‹åçš„ç©ºé—´äº§ç”Ÿä¸å°çš„å½±å“ï¼ˆè¿™ä¸€ç‚¹å»ºè®®çœ‹åŸæ–‡ï¼Œå¾ˆé‡è¦ï¼ï¼‰ã€‚</strong><br><br>##### 4.APKç˜¦èº«<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buildTypes&#123;</span><br><span class="line">	release&#123;</span><br><span class="line">		minifyEnabled <span class="keyword">true</span> <span class="comment">//åˆ é™¤æ— ç”¨çš„ä»£ç </span></span><br><span class="line">		shrinkResource <span class="keyword">true</span> <span class="comment">//åˆ é™¤æ— ç”¨çš„èµ„æº</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡tools:keepæˆ–è€…æ˜¯tools:discardæ ‡ç­¾æ¥å®ç°å¯¹ç‰¹å®šèµ„æºçš„ä¿ç•™ä¸åºŸå¼ƒâ€”â€”å’ŒProguardçš„keepä¸€æ ·ã€‚</p>
<h3 id="ç¬¬äº”å­£"><a href="#ç¬¬äº”å­£" class="headerlink" title="ç¬¬äº”å­£"></a>ç¬¬äº”å­£</h3><blockquote>
<p>æ¶‰åŠçš„å†…å®¹æœ‰ï¼šå¤šçº¿ç¨‹å¹¶å‘çš„æ€§èƒ½é—®é¢˜ï¼Œä»‹ç»äº†AsyncTaskã€HandlerThreadã€IntentServiceä¸ThreadPoolåˆ†åˆ«é€‚åˆçš„ä½¿ç”¨åœºæ™¯ä»¥åŠå„è‡ªçš„ä½¿ç”¨æ³¨æ„äº‹é¡¹ã€‚</p>
<div align="center"><img src="http://img.blog.csdn.net/20160429192507841" width="160" alt="GPU ProfilingåŸæ­¥éª¤"></div>

</blockquote>
<p>ä»Android Mç³»ç»Ÿå¼€å§‹ï¼Œç³»ç»Ÿæ›´æ–°äº†GPU Profilingçš„å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬å®šä½UIçš„æ¸²æŸ“æ€§èƒ½é—®é¢˜ã€‚æ—©æœŸçš„CPU Profilingå·¥å…·åªèƒ½ç²—ç•¥çš„æ˜¾ç¤ºå‡ºProcessã€Executeã€Updateä¸‰å¤§æ­¥éª¤çš„æ—¶é—´è€—è´¹æƒ…å†µã€‚</p>
<p>ä½†æ˜¯ä»…ä»…æ˜¾ç¤ºä¸‰å¤§æ­¥éª¤çš„æ—¶é—´è€—è´¹æƒ…å†µï¼Œè¿˜æ˜¯ä¸å¤ªèƒ½å¤Ÿæ¸…æ™°å¸®åŠ©æˆ‘ä»¬å®šä½å…·ä½“çš„ç¨‹åºä»£ç é—®é¢˜ï¼Œæ‰€ä»¥åœ¨Android Mç‰ˆæœ¬å¼€å§‹ï¼ŒGPU Profilingå·¥å…·æŠŠæ¸²æŸ“æ“ä½œæ‹†è§£æˆå¦‚ä¸‹8ä¸ªè¯¦ç»†çš„æ­¥éª¤è¿›è¡Œæ˜¾ç¤ºã€‚</p>
<p><div align="center"><img src="http://img.blog.csdn.net/20160429192539045" width="160" alt="GPU Profilingæ­¥éª¤"></div><br>æ—§ç‰ˆæœ¬ä¸­æåˆ°çš„Processã€Executeã€Updateè¿˜æ˜¯ç»§ç»­å¾—åˆ°äº†ä¿ç•™ï¼Œä»–ä»¬çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><div align="center"><img src="http://img.blog.csdn.net/20160429192645858" width="160" alt="æ—§ç‰ˆæœ¬æ­¥éª¤"></div><br>å…¶ä»–5ä¸ªæ­¥éª¤åˆ†åˆ«ä»£è¡¨äº†ä»€ä¹ˆå«ä¹‰ï¼š</p>
<ol>
<li><strong>ã€Sync &amp; Uploadã€‘</strong>é€šå¸¸è¡¨ç¤ºçš„æ˜¯å‡†å¤‡å½“å‰ç•Œé¢ä¸Šæœ‰å¾…ç»˜åˆ¶çš„å›¾ç‰‡æ‰€è€—è´¹çš„æ—¶é—´ï¼Œä¸ºäº†å‡å°‘è¯¥æ®µåŒºåŸŸçš„æ‰§è¡Œæ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥å‡å°‘å±å¹•ä¸Šçš„å›¾ç‰‡æ•°é‡æˆ–è€…æ˜¯ç¼©å°å›¾ç‰‡æœ¬èº«çš„å¤§å°ã€‚</li>
<li><strong>ã€Measure &amp; Layoutã€‘</strong>è¿™é‡Œè¡¨ç¤ºçš„æ˜¯å¸ƒå±€çš„onMeasureä¸onLayoutæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œä¸€æ—¦æ—¶é—´è¿‡é•¿ï¼Œå°±éœ€è¦ä»”ç»†æ£€æŸ¥è‡ªå·±çš„å¸ƒå±€æ˜¯ä¸æ˜¯å­˜åœ¨ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚</li>
<li><strong>ã€Animationã€‘</strong>è¡¨ç¤ºçš„æ˜¯è®¡ç®—æ‰§è¡ŒåŠ¨ç”»æ‰€éœ€è¦èŠ±è´¹çš„æ—¶é—´ï¼ŒåŒ…å«çš„åŠ¨ç”»æœ‰ObjectAnimatorï¼ŒViewPropertyAnimatorï¼ŒTransitionç­‰ç­‰ã€‚ä¸€æ—¦è¿™é‡Œçš„æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå°±éœ€è¦æ£€æŸ¥æ˜¯ä¸æ˜¯ä½¿ç”¨äº†éå®˜æ–¹çš„åŠ¨ç”»å·¥å…·æˆ–è€…æ˜¯æ£€æŸ¥åŠ¨ç”»æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ˜¯ä¸æ˜¯è§¦å‘äº†è¯»å†™æ“ä½œç­‰ç­‰ã€‚</li>
<li><strong>ã€Input Handlingã€‘</strong>è¡¨ç¤ºçš„æ˜¯ç³»ç»Ÿå¤„ç†è¾“å…¥äº‹ä»¶æ‰€è€—è´¹çš„æ—¶é—´ï¼Œç²—ç•¥ç­‰äºå¯¹äºçš„äº‹ä»¶å¤„ç†æ–¹æ³•æ‰€æ‰§è¡Œçš„æ—¶é—´ã€‚ä¸€æ—¦æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œæ„å‘³ç€åœ¨å¤„ç†ç”¨æˆ·çš„è¾“å…¥äº‹ä»¶çš„åœ°æ–¹æ‰§è¡Œäº†å¤æ‚çš„æ“ä½œã€‚</li>
<li><strong>ã€Misc/Vsync Delayã€‘</strong>å¦‚æœç¨åŠ æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘åº”ç”¨çš„Logæ—¥å¿—é‡Œé¢çœ‹åˆ°è¿™æ ·ä¸€è¡Œæç¤ºï¼šI/Choreographer(691): Skipped XXX frames! The application may be doing too much work on its main threadã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œäº†å¤ªå¤šçš„ä»»åŠ¡ï¼Œå¯¼è‡´UIæ¸²æŸ“è·Ÿä¸ä¸ŠvSyncçš„ä¿¡å·è€Œå‡ºç°æ‰å¸§çš„æƒ…å†µã€‚</li>
</ol>
<p>å…¶ä½™éƒ½æ˜¯æœ‰å…³çº¿ç¨‹çš„ï¼Œä¸ä½œæ•´ç†ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Instant Run ç®€ä»‹]]></title>
      <url>http://www.timebridge.space/2016/05/03/Android-instantrun/</url>
      <content type="html"><![CDATA[<p>ç¿»è¯‘è‡ª: <a href="http://tools.android.com/tech-docs/instant-run" target="_blank" rel="noopener">Instant Run</a></p>
<blockquote>
<p>Instant Runå¹¶ä¸æ”¯æŒ<a href="https://source.android.com/source/jack.html" target="_blank" rel="noopener">Jack</a>ï¼ŒJackéœ€è¦Android Næä¾›çš„å¯¹Java 8çš„è¯­è¨€ç‰¹æ€§çš„æ”¯æŒã€‚å…³äºJava 8å’ŒJackï¼Œå¯ä»¥çœ‹<a href="http://developer.android.com/intl/zh-cn/preview/j8-jack.html" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p>
</blockquote>
<p>Instant Runåœ¨Android Studio 2.0æ­£å¼è¿›å…¥ç”Ÿäº§ç¯å¢ƒï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å‡å°‘é€šè¿‡<code>Run</code>å’Œ<code>Debug</code>éƒ¨ç½²Appçš„æ—¶é—´ã€‚Instant Runä¸ä¼šåœ¨é¡¹ç›®æœ‰æ›´æ”¹ä¹‹åé‡æ–°æ‰“åŒ…APKï¼Œè€Œæ˜¯ä¼šæŠŠä»£ç å’Œèµ„æºçš„å˜åŒ–ç›´æ¥Pushåˆ°æœºå™¨ä¸Šï¼Œå› æ­¤å˜åŒ–å‡ ä¹æ˜¯ç¬æ—¶ååº”åœ¨è®¾å¤‡ä¸Šçš„ã€‚<a id="more"></a></p>
<p>å½“é…ç½®å¥½é¡¹ç›®å¹¶è¿è¡Œä¸€æ¬¡ä¹‹åï¼Œ<code>Run</code>çš„ç®­å¤´Iconå·¦è¾¹å°±ä¼šå‡ºç°ä¸€ä¸ªé»„è‰²çš„é—ªç”µIconï¼ˆ<code>Debug</code>ä¹Ÿæ˜¯ä¸€æ ·ï¼Œéœ€è¦å…ˆè·‘ä¸€æ¬¡ï¼‰ï¼Œè¿™å°±è¡¨ç¤ºInstant Runå·²ç»å‡†å¤‡å¥½ä¸ºä½ æ›´æ–°ç›®æ ‡åº”ç”¨äº†â€”â€”æŸäº›æ—¶å€™å®ƒç”šè‡³ä¸éœ€è¦é‡å¯ä½ çš„Activityæ¥åæ˜ å˜åŒ–ï¼Œæ›´æ”¹çš„æ•ˆæœä¼šç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<blockquote>
<p>ã€æ³¨æ„ã€‘Instant Runä¼šæš‚æ—¶æ€§åœ°å…³é—­äº†JaCoCoå’ŒProguardã€‚ä½†æ˜¯å› ä¸ºInstant Runåªå¯¹debugæ„å»ºæœ‰æ•ˆï¼Œå› æ­¤è¿™ç§è¡Œä¸ºä¸ä¼šå½±å“ä½ çš„releaseæ„å»ºã€‚</p>
</blockquote>
<p>Instant Runæœ‰ä¸‰ç§æ–¹å¼å¯ä»¥å°†æ›´æ–°åçš„é¡¹ç›®Pushåˆ°è®¾å¤‡ä¸Šï¼šHot Swapï¼ŒWarm Swapå’ŒCold Swapï¼Œå®ƒä¼šè‡ªåŠ¨é€‰æ‹©ä¸€ç§æ–¹å¼è¿›è¡Œæ›´æ–°ã€‚ä¸‹é¢çš„è¡¨æ ¼æè¿°äº†é¡¹ç›®å‘ç”Ÿå˜åŒ–ä¹‹åInstant Runä¼šå¦‚ä½•Pushæ›´æ–°:</p>
<table>
<thead>
<tr>
<th>ä»£ç å˜åŒ–</th>
<th>Instant Runè¡Œä¸º</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®ä¾‹æ–¹æ³•æˆ–è€…é™æ€æ–¹æ³•ä»£ç å˜åŒ–</td>
<td>Hot Swap: æœ€å¿«çš„Pushå˜åŒ–çš„æ–¹æ³•ï¼Œå‡ ä¹å¯ä»¥ç«‹å³çœ‹åˆ°å˜åŒ–ï¼Œåº”ç”¨ç¨‹åºä¼šç»§ç»­è¿è¡Œï¼Œä¸‹æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæ–°çš„æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨</td>
</tr>
<tr>
<td>æ›´æ”¹æˆ–è€…ç§»é™¤èµ„æº</td>
<td>Warm Swap: è¿™ç§æ–¹å¼ä¾ç„¶å¾ˆå¿«ï¼Œä½†æ˜¯åœ¨Pushå˜åŒ–çš„æ—¶å€™è¦æ±‚Activityé‡æ–°å¯åŠ¨ï¼ŒAppæœ¬èº«ä¸ä¼šé‡å¯</td>
</tr>
<tr>
<td>ä»£ç ç»“æ„å˜æ›´ï¼Œæ¯”å¦‚: 1)å¢åŠ ã€åˆ é™¤æˆ–è€…æ”¹åŠ¨æ³¨è§£ã€å®ä¾‹å˜é‡ã€é™æ€å˜é‡ã€é™æ€æ–¹æ³•ç­¾åã€å®ä¾‹æ–¹æ³•ç­¾åï¼›2ï¼‰æ”¹å˜ç»§æ‰¿çš„çˆ¶ç±»ï¼›3ï¼‰æ”¹å˜å®ç°çš„æ¥å£ï¼›4ï¼‰å˜æ›´é™æ€æ„é€ å™¨ï¼›5ï¼‰ä½¿ç”¨åŠ¨æ€Idé‡æ–°æ„å»ºLayout</td>
<td>Code Swap(API Level 21ä»¥åŠä»¥ä¸Šæ‰æ”¯æŒ): Instant Runä¼šå°†å˜åŒ–çš„ç»“æ„ä»£ç Pushåˆ°ç›®æ ‡è®¾å¤‡ä¸Šï¼Œå¹¶é‡å¯æ•´ä¸ªAppï¼› API Level 20ä»¥åŠä»¥ä¸‹ä¼šé‡æ–°æ„å»ºAPKã€‚</td>
</tr>
<tr>
<td>1ï¼‰æ›´æ”¹Manifestæ–‡ä»¶ï¼›2ï¼‰æ›´æ”¹Manifestæ–‡ä»¶å¼•ç”¨çš„èµ„æºï¼›3ï¼‰æ›´æ”¹widgetçš„UIå…ƒç´ (éœ€è¦æ‰§è¡Œ<code>Clean and Rerun</code>)</td>
<td>å¯¹äºå‰ä¸¤è€…ï¼ŒAndroid Studioä¼šè‡ªåŠ¨é‡æ–°æ„å»ºï¼Œè¿™æ˜¯å› ä¸ºè¯¸å¦‚iconã€åå­—ã€intent-filteræ˜¯åœ¨APKå®‰è£…çš„æ—¶å€™å°±ç¡®å®šäº†ã€‚å¦‚æœæ„å»ºè¿‡ç¨‹é»˜è®¤æ›´æ”¹äº†Manifestæ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°±ä¸ä¼šè·å¾—ä»»ä½•Instant Runå¸¦æ¥çš„å¥½å¤„ï¼Œå› æ­¤ä¸å»ºè®®åœ¨æ„å»ºä¸­è‡ªåŠ¨æ›´æ”¹ä»»ä½•çš„Manifestæ–‡ä»¶å†…å®¹ã€‚</td>
</tr>
</tbody>
</table>
<p>Android Studioé»˜è®¤ä¼šåœ¨Hot Swapä¹‹åä¿æŒAppè¿è¡Œå¹¶é‡å¯å½“å‰çš„Activityï¼Œè¿™ä¸ªè®¾ç½®å¯ä»¥æ›´æ”¹:</p>
<ol>
<li>æ‰“å¼€Settingsæˆ–è€…Preferenecesé¢æ¿ï¼›</li>
<li>æ‰“å¼€Build, Execution, Deployment &gt; Instant Runï¼›</li>
<li>å–æ¶ˆé€‰ä¸­<code>Restart activity on code changes</code>ï¼›</li>
</ol>
<p>å½“è¿™ä¸ªè®¾ç½®è¢«å–æ¶ˆä¹‹åï¼Œå¼€å‘è€…å¯ä»¥åœ¨èœå•æ çš„Runèœå•ä¸­é€‰æ‹©<code>Restart Activity</code>æ¥æ‰‹åŠ¨é‡å¯å½“å‰çš„Activityã€‚</p>
<h4 id="ä½¿ç”¨Rerun"><a href="#ä½¿ç”¨Rerun" class="headerlink" title="ä½¿ç”¨Rerun"></a>ä½¿ç”¨<code>Rerun</code></h4><p>å½“è¯¸å¦‚<code>onCreate()</code>æ–¹æ³•å‘ç”Ÿå˜åŒ–åï¼Œä½ å¯èƒ½ä¼šéœ€è¦é‡å¯Appæ¥ååº”å˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ç‚¹å‡»<code>Rerun</code>å‘½ä»¤(Iconæ˜¯ä¸€ä¸ªå³ä¸‹è§’ä¸€ä¸ªæ–¹å—ï¼Œå·¦è¾¹ä¸€ä¸ªå‘ä¸Šå¼¯æ›²çš„ç®­å¤´)æ¥åœæ­¢Appè¿è¡Œã€æ‰§è¡Œå¢é‡æ„å»ºå¹¶é‡å¯Appã€‚</p>
<p>å¦‚æœéœ€è¦è¿›è¡Œä¸€ä¸ªCleanæ„å»ºï¼Œå¯ä»¥é€‰æ‹©<code>Run &gt; Clean and Rerun &#39;app&#39;</code>å‘½ä»¤è¿›è¡Œï¼Œæˆ–è€…æŒ‰ä½<code>Shift</code>é”®çš„åŒæ—¶æŒ‰ä¸‹<code>Rerun</code>å‘½ä»¤ã€‚è¿™ä¸ªåŠ¨ä½œä¼šåœæ­¢å½“å‰è¿è¡Œçš„Appï¼Œæ‰§è¡Œä¸€ä¸ªå…¨æ–°çš„æ„å»ºï¼Œç„¶åå°†æ–°çš„APKéƒ¨ç½²åˆ°ç›®æ ‡è®¾å¤‡ä¸Šå»ã€‚</p>
<h2 id="ä¸ºé¡¹ç›®é…ç½®Instant-Run"><a href="#ä¸ºé¡¹ç›®é…ç½®Instant-Run" class="headerlink" title="ä¸ºé¡¹ç›®é…ç½®Instant Run"></a>ä¸ºé¡¹ç›®é…ç½®Instant Run</h2><p>å½“ä½¿ç”¨2.0.0æˆ–è€…æ›´é«˜ç‰ˆæœ¬çš„Android Gradleæ’ä»¶æ—¶ï¼ŒAndroid Studioè‡ªåŠ¨åº”ç”¨Instant Runã€‚ä¸ºäº†è®©å·²æœ‰é¡¹ç›®æ”¯æŒGradleæ’ä»¶çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥åšä»¥ä¸‹é…ç½®:</p>
<ol>
<li>æ‰“å¼€Settingsæˆ–è€…Preferencesé¢æ¿ï¼›</li>
<li>è·³è½¬åˆ°Build, Execution, Deployment &gt; Instant Runï¼Œç‚¹å‡»<code>Update Projec</code>ï¼Œå¦‚æœæ²¡æœ‰å‡ºç°è¿™ä¸ªé€‰é¡¹ï¼Œé‚£å°±è¯´æ˜è¿™ä¸ªé¡¹ç›®å·²ç»æ”¯æŒæœ€æ–°çš„æ’ä»¶äº†ï¼›</li>
</ol>
<h2 id="éœ€è¦çŸ¥é“çš„äº‹æƒ…"><a href="#éœ€è¦çŸ¥é“çš„äº‹æƒ…" class="headerlink" title="éœ€è¦çŸ¥é“çš„äº‹æƒ…"></a>éœ€è¦çŸ¥é“çš„äº‹æƒ…</h2><p>Instant Runæ˜¯è®¾è®¡æ¥åŠ é€Ÿå¤§å¤šæ•°æƒ…å†µä¸‹çš„æ„å»ºéƒ¨ç½²è¿‡ç¨‹çš„ï¼Œä¸‹é¢æ˜¯ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p>
<h4 id="Legacy-Multidex-with-Android-5-0-or-higher"><a href="#Legacy-Multidex-with-Android-5-0-or-higher" class="headerlink" title="Legacy Multidex with Android 5.0 or higher"></a>Legacy Multidex with Android 5.0 or higher</h4><p>å¦‚æœé¡¹ç›®æ˜¯Multidexçš„ï¼Œå³build.gradleé‡Œé¢é…ç½®äº†<code>multiDexEnabled true</code>å’Œ<code>minSdkVersion 20</code>æˆ–è€…æ›´ä½ç‰ˆæœ¬ï¼Œä¸”ç›®æ ‡è®¾å¤‡è¿è¡Œçš„æ˜¯Android 5.0(API Level 21)æˆ–è€…æ›´é«˜ç‰ˆæœ¬ï¼Œé‚£ä¹ˆéƒ¨ç½²ä¸€ä¸ªCleanæ„å»ºçš„æ•ˆç‡å¯èƒ½ä¼šä¸‹é™ã€‚å½“åˆå§‹åŒ–éƒ¨ç½²å®Œæˆä¹‹åï¼Œå¢é‡æ„å»ºå°±ä¼šæ˜¾è‘—åŠ å¿«ã€‚</p>
<p>è¿™é‡Œé€šè¿‡å¼•ç”¨æ¶‰åŠåˆ°å¦å¤–ä¸€å¤„<a href="http://developer.android.com/intl/zh-cn/tools/building/multidex.html#mdex-pre-l" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚å¼•ç”¨çš„æ–‡æ¡£æè¿°çš„å¾ˆæ¸…æ¥š:</p>
<blockquote>
<p>å¦‚æœä½ é¡¹ç›®æ˜¯Multidexçš„ï¼ŒåŒæ—¶minSdkVersioné…ç½®çš„æ˜¯20æˆ–è€…æ›´ä½ï¼Œå¹¶ä¸”ç›®æ ‡è®¾å¤‡è¿è¡Œçš„æ˜¯Android 4.4(API Level 20)æˆ–è€…æ›´ä½ç‰ˆæœ¬ï¼ŒAndroid Studioæ˜¯ä¸æ”¯æŒInstant Runçš„ã€‚</p>
</blockquote>
<p>è§£å†³åŠæ³•æ˜¯æ–°å»ºä¸€ä¸ªProduct Flavorï¼Œå°†<code>minSdkVerion</code>æé«˜åˆ°20ä»¥ä¸Šã€‚</p>
<h4 id="è¶…å‡º64Kæ–¹æ³•é™åˆ¶"><a href="#è¶…å‡º64Kæ–¹æ³•é™åˆ¶" class="headerlink" title="è¶…å‡º64Kæ–¹æ³•é™åˆ¶"></a>è¶…å‡º64Kæ–¹æ³•é™åˆ¶</h4><p>Instant Runä¼šåœ¨æ¯ä¸€ä¸ªDebug APKä¸­å¢åŠ é¢å¤–çš„æ–¹æ³•ï¼Œæ•°é‡å¦‚ä¸‹:</p>
<blockquote>
<p>approximately 140 plus three times the number of classes and their local dependenciesã€‚</p>
<p>æ•æˆ‘è‹±è¯­æ¸£â€¦</p>
</blockquote>
<p>å› æ­¤å¯èƒ½ä¼šé€ æˆä¸€äº›APKè¶…å‡ºæ–¹æ³•æ•°é™åˆ¶ï¼Œè§£å†³åŠæ³•å¯ä»¥å‚è€ƒ<a href="http://developers.android.com/tools/building/multidex.html#mdex-gradle" target="_blank" rel="noopener">configuring apps for Multidex</a>ã€‚</p>
<h4 id="éƒ¨ç½²åˆ°å¤šè®¾å¤‡"><a href="#éƒ¨ç½²åˆ°å¤šè®¾å¤‡" class="headerlink" title="éƒ¨ç½²åˆ°å¤šè®¾å¤‡"></a>éƒ¨ç½²åˆ°å¤šè®¾å¤‡</h4><p>å› ä¸ºInstant Runåœ¨é€‰æ‹©æ›´æ–°æ–¹å¼çš„æ—¶å€™ä½¿ç”¨äº†ä¸åŒçš„æŠ€æœ¯ï¼Œè¿™ä¾èµ–äºç›®æ ‡è®¾å¤‡çš„API Levelï¼Œå› ä¸ºè¿™ä¸ªåŸå› ï¼Œåœ¨ä¸€æ¬¡éƒ¨ç½²åˆ°å¤šä¸ªè®¾å¤‡çš„æ—¶å€™ï¼ŒAndroid Studioä¼šæš‚æ—¶å…³é—­æ‰Instant Runã€‚</p>
<h4 id="Instrumentationæµ‹è¯•"><a href="#Instrumentationæµ‹è¯•" class="headerlink" title="Instrumentationæµ‹è¯•"></a>Instrumentationæµ‹è¯•</h4><p>å½“è¿è¡ŒInstrumentationæµ‹è¯•çš„æ—¶å€™ï¼ŒAndroid Studioä¼šå…³é—­è¿™ä¸ªç‰¹æ€§ï¼Œä¸ä¼šæ’å…¥é¢å¤–çš„ä»£ç ã€‚</p>
<p>å½“åˆ†æä¸€ä¸ªAppçš„æ—¶å€™ï¼ŒInstant Runä¼šé€ æˆä¸€å®šçš„æ€§èƒ½å½±å“ï¼Œè¿™äº›å½±å“ä¼šå¹²æ‰°æ€§èƒ½åˆ†æå·¥å…·æä¾›çš„ä¿¡æ¯ï¼Œå¦å¤–å®ƒä¹Ÿä¼šä½¿å¾—stack traceæ›´åŠ å¤æ‚ï¼Œå› æ­¤è¿™ä¸ªæ—¶å€™éœ€è¦å…³é—­æ‰Instant Runã€‚</p>
<h2 id="å…³é—­Instant-Run"><a href="#å…³é—­Instant-Run" class="headerlink" title="å…³é—­Instant Run"></a>å…³é—­Instant Run</h2><ol>
<li>æ‰“å¼€Settingsæˆ–è€…Preferencesé¢æ¿ï¼›</li>
<li>è·³è½¬åˆ°Build, Execution, Deployment &gt; Instant Runï¼›</li>
<li>å–æ¶ˆå‹¾é€‰<code>Enable Instant Run</code>ï¼›</li>
</ol>
<hr>
<blockquote>
<p><strong>ä»Šå¤©æ˜¯2016-05-03ï¼Œä¸Šé¢æè¿°çš„å†…å®¹å¯ä»¥ä½œä¸ºå‚è€ƒï¼Œå®é™…æƒ…å†µå·²ç»æœ‰æ‰€å˜åŒ–ã€‚</strong></p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidå®˜æ–¹MVXé¡¹ç›®è§£æ]]></title>
      <url>http://www.timebridge.space/2016/04/22/google-android-mvx/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong>è®¾è®¡</strong>, å³æ ¹æ®é—®é¢˜å½“å‰çš„æƒ…å†µä»¥åŠæœªæ¥å¯é¢„è§çš„å˜åŒ–ï¼Œæä¾›ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚ä½•è°“ä¼˜é›…ï¼Œä¸æ˜¯æŠ•æœºå–å·§ï¼Œè€Œæ˜¯ç®€å•æ˜“æ‡‚ï¼Œæˆæœ¬ä½ã€‚</p>
</blockquote>
<p>å‰æ®µæ—¶é—´Googleå®˜æ–¹æ¨å‡ºäº†<strong><a href="https://github.com/googlesamples/android-architecture" target="_blank" rel="noopener">â€œAndroid Architecture Blueprintsâ€</a></strong>é¡¹ç›®ã€‚æ­£å¦‚é¡¹ç›®ä»‹ç»ä¸­æ‰€è¯´ï¼Œè™½ç„¶Androidå¹³å°å¯¹äºå¦‚ä½•ç»„ç»‡é¡¹ç›®ç»“æ„æä¾›äº†å¾ˆå¤§çš„è‡ªç”±åº¦ï¼Œä½†è¿™ç§è‡ªç”±åº¦ä¹Ÿé€ æˆäº†æ··ä¹±ï¼Œä½¿å¾—é¡¹ç›®çš„æµ‹è¯•ã€ç»´æŠ¤ä»¥åŠæ‰©å±•é‡åˆ°å›°éš¾ã€‚</p>
<p>åœ¨è¿™ä¸ªé¡¹ç›®é‡Œé¢ï¼ŒGoogleé’ˆå¯¹åŒä¸€ä¸ªåº”ç”¨ä½¿ç”¨ä¸åŒçš„æ¶æ„å’ŒæŠ€æœ¯è¿›è¡Œå®ç°ï¼Œä»¥å¸®åŠ©å¼€å‘è€…è§£å†³é—®é¢˜ã€‚å®ƒçš„é‡ç‚¹åœ¨äº<strong>ä»£ç ç»“æ„ï¼Œé¡¹ç›®æ¶æ„ï¼Œæµ‹è¯•ä»¥åŠå¯ç»´æŠ¤æ€§</strong>ã€‚ç ”ç©¶è¿™ä¸ªé¡¹ç›®è¦æ³¨æ„ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>æ¶æ„ä»¥åŠæ¶æ„çš„å®ç°ç”±å¾ˆå¤šç§é€‰æ‹©ï¼Œå–å†³äºä½ çš„ç°å®æƒ…å†µï¼Œå› æ­¤è¿™äº›ä¾‹å­åªæ˜¯ä¸€ä¸ªæŒ‡å¼•ï¼Œå¹¶ä¸èƒ½ä½œä¸ºè§„èŒƒï¼›</li>
<li>è¿™ä¸ªé¡¹ç›®è¿˜å¤„äºbetaçŠ¶æ€ï¼ŒåæœŸå¯èƒ½ä¼šå‡ºç°å½±å“æ‰€æœ‰ä¾‹å­çš„æ”¹åŠ¨ï¼›<a id="more"></a></li>
</ol>
<h2 id="é¡¹ç›®ç›®å‰çŠ¶æ€"><a href="#é¡¹ç›®ç›®å‰çŠ¶æ€" class="headerlink" title="é¡¹ç›®ç›®å‰çŠ¶æ€"></a>é¡¹ç›®ç›®å‰çŠ¶æ€</h2><p>ç¬¬ä¸€æœŸå·²ç»å®Œæˆè¿‘äºŒåˆ†ä¹‹ä¸€äº†ï¼š</p>
<ol>
<li><strong>todo-mvp/</strong> åŸºç¡€é¡¹ç›®ï¼Œä½¿ç”¨MVPæ¶æ„ï¼›</li>
<li><strong>todo-mvp-loaders/</strong> åŸºäºmvpé¡¹ç›®ï¼Œä½†æ˜¯æ˜¯ä½¿ç”¨LoadersåŠ è½½æ•°æ®ï¼›</li>
<li><strong>todo-mvp-databinding/</strong> åŸºäºmvpé¡¹ç›®ï¼Œä½¿ç”¨Data Bindingåº“å®ç°ï¼›</li>
</ol>
<p>å‰©ä½™çš„è¿˜æœ‰å‡ ç§æŠ€æœ¯çš„ç»„åˆï¼Œç›®å‰è¿˜åœ¨å¼€å‘ä¸­ã€‚</p>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>ç›´æ¥cloneé¡¹ç›®å³å¯ï¼Œåˆ†æ”¯å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/android-architecture.png" height="250" alt="One Piece"></div><br>ä»åˆ†æ”¯å‘½åå¯ä»¥çœ‹å‡ºç›®å‰è¯¥é¡¹ç›®æ‰€åšçš„ä¸€äº›å·¥ä½œä»¥åŠæ‰€ä½¿ç”¨çš„æŠ€æœ¯ã€‚<br><br>## MVP<br>todo-mvpæ˜¯æ‰€æœ‰ä¾‹å­çš„åŸºç¡€ï¼Œå®ƒæ²¡æœ‰ä¾èµ–ä»»ä½•çš„å…¶ä½™æ¡†æ¶å®ç°äº†MVPæ¶æ„ã€‚è¿™é‡Œé‡ç‚¹åˆ†æ<code>origin/todo-mvp</code>åˆ†æ”¯ä»£ç ã€‚<br><br>### é¡¹ç›®ç»“æ„<br><div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/mvpé¡¹ç›®ç»“æ„.png" width="500" alt="One Piece"></div>

<p>å¦‚å›¾æ‰€ç¤ºï¼Œé™¤äº†æºç æ–‡ä»¶å¤¹ï¼Œè¿˜æœ‰å››ä¸ªæ–‡ä»¶å¤¹æ˜¯ä¸“é—¨ä¸ºæµ‹è¯•å»ºç«‹çš„ï¼Œå…³äºæµ‹è¯•è¿™é‡Œä¸åˆ†æï¼Œä½†ä¼šé˜è¿°ä¸€ä¸‹MVPç»“æ„å¯¹äºæµ‹è¯•çš„æ”¯æŒã€‚</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/MVPé¡¹ç›®ç»“æ„-Detail.png" width="500" alt="One Piece"></div>

<p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°é¡¹ç›®çš„åˆ†åŒ…ç‰¹ç‚¹ï¼š<strong>æ•´ä½“åˆ†åŒ…æ˜¯æŒ‰ç…§é¡µé¢åŠŸèƒ½åˆ†çš„ï¼Œä»å¤–éƒ¨å¹¶ä¸èƒ½æ˜¾ç¤ºçš„çœ‹å‡ºæ˜¯MVPæ¨¡å¼</strong>ã€‚</p>
<p>æˆ‘ä»¬å±•å¼€è¯¦ç»†çœ‹ä¸€ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/mvpé¡¹ç›®ç»“æ„-Expand.png" width="500" alt="One Piece"></div>

<p><code>A</code>å¤„æ˜¯æ·»åŠ Taskçš„é¡µé¢ï¼Œè¿™é‡Œé¢æœ‰å››ä¸ªç±»ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°Pçš„å­˜åœ¨ï¼Œæ¯ä¸ªç±»å…·ä½“çš„å«ä¹‰ä¸‹ä¸€èŠ‚ç»†è¯´ï¼Œ<code>B</code>ä»åŒ…åä»¥åŠç±»åå¯ä»¥æ¨æµ‹å‡ºæ˜¯æ•°æ®æºï¼Œä¹Ÿå°±æ˜¯Modelã€‚<code>C</code>å¤„å®šä¹‰äº†åŸºæœ¬çš„Vå’ŒPçš„æ¥å£ã€‚</p>
<blockquote>
<p>è¿™ä¸ªé¡¹ç›®çš„UIéƒ½æ˜¯ç”±Activity + Fragmentç»„æˆçš„ï¼ŒActivityå’ŒFragmentæ‰®æ¼”çš„è§’è‰²å¹¶ä¸ä¸€æ ·ã€‚</p>
</blockquote>
<h3 id="é¡¹ç›®ç»†è¯´â€”â€”èŒè´£å’Œç»„è£…"><a href="#é¡¹ç›®ç»†è¯´â€”â€”èŒè´£å’Œç»„è£…" class="headerlink" title="é¡¹ç›®ç»†è¯´â€”â€”èŒè´£å’Œç»„è£…"></a>é¡¹ç›®ç»†è¯´â€”â€”èŒè´£å’Œç»„è£…</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹Vå’ŒPçš„åŸºæœ¬æ¥å£å®šä¹‰ï¼Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BasePresenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseView</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPresenter</span><span class="params">(T presenter)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆç®€å•ï¼ŒPé‡Œé¢åªæœ‰ä¸€ä¸ª<code>start()</code>æ–¹æ³•ï¼Œè¡¨ç¤ºåˆå§‹åŠ è½½æ•°æ®ã€‚Vä¸­ä¹Ÿåªæœ‰ä¸€ä¸ªæ–¹æ³•<code>setPresenter()</code>ï¼Œç”¨äºç»™Vè®¾ç½®å¯¹åº”çš„Pã€‚</p>
<p>æ¥ç€æˆ‘ä»¬çœ‹Aä¸­åœˆå‡ºçš„å››ä¸ªç±»ï¼ˆè¿™å››ä¸ªç±»å¯¹åº”å®ç°äº†ä¸€ä¸ªç•Œé¢ï¼Œè¿™é‡Œæ‹‰å‡ºæ¥ä½œä¸ºä¾‹å­ï¼Œå…¶ä½™çš„ç•Œé¢å®ç°ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼‰ï¼Œè¿™å‡ ä¸ªç±»çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<ol>
<li><strong><code>AddEditTaskContract</code></strong> æ‰©å±•BaseViewå’ŒBasePresenteræ¥å£ï¼Œå®šä¹‰è¯¥é¡µé¢Vå’ŒPéœ€è¦å®ç°çš„æ¥å£ï¼›</li>
<li><strong><code>AddEditTaskFragment</code></strong> Væ¥å£çš„å®ç°ï¼›</li>
<li><strong><code>AddEditTaskPresenter</code></strong> Pæ¥å£çš„å®ç°ï¼›</li>
<li><strong><code>AddEditTaskActivity</code></strong> Mã€Vã€Pä¸‰è€…çš„ç»„è£…ï¼›</li>
</ol>
<p><code>AddEditTaskActivity</code>çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">	setContentView(R.layout.addtask_act);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set up the toolbar.</span></span><br><span class="line">	Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span><br><span class="line">	setSupportActionBar(toolbar);</span><br><span class="line">	ActionBar actionBar = getSupportActionBar();</span><br><span class="line">	actionBar.setDisplayHomeAsUpEnabled(<span class="keyword">true</span>);</span><br><span class="line">	actionBar.setDisplayShowHomeEnabled(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ›å»ºView</span></span><br><span class="line">	AddEditTaskFragment addEditTaskFragment = (AddEditTaskFragment) getSupportFragmentManager().findFragmentById(R.id.contentFrame);</span><br><span class="line"></span><br><span class="line">	String taskId = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (addEditTaskFragment == <span class="keyword">null</span>) &#123;</span><br><span class="line">		addEditTaskFragment = AddEditTaskFragment.newInstance();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (getIntent().hasExtra(AddEditTaskFragment.ARGUMENT_EDIT_TASK_ID)) &#123;</span><br><span class="line">		taskId = getIntent().getStringExtra(AddEditTaskFragment.ARGUMENT_EDIT_TASK_ID);</span><br><span class="line">		actionBar.setTitle(R.string.edit_task);</span><br><span class="line">		Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">		bundle.putString(AddEditTaskFragment.ARGUMENT_EDIT_TASK_ID, taskId);</span><br><span class="line">			addEditTaskFragment.setArguments(bundle);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			actionBar.setTitle(R.string.add_task);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ActivityUtils.addFragmentToActivity(getSupportFragmentManager(), addEditTaskFragment, R.id.contentFrame);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ›å»ºPresenterå¹¶å°†Viewä¼ é€’ç»™Presenter</span></span><br><span class="line">	<span class="keyword">new</span> AddEditTaskPresenter(taskId, </span><br><span class="line">	<span class="comment">// åˆ›å»ºM</span></span><br><span class="line">	Injection.provideTasksRepository(getApplicationContext()), addEditTaskFragment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æ³¨é‡Šæ‰€æè¿°ï¼ŒActivityåˆ›å»ºäº†Vã€Pã€Mï¼Œå¹¶å°†Mã€Vä¼ é€’ç»™äº†Pï¼Œ<code>AddEditTaskPresenter</code>çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AddEditTaskPresenter</span><span class="params">(@Nullable String taskId, @NonNull TasksDataSource tasksRepository, @NonNull AddEditTaskContract.View addTaskView)</span> </span>&#123;</span><br><span class="line">	mTaskId = taskId;</span><br><span class="line">	<span class="comment">//è·å–åˆ°M</span></span><br><span class="line">	mTasksRepository = checkNotNull(tasksRepository);</span><br><span class="line">	mAddTaskView = checkNotNull(addTaskView);</span><br><span class="line">	<span class="comment">//ç»„è£…Må’ŒP</span></span><br><span class="line">	mAddTaskView.setPresenter(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åä¸€è¡Œï¼ŒPå°†è‡ªå·±è®¾ç½®ä¸ºVçš„Presenterã€‚å³Activityçš„<code>onCreate()</code>æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼ŒMã€Vã€Pä¸‰ä¸ªéƒ¨åˆ†ç»„è£…å®Œæ¯•ã€‚<strong>é™¤äº†ç»„è£…ï¼ŒActivityè¿˜è´Ÿè´£ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…:åˆå§‹åŒ–æ•°æ®ç¯å¢ƒ</strong>ã€‚ä»<code>onCreate()</code>æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼ŒActivityè·å–äº†å¯¹åº”çš„taskIdï¼Œå¹¶ä¼ é€’ç»™äº†<code>AddEditTaskFragment</code>å’Œ<code>AddEditTaskPresenter</code>ä¸¤è€…ï¼Œè¿™æ ·åœ¨ç¼–è¾‘ä¸€ä¸ªTaskçš„æ—¶å€™ï¼ŒPresenteræ‰çŸ¥é“å…·ä½“çš„ç¼–è¾‘å¯¹è±¡ã€‚</p>
<blockquote>
<p>è¿™é‡ŒtaskIdåº”è¯¥ä¼ å…¥åˆ°<code>AddEditTaskFragment</code>ä¸­ä¹ˆï¼Ÿä»å®ç°ä¸Šçœ‹ï¼Œè¿™ä¸ªtaskIdåœ¨<code>AddEditTaskFragment</code>ç”¨äºåˆ¤æ–­æ˜¯åœ¨ç¼–è¾‘ä¸€ä¸ªTaskè¿˜æ˜¯åœ¨åˆ›å»ºä¸€ä¸ªTaskï¼Œè¿™ä¸ªé€»è¾‘åº”è¯¥æ”¾åœ¨På±‚æ›´åŠ åˆé€‚ã€‚</p>
</blockquote>
<p><strong>ç»„è£…å®Œæ¯•ä¹‹åï¼Œæ•´ä¸ªé¡µé¢æ˜¯åœ¨å“ªé‡Œå¯åŠ¨çš„å‘¢ï¼Ÿåœ¨Vä¸­ï¼Œç”±Vçš„ç”Ÿå‘½å‘¨æœŸè§¦å‘ã€‚</strong><code>AddEditTaskFragment</code>çš„<code>onResume()</code>æ–¹æ³•å®ç°å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onResume();</span><br><span class="line">	mPresenter.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢è§¦å‘äº†mPresenterçš„<code>start()</code>æ–¹æ³•åŠ è½½æ•°æ®(æ­£å› ä¸ºActivityåˆå§‹åŒ–äº†æ•°æ®ç¯å¢ƒï¼Œå› æ­¤<code>start()</code>å‡½æ•°ä¸éœ€è¦ä»»ä½•çš„å‚æ•°ï¼‰ã€‚</p>
<p><code>start()</code>æ–¹æ³•ä¼šåŠ è½½æ•°æ®ï¼Œæˆ‘ä»¬æ¥çœ‹é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	openTask();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">null</span> == mTaskId || mTaskId.isEmpty()) &#123;</span><br><span class="line">		mTaskDetailView.showMissingTask();</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mTaskDetailView.setLoadingIndicator(<span class="keyword">true</span>);</span><br><span class="line">	mTasksRepository.getTask(mTaskId, <span class="keyword">new</span> TasksDataSource.GetTaskCallback() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTaskLoaded</span><span class="params">(Task task)</span> </span>&#123;</span><br><span class="line">			<span class="comment">// The view may not be able to handle UI updates anymore</span></span><br><span class="line">			<span class="keyword">if</span> (!mTaskDetailView.isActive()) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			mTaskDetailView.setLoadingIndicator(<span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">null</span> == task) &#123;</span><br><span class="line">				mTaskDetailView.showMissingTask();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				showTask(task);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="comment">// The view may not be able to handle UI updates anymore</span></span><br><span class="line">			<span class="keyword">if</span> (!mTaskDetailView.isActive()) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			mTaskDetailView.showMissingTask();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨äºæ‰“å¼€ä¸€ä¸ªTaskï¼Œå®ƒæ˜¯é€šè¿‡<code>mTasksRepository</code>æ¥åŠ è½½æ•°æ®çš„ã€‚<code>TasksRepository</code>æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»ï¼Œå®ƒå®ç°äº†<code>TasksDataSource</code>æ¥å£ï¼šè¿™ä¸ªæ¥å£ä¸­å®šä¹‰äº†å¾ˆå¤šçš„æœ‰å…³Taskæ“ä½œçš„æ–¹æ³•ï¼Œæœ‰å¢åˆ æ”¹æŸ¥ç­‰ã€‚<code>TasksRepository</code>æ˜¯<code>TasksDataSource</code>çš„ä¸€ä¸ªå®ç°ï¼Œå…¶ä½™å®ç°ç±»å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/TasksDataSourceå®ç°ç±».png" height="100" alt="TasksDataSourceå®ç°ç±»"></div>

<p>è¿™å››ä¸ªå®ç°çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<ol>
<li><code>TasksLocalDataSource</code>å’Œ<code>TasksRemoteDataSource</code>åˆ†åˆ«é€šè¿‡<code>TasksDataSource</code>å®šä¹‰çš„APIå®ç°äº†Taskçš„æœ¬åœ°ï¼ˆæ•°æ®åº“ï¼‰ä¿å­˜å’Œè¿œç«¯ä¿å­˜ï¼ˆä»£ç é‡Œé¢æ˜¯ä¸€æ®µå‡å®ç°ï¼ŒMockäº†ä¸€ä¸‹ä»æœåŠ¡å™¨ä¸Šæ“ä½œTaskèµ„æºçš„è¿‡ç¨‹ï¼‰ï¼›</li>
<li><code>TasksRepository</code>é€šè¿‡ä»¥ä¸Šä¸¤ä¸ªç±»å®ç°äº†<code>TasksDataSource</code>:æŠŠç›¸å…³çš„è¯·æ±‚ç›´æ¥ä»£ç†ç»™ä»¥ä¸Šä¸¤ä¸ªç±»ï¼›</li>
<li><code>FakeTasksRemoteDataSource</code>åˆ™æ˜¯ä¸€ä¸ªå®Œå…¨çš„Mockç±»ï¼Œç”¨äºç»™è‡ªåŠ¨åŒ–æµ‹è¯•æä¾›æ•°æ®æºï¼›</li>
</ol>
<p>å…³äºç¬¬2ç‚¹ï¼Œå¯ä»¥çœ‹<code>TasksRepository</code>ä¸­çš„ä¸€ä¸ªæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTask</span><span class="params">(@NonNull Task task)</span> </span>&#123;</span><br><span class="line">	checkNotNull(task);</span><br><span class="line">	mTasksRemoteDataSource.saveTask(task);</span><br><span class="line">	mTasksLocalDataSource.saveTask(task);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Do in memory cache update to keep the app UI up to date</span></span><br><span class="line">	<span class="keyword">if</span> (mCachedTasks == <span class="keyword">null</span>) &#123;</span><br><span class="line">		mCachedTasks = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	mCachedTasks.put(task.getId(), task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åœ¨è¿™ä¸ªMVPçš„å®ç°ä¸­ï¼ŒMå¯¹ä¸Šæ˜¯æš´éœ²å‡ºæ¥å£çš„ï¼ˆå³<code>TasksDataSource</code>ï¼‰ï¼Œå¹¶ä¸”æ•´ä¸ªAppçš„æ•°æ®æ¥å£éƒ½å®šä¹‰åœ¨ä¸€ä¸ªæ¥å£ä¸­ï¼Œè¿™æ ·åœ¨è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ä¾¿äºæä¾›Fakeæ•°æ®æºã€‚Må±‚åŠ è½½å®Œæ•°æ®ä¹‹åæ˜¯é€šè¿‡å›è°ƒæ¥å‘Šè¯‰På±‚çš„ï¼Œåœ¨<code>TasksDataSource</code>ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå›è°ƒæ¥å£çš„å®šä¹‰:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LoadTasksCallback</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onTasksLoaded</span><span class="params">(List&lt;Task&gt; tasks)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">GetTaskCallback</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onTaskLoaded</span><span class="params">(Task task)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS: <code>TasksRepository</code>æ˜¯å•ä¾‹è®¾è®¡ã€‚</p>
</blockquote>
<p>ä»¥ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“äº†æœ€åŸºæœ¬çš„MVPçš„å®ç°ä¸­å„ä¸ªç±»çš„å¤§ä½“ä½œç”¨ã€ä½ç½®ä»¥åŠå®ƒä»¬çš„å…³ç³»ã€‚</p>
<h2 id="MVP-Loader"><a href="#MVP-Loader" class="headerlink" title="MVP-Loader"></a>MVP-Loader</h2><p>è¿™ä¸ªåˆ†æ”¯æ¼”ç¤ºçš„æ˜¯å¦‚ä½•é€šè¿‡Loaderå®ç°MVPæ¶æ„ã€‚å‰é¢ä»‹ç»çš„åŸºæœ¬ç»“æ„ä»¥åŠå„ä¸ªç±»çš„èŒè´£éƒ½æ²¡æœ‰å˜åŒ–ã€‚Loaderä¸»è¦æ˜¯ç”¨äºæ•°æ®å¼‚æ­¥åŠ è½½çš„ï¼Œå› æ­¤åœ¨Modelè¿™å—å˜åŒ–æ¯”è¾ƒå¤§ã€‚</p>
<blockquote>
<p>å…³äºLoaderå¦‚æœæœ‰ç–‘é—®ï¼Œå¯ä»¥é˜…è¯»æ–‡ç« ï¼š<a href="http://www.muzileecoding.com/androidsource/Android-loader-and-loadermanager.html" target="_blank" rel="noopener">Loader &amp; LoaderManager</a>ã€‚</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å˜åŒ–ã€‚é¦–å…ˆåœ¨ç»„è£…ä¸Šä¸å¤ªä¸€æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the loader and presenter</span></span><br><span class="line">TaskLoader taskLoader = <span class="keyword">new</span> TaskLoader(taskId, getApplicationContext());</span><br><span class="line"><span class="keyword">new</span> AddEditTaskPresenter(taskId, Injection.provideTasksRepository(getApplicationContext()), addEditTaskFragment, taskLoader, getSupportLoaderManager());</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåœ¨åˆ›å»ºPçš„æ—¶å€™ï¼Œè¿˜åˆ›å»ºäº†Loaderå¹¶å°†å®ƒä¼ å…¥ç»™äº†Pï¼ŒPæ€ä¹ˆä½¿ç”¨è¿™ä¸ªLoaderå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddEditTaskPresenter</span> <span class="keyword">implements</span> <span class="title">AddEditTaskContract</span>.<span class="title">Presenter</span>,</span></span><br><span class="line"><span class="class">        <span class="title">LoaderManager</span>.<span class="title">LoaderCallbacks</span>&lt;<span class="title">Task</span>&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		mLoaderManager.initLoader(TASK_QUERY, <span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Pçš„<code>start()</code>æ–¹æ³•ç›´æ¥ä»£ç†ç»™äº†Loaderï¼Œå¹¶ä¸”Pè‡ªèº«å®ç°äº†LoaderCallbackså›è°ƒã€‚</p>
<p>åœ¨æ•´ä¸ªAppé‡Œé¢æ€»å…±å®ç°äº†ä¸¤ä¸ªLoaderï¼Œä¸€ä¸ªç”¨äºåŠ è½½å•ä¸ªTaskï¼Œä¸€ä¸ªç”¨äºåŠ è½½æ‰€æœ‰çš„Taskã€‚å‰é¢æåˆ°è¿‡åŸå§‹çš„MVPå®ç°ä¸­<code>TasksDataSource</code>æœ‰ä¸¤ä¸ªå›è°ƒæ¥å£æ¥å‘Šè¯‰På±‚æ•°æ®åŠ è½½å®Œæ¯•ï¼Œè¿™ä¸¤ä¸ªæ¥å£åœ¨è¿™ç§å®ç°ä¸­å·²ç»è¢«Loaderä»£æ›¿æ‰ã€‚</p>
<p>è¿™ç§å®ç°çš„å¦å¤–ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹æ˜¯ï¼š<code>TasksRepository</code>é‡Œé¢å¯ä»¥è®¾ç½®è§‚å¯Ÿè€…ï¼Œè€Œæ¯ä¸€ä¸ªLoaderéƒ½å®ç°äº†æ¥å£ï¼Œæˆä¸ºç›¸åº”çš„è§‚å¯Ÿè€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TasksRepositoryObserver</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onTasksChanged</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TasksLoader</span> <span class="keyword">extends</span> <span class="title">AsyncTaskLoader</span>&lt;<span class="title">List</span>&lt;<span class="title">Task</span>&gt;&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">TasksRepository</span>.<span class="title">TasksRepositoryObserver</span></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯åˆ©ç”¨äº†Loaderçš„ç‰¹æ€§ï¼šLoaderåœ¨ç›‘å¬åˆ°æ•°æ®å˜åŒ–ä¹‹åï¼Œå¯ä»¥é€šè¿‡<code>forceLoad()</code>æ–¹æ³•é‡æ–°åŠ è½½æ•°æ®å¹¶å›è°ƒé€šçŸ¥ä¸Šå±‚ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTasksChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (isStarted()) &#123;</span><br><span class="line">		forceLoad();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§ç»„åˆçœ‹ä¸Šå»ä¹Ÿéå¸¸æ£’ï¼Œæ•´ä¸ªç»“æ„æµè½¬å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/mvp-loader.png" height="400" alt="mvp-loader"></div>

<p>å› ä¸º<code>TasksRepository</code>æ˜¯å•ä¾‹çš„ï¼Œé¡µé¢åªè¦é€šè¿‡Loaderä»æ•°æ®æºä¸­åŠ è½½æ•°æ®ï¼Œå°±ç­‰äºæ˜¯åœ¨æ•°æ®æºä¸­è®¾ç½®äº†ä¸€ä¸ªç›‘å¬ï¼šå› æ­¤è¿™ç§è®¾è®¡å¯ä»¥ç›‘å¬æ‰€æœ‰æ•°æ®çš„å˜åŒ–ã€‚</p>
<h3 id="TODOï¼šç»§ç»­åˆ†æå…¶ä½™å®ç°æ–¹å¼"><a href="#TODOï¼šç»§ç»­åˆ†æå…¶ä½™å®ç°æ–¹å¼" class="headerlink" title="TODOï¼šç»§ç»­åˆ†æå…¶ä½™å®ç°æ–¹å¼"></a>TODOï¼šç»§ç»­åˆ†æå…¶ä½™å®ç°æ–¹å¼</h3>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[åç¼–è¯‘APK]]></title>
      <url>http://www.timebridge.space/2016/04/21/Apk-reverse-engineering/</url>
      <content type="html"><![CDATA[<p>ä»¥ä¸‹æ˜¯åœ¨Macç¯å¢ƒä¸‹è¿›è¡Œçš„æ“ä½œã€‚</p>
<p>å¦‚æœåªæ˜¯æƒ³çœ‹ä»£ç ï¼Œå‡†å¤‡ä»¥ä¸‹ä¸¤ä¸ªå·¥å…·å³å¯:</p>
<ol>
<li><strong>dex2jar</strong> <a href="https://sourceforge.net/projects/dex2jar/" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a></li>
<li><strong>jd-gui</strong> <a href="http://jd.benow.ca/" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a></li>
</ol>
<p>è¿™ä¸¤ä¸ªå·¥å…·å‰è€…æ˜¯ä¸ºäº†æŠŠAndroidè§£å‹ç¼©å‡ºæ¥çš„<code>classes.dex</code>æ–‡ä»¶è§£ææˆjaræ–‡ä»¶ï¼Œåè€…åˆ™æ˜¯æŸ¥çœ‹è½¬åŒ–å‡ºçš„jaræ–‡ä»¶ï¼Œå³æºç æ–‡ä»¶çš„ã€‚<a id="more"></a></p>
<h3 id="å…·ä½“æ­¥éª¤"><a href="#å…·ä½“æ­¥éª¤" class="headerlink" title="å…·ä½“æ­¥éª¤"></a>å…·ä½“æ­¥éª¤</h3><ol>
<li>å°†APKæ–‡ä»¶é‡å‘½åä¸º.zipæ–‡ä»¶ï¼Œå¹¶è§£å‹ã€‚åœ¨è§£å‹æ–‡ä»¶å¤¹ä¸‹é¢å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>classes.dex</code>æ–‡ä»¶ï¼ˆæœ‰çš„ä¼šæœ‰å¤šä¸ªdexæ–‡ä»¶ï¼‰ï¼›</li>
<li>å°†ä¸‹è½½ä¸‹æ¥çš„dex2jarå‹ç¼©åŒ…è§£å‹ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª<code>dex2jar.sh</code>è„šæœ¬æ–‡ä»¶ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<strong><code>sh sh ./dex2jar.sh classes.dexæ–‡ä»¶åœ°å€</code></strong>å³å¯ç”Ÿæˆå¯¹åº”çš„jaræ–‡ä»¶ã€‚</li>
<li>æ‰“å¼€jd-guiåº”ç”¨ï¼Œæ‰“å¼€ç”Ÿæˆçš„jaræ–‡ä»¶ï¼Œå°±å¯ä»¥çœ‹åˆ°åç¼–è¯‘å‡ºæ¥çš„ä»£ç äº†ï¼›</li>
</ol>
<p>ä»¥ä¸Šå¯ä»¥åç¼–è¯‘å‡ºå¯¹åº”çš„ä»£ç ï¼Œä½†æ˜¯èµ„æºæ–‡ä»¶ï¼Œæ¯”å¦‚xmlæ–‡ä»¶éƒ½ä¸è¯»ï¼Œå¦‚æœæƒ³è¦çœ‹è¿™éƒ¨åˆ†å†…å®¹ï¼Œéœ€è¦ç”¨åˆ°å¦å¤–ä¸€ä¸ªå·¥å…·:<br><strong>apktool</strong> <a href="http://ibotpeaches.github.io/Apktool/" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a><br>å®ƒçš„ä½œç”¨å°±æ˜¯ç”¨äºå°†èµ„æºæ–‡ä»¶åè§£ææˆæ¥è¿‘åŸå§‹æ ¼å¼çš„æ ·å­çš„ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¿®æ”¹åé‡æ–°buildæ–‡ä»¶ï¼›å¯ä»¥ä¸€è¡Œè¡Œdebug smaliä»£ç ã€‚ç›¸å…³èµ„æ–™ï¼š</p>
<ol>
<li><a href="http://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="noopener">å®‰è£…æ•™ç¨‹</a>;</li>
<li><a href="http://ibotpeaches.github.io/Apktool/documentation/" target="_blank" rel="noopener">ä½¿ç”¨æ•™ç¨‹</a></li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ButterKnife æºç åˆ†æ]]></title>
      <url>http://www.timebridge.space/2016/03/27/ButterKnife/</url>
      <content type="html"><![CDATA[<h1 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h1><div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/logo_butterknife.png" width="188" alt="ButterKnife Logo"></div>

<p><strong>ButterKnife</strong> æ˜¯ä¸€ä¸ªæ³¨è§£æ¡†æ¶ï¼Œé¡¹ç›®åœ°å€: <a href="http://jakewharton.github.io/butterknife/" target="_blank" rel="noopener">ButterKnife</a> ã€‚ ç®€å•ä½¿ç”¨ğŸŒ°å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bind</span>(R.id.title) TextView title;</span><br><span class="line">	<span class="meta">@Bind</span>(R.id.subtitle) TextView subtitle;</span><br><span class="line">	<span class="meta">@Bind</span>(R.id.footer) TextView footer;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">		setContentView(R.layout.simple_activity);</span><br><span class="line">		ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line">		<span class="comment">// TODO Use fields...</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OnClick</span>(R.id.footer)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  		<span class="comment">// TODO submit data to server...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè¿™æ®µä»£ç å¯ä»¥ä»£æ›¿ä»¥ä¸‹è¿™æ®µä»£ç :<a id="more"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ExampleActivity activity)</span> </span>&#123;</span><br><span class="line">	activity.subtitle = (android.widget.TextView) activity.findViewById(<span class="number">2130968578</span>);</span><br><span class="line">	activity.footer = (android.widget.TextView) activity.findViewById(<span class="number">2130968579</span>);</span><br><span class="line">	activity.title = (android.widget.TextView) activity.findViewById(<span class="number">2130968577</span>);</span><br><span class="line">	</span><br><span class="line">	activity.footer..setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">			submit();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œä½¿ç”¨ButterKnifeåå¯ä»¥ä¸ç”¨å†å»å†™<code>findViewById</code>ã€<code>setOnClickListener</code>è¿™æ ·é‡å¤ç¹çä»£ç ï¼Œé€šè¿‡<code>@Bind</code>ã€<code>@OnClick</code>æ³¨è§£å°±å¯ä»¥è¾¾åˆ°æ•ˆæœï¼Œä»£ç ç®€æ´ä¸å°‘ã€‚</p>
<p>æ›´å¤šçš„ä¾‹å­å’ŒåŠŸèƒ½å¯ä»¥å‚è§<a href="http://jakewharton.github.io/butterknife/" target="_blank" rel="noopener">å®˜ç½‘ç¤ºä¾‹</a>ã€‚</p>
<p>æœ¬æ–‡é‡ç‚¹åˆ†æä¸¤ä¸ªå†…å®¹ï¼š</p>
<ol>
<li>ButterKnifeçš„æ³¨è§£å®šä¹‰æ–¹å¼ï¼›</li>
<li>ButterKnifeæ˜¯å¦‚ä½•è¿ç”¨ç¼–è¯‘æ—¶æ³¨è§£æ¥æé«˜æ•ˆç‡çš„ï¼ˆåœ¨Androidä¸Šï¼Œåå°„çš„æ•ˆç‡è¾ƒä½ï¼‰ï¼› </li>
</ol>
<h1 id="çŸ¥è¯†å‚¨å¤‡"><a href="#çŸ¥è¯†å‚¨å¤‡" class="headerlink" title="çŸ¥è¯†å‚¨å¤‡"></a>çŸ¥è¯†å‚¨å¤‡</h1><p>ç ”ç©¶ButterKnifeè¦å…·å¤‡ä¸€å®šçš„æ³¨è§£çŸ¥è¯†ï¼ŒCodeKKä¸Šæœ‰ç¯‡æ–‡ç« æ¨èé˜…è¯»: <a href="http://a.codekk.com/detail/Android/Trinea/%E5%85%AC%E5%85%B1%E6%8A%80%E6%9C%AF%E7%82%B9%E4%B9%8B%20Java%20%E6%B3%A8%E8%A7%A3%20Annotation" target="_blank" rel="noopener">ã€Šå…¬å…±æŠ€æœ¯ç‚¹ä¹‹ Java æ³¨è§£ Annotationã€‹</a>ã€‚</p>
<p>å…³äºè¿è¡Œæ—¶æ³¨è§£çš„å¼€å‘ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« :<a href="http://www.race604.com/annotation-processing/" target="_blank" rel="noopener">Javaæ³¨è§£å¤„ç†å™¨</a>ã€‚ButterKnifeä½¿ç”¨çš„æ˜¯<code>com.google.auto.service:auto-service</code>åŒ…ï¼Œé€šè¿‡å…¶<code>AutoService</code>æ³¨è§£æ¥å®ç°ç¼–è¯‘æ—¶æ³¨è§£çš„å¼€å‘ã€‚</p>
<p>å¦å¤–ä¹Ÿå¯ä»¥å…³æ³¨ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®: <a href="https://bitbucket.org/hvisser/android-apt" target="_blank" rel="noopener">android-apt</a>ã€‚</p>
<h1 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h1><p>å¦‚ä¸‹æ˜¯ButterKnifeçš„é¡¹ç›®ç»“æ„:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/ButterKnifeé¡¹ç›®.png" width="250" alt="ButterKnifeé¡¹ç›®"></div>

<p>ButterKnifeé¡¹ç›®åˆ†ä¸ºå››ä¸ªModule: Module butterknife-annotationsä¸­å®šä¹‰çš„æ˜¯ButterKnifeæ‰€æ”¯æŒçš„æ³¨è§£ï¼Œbutterknife-compilerä¸­ä¸»è¦æ˜¯ç¼–è¯‘æ—¶æ³¨è§£Processorã€‚butterknife-sampleåˆ™æ˜¯ä¸€ä¸ªä½¿ç”¨ä¾‹å­ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ¥é€æ­¥åˆ†ææ•´ä¸ªæ³¨è§£æ¡†æ¶çš„å®ç°ã€‚</p>
<h1 id="æ³¨è§£å®šä¹‰è§£æ"><a href="#æ³¨è§£å®šä¹‰è§£æ" class="headerlink" title="æ³¨è§£å®šä¹‰è§£æ"></a>æ³¨è§£å®šä¹‰è§£æ</h1><p>ButterKnifeæ”¯æŒçš„æ³¨è§£ä¸»è¦åˆ†ä¸ºå››ç±»:</p>
<ol>
<li>èµ„æºç»‘å®šã€‚é€šè¿‡Idå¼•ç”¨Arrayã€Bitmapã€Boolã€Colorã€Dimenã€Drawableã€Intã€Stringç­‰å‡ ç±»èµ„æºï¼›</li>
<li>äº‹ä»¶ç»‘å®šã€‚åŒ…æ‹¬onCheckedChangedã€onClickã€onItemClickã€onItemLongClickç­‰å‡ ç§äº‹ä»¶ç›‘å¬ï¼›</li>
<li>è§†å›¾ç»‘å®šã€‚é€šè¿‡idå®ä¾‹åŒ–xmlä¸­çš„Viewï¼›</li>
<li>Markæ³¨è§£ã€‚Unbinderå’ŒOptionalï¼›</li>
</ol>
<h2 id="èµ„æºç»‘å®šæ³¨è§£å®šä¹‰"><a href="#èµ„æºç»‘å®šæ³¨è§£å®šä¹‰" class="headerlink" title="èµ„æºç»‘å®šæ³¨è§£å®šä¹‰"></a>èµ„æºç»‘å®šæ³¨è§£å®šä¹‰</h2><p>è¿™ç±»æ³¨è§£éƒ½ä»¥<code>BindXXX</code>çš„å½¢å¼æ¥å‘½åï¼Œç”±äºèµ„æºæ³¨è§£éƒ½åªéœ€è¦æŒ‡å®šèµ„æºçš„idï¼Œå› æ­¤å®šä¹‰çš„å½¢å¼éå¸¸ä¸€è‡´ã€‚ä¸‹é¢ä»¥Stringèµ„æºä¸ºä¾‹ï¼Œå±•ç¤ºä¸€ä¸‹å®šä¹‰å†…å®¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bind a field to the specified string resource ID.</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;&lt;code&gt;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@literal</span> @&#125;BindString(R.string.username_error) String usernameErrorText;</span></span><br><span class="line"><span class="comment"> * &lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention</span>(CLASS) <span class="meta">@Target</span>(FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindString &#123;</span><br><span class="line">	<span class="comment">/** String resource ID to which the field will be bound. */</span></span><br><span class="line">	<span class="meta">@StringRes</span> <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¿˜ç”¨åˆ°äº†Androidæä¾›çš„èµ„æºæ³¨è§£ï¼Œä»¥ä¿è¯è¿”å›çš„Idç¬¦åˆç‰¹å®šçš„èµ„æºã€‚æ³¨è§£æ˜¯ç¼–è¯‘æ—¶æ³¨è§£(CLASS)ï¼Œé€‚ç”¨äºå±æ€§(FIELD)ã€‚</p>
<h2 id="äº‹ä»¶ç»‘å®šæ³¨è§£"><a href="#äº‹ä»¶ç»‘å®šæ³¨è§£" class="headerlink" title="äº‹ä»¶ç»‘å®šæ³¨è§£"></a>äº‹ä»¶ç»‘å®šæ³¨è§£</h2><p>äº‹ä»¶ç»‘å®šæ³¨è§£æ¯”è¾ƒå¤æ‚ï¼Œä¸»è¦æ˜¯å› ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢:</p>
<ol>
<li>ä¸ºViewæ·»åŠ ç›‘å¬çš„æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚<code>setOnClickListener</code>ã€<code>addTextChangedListener</code>ã€<code>setOnFocusChangeListener</code>ç­‰ï¼Œæ–¹æ³•åå­—æœ¬èº«ä¸ä¸€è‡´ï¼Œä¸”æ— è§„å¾‹å¯è¨€ï¼›</li>
<li>è¿™äº›æ–¹æ³•åªèƒ½ç»‘å®šåœ¨ç‰¹å®šçš„Viewä¸Šé¢ï¼›</li>
<li>ç›‘å¬éœ€è¦å®ç°çš„æ–¹æ³•æœ‰å¾ˆå¤§çš„å·®åˆ«ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<code>OnLongClickListener</code>å’Œ<code>TextWatcher</code>éœ€è¦å®ç°çš„æ–¹æ³•çš„åŒºåˆ«ï¼›</li>
</ol>
<p>å› æ­¤åœ¨ButterKnifeå†…éƒ¨ä¸“é—¨ä¸ºæ­¤å»ºç«‹ä¸¤ä¸ªæ³¨è§£:<code>ListenerClass</code>å’Œ<code>ListenerMethod</code>ï¼ˆå¯ä»¥è®¤ä¸ºæ˜¯ButterKnifeæ”¯æŒäº‹ä»¶ç»‘å®šæ³¨è§£çš„å…ƒæ³¨è§£ï¼‰ã€‚</p>
<h3 id="äº‹ä»¶å…ƒæ³¨è§£"><a href="#äº‹ä»¶å…ƒæ³¨è§£" class="headerlink" title="äº‹ä»¶å…ƒæ³¨è§£"></a>äº‹ä»¶å…ƒæ³¨è§£</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>ListenerMethod</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RUNTIME) <span class="meta">@Target</span>(FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListenerMethod &#123;</span><br><span class="line">	<span class="comment">/** Name of the listener method for which this annotation applies. */</span></span><br><span class="line">	<span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** List of method parameters. If the type is not a primitive it must be fully-qualified. */</span></span><br><span class="line">	String[] parameters() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Primitive or fully-qualified return type of the listener method. May also be &#123;<span class="doctag">@code</span> void&#125;. */</span></span><br><span class="line">	<span class="function">String <span class="title">returnType</span><span class="params">()</span> <span class="keyword">default</span> "<span class="keyword">void</span>"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** If &#123;<span class="doctag">@link</span> #returnType()&#125; is not &#123;<span class="doctag">@code</span> void&#125; this value is returned when no binding exists. */</span></span><br><span class="line">	<span class="function">String <span class="title">defaultReturn</span><span class="params">()</span> <span class="keyword">default</span> "<span class="keyword">null</span>"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ³¨è§£ä¸»è¦æ˜¯å®šä¹‰ä¸€ä¸ªæ–¹æ³•çš„ç­¾å(æ–¹æ³•åå­—ã€æ–¹æ³•çš„å‚æ•°ã€æ–¹æ³•çš„è¿”å›ç±»å‹)ä»¥åŠé»˜è®¤è¿”å›å€¼ã€‚</p>
<p>å†æ¥çœ‹<code>ListenerClass</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RUNTIME) <span class="meta">@Target</span>(ANNOTATION_TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListenerClass &#123;</span><br><span class="line">	<span class="function">String <span class="title">targetType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Name of the setter method on the &#123;<span class="doctag">@link</span> #targetType() target type&#125; for the listener. */</span></span><br><span class="line">	<span class="function">String <span class="title">setter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Fully-qualified class name of the listener type. */</span></span><br><span class="line">	<span class="function">String <span class="title">type</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Enum which declares the listener callback methods. Mutually exclusive to &#123;<span class="doctag">@link</span> #method()&#125;. */</span></span><br><span class="line">	Class&lt;? extends Enum&lt;?&gt;&gt; callbacks() <span class="keyword">default</span> NONE.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Method data for single-method listener callbacks. Mutually exclusive with &#123;<span class="doctag">@link</span> #callbacks()&#125;</span></span><br><span class="line"><span class="comment">    * and an error to specify more than one value.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	ListenerMethod[] method() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Default value for &#123;<span class="doctag">@link</span> #callbacks()&#125;. */</span></span><br><span class="line">	<span class="keyword">enum</span> NONE &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ³¨è§£ä¸»è¦å®šä¹‰å¦‚ä¸‹å†…å®¹:</p>
<ol>
<li><strong>setter():</strong> ç›‘å¬çš„è®¾ç½®æ–¹æ³•å…¨ç§°ï¼›</li>
<li><strong>type():</strong> ç›‘å¬ç±»çš„ç±»åå…¨ç§°ï¼›</li>
<li><strong>method():</strong> ç›‘å¬ç±»ä¸­æœ‰å“ªäº›æ–¹æ³•ï¼›</li>
<li><strong>callback():</strong> å½“ä¸€ä¸ªç›‘å¬æœ‰å¤šä¸ªå›è°ƒæ—¶ï¼ŒæŒ‡å®šå½“å‰æ–¹æ³•åœ¨å“ªä¸ªå›è°ƒä¸­è°ƒç”¨ï¼Œåé¢æœ‰è¯¦ç»†é˜è¿°ï¼›</li>
</ol>
<p>æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£éƒ½æ˜¯ç”¨æ¥ä¿®é¥°æ³¨è§£çš„ï¼šå¯ä»¥çœ‹åˆ°<code>@Target</code>éƒ½æ˜¯<code>ANNOTATION_TYPE</code>ç±»å‹çš„ã€‚</p>
<h3 id="äº‹ä»¶æ³¨è§£"><a href="#äº‹ä»¶æ³¨è§£" class="headerlink" title="äº‹ä»¶æ³¨è§£"></a>äº‹ä»¶æ³¨è§£</h3><p>ç”±äºäº‹ä»¶çš„å¤æ‚æ€§ï¼Œæ³¨è§£å®šä¹‰æœ¬èº«å·®è·æ¯”è¾ƒå¤§ï¼Œå…ˆçœ‹ä¸€ä¸ªç®€å•çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(CLASS)</span><br><span class="line"><span class="meta">@ListenerClass</span>(</span><br><span class="line">    targetType = <span class="string">"android.widget.CompoundButton"</span>,</span><br><span class="line">    setter = <span class="string">"setOnCheckedChangeListener"</span>,</span><br><span class="line">    type = <span class="string">"android.widget.CompoundButton.OnCheckedChangeListener"</span>,</span><br><span class="line">    method = <span class="meta">@ListenerMethod</span>(</span><br><span class="line">        name = <span class="string">"onCheckedChanged"</span>,</span><br><span class="line">        parameters = &#123;</span><br><span class="line">            <span class="string">"android.widget.CompoundButton"</span>,</span><br><span class="line">            <span class="string">"boolean"</span></span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnCheckedChanged &#123;</span><br><span class="line">	<span class="comment">/** View IDs to which the method will be bound. */</span></span><br><span class="line">	<span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œè¯¥æ³¨è§£åŒæ ·æ˜¯ç¼–è¯‘æ—¶æ³¨è§£ï¼Œå¹¶ä¸”æ˜¯ç”¨äºä¿®é¥°ä¸€ä¸ªæ–¹æ³•çš„ã€‚<br>å…¶æ¬¡ï¼Œä½¿ç”¨â€œå…ƒæ³¨è§£â€ä¿®é¥°è¯¥æ³¨è§£ï¼šè¯¥æ³¨è§£æ˜¯ç”¨äºä¸ºComPoundButtoné€šè¿‡<code>setOnCheckedChangeListener</code>æ·»åŠ <code>OnCheckedChangeListener</code>ç›‘å¬çš„ï¼Œè¯¥ç›‘å¬æœ‰ä¸€ä¸ªéœ€è¦å®ç°çš„æ–¹æ³•<code>onCheckedChanged</code>ï¼Œè¯¥æ–¹æ³•ä¼ å…¥ä¸€ä¸ªCompoundButtonå¯¹è±¡å’Œå¸ƒå°”å€¼ä½œä¸ºå‚æ•°ã€‚</p>
<p>æœ€åæˆ‘ä»¬å…³æ³¨ä¸€ä¸‹è¿™ä¸ªæ³¨è§£æœ¬èº«ï¼šå®ƒåªéœ€è¦è¿”å›è®¾ç½®ä¸€ç»„idå³å¯ï¼Œé»˜è®¤è¿”å›çš„æ˜¯<code>View.NO_ID</code>ã€‚</p>
<p>è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªäº‹ä»¶æ³¨è§£çš„å®šä¹‰ã€‚è¿™æ ·çœ‹ä¸Šå»å¾ˆæŠ½è±¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªå®˜ç½‘å¯¹<code>OnClick</code>æ³¨è§£çš„ä½¿ç”¨ä¾‹å­å°±æ¸…æ¥šäº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClick</span>(&#123; R.id.door1, R.id.door2, R.id.door3 &#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pickDoor</span><span class="params">(DoorView door)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (door.hasPrizeBehind()) &#123;</span><br><span class="line">		Toast.makeText(<span class="keyword">this</span>, <span class="string">"You win!"</span>, LENGTH_SHORT).show();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		Toast.makeText(<span class="keyword">this</span>, <span class="string">"Try again"</span>, LENGTH_SHORT).show();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œå°±æ˜¯ä¸ºä¸‰ä¸ªdoor Viewæ·»åŠ <code>onClickListener</code>ç›‘å¬ã€‚</p>
<p>é‚£ä¹ˆå¦‚æœä¸€ä¸ªç›‘å¬æœ‰å¤šä¸ªæ–¹æ³•éœ€è¦å›è°ƒï¼Œåˆåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ¯”å¦‚ViewPagerçš„<code>OnPageChangeListener</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">viewPager.setOnPageChangeListener(<span class="keyword">new</span> ViewPager.OnPageChangeListener() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrolled</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">float</span> v, <span class="keyword">int</span> i1)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrollStateChanged</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>å¦‚æœåƒ<code>@onClick</code>é‚£æ ·ç»‘å®šï¼Œæˆ‘æ€ä¹ˆçŸ¥é“ç»‘å®šçš„æ˜¯å“ªä¸ªæ–¹æ³•å‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯åœ¨å“ªä¸ªå›è°ƒé‡Œé¢æ‰§è¡Œè¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿè¿™ä¸ªæ˜¯é€šè¿‡<code>callback</code>æ¥å®ç°çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>@OnPageChange</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(CLASS)</span><br><span class="line"><span class="meta">@ListenerClass</span>(</span><br><span class="line">    targetType = <span class="string">"android.support.v4.view.ViewPager"</span>,</span><br><span class="line">    setter = <span class="string">"setOnPageChangeListener"</span>,</span><br><span class="line">    type = <span class="string">"android.support.v4.view.ViewPager.OnPageChangeListener"</span>,</span><br><span class="line">    callbacks = OnPageChange.Callback.class</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnPageChange &#123;</span><br><span class="line">	<span class="comment">/** View IDs to which the method will be bound. */</span></span><br><span class="line">	<span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Listener callback to which the method will be bound. */</span></span><br><span class="line">	<span class="function">Callback <span class="title">callback</span><span class="params">()</span> <span class="keyword">default</span> Callback.PAGE_SELECTED</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** &#123;<span class="doctag">@code</span> ViewPager.OnPageChangeListener&#125; callback methods. */</span></span><br><span class="line">	<span class="keyword">enum</span> Callback &#123;</span><br><span class="line">		<span class="comment">/** &#123;<span class="doctag">@code</span> onPageSelected(int)&#125; */</span></span><br><span class="line">		<span class="meta">@ListenerMethod</span>(</span><br><span class="line">			name = <span class="string">"onPageSelected"</span>,</span><br><span class="line">			parameters = <span class="string">"int"</span></span><br><span class="line">		PAGE_SELECTED,</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** &#123;<span class="doctag">@code</span> onPageScrolled(int, float, int)&#125; */</span></span><br><span class="line">		<span class="meta">@ListenerMethod</span>(</span><br><span class="line">			name = <span class="string">"onPageScrolled"</span>,</span><br><span class="line">			parameters = &#123;</span><br><span class="line">				<span class="string">"int"</span>,</span><br><span class="line">				<span class="string">"float"</span>,</span><br><span class="line">				<span class="string">"int"</span></span><br><span class="line">			&#125;</span><br><span class="line">		)</span><br><span class="line">		PAGE_SCROLLED,</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** &#123;<span class="doctag">@code</span> onPageScrollStateChanged(int)&#125; */</span></span><br><span class="line">    	<span class="meta">@ListenerMethod</span>(</span><br><span class="line">        	name = <span class="string">"onPageScrollStateChanged"</span>,</span><br><span class="line">        	parameters = <span class="string">"int"</span></span><br><span class="line">    	)</span><br><span class="line">    	PAGE_SCROLL_STATE_CHANGED,</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>callbackå…¶å®æ˜¯ä¸ªæšä¸¾å€¼ï¼Œæ˜¯ä¸€ç»„ListenerMethodï¼Œæ˜ å°„åˆ°ç›‘å¬ç±»çš„è‹¥å¹²ä¸ªæ–¹æ³•ï¼Œ<code>@OnPageChange</code>æ³¨è§£å°±å®šä¹‰äº†ä¸‰ç»„ï¼Œcallbacké»˜è®¤æ˜¯<code>Callback.PAGE_SELECTED</code>ï¼Œè¿™ä¸ªå€¼ä»£è¡¨çš„æ–¹æ³•æ˜¯<code>onPageSelected</code>ï¼Œå³å¦‚æœæŒ‰ç…§ä¸‹é¢çš„ç”¨æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnPageChange</span>(R.id.example_pager) <span class="function"><span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">	Toast.makeText(<span class="keyword">this</span>, <span class="string">"Selected "</span> + position + <span class="string">"!"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå°±æ˜¯å½“<code>onPageSelected</code>å›è°ƒæ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚å¦‚æœæˆ‘æƒ³ç»‘å®šåˆ°å¦å¤–ä¸€ä¸ªå›è°ƒæ¥å£é‡Œé¢å»ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå¯ä»¥å¦‚ä¸‹ä½¿ç”¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnPageChange</span>(value = R.id.example_pager, callback = PAGE_SCROLL_STATE_CHANGED)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onPageStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">	Toast.makeText(<span class="keyword">this</span>, <span class="string">"State changed: "</span> + state + <span class="string">"!"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥åœ¨<code>onPageScrollStateChanged</code>å›è°ƒä¸­è°ƒç”¨è¿™ä¸ªæ–¹æ³•äº†ã€‚</p>
<h2 id="è§†å›¾ç»‘å®šæ³¨è§£"><a href="#è§†å›¾ç»‘å®šæ³¨è§£" class="headerlink" title="è§†å›¾ç»‘å®šæ³¨è§£"></a>è§†å›¾ç»‘å®šæ³¨è§£</h2><p>å’Œèµ„æºç»‘å®šæ³¨è§£å¾ˆåƒï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bind a field to the view for the specified ID. The view will automatically be cast to the field</span></span><br><span class="line"><span class="comment"> * type.</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;&lt;code&gt;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@literal</span> @&#125;Bind(R.id.title) TextView title;</span></span><br><span class="line"><span class="comment"> * &lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention</span>(CLASS) <span class="meta">@Target</span>(FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Bind &#123;</span><br><span class="line">	<span class="comment">/** View ID to which the field will be bound. */</span></span><br><span class="line">	<span class="meta">@IdRes</span> <span class="keyword">int</span>[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªä¸è¿‡è¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ªint[]æ•°ç»„ï¼Œå› ä¸º<code>@Bind</code>å®é™…æ”¯æŒå°†ä¸€ç»„idç»‘å®šåˆ°ä¸€ä¸ªæ•°ç»„æˆ–è€…Listå±æ€§ä¸Šã€‚</p>
<h2 id="å…¶ä½™æ³¨è§£"><a href="#å…¶ä½™æ³¨è§£" class="headerlink" title="å…¶ä½™æ³¨è§£"></a>å…¶ä½™æ³¨è§£</h2><ol>
<li><strong>Unbinder</strong> è¿™ä¸ªæ³¨è§£æ˜¯ä¸ºäº†ç»™ç±»ç”Ÿæˆä¸€ä¸ªUnbinderå®ä¾‹ï¼Œè¿™æ ·å¯ä»¥å°†ä¹‹å‰<code>bind</code>çš„å˜é‡å…¨éƒ¨è§£ç»‘ï¼Œåé¢æœ‰ä¾‹å­ï¼›</li>
<li><strong>Optional</strong> å¯é€‰é¡¹ï¼Œæœ‰æ—¶å€™æœ‰äº›Viewã€èµ„æºæ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥æœ‰äº›æ³¨å…¥å¿…é¡»å¯é€‰ï¼Œå¦åˆ™å°±ä¼šCrashï¼›</li>
</ol>
<h1 id="æ³¨è§£è§£æå¤§è‡´è¿‡ç¨‹"><a href="#æ³¨è§£è§£æå¤§è‡´è¿‡ç¨‹" class="headerlink" title="æ³¨è§£è§£æå¤§è‡´è¿‡ç¨‹"></a>æ³¨è§£è§£æå¤§è‡´è¿‡ç¨‹</h1><p>å®šä¹‰æ³¨è§£åªæ˜¯æ³¨è§£æ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œä»£è¡¨ç€æ³¨è§£æ¡†æ¶æ‰€æ”¯æŒçš„åŠŸèƒ½ï¼Œè§£ææ³¨è§£æ˜¯æ³¨è§£æ¡†æ¶çš„å¦ä¸€ä¸ªæ ¸å¿ƒéƒ¨åˆ†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ButterKnifeæ˜¯å¦‚ä½•å®ç°ç¼–è¯‘æ—¶æ³¨è§£çš„ã€‚æˆ‘ä»¬å°±ä»ä½¿ç”¨çš„ä¾‹å­ä¸Šåˆ‡å…¥å¼€å§‹åˆ†ææ•´ä¸ªæ³¨è§£çš„è¿ä½œè¿‡ç¨‹ã€‚</p>
<h2 id="è¿è¡Œæ—¶è§£æ"><a href="#è¿è¡Œæ—¶è§£æ" class="headerlink" title="è¿è¡Œæ—¶è§£æ"></a>è¿è¡Œæ—¶è§£æ</h2><p>è¿è¡Œæ—¶è§£ææºäºButterKnifeçš„ä¸€è¡Œä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ButterKnife.bind(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>åœ¨ä»»ä½•éœ€è¦ä½¿ç”¨ButterKnifeçš„ç±»ä¸­ï¼Œè¿™è¡Œä»£ç éƒ½éœ€è¦è°ƒç”¨ã€‚æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</span><br><span class="line">    bind(target, target, Finder.ACTIVITY);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(@NonNull Object target, @NonNull Object source, @NonNull Finder finder)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; targetClass = target.getClass();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up view binder for "</span> + targetClass.getName());</span><br><span class="line">        ViewBinder&lt;Object&gt; viewBinder = findViewBinderForClass(targetClass);</span><br><span class="line">        viewBinder.bind(finder, target, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to bind views for "</span> + targetClass.getName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>bind()</code>æ–¹æ³•æœ‰å¾ˆå¤šé‡è½½æ–¹æ³•ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°æ–¹æ³•<code>bind(@NonNull Object target, @NonNull Object source, @NonNull Finder finder)</code>ã€‚è¿™ä¸ªæ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å…³æ³¨ä¸€ä¸‹ç¬¬ä¸‰ä¸ªå‚æ•°<code>Finder</code>ï¼Œè¿™ä¸ªå…¶å®æ˜¯ä¸€ä¸ªæšä¸¾ç±»ï¼Œç”¨äºç¼–è¯‘æ—¶ç”Ÿæˆçš„ä»£ç ä¸­ï¼Œéå¸¸é‡è¦ï¼ˆåé¢å°±å¯ä»¥è§åˆ°äº†ï¼‰ï¼Œå®ƒä¸»è¦çš„åŠŸèƒ½å¦‚ä¸‹:<br><strong>ä¸ºActivityã€Viewã€Dialogä¸‰ç§æƒ…æ™¯æä¾›Contextä»¥åŠfindViewByIdåŠŸèƒ½ï¼Œå¹¶è‡ªå¸¦å¼ºåˆ¶è½¬æ¢ã€‚</strong></p>
<p>è¿™ä¸ªæ–¹æ³•ä¼šå¯¹targetClassè¿›è¡Œè§£æï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯<code>findViewBinderForClass()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, ViewBinder&lt;Object&gt;&gt; BINDERS = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ViewBinder&lt;Object&gt; NOP_VIEW_BINDER = <span class="keyword">new</span> ViewBinder&lt;Object&gt;() &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ViewBinder&lt;Object&gt; <span class="title">findViewBinderForClass</span><span class="params">(Class&lt;?&gt; cls)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">    ViewBinder&lt;Object&gt; viewBinder = BINDERS.get(cls);</span><br><span class="line">    <span class="keyword">if</span> (viewBinder != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Cached in view binder map."</span>);</span><br><span class="line">        <span class="keyword">return</span> viewBinder;</span><br><span class="line">    &#125;</span><br><span class="line">    String clsName = cls.getName();</span><br><span class="line">    <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"MISS: Reached framework class. Abandoning search."</span>);</span><br><span class="line">        <span class="keyword">return</span> NOP_VIEW_BINDER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; viewBindingClass = Class.forName(clsName + <span class="string">"$$ViewBinder"</span>);</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        viewBinder = (ViewBinder&lt;Object&gt;) viewBindingClass.newInstance();</span><br><span class="line">        <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Loaded view binder class."</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Not found. Trying superclass "</span> + cls.getSuperclass().getName());</span><br><span class="line">        viewBinder = findViewBinderForClass(cls.getSuperclass());</span><br><span class="line">    &#125;</span><br><span class="line">    BINDERS.put(cls, viewBinder);</span><br><span class="line">    <span class="keyword">return</span> viewBinder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå…¶å®æ˜¯ä¸ºä¸€ä¸ªç±»åˆ›å»ºä¸€ä¸ªViewBinder<object>å¯¹è±¡ï¼Œå¹¶é€šè¿‡BINDERSåšå‡ºç¼“å­˜ã€‚è¿™é‡Œæ³¨æ„ä¸€ç‚¹: å½“æ£€æµ‹åˆ°æ—¶androidæˆ–è€…javaæ¡†æ¶åº“ä¸­çš„ç±»ï¼Œåˆ™ç«‹å³è¿”å›ï¼Œå¦åˆ™å°±ä¼šé»˜è®¤å»è¯»å–ç±»ä¸­çš„<code>clsName + &quot;$$ViewBinder&quot;</code>ç±»ï¼Œå¹¶ç”±è¿™ä¸ªç±»åˆ›å»ºå‡ºViewBinder<object>å¯¹è±¡ï¼ˆå¯ä»¥çŒœæµ‹å‡ºè¿™ä¸ªç±»å°±æ˜¯ViewBinder<object>ç±»å‹çš„ï¼‰ã€‚</object></object></object></p>
<p>å¯æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨ButterKnifeç±»çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰åˆ›å»ºè¿™ä¸ªå¥‡æ€ªçš„ç±»ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»æ¥è‡ªå“ªé‡Œå‘¢ï¼Ÿè¿™ä¸ªä¸‹ä¸€èŠ‚å†è§£é‡Šï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹åˆ†æï¼Œåœ¨<code>findViewBinderForClass</code>ä¹‹åï¼Œè°ƒç”¨çš„å°±æ˜¯ä¸‹é¢çš„æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">viewBinder.bind(finder, target, source);</span><br></pre></td></tr></table></figure>
<p>ViewBinderåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ¡†æ¶é‡Œé¢æ²¡æœ‰ç›¸å…³å®ç°ï¼Œæ ¹æ®å‰é¢çš„åˆ†æï¼Œå…·ä½“çš„å®ç°åº”è¯¥åœ¨<code>clsName + &quot;$$ViewBinder&quot;</code>ç±»ä¸­ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å»æ‰¾<code>clsName + &quot;$$ViewBinder&quot;</code>ç±»å§ã€‚</p>
<h2 id="ç¼–è¯‘æ—¶æ³¨è§£â€”â€”ä»£ç ç”Ÿæˆ"><a href="#ç¼–è¯‘æ—¶æ³¨è§£â€”â€”ä»£ç ç”Ÿæˆ" class="headerlink" title="ç¼–è¯‘æ—¶æ³¨è§£â€”â€”ä»£ç ç”Ÿæˆ"></a>ç¼–è¯‘æ—¶æ³¨è§£â€”â€”ä»£ç ç”Ÿæˆ</h2><p>ç ”ç©¶ç¼–è¯‘æ—¶æ³¨è§£ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°Processorç±»ï¼ŒButterKnifeç±»çš„Processorç±»å«åš<code>ButterKnifeProcessor</code>ï¼Œå®ƒçš„<code>process</code>æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">    Map&lt;TypeElement, BindingClass&gt; targetClassMap = findAndParseTargets(env);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</span><br><span class="line">        TypeElement typeElement = entry.getKey();</span><br><span class="line">        BindingClass bindingClass = entry.getValue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bindingClass.brewJava().writeTo(filer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            error(typeElement, <span class="string">"Unable to write view binder for type %s: %s"</span>, typeElement,</span><br><span class="line">            e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªå…³é”®ç‚¹æ˜¯è°ƒç”¨<code>findAndParseTargets</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingClass&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">    Map&lt;TypeElement, BindingClass&gt; targetClassMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    Set&lt;String&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process each @Bind element.</span></span><br><span class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(Bind.class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parseBind(element, targetClassMap, erasedTargetNames);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logParsingError(element, Bind.class, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process each annotation that corresponds to a listener.</span></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</span><br><span class="line">        findAndParseListener(env, listener, targetClassMap, erasedTargetNames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process each @BindArray element.</span></span><br><span class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindArray.class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             parseResourceArray(element, targetClassMap, erasedTargetNames);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logParsingError(element, BindArray.class, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process each @BindBitmap element.</span></span><br><span class="line">    <span class="comment">// Process each @BindBool element.</span></span><br><span class="line">    <span class="comment">// Process each @BindColor element.</span></span><br><span class="line">    <span class="comment">// Process each @BindDimen element.</span></span><br><span class="line">    <span class="comment">// Process each @BindDrawable element.</span></span><br><span class="line">    <span class="comment">// Process each @BindInt element.</span></span><br><span class="line">    <span class="comment">// Process each @BindString element.    </span></span><br><span class="line">    <span class="comment">// Process each @Unbinder element.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to find a parent binder for each.</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</span><br><span class="line">        String parentClassFqcn = findParentFqcn(entry.getKey(), erasedTargetNames);</span><br><span class="line">        <span class="keyword">if</span> (parentClassFqcn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            entry.getValue().setParentViewBinder(parentClassFqcn + BINDING_CLASS_SUFFIX);</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">return</span> targetClassMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç²—ç•¥ä¸€çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯éå†å¹¶ä¸”æ•´ç†æ‰€æœ‰ä½¿ç”¨ButterKnifeæ³¨è§£çš„å…ƒç´ ï¼Œè¯¦ç»†æš‚æ—¶ç•¥å»ä¸è¡¨ã€‚</p>
<p>ç»§ç»­å¾€ä¸‹çœ‹ï¼šåœ¨éå†è¿™äº›å…ƒç´ ä¹‹åå†éå†<code>targetClassMap</code>ï¼Œç„¶åè°ƒç”¨<code>bindingClass.brewJava().writeTo(filer);</code>æ–¹æ³•åˆ›å»ºæ–‡ä»¶ï¼Œè¿™å°±ç®—ç”Ÿæˆå¤„ç†å®Œäº†ï¼Œé‚£ä¹ˆåˆ°åº•ç”Ÿæˆäº†ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ</p>
<h3 id="ç¼–è¯‘æ—¶æ³¨è§£è¿è¡Œç»“æœ"><a href="#ç¼–è¯‘æ—¶æ³¨è§£è¿è¡Œç»“æœ" class="headerlink" title="ç¼–è¯‘æ—¶æ³¨è§£è¿è¡Œç»“æœ"></a>ç¼–è¯‘æ—¶æ³¨è§£è¿è¡Œç»“æœ</h3><p>è¿™é‡Œå·ä¸ªæ‡’ï¼Œä¹Ÿæ˜¯ä¸ºäº†æ›´å¿«æ·çš„è¾¾åˆ°ç›®æ ‡ï¼šå› ä¸ºæœ‰module butterknife-sampleï¼Œæ‰€ä»¥ButterKnifeå¯ä»¥ç›´æ¥å½“åšåº”ç”¨è¿è¡Œã€‚æˆ‘ä»¬runä¸€ä¸‹ï¼Œç„¶ååœ¨è¯¥ä¸‹é¢ç›®å½•ç»“æ„ä¸‹å°±å¯ä»¥çœ‹åˆ°ä¸€äº›æ–‡ä»¶:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/Butter-Knifeç”Ÿæˆç±».png" height="250" alt="Butter-Knifeç”Ÿæˆç±»"></div>

<p>å¦‚å›¾ï¼Œåœ¨è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°è¿è¡Œæ—¶æ³¨è§£è‡ªåŠ¨ç”Ÿæˆçš„ç±»â€”â€”ç±»åæ˜¯ä»¥<code>$$ViewBinder</code>ç»“å°¾çš„ï¼Œä»¥<code>SimpleActivity$$ViewBinder</code>ä¸ºä¾‹ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity</span>$$<span class="title">ViewBinder</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">SimpleActivity</span>&gt; <span class="keyword">implements</span> <span class="title">ViewBinder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> SimpleActivity$$ViewBinder() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Finder finder, <span class="keyword">final</span> T target, Object source)</span> </span>&#123;</span><br><span class="line">        SimpleActivity$$ViewBinder.Unbinder unbinder = <span class="keyword">new</span> SimpleActivity$$ViewBinder.Unbinder(target);</span><br><span class="line">        View view = (View)finder.findRequiredView(source, <span class="number">2130968576</span>, <span class="string">"field \'title\'"</span>);</span><br><span class="line">        target.title = (TextView)finder.castView(view, <span class="number">2130968576</span>, <span class="string">"field \'title\'"</span>);</span><br><span class="line">        view = (View)finder.findRequiredView(source, <span class="number">2130968577</span>, <span class="string">"field \'subtitle\'"</span>);</span><br><span class="line">        target.subtitle = (TextView)finder.castView(view, <span class="number">2130968577</span>, <span class="string">"field \'subtitle\'"</span>);</span><br><span class="line">        view = (View)finder.findRequiredView(source, <span class="number">2130968578</span>, <span class="string">"field \'hello\', method \'sayHello\', and method \'sayGetOffMe\'"</span>);</span><br><span class="line">        target.hello = (Button)finder.castView(view, <span class="number">2130968578</span>, <span class="string">"field \'hello\'"</span>);</span><br><span class="line">        unbinder.view2130968578 = view;</span><br><span class="line">        view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</span><br><span class="line">                target.sayHello();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        view.setOnLongClickListener(<span class="keyword">new</span> OnLongClickListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View p0)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> target.sayGetOffMe();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        view = (View)finder.findRequiredView(source, <span class="number">2130968579</span>, <span class="string">"field \'listOfThings\' and method \'onItemClick\'"</span>);</span><br><span class="line">        target.listOfThings = (ListView)finder.castView(view, <span class="number">2130968579</span>, <span class="string">"field \'listOfThings\'"</span>);</span><br><span class="line">        unbinder.view2130968579 = view;</span><br><span class="line">        ((AdapterView)view).setOnItemClickListener(<span class="keyword">new</span> OnItemClickListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; p0, View p1, <span class="keyword">int</span> p2, <span class="keyword">long</span> p3)</span> </span>&#123;</span><br><span class="line">                target.onItemClick(p2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        view = (View)finder.findRequiredView(source, <span class="number">2130968580</span>, <span class="string">"field \'footer\'"</span>);</span><br><span class="line">        target.footer = (TextView)finder.castView(view, <span class="number">2130968580</span>, <span class="string">"field \'footer\'"</span>);</span><br><span class="line">        target.headerViews = Utils.listOf(<span class="keyword">new</span> View[]&#123;(View)finder.findRequiredView(source, <span class="number">2130968576</span>, <span class="string">"field \'headerViews\'"</span>), (View)finder.findRequiredView(source, <span class="number">2130968577</span>, <span class="string">"field \'headerViews\'"</span>), (View)finder.findRequiredView(source, <span class="number">2130968578</span>, <span class="string">"field \'headerViews\'"</span>)&#125;);</span><br><span class="line">        target.unbinder = unbinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Unbinder</span> <span class="keyword">implements</span> <span class="title">butterknife</span>.<span class="title">ButterKnife</span>.<span class="title">Unbinder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> SimpleActivity target;</span><br><span class="line">        View view2130968578;</span><br><span class="line">        View view2130968579;</span><br><span class="line"></span><br><span class="line">        Unbinder(SimpleActivity target) &#123;</span><br><span class="line">            <span class="keyword">this</span>.target = target;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.target.title = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.target.subtitle = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.view2130968578.setOnClickListener((OnClickListener)<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">this</span>.view2130968578.setOnLongClickListener((OnLongClickListener)<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">this</span>.target.hello = <span class="keyword">null</span>;</span><br><span class="line">                ((AdapterView)<span class="keyword">this</span>.view2130968579).setOnItemClickListener((OnItemClickListener)<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">this</span>.target.listOfThings = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.target.footer = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.target.headerViews = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.target.unbinder = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.target = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç±»å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç±»ï¼Œä¹Ÿæ˜¯ <strong>æ³¨è§£è§£æ</strong> ä¸€èŠ‚ä¸­è°ƒç”¨<code>Binder.bind()</code>æ–¹æ³•æ—¶ç”¨äºç»‘å®šçš„ç±»ï¼Œæ³¨æ„è¿™ä¸ªç±»ï¼šå®ƒå®ç°äº†ViewBinderæ¥å£ã€‚å†çœ‹ä¸€ä¸‹<code>bind</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(@NonNull Object target, @NonNull Object source, @NonNull Finder finder)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; targetClass = target.getClass();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up view binder for "</span> + targetClass.getName());</span><br><span class="line">        ViewBinder&lt;Object&gt; viewBinder = findViewBinderForClass(targetClass);</span><br><span class="line">        viewBinder.bind(finder, target, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to bind views for "</span> + targetClass.getName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>viewBinder.bind(finder, target, source);</code>è°ƒç”¨çš„å°±æ˜¯ç”Ÿæˆç±»ä¸­çš„<code>bind</code>æ–¹æ³•ã€‚æˆ‘ä»¬å–æ–¹æ³•ä¸­çš„ä¸€å°æ®µæ¥çœ‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">View view = (View)finder.findRequiredView(source, <span class="number">2130968576</span>, <span class="string">"field \'title\'"</span>);</span><br><span class="line">target.title = (TextView)finder.castView(view, <span class="number">2130968576</span>, <span class="string">"field \'title\'"</span>);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±é€šè¿‡finderçš„<code>findRequiredView</code>å’Œ<code>castView</code>ä¸¤ä¸ªæ–¹æ³•æ¥ä¸ºtargetçš„titleå±æ€§æ¥èµ‹å€¼äº†ã€‚è¿™é‡Œå…¶å®ç•¥æœ‰å¤šä½™ï¼Œä¸éœ€è¦å†æ·»åŠ <code>(TextView)</code>å¼ºè½¬ï¼Œçœ‹ä¸€ä¸‹<code>castView</code>æ–¹æ³•çš„å®ç°å°±å¥½äº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">castView</span><span class="params">(View view, <span class="keyword">int</span> id, String who)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (T) view;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">   		<span class="keyword">if</span> (who == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">		&#125;</span><br><span class="line">      	String name = getResourceEntryName(view, id);</span><br><span class="line">      	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"View '"</span></span><br><span class="line">          + name</span><br><span class="line">          + <span class="string">"' with ID "</span></span><br><span class="line">          + id</span><br><span class="line">          + <span class="string">" for "</span></span><br><span class="line">          + who</span><br><span class="line">          + <span class="string">" was of the wrong type. See cause for more info."</span>, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå·²ç»ä½¿ç”¨æ³›å‹è¿›è¡Œå¼ºè½¬äº†ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥æ˜ç™½ButterKnifeçš„å®ç°åŸç†äº†:<br><strong>ä¸ºæ³¨è§£ç±»ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ViewBinderç±»ï¼Œè‡ªåŠ¨ç”Ÿæˆ<code>findViewById</code>ç­‰æ¨¡æ¿ä»£ç ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œåå°„å®ä¾‹åŒ–ViewBinderç±»ï¼Œè°ƒç”¨å®ƒçš„<code>bind()</code>æ–¹æ³•å®Œæˆæ³¨è§£â€”â€”è¿™é‡Œåªæœ‰åœ¨ç”ŸæˆViewBinderå¯¹è±¡çš„æ—¶å€™ä½¿ç”¨äº†åå°„ï¼Œå…¶ä½™ä»£ç å‡æ˜¯æ­£å¸¸çš„è°ƒç”¨ã€‚</strong></p>
<p>ä»ç”Ÿæˆçš„ä»£ç é‡Œé¢è¿˜å¯ä»¥çœ‹åˆ°Unbinderè¿™ä¸ªå†…éƒ¨ç±»ï¼šç”Ÿæˆå®ƒæ˜¯å› ä¸ºSimpleActivityé‡Œé¢æœ‰è¿™æ ·çš„ç”¨æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unbinder</span> ButterKnife.Unbinder unbinder;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>unbinder()</code>æ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŠŠæ³¨å…¥çš„å†…å®¹å…¨éƒ¨åˆ é™¤äº†ï¼Œè¿™ä¹Ÿå°±æ˜¯<code>@Unbinder</code>æ³¨è§£çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<p>å¥½äº†ï¼Œåˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬å¤§è‡´èƒ½çŸ¥é“ButterKnifeæ˜¯æ€ä¹ˆç©çš„äº†ï¼Œä½†æ˜¯å…·ä½“å¦‚ä½•ç”Ÿæˆç±»è¿™ä¸€å—è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚<strong>ä¸‹ä¸€èŠ‚æˆ‘ä»¬æ¥é‡ç‚¹åˆ†æï¼šButterKnifeæ˜¯å¦‚ä½•ç”Ÿæˆä¸€ä¸ªç±»çš„ã€‚</strong></p>
<h1 id="ç”Ÿæˆç±»"><a href="#ç”Ÿæˆç±»" class="headerlink" title="ç”Ÿæˆç±»"></a>ç”Ÿæˆç±»</h1><p>è®²è§£è¿™ä¸ªéœ€è¦æˆ‘ä»¬åŸºäºå‰é¢çš„åˆ†æï¼Œåœ¨<code>findAndParseTargets</code>æ–¹æ³•ä¸­ï¼Œæœ‰å¾ˆå¤šçš„<code>parseXXX</code>æ–¹æ³•è°ƒç”¨ã€‚æ ¹æ®å‰é¢çš„åˆ†æï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šä¸€ä¸ªæ³¨è§£ç±»XXXä¼šå¯¹åº”ç”Ÿæˆ<code>XXX$$ViewBinder</code>ç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆç¡®å®šï¼šButterKnifeå¦‚ä½•ç¡®å®šéœ€è¦ç”Ÿæˆå“ªäº›ç±»ï¼Œå±æ€§åˆæ˜¯å¦‚ä½•è§„æ•´åˆ°è¿™äº›ç±»é‡Œé¢å»çš„ï¼Ÿå³ï¼šæ€ä¹ˆçŸ¥é“ç”Ÿæˆä¸€ä¸ªç±»çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p>
<h2 id="è§£æè¿‡ç¨‹"><a href="#è§£æè¿‡ç¨‹" class="headerlink" title="è§£æè¿‡ç¨‹"></a>è§£æè¿‡ç¨‹</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª<code>parseResourceInt</code>æ–¹æ³•ï¼Œè¿™æ˜¯å¤„ç†æ‰€æœ‰çš„Intèµ„æºçš„ç±»:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseResourceInt</span><span class="params">(Element element, Map&lt;TypeElement, BindingClass&gt; targetClassMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  Set&lt;String&gt; erasedTargetNames)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> hasError = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// A</span></span><br><span class="line">	TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Verify that the target type is int.</span></span><br><span class="line">	<span class="keyword">if</span> (element.asType().getKind() != TypeKind.INT) &#123;</span><br><span class="line">		error(element, <span class="string">"@%s field type must be 'int'. (%s.%s)"</span>, BindInt.class.getSimpleName(),</span><br><span class="line">		enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">		hasError = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Verify common generated code restrictions.</span></span><br><span class="line">	hasError |= isInaccessibleViaGeneratedCode(BindInt.class, <span class="string">"fields"</span>, element);</span><br><span class="line">	hasError |= isBindingInWrongPackage(BindInt.class, element);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Assemble information on the field.</span></span><br><span class="line">	String name = element.getSimpleName().toString();</span><br><span class="line">	<span class="keyword">int</span> id = element.getAnnotation(BindInt.class).value();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// B</span></span><br><span class="line">	BindingClass bindingClass = getOrCreateTargetClass(targetClassMap, enclosingElement);</span><br><span class="line">	FieldResourceBinding binding = <span class="keyword">new</span> FieldResourceBinding(id, name, <span class="string">"getInteger"</span>, <span class="keyword">false</span>);</span><br><span class="line">	bindingClass.addResource(binding);</span><br><span class="line"></span><br><span class="line">	erasedTargetNames.add(enclosingElement.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹Aå¤„ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ª<code>getEnclosingElement()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¹²å•¥çš„å‘¢ï¼Ÿå®˜ç½‘æ–‡æ¡£è§£é‡Šå¦‚ä¸‹:</p>
<blockquote>
<p>è¿”å›æ­¤å…ƒç´ ç›´æ¥å°è£…ï¼ˆéä¸¥æ ¼æ„ä¹‰ä¸Šï¼‰çš„å…ƒç´ ã€‚ ç±»æˆ–æ¥å£è¢«è®¤ä¸ºç”¨äºå°è£…å®ƒç›´æ¥å£°æ˜çš„å­—æ®µã€æ–¹æ³•ã€æ„é€ æ–¹æ³•å’Œæˆå‘˜ç±»å‹ã€‚è¿™åŒ…æ‹¬æ‰€æœ‰ï¼ˆéšå¼ï¼‰é»˜è®¤æ„é€ æ–¹æ³•å’Œæšä¸¾ç±»å‹çš„éšå¼ values å’Œ valueOf æ–¹æ³•ã€‚ åŒ…å°è£…ä½äºå…¶ä¸­çš„é¡¶å±‚ç±»å’Œæ¥å£ï¼Œä½†ä¸è®¤ä¸ºå®ƒå°è£…äº†å­åŒ…ã€‚ å½“å‰ä¸è®¤ä¸ºå…¶ä»–ç§ç±»çš„å…ƒç´ å°è£…äº†ä»»ä½•å…ƒç´ ï¼›ä½†æ˜¯ï¼Œéšç€æ­¤ API æˆ–ç¼–ç¨‹è¯­è¨€çš„å‘å±•ï¼Œè¿™ç§æƒ…å†µå¯èƒ½å‘ç”Ÿæ”¹å˜ã€‚</p>
</blockquote>
<p>ä»ButterKnifeçš„æ³¨è§£å®šä¹‰æ¥çœ‹ï¼Œæ³¨è§£ä½¿ç”¨åœ¨æ–¹æ³•æˆ–è€…å±æ€§ä¸Šé¢ï¼Œé‚£ä¹ˆé€šè¿‡è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è·å–åˆ°å°è£…è¿™äº›å…ƒç´ çš„ç±»ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹Bå¤„ï¼Œå…ˆçœ‹ä¸€ä¸‹<code>getOrCreateTargetClass</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BINDING_CLASS_SUFFIX = <span class="string">"$$ViewBinder"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> BindingClass <span class="title">getOrCreateTargetClass</span><span class="params">(Map&lt;TypeElement, BindingClass&gt; targetClassMap, TypeElement enclosingElement)</span> </span>&#123;</span><br><span class="line">	BindingClass bindingClass = targetClassMap.get(enclosingElement);</span><br><span class="line">	<span class="keyword">if</span> (bindingClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">		String targetType = enclosingElement.getQualifiedName().toString();</span><br><span class="line">		String classPackage = getPackageName(enclosingElement);</span><br><span class="line">		String className = getClassName(enclosingElement, classPackage) + BINDING_CLASS_SUFFIX;</span><br><span class="line"></span><br><span class="line">		bindingClass = <span class="keyword">new</span> BindingClass(classPackage, className, targetType);</span><br><span class="line">		targetClassMap.put(enclosingElement, bindingClass);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bindingClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆæ¸…æ¥šï¼šè¿™é‡Œä¼šå¾€targetClassMapé‡Œé¢å­˜å‚¨ä¸€ä¸ªEntryï¼ŒKeyä¸ºenclosingElementï¼ˆå³å¤–éƒ¨ç±»ï¼‰ï¼ŒValueä¸ºBindingClassã€‚BindingClassåˆå§‹åŒ–è®°å½•äº†ä¸‰æ ·ä¸œè¥¿: åŸå…ˆçš„æ³¨è§£ç±»ç±»åã€åŸå…ˆçš„æ³¨è§£ç±»æ‰€åœ¨åŒ…åå’Œè¦ç”Ÿæˆçš„æ³¨è§£ç±»ç±»åï¼ˆ<code>XXX$$ViewBinder</code>ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­çœ‹Bå¤„ï¼Œåœ¨è·å–åˆ°è¿™ä¸ªBindingClassä¹‹åï¼Œå°±æ‰§è¡Œå¦‚ä¸‹ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FieldResourceBinding binding = <span class="keyword">new</span> FieldResourceBinding(id, name, <span class="string">"getInteger"</span>, <span class="keyword">false</span>);</span><br><span class="line">bindingClass.addResource(binding);</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä»£ç ç”Ÿæˆä¸€ä¸ªFieldResourceBindingå¯¹è±¡ç„¶åæ·»åŠ åˆ°BindingClassä¸­ã€‚</p>
<p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªè§£æè¿‡ç¨‹: <strong>éå†æ‰€æœ‰çš„æ³¨è§£å…ƒç´ ï¼Œå¹¶é€šè¿‡<code>getEnclosingElement()</code>è·å–å£°æ˜è¿™äº›å…ƒç´ çš„ç±»ï¼Œæ‰€æœ‰éœ€è¦åˆ›å»ºçš„ç±»ä¿¡æ¯éƒ½ç»´æŠ¤åœ¨<code>targetClassMap</code>Mapæ•°æ®ç»“æ„ä¸­ï¼ŒKeyä¸ºæ³¨è§£ä½¿ç”¨ç±»ï¼ŒValueä¸ºBindingClassâ€”â€”åç»­å°†æ ¹æ®è¿™ä¸ªBindingClassç”Ÿæˆä»£ç ã€‚æ‰€æœ‰çš„æ³¨è§£å…ƒç´ éƒ½å°†ç»è¿‡è§£æå­˜å‚¨åˆ°BindingClassä¸­ï¼ˆç±»ä¼¼FieldResourceBindingè¿™æ ·çš„å±æ€§ï¼‰ï¼Œæœ€ç»ˆè§£æå®Œæˆï¼Œæ‰€æœ‰éœ€è¦ç”Ÿæˆçš„ç±»éƒ½å¯ä»¥é€šè¿‡<code>targetClassMap</code>ç´¢å¼•åˆ°</strong>ã€‚</p>
<h2 id="å†™å…¥è¿‡ç¨‹"><a href="#å†™å…¥è¿‡ç¨‹" class="headerlink" title="å†™å…¥è¿‡ç¨‹"></a>å†™å…¥è¿‡ç¨‹</h2><p>å†™å…¥è¿‡ç¨‹æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</span><br><span class="line">	TypeElement typeElement = entry.getKey();</span><br><span class="line">	BindingClass bindingClass = entry.getValue();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		bindingClass.brewJava().writeTo(filer);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		error(typeElement, <span class="string">"Unable to write view binder for type %s: %s"</span>, typeElement, e.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±æ˜¯éå†æ‰€æœ‰çš„BindingClassï¼Œè°ƒç”¨<code>brewJava()</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ¶‰åŠåˆ°çš„çŸ¥è¯†ä»¥åŠåé¢<code>writeTo()</code>æ–¹æ³•å‡æ¥è‡ªäº<a href="https://github.com/square/javapoet" target="_blank" rel="noopener">javapoeté¡¹ç›®</a>ï¼Œè¿™ä¸ªé¡¹ç›®å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ ¹æ®ä¸€äº›ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªJavaç±»ï¼Œæ­¤å¤„ä¸èµ˜è¿°ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ButterKnifeä¸ä½†ä½¿ç”¨æ–¹ä¾¿ï¼Œè€Œä¸”é€šè¿‡ç¼–è¯‘æ—¶æ³¨è§£ï¼Œå‡å°‘äº†åå°„çš„ä½¿ç”¨ï¼Œæé«˜äº†æ³¨è§£è§£æçš„æ•ˆç‡ï¼Œç¡®å®éå¸¸èµã€‚</p>
<p>æœ€åæ¨èä¸€ä¸ªAndroid Studioæ’ä»¶ç”¨äºç”ŸæˆButterKnifeä»£ç ï¼Œåœ°å€å¦‚ä¸‹: <a href="https://github.com/avast/android-butterknife-zelezny" target="_blank" rel="noopener">android-butterknife-zelezny</a>ï¼Œå¯ä»¥ç”¨äºå¿«é€Ÿç”ŸæˆButterKnifeæ³¨è§£ä»£ç ã€‚</p>
<p>é‰´äºæŸäº›é¡¹ç›®ç”±äºæ–¹æ³•æ•°é—®é¢˜æˆ–è€…å…¶ä½™åŸå› æ²¡æœ‰ä½¿ç”¨ButterKnifeï¼Œç¨‹åºå‘˜ä»¬è¢«é€¼è¦å†™<code>findViewById</code>è¿™æ ·çš„ä»£ç ï¼Œè¿˜å¾—å»XMLé‡Œé¢ç¿»æ‰¾idï¼Œæˆ‘åŸºäºä»¥ä¸Šæ’ä»¶ï¼Œæ”¹å†™äº†å¦å¤–ä¸€ä¸ªæ’ä»¶ï¼Œåœ°å€å¦‚ä¸‹ï¼š<a href="https://github.com/BigFootprint/AndroidViewGenerator" target="_blank" rel="noopener">AndroidViewGenerator</a>ï¼Œæ¬¢è¿ä½¿ç”¨ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MVCï¼ŒMVPï¼ŒMVVM]]></title>
      <url>http://www.timebridge.space/2016/03/24/mvc-mvp-mvvm/</url>
      <content type="html"><![CDATA[<p>æœ¬æ¥æƒ³å†™ä¸€ç¯‡ä»MVC -&gt; MVP -&gt; MVVMæ¼”å˜è¿‡ç¨‹çš„æ–‡ç« ï¼Œä»‹ç»ä¸€ä¸‹å„è‡ªçš„ä¸åŒç‚¹å’Œé€‚ç”¨å¸¸åœºæ™¯ã€‚ä½†æ˜¯æŸ¥äº†ä¸€äº›èµ„æ–™ä¹‹åï¼Œè§‰å¾—å¯¹äºMVCå’ŒMVPçš„ç†è§£æ˜¯ä»è€…è§ä»æ™ºè€…è§æ™ºçš„ï¼Œå¾ˆå¤šæ–‡ç« çœ‹ä¸Šå»å™è¿°éƒ½æ˜¯æ¯”è¾ƒé è°±çš„ï¼Œä½†æ˜¯åœ¨ä¸€äº›ç»†èŠ‚ä¸Šæœ‰æ‰€ä¸åŒã€‚æœ¬æ–‡ä¸æ‰“ç®—æ·±ç©¶è¿™äº›ä¸åŒï¼Œè€Œæ˜¯æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„åˆ’åˆ†ã€‚</p>
<p>è¿™é‡Œæ¨èä¸€äº›æ–‡ç« ï¼Œå¯ä»¥å¸®åŠ©ç†è§£è¿™äº›è¿™å‡ ä¸ªæ¨¡å¼:</p>
<ol>
<li><a href="http://www.wildcrest.com/Potel/Portfolio/mvp.pdf" target="_blank" rel="noopener">MVP: Model-View-Presenter<br>he Taligent Programming Model for C++ and Java</a></li>
<li><a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller" target="_blank" rel="noopener">Modelâ€“viewâ€“controller</a></li>
<li><a href="https://medium.com/hacking-and-gonzo/flux-vs-mvc-design-patterns-57b28c0f71b7#.in4m1jpvu" target="_blank" rel="noopener">Flux vs. MVC (Design Patterns)</a></li>
<li><a href="http://www.tutorialspoint.com/design_pattern/mvc_pattern.htm" target="_blank" rel="noopener">Design Patterns - MVC Pattern</a> </li>
<li><a href="http://martinfowler.com/eaaDev/SeparatedPresentation.html" target="_blank" rel="noopener">Separated Presentation</a></li>
<li><a href="http://www.infragistics.com/community/blogs/todd_snyder/archive/2007/10/17/mvc-or-mvp-pattern-whats-the-difference.aspx" target="_blank" rel="noopener">MVC or MVP Pattern â€“ Whats the difference?</a></li>
</ol>
<p><a id="more"></a>å¦‚æœä¸€ä¸ªåº”ç”¨å¾ˆå°ï¼Œé‚£ä¹ˆä»¥ä»€ä¹ˆæ ·å­çš„æ–¹å¼å†™é—®é¢˜éƒ½æ˜¯ä¸å¤§çš„ï¼Œæ¯”å¦‚ä»¥å‰ä¸Šå­¦çš„æ—¶å€™åšçš„è¯¾å ‚ä½œä¸šï¼ŒåŠŸèƒ½ç®€å•ï¼Œä¸éœ€è¦åæœŸç»´æŠ¤ï¼Œä»æ²¡æƒ³è¿‡è®¾è®¡çš„é—®é¢˜ã€‚</p>
<p>å½“åº”ç”¨å¤§äº†ä»¥åï¼ŒåŠŸèƒ½å˜å¾—å¤æ‚èµ·æ¥ï¼šå¯èƒ½éœ€è¦ä¿®æ”¹åŸæœ‰çš„åŠŸèƒ½ï¼Œå¯èƒ½æ–°å¼€å‘çš„åŠŸèƒ½ä¸åŸæœ‰çš„åŠŸèƒ½æœ‰äº¤é›†ï¼Œé‚£ä¸ç®¡æ˜¯å‡ ä¸ªäººå†™ï¼Œæœ‰äº›é—®é¢˜éƒ½éœ€è¦æ³¨æ„èµ·æ¥ã€‚</p>
<blockquote>
<p>ä¸è¦é€å¼ºï¼Œè§‰å¾—ä¸€ä¸ªäººç»´æŠ¤çš„åº”ç”¨å¯ä»¥æŒ‰ç…§è‡ªå·±çš„æ€§å­å†™ï¼Œå†™å¾—å¤šäº†ä¹Ÿæ‰›ä¸ä½ï¼Œæœ‰è¡€æ³ªæ•™è®­çš„ã€‚</p>
</blockquote>
<p>æ¯”å¦‚ä¸è¦é‡å¤ä»£ç ï¼Œä¿æŒç±»æˆ–è€…æ¨¡å—çš„èŒè´£å•ä¸€ï¼Œé«˜å†…èšä½è€¦åˆï¼Œä¸€å¼€å§‹å¯èƒ½ä¸è§‰å¾—æœ‰ä»€ä¹ˆï¼Œä½†æ˜¯ä¸€æ—¦å¤æ‚èµ·æ¥å°±ä¼šå‘ç°æ³¨æ„è¿™äº›ç‚¹æ˜¯å¤šä¹ˆçš„å¯è´µã€‚</p>
<blockquote>
<p>é‡åˆ°è¿‡å› ä¸ºCopyä»£ç å¯¼è‡´å‡ºBugçš„æƒ…å†µï¼Œå› ä¸ºåªè®°å¾—ä¿®æ”¹ä¸€ä¸ªåœ°æ–¹ã€‚ä¹Ÿé‡åˆ°è¿‡å› ä¸ºç±»çš„èŒè´£è¿‡äºåºå¤§ï¼Œå¯¼è‡´ä¿®æ”¹çš„æ—¶å€™å°å¿ƒç¿¼ç¿¼ï¼Œå› ä¸ºè¿å˜é‡åå­—å–èµ·æ¥éƒ½è§‰å¾—è¦é‡å¤äº†ï¼ŒåæœŸç›¸å…³åŠŸèƒ½çš„å¼€å‘éƒ½éœ€è¦å»ä¿®æ”¹è¿™ä¸ªç±»ã€‚</p>
</blockquote>
<p>çœ‹äº†ä¸€äº›èµ„æ–™ï¼Œæ„Ÿè§‰è¿™å‡ ä¸ªæ¨¡å¼éƒ½åœ¨è¯•å›¾è·µè¡Œä»¥ä¸‹ä¸¤ä¸ªåŸåˆ™:</p>
<ol>
<li>ä¿æŒèŒè´£å•ä¸€: ä¸€ä¸ªæ¨¡å—ä¸€ä¸ªç›®çš„ï¼Œè¯¥å¹²å•¥å¹²å•¥ï¼›</li>
<li>åˆ†ç¦»æ˜“å˜å’Œä¸æ˜“å˜çš„éƒ¨åˆ†: ä¸æ˜“å˜åŒ–çš„éƒ¨åˆ†ç›¸å¯¹ç¨³å®šï¼Œç»´æŠ¤èµ·æ¥æ—¢ä¸å®¹æ˜“åˆ†å¿ƒï¼Œä¹Ÿå®¹æ˜“å¤ç”¨ï¼Œå˜åŒ–çš„éƒ¨åˆ†å°†ä»¥æœ€å°çš„ä»£ä»·å˜åŒ–ï¼›</li>
</ol>
<p>å®é™…ä¸ŠMVC/MVPæ¨¡å¼è®¾è®¡è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç›®çš„: æ–¹ä¾¿æµ‹è¯•ã€‚UIæµ‹è¯•æ¯”ä¸šåŠ¡é€»è¾‘æµ‹è¯•è¦éš¾çš„å¤šï¼Œè€Œä¸”ä¸šåŠ¡é€»è¾‘çš„æµ‹è¯•ç›¸å¯¹è€Œè¨€æ›´åŠ é‡è¦ã€‚MVC/MVPå…¶å®å°±æ˜¯å»ºç«‹åœ¨è¿™å‡ ç‚¹åŸºç¡€ä¸Šï¼Œä¸ä¿¡æˆ‘ä»¬ä¸‹é¢æ¥æ…¢æ…¢åˆ†æã€‚</p>
<p>åŸºäºä»¥ä¸Šè¿™äº›ç›®çš„ï¼ŒMVC/MVPé¦–å…ˆè¦åšçš„äº‹æƒ…å°±æ˜¯åˆ†ç¦»å‡ºUIå±‚(å› ä¸ºUIå±‚ä¸ä¸å®¹æ˜“è¿›è¡Œæµ‹è¯•ä¸”æ˜“å˜)ã€‚é‚£ä¹ˆåº”è¯¥æ€ä¹ˆåˆ†ç¦»å‘¢ï¼Ÿ</p>
<p>å…³äºè¿™ä¸€ç‚¹ï¼Œã€æ¨è5ã€‘é‡Œé¢è¯´çš„éå¸¸è¯¦ç»†ï¼Œå¹¶ä¸”ç»™å‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œè¯»è€…å¯ä»¥å»ä»”ç»†æ£æ‘©ä¸€ä¸‹ï¼Œåº”è¯¥å¯ä»¥å¾ˆç›´è§‚çš„æ„Ÿå—åˆ°å¦‚ä½•åšä»¥åŠè¿™æ ·åšçš„å¥½å¤„ã€‚ä½œè€…è¿˜ç»™å‡ºäº†ä¸€ä¸ªåˆ†ç¦»çš„æ ‡å‡†ï¼Œè¿™ä¸ªæ ‡å‡†éå¸¸éå¸¸å¥½ï¼Œè¿™æ ·å¯ä»¥æŠŠViewå¾ˆå½»åº•çš„æ‹‰å‡ºå»:</p>
<p><strong>å‡è®¾æˆ‘è¦ä¸ºè¿™ä¸ªåº”ç”¨é‡å†™ä¸€ä¸ªUIå±‚ï¼Œä½¿ç”¨çš„ä¹Ÿæ˜¯åŒæ ·çš„è®¾è®¡æ–¹å¼ï¼Œé‚£ä¹ˆæ–°çš„UIå±‚å’Œæ—§æœ‰çš„UIå±‚ä¹‹é—´ä¼šæœ‰ç›¸åŒä»£ç ä¹ˆï¼Ÿå¦‚æœæœ‰ï¼Œé‚£ä¹ˆææœ‰å¯èƒ½è¿™æ®µä»£ç åº”è¯¥æ”¾åˆ°ä¸šåŠ¡å±‚å»ã€‚</strong>  </p>
<p>åˆ†å±‚ä¹‹åå°±ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜: ä¸¤å±‚ä¹‹é—´å¦‚ä½•äº¤äº’ã€‚æˆ‘ä»¬éµå¾ªã€æ¨è5ã€‘çš„å«æ³•ï¼ŒæŠŠè¿™ä¸¤å±‚ç§°ä¸ºPresentationå±‚å’ŒDomainå±‚ã€‚äº¤äº’åˆ†ä¸ºä¸¤ä¸ªæ–¹å‘:  </p>
<ol>
<li><strong>Presentationå±‚-&gt;Domainå±‚</strong> Presentationå±‚ä¸»åŠ¨è§¦å»è°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³•å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œå°±åƒã€æ¨è5ã€‘ä¸­çš„ä¾‹å­ï¼Œè¿™æ ·æ²¡å•¥é—®é¢˜ï¼›</li>
<li><strong>Domainå±‚-&gt;Presentationå±‚</strong> è¦Domainå±‚èƒ½ä¸»åŠ¨æ›´æ–°Presentationå±‚ï¼Œæœ‰ä¸¤ä¸ªåŠæ³•ï¼Œç¬¬ä¸€ä¸ªæ˜¯Domainå±‚æŒæœ‰Presentationå±‚çš„å¼•ç”¨ï¼Œç¬¬äºŒä¸ªåŠæ³•æ˜¯Presentationå±‚åœ¨Domainå±‚è®¾ç½®è§‚å¯Ÿè€…ã€‚</li>
</ol>
<p>Presentationå±‚-&gt;Domainå±‚é—®é¢˜ä¸å¤§ï¼Œé—®é¢˜ä¸»è¦å‡ºç°åœ¨Domainå±‚-&gt; Presentationå±‚è¿™ä¸ªæ–¹å‘ä¸Šï¼Œç¬¬ä¸€ç§åŠæ³•è‚¯å®šä¸è¡Œï¼Œè¿™æ ·Domainå±‚ä¾èµ–äºPresentationå±‚ï¼Œè¿˜æ€ä¹ˆå•ç‹¬åšæµ‹è¯•ï¼Ÿç¬¬äºŒä¸ªåŠæ³•æ¯”è¾ƒé è°±ï¼Œè¿™ç§åŠæ³•å’ŒMVPæ¨å´‡çš„På’ŒVä¹‹é—´çš„äº¤äº’ç±»ä¼¼ï¼ŒVå’ŒPä¹‹é—´æ˜¯é€šè¿‡æ¥å£äº¤äº’çš„ï¼ŒVå®ç°è¯¥æ¥å£ï¼ŒPå¼•ç”¨è¯¥æ¥å£(é¢å‘æ¥å£ç¼–ç¨‹)ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¯´è¿™æ ·é è°±å‘¢ï¼Ÿå› ä¸ºè¿™æ ·å°±å¯ä»¥å¾ˆå®¹æ˜“çš„æ’‡å¼€Presentationå±‚è¿›è¡Œå•å…ƒæµ‹è¯•äº†ã€‚é€šè¿‡é€»è¾‘åˆ†ç¦»+é¢å‘æ¥å£ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨æµ‹è¯•çš„æ—¶å€™Mockä¸€ä¸ªâ€œPresentationâ€ï¼Œæ¥å¯¹Presentationå±‚è°ƒç”¨çš„æ‰€æœ‰æ¥å£è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬è®¾æƒ³ä¸€ä¸‹çœŸå®çš„å¼€å‘åœºæ™¯ï¼Œå¦‚æœDomainå±‚å°±è¿™æ ·åšæˆä¸€å—ï¼Œé‚£ä¹ˆéšç€ä¸šåŠ¡çš„å¤æ‚åŒ–ï¼ŒDomainå±‚ä¼šå˜å¾—è¶Šæ¥è¶Šåºå¤§(Presentationå±‚ä¸€èˆ¬ä¸ä¼šï¼Œåé¢ä¼šæåˆ°å¦‚æœå‡ºç°äº†åº”è¯¥æ€ä¹ˆåŠ)ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•ç»´æŠ¤Domainå±‚å‘¢ï¼Ÿæˆ‘ä»¬éµå¾ªç›®æ ‡2å†è¿›è¡Œåˆ†å±‚ã€‚å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼Œå®ƒçš„æ•°æ®åŸºç¡€ç›¸å¯¹ç¨³å®šï¼Œå³æ•°æ®å¯¹è±¡æ¨¡å‹æ¯”è¾ƒç¨³å®šï¼Œå¯ä»¥å•ç‹¬å°†è¿™å—æŠ½å‡ºæ¥æˆä¸€ä¸ªæ¨¡å—ï¼Œç¨³å®šçš„ä¸ºAppæä¾›æ‰€éœ€çš„æ•°æ®æ”¯æŒï¼Œæ¯”å¦‚åŠ è½½ã€ä¿å­˜ç­‰ï¼Œæš‚æ—¶ç§°ä¹‹ä¸ºæ•°æ®å±‚ã€‚Domainå±‚å‰¥ç¦»æ‰æ•°æ®å±‚ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä¸šåŠ¡é€»è¾‘ï¼Œæš‚æ—¶ç§°è¿™ä¸€å±‚ä¸ºä¸šåŠ¡å±‚ã€‚</p>
<blockquote>
<p>åˆ°è¿™é‡Œï¼Œå…¶å®å°±å·²ç»çœ‹åˆ°äº†MVPæ¨¡å‹äº†ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥å°†ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹åˆ°å¦å¤–ä¸€ä¸ªæ¨¡å—ä¸­å»ï¼Œè¿™ä¸ªæ¨¡å—æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼šæ˜“å˜è€Œä¸”å¤æ‚ã€‚è¿™ä¸ªæ¨¡å—å’Œå…¶ä½™ä¸¤ä¸ªæ¨¡å—ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆæˆ‘ä»¬ç‰¢è®°ä¸€ç‚¹ï¼Œåˆ†ç¦»Presentationå±‚æ˜¯ä¸ºäº†æµ‹è¯•å‰©ä½™çš„ä¸šåŠ¡ä»£ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†³ä¸èƒ½å°†Presentationå±‚çš„ä¸œè¥¿ã€æ¦‚å¿µå¼•å…¥åˆ°æ•°æ®å±‚å’Œä¸šåŠ¡å±‚ä¸­å»ã€‚å…¶æ¬¡æ•°æ®å±‚æ˜¯æä¾›è¾ƒåŸå§‹æ•°æ®çš„åœ°æ–¹ï¼Œå®ƒå¿…é¡»ç»è¿‡å¤„ç†æ‰å¯ä»¥ä¸¢ç»™Presentationæ˜¾ç¤ºï¼ŒPresentationå±‚çš„æ“ä½œä¹Ÿéœ€è¦æ˜ å°„æˆä¸€äº›æ–¹æ³•çš„è°ƒç”¨å’Œé€»è¾‘æ“ä½œæ‰èƒ½ä¼ åˆ°æ•°æ®å±‚è¿›è¡Œç›¸å…³çš„ä¿å­˜æ“ä½œï¼Œè€Œè¿™ä¸€å±‚å¤„ç†ã€æ˜ å°„å°±æ˜¯äº¤ç»™ä¸šåŠ¡å±‚æ¥å®ç°çš„ã€‚</p>
<p>å› æ­¤å¯ä»¥çœ‹åˆ°MVPæ¨¡å¼ä¸‹ï¼ŒView(UIå±‚)å’ŒModel(æ•°æ®å±‚)ä¹‹é—´æ˜¯æ²¡æœ‰äº¤äº’çš„ï¼Œä¸€åˆ‡éƒ½æ˜¯é€šè¿‡Presenter(ä¸šåŠ¡å±‚)æ¥ä¸­è½¬çš„ã€‚è¿™æ ·çš„è®¾è®¡ï¼Œå°†æœ€æ˜“å˜çš„éƒ¨åˆ†æ”¾åœ¨ä¸šåŠ¡å±‚ä¸­ï¼Œé€šè¿‡ä¸šåŠ¡å±‚éš”ç¦»Presentationå±‚å’Œæ•°æ®å±‚ï¼Œèƒ½å¤Ÿè¾ƒå¤§é™åº¦çš„ä½¿è¿™ä¸¤ä¸ªéƒ¨åˆ†å˜å¾—çµæ´»ã€‚</p>
<p>è¿™ç§æ¨¡å¼è®¾è®¡ä¹Ÿè§£å†³äº†ä¹‹å‰æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜: å³ä¸€ä¸ªä¸šåŠ¡å±‚æ”¯æŒå¤šä¸ªPresentationå±‚ã€‚MVPé‡Œé¢æ˜¯ä¸»å¼ ä¸€ä¸ªViewå¯¹åº”ä¸€ä¸ªæˆ–è€…å¤šä¸ªPresenterçš„ï¼Œè¿™æ—¶çš„æ—¢å¯ä»¥é‡ç”¨ä¹Ÿå¯ä»¥å¤šæ ·åŒ–ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æŠŠä¸å˜çš„Modelå±‚æŠ½ç¦»å‡ºå»äº†ï¼Œå¦‚æœä¸šåŠ¡å±‚éœ€è¦å˜åŒ–ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯ä¸å¸¦é‡å¤çš„å˜åŒ–ã€‚Presenterå˜æˆäº†ä»…ä»…å¤„ç†ä¸šåŠ¡é€»è¾‘çš„åœ°ç‚¹ï¼Œç²’åº¦ä¸Šä¹Ÿæ›´å¥½æ§åˆ¶ã€‚</p>
<p>ä¸¾ä¸ªğŸŒ°ï¼Œæ¯”å¦‚æˆ‘å†™ä¸€ä¸ªAndroid Activityï¼Œè¿™ä¸ªActivityä¸Šæœ‰å¤šä¸ªFragmentã€‚æˆ‘å¯ä»¥ä¸ºè¿™äº›Fragmenté…ç½®ä¸€ä¸ªç»Ÿä¸€çš„Presenterï¼Œä½†æ˜¯æˆ‘ä¹Ÿå¯ä»¥ä¸ºæ¯ä¸€ä¸ªFragmenté…ç½®ä¸€ä¸ªPresenterã€‚ç”šè‡³å› ä¸ºä¸€ä¸ªFragmentä¸Šæ˜¾ç¤ºçš„å…ƒç´ ä¹‹é—´ç›¸å¯¹ç‹¬ç«‹ï¼Œæ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªå¹¿å‘Šä½ï¼Œè¿™ä¸ªå¹¿å‘Šä½å’Œé¡µé¢çš„å…¶ä½™å…ƒç´ æ¯«æ— å…³ç³»ï¼Œå¹¶ä¸”å¹¿å‘Šä½è¿˜å¯ä»¥åœ¨å…¶ä½™é¡µé¢ä¸Šé‡ç”¨ï¼Œé‚£æˆ‘å°±å¯ä»¥å•ç‹¬ä¸ºè¿™ä¸ªå¹¿å‘Šä½Viewé…ç½®ä¸€ä¸ªPresenterï¼Œè¿™æ ·ä¸€ä¸ªFragmentä¹Ÿå¯ä»¥å¯¹åº”å¤šä¸ªPresenteräº†ã€‚è¿™ç§ç²’åº¦æ§åˆ¶å˜å¾—ç›¸å½“çµæ´»ã€‚å¦‚ä¸‹å›¾ï¼ŒViewå’ŒModelä¹‹é—´å¯ä»¥ä»»æ„æ‹¼æ¥åˆé€‚çš„Presenter:</p>
<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/MVPæ¨¡å¼.png" width="250" alt="MVPæ¨¡å¼"></div>

<p>åº”ç”¨è¯´ç™½äº†å…¶å®å°±æ˜¯é€šè¿‡UIå±•ç¤ºæ•°æ®ï¼Œä¿®æ”¹æ•°æ®çš„å·¥å…·ã€‚ä¸¾ä¸ªä¾‹å­: ä½ ä¸‹ä¸€ä¸ªå¤–å–å•ï¼Œé¦–å…ˆæµè§ˆé™„è¿‘çš„å•†æˆ·ï¼Œè¿™å°±æ˜¯å±•ç¤ºæ•°æ®ï¼Œæœ€åä¸‹å•ï¼Œå…¶å®å°±æ˜¯ä¸ºè¿™ä¸ªè´¦æˆ·åœ¨æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡è®¢å•æ•°æ®ã€‚æ•´ä¸ªåº”ç”¨å°±æ˜¯åœ¨å¹²è¿™ä»¶äº‹ã€‚å› æ­¤æ•°æ®æœ¬èº«æ˜¯ç›¸å¯¹ç¨³å®šçš„ï¼Œè€ŒUIå‘¢ï¼Œå¾ˆçµæ´»æ˜“å˜ï¼ˆæ˜¾ç¤ºå†…å®¹ä¼šå˜åŒ–ï¼Œå½¢å¼ä¹Ÿä¼šå˜åŒ–ï¼Œæ¯”å¦‚ä»¥H5çš„å½¢å¼æ˜¾ç¤ºï¼‰ã€‚è¿™ä¸¤å—éƒ½åº”å½“ç‹¬ç«‹å‡ºå»ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä¸šåŠ¡é€»è¾‘ï¼Œè¿˜æ˜¯ä»¥ä¸‹å¤–å–å•ä¸ºä¾‹ï¼Œåˆ›å»ºè®¢å•å‰ï¼Œå¯èƒ½éœ€è¦æ ¡éªŒé…é€è·ç¦»ï¼Œæ˜¯å¦èƒ½å‚åŠ ç«‹å‡æ´»åŠ¨ï¼Œè¿™äº›ä¸œè¥¿éå¸¸æ˜“å˜ï¼Œç†åº”å•ç‹¬æŠ½ç¦»å‡ºæ¥ã€‚</p>
<p>é€šè¿‡ä»¥ä¸ŠèŒè´£åˆ†é…ï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥å°†åº”ç”¨åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—:</p>
<ol>
<li><strong>Viewå±‚</strong> è´Ÿè´£æ˜¾ç¤ºï¼Œæ²¡æœ‰ä»»ä½•çš„ä¸šåŠ¡é€»è¾‘ï¼›</li>
<li><strong>Modelå±‚</strong> è´Ÿè´£æä¾›æ•°æ®ï¼Œä¹Ÿæ²¡æœ‰å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£ç®€å•çš„æ“ä½œæ•°æ®ï¼›</li>
<li><strong>Presenterå±‚</strong> è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œæ˜¯Viewå’ŒModelçš„ä¸­é—´ä¸­è½¬å±‚ï¼›</li>
</ol>
<p>è¿™ç§åˆ†å±‚åˆ†å—ï¼Œæ˜¯æ»¡è¶³æˆ‘ä»¬çš„ä¸‰ä¸ªç›®æ ‡çš„ã€‚ã€æ¨è6ã€‘é‡Œé¢ä¹ŸæŒ‡å‡ºï¼Œè¿™æ ·çš„åˆ†é…æœ‰åŠ©äºå„ä¸ªæ¨¡å—çš„å•ç‹¬å‘å±•ã€‚æ¯”å¦‚Modelå±‚çš„ORMï¼ŒViewå±‚çš„æ³¨è§£ï¼ŒPresenterå±‚çš„ä¹Ÿæœ‰IOCæ¡†æ¶æ”¯æŒã€‚</p>
<p>ä»¥ä¸Šï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆä¸€ä¸ªAppå¯ä»¥åˆ’åˆ†å‡ºä¸‰ä¸ªå¤§å—çš„åŸå› ã€‚æ¯ä¸€ä¸ªå¤§å—æœ¬èº«ä¹Ÿå¯ä»¥åšå‡ºæ›´ç»†ç²’åº¦çš„åˆ’åˆ†ï¼Œæ¯”å¦‚æ•°æ®å±‚ä¹Ÿå¯ä»¥åˆ’åˆ†å‡ºServiceå±‚ï¼Œè¿™äº›å†…éƒ¨çš„åˆ’åˆ†å¾ˆå¤§ç¨‹åº¦ä¸Šä¹Ÿæ˜¯ä¸ºäº†å®ç°å‰é¢æ‰€è¯´çš„ä¸¤ä¸ªç›®æ ‡ï¼Œä½¿å¾—ä»£ç æ›´å¥½ç»´æŠ¤ã€‚</p>
<blockquote>
<p>ä»¥ä¸Šæ˜¯ç»“åˆæ—¥å¸¸å¼€å‘å’Œè¿™ä¸‰ç§æ¨¡å¼è®¾è®¡çš„ä¸€äº›æ€è€ƒï¼ŒåæœŸæœ‰æ‰€å®è·µå†åšè¡¥å……ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è§‚å½±ã€Šè’é‡çŒäººã€‹]]></title>
      <url>http://www.timebridge.space/2016/03/20/the-revenant/</url>
      <content type="html"><![CDATA[<p>å°æå­çš„å¤§ç‰‡: <a href="https://movie.douban.com/subject/5327268/?source=new_aladdin" target="_blank" rel="noopener">è’é‡çŒäºº</a></p>
<p>è¯´å®è¯ï¼Œçœ‹çš„å¥½ç´¯ï¼Œæƒ…èŠ‚å¥½æ™®é€šï¼Œä¸è¿‡å°ææ¼”å¾—å¾ˆå–åŠ›ã€‚</p>
<p>ä¸€ç›´ä¸æ˜ç™½æ¬§ç¾è¿™ç±»ç”µè§†å‰§æ˜¯æ€ä¹ˆæ‹çš„ï¼Œæˆ–è®¸æˆ‘è¯¥å»çŸ¥ä¹ä¸Šæä¸ªé—®é¢˜ã€‚å°±åƒã€Šæ–¯å·´è¾¾å…‹æ–¯ã€‹å’Œã€Šå†°ä¸ç«ä¹‹æ­Œã€‹ä¸€æ ·ï¼Œè¿™ç±»å‰§æ‹æ‘„çš„ä¸–ç•Œï¼Œå……æ–¥ç€è„æ°´å’Œæ·¤æ³¥ï¼Œç”Ÿæ´»åœ¨é‚£é‡Œçš„äººä»¿ä½›è¿™ä¸ªå¹´ä»£çš„ä¹ä¸ï¼Œå¤„å¤„é€éœ²ç€åŸå§‹ç”Ÿæ´»çš„æ°”æ¯ã€‚ä¸€æ–¹é¢å¥½å¿ƒç–¼æ¼”å‘˜ï¼Œä¸€æ–¹é¢ä¹Ÿæ„Ÿå¹å°±è¿™æ ·çš„åŸå§‹äººï¼Œåœ¨ä»–ä»¬èŒ¹æ¯›é¥®è¡€çš„å¹´ä»£ï¼Œæˆ‘ä»¬å·²ç»è¯—è¯æ­Œèµ‹ã€äº­å°æ¥¼é˜ï¼Œç„¶åŒºåŒºä¸¤ä¸‰ç™¾å¹´å°±ç¿»èº«æˆä¸ºæ–‡æ˜äººï¼Œçœ‹æ¥ä¸å…‰å¤ä»‡ä¹‹å‰‘æŒæ¡åœ¨ä¸Šå¸æ‰‹ä¸­ï¼Œå‘½è¿ä¹‹ç§¤ä¹ŸæŒæ¡åœ¨ä¸Šå¸æ‰‹ä¸­å•Šã€‚<a id="more"></a></p>
<p>è¿™éƒ¨å‰§å°±åƒæ‹æ‘„çš„é‚£ä¸ªä¸–ç•Œä¸€æ ·ï¼Œé™æ‚„æ‚„çš„ï¼Œç›´åˆ°æœ€åé›ªå´©äº†ä¸€ä¸‹ï¼Œå°æè€äº†ç‚¹æ‰‹æ®µå¹²æ‰äº†åè›‹ï¼Œæ²¡æœ‰å®å¤§çš„åœºé¢ï¼Œæ²¡æœ‰ç”·å¥³ä¸»è§’çš„æ¿€æƒ…æˆï¼Œå’Œæˆ‘å°è±¡é‡Œé¢çš„æ¬§ç¾å¤§ç‰‡ç›¸å»ç”šè¿œï¼ˆå°æèº²è¿›ğŸ´è‚šå­çš„æƒ…èŠ‚è¢«æˆ‘çŒœåˆ°äº†ï¼Œéƒ½å¿˜äº†åœ¨å“ªé‡Œçœ‹åˆ°è¿‡ç±»ä¼¼çš„åœºæ™¯äº†ï¼‰ã€‚ä½†æˆ‘å¿…é¡»èµä¸€ä¸‹è¿™éƒ¨ç”µå½±æ‹æ‘„çš„è‡ªç„¶é£å…‰ï¼Œå•Šå•Šå•Šï¼ï¼æˆ‘éƒ½è¦ç§°èµè¿™éƒ¨ç”µå½±ä¸ºå£çº¸ç”µå½±â€”â€”æˆ‘è§‰å¾—å¤ªå¤šå¤ªå¤šçš„ç”»é¢ï¼Œæ‘„å½±å¸ˆéƒ½èŠ±è´¹äº†å·¨å¤§çš„å¿ƒæ€æ‹æ‘„æ„å›¾ï¼Œä»¥è‡³äºè¿™äº›ç”»é¢å……å½“ç”µè„‘æ¡Œé¢ç»°ç»°æœ‰ä½™ï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½æƒ³é™ä¸‹æ¥æ¬£èµä¸€ä¸‹é£å…‰ï¼ˆPSï¼šçœ‹è¿‡Macè‡ªå¸¦å£çº¸çš„äººæ„Ÿè§¦åº”è¯¥æ›´æ·±ï¼‰ã€‚</p>
<p>æœ‰ä¸€ä¸ªå°è±¡æ¯”è¾ƒæ·±åˆ»çš„åœºé¢å°±æ˜¯å°æå’Œç†Šçš„ææ–—ï¼šæˆ‘ç»ˆäºæ˜ç™½ä»€ä¹ˆå«å®Œè™â€¦æ€ªä¸å¾—æœ‰äººè¯´å°æè¢«ç†Šå¼ºäº†ï¼Œé‚£ä¸ªåŠ¨ä½œç¡®å®æœ‰ç‚¹åƒâ€¦å¦å¤–ï¼Œè£…æ­»çœŸçš„ç®¡ç”¨ï¼Ÿ</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ADB ä»‹ç»]]></title>
      <url>http://www.timebridge.space/2016/02/29/Android-adb/</url>
      <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><strong>ADBï¼Œå…¨ç§°Android Debug Bridge</strong>ï¼Œæ˜¯ä¸€ä¸ªé›†æˆäº†ä¸è°ƒè¯•æœºå™¨(çœŸæœº/æ¨¡æ‹Ÿå™¨)é€šä¿¡ä¸°å¯ŒåŠŸèƒ½çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒæ˜¯client-serveræ¨¡å¼çš„ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†:</p>
<ol>
<li><strong>Client</strong> è¿è¡Œåœ¨ä½ çš„å¼€å‘æœºå™¨ä¸Š(ä¾‹å¦‚ç”µè„‘)ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡åœ¨shellä¸­è¿è¡Œadbå‘½ä»¤æ¥è°ƒç”¨clientï¼Œå¦å¤–åƒDDMSè¿™æ ·çš„å·¥å…·ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªadb clientï¼›</li>
<li><strong>Daemon</strong> è¿è¡Œåœ¨çœŸæœºæˆ–è€…æ¨¡æ‹Ÿå™¨ä¸Šï¼Œæ¥å—å¹¶å¤„ç†adbå‘½ä»¤ï¼› </li>
<li><strong>Server</strong> åœ¨ä½ çš„å¼€å‘æœºä¸Šè¿è¡Œçš„åå°è¿›ç¨‹ï¼Œå®ƒè´Ÿè´£ç®¡ç†Clientå’ŒDaemonä¹‹é—´çš„äº¤äº’ï¼›<a id="more"></a>
adbå‘½ä»¤å·¥å…·å¯ä»¥åœ¨ <strong><sdk>/platform-tools</sdk></strong> ä¸‹é¢å¯ä»¥æ‰¾åˆ°ã€‚</li>
</ol>
<p>å½“ä¸€ä¸ªClientå¯åŠ¨çš„æ—¶å€™ï¼ŒClientä¼šæ£€æµ‹æœ‰æ²¡æœ‰adb Serverè¿›ç¨‹åœ¨è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰ï¼Œå®ƒå°±ä¼šå¯åŠ¨ä¸€ä¸ªã€‚å½“Serverå¯åŠ¨èµ·æ¥åï¼Œå®ƒå°±ä¼šç»‘å®šåˆ°æœ¬åœ°æœºå™¨çš„5037ç«¯å£ç›‘å¬ä»adb Clientå‘æ¥çš„å‘½ä»¤ã€‚æ‰€æœ‰çš„adb Clientéƒ½ä½¿ç”¨5037ç«¯å£ä¸Serveré€šä¿¡ã€‚</p>
<p>adb Serverè´Ÿè´£å»ºç«‹ä¸æ‰€æœ‰çš„æ¨¡æ‹Ÿå™¨/çœŸæœºçš„è¿æ¥ã€‚å®ƒä¼šæ‰«ææ‰€æœ‰æ¨¡æ‹Ÿå™¨/çœŸæœºåœ¨[5555, 5585]ä¹‹é—´çš„å¥‡æ•°ç«¯å£å»å¯»æ‰¾adb Daemonï¼Œä¸€æ—¦æ‰¾åˆ°å°±ä¼šè¿æ¥åˆ°è¯¥ç«¯å£ã€‚è¿æ¥å»ºç«‹åï¼Œå°±å¯ä»¥é€šè¿‡adbå‘½ä»¤æ¥æ“ä½œæ¨¡æ‹Ÿå™¨/çœŸæœºã€‚å› ä¸ºServerç»´æŠ¤ç€åˆ°è¿™äº›æ¨¡æ‹Ÿå™¨/çœŸæœºçš„æ‰€æœ‰çš„å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿå¤„ç†æ‰€æœ‰çš„adb Clientçš„å‘½ä»¤ï¼Œå› æ­¤å¼€å‘è€…å¯ä»¥ä»ä»»ä½•ä¸€ä¸ªClientæ§åˆ¶ä»»ä½•ä¸€å°æ¨¡æ‹Ÿå™¨/çœŸæœº(Serverå…¶å®æ˜¯ä¸€ä¸ªæ¶ˆæ¯è½¬å‘ä¸­å¿ƒ)ã€‚</p>
<h2 id="ADBå‘½ä»¤"><a href="#ADBå‘½ä»¤" class="headerlink" title="ADBå‘½ä»¤"></a>ADBå‘½ä»¤</h2><h3 id="åŸºæœ¬æ ¼å¼"><a href="#åŸºæœ¬æ ¼å¼" class="headerlink" title="åŸºæœ¬æ ¼å¼"></a>åŸºæœ¬æ ¼å¼</h3><p>adbå‘½ä»¤çš„æ ¼å¼æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb [-d|-e|-s &lt;serialNumber&gt;] &lt;command&gt;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <strong>[-d|-e|-s <serialnumber>]</serialnumber></strong> æ˜¯ç”¨äºåœ¨å¤šè®¾å¤‡çŠ¶æ€ä¸‹é€‰æ‹©å‘½ä»¤ç›®æ ‡è®¾å¤‡çš„ï¼Œå«ä¹‰åˆ†åˆ«å¦‚ä¸‹:</p>
<blockquote>
<p><code>-d</code> : Direct an adb command to the only attached USB device.<br><code>-e</code> : Direct an adb command to the only running emulator instance.<br><code>-s &lt;serialNumber&gt;</code> : Direct an adb command a specific emulator/device instance, referred to by its adb-assigned serial number (such as â€œemulator-5556â€).</p>
</blockquote>
<h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><p>å³ <code>&lt;command&gt;</code> éƒ¨åˆ†ã€‚</p>
<h4 id="1-devices"><a href="#1-devices" class="headerlink" title="1. devices"></a>1. <code>devices</code></h4><p>Prints a list of all attached emulator/device instances.æ‰“å°æ ¼å¼å¦‚ä¸‹ : [serialNumber] [state]ã€‚stateæœ‰ä¸‰ç§: </p>
<ol>
<li><strong>offline</strong> æœºå™¨æ²¡æœ‰è¿æ¥æˆ–è€…ä¸å“åº”adbå‘½ä»¤</li>
<li><strong>device</strong> æœºå™¨è¿æ¥æ­£å¸¸</li>
<li><strong>no device</strong> æ²¡æœ‰ä»»ä½•æœºå™¨è¿æ¥</li>
</ol>
<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ä»¥æŒ‡å®šä¸€ä¸ªè®¾å¤‡è¿è¡Œå‘½ä»¤ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š<br><code>adb -s [serialNumber] shell wm size</code></p>
<h4 id="2-logcat-option-filter-specs"><a href="#2-logcat-option-filter-specs" class="headerlink" title="2. logcat [option] [filter-specs]"></a>2. <code>logcat [option] [filter-specs]</code></h4><p>Prints log data to the screen.</p>
<h4 id="3-install-lt-path-to-apk-gt"><a href="#3-install-lt-path-to-apk-gt" class="headerlink" title="3. install &lt;path-to-apk&gt;"></a>3. <code>install &lt;path-to-apk&gt;</code></h4><p>Pushes an Android application (specified as a full path to an .apk file) to an emulator/device.</p>
<h4 id="4-pull-lt-remote-gt-lt-local-gt"><a href="#4-pull-lt-remote-gt-lt-local-gt" class="headerlink" title="4. pull &lt;remote&gt; &lt;local&gt;"></a>4. <code>pull &lt;remote&gt; &lt;local&gt;</code></h4><p>Copies a specified file from an emulator/device instance to your development computer.</p>
<h4 id="5-push-lt-local-gt-lt-remote-gt"><a href="#5-push-lt-local-gt-lt-remote-gt" class="headerlink" title="5.push &lt;local&gt; &lt;remote&gt;"></a>5.<code>push &lt;local&gt; &lt;remote&gt;</code></h4><p>Copies a specified file from your development computer to an emulator/device instance.</p>
<h4 id="6-start-server"><a href="#6-start-server" class="headerlink" title="6. start-server"></a>6. <code>start-server</code></h4><p>Checks whether the adb server process is running and starts it, if not.</p>
<h4 id="7-kill-server"><a href="#7-kill-server" class="headerlink" title="7. kill-server"></a>7. <code>kill-server</code></h4><p>Terminates the adb server process.</p>
<h4 id="8-get-serialno"><a href="#8-get-serialno" class="headerlink" title="8. get-serialno"></a>8. <code>get-serialno</code></h4><p>Prints the adb instance serial number string.</p>
<h4 id="9-shell"><a href="#9-shell" class="headerlink" title="9. shell"></a>9. <code>shell</code></h4><p>Starts a remote shell in the target emulator/device instance.</p>
<h4 id="10-adb-shell-dumpsys-activity-top"><a href="#10-adb-shell-dumpsys-activity-top" class="headerlink" title="10. adb shell dumpsys activity top"></a>10. <code>adb shell dumpsys activity top</code></h4><p>æ‰“å°æ ˆé¡¶Activityçš„ä¿¡æ¯ï¼ˆç±»åã€å¸ƒå±€ä¿¡æ¯ï¼‰ã€‚</p>
<blockquote>
<p>PS: è¿™ä¸ªå‘½ä»¤æ˜¯<code>adb shell dumpsys</code>çš„å­é›†ï¼Œ<code>adb shell dumpsys</code>å¯ä»¥dumpæ•´ä¸ªç³»ç»Ÿçš„ä¿¡æ¯ï¼Œæ›¾ç»ç”¨æ¥è¿½è¸ªæ³¨å†Œåˆ°ç³»ç»Ÿçš„å¹¿æ’­ï¼Œéå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯ä¿¡æ¯é‡å¤§çš„æ—¶å€™é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œåé¢åŠ ä¸Šåˆ«çš„å‚æ•°å¯ä»¥æ›´æœ‰é’ˆå¯¹æ€§çš„dumpä¿¡æ¯ã€‚</p>
</blockquote>
<h4 id="11-adb-shell-pm-list-instrumentation"><a href="#11-adb-shell-pm-list-instrumentation" class="headerlink" title="11. adb shell pm list instrumentation"></a>11. <code>adb shell pm list instrumentation</code></h4><p>æ‰“å°æ‰€æœ‰çš„intrumentationåŒ…ã€‚</p>
<h4 id="12-adb-logcat-c"><a href="#12-adb-logcat-c" class="headerlink" title="12. adb logcat -c"></a>12. <code>adb logcat -c</code></h4><p>æ¸…ç©ºæ—¥å¿—ã€‚</p>
<h4 id="13-adb-shell-wm-size"><a href="#13-adb-shell-wm-size" class="headerlink" title="13. adb shell wm size"></a>13. <code>adb shell wm size</code></h4><p>æ‰“å°å±å¹•å°ºå¯¸ã€‚</p>
<h4 id="14-adb-shell-wm-density"><a href="#14-adb-shell-wm-density" class="headerlink" title="14. adb shell wm density"></a>14. <code>adb shell wm density</code></h4><p>æ‰“å°å±å¹•å¯†åº¦ã€‚</p>
<h4 id="15-adb-shell-dumpsys-window-displays"><a href="#15-adb-shell-dumpsys-window-displays" class="headerlink" title="15. adb shell dumpsys window displays"></a>15. <code>adb shell dumpsys window displays</code></h4><p>æ˜¾ç¤ºå±å¹•å‚æ•°ã€‚</p>
<h3 id="æ— çº¿è°ƒè¯•"><a href="#æ— çº¿è°ƒè¯•" class="headerlink" title="æ— çº¿è°ƒè¯•"></a>æ— çº¿è°ƒè¯•</h3><p>Androidè¿˜æ”¯æŒæ— çº¿è°ƒè¯•ï¼Œæ­¥éª¤å¦‚ä¸‹:</p>
<ol>
<li>è¿æ¥åˆ°åŒä¸€ä¸ªWifiä¸Šï¼›</li>
<li>ç”¨USBçº¿è¿æ¥æ‰‹æœºå’Œç”µè„‘ï¼Œå¹¶é€šè¿‡<code>adb tcpip 5555</code>å‘½ä»¤è®¾ç½®è®¾å¤‡åœ¨5555ç«¯å£ä¸Šç›‘å¬TCP/IPè¿æ¥ï¼Œä¹‹åæ‹”å‡ºUSBçº¿ï¼›</li>
<li>æ‰¾åˆ°æ‰‹æœºçš„IPåœ°å€ï¼Œä½¿ç”¨<code>adb connect &lt;device-ip-address&gt;</code>å‘½ä»¤è¿æ¥è®¾å¤‡ï¼›</li>
<li>ä½¿ç”¨<code>adb devices</code>å‘½ä»¤æŸ¥çœ‹è®¾å¤‡æ˜¯å¦è¢«è¿æ¥ï¼›</li>
</ol>
<p>å®˜ç½‘ä¸Šä¹Ÿæœ‰æåˆ°æœ‰å…³é˜²ç«å¢™çš„è®¾ç½®ï¼Œéœ€è¦æ”¯æŒADBæ— çº¿è°ƒè¯•æ‰è¡Œã€‚æˆ‘åœ¨å…¬å¸è¯•äº†ä¸€ä¸‹ï¼Œæ˜¯ä¸è¡Œçš„ã€‚æ–­å¼€æ— çº¿è¿æ¥çš„å‘½ä»¤æ˜¯<code>adb disconnect &lt;device-ip-address&gt;</code>ã€‚</p>
<h3 id="Shellå‘½ä»¤"><a href="#Shellå‘½ä»¤" class="headerlink" title="Shellå‘½ä»¤"></a>Shellå‘½ä»¤</h3><p>ADBæä¾›äº†ä¸€ä¸ªUnix Shellï¼Œä»¥ä¾¿äºå¯ä»¥åœ¨è¿æ¥çš„è®¾å¤‡ä¸Šæ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œç›¸å…³çš„å‘½ä»¤äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨åœ¨è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿä¸‹é¢ï¼Œåœ°å€æ˜¯ <strong>/system/bin/â€¦</strong></p>
<p>æ‰§è¡Œshellå‘½ä»¤æœ‰ä¸¤ç§åŠæ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸è¿›å…¥shellï¼Œè€Œæ˜¯ç›´æ¥è¿è¡Œä¸€ä¸ªshellå‘½ä»¤</span></span><br><span class="line">adb [-d|-e|-s &lt;serialNumber&gt;] shell &lt;shell_command&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿›å…¥shellæ¨¡å¼åå†æ‰§è¡Œ</span></span><br><span class="line">adb [-d|-e|-s &lt;serialNumber&gt;] shell</span><br></pre></td></tr></table></figure>
<h3 id="amå‘½ä»¤"><a href="#amå‘½ä»¤" class="headerlink" title="amå‘½ä»¤"></a>amå‘½ä»¤</h3><p><strong>amï¼Œå³activity manager</strong>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥è§¦å‘ä¸€äº›ç³»ç»Ÿè¡Œä¸ºï¼Œæ¯”å¦‚å¯åŠ¨Activityï¼Œåœæ­¢è¿›ç¨‹ï¼Œå‘é€å¹¿æ’­ï¼Œä¿®æ”¹å±å¹•å±æ€§(åœ¨Nexus5 + 6.0ä¸Šå°è¯•æœ‰å…³å‘½ä»¤ï¼Œå‘ç°æ‰¾ä¸åˆ°)ç­‰ã€‚åœ¨shellé‡Œä½¿ç”¨ <code>am &lt;command&gt;</code> å³å¯ã€‚å¸¸è§æ˜“ç”¨çš„å‘½ä»¤å¦‚ä¸‹:</p>
<h4 id="1-force-stop-lt-PACKAGE-gt"><a href="#1-force-stop-lt-PACKAGE-gt" class="headerlink" title="1. force-stop &lt;PACKAGE&gt;"></a>1. <code>force-stop &lt;PACKAGE&gt;</code></h4><p>Force stop everything associated with <package> (the appâ€™s package name).</package></p>
<h4 id="2-start-options-lt-INTENT-gt"><a href="#2-start-options-lt-INTENT-gt" class="headerlink" title="2. start [options] &lt;INTENT&gt;"></a>2. <code>start [options] &lt;INTENT&gt;</code></h4><p>Start an Activity specified by <a href="https://developer.android.com/intl/zh-cn/tools/help/shell.html#IntentSpec" target="_blank" rel="noopener"><intent></intent></a>.å¯ä»¥æºå¸¦Urlç­‰å‚æ•°æ‰“å¼€ä¸€ä¸ªAcitivityï¼Œç”±æ­¤å¯ä»¥æ”»å‡»åˆ«äººçš„åº”ç”¨ã€‚</p>
<h4 id="3-broadcast-options-lt-INTENT-gt"><a href="#3-broadcast-options-lt-INTENT-gt" class="headerlink" title="3. broadcast [options] &lt;INTENT&gt;"></a>3. <code>broadcast [options] &lt;INTENT&gt;</code></h4><p>Issue a broadcast intent.</p>
<h3 id="pmå‘½ä»¤"><a href="#pmå‘½ä»¤" class="headerlink" title="pmå‘½ä»¤"></a>pmå‘½ä»¤</h3><p><strong>pmï¼Œå³package manager</strong>ã€‚çœ‹ä¸€äº›æ¯”è¾ƒæ˜“ç”¨çš„å‘½ä»¤å§ã€‚</p>
<h4 id="1-adb-shell-pm-clear-lt-PACKAGE-gt"><a href="#1-adb-shell-pm-clear-lt-PACKAGE-gt" class="headerlink" title="1. adb shell pm clear &lt;PACKAGE&gt;"></a>1. <code>adb shell pm clear &lt;PACKAGE&gt;</code></h4><p>Deletes all data associated with a package.</p>
<h4 id="2-adb-shell-pm-list-packages"><a href="#2-adb-shell-pm-list-packages" class="headerlink" title="2. adb shell pm list packages"></a>2. <code>adb shell pm list packages</code></h4><p>åˆ—å‡ºæ‰€æœ‰çš„åº”ç”¨ã€‚</p>
<h4 id="3-enable-disable-lt-PACKAGE-OR-COMPONENT-gt"><a href="#3-enable-disable-lt-PACKAGE-OR-COMPONENT-gt" class="headerlink" title="3. enable|disable &lt;PACKAGE_OR_COMPONENT&gt;"></a>3. <code>enable|disable &lt;PACKAGE_OR_COMPONENT&gt;</code></h4><p>Enable/Disable the given package or component (written as â€œpackage/classâ€).</p>
<h4 id="4-grant-revoke-lt-PACKAGE-NAME-gt-lt-PERMISSION-gt"><a href="#4-grant-revoke-lt-PACKAGE-NAME-gt-lt-PERMISSION-gt" class="headerlink" title="4. grant/revoke &lt;PACKAGE_NAME&gt; &lt;PERMISSION&gt;"></a>4. <code>grant/revoke &lt;PACKAGE_NAME&gt; &lt;PERMISSION&gt;</code></h4><p>Grant/Revoke a permission to an app. On devices running Android 6.0 (API level 23) and higher, may be any permission declared in the app manifest. On devices running Android 5.1 (API level 22) and lower, must be an optional permission defined by the app.(å¯ä»¥æ”¶å›æƒé™ï¼Œæµ‹è¯•çš„æ—¶å€™éå¸¸æœ‰ç”¨)</p>
<p><strong>pm</strong>ä¸‹é¢è¿˜æœ‰å‡ ä¸ªåˆ—ä¸¾è®¾å¤‡æ”¯æŒçš„featureã€libraryã€permissoonç­‰ç‰¹æ€§çš„å‘½ä»¤ï¼Œç›´æ¥æŸ¥é˜…<a href="https://developer.android.com/intl/zh-cn/tools/help/shell.html#IntentSpec" target="_blank" rel="noopener">æ–‡æ¡£</a>å§ï¼Œæœ‰å¾ˆå¤šé€‰é¡¹ã€‚</p>
<h3 id="å…¶ä»–å‘½ä»¤"><a href="#å…¶ä»–å‘½ä»¤" class="headerlink" title="å…¶ä»–å‘½ä»¤"></a>å…¶ä»–å‘½ä»¤</h3><h4 id="1-screencap-lt-filename-gt"><a href="#1-screencap-lt-filename-gt" class="headerlink" title="1. screencap &lt;filename&gt;"></a>1. <code>screencap &lt;filename&gt;</code></h4><p>å…·ä½“æ‰§è¡Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screencap /sdcard/screen.png</span><br></pre></td></tr></table></figure>
<p>ç”¨äºç»™å½“å‰å±å¹•æˆªå›¾ï¼Œéå¸¸æœ‰ç”¨ï¼Œä¸»è¦æ˜¯å¯¼å‡ºå›¾ç‰‡éå¸¸æ–¹ä¾¿ï¼Œä½¿ç”¨pullå³å¯ã€‚</p>
<h4 id="2-screenrecord-options-lt-filename-gt"><a href="#2-screenrecord-options-lt-filename-gt" class="headerlink" title="2. screenrecord [options] &lt;filename&gt;"></a>2. <code>screenrecord [options] &lt;filename&gt;</code></h4><p>å…·ä½“æ‰§è¡Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screenrecord /sdcard/demo.mp4</span><br></pre></td></tr></table></figure>
<p>ç”¨äºå½•åˆ¶æ“ä½œè§†é¢‘ã€‚é»˜è®¤æ˜¯3åˆ†é’Ÿååœæ­¢å½•åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨Ctrl-Cå‘½ä»¤ç»ˆæ­¢å½•åˆ¶ï¼Œæˆ–è€…ä½¿ç”¨<code>--time--limit</code>æ¥è®¾ç½®å½•åˆ¶æ—¶é—´ã€‚å¯¼å‡ºæ–¹æ³•å’Œå›¾ç‰‡ä¸€è‡´ã€‚</p>
<p><br><hr></p>
<h3 id="ä¸€ç¯‡æ•´ç†çš„æ›´åŠ è¯¦ç»†çš„æ–‡ç« ï¼šAwesome-ADBã€‚"><a href="#ä¸€ç¯‡æ•´ç†çš„æ›´åŠ è¯¦ç»†çš„æ–‡ç« ï¼šAwesome-ADBã€‚" class="headerlink" title="ä¸€ç¯‡æ•´ç†çš„æ›´åŠ è¯¦ç»†çš„æ–‡ç« ï¼šAwesome ADBã€‚"></a>ä¸€ç¯‡æ•´ç†çš„æ›´åŠ è¯¦ç»†çš„æ–‡ç« ï¼š<a href="https://github.com/mzlogin/awesome-adb" target="_blank" rel="noopener">Awesome ADB</a>ã€‚</h3>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java åŠ¨æ€ä»£ç†å®ç°]]></title>
      <url>http://www.timebridge.space/2016/02/28/Java-bitset/</url>
      <content type="html"><![CDATA[<h2 id="ä»‹ç»å’Œä½¿ç”¨"><a href="#ä»‹ç»å’Œä½¿ç”¨" class="headerlink" title="ä»‹ç»å’Œä½¿ç”¨"></a>ä»‹ç»å’Œä½¿ç”¨</h2><p>åœ¨Javaä¸­æ˜¯ä¸èƒ½åƒC/C++é‚£æ ·ç›´æ¥ä»¥bitä¸ºå•ä½æ“ä½œæ•°æ®çš„ï¼Œå¿…é¡»æƒ³åŠæ³•æ›¿ä»£: </p>
<ol>
<li>ä½¿ç”¨æ•´æ•°æ•°ç»„æ¥æ¨¡æ‹Ÿbitï¼›</li>
<li>é€šè¿‡å·²æœ‰æ•°æ®ç±»å‹ï¼Œä½¿ç”¨ä½ç§»æ“ä½œæ¥è¾¾åˆ°æ“ä½œbitçš„æ•ˆæœï¼›</li>
</ol>
<p>ç¬¬ä¸€ç§åŠæ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å¾ˆè€—ç©ºé—´ã€‚Javaè‡ªå¸¦çš„å·¥å…·ç±»BitSeté‡‡ç”¨çš„æ˜¯ç¬¬äºŒç§æ–¹æ¡ˆã€‚</p>
<p>BitSeté€‰å–çš„åŸºç¡€ç±»å‹æ˜¯longï¼Œå†…éƒ¨ä¿å­˜äº†ä¸€ä¸ªlongæ•°ç»„ï¼Œé€šè¿‡andç­‰æ“ä½œè®¾ç½®longçš„æŸä¸€ä½çš„å€¼æ¥æ¨¡æ‹Ÿbitæ“ä½œã€‚<a id="more"></a></p>
<p>BitSetçš„ç”¨æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BitSet set = <span class="keyword">new</span> BitSet(<span class="number">1024</span>);</span><br><span class="line">set.set(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè¡¨ç¤ºå»ºç«‹ä¸€ä¸ªå¯ä»¥å®¹çº³1024ä¸ªbitçš„BitSetï¼Œå¹¶å°†ç¬¬2ä½ç½®ä¸º1ã€‚BitSetæœ¬èº«è‡ªå¸¦æ‰©å®¹åŠŸèƒ½ï¼Œå®ç°äº†å¤§é‡çš„ä¸bitä½ç›¸å…³çš„æ“ä½œAPIï¼Œè¯¦è§<a href="https://docs.oracle.com/javase/7/docs/api/java/util/BitSet.html" target="_blank" rel="noopener">Doc</a>ã€‚</p>
<h2 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å†…éƒ¨å®ç°ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹å®ä¾‹åŒ–è¿‡ç¨‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ADDRESS_BITS_PER_WORD = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BitSet</span><span class="params">(<span class="keyword">int</span> nbits)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// nbits can't be negative; size 0 is OK</span></span><br><span class="line">   <span class="keyword">if</span> (nbits &lt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> NegativeArraySizeException(<span class="string">"nbits &lt; 0: "</span> + nbits);</span><br><span class="line"> </span><br><span class="line">   initWords(nbits);</span><br><span class="line">   sizeIsSticky = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWords</span><span class="params">(<span class="keyword">int</span> nbits)</span> </span>&#123;</span><br><span class="line">   words = <span class="keyword">new</span> <span class="keyword">long</span>[wordIndex(nbits-<span class="number">1</span>) + <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">wordIndex</span><span class="params">(<span class="keyword">int</span> bitIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bitIndex &gt;&gt; ADDRESS_BITS_PER_WORD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘æŠŠå®ä¾‹åŒ–æ¶‰åŠåˆ°çš„ç›¸å…³æ–¹æ³•å’Œå˜é‡éƒ½å·²ç»è´´å‡ºæ¥äº†ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒå®é™…ä¸Šå°±æ˜¯é€šè¿‡initWordså®ä¾‹åŒ–äº†ä¸€ä¸ªlongæ•°ç»„ï¼Œè€Œæ•°ç»„çš„å¤§å°æ˜¯é€šè¿‡ç®—å¼<strong>wordIndex(nbits-1) + 1</strong>ç®—å‡ºæ¥çš„ï¼Œè¯¥ç®—å¼å¯ä»¥ä¿è¯è®¡ç®—å‡ºæ¥çš„æ•°ç»„çš„å¤§å°æ­£å¥½å¯ä»¥å®¹çº³nbitsä½æ•°çš„bitå€¼ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è®²ä¸€äº›é‡è¦çš„æ–¹æ³•ã€‚</p>
<h3 id="set-æ–¹æ³•"><a href="#set-æ–¹æ³•" class="headerlink" title="set()æ–¹æ³•"></a><code>set()</code>æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> bitIndex)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (bitIndex &lt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"bitIndex &lt; 0: "</span> + bitIndex);</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">int</span> wordIndex = wordIndex(bitIndex);</span><br><span class="line">   expandTo(wordIndex);</span><br><span class="line"> </span><br><span class="line"> 	<span class="comment">//A</span></span><br><span class="line">   words[wordIndex] |= (<span class="number">1L</span> &lt;&lt; bitIndex); <span class="comment">// Restores invariants</span></span><br><span class="line"> </span><br><span class="line">   checkInvariants();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯è®¾ç½®æŸä¸€ä¸ªbitä¸ºä¸º1ã€‚è¿™é‡Œåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:</p>
<ol>
<li>ç¡®å®šbitä½æ˜ å°„åˆ°æ•°ç»„ä¸­çš„å“ªä¸€ä½ï¼Œå³å“ªä¸€ä¸ªlongå€¼ï¼›</li>
<li>é€šè¿‡expandToæ–¹æ³•(ä¸‹é¢ä¼šæœ‰è¯¦ç»†è§£é‡Š)ä¿è¯longæ•°ç»„çš„é•¿åº¦å¯ä»¥å®¹çº³è¿™ä¸€ä½ï¼›</li>
<li>å°†longçš„è¿™ä¸€ä½ç½®ä¸º1ï¼›</li>
</ol>
<p>å…¶ä¸­Aå¤„çš„è¡¨è¾¾å¼å°±æ˜¯åœ¨è®¾ç½®ä½æ•°ï¼Œjavaä¸­çš„ç§»ä½æ“ä½œä¼šæ¨¡é™¤ä½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œlongç±»å‹çš„ç§»ä½ä¼šæ¨¡é™¤64ã€‚ä¾‹å¦‚å¯¹longç±»å‹çš„å€¼å·¦ç§»65ä½ï¼Œå®é™…æ˜¯å·¦ç§»äº†65%64=1ä½ã€‚æ‰€ä»¥è¿™è¡Œä»£ç å°±ç­‰äºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> transderBits = bitIndex % <span class="number">64</span>;</span><br><span class="line">words[wordsIndex] |= (<span class="number">1L</span> &lt;&lt; transferBits);</span><br></pre></td></tr></table></figure>
<h3 id="clear-æ–¹æ³•"><a href="#clear-æ–¹æ³•" class="headerlink" title="clear()æ–¹æ³•"></a><code>clear()</code>æ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•å’Œset()ç›¸å¯¹ï¼Œå®ƒçš„å®ç°æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">(<span class="keyword">int</span> bitIndex)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (bitIndex &lt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"bitIndex &lt; 0: "</span> + bitIndex);</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">int</span> wordIndex = wordIndex(bitIndex);</span><br><span class="line">   <span class="keyword">if</span> (wordIndex &gt;= wordsInUse)</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">   words[wordIndex] &amp;= ~(<span class="number">1L</span> &lt;&lt; bitIndex);</span><br><span class="line"> </span><br><span class="line">   recalculateWordsInUse();</span><br><span class="line">   checkInvariants();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å’Œset()æ–¹æ³•çš„æ­¥éª¤ç±»ä¼¼ï¼Œåªæœ‰åœ¨è®¾ç½®ä½çš„æ—¶å€™æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸å¤šè§£é‡Šã€‚</p>
<h3 id="expandTo-æ–¹æ³•"><a href="#expandTo-æ–¹æ³•" class="headerlink" title="expandTo()æ–¹æ³•"></a><code>expandTo()</code>æ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥å¯¹BitSetå†…éƒ¨çš„longæ•°ç»„æ‰©å®¹çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The number of words in the logical size of this BitSet.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> wordsInUse = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expandTo</span><span class="params">(<span class="keyword">int</span> wordIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> wordsRequired = wordIndex+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (wordsInUse &lt; wordsRequired) &#123;</span><br><span class="line">        ensureCapacity(wordsRequired);</span><br><span class="line">        wordsInUse = wordsRequired;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>wordsInUseè¡¨ç¤ºé€»è¾‘ä¸Šwordsçš„å¤§å°ï¼Œå½“æˆ‘ä»¬ä¼ è¿›ä¸€ä¸ªwordIndexçš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦åˆ¤æ–­è¿™ä¸ªé€»è¾‘å¤§å°ä¸wordIndexçš„å¤§å°å…³ç³»ï¼Œå¦‚æœå°äºå®ƒï¼Œæˆ‘ä»¬å°±è°ƒç”¨æ–¹æ³•ensureCapacity():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacity</span><span class="params">(<span class="keyword">int</span> wordsRequired)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (words.length &lt; wordsRequired) &#123;</span><br><span class="line">		<span class="comment">// Allocate larger of doubled size or required size</span></span><br><span class="line">		<span class="keyword">int</span> request = Math.max(<span class="number">2</span> * words.length, wordsRequired);</span><br><span class="line">		words = Arrays.copyOf(words, request);</span><br><span class="line">		sizeIsSticky = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆ¤æ–­æ˜¯å¦wordsæ•°ç»„ç¡®å®å°äº†ä¸å¤Ÿç”¨ï¼Œä¸å¤Ÿçš„è¯å°±æ–°å»ºä¸€ä¸ªä¸¤å€å¤§çš„æˆ–è€…å’ŒwordsRequiredä¸€æ ·å¤§çš„æ•°ç»„å¹¶copyåŸæ¥çš„æ•°æ®ã€‚</p>
<h3 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get()æ–¹æ³•"></a><code>get()</code>æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> bitIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bitIndex &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"bitIndex &lt; 0: "</span> + bitIndex);</span><br><span class="line"> </span><br><span class="line">    checkInvariants();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> wordIndex = wordIndex(bitIndex);</span><br><span class="line">    <span class="keyword">return</span> (wordIndex &lt; wordsInUse)</span><br><span class="line">        &amp;&amp; ((words[wordIndex] &amp; (<span class="number">1L</span> &lt;&lt; bitIndex)) != <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰å½“wordIndexæ²¡æœ‰è¶Šç•Œï¼Œå¹¶ä¸”wordIndexä¸Šçš„wordIndexä¸Šçš„bitä¸ä¸º0çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰è¯´è¿™ä¸€ä½æ˜¯true.</p>
<h3 id="size-æ–¹æ³•"><a href="#size-æ–¹æ³•" class="headerlink" title="size()æ–¹æ³•"></a><code>size()</code>æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ADDRESS_BITS_PER_WORD = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> BITS_PER_WORD = <span class="number">1</span> &lt;&lt; ADDRESS_BITS_PER_WORD;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> words.length * BITS_PER_WORD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯å®é™…æ•°ç»„å¯ä»¥å®¹çº³çš„bitä½æ•°ï¼Œå®ƒæ°¸è¿œæ˜¯64çš„å€æ•°ï¼Œè€Œä¸ä¸€å®šæ˜¯æˆ‘ä»¬ä¼ è¿›æ¥å®ä¾‹åŒ–çš„é‚£ä¸ªnbitså¤§å°ï¼Œæ¯”å¦‚ä½ ä¼ å…¥1020ï¼Œè¿™é‡Œè¿”å›çš„åº”è¯¥ä¹Ÿæ˜¯1024ã€‚</p>
<h3 id="length-æ–¹æ³•"><a href="#length-æ–¹æ³•" class="headerlink" title="length()æ–¹æ³•"></a><code>length()</code>æ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•çœ‹ä¸Šå»å’Œsize()å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯å®é™…çš„é€»è¾‘å´ä¸ä¸€æ ·:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the "logical size" of this &lt;code&gt;BitSet&lt;/code&gt;: the index of</span></span><br><span class="line"><span class="comment"> * the highest set bit in the &lt;code&gt;BitSet&lt;/code&gt; plus one. Returns zero</span></span><br><span class="line"><span class="comment"> * if the &lt;code&gt;BitSet&lt;/code&gt; contains no set bits.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  the logical size of this &lt;code&gt;BitSet&lt;/code&gt;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>   1.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">length</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (wordsInUse == <span class="number">0</span>)</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">return</span> BITS_PER_WORD * (wordsInUse - <span class="number">1</span>) +</span><br><span class="line">		(BITS_PER_WORD - Long.numberOfLeadingZeros(words[wordsInUse - <span class="number">1</span>]));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•è™½ç„¶çŸ­å°ï¼Œå´æ¯”è¾ƒéš¾ä»¥ç†è§£ï¼Œç»†ç»†åˆ†æä¸€ä¸‹ï¼šæ ¹æ®æ³¨é‡Šï¼Œè¿™ä¸ªæ–¹æ³•æ³•è¿”å›çš„æ˜¯BitSetçš„é€»è¾‘å¤§å°ï¼Œæ¯”å¦‚è¯´ä½ å£°æ˜äº†ä¸€ä¸ª129ä½çš„BitSet,è®¾ç½®äº†ç¬¬23ï¼Œ45ï¼Œ67ä½ï¼Œé‚£ä¹ˆå…¶é€»è¾‘å¤§å°å°±æ˜¯67ï¼Œä¹Ÿå°±æ˜¯è¯´é€»è¾‘å¤§å°å…¶å®æ˜¯çš„æ˜¯åœ¨ä½ è®¾ç½®çš„æ‰€æœ‰ä½é‡Œé¢æœ€é«˜ä½çš„Indexã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæ–¹æ³•ï¼ŒLong.numberOfLeadingZerosï¼Œç½‘ä¸Šæ²¡æœ‰å¾ˆå¥½çš„è§£é‡Šï¼Œåšå®éªŒå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">long</span> test = <span class="number">1</span>;</span><br><span class="line">System.out.println(Long.numberOfLeadingZeros(test&lt;&lt;<span class="number">3</span>));</span><br><span class="line">System.out.println(Long.numberOfLeadingZeros(test&lt;&lt;<span class="number">40</span>));</span><br><span class="line">System.out.println(Long.numberOfLeadingZeros(test&lt;&lt;<span class="number">40</span> | test&lt;&lt;<span class="number">4</span>));</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">60</span></span><br><span class="line"><span class="number">23</span></span><br><span class="line"><span class="number">23</span></span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¾“å‡ºä¸€ä¸ª64ä½äºŒè¿›åˆ¶å­—ç¬¦ä¸²å‰é¢0çš„ä¸ªæ•°çš„ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>BitSeté€šè¿‡æ“ä½œlongæ•°ç»„æ¥æ¨¡æ‹Ÿbitæ“ä½œï¼Œè™½ç„¶å¯èƒ½å¹¶æ²¡æœ‰ç›´æ¥æ“ä½œbitæ•°ç»„é‚£ä¹ˆå¿«é€Ÿ(æ¯•ç«Ÿè¦åšä¸€äº›è®¡ç®—)ï¼Œä½†å·²ç»æ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„æ–¹æ¡ˆäº†ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android çš„é”®ç›˜æ”¶èµ·å±•å¼€]]></title>
      <url>http://www.timebridge.space/2016/02/28/Android-keyboard-show-and-hide/</url>
      <content type="html"><![CDATA[<h2 id="ä»‹ç»å’Œä½¿ç”¨"><a href="#ä»‹ç»å’Œä½¿ç”¨" class="headerlink" title="ä»‹ç»å’Œä½¿ç”¨"></a>ä»‹ç»å’Œä½¿ç”¨</h2><p>é”®ç›˜çš„å±•å¼€å’Œæ”¶èµ·ä¸»è¦ä½¿ç”¨åˆ°ç±» <a href="http://developer.android.com/reference/android/view/inputmethod/InputMethodManager.html" target="_blank" rel="noopener">InputMethodManager</a> ã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//éšè—é”®ç›˜</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideKeyboard</span><span class="params">(Context context, View view)</span> </span>&#123;</span><br><span class="line">        InputMethodManager inputMethodManager = (InputMethodManager) context.getSystemService(Activity.INPUT_METHOD_SERVICE);</span><br><span class="line">        inputMethodManager.hideSoftInputFromWindow(view.getWindowToken(), InputMethodManager.HIDE_NOT_ALWAYS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ˜¾ç¤ºé”®ç›˜</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showKeyboard</span><span class="params">(Context context, View view)</span> </span>&#123;</span><br><span class="line">        InputMethodManager inputMethodManager = (InputMethodManager) context.getSystemService(Activity.INPUT_METHOD_SERVICE);</span><br><span class="line">        inputMethodManager.showSoftInput(view, InputMethodManager.SHOW_IMPLICIT);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="å‚æ•°é—®é¢˜"><a href="#å‚æ•°é—®é¢˜" class="headerlink" title="å‚æ•°é—®é¢˜"></a>å‚æ•°é—®é¢˜</h2><p>åœ¨è°ƒç”¨hideSoftInputFromWindow()å’ŒshowSoftInput()æ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½è¦æ±‚ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°åœ¨å®˜ç½‘ä¸Šçš„è§£é‡Šå¹¶ä¸æ¸…æ¥šï¼Œæ¯”å¦‚hideSoftInputFromWindow()æ–¹æ³•ä¸Šå…³äºè¿™ä¸ªå‚æ•°çš„è§£é‡Šå¦‚ä¸‹:</p>
<blockquote>
<p>int: Provides additional operating flags. Currently may be 0 or have the HIDE_IMPLICIT_ONLY bit set.</p>
</blockquote>
<p>ä»å®˜ç½‘ä¸Šçœ‹ï¼Œè¿™ä¸ªå‚æ•°æ€»å…±æœ‰ä»¥ä¸‹å››ä¸ªå¸¸é‡ï¼ŒåŠ ä¸Š0:</p>
<p>åœ¨å±•å¼€å’Œæ”¶èµ·æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œéƒ½è¦æ±‚ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ã€‚å¤§è‡´æœ‰ä»¥ä¸‹å››ç§ï¼š</p>
<ol>
<li>HIDE_IMPLICIT_ONLYï¼šindicate that the soft input window should only be hidden if it was not explicitly shown by the user.</li>
<li>HIDE_NOT_ALWAYSï¼što indicate that the soft input window should normally be hidden, unless it was originally shown with SHOW_FORCED</li>
<li>SHOW_FORCEDï¼šindicate that the user has forced the input method open (such as by long-pressing menu) so it should not be closed until they explicitly do so.</li>
<li>SHOW_IMPLICITï¼šindicate that this is an implicit request to show the input window, not as the result of a direct request by the user.</li>
</ol>
<p>1å’Œ2æ˜¯ç”¨äºæ”¶èµ·é”®ç›˜çš„ï¼Œ3å’Œ4æ˜¯ç”¨äºå±•å¼€é”®ç›˜çš„ã€‚</p>
<h3 id="å®éªŒç»“æœ"><a href="#å®éªŒç»“æœ" class="headerlink" title="å®éªŒç»“æœ"></a>å®éªŒç»“æœ</h3><ol>
<li>å¦‚æœç”¨æˆ·æ˜¯ç‚¹å‡»è¾“å…¥æ¡†å¼¹å‡ºçš„é”®ç›˜ï¼Œåˆ™è°ƒç”¨1ï¼‰æ˜¯æ— æ³•éšè—çš„ï¼Œç³»ç»Ÿæ­¤æ—¶åˆ¤æ–­ä½¿ç”¨æˆ·æœ‰æ„å‘¼å”¤é”®ç›˜çš„ï¼è°ƒç”¨2ï¼‰åˆ™å¯ä»¥æ”¶èµ·é”®ç›˜ï¼›</li>
<li>å¦‚æœç”¨æˆ·æ˜¯ä½¿ç”¨3ï¼‰ä½œä¸ºå‚æ•°æ˜¾ç¤ºé”®ç›˜çš„ï¼Œåˆ™1ï¼‰å’Œ2ï¼‰éƒ½æ˜¯æ— æ³•éšè—é”®ç›˜çš„ï¼Œæ­¤æ—¶éœ€è¦ç”¨å‚æ•°0ï¼Œå¼ºåˆ¶éšè—ä¸€åˆ‡é”®ç›˜ï¼›</li>
<li>å¦‚æœç”¨æˆ·æ˜¯ä½¿ç”¨4ï¼‰ä½œä¸ºå‚æ•°æ˜¾ç¤ºé”®ç›˜çš„ï¼Œåˆ™1ï¼‰å’Œ2ï¼‰éƒ½æ˜¯å¯ä»¥éšè—é”®ç›˜çš„ã€‚</li>
</ol>
<p>æ€»ç»“ä¸‹æ¥å°±æ˜¯: <strong>Forced &gt; Explicit &gt; Implicit</strong>ã€‚</p>
<p>å¯¹äºéšè—é”®ç›˜ï¼Œå…¶ä¸­1ï¼‰æ˜¯å±äºimplicitï¼Œ2ï¼‰æ˜¯å±äºexplicitï¼Œ0åˆ™æ˜¯å±äºforceï¼›å¯¹äºæ˜¾ç¤ºé”®ç›˜ï¼Œåˆ™4ï¼‰æ˜¯å±äºimplicitï¼Œè¾“å…¥æ¡†å‘¼å‡ºå±äºexplicitï¼Œ3ï¼‰åˆ™æ˜¯å±äºforceï¼›</p>
<p><strong>åªæœ‰éšè—çš„çº§åˆ«&gt;=å±•å¼€çš„çº§åˆ«ï¼Œæ‰èƒ½å°†é”®ç›˜éšè—æ‰ã€‚</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android çš„ Activity ç”Ÿå‘½å‘¨æœŸ]]></title>
      <url>http://www.timebridge.space/2016/02/28/Android-activity-lifecycle/</url>
      <content type="html"><![CDATA[<h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><p>ã€ç¯å¢ƒã€‘æµ‹è¯•æ‰‹æœºä¸ºNexus 5ï¼Œç³»ç»Ÿä¸º4.4å’Œ6.0ã€‚</p>
<blockquote>
<p>PS: æœ€æ—©æµ‹è¯•æ˜¯åœ¨4.4ä¸‹è¿›è¡Œï¼Œå½“æ—¶ç”¨çš„è¿˜æ˜¯Eclipseï¼Œå› æ­¤æˆªå›¾éƒ½æ˜¯Eclipseä¸‹é¢çš„ã€‚æœ€æ–°åœ¨6.0 + Android Studioä¸‹éªŒè¯ï¼Œç»“æœå®Œå…¨ä¸€è‡´ã€‚<a href="http://www.cnblogs.com/lqminn/p/3856089.html" target="_blank" rel="noopener">åŸæ–‡åœ°å€</a></p>
</blockquote>
<a id="more"></a>
<h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.androidalarm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Configuration;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    Button addButton, cancelButton;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onCreate"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onConfigurationChanged"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onConfigurationChanged(newConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onCreateView"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onCreateView(name, context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onDestroy"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onPause"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onRestart"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onRestart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onRestoreInstanceState"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onRestoreInstanceState(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onResume"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onSaveInstanceState"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onSaveInstanceState(outState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onStart"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"BigFootprint"</span>, <span class="string">"onStop"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>XMLé…ç½®:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"com.example.androidalarm"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionCode</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionName</span>=<span class="string">"1.0"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:minSdkVersion</span>=<span class="string">"8"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:targetSdkVersion</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_launcher"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"com.example.androidalarm.MainActivity"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="æ­£å¸¸æƒ…å†µçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#æ­£å¸¸æƒ…å†µçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="æ­£å¸¸æƒ…å†µçš„ç”Ÿå‘½å‘¨æœŸ"></a>æ­£å¸¸æƒ…å†µçš„ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="å¸¸è§çš„æ‰“å¼€é€€å‡º"><a href="#å¸¸è§çš„æ‰“å¼€é€€å‡º" class="headerlink" title="å¸¸è§çš„æ‰“å¼€é€€å‡º"></a>å¸¸è§çš„æ‰“å¼€é€€å‡º</h3><p>è¿è¡Œé¡¹ç›®ï¼Œå½“é¡¹ç›®å¯åŠ¨ï¼ŒMainActivityæ˜¾ç¤ºå‡ºæ¥çš„æ—¶å€™ï¼ŒConsoleçš„æ‰“å°å¦‚ä¸‹:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-å¯åŠ¨.jpg" alt="æ²¡æœ‰é…ç½®-å¯åŠ¨"><br>å‡ ä¸ªä¸»æµçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å’Œæ–‡æ¡£æè¿°çš„ä¸€æ ·ï¼Œä½†æ˜¯onCreatView()æ–¹æ³•åˆ™ä¼šå¤šæ¬¡è°ƒç”¨(ä»å®éªŒä¸¤æ¬¡æ¥çœ‹ï¼Œæ¬¡æ•°ä¸å›ºå®š)ï¼Œè™½ç„¶è¿™ä¸ªæ–¹æ³•ä¸å¸¸ç”¨ï¼Œä½†æ˜¯ç”¨åˆ°çš„æ—¶å€™è¦æ³¨æ„ã€‚</p>
<p>æ¥ä¸‹å»æˆ‘ä»¬æŒ‰Backé”®é€€å‡º:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-é€€å‡º.jpg" alt="æ²¡æœ‰é…ç½®-é€€å‡º"><br>ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è°ƒç”¨æ­£å¸¸ã€‚</p>
<h3 id="å±å¹•æš—ä¸‹äº®èµ·"><a href="#å±å¹•æš—ä¸‹äº®èµ·" class="headerlink" title="å±å¹•æš—ä¸‹äº®èµ·"></a>å±å¹•æš—ä¸‹äº®èµ·</h3><p>ç„¶åæˆ‘ä»¬æ‰“å¼€Activityï¼Œç­‰ç€å±å¹•è‡ªå·±æš—æ‰ï¼Œè¿™ä¸ªæ—¶å€™çš„Logæ˜¯è¿™æ ·çš„:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-å±å¹•æš—æ‰.jpg" alt="æ²¡æœ‰é…ç½®-å±å¹•æš—æ‰"><br>æ²¡æœ‰è°ƒç”¨onDestroy()æ–¹æ³•ï¼Œä½†æ˜¯åœ¨onPause()å’ŒonStop()ä¹‹é—´è°ƒç”¨äº†onSaveInstanceState()æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬æŒ‰ä¸‹ç”µæºé”®ï¼Œäº®èµ·å±å¹•:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-å±å¹•äº®èµ·.jpg" alt="æ²¡æœ‰é…ç½®-å±å¹•äº®èµ·"><br>æ²¡æœ‰onCreate()æ–¹æ³•(å› ä¸ºActivityæ²¡æœ‰è¢«æ€æ­»)ï¼Œä½†æ˜¯è°ƒç”¨äº†onRestart()æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„æ–¹æ³•ã€‚</p>
<h3 id="Homeé”®é€€å‡º"><a href="#Homeé”®é€€å‡º" class="headerlink" title="Homeé”®é€€å‡º"></a>Homeé”®é€€å‡º</h3><p>æˆ‘ä»¬æŒ‰ä¸‹Homeé”®é€€å‡ºMainActivity:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-Homeé€€å‡º.jpg" alt="æ²¡æœ‰é…ç½®-Homeé€€å‡º"><br>å’Œå±å¹•æš—è°ƒçš„Logå®Œå…¨ä¸€è‡´ã€‚</p>
<p>å†ç‚¹å‡»åº”ç”¨å›¾æ ‡è¿›å…¥:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-Homeè¿›å…¥.jpg" alt="æ²¡æœ‰é…ç½®-Homeè¿›å…¥"></p>
<h2 id="æ¨ªç«–å±åˆ‡æ¢çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#æ¨ªç«–å±åˆ‡æ¢çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="æ¨ªç«–å±åˆ‡æ¢çš„ç”Ÿå‘½å‘¨æœŸ"></a>æ¨ªç«–å±åˆ‡æ¢çš„ç”Ÿå‘½å‘¨æœŸ</h2><p>åœ¨ä»¥ä¸Šä»£ç ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ‰‹æœºåˆ‡æ¢ä¸ºæ¨ªå±(æ³¨:å› ä¸ºonCreateViewè°ƒç”¨æ¬¡æ•°å¤ªå¤šï¼Œè€Œä¸”ä¸æ˜¯é‡ç‚¹ç ”ç©¶å¯¹è±¡ï¼Œåé¢çš„å®éªŒå»é™¤äº†å®ƒçš„Log):</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-ç«–æ¨ª.jpg" alt="æ²¡æœ‰é…ç½®-ç«–æ¨ª"></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒActivityæ˜¯è¢«æ€æ‰åé‡å»ºçš„ï¼Œå¹¶ä¸”è°ƒç”¨äº†onSaveInstanceState()å’ŒonRestoreInstanceState()ä¸¤ä¸ªæ–¹æ³•åšäº†æ•°æ®æ¢å¤å’Œä¿å­˜ã€‚</p>
<p>å°†å±å¹•ä»æ¨ªå±åˆ‡æ¢ä¸ºç«–å±ï¼ŒLogå¦‚ä¸‹:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ²¡æœ‰é…ç½®-æ¨ªç«–.jpg" alt="æ²¡æœ‰é…ç½®-æ¨ªç«–"><br>å’Œåˆ‡æ¢ä¸ºæ¨ªå±æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸ºActivityçš„XMLå£°æ˜æ·»åŠ å¦‚ä¸‹é…ç½®:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:configChanges="orientation"</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥ä¸€æ¬¡ç«–å± -&gt; æ¨ªå± â€”&gt; ç«–å±çš„åˆ‡æ¢ï¼Œå…¶Logå¦‚ä¸‹:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/é…ç½®orientation-åˆ‡æ¢.jpg" alt="é…ç½®orientation-åˆ‡æ¢"></p>
<p>å’Œæ²¡æœ‰é…ç½®æ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬å°†é…ç½®æ”¹ä¸º:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:configChanges="orientation|keyboardHidden"</span><br></pre></td></tr></table></figure>
<p>æ‰“å°çš„Logæ²¡æœ‰å˜åŒ–ã€‚å†å°†é…ç½®æ”¹ä¸º:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:configChanges="orientation|screenSize"</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™åˆ‡æ¢æ‰“å°çš„Logå°±å¦‚ä¸‹:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/é…ç½®orientation|screenSize-åˆ‡æ¢.jpg" alt="é…ç½®orientation|screenSize-åˆ‡æ¢"></p>
<p>è¿™æ ·çš„é…ç½®ï¼Œåœ¨æ¨ªç«–å±åˆ‡æ¢çš„æ—¶å€™å°±åªä¼šè°ƒç”¨onConfigurationChanged()æ–¹æ³•ï¼Œè€Œä¸ä¼šå¼•èµ·Activityé‡å»ºã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»ä»¥ä¸Šå®éªŒä¸­å¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºã€‚</p>
<h3 id="Androidä»€ä¹ˆæ—¶å€™è®¤ä¸ºActivityå¯èƒ½ä¼šè¢«æ„å¤–å…³é—­"><a href="#Androidä»€ä¹ˆæ—¶å€™è®¤ä¸ºActivityå¯èƒ½ä¼šè¢«æ„å¤–å…³é—­" class="headerlink" title="Androidä»€ä¹ˆæ—¶å€™è®¤ä¸ºActivityå¯èƒ½ä¼šè¢«æ„å¤–å…³é—­?"></a>Androidä»€ä¹ˆæ—¶å€™è®¤ä¸ºActivityå¯èƒ½ä¼šè¢«æ„å¤–å…³é—­?</h3><p>è¿™ä¸ªæ˜¯ä»¥onSaveInstanceStateæ–¹æ³•è¢«è°ƒç”¨ä½œä¸ºæ ‡å¿—çš„ï¼Œå¾ˆæ˜æ˜¾æœ‰ä¸‰ç§æƒ…å†µ:</p>
<ol>
<li>å±å¹•æš—ä¸‹å»ï¼›</li>
<li>æŒ‰ä¸‹Homeé”®é€€å‡ºActivityï¼›</li>
<li>æ¨ªç«–å±åˆ‡æ¢ï¼›</li>
</ol>
<p>å› ä¸ºå®éªŒçš„é—®é¢˜ï¼Œè¿™é‡Œç»™å‡ºçš„ä¸‰ä¸ªæƒ…æ™¯å¹¶ä¸å®Œæ•´ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æƒ…æ™¯ï¼šå½“å‰Activityå¯åŠ¨åˆ«çš„Activityçš„æ—¶å€™ã€‚å®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹: ç”¨æˆ·ç¦»å¼€äº†è¿™ä¸ªActivityï¼Œä½†æ²¡æœ‰ä¸»åŠ¨å…³é—­å®ƒã€‚Androidç³»ç»Ÿè¿™ä¸ªæ—¶å€™åˆ¤å®šè¿™ä¸ªActivityæœ‰æ„å¤–è¢«å…³é—­çš„å¯èƒ½æ€§ï¼Œå› æ­¤éœ€è¦ä¿å­˜æ•°æ®ã€‚</p>
<h3 id="onConfigurationChanged-æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨"><a href="#onConfigurationChanged-æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨" class="headerlink" title="onConfigurationChanged()æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨?"></a>onConfigurationChanged()æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨?</h3><p>è¿™ä¸ªæ–¹æ³•å’ŒActivityçš„<strong>android:configChanges</strong>é…ç½®æ¯æ¯ç›¸å…³ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å®˜ç½‘çš„è§£é‡Šã€‚</p>
<p>å…³äºonConfigurationChanged()æ–¹æ³•ï¼Œå…¶ <a href="http://developer.android.com/intl/zh-cn/reference/android/app/Activity.html#onConfigurationChanged(android.content.res.Configuration" target="_blank" rel="noopener">æ³¨é‡Š</a> æ˜¯è¿™æ ·çš„:</p>
<blockquote>
<p>Called by the system when the device configuration changes while your activity is running. Note that this will only be called if you have selected configurations you would like to handle with the configChanges attribute in your manifest. If any configuration change occurs that is not selected to be reported by that attribute, then instead of reporting it the system will stop and restart the activity (to have it launched with the new configuration).<br>At the time that this function has been called, your Resources object will have been updated to return resource values matching the new configuration.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼šè¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨ä½ çš„åº”ç”¨ç¨‹åºè¿è¡Œä¸”é…ç½®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„é…ç½®å˜åŒ–éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¿…é¡»é€šè¿‡<strong>configChanges</strong>å±æ€§è¿›è¡Œé…ç½®ï¼Œå¦‚æœä¸€ä¸ªé…ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†ä½ æ²¡æœ‰åœ¨<strong>configChanges</strong>å±æ€§ä¸­è¿›è¡Œé…ç½®ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šé‡æ–°åˆ›å»ºè¿™ä¸ªActivityã€‚åœ¨è¿™ä¸ªæ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œè¯¥é…ç½®å¯¹åº”çš„èµ„æºæ–‡ä»¶å·²ç»è¢«æ›´æ–°ã€‚</p>
<p>å…³äº<strong>android:configChanges</strong>çš„ <a href="http://developer.android.com/intl/zh-cn/guide/topics/manifest/activity-element.html#config" target="_blank" rel="noopener">è§£é‡Š</a> æ˜¯è¿™çš„:</p>
<blockquote>
<p>Lists configuration changes that the activity will handle itself. When a configuration change occurs at runtime, the activity is shut down and restarted by default, but declaring a configuration with this attribute will prevent the activity from being restarted. Instead, the activity remains running and its onConfigurationChanged() method is called.</p>
</blockquote>
<p>ç¿»è¯‘ä¸€ä¸‹: åˆ—ä¸¾äº†Activtyè‡ªå·±ä¼šå¤„ç†çš„é…ç½®å˜åŒ–é€‰é¡¹ã€‚å½“ç¨‹åºè¿è¡Œä¸”ä¸€ä¸ªé…ç½®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼ŒActivityé»˜è®¤æ˜¯é‡æ–°åˆ›å»ºçš„ï¼Œä½†æ˜¯å¦‚æœåœ¨è¿™é‡Œå£°æ˜äº†è¿™ä¸ªé…ç½®ï¼ŒActivityå°±ä¸ä¼šè¢«é‡æ–°åˆ›å»ºï¼Œè€Œæ˜¯è°ƒç”¨å®ƒçš„onConfigurationChanged()æ–¹æ³•ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æœ€å¸¸å…³æ³¨çš„é…ç½®å˜åŒ–å°±æ˜¯<strong>orientation</strong>ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘ä»¬å•ç‹¬é…ç½®<strong>android:configChanges=â€orientationâ€</strong>æ²¡æœ‰è¾¾åˆ°é¢„æœŸæ•ˆæœå‘¢ï¼Ÿå®˜ç½‘ä¸Šå…³äºè¿™ä¸ªé…ç½®æœ‰è§£é‡Š:</p>
<blockquote>
<p>The screen orientation has changed â€” the user has rotated the device.</p>
<blockquote>
<p>Note: If your application targets API level 13 or higher (as declared by the minSdkVersion and targetSdkVersion attributes), then you should also declare the â€œscreenSizeâ€ configuration, because it also changes when a device switches between portrait and landscape orientations.</p>
</blockquote>
</blockquote>
<p>åœ¨API Level 13ä»¥åŠæ›´é«˜çš„ç‰ˆæœ¬ä¸Šï¼Œè¿™é‡Œå¿…é¡»åŠ ä¸Š<strong>screenSize</strong>é…ç½®æ‰è¡Œã€‚å› ä¸ºåˆ‡æ¢æ¨ªç«–å±çš„æ—¶å€™ä¼šå¯¼è‡´å±å¹•å°ºå¯¸å˜åŒ–(å®½é«˜ä¸ä¸€è‡´)ï¼Œè€Œå¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸ªï¼Œé‚£ç³»ç»Ÿä¼šè®¤ä¸ºä½ ä¸ä¼šå»å¤„ç†<strong>screenSize</strong>é…ç½®ï¼Œè‡ªç„¶å°±ä¼šé‡æ–°åˆ›å»ºActivityã€‚</p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å®˜ç½‘ä¸Šæœ‰ä¸€ç¯‡ <a href="http://developer.android.com/intl/zh-cn/guide/topics/resources/runtime-changes.html#HandlingTheChange" target="_blank" rel="noopener">APIæŒ‡å—</a> ï¼ŒæŒ‡å¯¼å¼€å‘è€…å¦‚ä½•å¤„ç†è¿è¡Œæ—¶é…ç½®å˜æ›´ï¼Œæœ‰å‡ ä¸ªé‡è¦çš„ç‚¹æ•´ç†å¦‚ä¸‹:</p>
<ol>
<li>é…ç½®å˜åŒ–æœ‰ä¸¤ç§å¤„ç†åŠæ³•ï¼Œä¸€ç§æ˜¯ç›´æ¥é‡å¯Activityï¼Œè¿™ç§åŠæ³•æˆæœ¬è¾ƒé«˜ï¼Œå› ä¸ºè¦è¿›è¡Œå¤§é‡çš„æ•°æ®ä¿å­˜å’Œæ¢å¤ï¼Œä¸€ç§æ˜¯é€‰æ‹©è‡ªè¡Œå¤„ç†é…ç½®å˜æ›´ï¼›</li>
<li>ä½¿ç”¨Bundleä¿å­˜æ•°æ®ä¼šå¾ˆéº»çƒ¦ï¼Œè¦ç»è¿‡åºåˆ—åŒ–ååºåˆ—åŒ–æ“ä½œä¸”ä¸€äº›å¯¹è±¡å¹¶ä¸èƒ½è¢«åºåˆ—åŒ–ååºåˆ—åŒ–ï¼Œä¸€äº›å¯¹è±¡ä¾‹å¦‚Bitmapï¼Œé‡æ–°å®ä¾‹åŒ–çš„æˆæœ¬å¾ˆå¤§ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡Fragmentæ¥ä¿å­˜æ•°æ®(å½“Androidç³»ç»Ÿå› é…ç½®å˜æ›´è€Œå…³é—­Activityæ—¶ï¼Œä¸ä¼šé”€æ¯æ‚¨å·²æ ‡è®°ä¸ºè¦ä¿ç•™çš„Activityçš„Fragmentã€‚æ‚¨å¯ä»¥å°†æ­¤ç±»ç‰‡æ®µæ·»åŠ åˆ°Activityä»¥ä¿ç•™æœ‰çŠ¶æ€çš„å¯¹è±¡ã€‚)ï¼›</li>
<li>è‡ªè¡Œå¤„ç†é…ç½®å˜æ›´å¯èƒ½å¯¼è‡´å¤‡ç”¨èµ„æºçš„ä½¿ç”¨æ›´ä¸ºå›°éš¾ï¼Œå› ä¸ºç³»ç»Ÿä¸ä¼šä¸ºæ‚¨è‡ªåŠ¨åº”ç”¨è¿™äº›èµ„æºï¼Œå¼€å‘è€…æœ‰è´£ä»»é‡ç½®ä¸ºæ‰€æœ‰å…ƒç´ è®¾ç½®æ–°çš„èµ„æº(å¦‚æœéœ€è¦å˜åŒ–çš„è¯)ã€‚ åªèƒ½åœ¨æ‚¨å¿…é¡»é¿å…Activityå› é…ç½®å˜æ›´è€Œé‡å¯è¿™ä¸€ä¸‡èˆ¬æ— å¥ˆçš„æƒ…å†µä¸‹ï¼Œæ‰è€ƒè™‘é‡‡ç”¨è‡ªè¡Œå¤„ç†é…ç½®å˜æ›´è¿™ç§æ–¹æ³•ï¼Œè€Œä¸”å¯¹äºå¤§å¤šæ•°åº”ç”¨å¹¶ä¸å»ºè®®ä½¿ç”¨æ­¤æ–¹æ³•ï¼›</li>
</ol>
<p>è¿™é‡Œå†å¤‡æ³¨ä¸¤ä¸ªæ–¹æ³•: <strong>onRetainNonConfigurationInstance()</strong>å’Œ<strong>getLastNonConfigurationInstance()</strong>ï¼Œå…·ä½“çš„æ–¹æ³•è§£é‡Šå¯ä»¥çœ‹<a href="http://developer.android.com/intl/zh-cn/reference/android/app/Activity.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚</p>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•åŸæœ¬ä¹Ÿæ˜¯ç”¨äºå¤„ç†Configurationå˜åŒ–çš„æƒ…å†µçš„ï¼Œå’Œ2çš„ä½¿ç”¨æƒ…å†µæ˜¯ä¸€è‡´çš„ã€‚åœ¨onRetainNonConfigurationInstance ()æ–¹æ³•çš„æ³¨é‡Šä¸­ç‰¹åˆ«è¯´æ˜äº†ä»¥ä¸‹å‡ ç‚¹:</p>
<blockquote>
<p>This function is called purely as an optimization, and you must not rely on it being called(ä¸ä¸€å®šä¼šè¢«è°ƒç”¨). When it is called, a number of guarantees will be made to help optimize configuration switching:</p>
<ol>
<li>The function will be called between onStop() and onDestroy().åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹é—´è°ƒç”¨ã€‚</li>
<li>A new instance of the activity will always be immediately created after this oneâ€™s onDestroy() is called. In particular, no messages will be dispatched during this time (when the returned object does not have an activity to be associated with).æ³¨æ„ä½¿ç”¨çš„åœºæ™¯ï¼Œå¿…é¡»ä¿è¯åœ¨é‡å»ºçš„é—´éš™ä¸­æ²¡æœ‰æ¶ˆæ¯ä¼ é€å¤„ç†ã€‚</li>
<li>The object you return here will always be available from the getLastNonConfigurationInstance() method of the following activity instance as described there.å¯ä»¥é€šè¿‡getLastNonConfigurationInstance()è·å–æ•°æ®</li>
</ol>
</blockquote>
<p>ä½†æ˜¯åœ¨API Level 13ä¸Šï¼Œè¿™ä¸ªæ”¾å¼ƒå·²ç»è¢«åºŸå¼ƒäº†ï¼Œå®˜ç½‘å»ºè®®é€šè¿‡Fragmentçš„setRetainInstance(boolean)æ–¹æ³•æ¥æ›¿ä»£è¿™ç§æ–¹æ¡ˆã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ThreadLocalæºç å‰–æ]]></title>
      <url>http://www.timebridge.space/2016/02/27/Java-threadlocal/</url>
      <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>å½“ä¸€ä¸ªèµ„æºå¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹èµ„æºåŠ ä»¥ä¿æŠ¤ï¼Œä»¥ç¡®å®šåœ¨è¯¥èµ„æºä¸Šçš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¸¸è§çš„æ–¹æ³•å°±æ˜¯åŠ é”(synchronizedæˆ–è€…Lock)ï¼Œæˆ–è€…å°†æ“ä½œåŸå­åŒ–(æ¯”å¦‚AtomicInteger)ã€‚</p>
<p>ThreadLocalæ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„å¦å¤–ä¸€ç§æ–¹æ¡ˆ: æ—¢ç„¶èµ„æºåœ¨çº¿ç¨‹é—´å…±äº«ä¼šæœ‰å®‰å…¨é—®é¢˜ï¼Œé‚£ä¹ˆå°±ä¸ç”¨å…±äº«äº†ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä»½èµ„æºå‰¯æœ¬å°±å¥½äº†ã€‚<a id="more"></a></p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.footprint.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; intLocal = <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Integer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.get();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Integer value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.set(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="number">3</span>; index ++)</span><br><span class="line">            <span class="keyword">new</span> MyThread(index).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="number">5</span>; index ++)&#123;</span><br><span class="line">            <span class="keyword">int</span> value = ThreadLocalTest.intLocal.get();</span><br><span class="line">            System.out.println(<span class="string">"Thread-"</span> + id + <span class="string">" : "</span> + value);</span><br><span class="line">            ThreadLocalTest.intLocal.set(++value);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep((<span class="keyword">int</span>)(<span class="number">100</span> * Math.random()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¾‹å­åŸºäºä¸€ä¸ªå¾ˆå…¸å‹çš„é—®é¢˜: é“¶è¡Œå­˜é’±å–é’±é—®é¢˜ã€‚æˆ‘ä»¬çŸ¥é“å½“å¤šçº¿ç¨‹å¹¶å‘æ“ä½œä¸€ä¸ªintå€¼çš„åŠ å‡æ“ä½œçš„æ—¶å€™ï¼Œæœ€åçš„æ•°å€¼ä¼šäº§ç”Ÿå¾ˆå¤§çš„ä¸ç¡®å®šæ€§ï¼Œå¾—ä¸åˆ°æœ€ç»ˆæ­£ç¡®çš„ç»“æœã€‚è¿™é‡Œæˆ‘ä»¬å°†æ“ä½œçš„â€œå­˜æ¬¾â€å¯¹è±¡ç”±æ™®é€šçš„intå€¼è½¬å˜ä¸ºThreadLocal<integer>å¯¹è±¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿è¡Œç»“æœ:</integer></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Thread-<span class="number">0</span> : <span class="number">0</span></span><br><span class="line">Thread-<span class="number">2</span> : <span class="number">0</span></span><br><span class="line">Thread-<span class="number">1</span> : <span class="number">0</span></span><br><span class="line">Thread-<span class="number">0</span> : <span class="number">1</span></span><br><span class="line">Thread-<span class="number">1</span> : <span class="number">1</span></span><br><span class="line">Thread-<span class="number">1</span> : <span class="number">2</span></span><br><span class="line">Thread-<span class="number">2</span> : <span class="number">1</span></span><br><span class="line">Thread-<span class="number">1</span> : <span class="number">3</span></span><br><span class="line">Thread-<span class="number">0</span> : <span class="number">2</span></span><br><span class="line">Thread-<span class="number">1</span> : <span class="number">4</span></span><br><span class="line">Thread-<span class="number">2</span> : <span class="number">2</span></span><br><span class="line">Thread-<span class="number">0</span> : <span class="number">3</span></span><br><span class="line">Thread-<span class="number">2</span> : <span class="number">3</span></span><br><span class="line">Thread-<span class="number">2</span> : <span class="number">4</span></span><br><span class="line">Thread-<span class="number">0</span> : <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>è™½ç„¶5ä¸ªçº¿ç¨‹æ“ä½œçš„æ˜¯åŒä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œä½†æ¯ä¸€ä¸ªçº¿ç¨‹çš„æ•°å­—éƒ½æ˜¯åœ¨è‡ªæˆ‘é€’å¢ï¼Œçº¿ç¨‹ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œè¿™å°±æ˜¯ThreadLocalçš„ä½œç”¨ã€‚</p>
<p>ThreadLocalç±»ä¸­å¯é‡è½½çš„æ–¹æ³•åªæœ‰å››ä¸ªï¼š</p>
<ol>
<li>set()ï¼šè®¾ç½®å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬é€‰æ‹©å°†æŸä¸ªå€¼è®¾ç½®ä¸ºThreadLocalç±»å‹çš„ï¼›</li>
<li>get()ï¼šå°†è®¾ç½®è¿›å»çš„å€¼å–å‡ºæ¥ï¼›</li>
<li>remove()ï¼šæˆ‘ä»¬ä¸æƒ³å°†æŸä¸ªå€¼è®¾ç½®ä¸ºThreadLocaläº†ï¼Œç§»é™¤æ‰ï¼›</li>
<li>initialValue()ï¼šå¦‚æœgetçš„æ—¶å€™è¿˜æ²¡æœ‰è®¾ç½®å€¼ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼›</li>
</ol>
<p>ä¸€èˆ¬é‡è½½initialValue()æä¾›ä¸€ä¸ªåˆå§‹å€¼å°±å¯ä»¥äº†ï¼Œå…¶ä½™æ–¹æ³•ä¸éœ€è¦é‡è½½ã€‚</p>
<h2 id="ThreadLocalæºç å‰–æ"><a href="#ThreadLocalæºç å‰–æ" class="headerlink" title="ThreadLocalæºç å‰–æ"></a>ThreadLocalæºç å‰–æ</h2><p>æœ¬èŠ‚ä»æºç è§’åº¦çœ‹ä¸€ä¸‹å››ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•é…åˆè¿ä½œçš„ï¼Œåˆæ˜¯å¦‚ä½•åšåˆ°ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªèµ„æºå‰¯æœ¬çš„ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆä»get()æ–¹æ³•å…¥æ‰‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">	Thread t = Thread.currentThread();</span><br><span class="line">	ThreadLocalMap map = getMap(t);</span><br><span class="line">	<span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">		ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">		<span class="keyword">if</span> (e != <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> (T)e.value;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getMapæ–¹æ³•è¿”å›çš„æ˜¯çº¿ç¨‹çš„threadLocalså¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ThreadLocal values pertaining to this thread. This map is maintained</span></span><br><span class="line"><span class="comment"> * by the ThreadLocal class. */</span></span><br><span class="line">ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå®ƒæ˜¯ä¸€ä¸ªThreadLocalMapå¯¹è±¡ï¼Œä¸“é—¨ä¸ºThreadLocalè€Œç”Ÿä¸”å®ç°å’Œç»´æŠ¤éƒ½åœ¨ThreadLocalä¸­è¿›è¡Œï¼Œåªä¸è¿‡Threadå¯¹å®ƒæœ‰ä¸€ä¸ªå¼•ç”¨ã€‚å®ƒçš„æ³¨é‡Šå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ThreadLocalMap is a customized hash map suitable only for</span></span><br><span class="line"><span class="comment"> * maintaining thread local values. No operations are exported</span></span><br><span class="line"><span class="comment"> * outside of the ThreadLocal class. The class is package private to</span></span><br><span class="line"><span class="comment"> * allow declaration of fields in class Thread.  To help deal with</span></span><br><span class="line"><span class="comment"> * very large and long-lived usages, the hash table entries use</span></span><br><span class="line"><span class="comment"> * WeakReferences for keys. However, since reference queues are not</span></span><br><span class="line"><span class="comment"> * used, stale entries are guaranteed to be removed only when</span></span><br><span class="line"><span class="comment"> * the table starts running out of space.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ä¸ªå®šåˆ¶çš„HashMapå®¹å™¨ï¼Œå®ƒåªèƒ½åœ¨ThreadLocalå†…éƒ¨ä½¿ç”¨ï¼Œæ‰€æœ‰çš„Keyéƒ½æ˜¯WeakReferencesï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªMapçš„Entry:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">	Object value;</span><br><span class="line"></span><br><span class="line">	Entry(ThreadLocal k, Object v) &#123;</span><br><span class="line">		<span class="keyword">super</span>(k);</span><br><span class="line">		value = v;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡Entryå¯ä»¥å¾ˆæ¸…æ¥šçš„äº†è§£åˆ°ThreadLocalMapç»´æŠ¤çš„æ˜¯ä¸€ä¸ªä»ThreadLocalåˆ°å¯¹åº”å€¼çš„æ˜ å°„ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªè¿™æ ·çš„å˜é‡ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªThreadå¯ä»¥ç»´æŠ¤å¾ˆå¤šçš„ThreadLocalï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥ç»´æŠ¤å¾ˆå¤šèµ„æºçš„å‰¯æœ¬ã€‚</p>
<p>æˆ‘ä»¬å›åˆ°get()æ–¹æ³•ã€‚getMap()æ–¹æ³•å°±æ˜¯è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡ï¼Œå‰©ä¸‹çš„æ­¥éª¤å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">	ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">if</span> (e != <span class="keyword">null</span>)</span><br><span class="line">	<span class="keyword">return</span> (T)e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰å½“å½“å‰çº¿ç¨‹çš„Mapä¸­ç»´æŠ¤ç€å½“å‰ThreadLocalæ˜ å°„çš„å€¼çš„æ—¶å€™ï¼Œæ‰ä¼šæ­£å¸¸è¿”å›ç»“æœï¼Œå¦åˆ™å°±ä¼šå»è°ƒç”¨setInitialValue()æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Variant of set() to establish initialValue. Used instead</span></span><br><span class="line"><span class="comment"> * of set() in case user has overridden the set() method.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the initial value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	T value = initialValue();<span class="comment">//è°ƒç”¨æ–¹æ³•åˆå§‹åŒ–å€¼</span></span><br><span class="line">	Thread t = Thread.currentThread();</span><br><span class="line">	ThreadLocalMap map = getMap(t);</span><br><span class="line">	<span class="keyword">if</span> (map != <span class="keyword">null</span>)<span class="comment">//Mapå·²ç»å­˜åœ¨ç›´æ¥è®¾ç½®å€¼</span></span><br><span class="line">		map.set(<span class="keyword">this</span>, value);</span><br><span class="line">	<span class="keyword">else</span><span class="comment">//å¦åˆ™åˆ›å»ºMap</span></span><br><span class="line">		createMap(t, value);</span><br><span class="line">	<span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºThreadLocalMap</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">	t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Construct a new map initially containing (firstKey, firstValue).</span></span><br><span class="line"><span class="comment"> * ThreadLocalMaps are constructed lazily, so we only create</span></span><br><span class="line"><span class="comment"> * one when we have at least one entry to put in it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ThreadLocalMap(ThreadLocal firstKey, Object firstValue) &#123;</span><br><span class="line">	table = <span class="keyword">new</span> Entry[INITIAL_CAPACITY];</span><br><span class="line">	<span class="keyword">int</span> i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">	<span class="comment">//ä¼ å…¥çš„Key-Valueä¼šè¢«ç«‹åˆ»åˆ›å»ºä¸ºEntryä¿å­˜èµ·æ¥</span></span><br><span class="line">	table[i] = <span class="keyword">new</span> Entry(firstKey, firstValue);</span><br><span class="line">	size = <span class="number">1</span>;</span><br><span class="line">	setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç†è§£äº†ThreadLocalMapçš„å«ä¹‰ä»¥åŠå®ƒä¸Threadçš„å…³ç³»ï¼Œè¿™é‡Œå°±å¾ˆå¥½ç†è§£äº†ï¼Œè¯¦è§æ³¨é‡Šã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œget()å’ŒinitialValue()æ–¹æ³•éƒ½å·²ç»æ¶‰åŠåˆ°ï¼Œå‰©ä¸‹çš„set()å’Œremove()ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>åˆ†æè‡³æ­¤ï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸ªé—®é¢˜: ThreadLocalä¼šä¸ä¼šé€ æˆå†…å­˜æ³„éœ²ï¼Ÿ</p>
<p>é—®é¢˜çš„èµ·å› æ˜¯è¿™æ ·çš„: Theadé€šè¿‡ThreadLocalMapå¼•ç”¨ç€TheadLocalåˆ°ä¸€ä¸ªå˜é‡å€¼çš„æ˜ å°„ï¼Œå‡è®¾å¦‚æœä¸€ä¸ªçº¿ç¨‹æœ‰Aã€Bä¸¤ä¸ªæ–¹æ³•ï¼ŒAæ–¹æ³•è°ƒç”¨çš„æ—¶å€™åˆå§‹åŒ–äº†ä¸€ä¸ªThreadLocalèµ„æºï¼Œç„¶åçº¿ç¨‹ä¸€ç›´åœ¨æ‰§è¡ŒBæ–¹æ³•ï¼Œå¹¶ä¸”Bä¸ä¼šå†å»æ“ä½œThreadLocalèµ„æºäº†ï¼Œé‚£ä¹ˆä¼šä¸ä¼šå¼•èµ·è¿™ä¸ªThreadLocalèµ„æºä¸èƒ½é‡Šæ”¾å‘¢ï¼Ÿ</p>
<p>ThreadLocalçš„å®ç°å¾ˆå®¹æ˜“è®©äººè§‰å¾—ä¸ä¼šï¼Œæ¯”å¦‚ThreadLocalMapçš„Entryå®ç°ã€‚è¯»è€…åº”è¯¥æ³¨æ„åˆ°Entryçš„Keyä¹Ÿå°±æ˜¯å¯¹ThreadLocalçš„å¼•ç”¨æ˜¯WeakReferenceçš„ï¼è¿™æ ·ä¿è¯äº†å½“å¤–éƒ¨ç±»(ThreadLocalTest)è¢«é”€æ¯åï¼Œä¸€æ—¦ThreadLocalå˜é‡(intLocal)ä¸å†æœ‰å¼ºå¼•ç”¨ï¼ŒThreadLocalå°±ä¼šç«‹åˆ»è¢«å›æ”¶æ‰ï¼Œå³Entryä¸­çš„Keyä¼šè¢«å›æ”¶æ‰ã€‚ä½†TheadlLocalä»…ä»…æ˜¯ä¸€ä¸ªæ¡¥æ¢ï¼ŒçœŸæ­£çš„èµ„æºæ˜¯Valueï¼Œå®ƒè¿˜æ˜¯è¢«Entryå¼•ç”¨ç€ï¼Œä¿å­˜åœ¨Threadçš„ThreadLocalMapä¸­ã€‚</p>
<p>æ‰€ä»¥ï¼Œç±»ä¼¼äºä»£ç ğŸŒ°ä¸­ç»™å‡ºçš„å®ç°ï¼Œæ˜¯æœ‰é£é™©çš„ã€‚å½“æˆ‘ä»¬ç¡®è®¤çº¿ç¨‹ä¸­ä¸ä¼šå†ä½¿ç”¨ä¸€ä¸ªèµ„æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”å½“ä¸»åŠ¨å»removeï¼Œæ¯”å¦‚åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼ŒAæ–¹æ³•å°±åº”è¯¥è°ƒç”¨removeæ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—ä¸ä½¿ç”¨çš„èµ„æºå°½æ—©é‡Šæ”¾æ‰ï¼Œè€Œä¸æ˜¯å¦‚æ³¨é‡Šä¸­æ‰€è¯´:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Each thread holds an implicit reference to its copy of a thread-local</span></span><br><span class="line"><span class="comment"> * variable as long as the thread is alive and the &lt;tt&gt;ThreadLocal&lt;/tt&gt;</span></span><br><span class="line"><span class="comment"> * instance is accessible; after a thread goes away, all of its copies of</span></span><br><span class="line"><span class="comment"> * thread-local instances are subject to garbage collection (unless other</span></span><br><span class="line"><span class="comment"> * references to these copies exist).</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ç­‰åˆ°Threadæ­»äº¡ä¹‹åæ‰æŠŠèµ„æºå‰¯æœ¬å…¨éƒ¨é‡Šæ”¾æ‰ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ—¥å¸¸å¼€å‘ä¸­å¹¶ä¸å¸¸ç”¨åˆ°è¿™ä¸ªç±»ï¼Œä½†æ˜¯å¥¹æä¾›äº†è§£å†³èµ„æºå®‰å…¨çš„ä¸€ç§æ–¹æ¡ˆï¼Œä¾¿åˆ©ä¸”ä¼˜é›…ï¼Œå¯¹äºå…¶ä½¿ç”¨ï¼ŒAndroidå¼€å‘è€…å¯ä»¥å»ç ”ä¹ ä¸€ä¸‹<a href="http://www.muzileecoding.com/androidsource/Android-Handler.html" target="_blank" rel="noopener">Handlerçš„å®ç°</a>ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidå¼€å‘One Piece]]></title>
      <url>http://www.timebridge.space/2016/02/27/Android-One-Piece/</url>
      <content type="html"><![CDATA[<div align="center"><img src="http://7xktd8.com1.z0.glb.clouddn.com/onepiece2.png" height="188" alt="One Piece"></div>

<h2 id="å·¥å…·ç›¸å…³"><a href="#å·¥å…·ç›¸å…³" class="headerlink" title="å·¥å…·ç›¸å…³"></a>å·¥å…·ç›¸å…³</h2><h3 id="TraceView"><a href="#TraceView" class="headerlink" title="TraceView"></a>TraceView</h3><ol>
<li><a href="http://tech.meituan.com/android_custom_lint.html" target="_blank" rel="noopener">Androidè‡ªå®šä¹‰Lintå®è·µ</a>ã€‚çœ‹ä¸Šå»å¾ˆå¼ºå¤§çš„æ ·å­ï¼Œå¯ä»¥ç”¨äºå®šåˆ¶ä¸€äº›å·¥å…·ã€‚</li>
<li><a href="http://laobie.github.io/android/2016/02/14/android-studio-tips.html" target="_blank" rel="noopener">Android Studio å°æŠ€å·§åˆé›†</a>ã€‚è°ƒè¯•å™¨æŠ€å·§åˆ†ç±»ä¸‹å¾ˆæœ‰ç”¨ã€‚</li>
<li><a href="https://segmentfault.com/a/1190000004461614" target="_blank" rel="noopener">Androidåˆ†äº«ï¼šä»£ç æ··æ·†é‚£äº›äº‹</a>ã€‚è·ŸProguardç›¸å…³çš„åŸºæœ¬çŸ¥è¯†ï¼Œä¹Ÿæœ‰ä¸€äº›ä¸é”™çš„æ–‡ç« é“¾æ¥ã€‚<a id="more"></a>
<h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=404234343&amp;idx=1&amp;sn=b297b01ee7c656b900417f14a2a0ccae&amp;scene=1&amp;srcid=0303KKfAyLlCyDJT1Sutn26i&amp;key=710a5d99946419d9c72026bcf5c728d9f9fb967dc032ffe2a60669550d6677ace7cadcf6453d69de28540dcbdceefb49&amp;ascene=0&amp;uin=MTYzMjY2MTE1&amp;devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.11.3+build(15D21" target="_blank" rel="noopener">TRIMï¼šæå‡ç£ç›˜æ€§èƒ½ï¼Œç¼“è§£Androidå¡é¡¿</a>&amp;version=11020201&amp;pass_ticket=VbRCYWXa6oXQkbEbGqIqO1z%2BRQ8XRpmC8IJJVBb2EJ8%3D)ã€‚è¿™ç¯‡æ–‡ç« æåˆ°äº†Androidç³»ç»Ÿä¸Šé•¿æœŸè¯»å†™æ–‡ä»¶é€ æˆçš„ç£ç›˜ç¢ç‰‡åŒ–å¯¹Androidç³»ç»Ÿæµç•…åº¦çš„å½±å“ã€‚</li>
</ol>
<blockquote>
<p>Androidæ‰‹æœºå¤§å¤šé‡‡ç”¨NAND Flashæ¶æ„çš„é—ªå­˜å¡ã€‚è™½ç„¶ NAND Flash çš„ä¼˜ç‚¹å¤šå¤šï¼Œä½†æ˜¯ä¸ºäº†å»¶é•¿é©±åŠ¨å™¨çš„å¯¿å‘½ï¼Œå®ƒçš„è¯»å†™æ“ä½œå‡æ˜¯ä»¥ Page ä¸ºå•ä½è¿›è¡Œçš„ï¼Œä½†æ“¦é™¤æ“ä½œå´æ˜¯æŒ‰ Block ä¸ºå•ä½è¿›è¡Œçš„ã€‚è¿™ä¼šé€ æˆâ€œå†™å…¥æ”¾å¤§â€ï¼ˆWrite Amplificationï¼‰é—®é¢˜ã€‚è¿™ä¸€ç‚¹å¯ä»¥ä½¿ç”¨TRIMæŠ€æœ¯è§£å†³:</p>
<blockquote>
<p>TRIM æ˜¯ä¸€æ¡ ATA æŒ‡ä»¤ï¼Œç”±æ“ä½œç³»ç»Ÿå‘é€ç»™é—ªå­˜ä¸»æ§åˆ¶å™¨ï¼Œå‘Šè¯‰å®ƒå“ªäº›æ•°æ®å çš„åœ°å€æ˜¯â€œæ— æ•ˆâ€çš„ã€‚åœ¨ TRIM çš„å¸®åŠ©ä¸‹ï¼Œé—ªå­˜ä¸»æ§åˆ¶å™¨å°±å¯ä»¥æå‰çŸ¥é“å“ªäº› Page æ˜¯â€œæ— æ•ˆâ€çš„ï¼Œä¾¿å¯ä»¥åœ¨é€‚å½“çš„æ—¶æœºåšå‡ºä¼˜åŒ–ï¼Œä»è€Œæ”¹å–„æ€§èƒ½ã€‚</p>
</blockquote>
<p>åé¢ç”¨å®éªŒè¯æ˜äº†è¿™ç§çŒœæƒ³ï¼Œä»¥åŠAndroidç³»ç»Ÿç¡®å®ä½¿ç”¨è¯¥æŠ€æœ¯å¯¹ç³»ç»Ÿåšå‡ºäº†ä¼˜åŒ–ï¼Œç»“è®ºå¦‚ä¸‹:</p>
<ol>
<li>åœ¨ TRIM æ— æ•ˆçš„æƒ…å†µä¸‹ï¼Œé•¿æœŸä½¿ç”¨ SD å¡ï¼Œç£ç›˜å†™å…¥é€Ÿåº¦ä¼šå—åˆ°æ˜æ˜¾å½±å“;</li>
<li>TRIM å¯¹å› é—²ç½®æ•°æ®å—é€ æˆçš„ I/O æ€§èƒ½ä¸‹é™æœ‰ä¸€å®šçš„æ¢å¤ä½œç”¨;</li>
<li>å¤§é‡çš„è¯»å†™æ“ä½œå¯¹ SD å¡é€ æˆäº†ä¸€å®šé‡çš„ä¸å¯æ¢å¤çš„æŸè€—;</li>
</ol>
</blockquote>
<ol>
<li><a href="http://blog.csdn.net/UsherFor/article/details/46827587" target="_blank" rel="noopener">å¦‚ä½•åšåˆ°å°†apkå¤§å°å‡å°‘6M</a>ã€‚è®²äº†ä¸€ç»„ä¸ç¼©å°APKå¤§å°ç›¸å…³çš„ä¼˜åŒ–æªæ–½ï¼ŒæŒºå…¨é¢ã€‚</li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI1NjEwMTM4OA==&amp;mid=2651232233&amp;idx=1&amp;sn=03d9858ac451f2768b804d2604a8e12e" target="_blank" rel="noopener">PNGå›¾ç‰‡å‹ç¼©å¯¹æ¯”åˆ†æ</a>ã€‚è°ƒç ”äº†ç›®å‰å¸¸ç”¨çš„PNGå‹ç¼©å·¥å…·å’Œç¬¬ä¸‰æ–¹åº“ï¼Œåœ¨å†³å®šä½¿ç”¨pngquantçš„åŸºç¡€ä¸Šå¼€å‘Gradleæ’ä»¶ï¼Œå®ŒæˆPNGçš„è‡ªåŠ¨æ‰“åŒ…å‹ç¼©ï¼Œéå¸¸å…·æœ‰å®è·µæ€§ã€‚</li>
</ol>
<h2 id="çŸ¥è¯†æ•´ç†"><a href="#çŸ¥è¯†æ•´ç†" class="headerlink" title="çŸ¥è¯†æ•´ç†"></a>çŸ¥è¯†æ•´ç†</h2><ol>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzA4MjU5NTY0NA==&amp;mid=404530070&amp;idx=1&amp;sn=e2580b69d6ec73dabf8160216aa6702a&amp;scene=1&amp;srcid=0322dGvv5B4miLg3vt0q2rK2&amp;key=710a5d99946419d9e5ab07eaa09e546952524b770e8a63c46c223b7588209d3a542fe4a0827571ac73b03cb78b404289&amp;ascene=0&amp;uin=MTYzMjY2MTE1&amp;devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.11.4+build(15E65" target="_blank" rel="noopener">Android Bitmapé¢é¢è§‚</a>&amp;version=11020201&amp;pass_ticket=Sqb%2BpOLTrZ0wixoScJ8flYxFV4tOFnBa7NFos1uIG8U%3D)</p>
</li>
<li><p><a href="http://ztelur.github.io/2016/03/16/Android-MotionEvent%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">Android MotionEventè¯¦è§£</a>ã€‚é‡Œé¢æœ‰ç€å¯¹Indexã€Pointerã€Idçš„è®¨è®ºã€‚</p>
</li>
<li><p><a href="http://jijiaxin89.com/2015/08/30/Android-s-Runtime-Permission/" target="_blank" rel="noopener">Android M æ–°çš„è¿è¡Œæ—¶æƒé™å¼€å‘è€…éœ€è¦çŸ¥é“çš„ä¸€åˆ‡</a></p>
</li>
<li><p><a href="http://mp.weixin.qq.com/s?__biz=MzA4MjU5NTY0NA==&amp;mid=404388098&amp;idx=1&amp;sn=8bbbba7692dca68cdda2212dec4d86c0&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">ä½ åº”è¯¥çŸ¥é“çš„é‚£äº›Androidå°ç»éªŒ</a></p>
</li>
<li><p><a href="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=403263974&amp;idx=1&amp;sn=b0315addbc47f3c38e65d9c633a12cd6&amp;scene=4#wechat_redirect" target="_blank" rel="noopener">Android å¼€å‘ç»•ä¸è¿‡çš„å‘ï¼šä½ çš„ Bitmap ç©¶ç«Ÿå å¤šå¤§å†…å­˜ï¼Ÿ</a>ã€‚è¯¦ç»†æ¢ç©¶äº†å…³äºå›¾ç‰‡æ”¾ç½®åœ¨ä¸åŒåˆ†è¾¨ç‡æ–‡ä»¶å¤¹ä¸‹é¢ç”ŸæˆBitmapåæ‰€å å†…å­˜å¤§å°çš„è®¡ç®—æ–¹æ³•ï¼Œæ¸…æ¥šæ˜ç™½ã€‚</p>
<blockquote>
<p>æ•´ç†å‡ºæ¥çš„å…¬å¼åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<p>1ï¼‰å†…å­˜å›¾ç‰‡å®é™…çš„å®½é«˜è®¡ç®—ï¼šå†…å­˜å®½/é«˜ = (int)(æ–‡ä»¶å®é™…å®½/é«˜ * å±å¹•åˆ†è¾¨ç‡ / æ–‡ä»¶å¤¹åˆ†è¾¨ç‡ + 0.5)</p>
<p>2ï¼‰å†…å­˜å ç”¨è®¡ç®—ï¼šå†…å­˜å¤§å° = å†…å­˜å®½ <em> å†…å­˜é«˜ </em> æ¯ä¸ªåƒç´ å ç”¨å€¼ã€‚</p>
<p>æ¯ä¸ªåƒç´ å ç”¨å€¼å¯ä»¥å‚è§ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">SkColorTypeBytesPerPixel</span><span class="params">(SkColorType ct)</span> </span>&#123;</span><br><span class="line">&gt;    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint8_t</span> gSize[] = &#123;</span><br><span class="line">&gt;     <span class="number">0</span>,  <span class="comment">// Unknown</span></span><br><span class="line">&gt;     <span class="number">1</span>,  <span class="comment">// Alpha_8</span></span><br><span class="line">&gt;     <span class="number">2</span>,  <span class="comment">// RGB_565</span></span><br><span class="line">&gt;     <span class="number">2</span>,  <span class="comment">// ARGB_4444</span></span><br><span class="line">&gt;     <span class="number">4</span>,  <span class="comment">// RGBA_8888</span></span><br><span class="line">&gt;     <span class="number">4</span>,  <span class="comment">// BGRA_8888</span></span><br><span class="line">&gt;     <span class="number">1</span>,  <span class="comment">// kIndex_8</span></span><br><span class="line">&gt;   &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>ç²—ç•¥çš„çœ‹ï¼Œ<strong>å›¾ç‰‡å ç”¨å†…å­˜å¤§å°ä¸è§£ææ ¼å¼ã€å­˜æ”¾ç›®å½•ä»¥åŠæ‰‹æœºå±å¹•å¯†åº¦ç›¸å…³</strong>ã€‚</p>
</blockquote>
</li>
<li><p>å¾…è¡¥å……ã€‚</p>
</li>
</ol>
<h2 id="é»‘ç§‘æŠ€"><a href="#é»‘ç§‘æŠ€" class="headerlink" title="é»‘ç§‘æŠ€"></a>é»‘ç§‘æŠ€</h2><ol>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzAxNjI3MDkzOQ==&amp;mid=405919721&amp;idx=1&amp;sn=fdad21c0bc74d90e66443d488e8cdc8f&amp;scene=0&amp;key=710a5d99946419d977ba9c54e81b348f298b6edd533df2290bf866f6dc83684af4956d4748ed17fc4b79f57bd5c02431&amp;ascene=0&amp;uin=MTYzMjY2MTE1&amp;devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.11.3+build(15D21" target="_blank" rel="noopener">ä¸€ç§ä¸º Apk åŠ¨æ€å†™å…¥ä¿¡æ¯çš„æ–¹æ¡ˆ</a>&amp;version=11020201&amp;pass_ticket=obnYCpEe4OrQ6yNew2Dy2ncIZX%2B8wffXKUYSyIB2KVY%3D)<br>æŒºæœ‰æ„æ€çš„æ‰‹æ³•ï¼Œè¿™ç¯‡æ–‡ç« åŸºäºåˆ†äº«åœºæ™¯ä»‹ç»äº†ä¸€ç§åŠ¨æ€ä¸ºAPKå†™å…¥ä¿¡æ¯çš„æ–¹æ³•â€”â€”ä»Zipæ–‡ä»¶æ ¼å¼å…¥æ‰‹ï¼Œåœ¨æ–‡ä»¶å°¾éƒ¨æ’å…¥ä¸€å°æ®µä¿¡æ¯ï¼Œåˆ©ç”¨è¿™æ®µä¿¡æ¯å®Œæˆåˆ†äº«åœºæ™¯çš„å®Œæ•´æ€§ã€‚èµï¼</li>
<li><a href="http://blog.csdn.net/xieyuooo/article/details/7068216" target="_blank" rel="noopener">å¦‚ä½•ç²¾ç¡®åœ°æµ‹é‡javaå¯¹è±¡çš„å¤§å°-åº•å±‚instrument API</a>å’Œ<a href="http://my.oschina.net/xianggao/blog/362495" target="_blank" rel="noopener">java.lang.Instrument ä»£ç†Agentä½¿ç”¨</a>ã€‚ä¸»è¦ä»‹ç»äº†<code>Agent</code>çš„å­˜åœ¨ä»¥åŠInstrumentæµ‹é‡Javaå¯¹è±¡å¤§å°çš„ä½¿ç”¨æ–¹å¼ã€‚</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HandlerThread & IntentServiceæºç åˆ†æ]]></title>
      <url>http://www.timebridge.space/2016/02/26/Android-HandlerThread-And-IntentService/</url>
      <content type="html"><![CDATA[<h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><p>ã€ç¯å¢ƒã€‘ä»£ç åˆ†æåŸºäº API-23ã€‚</p>
<h2 id="ä»‹ç»å’Œä½¿ç”¨"><a href="#ä»‹ç»å’Œä½¿ç”¨" class="headerlink" title="ä»‹ç»å’Œä½¿ç”¨"></a>ä»‹ç»å’Œä½¿ç”¨</h2><p>æœ¬æ–‡å°†ä»‹ç»ä¸¤ä¸ªç±»ï¼šHandlerThreadå’ŒIntentServiceï¼Œåè€…ä½¿ç”¨åˆ°äº†å‰è€…ï¼Œä¸¤ä¸ªç±»éƒ½çŸ­å°ç²¾æ‚ï¼Œæ”¾åœ¨ä¸€èµ·åˆ†æå¾ˆniceã€‚</p>
<p>åœ¨å­¦ä¹ Serviceçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€å®šä¼šçŸ¥é“IntentService:ï¼Œå®˜æ–¹æ–‡æ¡£ä¸æ­¢ä¸€æ¬¡å¼ºè°ƒ: Serviceæœ¬èº«æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œè€Œä¸»çº¿ç¨‹ä¸­æ˜¯ä¸é€‚åˆè¿›è¡Œè€—æ—¶ä»»åŠ¡çš„ï¼Œå› è€Œå®˜æ–¹æ–‡æ¡£å®å˜±æˆ‘ä»¬ä¸€å®šè¦åœ¨Serviceä¸­å¦å¼€çº¿ç¨‹è¿›è¡Œè€—æ—¶ä»»åŠ¡å¤„ç†ã€‚IntentServiceæ­£æ˜¯ä¸ºè¿™ä¸ªç›®çš„è€Œè¯ç”Ÿçš„ä¸€ä¸ªä¼˜é›…è®¾è®¡ï¼Œè®©ç¨‹åºå‘˜ä¸ç”¨å†ç®¡ç†çº¿ç¨‹çš„å¼€å¯å’Œè¿è¡Œã€‚</p>
<p>ä¸¤ä¸ªç±»å…·ä½“çš„ä½¿ç”¨ä¾‹å­è§ä¸‹é¢çš„åˆ†æã€‚<a id="more"></a></p>
<h2 id="HandlerThreadæºç å‰–æ"><a href="#HandlerThreadæºç å‰–æ" class="headerlink" title="HandlerThreadæºç å‰–æ"></a>HandlerThreadæºç å‰–æ</h2><p>HandlerThreadæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ç±»ï¼Œåœ¨<a href="http://www.muzileecoding.com/androidsource/Android-Handler.html" target="_blank" rel="noopener">Handlerä¸€æ–‡</a>ä¸­ï¼Œæˆ‘ä»¬æè¿°äº†åˆ›å»ºä¸€ä¸ªå¸¦Looper(æ¶ˆæ¯å¾ªç¯æœºåˆ¶)çš„çº¿ç¨‹çš„åšæ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">     <span class="keyword">public</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          Looper.prepare();</span><br><span class="line"></span><br><span class="line">          mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                 <span class="comment">// process incoming messages here</span></span><br><span class="line">              &#125;</span><br><span class="line">         &#125;;</span><br><span class="line">         Looper.loop();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œè€Œä¸”å¯¹äºLooper.prepare()ï¼ŒLooper.loop()ä»¥åŠHandlerçš„åˆ›å»ºé¡ºåºæ˜¯æœ‰ç›¸åº”è¦æ±‚çš„ï¼ŒHandlerThreadæ˜¯å¯¹è¿™ä¸ªåˆ›å»ºè¿‡ç¨‹çš„ä¸€ä¸ªå°è£…â€”â€”ç›´æ¥æä¾›ä¸€ä¸ªå¸¦æœ‰Looperæœºåˆ¶çš„Threadã€‚</p>
<p>HandlerThreadçš„å®Œæ•´æºç åªæœ‰149è¡Œï¼Œåˆ é™¤æ³¨é‡Šå’ŒLicenseä¹‹åï¼Œåªæœ‰71è¡Œï¼Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mPriority;</span><br><span class="line">    <span class="keyword">int</span> mTid = -<span class="number">1</span>;</span><br><span class="line">    Looper mLooper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        mPriority = Process.THREAD_PRIORITY_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerThread</span><span class="params">(String name, <span class="keyword">int</span> priority)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        mPriority = priority;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//å›è°ƒæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLooperPrepared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mTid = Process.myTid();</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            mLooper = Looper.myLooper();</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        Process.setThreadPriority(mPriority);</span><br><span class="line">        onLooperPrepared();</span><br><span class="line">        Looper.loop();</span><br><span class="line">        mTid = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Looper <span class="title">getLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isAlive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If the thread has been started, wait until the looper has been created.</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (isAlive() &amp;&amp; mLooper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mLooper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Looper looper = getLooper();</span><br><span class="line">        <span class="keyword">if</span> (looper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            looper.quit();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">quitSafely</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Looper looper = getLooper();</span><br><span class="line">        <span class="keyword">if</span> (looper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            looper.quitSafely();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getThreadId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HandlerThreadæ˜¯Threadçš„ä¸€ä¸ªå­ç±»ï¼Œä¹‹å‰çš„åˆ›å»ºè¿‡ç¨‹éƒ½è¢«æ”¾åˆ°äº†run()æ–¹æ³•ä¸­ï¼Œçœ‹è¿‡<a href="http://www.muzileecoding.com/androidsource/Android-Handler.html" target="_blank" rel="noopener">Handlerä¸€æ–‡</a>çš„è¯»è€…åº”è¯¥å¯¹æ­¤éå¸¸ç†Ÿæ‚‰ã€‚run()æ–¹æ³•ä¸­æœ‰å‡ è¡Œä»£ç æ¯”è¾ƒå¥‡ç‰¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">	mLooper = Looper.myLooper();</span><br><span class="line">	notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸ºä»€ä¹ˆè¦åŠ ä¸Š<strong>synchronized</strong>å…³é”®å­—å‘¢ï¼Ÿç­”æ¡ˆåœ¨äºgetLooper()æ–¹æ³•ã€‚</p>
<p>getLooper()æ–¹æ³•æ˜¯å°†HandlerThreadçš„Looperæš´éœ²åˆ°å¤–é¢ä»¥ä¾¿äºå…¶ä½™çš„çº¿ç¨‹å»ºç«‹è¿™ä¸ªThreadçš„Handlerä¸ä¹‹äº¤äº’ã€‚å¦‚æœå…¶ä½™çº¿ç¨‹åœ¨HandlerThreadå¯åŠ¨ä¹‹å‰(å³run()æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œå³Looper.prepare()æ‰§è¡Œä¹‹å‰)è°ƒç”¨getLooper()æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™HandlerThreadæ˜¯æ²¡æœ‰å¯ç”¨çš„Looperçš„ï¼Œæ‰€ä»¥åœ¨getLooper()æ–¹æ³•ä¸­ï¼Œè¿™æ ·çš„å¤–éƒ¨çº¿ç¨‹å°±ä¼šè¢«wait()ã€‚</p>
<p>è€Œç­‰åˆ°run()æ–¹æ³•è¿è¡Œåˆ°Looper.prepare()ä¹‹åï¼ŒLooperå·²ç»å®Œå¤‡ï¼Œæ­¤æ—¶åº”è¯¥é€šçŸ¥æ‰€æœ‰çš„waitçº¿ç¨‹è·å–Looperâ€”â€”è¿™é‡Œæ˜¯éœ€è¦åšåŒæ­¥çš„ã€‚</p>
<p>è§£é‡Šåˆ°æ­¤ï¼Œå¯¹äºHandlerç†Ÿæ‚‰çš„è¯»è€…ä¸€å®šçŸ¥é“HandlerThreadæ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œå¦‚æœä¸çŸ¥é“ï¼Œä¸‹é¢çš„IntentServiceæä¾›äº†å®Œç¾çš„ä¾‹å­ã€‚</p>
<blockquote>
<p>çº¿ç¨‹ï¼Œæ˜¯å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§çš„ã€‚</p>
</blockquote>
<h2 id="IntentServiceæºç å‰–æ"><a href="#IntentServiceæºç å‰–æ" class="headerlink" title="IntentServiceæºç å‰–æ"></a>IntentServiceæºç å‰–æ</h2><p>IntentServiceä¹Ÿå¾ˆçŸ­å°ï¼Œåªæœ‰164è¡Œï¼ŒçœŸæ˜¯çš„ä»£ç åˆ™åªæœ‰70è¡Œä¸åˆ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Looper mServiceLooper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServiceHandler mServiceHandler;</span><br><span class="line">    <span class="keyword">private</span> String mName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mRedelivery;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            onHandleIntent((Intent)msg.obj);</span><br><span class="line">            stopSelf(msg.arg1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IntentService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        mName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntentRedelivery</span><span class="params">(<span class="keyword">boolean</span> enabled)</span> </span>&#123;</span><br><span class="line">        mRedelivery = enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> It would be nice to have an option to hold a partial wakelock</span></span><br><span class="line">        <span class="comment">// during processing, and to have a static startService(Context, Intent)</span></span><br><span class="line">        <span class="comment">// method that would launch the service &amp; hand off a wakelock.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"IntentService["</span> + mName + <span class="string">"]"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        mServiceLooper = thread.getLooper();</span><br><span class="line">        mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Message msg = mServiceHandler.obtainMessage();</span><br><span class="line">        msg.arg1 = startId;</span><br><span class="line">        msg.obj = intent;</span><br><span class="line">        mServiceHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        onStart(intent, startId);</span><br><span class="line">        <span class="keyword">return</span> mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mServiceLooper.quit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§è‡´çœ‹ä¸Šå»æ˜¯è¿™æ ·çš„: IntentServiceåœ¨å†…éƒ¨å»ºç«‹äº†ä¸€ä¸ªHandlerThreadï¼Œæ¯ä¸€ä¸ªè¢«å‘é€åˆ°Serviceçš„Handleréƒ½è¢«æŠ›åˆ°Handlerthreadä¸­æ‰§è¡Œï¼Œå›è°ƒæ–¹æ³•: onHandlerIntent()ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆè´´ä¸€ä¸‹ç±»çš„æ³¨é‡Š:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IntentService is a base class for &#123;<span class="doctag">@link</span> Service&#125;s that handle asynchronous</span></span><br><span class="line"><span class="comment"> * requests (expressed as &#123;<span class="doctag">@link</span> Intent&#125;s) on demand.  Clients send requests</span></span><br><span class="line"><span class="comment"> * through &#123;<span class="doctag">@link</span> android.content.Context#startService(Intent)&#125; calls; the</span></span><br><span class="line"><span class="comment"> * service is started as needed, handles each Intent in turn using a worker</span></span><br><span class="line"><span class="comment"> * thread, and stops itself when it runs out of work.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This "work queue processor" pattern is commonly used to offload tasks</span></span><br><span class="line"><span class="comment"> * from an application's main thread.  The IntentService class exists to</span></span><br><span class="line"><span class="comment"> * simplify this pattern and take care of the mechanics.  To use it, extend</span></span><br><span class="line"><span class="comment"> * IntentService and implement &#123;<span class="doctag">@link</span> #onHandleIntent(Intent)&#125;.  IntentService</span></span><br><span class="line"><span class="comment"> * will receive the Intents, launch a worker thread, and stop the service as</span></span><br><span class="line"><span class="comment"> * appropriate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;All requests are handled on a single worker thread -- they may take as</span></span><br><span class="line"><span class="comment"> * long as necessary (and will not block the application's main loop), but</span></span><br><span class="line"><span class="comment"> * only one request will be processed at a time.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;div class="special reference"&gt;</span></span><br><span class="line"><span class="comment"> * &lt;h3&gt;Developer Guides&lt;/h3&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For a detailed discussion about how to create services, read the</span></span><br><span class="line"><span class="comment"> * &lt;a href="&#123;<span class="doctag">@docRoot</span>&#125;guide/topics/fundamentals/services.html"&gt;Services&lt;/a&gt; developer guide.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/div&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> android.os.AsyncTask</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>æ³¨é‡Šé‡Œé¢æœ‰å‡ ä¸ªå¾ˆé‡è¦çš„ç‚¹:</p>
<ol>
<li>Clientæ˜¯é€šè¿‡startService(Intent)æ¥å‘Serviceå‘é€è¯·æ±‚çš„ï¼Œè¯·æ±‚è¢«åŒ…è£…åœ¨Intenté‡Œé¢ï¼›</li>
<li>åœ¨æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼ŒServiceä¼šè‡ªå·±å¯åŠ¨ï¼Œæ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™è‡ªå·±Stopï¼›</li>
<li>è¿™ä¸ªç±»å®ç°äº†æ‰€è°“çš„â€work queue processorâ€æ¨¡å¼ï¼Œç±»ä¼¼äºä¸»çº¿ç¨‹å¤„ç†æ¶ˆæ¯çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ä¸²è¡Œçš„æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼›</li>
<li>ä½¿ç”¨IntentServiceåªéœ€è¦ç»§æ‰¿è¯¥ç±»ï¼Œå¹¶å®ç°<code>onHandleIntent(Intent intent)</code>æ–¹æ³•å³å¯ï¼›</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å…³æ³¨å‡ ä¸ªé‡è¦çš„æ–¹æ³•:</p>
<ol>
<li><strong>onStartCommand():</strong> è¿™ä¸ªæ–¹æ³•æ¯æ¬¡åœ¨startService()æ–¹æ³•è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå®ƒå¯ä»¥æ ¹æ®ä¸€ä¸ªbooleanå€¼å†³å®šè¿”å›å€¼ï¼ˆè¿™é‡Œå¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹Serviceè¯¥æ–¹æ³•è¿”å›å€¼çš„å«ä¹‰ï¼Œå®ƒå†³å®šäº†Serviceè¢«æ€æ­»ä¹‹åå¦‚ä½•å¤è‹ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡setIntentRedelivery()æ–¹æ³•æ§åˆ¶è¿”å›å€¼ï¼›</li>
<li><strong>onStart():</strong> è¿™ä¸ªæ–¹æ³•åœ¨åŒ…è£…æ¶ˆæ¯çš„æ—¶å€™æ˜¯æŠŠstartIdåŒ…è£…åˆ°äº†æ¶ˆæ¯é‡Œé¢ã€‚è¿™ä¸ªstartIdå¾ˆæœ‰ç”¨ï¼Œå½±å“åˆ°äº†å‰é¢è¯´çš„ç¬¬2ç‚¹ï¼ˆè‡ªåŠ¨å¯åŠ¨ã€åœæ­¢ï¼‰çš„å®ç°ï¼›</li>
</ol>
<p>å…³äºstartIdçš„ç”¨å¤„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">However, <span class="function"><span class="keyword">if</span> your service handles multiple requests to <span class="title">onStartCommand</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">concurrently, then you shouldn't stop the service when you're done </span></span><br><span class="line"><span class="function">processing a start request, because you might have since received a new </span></span><br><span class="line"><span class="function">start <span class="title">request</span> <span class="params">(stopping at the end of the first request would terminate the </span></span></span><br><span class="line"><span class="function"><span class="params">second one)</span>. To avoid <span class="keyword">this</span> problem, you can use <span class="title">stopSelf</span><span class="params">(<span class="keyword">int</span>)</span> to ensure </span></span><br><span class="line"><span class="function">that your request to stop the service is always based on the most recent </span></span><br><span class="line"><span class="function">start request. That is, when you call <span class="title">stopSelf</span><span class="params">(<span class="keyword">int</span>)</span>, you pass the ID of the </span></span><br><span class="line"><span class="function">start <span class="title">request</span> <span class="params">(the startId delivered to onStartCommand()</span>) to which your </span></span><br><span class="line"><span class="function">stop request corresponds. Then <span class="keyword">if</span> the service received a new start request </span></span><br><span class="line"><span class="function">before you were able to call <span class="title">stopSelf</span><span class="params">(<span class="keyword">int</span>)</span>, then the ID will not match and </span></span><br><span class="line"><span class="function">the service will not stop.</span></span><br></pre></td></tr></table></figure>
<h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><ol>
<li>The IntentService internally handles the two start types <code>START_NOT_STICKY</code> and <code>START_REDELIVER_INTENT</code>. The first is default, so the latter needs to be set with <code>setIntentRedelivery(true)</code>.</li>
<li>There is no need to stop the IntentService with <code>stopSelf()</code>, because that is done internally.</li>
</ol>
<blockquote>
<p>BroadcastReceiverä¸­æœ‰ä¸€ä¸ª<code>BroadcastReceiver.goAsync()</code>æ–¹æ³•ï¼Œç”¨äºç»´æŒBroadcastReceiverçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Androidä¸Šä¸ºäº†å°†è€—æ—¶æ“ä½œå‰¥ç¦»å‡ºä¸»çº¿ç¨‹åšäº†å¾ˆå¤šçš„å·¥ä½œï¼Œä¸ºæ­¤ä¹Ÿä¸ºçº¿ç¨‹é—´è°ƒåº¦åšäº†å¾ˆå¤šçš„åŠªåŠ›ã€‚</p>
<p>æ‰€æœ‰çš„çº¿ç¨‹æ¶ˆæ¯è°ƒåº¦éƒ½æ˜¯åŸºäº<a href="http://www.muzileecoding.com/androidsource/Android-Handler.html" target="_blank" rel="noopener">Handleræœºåˆ¶</a>ï¼ŒAndroidè¿˜åŸºäºHandleråšäº†æ›´å¤šé«˜çº§çš„å°è£…ï¼Œæœ€ç»å…¸çš„å°±æ˜¯ <strong>AsyncTask</strong>ï¼Œè¿™äº›ç±»éƒ½æœ‰ç›¸ä¼¼çš„ç‰¹ç‚¹ï¼šçŸ­å°ç²¾æ‚ï¼Œä¾¿äºå¼€å‘ã€‚åŒæ—¶ä¹Ÿæ˜¯éå¸¸ä¸é”™çš„å­¦ä¹ ææ–™ã€‚</p>
<p>IntentServiceä¸“é—¨ç”¨äºå¤„ç†ä¸²è¡ŒåŒ–å¤„ç†ä»»åŠ¡ï¼Œä¸€æ—¦å¤æ‚æ€§è¶…è¿‡è¿™ç§éœ€æ±‚ï¼ŒIntentServiceå°±ä¸å¤§é€‚ç”¨äº†ï¼Œæ¯”å¦‚å¹¶å‘å¤„ç†ä»»åŠ¡ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidå¼€å‘ç¬”è®°]]></title>
      <url>http://www.timebridge.space/2016/02/22/Android-develop-note/</url>
      <content type="html"><![CDATA[<p><strong>ã€1ã€‘ç©ºæ ¼é—®é¢˜</strong><br>å¦‚ä½•åœ¨å­—ç¬¦ä¸²ä¸­æ·»åŠ æ­£ç¡®çš„ç©ºæ ¼ï¼Œé—®é¢˜æºè‡ªäºå¦‚ä½•æ·»åŠ ä¸€ä¸ªä¸­æ–‡ç©ºæ ¼ã€‚<br>æ–¹æ¡ˆ: <a href="http://stackoverflow.com/questions/1587056/android-string-concatenate-how-to-keep-the-spaces-at-the-end-and-or-beginnin" target="_blank" rel="noopener">StackOverFlow</a></p>
<p><strong>ã€2ã€‘No Debuggable Applications</strong><br>åœ¨Android Studioçš„èœå•æ ä¸­é€‰æ‹©Tools -&gt; Android -&gt; Enable ADB Integrationã€‚</p>
<p>PS:éœ€è¦å…³é—­DDMSã€‚<a id="more"></a></p>
<p>å…³äºåŸå› ï¼Œ<a href="http://stackoverflow.com/questions/9242148/what-is-the-purpose-of-tools-android-enable-adb-service" target="_blank" rel="noopener">StackoverFlowä¸Šè¿™ä¸ªé—®é¢˜</a>ä¸‹é¢æœ‰å›ç­”:</p>
<blockquote>
<p>The ADB (Andorid Debug Bridge) is a service that IDEA uses for debugging Android code on emulator or USB device. This service can be used by only one application in the same time. DDMS tool uses ADB too, so you need to disable ADB-IDEA connection if you want to use DDMS tool without closing IDEA. You wonâ€™t be able to debug Android applications in IDEA if this service is disabled, but note that if you try to launch debugging IDEA will notify you that ADB service is disabled and offer to enable it again. So there shouldnâ€™t be any problems after disabling this service. You just need to do it before launching DDMS.</p>
</blockquote>
<p><strong>ã€3ã€‘ç”Ÿå‘½å‘¨æœŸé—®é¢˜</strong>  </p>
<ol>
<li>Activityçš„<code>onCreate()</code>ä¼šè°ƒç”¨<code>mFragments.dispatchCreate()</code>;</li>
<li>Activityçš„<code>onStart()</code>ä¼šè°ƒç”¨<code>mFragments.dispatchActivityCreated()</code>ä»¥åŠ<code>mFragments.dispatchStart()</code>(å‰è€…ä¿è¯åªè°ƒç”¨ä¸€æ¬¡);</li>
<li>å†…å­˜ä¸è¶³å¯¼è‡´Activityè¢«å›æ”¶åï¼Œæ¢å¤çš„æ—¶å€™ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š<code>onCreate</code> -&gt; <code>onStart</code> -&gt; <code>onRestoreInstanceState</code> -&gt; <code>onActivityResult</code> -&gt; <code>onResume</code>;</li>
<li><code>onActivityResult</code>æ˜¯åœ¨<code>onResume</code>ä¹‹å‰è¢«è°ƒç”¨çš„ï¼Œè¿™ä¸€ç‚¹æ— è®ºæ˜¯ä¸æ˜¯æ•°æ®æ¢å¤ï¼Œéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤åœ¨æ•°æ®å›æ”¶çš„æƒ…å†µä¸‹ï¼Œå¦‚æœè¦åœ¨<code>onActivityResult</code>ä¸­ä½¿ç”¨<code>onResume</code>æ–¹æ³•å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œåˆ™åŠ¡å¿…è¦å°å¿ƒ â€”â€” StackOverFlowä¸Šæœ‰ä¸€ä¸ªé—®é¢˜<a href="http://stackoverflow.com/questions/6468319/onactivityresult-onresume" target="_blank" rel="noopener">onActivityResult() &amp; onResume()</a>ï¼Œå…³æ³¨ä¸€ä¸‹å…¶ä¸­çš„é«˜ç¥¨ç­”æ¡ˆ;</li>
</ol>
<p>ç¬¬ä¸‰ç‚¹ä¿è¯<code>onActivityResult</code>è°ƒç”¨çš„æ—¶å€™æ•°æ®éƒ½æ¢å¤æˆåº”æœ‰çš„æ ·å­äº†ã€‚</p>
<h4 id="æŒç»­æ›´æ–°Â·Â·Â·"><a href="#æŒç»­æ›´æ–°Â·Â·Â·" class="headerlink" title="æŒç»­æ›´æ–°Â·Â·Â·"></a><em>æŒç»­æ›´æ–°Â·Â·Â·</em></h4>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Groovy å®‰è£…å’Œ Eclipse æ’ä»¶å®‰è£…]]></title>
      <url>http://www.timebridge.space/2016/01/29/Groovy-install-and-ide-plugin/</url>
      <content type="html"><![CDATA[<h2 id="Groovyçš„å®‰è£…"><a href="#Groovyçš„å®‰è£…" class="headerlink" title="Groovyçš„å®‰è£…"></a>Groovyçš„å®‰è£…</h2><p>Groovyçš„å®‰è£…å¯ä»¥å‚è€ƒ<a href="http://www.groovy-lang.org/download.html" target="_blank" rel="noopener">å®˜ç½‘ä¸Šçš„æ•™ç¨‹</a>ï¼Œæˆ‘æ˜¯åœ¨Macä¸Šå®‰è£…çš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå·æ‡’çš„ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼š<strong>brew install groovy</strong>ã€‚</p>
<p>åœ¨æœ¬åœ°å®‰è£…åéœ€è¦é…ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡ï¼Œå°±å’ŒJavaä¸€æ ·ã€‚åœ¨å‘½ä»¤è¡Œé‡Œé¢æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<strong>vi ~/.bash_profile</strong>ã€‚å•ç‹¬åŠ å…¥å¦‚ä¸‹è¿™è¡Œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export GROOVY_HOME=/usr/local/opt/groovy/libexec</span><br></pre></td></tr></table></figure>
<p>ç„¶åé€€å‡ºä¿å­˜ï¼Œæ¥ç€æ‰§è¡Œ <strong>source ~/.bash_profile</strong> å³å¯ã€‚åœ¨å‘½ä»¤è¡Œé‡Œé¢è¾“å…¥ <strong>groovy -v</strong> å‘½ä»¤ï¼Œæœ‰ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Groovy Version: <span class="number">2.4</span>.3 JVM: <span class="number">1.6</span>.0_65 Vendor: Apple Inc. OS: Mac OS X</span><br></pre></td></tr></table></figure>
<p>å°±è¡¨ç¤ºå®‰è£…æˆåŠŸäº†ã€‚<a id="more"></a></p>
<h2 id="IDEçš„æ’ä»¶é›†æˆ"><a href="#IDEçš„æ’ä»¶é›†æˆ" class="headerlink" title="IDEçš„æ’ä»¶é›†æˆ"></a>IDEçš„æ’ä»¶é›†æˆ</h2><p>é¦–å…ˆè¯´æ˜ä¸¤ç‚¹:<br>1ï¼‰groovyè‡ªå·±æ˜¯æœ‰ä¸€ä¸ªç®€å•GUIç»„ä»¶å¯ä»¥å®ç°ç¼–ç çš„ï¼Œå¦‚æœæ€•éº»çƒ¦ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ–¹æ³•æ˜¯åœ¨å‘½ä»¤è¡Œé‡Œé¢æ‰§è¡Œ <strong>groovyConsole</strong> å‘½ä»¤ï¼Œä½ å°±å¯ä»¥çœ‹è§ä¸‹é¢çš„UIï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/GroovyGUI.png" alt="Groovyè‡ªå¸¦GUI"><br>è¿™ä¸ªç®€å•çš„ç¼–è¾‘å™¨åŸºæœ¬å¯ä»¥æ»¡è¶³è”ç³»çš„éœ€è¦ï¼Œä¸ŠåŠéƒ¨åˆ†æ˜¯ç¼–ç çš„ï¼Œä¸‹åŠéƒ¨åˆ†æ˜¯è¾“å‡ºï¼Œç¼–å†™å®Œæˆä¹‹åæ‰§è¡ŒCmd+Rå³å¯è¿è¡Œç¨‹åºã€‚å¦å¤–å­—ä½“ä¹Ÿå¯ä»¥æ”¾å¤§ç¼©å°ï¼Œè€ƒè™‘çš„è¿˜æ˜¯æ¯”è¾ƒå…¨é¢çš„ã€‚è¯»è€…å¯ä»¥ç ”ç©¶ä¸€ä¸‹èœå•æ ï¼Œå‘½ä»¤ä¸å¤šï¼Œå¯ä»¥å¾ˆå¿«çš„è¿‡ä¸€éï¼›<br>2ï¼‰è™½ç„¶å¹³æ—¶ä½¿ç”¨Intellijæ¯”è¾ƒå¤šï¼Œä½†è¿™é‡Œåªè®²ä¸€ä¸‹å¦‚ä½•åœ¨Eclipseä¸­é…ç½®æ’ä»¶ï¼ŒåŸå› æ˜¯æˆ‘å¯¹è¿™ä¸ªæ¯”è¾ƒç†Ÿæ‚‰ï¼›</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œå…ˆä¸è¦æ€¥ç€å»ä¸‹è½½Eclipseï¼ŒGroovyçš„å®‰è£…å¯¹Eclipseçš„ç‰ˆæœ¬æœ‰è¦æ±‚ã€‚æ’ä»¶æ˜¯ä¸€ä¸ª<a href="https://github.com/groovy/groovy-eclipse/wiki" target="_blank" rel="noopener">Githubé¡¹ç›®</a>ï¼Œå®ƒçš„<a href="https://github.com/groovy/groovy-eclipse/wiki" target="_blank" rel="noopener">Wiki</a>é‡Œé¢å†™äº†æ”¯æŒçš„Eclipseå’Œå¯¹åº”çš„æ’ä»¶ä¸‹è½½é“¾æ¥ï¼Œæ¯”å¦‚å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œå®ƒæœ€æ–°æ”¯æŒåˆ°4.4ï¼Œè€ŒEclipseå·²ç»åˆ°4.6äº†ï¼ŒWikié‡Œé¢æœ‰å¦‚ä¸‹æè¿°ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Eclipseå’ŒGroovyæ’ä»¶ç‰ˆæœ¬å¯¹åº”å›¾.png" alt="Eclipseå’ŒGroovyæ’ä»¶ç‰ˆæœ¬å¯¹åº”å›¾"><br>çœ‹ç€è¿™ä¸ªï¼Œå»ä¸‹è½½ä¸€ä¸ª4.4(Luna)ç‰ˆæœ¬çš„Eclipseå¹¶å®‰è£…å®Œæˆã€‚æ‰“å¼€Eclipseï¼Œåœ¨èœå•æ ä¸­ä¾æ¬¡ç‚¹å‡»ï¼šHelp-&gt;Install New Softwareâ€¦ï¼Œå°±çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Eclipseå®‰è£…Groovyæ’ä»¶.png" alt="Eclipseå®‰è£…Groovyæ’ä»¶"><br>ç‚¹å‡»Addï¼Œå¼¹å‡ºAdd Resposityæ¡†ï¼Œéšä¾¿å–ä¸€ä¸ªåå­—ï¼Œä¹‹åå°†å‰é¢è¡¨æ ¼ä¸­å¯¹åº”ç‰ˆæœ¬çš„æ’ä»¶ä¸‹è½½é“¾æ¥å¡«åˆ°Locationé‡Œé¢ï¼Œç‚¹å‡»OKï¼Œç‚¹å‡»Nextï¼Œåœ¨æ‹‰ä¸‹æ¥çš„ç»„ä»¶ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ˜¯Requiredï¼Œå…¶ä½™çš„å¯ä»¥ä¸é€‰ï¼Œä¹‹åä¸€è·¯Accept &amp; Nextï¼Œç›´åˆ°å®Œæˆå®‰è£…ã€‚</p>
<p>æœ€åEclipseä¼šè¦æ±‚é‡å¯ï¼Œé‡å¯ä¹‹åï¼Œæ’ä»¶å®‰è£…å®Œæˆã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Loader & LoaderManageræºç åˆ†æ]]></title>
      <url>http://www.timebridge.space/2015/12/17/Android-loader-and-loadermanager/</url>
      <content type="html"><![CDATA[<h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><p>ã€ç¯å¢ƒã€‘ä»£ç åˆ†æåŸºäº supportv4åŒ…ã€‚</p>
<h2 id="Loaderçš„ä»‹ç»å’Œä½¿ç”¨"><a href="#Loaderçš„ä»‹ç»å’Œä½¿ç”¨" class="headerlink" title="Loaderçš„ä»‹ç»å’Œä½¿ç”¨"></a>Loaderçš„ä»‹ç»å’Œä½¿ç”¨</h2><p>åŠ è½½å™¨: ç”¨äºåœ¨Activityå’ŒFragmentä¸­å¼‚æ­¥åŠ è½½æ•°æ®ï¼Œå®ƒæœ‰ä»¥ä¸‹ç‰¹æ€§:</p>
<ol>
<li><strong>å¼‚æ­¥æ•°æ®ç®¡ç†</strong> é™¤äº†å¯ä»¥å¼‚æ­¥åŠ è½½æ•°æ®ï¼Œè¿˜èƒ½åœ¨æ•°æ®æºæ›´æ–°çš„æ—¶å€™é€šçŸ¥ä¸Šå±‚;</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong> å’ŒActivityã€Fragmentçš„ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œåœ¨Activityçš„é…ç½®å˜åŒ–çš„æ—¶å€™ä»ç„¶èƒ½å¤Ÿç»§ç»­åœ¨åå°è¿è¡Œ;</li>
<li><strong>ç¼“å­˜æ•°æ®</strong> å¦‚æœæœ‰å¼‚æ­¥æ•°æ®æ— æ³•åˆ†å‘ï¼Œå®ƒå¯ä»¥ç¼“å­˜æ•°æ®ç›´åˆ°æœ‰æ¥æ”¶è€…å‡ºç°ï¼Œæ¯”å¦‚åœ¨Activityé‡å»ºæœŸé—´;</li>
<li><strong>é˜²æ­¢å†…å­˜æ³„éœ²</strong> ä¸ä¼šå½±å“Contextå¯¹è±¡çš„å›æ”¶ï¼Œå› ä¸ºå®ƒåªä¾èµ–äºApplication Context;</li>
</ol>
<p>è¯¦ç»†ä»‹ç»å’Œç”¨æ³•å¯ä»¥çœ‹<a href="http://developer.android.com/intl/zh-cn/guide/components/loaders.html" target="_blank" rel="noopener">å®˜ç½‘æ–‡æ¡£</a>ã€‚<a id="more"></a></p>
<blockquote>
<p>å¼€å‘å®˜ç½‘å·²ç»é€æ­¥å›½é™…åŒ–äº†ï¼Œç°åœ¨èƒ½çœ‹ä¸­æ–‡ç‰ˆå•¦ï¼Œå”¯ä¸€è¦æ±‚å°±æ˜¯ç¿»Â·ä¸ªÂ·å¢™ã€‚</p>
</blockquote>
<h2 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h2><p>æˆ‘ä»¬ä»ä½¿ç”¨ä»£ç åˆ‡å…¥ï¼Œè°ƒç”¨ä¸€ä¸ªLoaderåªéœ€è¦å¦‚ä¸‹ä»£ç å³å¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°çš„å…·ä½“ç±»å‹è§ä¸‹é¢çš„æ–¹æ³•</span></span><br><span class="line">getLoaderManager().initLoader(<span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹initLoaderï¼ˆä½äºLoaderManagerImplä¸­ï¼‰:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;D&gt; <span class="function">Loader&lt;D&gt; <span class="title">initLoader</span><span class="params">(<span class="keyword">int</span> id, Bundle args, LoaderManager.LoaderCallbacks&lt;D&gt; callback)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mCreatingLoader) &#123;<span class="comment">//è¡¨ç¤ºæ­£åœ¨åˆ›å»ºä¸­</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Called while creating a loader"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	LoaderInfo info = mLoaders.get(id);</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"initLoader in "</span> + <span class="keyword">this</span> + <span class="string">": args="</span> + args);</span><br><span class="line">	<span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Loader doesn't already exist; create.</span></span><br><span class="line">		info = createAndInstallLoader(id, args,  (LoaderManager.LoaderCallbacks&lt;Object&gt;)callback);</span><br><span class="line">		<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"  Created new loader "</span> + info);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"  Re-using existing loader "</span> + info);</span><br><span class="line">		info.mCallbacks = (LoaderManager.LoaderCallbacks&lt;Object&gt;)callback;</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//è¿™ä¸ªç‚¹è¦é¢å¤–æ³¨æ„: è¿™é‡Œå°±æ˜¯ä»å·²ç»å­˜åœ¨çš„Loaderä¸­è·å–æ•°æ®ï¼Œæ¯”å¦‚Activityé…ç½®å˜åŒ–çš„æ—¶å€™â€”â€”å®ç°äº†å‰é¢è¯´çš„ç¬¬ä¸‰ç‚¹ç‰¹æ€§ï¼Œæ•°æ®ç¼“å­˜ã€‚</span></span><br><span class="line">	<span class="keyword">if</span> (info.mHaveData &amp;&amp; mStarted) &#123;</span><br><span class="line">		<span class="comment">// If the loader has already generated its data, report it now.</span></span><br><span class="line">		info.callOnLoadFinished(info.mLoader, info.mData);</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">return</span> (Loader&lt;D&gt;)info.mLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹mLoaderså˜é‡:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> SparseArrayCompat&lt;LoaderInfo&gt; mLoaders = <span class="keyword">new</span> SparseArrayCompat&lt;LoaderInfo&gt;();</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ä¸ªä»idåˆ°LoaderInfoçš„æ˜ å°„ï¼Œä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„LoaderInfoï¼Œå°±createAndInstallLoaderï¼Œå¦åˆ™ï¼Œæ›´æ–°ä¸€ä¸‹callbackã€‚å¦‚æœLoadInfoè®°å½•è¿™ä¸ªLoaderå·²ç»å¯åŠ¨è¿è¡Œå¹¶ä¸”ä¿å­˜äº†ä¹‹å‰çš„æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè°ƒç”¨çš„æ˜¯LoadInfoçš„callOnLoadFinishedæ–¹æ³•ã€‚æœ€åè¿”å›åˆ›å»ºå‡ºæ¥çš„Loaderã€‚å¾ˆæ˜æ˜¾é‡ç‚¹åœ¨äºcreateAndInstallLoaderæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LoaderInfo <span class="title">createAndInstallLoader</span><span class="params">(<span class="keyword">int</span> id, Bundle args, LoaderManager.LoaderCallbacks&lt;Object&gt; callback)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		mCreatingLoader = <span class="keyword">true</span>;<span class="comment">//1. è®¾ç½®æ ‡å¿—</span></span><br><span class="line">		LoaderInfo info = createLoader(id, args, callback);<span class="comment">//2. åˆ›å»º</span></span><br><span class="line">		installLoader(info);<span class="comment">//3. install</span></span><br><span class="line">		<span class="keyword">return</span> info;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		mCreatingLoader = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè®¾ç½®äº†ä¸€ä¸ªæ ‡å¿—ä½mCreatingLoaderï¼Œè¡¨ç¤ºæ­£åœ¨åˆ›å»ºLoaderï¼Œæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºcreateå’Œinstallä¸¤æ­¥ã€‚</p>
<h3 id="Loaderçš„createè¿‡ç¨‹"><a href="#Loaderçš„createè¿‡ç¨‹" class="headerlink" title="Loaderçš„createè¿‡ç¨‹"></a>Loaderçš„createè¿‡ç¨‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LoaderInfo <span class="title">createLoader</span><span class="params">(<span class="keyword">int</span> id, Bundle args, LoaderManager.LoaderCallbacks&lt;Object&gt; callback)</span> </span>&#123;</span><br><span class="line">	LoaderInfo info = <span class="keyword">new</span> LoaderInfo(id, args, callback);</span><br><span class="line">	Loader&lt;Object&gt; loader = callback.onCreateLoader(id, args);</span><br><span class="line">	info.mLoader = loader;</span><br><span class="line">	<span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºè¿‡ç¨‹å¾ˆç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªLoaderInfoï¼Œä»å›è°ƒçš„onCreateLoaderä¸­è·å–å¯¹åº”çš„Loaderï¼Œå†å°†Loaderè®¾ç½®åˆ°LoaderInfoä¸­ï¼Œè¿™æ ·LoaderInfoå°†ä¿å­˜ç€æœ‰å…³Loaderçš„æ‰€æœ‰ä¿¡æ¯ï¼šidï¼Œargsä»¥åŠLoaderæœ¬èº«ã€‚</p>
<h3 id="Loaderçš„installè¿‡ç¨‹"><a href="#Loaderçš„installè¿‡ç¨‹" class="headerlink" title="Loaderçš„installè¿‡ç¨‹"></a>Loaderçš„installè¿‡ç¨‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installLoader</span><span class="params">(LoaderInfo info)</span> </span>&#123;</span><br><span class="line">	mLoaders.put(info.mId, info);</span><br><span class="line">	<span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">		<span class="comment">// The activity will start all existing loaders in it's onStart(),</span></span><br><span class="line">		<span class="comment">// so only start them here if we're past that point of the activitiy's</span></span><br><span class="line">		<span class="comment">// life cycle</span></span><br><span class="line">		info.start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå°†LoaderInfoä¿å­˜åˆ°mLoadersä¸­ï¼Œå¦‚æœå·²ç»startè¿‡äº†ï¼Œå°±è°ƒç”¨LoaderInfoçš„startæ–¹æ³•ã€‚æ³¨æ„æ–¹æ³•å†…éƒ¨è¿™æ®µæ³¨é‡Šï¼š<strong>Activityåœ¨onStart()æ–¹æ³•ä¸­ä¼šå¯åŠ¨æ‰€æœ‰çš„loadersï¼Œæ‰€ä»¥åªæœ‰åœ¨onStart()ä¹‹åè¿˜æ²¡æœ‰å¯åŠ¨çš„Loaderæ‰ä¼šåœ¨è¿™é‡Œå¯åŠ¨</strong>ã€‚</p>
<p>ä»å®˜ç½‘ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨initLoaderæ–¹æ³•å³å¯ï¼Œå¹¶ä¸éœ€è¦æ‰‹åŠ¨å¯åŠ¨åŠ è½½è¿‡ç¨‹ï¼Œå†åŠ ä¸Šä¸Šé¢çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹: Loaderçš„æ•°æ®åŠ è½½æ˜¯ç”±Activity/Fragmentçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å¯åŠ¨çš„ï¼Œä¸‹é¢å°±æ¥åˆ†æä¸€ä¸‹ã€‚</p>
<h3 id="Loaderçš„å¯åŠ¨è¿‡ç¨‹"><a href="#Loaderçš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="Loaderçš„å¯åŠ¨è¿‡ç¨‹"></a>Loaderçš„å¯åŠ¨è¿‡ç¨‹</h3><p>åœ¨supportv4çš„FragmentActivityä¸­ï¼ŒæŸ¥çœ‹å…¶onStartæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onStart();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//æœ€åä¸‰è¡Œä»£ç </span></span><br><span class="line">	mFragments.doLoaderStart();</span><br><span class="line"></span><br><span class="line">	mFragments.dispatchStart();</span><br><span class="line">	mFragments.reportLoaderStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mFragmentsæ˜¯FragmentManagerç±»å‹ï¼Œè¿™é‡Œå°±è°ƒç”¨äº†å®ƒçš„doLoaderStart()æ–¹æ³•â€”â€”è¿™é‡Œè¡¨æ˜ï¼š<strong>ä¸ºäº†Loaderåœ¨Activityå’ŒFragmentä¸­éƒ½èƒ½ä½¿ç”¨ï¼ŒåŒæ—¶é€»è¾‘ä¸€è‡´ï¼ŒLoaderæ˜¯é€šè¿‡FragmentManagerè¿›è¡Œç®¡ç†çš„ï¼ŒActivityåªæ˜¯å¼•ç”¨äº†FragmentManagerçš„å®ä¾‹ã€‚</strong></p>
<blockquote>
<p>ã€ç‰¹åˆ«æ³¨æ„ã€‘è¿™é‡Œè¿˜è°ƒç”¨äº†ä¸€ä¸ªå’ŒLoaderç›¸å…³çš„æ–¹æ³•:reportLoaderStartã€‚è¿™ä¸ªæ–¹æ³•åé¢è®²retainçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œæš‚æ—¶ä¸ç”¨å…³æ³¨ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹FragmentManagerçš„doLoaderStart()æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doLoaderStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mLoadersStarted) &#123;<span class="comment">//åªèƒ½Startä¸€æ¬¡</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mLoadersStarted = <span class="keyword">true</span>;<span class="comment">//æ ‡è®°å¼€å§‹</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mLoaderManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">		mLoaderManager.doStart();</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mCheckedForLoaderManager) &#123;</span><br><span class="line">		mLoaderManager = getLoaderManager(<span class="string">"(root)"</span>, mLoadersStarted, <span class="keyword">false</span>);</span><br><span class="line">		<span class="comment">// the returned loader manager may be a new one, so we have to start it</span></span><br><span class="line">		<span class="keyword">if</span> ((mLoaderManager != <span class="keyword">null</span>) &amp;&amp; (!mLoaderManager.mStarted)) &#123;</span><br><span class="line">			mLoaderManager.doStart();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	mCheckedForLoaderManager = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šåˆå§‹åŒ–LoaderManagerï¼Œå¹¶è°ƒç”¨å®ƒçš„doStart()æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Starting in "</span> + <span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">		RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">		e.fillInStackTrace();</span><br><span class="line">		Log.w(TAG, <span class="string">"Called doStart when already started: "</span> + <span class="keyword">this</span>, e);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//startä¹‹åå°±ä¼šè®¾ç½®æ ‡å¿—ä½ï¼Œè¿˜è®°å¾—å‰é¢LoaderManager.installLoaderæ–¹æ³•å¯¹è¿™ä¸ªå‚æ•°çš„ä½¿ç”¨ä¹ˆï¼Ÿ</span></span><br><span class="line">	mStarted = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Call out to sub classes so they can start their loaders</span></span><br><span class="line">	<span class="comment">// Let the existing loaders know that we want to be notified when a load is complete</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = mLoaders.size()-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">		mLoaders.valueAt(i).start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆçœ‹åˆ°äº†mStartedæ ‡å¿—ä½ï¼Œå¾ˆæ˜æ˜¾ï¼Œä¸€ä¸ªLoaderManagerå¯åŠ¨ä¸¤æ¬¡æ˜¯ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯çš„(ä¸ä¼šcrash)ã€‚ç„¶åéå†mLoadersä¸­çš„æ‰€æœ‰çš„LoaderInfoï¼Œè°ƒç”¨start()æ–¹æ³•å¯åŠ¨ã€‚</p>
<h3 id="åˆè§start-æ–¹æ³•"><a href="#åˆè§start-æ–¹æ³•" class="headerlink" title="åˆè§start()æ–¹æ³•"></a>åˆè§start()æ–¹æ³•</h3><p>å‰é¢çš„åˆ†æä¸­ï¼Œä¸è®ºLoaderæ˜¯åœ¨Activityçš„onStrat()æ–¹æ³•ä¹‹å‰è¿˜æ˜¯ä¹‹åè°ƒç”¨çš„ï¼Œæœ€ç»ˆå¯åŠ¨éƒ½æ˜¯è°ƒç”¨çš„Loaderçš„start()æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹LoaderInfoçš„start()æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//A</span></span><br><span class="line">	<span class="keyword">if</span> (mRetaining &amp;&amp; mRetainingStarted) &#123;</span><br><span class="line">		<span class="comment">// Our owner is started, but we were being retained from a</span></span><br><span class="line">		<span class="comment">// previous instance in the started state...  so there is really</span></span><br><span class="line">		<span class="comment">// nothing to do here, since the loaders are still started.</span></span><br><span class="line">		mStarted = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//B</span></span><br><span class="line">	<span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">		<span class="comment">// If loader already started, don't restart.</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mStarted = <span class="keyword">true</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"  Starting: "</span> + <span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">//Loaderä¸ºNullåˆ™å°è¯•å»åˆ›å»ºLoader</span></span><br><span class="line">	<span class="keyword">if</span> (mLoader == <span class="keyword">null</span> &amp;&amp; mCallbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">		mLoader = mCallbacks.onCreateLoader(mId, mArgs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (mLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mLoader.getClass().isMemberClass() &amp;&amp; !Modifier.isStatic(mLoader.getClass().getModifiers())) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Object returned from onCreateLoader must not be a non-static inner member class: "</span></span><br><span class="line">                            + mLoader);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!mListenerRegistered) &#123;</span><br><span class="line">			mLoader.registerListener(mId, <span class="keyword">this</span>);</span><br><span class="line">			mLoader.registerOnLoadCanceledListener(<span class="keyword">this</span>);</span><br><span class="line">			mListenerRegistered = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		mLoader.startLoading();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåœ¨è¿›å…¥æ­£å¸¸æµç¨‹ä¹‹å‰ä¼šåšä¸¤ä¸ªåˆ¤æ–­ï¼š</p>
<p><strong>Aå¤„</strong>  å¦‚æœä¸€ä¸ªLoaderInfoå·²ç»è¢«retainè¿‡ï¼Œä¸”retainä¹‹å‰å·²ç»startäº†ï¼Œåˆ™æ ‡è®°ä¸€ä¸‹mStartedä¸ºtrueï¼Œç›´æ¥è¿”å›(<strong>å…³äºretainçš„å«ä¹‰ï¼Œè§åé¢çš„è§£é‡Šï¼Œè¿™é‡Œä¸éœ€è¦çº ç»“ï¼ŒçŸ¥é“æœ‰è¿™ä¸ªæ¡ä»¶åˆ¤æ–­å°±å¥½</strong>)ï¼›<br><strong>Bå¤„</strong>  å¦‚æœLoaderå·²ç»å¯åŠ¨äº†ï¼Œä¸éœ€è¦æ‰“æ–­æˆ–è€…åšåˆ«çš„å¤„ç†ï¼Œç›´æ¥è¿”å›ï¼›  </p>
<p><strong>å¦‚æœLoaderæ˜¯æˆå‘˜ç±»ï¼Œå¹¶ä¸”ä¸æ˜¯staticçš„ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆè¿™é‡Œä¼šç›´æ¥æŠ›å¼‚å¸¸ï¼Œæ¯”handleræ›´åŠ ä¸¥å‰ï¼‰ã€‚</strong>ä¹‹ååœ¨Loaderä¸Šæ³¨å†Œç›‘å¬ï¼Œè¿™ä¸¤ä¸ªç›‘å¬æ˜¯OnLoadCompleteListenerå’ŒOnLoadCanceledListener(æ³¨: LoaderInfoç±»å®ç°äº†è¿™ä¸¤ä¸ªæ¥å£)ï¼Œåˆ†åˆ«ç›‘å¬åŠ è½½å®Œæˆå’ŒåŠ è½½å–æ¶ˆä¸¤ä¸ªäº‹ä»¶ã€‚æœ€åè°ƒç”¨Loaderçš„startLoadingæ–¹æ³•å¼€å§‹åŠ è½½ã€‚</p>
<h3 id="Loaderçš„loadè¿‡ç¨‹"><a href="#Loaderçš„loadè¿‡ç¨‹" class="headerlink" title="Loaderçš„loadè¿‡ç¨‹"></a>Loaderçš„loadè¿‡ç¨‹</h3><p>Loaderçš„startLoadingæ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startLoading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	mStarted = <span class="keyword">true</span>;</span><br><span class="line">	mReset = <span class="keyword">false</span>;</span><br><span class="line">	mAbandoned = <span class="keyword">false</span>;</span><br><span class="line">	onStartLoading();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subclasses must implement this to take care of loading their data,</span></span><br><span class="line"><span class="comment"> * as per &#123;<span class="doctag">@link</span> #startLoading()&#125;.  This is not called by clients directly,</span></span><br><span class="line"><span class="comment"> * but as a result of a call to &#123;<span class="doctag">@link</span> #startLoading()&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStartLoading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šä»£ç ï¼Œè®¾ç½®flagä¹‹åï¼ŒstartLoadingå°±è°ƒç”¨äº†onStartLoadingæ–¹æ³•ï¼Œæ ¹æ®æ³¨é‡Šï¼Œå­ç±»å¿…é¡»å®ç°è¿™ä¸ªæ–¹æ³•æ¥åŠ è½½æ•°æ®ã€‚Loaderæœ¬èº«æ˜¯ä¸€ä¸ªæ¥è¿‘æ¥å£çš„å…·ä½“ç±»ï¼Œå®é™…çš„ä»£ç é‡å¾ˆå°‘ï¼Œè¯»è€…å¯ä»¥å»çœ‹å®ƒçš„æºç ï¼Œä¸å‰é¢æåˆ°çš„å¼‚æ­¥è¿‡ç¨‹æ²¡æœ‰å…³ç³»ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆåŸå§‹çš„ç±»ï¼Œå®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ç±»æ˜¯<strong>AsyncTaskLoader</strong>ï¼Œå®ƒçš„æºç åˆ†æè§å¦å¤–ä¸€ç¯‡æ–‡ç« ã€‚</p>
<p>OKï¼Œåˆ°è¿™é‡Œï¼ŒLoaderçš„åˆå§‹åŒ–å’Œå¯åŠ¨åŠ è½½è¿‡ç¨‹å·²ç»è®²å®Œäº†ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨onStartLoading()ä¸­åŠ è½½æ•°æ®å³å¯ã€‚å…ˆä¸è¦å¥½å¥‡æ•°æ®æ€ä¹ˆæŠ›åˆ°è°ƒç”¨å±‚ï¼Œå‰é¢è¯´äº†ï¼Œå› ä¸ºLoaderå¾ˆåŸå§‹ï¼Œæ–¹æ³•ä¹‹é—´çš„å…³ç³»æ²¡æœ‰å»ºç«‹ï¼Œè¿™å—éœ€è¦å»AsyncTaskLoaderä¸­ä½“ç°ã€‚</p>
<h2 id="Loaderçš„åœæ­¢è¿‡ç¨‹"><a href="#Loaderçš„åœæ­¢è¿‡ç¨‹" class="headerlink" title="Loaderçš„åœæ­¢è¿‡ç¨‹"></a>Loaderçš„åœæ­¢è¿‡ç¨‹</h2><p>æœ‰äº†ä¸Šè¿°åˆ›å»ºå¯åŠ¨è¿‡ç¨‹ï¼Œåˆ†æåœæ­¢è¿‡ç¨‹çš„åˆ‡å…¥ç‚¹å°±æ¯”è¾ƒå¥½æ‰¾äº†ã€‚æ ¹æ®ç»éªŒï¼Œåœ¨Activityçš„onStart()æ–¹æ³•æœ‰åˆ›å»ºæ–¹æ³•ï¼Œåˆ™åœ¨å¯¹åº”çš„onStop()æ–¹æ³•ä¸­åº”è¯¥å°±åœæ­¢æ–¹æ³•ã€‚onStop()æ–¹æ³•æ¯”è¾ƒç»•ï¼Œä½†æ˜¯è¿½è¸ªä¸€ä¸‹ä¸éš¾å‘ç°æœ€ç»ˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onReallyStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	mFragments.doLoaderStop(mRetaining);</span><br><span class="line">	mFragments.dispatchReallyStop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±è°ƒç”¨äº†FragmentControllerçš„doLoaderStopæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doLoaderStop</span><span class="params">(<span class="keyword">boolean</span> retain)</span> </span>&#123;</span><br><span class="line">	mRetainLoaders = retain;</span><br><span class="line">	<span class="keyword">if</span> (mLoaderManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!mLoadersStarted) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	mLoadersStarted = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (retain) &#123;</span><br><span class="line">		mLoaderManager.doRetain();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mLoaderManager.doStop();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåœ¨LoaderManagerä¸ä¸ºnullä¸”å·²ç»å¯åŠ¨çš„æƒ…å†µä¸‹ï¼Œæ ¹æ®retainåˆ¤æ–­å†³å®šè°ƒç”¨LoaderManagerçš„æ–¹æ³•ã€‚</p>
<h3 id="Loaderçš„retainè¿‡ç¨‹"><a href="#Loaderçš„retainè¿‡ç¨‹" class="headerlink" title="Loaderçš„retainè¿‡ç¨‹"></a>Loaderçš„retainè¿‡ç¨‹</h3><p>retainæ˜¯ä»å¤–éƒ¨ä¼ å‡ºæ¥çš„ï¼ŒActivityæ­£å¸¸stopçš„æ—¶å€™ï¼Œè¿™ä¸ªå€¼ä¸ºfalseï¼Œä½†æ˜¯ä¸‹é¢æƒ…å†µæ˜¯trueçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">onRetainNonConfigurationInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">		doReallyStop(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//Â·Â·Â·Â·Â·</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤æ¯”å¦‚è½¬å±çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªæ˜¯åšretainï¼Œè€Œä¸æ˜¯stopã€‚LoaderInfoçš„retainæ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">retain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"  Retaining: "</span> + <span class="keyword">this</span>);</span><br><span class="line">	mRetaining = <span class="keyword">true</span>;</span><br><span class="line">	mRetainingStarted = mStarted;</span><br><span class="line">	mStarted = <span class="keyword">false</span>;</span><br><span class="line">	mCallbacks = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™è¾¹åªæ˜¯è¿™æ˜¯ä¸€äº›æ ‡å¿—ä½ã€‚å¹¶ä¸”å°†<strong>mCallbacksè®¾ç½®ä¸ºNull</strong>(é˜²æ­¢å†…å­˜æ³„éœ²)ã€‚è¿™è¾¹æ¶‰åŠåˆ°ä¸¤ä¸ªflagâ€”â€”mRetainingStartedå’ŒmStartedã€‚å‰é¢start()çš„æ—¶å€™ç”¨åˆ°äº†è¿™ä¸¤ä¸ªå‚æ•°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mRetaining &amp;&amp; mRetainingStarted) &#123;</span><br><span class="line">	mStarted = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¦ç»†çš„retainæƒ…å†µåé¢è¡¥å……ä»‹ç»ï¼Œäº†è§£ä¸»æµç¨‹çš„è¯åˆ°è¿™é‡Œå°±åŸºæœ¬å¯ä»¥äº†ã€‚</p>
<h3 id="Loaderçš„stopè¿‡ç¨‹"><a href="#Loaderçš„stopè¿‡ç¨‹" class="headerlink" title="Loaderçš„stopè¿‡ç¨‹"></a>Loaderçš„stopè¿‡ç¨‹</h3><p>LoaderManagerçš„doStopæ–¹æ³•æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Stopping in "</span> + <span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">if</span> (!mStarted) &#123;</span><br><span class="line">		RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">		e.fillInStackTrace();</span><br><span class="line">		Log.w(TAG, <span class="string">"Called doStop when not started: "</span> + <span class="keyword">this</span>, e);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = mLoaders.size()-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">		mLoaders.valueAt(i).stop();</span><br><span class="line">	&#125;</span><br><span class="line">	mStarted = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ²¡æœ‰startçš„æ—¶å€™ï¼Œæ˜¯ä¸å…è®¸æ‰§è¡Œstopçš„ï¼Œä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯(åŒæ ·ä¸ä¼šå¼•èµ·crash)ã€‚å¦åˆ™éå†æ‰€æœ‰çš„LoaderInfoï¼Œè°ƒç”¨stop()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œä¸‹é¢çš„æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"  Stopping: "</span> + <span class="keyword">this</span>);</span><br><span class="line">	mStarted = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (!mRetaining) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mLoader != <span class="keyword">null</span> &amp;&amp; mListenerRegistered) &#123;</span><br><span class="line">			<span class="comment">// Let the loader know we're done with it</span></span><br><span class="line">			mListenerRegistered = <span class="keyword">false</span>;</span><br><span class="line">			mLoader.unregisterListener(<span class="keyword">this</span>);</span><br><span class="line">			mLoader.unregisterOnLoadCanceledListener(<span class="keyword">this</span>);</span><br><span class="line">			mLoader.stopLoading();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ²¡æœ‰retainçš„æƒ…å†µä¸‹ï¼Œä¸»è¦æ˜¯å–æ¶ˆç›‘å¬å¹¶ä¸”è°ƒç”¨Loaderçš„stopLoadingæ–¹æ³•ï¼Œæ³¨æ„è¿™è¾¹è°ƒç”¨stopLoadingçš„æ¡ä»¶æ˜¯å¾ˆè‹›åˆ»çš„(PS: è¿™è¾¹è¿™ä¸ªå†™æ³•å¯èƒ½æœ‰äº›é—®é¢˜ï¼Œæ³¨å†ŒåŠ¨ä½œå’Œstopä¸åº”è¯¥æœ‰è¿™ä¹ˆå¼ºçš„å…³ç³»)ã€‚Loaderé‡Œé¢çš„stopæ–¹æ³•å¾ˆç®€å•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopLoading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	mStarted = <span class="keyword">false</span>;</span><br><span class="line">	onStopLoading();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subclasses must implement this to take care of stopping their loader,</span></span><br><span class="line"><span class="comment"> * as per &#123;<span class="doctag">@link</span> #stopLoading()&#125;.  This is not called by clients directly,</span></span><br><span class="line"><span class="comment"> * but as a result of a call to &#123;<span class="doctag">@link</span> #stopLoading()&#125;.</span></span><br><span class="line"><span class="comment"> * This will always be called from the process's main thread.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStopLoading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å’ŒstartLoading()å¾ˆåƒï¼ŒåŒæ ·å­ç±»éœ€è¦å»è¦†ç›–å®ç°onStopLoadingå®ŒæˆåŠ è½½ã€‚</p>
<h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><h3 id="Loaderçš„retainè¿‡ç¨‹-1"><a href="#Loaderçš„retainè¿‡ç¨‹-1" class="headerlink" title="Loaderçš„retainè¿‡ç¨‹"></a>Loaderçš„retainè¿‡ç¨‹</h3><p>å‰é¢è¯´startçš„æ—¶å€™ï¼Œç•™äº†ä¸€ä¸ªå’Œretainæœ‰å…³çš„æ–¹æ³•:reportLoaderStartï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åœ¨åšä»€ä¹ˆã€‚è¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨FragmentHostCallbackçš„reportLoaderStartæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportLoaderStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mAllLoaderManagers != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> N = mAllLoaderManagers.size();</span><br><span class="line">		LoaderManagerImpl loaders[] = <span class="keyword">new</span> LoaderManagerImpl[N];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=N-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">			loaders[i] = (LoaderManagerImpl) mAllLoaderManagers.valueAt(i);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">			LoaderManagerImpl lm = loaders[i];</span><br><span class="line">			lm.finishRetain();</span><br><span class="line">			lm.doReportStart();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¶‰åŠåˆ°mAllLoaderManagerså˜é‡ï¼Œå®ƒçš„å£°æ˜æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The loader managers for individual fragments [i.e. Fragment#getLoaderManager()] */</span></span><br><span class="line"><span class="keyword">private</span> SimpleArrayMap&lt;String, LoaderManager&gt; mAllLoaderManagers;</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸€ä¸ªä»Stringåˆ°LoaderManagerçš„æ˜ å°„ï¼Œå¦å¤–ä»å˜é‡åç§°å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œåº”è¯¥é›†åˆäº†å±äºActivityçš„æ‰€æœ‰çš„LoaderManagerã€‚æœç´¢å®ƒè¢«ä½¿ç”¨çš„åœ°æ–¹å¯ä»¥çœ‹åˆ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LoaderManagerImpl <span class="title">getLoaderManager</span><span class="params">(String who, <span class="keyword">boolean</span> started, <span class="keyword">boolean</span> create)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mAllLoaderManagers == <span class="keyword">null</span>) &#123;</span><br><span class="line">		mAllLoaderManagers = <span class="keyword">new</span> SimpleArrayMap&lt;String, LoaderManager&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	LoaderManagerImpl lm = (LoaderManagerImpl) mAllLoaderManagers.get(who);</span><br><span class="line">	<span class="keyword">if</span> (lm == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (create) &#123;</span><br><span class="line">			lm = <span class="keyword">new</span> LoaderManagerImpl(who, <span class="keyword">this</span>, started);</span><br><span class="line">			mAllLoaderManagers.put(who, lm);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		lm.updateHostController(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> lm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ˜¯ä»¥ä¸€ç§putIfAbsentçš„æ–¹å¼åœ¨åˆ›å»ºLoaderManagerImplï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åŒ…å†…å¯è§çš„ï¼Œæˆ‘åœ¨FragmentActivityå’ŒFragmentä¸­getSupportLoaderManageræ–¹æ³•å’ŒgetLoaderManageræ–¹æ³•ï¼Œå‘ç°æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•è·å–å±äºActivity/Fragmentçš„LoaderManagerã€‚è¯»è€…ç»†å¿ƒçš„è¯ï¼Œåº”è¯¥åœ¨doLoaderStartä¸­å°±æ³¨æ„åˆ°å®ƒäº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mLoaderManager = getLoaderManager(<span class="string">"(root)"</span>, mLoadersStarted, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨Fragmentä¸­ï¼Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨çš„åœ°æ–¹å°±æ›´å¤šäº†ï¼Œæ¯”å¦‚onStart()ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	mCalled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!mLoadersStarted) &#123;</span><br><span class="line">		mLoadersStarted = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (!mCheckedForLoaderManager) &#123;</span><br><span class="line">			mCheckedForLoaderManager = <span class="keyword">true</span>;</span><br><span class="line">			mLoaderManager = mHost.getLoaderManager(mWho, mLoadersStarted, <span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (mLoaderManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">			mLoaderManager.doStart();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€ŒmWhoçš„è®¾ç½®æ˜¯è¿™æ ·çš„ï¼Œå…¶å®å¯ä»¥è®¤ä¸ºæ˜¯Fragmentçš„ä¸€ä¸ªTag:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setIndex</span><span class="params">(<span class="keyword">int</span> index, Fragment parent)</span> </span>&#123;</span><br><span class="line">	mIndex = index;</span><br><span class="line">	<span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">		mWho = parent.mWho + <span class="string">":"</span> + mIndex;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mWho = <span class="string">"android:fragment:"</span> + mIndex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†å¾€ä¸Šå°±ä¸è¿½æº¯äº†ï¼Œæ€»ä¹‹æ¯ä¸€ä¸ªFragmentè‡ªèº«éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬æœ‰çš„mWhoï¼Œè€Œè¿™ä¸ªå‚æ•°åˆè¢«ç”¨æ¥æ ‡è¯†ä¸€ä¸ªLoaderManagerã€‚å› æ­¤è¿™é‡Œä¸éš¾çŒœæµ‹å‡ºLoaderå’ŒFragmentã€Activityçš„å…³ç³»:</p>
<p><strong>åœ¨ä¸€ä¸ªActivityä¸­ï¼Œå¯ä»¥æœ‰Nä¸ªFragmentï¼ŒActivityå’Œæ¯ä¸€ä¸ªFragmentéƒ½æœ‰è‡ªå·±çš„LoaderManagerï¼Œå…¶ä¸­Activityæ˜¯ä»¥(root)æ ‡è®°çš„(ä¸ºä»€ä¹ˆrootæ˜¯Activityçš„ï¼Ÿå¯ä»¥ä»FragmentActivityçš„onStartæ–¹æ³•çœ‹åˆ°ï¼Œæ˜¯å…ˆè°ƒç”¨doLoaderStartï¼Œä¸ç®¡onStartä¹‹å‰æ˜¯å¦è°ƒç”¨äº†getLoaderManagerï¼Œè¿™é‡Œéƒ½ä¼šå»ºç«‹ä¸€ä¸ªrootä¸ºæ ‡è®°çš„LoaderManagerï¼Œè¿™ä¸ªLoaderManagerå°±æ˜¯å±äºActivityçš„)ï¼ŒFragmentåˆ™æ˜¯ä»¥è‡ªå·±çš„mWhoå±æ€§æ ‡è®°çš„ï¼Œå®ƒä»¬éƒ½è¢«è®°å½•åœ¨FragmentHostCallbackçš„mAllLoaderManagerså±æ€§ä¸­(è¿™ä¸ªå±æ€§è¢«FragmentHostCallbackå¼•ç”¨ï¼ŒFragmentHostCallbackå±æ€§è¢«FragmentControllerå¼•ç”¨ï¼ŒFragmentControlleråˆè¢«FragmentActivityå¼•ç”¨)ã€‚</strong></p>
<p>è¯•æƒ³ä¸€ä¸‹ä¸€ä¸ªFragmentè¢«ç§»é™¤çš„è¿‡ç¨‹ï¼Ÿæ‰€æœ‰åœ¨å®ƒå†…éƒ¨è¢«åˆ›å»ºçš„Loaderéƒ½ä¼šè¢«é”€æ¯æ‰ï¼Œè€Œä¸ä¼šå½±å“åˆ°å…¶ä½™çš„Loaderã€‚</p>
<p>ä¸Šé¢è§£é‡Šäº†ä¸€ä¸‹æ‰€æœ‰çš„LoaderManageréƒ½è¢«mAllLoaderManagerså˜é‡ä½¿ç”¨ä¸€ä¸ªStringç´¢å¼•ç€ã€‚æˆ‘ä»¬å›åˆ°å‰é¢reportLoaderStartçš„ä»£ç ï¼Œå†è´´ä¸€ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportLoaderStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mAllLoaderManagers != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> N = mAllLoaderManagers.size();</span><br><span class="line">		LoaderManagerImpl loaders[] = <span class="keyword">new</span> LoaderManagerImpl[N];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=N-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">			loaders[i] = (LoaderManagerImpl) mAllLoaderManagers.valueAt(i);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">			LoaderManagerImpl lm = loaders[i];</span><br><span class="line">			lm.finishRetain();</span><br><span class="line">			lm.doReportStart();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéå†æ‰€æœ‰çš„LoaderManagerçš„å®ä¾‹ï¼Œè°ƒç”¨ä»–ä»¬çš„finishRetainå’ŒdoReportStartæ–¹æ³•ã€‚LoaderManagerå†å°†è¿™äº›åˆ†å‘åˆ°å“åº”çš„Loaderä¸­å»ã€‚LoaderInfoä¸­ä¸¤ä¸ªæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">finishRetain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mRetaining) &#123;</span><br><span class="line">		<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"  Finished Retaining: "</span> + <span class="keyword">this</span>);</span><br><span class="line">		mRetaining = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (mStarted != mRetainingStarted) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!mStarted) &#123;</span><br><span class="line">				<span class="comment">// This loader was retained in a started state, but</span></span><br><span class="line">				<span class="comment">// at the end of retaining everything our owner is</span></span><br><span class="line">				<span class="comment">// no longer started...  so make it stop.</span></span><br><span class="line">				stop();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mStarted &amp;&amp; mHaveData &amp;&amp; !mReportNextStart) &#123;</span><br><span class="line">		<span class="comment">// This loader has retained its data, either completely across</span></span><br><span class="line">		<span class="comment">// a configuration change or just whatever the last data set</span></span><br><span class="line">		<span class="comment">// was after being restarted from a stop, and now at the point of</span></span><br><span class="line"> 		<span class="comment">// finishing the retain we find we remain started, have</span></span><br><span class="line">		<span class="comment">// our data, and the owner has a new callback...  so</span></span><br><span class="line">		<span class="comment">// let's deliver the data now.</span></span><br><span class="line">		callOnLoadFinished(mLoader, mData);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mReportNextStart) &#123;</span><br><span class="line">			mReportNextStart = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">if</span> (mHaveData) &#123;</span><br><span class="line">				callOnLoadFinished(mLoader, mData);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>finishRetainçš„æ—¶å€™ï¼Œå¦‚æœä¹‹å‰retainäº†ï¼Œåˆ™åœæ­¢æ‰(mRetainingç½®ä¸ºtrue)ã€‚æ¥ä¸‹æ¥çš„åˆ¤æ–­æ¯”è¾ƒéš¾ä»¥ç†è§£ã€‚é¦–å…ˆæ˜ç¡®ä¸€ä¸‹mStartedå’ŒmRetainingStartedçš„å«ä¹‰: mStartedæ ‡è®°çš„æ˜¯å½“å‰Loaderæ˜¯å¦startçš„çŠ¶æ€ï¼Œè€ŒmRetainingStartedæ ‡è®°çš„æ˜¯Loaderåœ¨retainä¹‹å‰çš„startçŠ¶æ€ã€‚æ‰€ä»¥è¿™ä¸ªåˆ¤æ–­çš„å«ä¹‰æ˜¯ï¼Œå¦‚æœå½“å‰çš„startçŠ¶æ€å’Œretainä¹‹å‰çš„startçŠ¶æ€ä¸ä¸€è‡´ï¼Œä¸”å½“å‰çš„çŠ¶æ€æ˜¯æœªå¯åŠ¨çš„ï¼Œæ¢å¥è¯è¯´ï¼Œä¹‹å‰æ˜¯å¯åŠ¨çš„ï¼Œretainæ¢å¤ä¹‹ååˆä¸å¯åŠ¨äº†ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºè¿™ä¸ªLoaderä¸å†è¢«éœ€è¦äº†ï¼Œå› æ­¤ç›´æ¥stopæ‰â€”â€”è¯»è€…åº”å½“æ³¨æ„FragmentActivity.onStart()æ–¹æ³•é‡Œé¢doLoaderStart()å’ŒreportLoaderStart()æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼Œæ˜¯å…ˆå…¨éƒ¨å¯åŠ¨Loaderï¼Œå†reportçš„ã€‚</p>
<p>ä¹‹åï¼Œå¦‚æœLoaderå·²ç»å¼€å§‹äº†ï¼Œæ•°æ®ä¹Ÿæœ‰äº†ï¼Œè€Œä¸”callbackå·²ç»è¢«æ›´æ–°äº†(ç¯å¢ƒé‡å»º)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨callOnLoadFinishedåˆ†å‘æ•°æ®äº†ã€‚reportStartç±»ä¼¼ã€‚</p>
<blockquote>
<p>è¡¥å……ï¼šä»ä»£ç çœ‹ï¼Œå½“Fragmentçš„performDestroyViewæ–¹æ³•è¢«è°ƒç”¨ï¼Œå³Fragmentè¢«é”€æ¯çš„æ—¶å€™ï¼Œæ‰€æœ‰å±äºå®ƒçš„LoaderInfoçš„mReportNextStartéƒ½ä¼šè¢«æ ‡ä¸ºtrueï¼ŒreportStart()ä¹‹åéƒ½ä¼šè¢«æ ‡ä¸ºfalseï¼Œå½“ç„¶åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿæ˜¯falseã€‚</p>
</blockquote>
<p>callOnLoadFinishedä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callOnLoadFinished</span><span class="params">(Loader&lt;Object&gt; loader, Object data)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mCallbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">		String lastBecause = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mHost != <span class="keyword">null</span>) &#123;</span><br><span class="line">			lastBecause = mHost.mFragmentManager.mNoTransactionsBecause;</span><br><span class="line">			mHost.mFragmentManager.mNoTransactionsBecause = <span class="string">"onLoadFinished"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"  onLoadFinished in "</span> + loader + <span class="string">": "</span> + loader.dataToString(data));</span><br><span class="line">			<span class="comment">//åˆ†å‘æ•°æ®</span></span><br><span class="line"> 			mCallbacks.onLoadFinished(loader, data);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (mHost != <span class="keyword">null</span>) &#123;</span><br><span class="line">				mHost.mFragmentManager.mNoTransactionsBecause = lastBecause;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		mDeliveredData = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœmCallbacksä¸ä¸ºnullï¼Œé‚£ä¹ˆè°ƒç”¨å®ƒçš„onLoadFinishedåˆ†å‘æ•°æ®ã€‚</p>
<h3 id="Loaderçš„Restartè¿‡ç¨‹"><a href="#Loaderçš„Restartè¿‡ç¨‹" class="headerlink" title="Loaderçš„Restartè¿‡ç¨‹"></a>Loaderçš„Restartè¿‡ç¨‹</h3><p>Loaderçš„restartè¿‡ç¨‹æ˜¯é€šè¿‡<code>LoaderManager.restartLoader()</code>æ–¹æ³•å®ç°çš„ã€‚æ–¹æ³•æ³¨é‡Šä¸­è¯´ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªIDæŒ‡å‘çš„Loaderï¼Œå¦‚æœè¿™ä¸ªIDå·²ç»æœ‰ç»‘å®šçš„Loaderï¼Œé‚£ä¹ˆè¿™ä¸ªLoaderä¼šè¢«cancelã€stopæˆ–è€…destroyï¼Œç„¶åä½¿ç”¨æ–°çš„argumentsåˆ›å»ºä¸€ä¸ªLoaderã€‚è¿™å°±æ˜¯å®ƒä¸<code>LoaderManager.initLoader()</code>æ–¹æ³•çš„åŒºåˆ«â€”â€”<strong>ä¸å­˜åœ¨é‡ç”¨</strong>ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœåœ¨ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¹‹é—´ä½¿ç”¨ç¼“å­˜æ•°æ®(å³æ•°æ®ä¸ä¼šå˜åŒ–)ï¼Œåˆ™åº”è¯¥ä½¿ç”¨<code>LoaderManager.initLoader()</code>ï¼Œå¦‚æœå¯èƒ½å˜åŒ–ï¼Œåˆ™åº”è¯¥ä½¿ç”¨<code>LoaderManager.restartLoader()</code>æ–¹æ³•ã€‚</p>
<p>Restartè¿‡ç¨‹ä»<code>LoaderManager.restartLoader()</code>æ–¹æ³•åˆ‡å…¥å³å¯ï¼ŒåŸºäºå‰é¢çš„è§£é‡Šï¼Œçœ‹æ‡‚è¿™ä¸ªæ–¹æ³•å¹¶ä¸å›°éš¾ï¼Œå…¶ä¸­å¯ä»¥çœ‹åˆ°ä¸€äº›é‡è¦çš„æ–¹æ³•æ˜¯å¦‚ä½•è°ƒç”¨çš„ï¼Œæ¯”å¦‚ï¼šLoaderCallbacksçš„<code>onLoaderReset()</code>æ–¹æ³•ï¼ŒLoaderçš„<code>onAbandon()</code>æ–¹æ³•ã€‚è¯·è¯»è€…è‡ªè¡Œè§£æã€‚</p>
<h2 id="ä½¿ç”¨æ³¨æ„ç‚¹"><a href="#ä½¿ç”¨æ³¨æ„ç‚¹" class="headerlink" title="ä½¿ç”¨æ³¨æ„ç‚¹"></a>ä½¿ç”¨æ³¨æ„ç‚¹</h2><ol>
<li>å¯ä»¥é€šè¿‡<code>Loader.forceLoad()</code>æ–¹æ³•å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®ï¼Œæ•°æ®åŠ è½½å®Œæˆä¼šè°ƒç”¨<code>onLoadFinished()</code>å›è°ƒï¼Œä¹Ÿå¯ä»¥è°ƒç”¨<code>Loader.cancelLoad()</code>å–æ¶ˆå›è°ƒï¼Œå°†ä¸ä¼šå—åˆ°ä»»ä½•å›è°ƒ;</li>
<li>åœ¨Activityã€Fragmenté”€æ¯çš„æ—¶å€™æˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº†<code>LoaderManager.destroyLoader(id)</code>æ–¹æ³•çš„æ—¶å€™ï¼ŒLoaderä¼šè¢«é”€æ¯ï¼Œå›è°ƒæ–¹æ³•<code>onLoaderReset(Loader)</code>ä¼šè¢«è°ƒç”¨ï¼Œè¡¨ç¤ºæ•°æ®å¤±æ•ˆï¼Œéœ€è¦é‡ç½®;</li>
<li>å‰é¢è¯´äº†Loaderå¯ä»¥ç›‘æµ‹æ•°æ®çš„å˜åŒ–ï¼Œä½†æœ‰æ—¶å€™æ•°æ®å˜åŒ–è¿‡å¿«ï¼Œå¯¼è‡´UIæŒç»­åˆ·æ–°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•é™ä½åˆ·æ–°é¢‘ç‡: <code>setUpdateThrottle(long delayMs)</code>;</li>
</ol>
<p>Loaderæ•°æ®åŠ è½½ç›¸å…³æ–¹æ³•æ‰§è¡Œæµç¨‹å¦‚ä¸‹:<br><img src="http://7xktd8.com1.z0.glb.clouddn.com/Loaderæ•°æ®åŠ è½½.png" alt="Loaderæ•°æ®åŠ è½½"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šè§£æäº†Loaderæ˜¯å¦‚ä½•åˆå§‹åŒ–å¹¶å¯åŠ¨çš„ï¼Œæ•´ä¸ªæ•°æ®çš„åŠ è½½å’Œåœæ­¢åˆæ˜¯å¦‚ä½•ç»‘å®šåˆ°Activityå’ŒFragmentçš„ç”Ÿå‘½å‘¨æœŸçš„ã€‚</p>
<p>ç„¶è€ŒLoaderæœ¬èº«çš„ç”¨å¤„å¹¶ä¸å¤§ï¼Œå› ä¸ºLoaderæœ¬èº«æ²¡æœ‰ä»»ä½•çš„å¼‚æ­¥è°ƒåº¦ï¼Œç›´æ¥ä½¿ç”¨Loaderè¿›è¡Œå¼€å‘æ˜¾å¾—å¤ªè¿‡åŸå§‹ï¼Œå¼€å‘ä¸­ä¸€èˆ¬ä¼šä½¿ç”¨<strong>AsyncTaskLoader</strong>ã€‚AsyncTaskLoaderç»“åˆäº†<a href="http://www.muzileecoding.com/androidsource/Android-AsyncTask.html" target="_blank" rel="noopener">AsyncTask</a>å’ŒLoaderçš„æœºåˆ¶ï¼Œå°†æ•°æ®åŠ è½½æ–¹åˆ°äº†å¼‚æ­¥ä»»åŠ¡ä¸­(æºç é‡Œæ˜¯é€šè¿‡LoadTaskå®ç°çš„)ï¼Œå¹¶é‡æ–°å£°æ˜äº†ä¸€äº›å›è°ƒå‡½æ•°ï¼Œæœ‰åŠ›çš„æ”¯æŒäº†Activityå’ŒFragmentçš„å¼‚æ­¥åŠ è½½æ•°æ®ä»»åŠ¡ã€‚</p>
<blockquote>
<p><strong>AsyncTaskLoader</strong>å¹¶ä¸ä¾èµ–äºå¹³å°çš„AsyncTaskï¼Œå› ä¸ºå¹³å°çš„AsyncTaskå¹¶è¡Œæˆ–è€…ä¸²è¡Œæ‰§è¡Œä»»åŠ¡æ˜¯éšç€å¹³å°ç‰ˆæœ¬å˜åŒ–çš„ã€‚</p>
<p><strong>AsyncTaskLoader</strong>ä¼šå°½å¯èƒ½çš„å‡å°‘ä»»åŠ¡çš„æ•°é‡ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨<code>forceLoader()</code>æ–¹æ³•ï¼Œå‰é¢çš„ç›¸åŒä»»åŠ¡ä¼šè¢«å–æ¶ˆæ‰ï¼Œæ˜¯ä¸ä¼šæœ‰ä»»ä½•å›è°ƒçš„ã€‚</p>
</blockquote>
<p>å¯¹äºæ•°æ®åº“æŸ¥è¯¢ï¼ŒLoaderè¿˜æœ‰ä¸€ä¸ªå­ç±»å«åšï¼šCursorLoaderï¼Œè¯»è€…æœ‰å…´è¶£ä¹Ÿå¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚</p>
<h3 id="è‡ªå®šä¹‰Loader"><a href="#è‡ªå®šä¹‰Loader" class="headerlink" title="è‡ªå®šä¹‰Loader"></a>è‡ªå®šä¹‰Loader</h3><p>å¦‚æ€»ç»“æ‰€è¯´ï¼ŒLoaderæœ¬èº«çš„åŠŸèƒ½å¾ˆå¼±ï¼Œè™½ç„¶æœ‰AsyncTaskLoaderå’ŒCursorLoaderç­‰å…·ä½“ç±»æ”¯æŒï¼Œä½†æ˜¯å¼€å‘è€…ä»å¯èƒ½æœ‰éœ€æ±‚éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªLoaderï¼Œè¿™æ—¶å€™å‚è€ƒå®ç°å¦‚ä¸‹ç‰¹æ€§:</p>
<ol>
<li>Loaderçš„ç”Ÿå‘½å‘¨æœŸ;</li>
<li>åå°æ•°æ®åŠ è½½;</li>
<li>æ•°æ®ç®¡ç†;</li>
<li>å‘é€ç¼“å­˜ç»“æœ;</li>
</ol>
<p>Loaderçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è½®è½¬å¦‚ä¸‹:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/LoaderçŠ¶æ€.png" alt="LoaderçŠ¶æ€"><br>è¿™å…¶ä¸­æ¶‰åŠåˆ°ä¸€äº›é‡è¦æ–¹æ³•çš„å®ç°:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startLoading</span><span class="params">()</span> -&gt; <span class="keyword">void</span> <span class="title">onStartLoading</span><span class="params">()</span> <span class="keyword">void</span> <span class="title">stopLoading</span><span class="params">()</span> -&gt; <span class="keyword">void</span> <span class="title">onStopLoading</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> -&gt; <span class="keyword">void</span> <span class="title">onReset</span><span class="params">()</span><span class="keyword">void</span> <span class="title">abandon</span><span class="params">()</span> -&gt; <span class="keyword">void</span> <span class="title">onAbandon</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p>
<p>ä»¥åŠ<code>forceLoad ()</code>æ–¹æ³•çš„å®ç°ï¼Œè¿™äº›æ–¹æ³•åœ¨Loaderç±»ä¸­éƒ½æœ‰è¯¦ç»†çš„æ³¨é‡Šï¼Œå…·ä½“å®ç°å¯ä»¥å‚è€ƒæ³¨é‡Šä»¥åŠAsyncTaskLoaderçš„å®ç°ã€‚</p>
<h3 id="æ•°æ®ç®¡ç†"><a href="#æ•°æ®ç®¡ç†" class="headerlink" title="æ•°æ®ç®¡ç†"></a>æ•°æ®ç®¡ç†</h3><p>ç›‘æ§æ•°æ®å˜åŒ–çš„æ–¹å¼: </p>
<ol>
<li>ä½¿ç”¨Javaçš„Observableå’ŒObserver;</li>
<li>å¹¿æ’­å‘ŠçŸ¥;</li>
<li>FileObserverâ€”â€”ç›‘æ§ä¸€ä¸ªè·¯å¾„ä¸Šçš„æ–‡ä»¶å˜åŒ–;</li>
</ol>
<blockquote>
<p>PS: è‡ªå®šä¹‰çš„æ—¶å€™å¯ä»¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹AsyncTaskLoaderçš„å®ç°ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidé€‚é…ä¹‹UEDæ ‡æ³¨è½¬æ¢]]></title>
      <url>http://www.timebridge.space/2015/12/14/Android-adapt-ued-mark-convert/</url>
      <content type="html"><![CDATA[<p>é€‚é…åŸºç¡€çŸ¥è¯†å¯ä»¥å‚è§ï¼š<a href="http://blog.csdn.net/zhaokaiqiang1992/article/details/45419023" target="_blank" rel="noopener">ã€ŠAndroidå±å¹•é€‚é…å…¨æ”»ç•¥(æœ€æƒå¨çš„å®˜æ–¹é€‚é…æŒ‡å¯¼)ã€‹</a></p>
<p>å¦‚æœUEDå‡ºäº†ä¸€å¼ UIè®¾è®¡å›¾å¹¶æ ‡æ³¨äº†ç›¸åº”å…ƒç´ çš„å°ºå¯¸å’Œé—´è·pxå€¼ï¼Œä½œä¸ºAndroidå¼€å‘è€…ï¼Œå¦‚ä½•åœ¨ç¨‹åºä¸­å°†æ ‡æ³¨å€¼è½¬æ¢ä¸ºç›¸åº”çš„dpå€¼å‘¢ï¼Ÿ<a id="more"></a></p>
<h2 id="ç›®æ ‡æ•ˆæœ"><a href="#ç›®æ ‡æ•ˆæœ" class="headerlink" title="ç›®æ ‡æ•ˆæœ"></a>ç›®æ ‡æ•ˆæœ</h2><p>è¦ç¡®å®šè½¬æ¢çš„æ–¹æ³•ï¼Œé¦–å…ˆéœ€è¦æ˜ç¡®è½¬æ¢çš„æ•ˆæœã€‚</p>
<p><strong>åœ¨æ‰‹æœºä¸Šï¼Œæˆ‘ä»¬åº”å½“æ³¨é‡çš„æ˜¯å…ƒç´ çš„æ¨ªå‘æ’åˆ—ï¼Œè€Œéçºµå‘æ’åˆ—â€”â€”å…ƒç´ æ¨ªå‘åº”å½“ç­‰æ¯”ç¼©æ”¾ï¼Œçºµå‘å¯ä»¥é€‰æ‹©ä¸æ¨ªå‘ç­‰æ¯”ç¼©æ”¾æˆ–è€…ä¿æŒå›ºå®šå°ºå¯¸ã€‚</strong></p>
<p>å…ƒç´ æ¨ªå‘çš„ç­‰æ¯”ç¼©æ”¾æ˜¯æŒ‡ï¼šåŠ å…¥æ‰‹æœºAçš„å®½åº¦æ˜¯1080pxï¼Œå±å¹•ä¸Šæœ‰ä¸€æ¡çº¿çš„å®½åº¦æ˜¯540pxï¼Œé‚£ä¹ˆè¿™åŒæ ·â€œå°ºå¯¸â€çš„çº¿åœ¨å®½åº¦ä¸º540pxçš„å±å¹•ä¸Šå®½åº¦å°±åº”è¯¥ä¸º270pxã€‚è¿™ä¹Ÿæ­£æ˜¯Androidå¼•å…¥<a href="http://developer.android.com/intl/zh-cn/guide/practices/screens_support.html" target="_blank" rel="noopener">dp</a>çš„ç›®çš„:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/density-test-good.png" alt="DPå¯¹ä¸åŒåˆ†è¾¨ç‡å±å¹•çš„æ”¯æŒ"></p>
<p>è¿™å¼ å›¾éå¸¸ç»å…¸ï¼Œä½†æ˜¯æ³¨æ„ï¼ŒButtonçœ‹ä¸Šå»ä¸€æ ·å¤§å°çš„å‰ææ˜¯ï¼šå±å¹•çš„å®½åº¦æ˜¯ä¸€è‡´çš„ã€‚è€Œç°å®ç”Ÿæ´»ä¸­ï¼Œæ‰‹æœºçš„å®½åº¦å¾€å¾€æœ‰å·®å¼‚ï¼Œå› æ­¤åŒä¸€ä¸ªdpå€¼çš„å…ƒç´ åœ¨è¿™äº›æ‰‹æœºä¸Šæ˜¾ç¤ºå‡ºæ¥çš„ç‰©ç†å°ºå¯¸å¹¶ä¸ä¸€è‡´ï¼Œä½†æ˜¯å±å¹•æˆªå›¾ååœ¨Photoshopä¸Šæ‹‰è‡³åŒä¸€ä¸ªå®½åº¦ï¼Œå°±å¯ä»¥çœ‹å‡ºå°ºå¯¸æ˜¯åŒæ ·å¤§å°çš„ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦æ³¨é‡å…ƒç´ çš„æ¨ªå‘æ˜¾ç¤ºè€Œéçºµå‘ï¼Ÿå…ƒç´ æ¨ªå‘ç­‰æ¯”ç¼©æ”¾æœ‰åŠ©äºå…ƒç´ æ›´å¥½çš„æ’åˆ—ï¼Œé«˜åº¦ä¸ä¹‹ç­‰æ¯”ç¼©æ”¾å¯ä»¥ä½¿å¾—é•¿å®½æ¯”è¶Šå¤§çš„æ‰‹æœºåœ¨çºµå‘ä¸Šæ˜¾ç¤ºæ›´å¤šçš„å…ƒç´ ï¼Œä»è€Œä½“ç°å¤§å±æ‰‹æœºçš„ä¼˜åŠ¿ï¼Œè€Œä¸”æ‰‹æœºé¡µé¢çš„ä¸Šä¸‹æ»šåŠ¨æ˜¯éå¸¸è‡ªç„¶çš„æ“ä½œï¼Œæ‰€ä»¥ï¼Œæ³¨é‡å…ƒç´ æ¨ªå‘å¯ä»¥ä½¿åŒä¸€ä¸ªç•Œé¢åœ¨ä»»ä½•æ‰‹æœºä¸Šä½“éªŒæ›´å¥½ã€‚</p>
<h2 id="è½¬æ¢æ–¹å¼"><a href="#è½¬æ¢æ–¹å¼" class="headerlink" title="è½¬æ¢æ–¹å¼"></a>è½¬æ¢æ–¹å¼</h2><p>ç¡®å®šæ•ˆæœçš„ç›®çš„ä¸€æ–¹é¢æ˜¯ç¡®ç«‹è½¬æ¢ç›®æ ‡ï¼Œä¸€æ–¹é¢ä¹Ÿæ˜¯ä¸‹é¢è½¬æ¢çš„å‰æï¼š<strong>æˆ‘ä»¬å°†æ³¨é‡å…ƒç´ çš„æ¨ªå‘æ¯”ä¾‹æ‹‰ä¼¸ã€‚</strong></p>
<p>OKï¼Œæˆ‘ä»¬çœ‹å¦‚ä½•è½¬æ¢UEDçš„è§†è§‰æ ‡æ³¨ï¼Œæ‰èƒ½å¾—åˆ°åˆç†çš„dpå€¼ã€‚è¿™é‡Œéœ€è¦å¦å¤–å‡è®¾å¾ˆå¤šçš„å˜é‡ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<ol>
<li>å‡è®¾UEDå‡ºçš„è§†è§‰ç¨¿å®½åº¦æ˜¯Spxï¼Œæœ‰ä¸€ä¸ªæ ‡æ³¨æ˜¯ B pxï¼ŒUEDçš„è¿™ä»½è§†è§‰ç¨¿ä½¿ç”¨çš„dpiæ˜¯ P dpiï¼Œå³ä¸€è‹±å¯¸é‡Œé¢æœ‰ P ä¸ªåƒç´ ã€‚</li>
<li>å‡è®¾æˆ‘ä»¬å¼€å‘çš„æ‰‹æœºå®½åº¦æ˜¯Apxï¼Œå±å¹•å¯†åº¦æ˜¯Dï¼Œå³dpi=160Dï¼Œæˆ‘ä»¬ä»æ ‡æ³¨è½¬æ¢è¿‡æ¥çš„å€¼æ˜¯Xï¼Œå³æœ€ç»ˆå†™å…¥ç¨‹åºçš„æ˜¯ X dpï¼Œå³æœ€ç»ˆå±å¹•ä¸Šæ˜¾ç¤ºå‡ºæ¥çš„æ˜¯XDä¸ªåƒç´ ã€‚</li>
</ol>
</blockquote>
<p>åŸºäºä»¥ä¸Šå‡è®¾å’Œç›®æ ‡ï¼Œæˆ‘ä»¬æƒ³è±¡ï¼Œå°†æˆ‘ä»¬å†™å‡ºçš„ç•Œé¢(ä¸ºäº†ä¾¿äºæƒ³è±¡ï¼Œå‡è®¾æ ‡æ³¨æ˜¯ç”¨äºä¸€ä¸ªå…ƒç´ çš„å®½åº¦)ç­‰æ¯”ä¾‹ç¼©æ”¾ï¼Œå’ŒUEDå‡ºçš„è§†è§‰å›¾é‡å ï¼Œæ ¹æ®æ•ˆæœï¼Œæ­¤æ—¶å…ƒç´ çš„å®½åº¦ä¸UEDè§†è§‰ç¨¿ä¸Šçš„å®½åº¦åº”è¯¥å®Œå…¨ä¸€è‡´ã€‚æ ¹æ®å‡è®¾å€¼ï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹å‚æ•°:</p>
<ol>
<li>è®¾è®¡è§†è§‰ç¨¿çš„ç‰©ç†å®½åº¦ï¼šS/Pâ€”â€”è®°ä¸ºMï¼›</li>
<li>è®¾è®¡è§†è§‰ç¨¿ä¸Šå…ƒç´ çš„ç‰©ç†å®½åº¦ï¼šB/Pâ€”â€”è®°ä¸ºNï¼›</li>
<li>å®é™…è¿è¡Œç¨‹åºçš„æ‰‹æœºå±å¹•ç‰©ç†å®½åº¦ï¼šA/160Dâ€”â€”è®°ä¸ºXï¼›<ol>
<li>å®é™…è¿è¡Œç¨‹åºçš„æ‰‹æœºä¸Šå…ƒç´ çš„ç‰©ç†å®½åº¦ï¼šXD/160Dâ€”â€”è®°ä¸ºYï¼›</li>
</ol>
</li>
</ol>
<p>æ ¹æ®ç›®æ ‡ï¼Œåº”è¯¥æœ‰ <strong>N/Y=M/X</strong> ï¼ŒåŒ–ç®€åå¯ä»¥å¾—åˆ° <strong>X = AB/DS</strong>â€”â€”è¿™å°±æ˜¯æˆ‘ä»¬åº”å½“æ­£ç¡®å†™å…¥ç¨‹åºçš„dpå€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸ç¨‹åºå®é™…è¿è¡Œæ‰‹æœºå®½åº¦ã€å±å¹•å¯†åº¦ã€è§†è§‰ç¨¿è®¾è®¡æ‰€ç”¨å®½åº¦ä»¥åŠæ ‡æ³¨å€¼ç›¸å…³çš„å˜é‡ã€‚</p>
<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><p>æ ¹æ®ä¸Šé¢çš„å…¬å¼ï¼Œå®éªŒç»“æœæ˜¯ç¬¦åˆçš„ã€‚ä½†æ˜¯è¿™å››ä¸ªå˜é‡çš„ç»„åˆéå¸¸å¥‡æ€ªï¼Œå¦‚æœè¯´æœ€ç»ˆå€¼ä¸æ ‡æ³¨å€¼ç›¸å…³ï¼Œé‚£æ˜¯ç†æ‰€å½“ç„¶çš„ï¼Œä½†æ˜¯æ€ä¹ˆä¼šå’Œå±å¹•å¯†åº¦æœ‰å…³(dpå€¼ä¸å°±æ˜¯ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ä¹ˆ?)ï¼Œè¿˜å’Œè§†è§‰ç¨¿è®¾è®¡æ‰€ç”¨å®½åº¦ã€æ‰‹æœºå®½åº¦ç›¸å…³ï¼Ÿæ‰‹æœºå®½åº¦è¿˜æ˜¯ä¸€ä¸ªä¸ç¡®å®šå€¼ï¼</p>
<p>å®é™…ä¸Šè§†è§‰ç¨¿æ‰€ç”¨å®½åº¦å¹¶ä¸ä¼šå½±å“æœ€ç»ˆçš„è®¡ç®—ï¼Œå› ä¸ºè¿™ä¸ªå€¼çš„æ¯”ä¾‹å˜åŒ–ä¼šå’Œæ ‡æ³¨å€¼ç›¸æŠµæ¶ˆã€‚è®¾æƒ³è®¾è®¡å¸ˆåœ¨ä¸€ä¸ª1000pxå®½åº¦çš„è§†è§‰ç¨¿ä¸Šç”»ä¸€æ¡å æ»¡åŠå±å¹•çš„çº¿ï¼Œéœ€è¦500pxï¼Œå› æ­¤ä»–çš„æ ‡æ³¨ä¹Ÿæ˜¯500pxï¼Œé‚£ä¹ˆåœ¨500pxçš„å±å¹•ä¸Šå‘¢ï¼Ÿä»–ä¼šæ ‡æ³¨250pxï¼Œä¸€èˆ¬å…¬å¸é‡Œé¢å‡ºè§†è§‰ç¨¿ï¼Œè§†è§‰ç¨¿å®½åº¦å€¼æ˜¯å›ºå®šçš„ï¼š640pæˆ–è€…720pï¼Œå› æ­¤æœ€ç»ˆå€¼ç¡®å®å’Œè§†è§‰ç¨¿æ‰€ç”¨å®½åº¦æœ‰å…³ï¼Œå¦å¤–ä¹Ÿå¯ä»¥çŸ¥é“B/Så®é™…ä¸Šæ˜¯è¿™ä¸ªå…ƒç´ çš„å®½åº¦ä¸å±å¹•å®½åº¦çš„æ¯”ä¾‹ã€‚</p>
<p>é™¤å»Bå’ŒSï¼ŒA(å¼€å‘çš„æ‰‹æœºå®½åº¦åƒç´ å€¼)å’ŒD(å±å¹•å¯†åº¦)åˆæ€ä¹ˆè§£é‡Šå‘¢ï¼Ÿæ ¹æ®å‰é¢çš„ç»“è®ºï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å…¬å¼: <strong>B/S=XD/A</strong> ã€‚å‰é¢è¯´äº†B/Sçš„å«ä¹‰ï¼ŒXDåˆ™æ˜¯å…ƒç´ å®é™…æ˜¾ç¤ºçš„ç‰©ç†å°ºå¯¸ï¼ŒAæ˜¯æ‰‹æœºå®é™…çš„ç‰©ç†å®½åº¦ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¯”å±•ç°çš„å°±æ˜¯æˆ‘ä»¬ä¹‹å‰çš„ç›®æ ‡ã€‚</p>
<p>é—®é¢˜æ¥äº†ï¼ŒAB/DSåˆ°åº•æ€ä¹ˆç®—ï¼Ÿå®é™…ä¸ŠBå’ŒSå¾ˆå®¹æ˜“å¾—åˆ°ï¼ŒBæ˜¯æ ‡æ³¨ï¼ŒSä¸€èˆ¬ä¸º640æˆ–è€…720ï¼ŒAå’ŒDå´ä¸€ç›´åœ¨å˜åŒ–ï¼Œ<strong>BUTï¼ï¼!</strong> å®ƒä»¬çš„æ¯”å´ç›¸å¯¹å›ºå®šâ€”â€”ç›®å‰ä¸»æµæ‰‹æœº(ä¸‰æ˜Ÿã€å°ç±³ã€ä¸­å…´ç­‰)è¿™ä¸¤ä¸ªå€¼åŸºæœ¬æ˜¯(720,2)æˆ–è€…(1080,3)çš„é…æ¯”ï¼Œé™¤ä¸€ä¸‹å¾ˆå®¹æ˜“å¾—åˆ°360è¿™ä¸ªç»“æœï¼ˆNexus 5ä¹Ÿæ˜¯è¿™ä¸ªå€¼ï¼‰ï¼Œéƒ¨åˆ†æ‰‹æœºåœ¨æ­¤ä¸Šä¸‹æµ®åŠ¨ï¼ˆæ¯”å¦‚é­…æ—ï¼Œ383ï¼‰ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¦‚æœUEDå‡ºå›¾çš„æ ‡å‡†å®½åº¦æ˜¯720pxï¼Œå¾ˆå®¹æ˜“å¾—åˆ° <strong>X = 0.5B</strong> è¿™ä¸ªç»“æœï¼Œå³å°†UEDçš„æ ‡æ³¨é™¤ä»¥2å°±å¯ä»¥äº†ï¼Œå¦‚æœæ˜¯640pxï¼Œåˆ™éœ€è¦ä¹˜ä»¥1.125æ‰èƒ½å¾—åˆ°æ­£ç¡®çš„å€¼ã€‚</p>
<blockquote>
<p>å¤‡æ³¨: å¾ˆå¤šæ‰‹æœºçš„ppiå®é™…ä¸Šä¸æ˜¯160çš„æ•´æ•°å€ï¼Œä¹Ÿä¸æ˜¯x.5å€ï¼Œåœ¨å®˜ç½‘ä¸Šï¼Œhdpiã€mdpiã€xhdpiç­‰çš„å®šä¹‰æ˜¯å¯¹åº”ä¸€ä¸ªèŒƒå›´çš„ï¼Œæ‰‹æœºç³»ç»Ÿåœ¨è¿™é‡Œä¼šåšä¸€ä¸ªæ¢ç®—ï¼Œä½¿å¾—ä»æ‰‹æœºä¸Šè·å–çš„å±å¹•å¯†åº¦å€¼åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæ•´æ•°æˆ–è€…x.5å€¼ï¼Œæ¯”å¦‚2.0ï¼Œ3.0ï¼Œ1.5ã€‚æ¯”å¦‚æˆ‘çš„Nexus 5æ‰‹æœºï¼Œå±å¹•å¯†åº¦æ˜¯3.0ï¼Œå®é™…çš„ppiæ˜¯445ï¼Œå¹¶ä¸æ˜¯160 * 3.0 = 480ppiã€‚</p>
</blockquote>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>720pçš„å›¾æ ‡æ³¨é™¤ä»¥2ï¼Œ640pçš„åˆ™è¿˜è¦ä¹˜ä»¥1.125ï¼Œå…¬å¸UEDä¸€ç›´æœ‰è¿™ä¸ªâ€å¥‡æ€ªâ€çš„è§„å®šï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä»–ä»¬å¹¶ä¸é€‚ç”¨ã€‚ä»¥ä¸Šåˆ†æå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªç»“è®ºæ˜¯åŸºäºä¸€äº›äº‹å®çš„ï¼Œå½“A/Dä¸æ˜¯360å¹¶ä¸”æµ®åŠ¨æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè¿™ä¸ªè§„åˆ™å°±ä¸å†æˆç«‹ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JavaåŠ¨æ€ä»£ç†å®ç°]]></title>
      <url>http://www.timebridge.space/2015/12/13/dynamic-proxy/</url>
      <content type="html"><![CDATA[<p>æœ¬æ–‡æ•´ç†è‡ªã€ŠThinking In Javaã€‹å’Œ IBM æŠ€æœ¯åšå®¢<a href="https://www.ibm.com/developerworks/cn/java/j-lo-proxy1/" target="_blank" rel="noopener">Java åŠ¨æ€ä»£ç†æœºåˆ¶åˆ†æåŠæ‰©å±•</a>ï¼Œå¯¹åŠ¨æ€ç±»çš„ç”Ÿæˆéƒ¨åˆ†åšäº†è¡¥å……ã€‚<a id="more"></a></p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>ä¾‹å­æ¥è‡ªã€ŠThinking In Javaã€‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MethodSelector</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">     <span class="keyword">private</span> Object proxied;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">MethodSelector</span><span class="params">(Object proxied)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.proxied = proxied;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">          <span class="keyword">if</span>(method.getName().equals(<span class="string">"interesting"</span>))</span><br><span class="line">               print(<span class="string">"Proxy detected the interesting method"</span>);</span><br><span class="line">          <span class="keyword">return</span> method.invoke(proxied, args);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SomeMethods</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">boring1</span><span class="params">()</span></span>;</span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">boring2</span><span class="params">()</span></span>;</span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">interesting</span><span class="params">(String arg)</span></span>;</span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">boring3</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Implementation</span> <span class="keyword">implements</span> <span class="title">SomeMethods</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boring1</span><span class="params">()</span> </span>&#123; print(<span class="string">"boring1"</span>); &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boring2</span><span class="params">()</span> </span>&#123; print(<span class="string">"boring2"</span>); &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interesting</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">          print(<span class="string">"interesting "</span> + arg);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boring3</span><span class="params">()</span> </span>&#123; print(<span class="string">"boring3"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SelectingMethods</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">          SomeMethods proxy= (SomeMethods)Proxy.newProxyInstance(</span><br><span class="line">               SomeMethods.class.getClassLoader(),</span><br><span class="line">               <span class="keyword">new</span> Class[]&#123; SomeMethods.class &#125;,</span><br><span class="line">               <span class="keyword">new</span> MethodSelector(<span class="keyword">new</span> Implementation()));</span><br><span class="line">          proxy.boring1();</span><br><span class="line">          proxy.boring2();</span><br><span class="line">          proxy.interesting(<span class="string">"bonobo"</span>);</span><br><span class="line">          proxy.boring3();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡º</span></span><br><span class="line">boring1</span><br><span class="line">boring2</span><br><span class="line">Proxy detected the interesting method</span><br><span class="line">interesting bonobo</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œé‡ç‚¹å°±åœ¨äºInvocationHandlerçš„å®ç°ã€‚è¿™é‡Œå¯ä»¥å¯¹æ–¹æ³•çš„è°ƒç”¨åšå‡ºè½¬å‘ï¼Œå¾ˆåƒAPOï¼Ÿ</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="åˆ†æå‰æ"><a href="#åˆ†æå‰æ" class="headerlink" title="åˆ†æå‰æ"></a>åˆ†æå‰æ</h3><p>ã€ç¯å¢ƒã€‘JDK 1.6<br>ã€ä»£ç ã€‘<a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b27/java/lang/reflect/Proxy.java#Proxy.newProxyInstance%28java.lang.ClassLoader%2Cjava.lang.Class%5B%5D%2Cjava.lang.reflect.InvocationHandler%29" target="_blank" rel="noopener">Proxy.java</a></p>
<h3 id="ä»£ç†æœºåˆ¶åŠå…¶ç‰¹ç‚¹"><a href="#ä»£ç†æœºåˆ¶åŠå…¶ç‰¹ç‚¹" class="headerlink" title="ä»£ç†æœºåˆ¶åŠå…¶ç‰¹ç‚¹"></a>ä»£ç†æœºåˆ¶åŠå…¶ç‰¹ç‚¹</h3><p>é¦–å…ˆè®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ Java åŠ¨æ€ä»£ç†ã€‚å…·ä½“æœ‰å¦‚ä¸‹å››æ­¥éª¤ï¼š</p>
<ol>
<li>é€šè¿‡å®ç° InvocationHandler æ¥å£åˆ›å»ºè‡ªå·±çš„è°ƒç”¨å¤„ç†å™¨ï¼›</li>
<li>é€šè¿‡ä¸º Proxy ç±»æŒ‡å®š ClassLoader å¯¹è±¡å’Œä¸€ç»„ interface æ¥åˆ›å»ºåŠ¨æ€ä»£ç†ç±»ï¼›</li>
<li>é€šè¿‡åå°„æœºåˆ¶è·å¾—åŠ¨æ€ä»£ç†ç±»çš„æ„é€ å‡½æ•°ï¼Œå…¶å”¯ä¸€å‚æ•°ç±»å‹æ˜¯è°ƒç”¨å¤„ç†å™¨æ¥å£ç±»å‹ï¼›</li>
<li>é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å®ä¾‹ï¼Œæ„é€ æ—¶è°ƒç”¨å¤„ç†å™¨å¯¹è±¡ä½œä¸ºå‚æ•°è¢«ä¼ å…¥ï¼›</li>
</ol>
<p>è€Œå®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦åšå¦‚ä¸‹ä¸¤æ­¥:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InvocationHandlerImpl å®ç°äº† InvocationHandler æ¥å£ï¼Œå¹¶èƒ½å®ç°æ–¹æ³•è°ƒç”¨ä»ä»£ç†ç±»åˆ°å§”æ‰˜ç±»çš„åˆ†æ´¾è½¬å‘</span></span><br><span class="line">InvocationHandler handler = <span class="keyword">new</span> InvocationHandlerImpl(..); </span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ Proxy ç›´æ¥åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å®ä¾‹</span></span><br><span class="line">Interface proxy = (Interface)Proxy.newProxyInstance( classLoader, <span class="keyword">new</span> Class[] &#123; Interface.class &#125;, handler );</span><br></pre></td></tr></table></figure>
<h3 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜ å°„è¡¨ï¼šç”¨äºç»´æŠ¤ç±»è£…è½½å™¨å¯¹è±¡åˆ°å…¶å¯¹åº”çš„ä»£ç†ç±»ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map loaderToCache = <span class="keyword">new</span> WeakHashMap(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è®°ï¼šç”¨äºæ ‡è®°ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»æ­£åœ¨è¢«åˆ›å»ºä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object pendingGenerationMarker = <span class="keyword">new</span> Object(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒæ­¥è¡¨ï¼šè®°å½•å·²ç»è¢«åˆ›å»ºçš„åŠ¨æ€ä»£ç†ç±»ç±»å‹ï¼Œä¸»è¦è¢«æ–¹æ³• isProxyClass è¿›è¡Œç›¸å…³çš„åˆ¤æ–­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map proxyClasses = Collections.synchronizedMap(<span class="keyword">new</span> WeakHashMap()); </span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³è”çš„è°ƒç”¨å¤„ç†å™¨å¼•ç”¨</span></span><br><span class="line"><span class="keyword">protected</span> InvocationHandler h;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»£ç†ç±»å®ä¾‹åŒ–æ„å»ºå‚æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Class[] constructorParams =</span><br><span class="line">        &#123; InvocationHandler.class &#125;;</span><br></pre></td></tr></table></figure>
<p>ç”±å˜é‡å¯ä»¥çŒœæµ‹ï¼Œä»£ç†çš„åˆ›å»ºè¿‡ç¨‹ä¸­æ˜¯ä½¿ç”¨äº†å¾ˆå¤šçš„ç¼“å­˜çš„ã€‚</p>
<h3 id="é™æ€æ„é€ æ–¹æ³•"><a href="#é™æ€æ„é€ æ–¹æ³•" class="headerlink" title="é™æ€æ„é€ æ–¹æ³•"></a>é™æ€æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, </span></span></span><br><span class="line"><span class="function"><span class="params">            Class&lt;?&gt;[] interfaces, </span></span></span><br><span class="line"><span class="function"><span class="params">            InvocationHandler h)</span> </span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IllegalArgumentException </span>&#123; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ h ä¸ä¸ºç©ºï¼Œå¦åˆ™æŠ›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (h == <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å¾—ä¸åˆ¶å®šç±»è£…è½½å™¨å’Œä¸€ç»„æ¥å£ç›¸å…³çš„ä»£ç†ç±»ç±»å‹å¯¹è±¡</span></span><br><span class="line">    Class cl = getProxyClass(loader, interfaces); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡åå°„è·å–æ„é€ å‡½æ•°å¯¹è±¡å¹¶ç”Ÿæˆä»£ç†ç±»å®ä¾‹</span></span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">        Constructor cons = cl.getConstructor(constructorParams); </span><br><span class="line">        <span class="keyword">return</span> (Object) cons.newInstance(<span class="keyword">new</span> Object[] &#123; h &#125;); </span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString()); </span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString()); </span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString()); </span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString()); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯è°ƒç”¨getProxyClassæ–¹æ³•è·å–ä¸€ä¸ªclï¼Œç„¶åé€šè¿‡åå°„åˆ›å»ºå‡ºä»£ç†ç±»çš„å®ä¾‹ã€‚å¾ˆæ˜æ˜¾ï¼Œæ ¸å¿ƒåœ¨äºgetProxyClassåˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</p>
<h3 id="getProxyClassæ–¹æ³•"><a href="#getProxyClassæ–¹æ³•" class="headerlink" title="getProxyClassæ–¹æ³•"></a>getProxyClassæ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œåˆ†ä¸ºå››ä¸ªä¸»ä½“éƒ¨åˆ†:</p>
<p>ã€1ã€‘å¯¹è¿™ç»„æ¥å£è¿›è¡Œä¸€å®šç¨‹åº¦çš„å®‰å…¨æ£€æŸ¥ï¼ŒåŒ…æ‹¬æ£€æŸ¥æ¥å£ç±»å¯¹è±¡æ˜¯å¦å¯¹ç±»è£…è½½å™¨å¯è§å¹¶ä¸”ä¸ç±»è£…è½½å™¨æ‰€èƒ½è¯†åˆ«çš„æ¥å£ç±»å¯¹è±¡æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œè¿˜ä¼šæ£€æŸ¥ç¡®ä¿æ˜¯ interface ç±»å‹è€Œä¸æ˜¯ class ç±»å‹ã€‚è¿™ä¸ªæ­¥éª¤é€šè¿‡ä¸€ä¸ªå¾ªç¯æ¥å®Œæˆï¼Œæ£€æŸ¥é€šè¿‡åå°†ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ¥å£åç§°çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œè®°ä¸º String[] interfaceNamesã€‚æ€»ä½“ä¸Šè¿™éƒ¨åˆ†å®ç°æ¯”è¾ƒç›´è§‚ï¼Œæ‰€ä»¥ç•¥å»å¤§éƒ¨åˆ†ä»£ç ï¼Œä»…ä¿ç•™ç•™å¦‚ä½•åˆ¤æ–­æŸç±»æˆ–æ¥å£æ˜¯å¦å¯¹ç‰¹å®šç±»è£…è½½å™¨å¯è§çš„ç›¸å…³ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">    <span class="comment">// æŒ‡å®šæ¥å£åå­—ã€ç±»è£…è½½å™¨å¯¹è±¡ï¼ŒåŒæ—¶åˆ¶å®š initializeBoolean ä¸º false è¡¨ç¤ºæ— é¡»åˆå§‹åŒ–ç±»</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ–¹æ³•è¿”å›æ­£å¸¸è¿™è¡¨ç¤ºå¯è§ï¼Œå¦åˆ™ä¼šæŠ›å‡º ClassNotFoundException å¼‚å¸¸è¡¨ç¤ºä¸å¯è§</span></span><br><span class="line">    interfaceClass = Class.forName(interfaceName, <span class="keyword">false</span>, loader); </span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ç›®çš„æ˜¯ä¿è¯ä»£ç†ç±»åˆ›å»ºçš„æ—¶å€™ï¼Œå’Œå®ƒæ‰€æœ‰éœ€è¦ä»£ç†çš„æ¥å£éƒ½åœ¨ä¸€ä¸ªClassLoaderä¸Šå¯è§ã€‚å¹¶ä¸”ç¦æ­¢ä¼ å…¥ç±»ï¼ˆåé¢è§£é‡Šï¼‰ï¼Œç¦æ­¢é‡å¤ä¼ å…¥ã€‚</p>
<p>ã€2ã€‘ä» loaderToCache æ˜ å°„è¡¨ä¸­è·å–ä»¥ç±»è£…è½½å™¨å¯¹è±¡ä¸ºå…³é”®å­—æ‰€å¯¹åº”çš„ç¼“å­˜è¡¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å­˜è¡¨å¹¶æ›´æ–°åˆ° loaderToCacheã€‚ç¼“å­˜è¡¨æ˜¯ä¸€ä¸ª HashMap å®ä¾‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹å®ƒå°†å­˜æ”¾é”®å€¼å¯¹ï¼ˆæ¥å£åå­—åˆ—è¡¨ï¼ŒåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ç±»å¯¹è±¡å¼•ç”¨ï¼‰ã€‚å½“ä»£ç†ç±»æ­£åœ¨è¢«åˆ›å»ºæ—¶å®ƒä¼šä¸´æ—¶ä¿å­˜ï¼ˆæ¥å£åå­—åˆ—è¡¨ï¼ŒpendingGenerationMarkerï¼‰ã€‚æ ‡è®° pendingGenerationMarke (å…¶å®æ˜¯ä¸€ä¸ªå¯¹è±¡)çš„ä½œç”¨æ˜¯é€šçŸ¥åç»­çš„åŒç±»è¯·æ±‚ï¼ˆæ¥å£æ•°ç»„ç›¸åŒä¸”ç»„å†…æ¥å£æ’åˆ—é¡ºåºä¹Ÿç›¸åŒï¼‰ä»£ç†ç±»æ­£åœ¨è¢«åˆ›å»ºï¼Œè¯·ä¿æŒç­‰å¾…ç›´è‡³åˆ›å»ºå®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ä»¥æ¥å£åå­—åˆ—è¡¨ä½œä¸ºå…³é”®å­—è·å¾—å¯¹åº” cache å€¼</span></span><br><span class="line">    Object value = cache.get(key); </span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Reference) &#123; </span><br><span class="line">        proxyClass = (Class) ((Reference) value).get(); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (proxyClass != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»åˆ›å»ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> proxyClass; </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value == pendingGenerationMarker) &#123; </span><br><span class="line">        <span class="comment">// ä»£ç†ç±»æ­£åœ¨è¢«åˆ›å»ºï¼Œä¿æŒç­‰å¾…</span></span><br><span class="line">        <span class="keyword">try</span> &#123; </span><br><span class="line">            cache.wait(); </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// ç­‰å¾…è¢«å”¤é†’ï¼Œç»§ç»­å¾ªç¯å¹¶é€šè¿‡äºŒæ¬¡æ£€æŸ¥ä»¥ç¡®ä¿åˆ›å»ºå®Œæˆï¼Œå¦åˆ™é‡æ–°ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">continue</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="comment">// æ ‡è®°ä»£ç†ç±»æ­£åœ¨è¢«åˆ›å»º</span></span><br><span class="line">        cache.put(key, pendingGenerationMarker); </span><br><span class="line">        <span class="comment">// break è·³å‡ºå¾ªç¯å·²è¿›å…¥åˆ›å»ºè¿‡ç¨‹</span></span><br><span class="line">        <span class="keyword">break</span>; </span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>ã€3ã€‘åŠ¨æ€åˆ›å»ºä»£ç†ç±»çš„ç±»å¯¹è±¡ã€‚é¦–å…ˆæ˜¯ç¡®å®šä»£ç†ç±»æ‰€åœ¨çš„åŒ…ï¼Œå…¶åŸåˆ™å¦‚å‰æ‰€è¿°ï¼Œå¦‚æœéƒ½ä¸º public æ¥å£ï¼Œåˆ™åŒ…åä¸ºç©ºå­—ç¬¦ä¸²è¡¨ç¤ºé¡¶å±‚åŒ…ï¼›å¦‚æœæ‰€æœ‰é public æ¥å£(packageå¯è§)éƒ½åœ¨åŒä¸€ä¸ªåŒ…ï¼Œåˆ™åŒ…åä¸è¿™äº›æ¥å£çš„åŒ…åç›¸åŒï¼›å¦‚æœæœ‰å¤šä¸ªé public æ¥å£ä¸”ä¸åŒåŒ…ï¼Œåˆ™æŠ›å¼‚å¸¸ç»ˆæ­¢ä»£ç†ç±»çš„ç”Ÿæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">String proxyPkg = <span class="keyword">null</span>;     <span class="comment">// package to define proxy class in</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Record the package of a non-public proxy interface so that the</span></span><br><span class="line"><span class="comment">	 * proxy class will be defined in the same package.  Verify that</span></span><br><span class="line"><span class="comment">	 * all non-public proxy interfaces are in the same package.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> flags = interfaces[i].getModifiers();</span><br><span class="line">		<span class="keyword">if</span> (!Modifier.isPublic(flags)) &#123;</span><br><span class="line">			String name = interfaces[i].getName();</span><br><span class="line">			<span class="keyword">int</span> n = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">			String pkg = ((n == -<span class="number">1</span>) ? <span class="string">""</span> : name.substring(<span class="number">0</span>, n + <span class="number">1</span>));</span><br><span class="line">			<span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">				proxyPkg = pkg;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pkg.equals(proxyPkg)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"non-public interfaces from different packages"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;     <span class="comment">// if no non-public proxy interfaces,</span></span><br><span class="line">		proxyPkg = <span class="string">""</span>;          <span class="comment">// use the unnamed package</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>ç¡®å®šäº†åŒ…åï¼Œå°±å¼€å§‹ç”Ÿæˆä»£ç†ç±»çš„ç±»åï¼ŒåŒæ ·å¦‚å‰æ‰€è¿°æŒ‰æ ¼å¼â€œ$ProxyNâ€ç”Ÿæˆã€‚ç±»åä¹Ÿç¡®å®šäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§è¯å¥‡è¿¹çš„å‘ç”Ÿ â€”â€” åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Choose a name for the proxy class to generate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">long</span> num;</span><br><span class="line"><span class="keyword">synchronized</span> (nextUniqueNumberLock) &#123;</span><br><span class="line">	num = nextUniqueNumber++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String proxyName = proxyPkg + proxyClassNamePrefix + num;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Verify that the class loader hasn't already</span></span><br><span class="line"><span class="comment"> * defined a class with the chosen name.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Generate the specified proxy class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	proxyClass = defineClass0(loader, proxyName,</span><br><span class="line">	proxyClassFile, <span class="number">0</span>, proxyClassFile.length);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment"> 	 * A ClassFormatError here means that (barring bugs in the</span></span><br><span class="line"><span class="comment"> 	 * proxy class generation code) there was some other</span></span><br><span class="line"><span class="comment"> 	 * invalid aspect of the arguments supplied to the proxy</span></span><br><span class="line"><span class="comment"> 	 * class creation (such as virtual machine limitations</span></span><br><span class="line"><span class="comment"> 	 * exceeded).</span></span><br><span class="line"><span class="comment">  	 */</span></span><br><span class="line"> 	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé€šè¿‡proxyPkg + proxyClassNamePrefix + numæ‹¼æ¥å‡ºä»£ç†ç±»çš„åå­—ï¼Œä¸€èˆ¬proxyPkgä¸ºç©ºï¼ŒproxyClassNamePrefixæ˜¯ä¸€ä¸ªfinalå­—ç¬¦ä¸²â€$Proxyâ€ï¼Œnumåˆ™æ˜¯ä¸€ä¸ªé€’å¢æ•°å­—ï¼Œå¯ä»¥çœ‹åšæ˜¯åˆ›å»ºçš„ç¬¬Nä¸ªä»£ç†ç±»ã€‚æœ€åè°ƒç”¨ProxyGeneratorçš„generateProxyClassç”Ÿæˆä»£ç†ç±»çš„byte[]æ•°ç»„ï¼Œä»¥ä¸€ä¸ªnativeæ–¹æ³•defineClass0ç”Ÿæˆæœ€ç»ˆçš„ä»£ç†ç±»classå¯¹è±¡ã€‚</p>
<p>ã€4ã€‘ä»£ç ç”Ÿæˆè¿‡ç¨‹è¿›å…¥ç»“å°¾éƒ¨åˆ†ï¼Œæ ¹æ®ç»“æœæ›´æ–°ç¼“å­˜è¡¨ï¼Œå¦‚æœæˆåŠŸåˆ™å°†ä»£ç†ç±»çš„ç±»å¯¹è±¡å¼•ç”¨æ›´æ–°è¿›ç¼“å­˜è¡¨ï¼Œå¦åˆ™æ¸…æ¥šç¼“å­˜è¡¨ä¸­å¯¹åº”å…³é”®å€¼ï¼Œæœ€åå”¤é†’æ‰€æœ‰å¯èƒ½çš„æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We must clean up the "pending generation" state of the proxy</span></span><br><span class="line"><span class="comment"> * class cache entry somehow.  If a proxy class was successfully</span></span><br><span class="line"><span class="comment"> * generated, store it in the cache (with a weak reference);</span></span><br><span class="line"><span class="comment"> * otherwise, remove the reserved entry.  In all cases, notify</span></span><br><span class="line"><span class="comment"> * all waiters on reserved entries in this cache.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">synchronized</span> (cache) &#123;</span><br><span class="line">	<span class="keyword">if</span> (proxyClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">		cache.put(key, <span class="keyword">new</span> WeakReference(proxyClass));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		cache.remove(key);</span><br><span class="line">	&#125;</span><br><span class="line">	cache.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå››æ­¥å±•ç°äº†åˆ›å»ºä¸€ä¸ªä»£ç†ç±»çš„ä¸»ä½“ï¼Œåˆ°ç°åœ¨åªå‰©ä¸‹ProxyGeneratoræœªæè¿°äº†ã€‚<br>åœ¨IBMçš„åŸåšå®¢ä¸­è¯´:</p>
<blockquote>
<p>å½“ä½ å°è¯•å»æ¢ç´¢è¿™ä¸ªç±»æ—¶ï¼Œä½ æ‰€èƒ½è·å¾—çš„ä¿¡æ¯ä»…ä»…æ˜¯å®ƒä½äºå¹¶æœªå…¬å¼€çš„ sun.misc åŒ…ï¼Œæœ‰è‹¥å¹²å¸¸é‡ã€å˜é‡å’Œæ–¹æ³•ä»¥å®Œæˆè¿™ä¸ªç¥å¥‡çš„ä»£ç ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œä½†æ˜¯ sun å¹¶æ²¡æœ‰æä¾›æºä»£ç ä»¥ä¾›ç ”è¯»ã€‚</p>
</blockquote>
<p>ä½†æ˜¯åˆ°æˆ‘å†™è¿™ç¯‡åšå®¢çš„æ—¶å€™ï¼ŒProxyGenerator.javaå·²ç»å¯ä»¥çœ‹åˆ°äº†ï¼Œå¯ä»¥åœ¨è¿™é‡Œ<a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b27/sun/misc/ProxyGenerator.java#ProxyGenerator" target="_blank" rel="noopener">ä¸‹è½½</a>ã€‚</p>
<h2 id="ProxyGeneratorç±»"><a href="#ProxyGeneratorç±»" class="headerlink" title="ProxyGeneratorç±»"></a>ProxyGeneratorç±»</h2><h3 id="generateProxyClassæ–¹æ³•"><a href="#generateProxyClassæ–¹æ³•" class="headerlink" title="generateProxyClassæ–¹æ³•"></a>generateProxyClassæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateProxyClass(<span class="keyword">final</span> String name, Class[] interfaces) &#123;</span><br><span class="line">ProxyGenerator gen = <span class="keyword">new</span> ProxyGenerator(name, interfaces);</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">byte</span>[] classFile = gen.generateClassFile();</span><br><span class="line"><span class="comment">//...çœç•¥ï¼Œè¿™é‡Œæ˜¯å°†byteæŒä¹…åŒ–ã€‚</span></span><br></pre></td></tr></table></figure>
<p>ç»§ç»­è¿½è¸ªgenerateClassFileæ–¹æ³•ã€‚</p>
<h3 id="generateClassFileæ–¹æ³•"><a href="#generateClassFileæ–¹æ³•" class="headerlink" title="generateClassFileæ–¹æ³•"></a>generateClassFileæ–¹æ³•</h3><p>ä»æ–¹æ³•åå­—å¯ä»¥çŒœå‡ºï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºç”Ÿæˆä¸€ä¸ªClasså¯¹è±¡ã€‚è¿™ä¸ªæ–¹æ³•ä¹Ÿéå¸¸é•¿ï¼Œåˆ†ä¸º3æ­¥ã€‚</p>
<p>ã€1ã€‘æ”¶é›†åˆ›å»ºClasså¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ProxyMethodå¯¹è±¡ï¼Œä»¥ä¾¿äºåé¢ç”Ÿæˆä»£ç†ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">addProxyMethod(hashCodeMethod, Object.class);</span><br><span class="line">addProxyMethod(equalsMethod, Object.class);</span><br><span class="line">addProxyMethod(toStringMethod, Object.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</span><br><span class="line">	Method[] methods = interfaces[i].getMethods();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; methods.length; j++) &#123;</span><br><span class="line">		addProxyMethod(methods[j], interfaces[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</span><br><span class="line">	checkReturnTypes(sigmethods);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ äº†Objectçš„åŸºç¡€æ–¹æ³•å’Œæ¥å£çš„æ‰€æœ‰æ–¹æ³•ã€‚åœ¨æ·»åŠ æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸€ä¸ªç”±æ–¹æ³•åå­—+å‚æ•°ä½œä¸ºKeyï¼ŒList<proxymethod>ä½œä¸ºå€¼çš„mapï¼Œæ·»åŠ å®Œæˆåä¼šåšä¸€æ¬¡checkï¼Œå³checkReturnTypesã€‚å…³äºè¿™ä¸ªæ–¹æ³•ï¼Œæ³¨é‡Šå¦‚ä¸‹ï¼š</proxymethod></p>
<blockquote>
<p>For a given set of proxy methods with the same signature, check that their return types are compatible according to the Proxy specification. Specifically, if there is more than one such method, then all of the return types must be reference types, and there must be one return type that is assignable to each of the rest of them.</p>
</blockquote>
<p>ã€2ã€‘æ”¶é›†äº§ç”Ÿç±»æ‰€éœ€è¦çš„æ‰€æœ‰çš„MethodInfoå’ŒFieldInfoå¯¹è±¡<br>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">methods.add(generateConstructor());</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</span><br><span class="line">	<span class="keyword">for</span> (ProxyMethod pm : sigmethods) &#123;</span><br><span class="line">		<span class="comment">// add static field for method's Method object</span></span><br><span class="line">		fields.add(<span class="keyword">new</span> FieldInfo(pm.methodFieldName,</span><br><span class="line">			<span class="string">"Ljava/lang/reflect/Method;"</span>,</span><br><span class="line">			ACC_PRIVATE | ACC_STATIC));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// generate code for proxy method and add it</span></span><br><span class="line">		methods.add(pm.generateMethod());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œmethodä¸­å—¨æ·»åŠ äº†æ„é€ å‡½æ•°å’Œé™æ€åˆå§‹åŒ–å‡½æ•°ã€‚</p>
<p>ã€3ã€‘å†™å…¥æœ€ç»ˆçš„ç±»æ–‡ä»¶<br>æ¥ä¸‹å»ä»£ç çš„å«ä¹‰æ˜¯ï¼šæŒ‰ç…§Javaç±»æ–‡ä»¶ç¼–è¯‘åçš„æ ¼å¼ï¼Œåˆ›å»ºä¸€ä¸ªç±»å‡ºæ¥ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹é‡ç‚¹(æ³¨æ„ï¼Œä¸‹é¢è´´çš„ä»£ç åœ¨åŸä»£ç ä¸­ä¸æ˜¯è¿è´¯çš„ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œç‰¹æ„æˆªå–å‡ è¡Œå±•ç¤º)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** name of the superclass of proxy classes */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String superclassName = <span class="string">"java/lang/reflect/Proxy"</span>;</span><br><span class="line">    </span><br><span class="line">dout.writeInt(<span class="number">0xCAFEBABE</span>);</span><br><span class="line">dout.writeShort(cp.getClass(superclassName));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (MethodInfo m : methods) &#123;</span><br><span class="line">	m.write(dout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†™å…¥çš„ç¬¬ä¸€ä¸ªå†…å®¹å°±æ˜¯<strong>dout.writeInt(0xCAFEBABE);</strong>ï¼Œè€Œ0xCAFEBABEå°±æ˜¯æ ‡è®° java class æ–‡ä»¶çš„é­”æ•°ã€‚ä¹‹åä¼šå†™å…¥superclassNameï¼Œè€Œè¿™ä¸ªç±»å°±æ˜¯java/lang/reflect/Proxyï¼Œå³Proxyç±»ï¼Œæ‰€ä»¥æ‰€æœ‰è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç†ç±»éƒ½æ˜¯Proxyçš„å­ç±»ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç†ç±»ä¸èƒ½ä»£ç†ä¸€ä¸ªå…·ä½“ç±»ï¼Œè€Œåªèƒ½ä»£ç†ä¸€ä¸ªæ¥å£ï¼šJavaä¸­æ²¡æœ‰å¤šç»§æ‰¿ï¼Œåé¢ä¼šæœ‰æ›´ç›´æ¥çš„è¯æ®ã€‚ä¹‹åå°±æ˜¯å†™å…¥æ–¹æ³•ã€‚å†™å…¥æ–¹æ³•è¿™ä¸€å—æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ¥é‡‡å–ä¸€äº›ç‰¹æ®Šæªæ–½çœ‹çœ‹å…·ä½“ç”Ÿæˆçš„æ–‡ä»¶æ˜¯ä»€ä¹ˆã€‚æ¥ç€æœ€å‰é¢çš„ä½¿ç”¨ä¾‹å­ï¼Œæˆ‘ä»¬åœ¨mainå‡½æ•°ä¸­å†™å…¥å¦‚ä¸‹ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Implementation implementation = <span class="keyword">new</span> Implementation();</span><br><span class="line">Class[] interfaces = implementation.getClass().getInterfaces();</span><br><span class="line"><span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(<span class="string">"MethodSelector"</span>, interfaces);</span><br><span class="line">File f = <span class="keyword">new</span> File(<span class="string">"/Users/muzileecoding/Desktop/MethodSelector.class"</span>);</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(f);</span><br><span class="line">	fos.write(proxyClassFile);</span><br><span class="line">	fos.flush();</span><br><span class="line">	fos.close();;</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åå°±å¯ä»¥åœ¨ç›¸åº”çš„æ–‡ä»¶å¤¹ä¸‹é¢è·å–åˆ°MethodSelector.classæ–‡ä»¶ï¼Œå°†æ–‡ä»¶åç¼–è¯‘ï¼ˆæ‹–å…¥IDEæ‰“å¼€å³å¯ï¼‰ï¼Œä¸‹é¢æ˜¯å®Œæ•´çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.footprint.reflection.SomeMethods;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodSelector</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">SomeMethods</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m4;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m6;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m5;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodSelector</span><span class="params">(InvocationHandler var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;)).booleanValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">boring2</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m4, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">boring3</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m6, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">interesting</span><span class="params">(String var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m5, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>)).intValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">boring1</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.Object"</span>)&#125;);</span><br><span class="line">            m4 = Class.forName(<span class="string">"com.footprint.reflection.SomeMethods"</span>).getMethod(<span class="string">"boring2"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">            m6 = Class.forName(<span class="string">"com.footprint.reflection.SomeMethods"</span>).getMethod(<span class="string">"boring3"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">            m5 = Class.forName(<span class="string">"com.footprint.reflection.SomeMethods"</span>).getMethod(<span class="string">"interesting"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.String"</span>)&#125;);</span><br><span class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">            m3 = Class.forName(<span class="string">"com.footprint.reflection.SomeMethods"</span>).getMethod(<span class="string">"boring1"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå°±æ˜¯æœ€ç»ˆå†™å‡ºçš„javaåŠ¨æ€ä»£ç†ç±»ï¼š</p>
<ol>
<li>åŠ¨æ€ç”Ÿæˆç±»çš„æ—¶å€™ç”Ÿæˆäº†ä¸€ä¸ªåªéœ€è¦InvocationHandlerå®ä¾‹ä½œä¸ºå‚æ•°çš„æ„é€ å‡½æ•°çš„ï¼Œç»“åˆå‰é¢åˆ›å»ºå‡ºåŠ¨æ€ä»£ç†æ–‡ä»¶ä¹‹ååˆ›å»ºåŠ¨æ€ä»£ç†å®ä¾‹çš„åå°„ä»£ç ï¼Œè¿™é‡Œä¸éš¾ç†è§£ï¼›</li>
<li>æ‰€æœ‰çš„æ–¹æ³•ä½“éƒ½å˜æˆäº†<strong>super.h.invoke(this, m4, (Object[])null);</strong>è¿™æ ·çš„è°ƒç”¨ï¼Œè€Œm4ä»£è¡¨ç€æ¥å£ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä»è¿™é‡Œå¯ä»¥çŸ¥é“ï¼Œå®é™…ç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼Œè°ƒç”¨äº†æˆ‘ä»¬åˆ›å»ºä»£ç†æ—¶ä¼ å…¥çš„InvocationHandlerå®ä¾‹ï¼Œå¹¶ä¸”å°†æˆ‘ä»¬çš„è¿”å›ç»“æœç›´æ¥è¿”å›ï¼Œè¿™å°±æ˜¯åŠ¨æ€ä»£ç†çš„æœ¬è´¨ï¼›</li>
</ol>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬ä¼ å…¥çš„ä¸‰ä¸ªå‚æ•°å¦‚ä½•è½¬åŒ–ä¸ºæœ€ç»ˆçš„åŠ¨æ€ä»£ç†ç±»ï¼Œå·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><strong>åŠ¨æ€ä»£ç†çš„åŸç†å®é™…ä¸Šå°±æ˜¯ï¼š</strong>æ ¹æ®æˆ‘ä»¬è¦ä»£ç†çš„æ¥å£ï¼Œåœ¨æ¥å£åŠ è½½çš„ClassLoaderä¸ŠåŠ¨æ€ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼ˆè¿™ä¸ªç±»åŸæ¥ä¸å­˜åœ¨ï¼‰ï¼ŒåŠ¨æ€ä»£ç†ç±»éœ€è¦æˆ‘ä»¬ä¼ å…¥çš„InvocationHandlerä½œä¸ºæ„é€ å‚æ•°ï¼Œè¿™ä¸ªä»£ç†ç±»ä¸­ä¼šæœ‰æ‰€æœ‰æˆ‘ä»¬éœ€è¦ä»£ç†çš„æ¥å£çš„æ–¹æ³•å®ç°ï¼Œè€Œè¿™ä¸ªå®ç°ï¼Œå°±æ˜¯ç®€å•çš„è°ƒç”¨æˆ‘ä»¬ä¼ å…¥çš„InvocationHandlerçš„invokeæ–¹æ³•ã€‚æ‰€ä»¥å¦‚æœè¿™æ ·å†™:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object o, Method method, Object[] objects)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> method.invoke(o, objects);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°±ä¼šé€ æˆå¾ªç¯è°ƒç”¨ï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚</p>
<p>Proxy.newProxyInstanceæ–¹æ³•çš„è¿”å›å€¼åªèƒ½å¼ºè½¬ä¸ºå®ƒä»£ç†çš„å…¶ä¸­ä¸€ä¸ªæ¥å£ï¼ŒåŸå› å¾ˆç®€å•ï¼Œå› ä¸ºç”Ÿæˆçš„ç±»ç­¾åæ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodSelector</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">SomeMethods</span></span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä¸¤ä¸ªç‚¹è¦æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p>æœ€åï¼Œæ­£å¦‚ IBM åšå®¢ä¸­æ‰€è¯´ï¼Œä¹Ÿå¦‚å‰é¢åˆ†æçš„ï¼ŒJavaè‡ªå¸¦çš„åŠ¨æ€ä»£ç†æ˜¯ä¸èƒ½å®ç°ä»£ç†å®ä½“ç±»æˆ–è€…æŠ½è±¡ç±»çš„ï¼Œè¿™ä¸€ç‚¹ç¾ä¸­ä¸è¶³ï¼Œè¿™æ„å‘³ç€æˆ‘ä¸€æ—¦è¦ä»£ç†ä¸€ä¸ªç±»ï¼Œå°±å¿…é¡»æŠ½è±¡å‡ºå“åº”çš„æ–¹æ³•ã€‚ä½†å®é™…ä¸Šï¼Œåº”è¯¥æœ‰éšæ„ä»£ç†ä¸€ä¸ªç±»çš„æˆç†Ÿå®ç°äº†ï¼Œå› ä¸ºAOPçš„å®ç°å°±ä¾èµ–äºæ­¤ã€‚So:</p>
<blockquote>
<p>ä¸å®Œç¾å¹¶ä¸ç­‰äºä¸ä¼Ÿå¤§ï¼Œä¼Ÿå¤§æ˜¯ä¸€ç§æœ¬è´¨ï¼ŒJava åŠ¨æ€ä»£ç†å°±æ˜¯ä½ä¾‹ã€‚  </p>
<p>â€”â€”<a href="https://www.ibm.com/developerworks/cn/java/j-lo-proxy1/" target="_blank" rel="noopener">Java åŠ¨æ€ä»£ç†æœºåˆ¶åˆ†æåŠæ‰©å±•</a></p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è§‚å½±ã€Šç«æ˜Ÿæ•‘æ´ã€‹]]></title>
      <url>http://www.timebridge.space/2015/12/05/mars-jiu-yuan/</url>
      <content type="html"><![CDATA[<p>ä¸è®ºå¤„äºä»€ä¹ˆæ ·çš„å›°å¢ƒï¼Œå°±ç®—æ˜¯è¢«å…¨ä¸–ç•Œçš„äººä¸¢å¼ƒåœ¨ç«æ˜Ÿï¼Œä½ ä¹Ÿè¦åšå¼ºï¼ŒæŒ£æ‰æ´»ä¸‹å»ï¼Œå¹¶ä¿æŒé€—æ¯”çš„å¿ƒæƒ…ï¼Œç”¨è‡ªå·±çš„ç¿”è½¬æ¢æˆè‡ªå·±çš„å£ç²®ï¼Œè¯´ä¸å®šä½ ä¸€ä¸å°å¿ƒå°±ä¼šæˆä¸ºæ˜Ÿçƒéœ¸ä¸»ï¼Œæ¯”å“¥ä¼¦å¸ƒå‘ç°æ–°å¤§é™†è¿˜è¦ç‰›é€¼ã€‚</p>
<p>æœ€åçœ‹åˆ°ç”·ä¸»å’Œä¸­æ ¡å¤§äººåœ¨æ— å çš„å¤ªç©ºé‡Œé¢å†ç»è‰°é™©ç»ˆäºç¢°æ’åœ¨ä¸€èµ·ï¼Œè¿˜æ˜¯è›®æœ‰æ„Ÿè§¦çš„ï¼Œæƒ³åˆ°äº†å¼ çˆ±ç²çš„é‚£å¥:<a id="more"></a></p>
<blockquote>
<p>äºåƒä¸‡äººä¹‹ä¸­é‡è§ä½ æ‰€è¦é‡è§çš„äºº,äºåƒä¸‡å¹´ä¹‹ä¸­,æ—¶é—´çš„æ— æ¶¯çš„è’é‡é‡Œ,æ²¡æœ‰æ—©ä¸€æ­¥,ä¹Ÿæ²¡æœ‰æ™šä¸€æ­¥,åˆšå·§èµ¶ä¸Šäº†,æ²¡æœ‰åˆ«çš„è¯å¯è¯´,æƒŸæœ‰è½»è½»åœ°é—®ä¸€å£°å™¢,ä½ ä¹Ÿåœ¨è¿™é‡Œ?</p>
<p>â€”â€”å¼ çˆ±ç²ã€Šçˆ±ã€‹</p>
</blockquote>
<p>å¼ çˆ±ç²è¯´çš„æ˜¯ç¼˜åˆ†ï¼Œç¼˜åˆ†å¤©æ³¨å®šï¼Œç”·ä¸»å’Œå¥³ä¸»çš„æ˜¯çˆ±â€”â€”åœ¨æ— å çš„ç©ºé—´ä¸­æ”¹å˜å½¼æ­¤çš„è½¨è¿¹ï¼Œäº¤é”™ç›¸æºï¼Œçˆ±æ˜¯å¯ä»¥äº‰å–çš„ã€‚</p>
<p>çœ‹ä¸ªç”µå½±è¿Ÿåˆ°20åˆ†é’Ÿä¹Ÿæ˜¯é†‰äº†ï¼Œè¿›å»çœ‹çš„æ—¶å€™å·²ç»ç¬¬36ä¸ªå¤ªé˜³æ—¥äº†ï¼ï¼</p>
<p>å…¬å¸å± å¤§å¸ˆåœ¨åˆ†äº«é€šä¿¡çš„æ—¶å€™è¯´ï¼Œåœ°çƒå’Œç«æ˜Ÿä¹‹é—´ä¸å¤ªå¯èƒ½æ˜¯ä½¿ç”¨TCP/IPåè®®è¿›è¡Œä¼ è¾“çš„ï¼Œå› ä¸ºæ¥å›ä¼ é€’æ—¶é—´æ˜¯12åˆ†é’Ÿï¼ŒTCP/IPçš„ä¼ è¾“æ•ˆç‡å¤ªä½ã€‚ä¸è¿‡çœ‹é‚£ä¸ªè¢«åŸ‹æ±°çš„æ¢æµ‹å™¨ï¼Œäº§è‡ªä¸Šä¸–çºª90å¹´ä»£ï¼Œè²Œä¼¼åªèƒ½ä½¿ç”¨TCP/IPåè®®å•Šã€‚</p>
<p>åæœŸçš„å‘å±•æ–¹å‘åº”è¯¥æ˜¯å¯»æ±‚ä¸€ç§æ›´ç¨³å¥çš„ä¼ è¾“ä»‹è´¨ï¼Œæ¯”å¦‚ã€Šä¸‰ä½“ã€‹é‡Œé¢çš„å¼•åŠ›æ³¢ã€ä¸­å­æŸä¸€ç±»çš„ã€‚TCP/IPåè®®çš„ä¼ è¾“èµ·ç æ˜¯ç›®å‰æ¥è¯´èƒ½æƒ³åˆ°çš„æœ€ä½æˆæœ¬çš„ä¿è¯è´¨é‡çš„ä¼ è¾“åè®®ï¼Œç¡®è®¤åŒ…å›ä¼ å’Œä¸¢åŒ…é‡ä¼ æœºåˆ¶æ˜¯ä¿è¯æ•°æ®ä¼ è¾“æˆåŠŸçš„å¿…è¦æ‰‹æ®µã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[AsyncTask æºç åˆ†æ]]></title>
      <url>http://www.timebridge.space/2015/12/02/Android-AsyncTask/</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ã€ç¯å¢ƒã€‘æºç åˆ†æåŸºäº 6.0ã€‚<br>ã€çŸ¥è¯†ã€‘è¯·è¯»è€…è‡ªå¤‡FutureTaskç›¸å…³æŠ€èƒ½ã€‚</p>
<h2 id="AsyncTaskçš„ä»‹ç»å’Œä½¿ç”¨"><a href="#AsyncTaskçš„ä»‹ç»å’Œä½¿ç”¨" class="headerlink" title="AsyncTaskçš„ä»‹ç»å’Œä½¿ç”¨"></a>AsyncTaskçš„ä»‹ç»å’Œä½¿ç”¨</h2><p>å¦‚å®˜ç½‘æ‰€è¿°:</p>
<blockquote>
<p>AsyncTask enables proper and easy use of the UI thread. This class allows to perform background operations and publish results on the UI thread without having to manipulate threads and/or handlers.</p>
</blockquote>
<p>ç®€è€Œè¨€ä¹‹ï¼ŒAsyncTaskæ˜¯ä¸ºäº†åœ¨åå°çº¿ç¨‹å’ŒUIçº¿ç¨‹ä¹‹é—´åšä»»åŠ¡è°ƒåº¦è€Œå¼€å‘çš„ä¸€ä¸ªç±»ï¼Œä½¿å¾—è¿™ç§å¸¸è§çš„æ“ä½œæ›´åŠ å®¹æ˜“ç®€ç»ƒï¼Œè€Œä¸ç”¨å»æ“ä½œçº¿ç¨‹æœ¬èº«ä»¥åŠHandlerã€‚è¯¦ç»†ä»‹ç»è§å®˜æ–¹æ–‡æ¡£: <a href="http://developer.android.com/intl/zh-cn/reference/android/os/AsyncTask.html" target="_blank" rel="noopener">AsyncTask</a>ã€‚<a id="more"></a></p>
<p>æºç (ç±»æ³¨é‡Š)ä¸­ç»™å‡ºçš„ğŸŒ°å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadFilesTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">URL</span>, <span class="title">Integer</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">	<span class="comment">//åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œ</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Long <span class="title">doInBackground</span><span class="params">(URL... urls)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> count = urls.length;</span><br><span class="line">		<span class="keyword">long</span> totalSize = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">			totalSize += Downloader.downloadFile(urls[i]);</span><br><span class="line"> 			publishProgress((<span class="keyword">int</span>) ((i / (<span class="keyword">float</span>) count) * <span class="number">100</span>));</span><br><span class="line">			<span class="comment">// Escape early if cancel() is called</span></span><br><span class="line">			<span class="keyword">if</span> (isCancelled()) <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> totalSize;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œ</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Integer... progress)</span> </span>&#123;</span><br><span class="line">		setProgressPercent(progress[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œ</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Long result)</span> </span>&#123;</span><br><span class="line">		showDialog(<span class="string">"Downloaded "</span> + result + <span class="string">" bytes"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä½¿ç”¨å¦‚ä¸‹ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> DownloadFilesTask().execute(url1, url2, url3);</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨è¿‡ç¨‹éå¸¸æ–¹ä¾¿ï¼Œä»»åŠ¡è¢«åˆ†è§£æˆè€—æ—¶çš„åç«¯ä»»åŠ¡ä»¥åŠUIçº¿ç¨‹çš„å›è°ƒä¸¤éƒ¨åˆ†ï¼Œå¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨è¿›è¡Œä»»åŠ¡çš„è°ƒåº¦ï¼Œåªéœ€è¦æŒ‰ç…§çº¦å®šï¼Œå°†æ“ä½œåˆ†è§£åˆ°å¯¹åº”çš„å‡½æ•°ä¸­ï¼Œå°±å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œéå¸¸æ–¹ä¾¿ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥æ¢ç©¶ä¸€ä¸‹ï¼ŒAsyncTaskæ˜¯å¦‚ä½•å®ç°è¿™ä¸ªåŠŸèƒ½çš„ã€‚</p>
<h2 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h2><p>å¦‚ä¸Šç¤ºä¾‹æ‰€ç¤ºï¼ŒAsyncTaskæœ‰å‡ ä¸ªé‡è¦çš„â€ç”Ÿå‘½å‘¨æœŸâ€æ–¹æ³•:</p>
<ol>
<li>onPreExecute()</li>
<li>doInBackground()</li>
<li>onProgressUpdate()</li>
<li>onPostExecute()</li>
<li>onCancelled()</li>
</ol>
<p>å…³äºå®ƒä»¬å…·ä½“çš„ä½œç”¨å’Œè°ƒç”¨æ—¶é—´ï¼Œåœ¨æºç çš„ç±»æ³¨é‡Šä»¥åŠå®˜æ–¹APIæ–‡æ¡£é‡Œé¢éƒ½æœ‰è¯¦ç»†çš„è§£é‡Šï¼Œæ­¤å¤„ä¸èµ˜è¿°ã€‚(æ‡’å¾—å†™â€¦å…¶å®çœ‹åå­—å°±èƒ½çŒœå‡ºå¤§æ¦‚)</p>
<p>å¦‚ğŸŒ°æ‰€ç¤ºï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹æ˜¯å¦‚ä½•å‘ç”Ÿçš„ã€‚</p>
<h3 id="å®ä¾‹åŒ–"><a href="#å®ä¾‹åŒ–" class="headerlink" title="å®ä¾‹åŒ–"></a>å®ä¾‹åŒ–</h3><p>é¦–å…ˆæ˜¯AsyncTaskçš„åˆ›å»ºè¿‡ç¨‹ï¼Œå…¶ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">			mTaskInvoked.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">			Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">			<span class="comment">//noinspection unchecked</span></span><br><span class="line">			Result result = doInBackground(mParams);</span><br><span class="line">			Binder.flushPendingCommands();</span><br><span class="line">			<span class="keyword">return</span> postResult(result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				postResultIfNotInvoked(get());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				android.util.Log.w(LOG_TAG, e);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</span><br><span class="line">					e.getCause());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (CancellationException e) &#123;</span><br><span class="line">				postResultIfNotInvoked(<span class="keyword">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºè¿‡ç¨‹åªæ˜¯å®ä¾‹åŒ–äº†ä¸¤ä¸ªå˜é‡: mWorker &amp; mFutureã€‚mWorkeræ˜¯ä¸€ä¸ªWorkerRunnableå¯¹è±¡ï¼Œè¿™ä¸ªç±»çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</span><br><span class="line">        Params[] mParams;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§æ‰¿äº†Callableå¯¹è±¡ï¼Œæ·»åŠ äº†Paramså®ä¾‹ï¼Œè‡³äºParamså’ŒResultçš„ç±»å‹ï¼Œåœ¨AsyncTaskç±»ç­¾åä¸­å¯ä»¥çœ‹åˆ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTask</span>&lt;<span class="title">Params</span>, <span class="title">Progress</span>, <span class="title">Result</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ˜¯æ³›å‹ï¼Œç”±ä½¿ç”¨è€…è‡ªå·±å†³å®šã€‚å› æ­¤<strong>WorkerRunnableå…¶å®æ˜¯Callableçš„å¢å¼ºç‰ˆï¼Œå¯ä»¥ä¼ é€’å¦å¤–ä¸€ä¸ªæ³›å‹å‚æ•°è¿›å»</strong>ã€‚</p>
<p>mFutureæ˜¯ä¸€ä¸ªFutureTaskå¯¹è±¡ï¼Œæ¥å—mWorkerå¯¹è±¡ä½œä¸ºå‚æ•°ã€‚è¦å¼„æ¸…æ¥šè¿™ä¸¤ä¸ªå¯¹è±¡çš„ä½œç”¨ï¼Œå…ˆæ’‡ä¸‹è¿™ä¸¤ä¸ªå¯¹è±¡çš„å£°æ˜ç»†èŠ‚ï¼Œç»§ç»­å¾€åçœ‹ã€‚</p>
<h3 id="æ‰§è¡Œå¼€å§‹"><a href="#æ‰§è¡Œå¼€å§‹" class="headerlink" title="æ‰§è¡Œå¼€å§‹"></a>æ‰§è¡Œå¼€å§‹</h3><p>ä½¿ç”¨ç¤ºä¾‹ä¸­æ‰§è¡Œtaskè°ƒç”¨çš„æ˜¯executeæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨å¦å¤–ä¸€ä¸ªæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec, Params... params)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (mStatus) &#123;</span><br><span class="line">			<span class="keyword">case</span> RUNNING:</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span>	+ <span class="string">" the task is already running."</span>);</span><br><span class="line">			<span class="keyword">case</span> FINISHED: <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></span><br><span class="line">                            + <span class="string">" the task has already been executed "</span></span><br><span class="line">                            + <span class="string">"(a task can be executed only once)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mStatus = Status.RUNNING;<span class="comment">//è®¾ç½®ä»»åŠ¡çŠ¶æ€</span></span><br><span class="line">	onPreExecute();</span><br><span class="line">	mWorker.mParams = params;</span><br><span class="line">	exec.execute(mFuture);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ˜¯æœªæ‰§è¡Œçš„çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™æ ¹æ®å½“å‰çŠ¶æ€æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™æ®µä»£ç è¡¨æ˜ï¼š<strong>ä¸€ä¸ªAsyncTaskåªèƒ½æ‰§è¡Œä¸€æ¬¡(æ¯æ¬¡è¿è¡Œéƒ½å¾—é‡æ–°åˆ›å»º)ã€‚</strong></p>
<blockquote>
<p><strong>PENDING</strong>æ˜¯åˆ›å»ºå¥½ä½†æ²¡æœ‰æ‰§è¡Œçš„çŠ¶æ€ï¼ŒFINISHEDæ˜¯ç»ˆç»“æ€ï¼Œå¯ä»¥é€šè¿‡<code>AsyncTask.getStatus()</code>æ–¹æ³•æ¥è·çŸ¥çŠ¶æ€ã€‚</p>
</blockquote>
<p>onPreExecute()æ–¹æ³•åœ¨ä¸€å¼€å§‹å°±ä¼šè°ƒç”¨ï¼Œæ‰§è¡Œåœ¨execute()æ–¹æ³•çš„è°ƒç”¨çº¿ç¨‹ä¸Šã€‚ä¼ é€’è¿›æ¥çš„å‚æ•°ä¼šè¢«èµ‹å€¼ç»™mWorkerçš„mParamså±æ€§ï¼Œåœ¨çº¿åŸæ± ä¸­æ‰§è¡Œä»»åŠ¡ã€‚</p>
<h3 id="æ‰§è¡Œè¿‡ç¨‹"><a href="#æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="æ‰§è¡Œè¿‡ç¨‹"></a>æ‰§è¡Œè¿‡ç¨‹</h3><p>æ‰§è¡Œè¿‡ç¨‹çš„ä»£ç å°±åœ¨mWorkerçš„å£°æ˜ä¸­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	mTaskInvoked.set(<span class="keyword">true</span>);</span><br><span class="line">	Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">	<span class="comment">//noinspection unchecked</span></span><br><span class="line">	Result result = doInBackground(mParams);</span><br><span class="line">	Binder.flushPendingCommands();</span><br><span class="line">	<span class="keyword">return</span> postResult(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mTaskInvokedæ˜¯ä¸€ä¸ªAtomicBooleanç±»ï¼Œä»åç§°çœ‹ï¼Œæ˜¯è¡¨ç¤ºè¯¥ä»»åŠ¡æ˜¯å¦è¢«æ‰§è¡Œè¿‡ï¼Œå…·ä½“ä½œç”¨åé¢è¯¦è¿°ã€‚</p>
<p>å°†çº¿ç¨‹çš„ä¼˜å…ˆçº§è®¾ç½®ä¸ºåå°çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œè°ƒç”¨ç¬¬äºŒä¸ªé‡è¦çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•doInBackgroundæ‰§è¡Œä»»åŠ¡ã€‚æœ€åè°ƒç”¨postResultæ–¹æ³•è¿”å›ç»“æœï¼ŒpostResultæ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</span><br><span class="line">                <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</span><br><span class="line">	message.sendToTarget();</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä»ä¸€ä¸ªgetHandler()æ–¹æ³•ä¸­è·å–ä¸€ä¸ªMessageï¼ŒåŒæ—¶å°†ä¸€ä¸ªAsyncTaskResultå¯¹è±¡æ”¾ç½®åˆ°Meesageä¸­ï¼Œå°†æ¶ˆæ¯åˆ†å‘åˆ°ä¸»çº¿ç¨‹ä¸­ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹è¿™æ®µä»£ç ä¸­çš„ä¸¤ä¸ªKey Pointã€‚</p>
<h4 id="AsyncTaskResult"><a href="#AsyncTaskResult" class="headerlink" title="AsyncTaskResult"></a>AsyncTaskResult</h4><p>é¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸ºAsyncTaskæ‰§è¡Œç»“æœå£°æ˜çš„ç±»:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskResult</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> AsyncTask mTask;</span><br><span class="line">	<span class="keyword">final</span> Data[] mData;</span><br><span class="line">	</span><br><span class="line">	AsyncTaskResult(AsyncTask task, Data... data) &#123;</span><br><span class="line">		mTask = task;</span><br><span class="line">		mData = data;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»å¾ˆç®€å•ï¼ŒæŒæœ‰Taskæœ¬èº«å’ŒmDataâ€”â€”è¿™æ˜¯æˆ‘ä»¬çš„ä»»åŠ¡æ‰§è¡Œç»“æœã€‚</p>
<h4 id="getHandler"><a href="#getHandler" class="headerlink" title="getHandler()"></a>getHandler()</h4><p>getHandler()è¿”å›çš„æ˜¯ä¸€ä¸ªInternalHandlerå®ä¾‹ï¼Œç±»å£°æ˜å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(Looper.getMainLooper());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">		AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</span><br><span class="line">		<span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">			<span class="keyword">case</span> MESSAGE_POST_RESULT:</span><br><span class="line">				<span class="comment">// There is only one result</span></span><br><span class="line">				result.mTask.finish(result.mData[<span class="number">0</span>]);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> MESSAGE_POST_PROGRESS:</span><br><span class="line">				result.mTask.onProgressUpdate(result.mData);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œè¿™æ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹çš„Handlerâ€”â€”ä¿è¯ç›¸å…³çš„å‡½æ•°è¢«è°ƒåº¦åˆ°UIçº¿ç¨‹æ‰§è¡Œï¼›å…¶æ¬¡ï¼Œå¤„ç†ä¸¤ç§æ¶ˆæ¯ï¼šMESSAGE_POST_RESULTå’ŒMESSAGE_POST_PROGRESSï¼Œå³çº¿ç¨‹æ‰§è¡Œè¿›åº¦æ›´æ–°å’Œæ‰§è¡Œå®Œæˆçš„å›è°ƒã€‚result.mTaskå°±æ˜¯æˆ‘ä»¬å½“å‰çš„AsyncTaskã€‚è¯»è€…å¯èƒ½ç–‘æƒ‘MESSAGE_POST_PROGRESSæ¶ˆæ¯æ˜¯ä»€ä¹ˆæ—¶å€™å‘å‡ºçš„ï¼Œçœ‹publishProgress()å°±ä¼šæ˜ç™½ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¼€å‘è€…è‡ªå·±è°ƒç”¨çš„ï¼Œä¸æ˜¯å¿…ç»çš„ç”Ÿå‘½å‘¨æœŸï¼Œå› æ­¤è¿™é‡Œä¸ä½œåˆ†æã€‚</p>
<h3 id="æ‰§è¡Œç»“æŸ"><a href="#æ‰§è¡Œç»“æŸ" class="headerlink" title="æ‰§è¡Œç»“æŸ"></a>æ‰§è¡Œç»“æŸ</h3><p>æ‰§è¡Œç»“æŸä¹‹åçš„ä»£ç åœ¨ä¸€å¼€å§‹ä¹Ÿçœ‹åˆ°äº†ï¼Œå°±æ˜¯mFutureçš„å£°æ˜ï¼Œæ‰§è¡Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		postResultIfNotInvoked(get());</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		android.util.Log.w(LOG_TAG, e);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</span><br><span class="line">		e.getCause());</span><br><span class="line">	&#125; <span class="keyword">catch</span> (CancellationException e) &#123;</span><br><span class="line">		postResultIfNotInvoked(<span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªè°ƒç”¨äº†ä¸€ä¸ªæ–¹æ³•:postResultIfNotInvoked(get())ã€‚get()æ–¹æ³•æ˜¯FutureTaskçš„æ–¹æ³•ï¼Œä¼šé˜»å¡ç›´è‡³ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚postResultIfNotInvokedæ–¹æ³•çš„å®ç°æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postResultIfNotInvoked</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> wasTaskInvoked = mTaskInvoked.get();</span><br><span class="line">	<span class="keyword">if</span> (!wasTaskInvoked) &#123;</span><br><span class="line">		postResult(result);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆå‡ºç°äº†mTaskInvokedï¼Œé…åˆæ–¹æ³•åç§°postResultIfNotInvokedå¯ä»¥çŸ¥é“ï¼Œè¿™æ®µä»£ç æ˜¯åœ¨ä»»åŠ¡æ²¡æœ‰è¢«æ‰§è¡Œçš„æ—¶å€™æ‰ä¼šè¢«è°ƒç”¨ã€‚å‰é¢çœ‹åˆ°call()æ–¹æ³•çš„ä¸€å¼€å§‹å°±ä¼šæŠŠmTaskInvokedè®¾ç½®ä¸ºtrueï¼Œè¿™é‡Œæœ‰äº›å¥‡æ€ª:</p>
<ol>
<li>æŒ‰é“ç†ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œèµ·æ¥ä¹‹åï¼Œé¦–å…ˆå°±ä¼šæ‰§è¡ŒmTaskInvokedçš„setæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡ŒpostResultè‚¯å®šä¸ä¼šè¢«æ‰§è¡Œã€‚ä½†å¦‚æœä»»åŠ¡æ²¡æœ‰è¢«Invokedï¼Œåˆæ€ä¹ˆä¼šæ‰§è¡Œåˆ°postResultIfNotInvokedæ–¹æ³•å‘¢ï¼ŸpostResultä»¥åŠpostResultIfNotInvokedéƒ½æ˜¯privateçš„ï¼Œåªå¯èƒ½èµ°è¿™ä¸ªæµç¨‹è°ƒç”¨ï¼›</li>
<li>åœ¨call()æ–¹æ³•çš„æœ€åï¼Œå·²ç»è°ƒç”¨postResultäº†ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦å†æ¬¡åˆ¤æ–­å¹¶åˆ†å‘ç»“æœï¼Ÿ</li>
</ol>
<p>ä¸€æ­¥æ­¥æ¥ï¼šè¦ <strong>!wasTaskInvoked</strong> ä¸ºtrueï¼Œåˆ™callæ–¹æ³•ä¸èƒ½è¢«æ‰§è¡Œï¼Œå¦åˆ™mTaskInvokedè‚¯å®šä¼šè¢«ç½®ä¸ºtrueï¼Œé‚£ä¹ˆåªæœ‰ä¸€ç§åŠæ³•ï¼Œå°±æ˜¯callæ–¹æ³•åˆšæ‰§è¡Œçš„æ—¶å€™å°±æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè€Œå¼‚å¸¸åœ¨FutureTaskä¸­æ˜¯å¾ˆå¸¸è§çš„ï¼Œè‡³å°‘æœ‰ä¸¤ç§ï¼Œå°±æ˜¯InterruptedExceptionå’ŒCancellationExceptionã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ç¬¬5ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œçœ‹å®Œå°±çŸ¥é“å¦‚ä½•è§£é‡Šè¿™ä¸ªåˆ¤æ–­äº†ã€‚</p>
<h3 id="å–æ¶ˆæ‰§è¡Œ"><a href="#å–æ¶ˆæ‰§è¡Œ" class="headerlink" title="å–æ¶ˆæ‰§è¡Œ"></a>å–æ¶ˆæ‰§è¡Œ</h3><p>AsyncTaskæ˜¯å¯ä»¥å–æ¶ˆçš„ï¼Œè°ƒç”¨æ–¹æ³•cancel()å°±å¥½:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</span><br><span class="line">	mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">	<span class="keyword">return</span> mFuture.cancel(mayInterruptIfRunning);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mCancelled.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mCancelledä¹Ÿæ˜¯ä¸€ä¸ªAtomicBooleanå¯¹è±¡ï¼Œæ ‡è¯†ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå˜é‡æœ‰ä»€ä¹ˆå½±å“ã€‚</p>
<p>åœ¨ä»»åŠ¡ç»“æŸçš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ˜¯AsyncTask.finsh()æ–¹æ³•(å¯ä»¥æŸ¥çœ‹InternalHandlerå¯¹MESSAGE_POST_RESULTç±»å‹æ¶ˆæ¯çš„å¤„ç†):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">		onCancelled(result);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		onPostExecute(result);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//æ³¨æ„ï¼Œä¸è®ºä»»åŠ¡æ˜¯æ­£å¸¸å®Œæˆè¿˜æ˜¯å–æ¶ˆï¼ŒçŠ¶æ€éƒ½æ ‡è®°ä¸ºFINISHED</span></span><br><span class="line">	mStatus = Status.FINISHED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šåšå‡ºåˆ¤æ–­ï¼Œå¦‚æœè¢«å–æ¶ˆäº†ï¼Œæ˜¯å›è°ƒç”Ÿå‘½å‘¨æœŸæ–¹æ³•onCancelledï¼Œå¦åˆ™è°ƒç”¨onPostExecuteã€‚</p>
<p>åˆ°æ­¤è¿˜æ²¡æœ‰å›ç­”å‰é¢çš„é—®é¢˜ï¼Œä½†æ˜¯å–æ¶ˆæ˜¯å¾ˆå…³é”®çš„ã€‚ç†Ÿæ‚‰FutureTaskçš„äººåº”è¯¥çŸ¥é“CancellationExceptionå‘ç”Ÿçš„æƒ…å†µï¼šå¦‚æœæœ‰äººåœ¨AsyncTaskè¿è¡Œä¹‹å‰ï¼Œå³callæ‰§è¡Œä¹‹å‰è°ƒç”¨cancelæ–¹æ³•ï¼Œé‚£ä¹ˆåªè¦AsyncTaskä¸€è¿è¡Œï¼Œå°±ä¼šç«‹åˆ»æŠ›å‡ºCancellationExceptionå¼‚å¸¸ï¼Œè¿›å…¥done()æ–¹æ³•æ‰§è¡Œã€‚</p>
<p><strong>postResultIfNotInvoked()æ–¹æ³•å°±æ˜¯ä¸ºäº†é˜²æ­¢åœ¨è¿™ç§æƒ…å†µä¸‹ä¸å›è°ƒonCancelled()è®¾ç½®çš„: å¦‚æœæ­£å¸¸æ‰§è¡Œï¼Œä¸å‘ç”Ÿä»»ä½•çš„å¼‚å¸¸ï¼Œåˆ™ä¼šæ‰§è¡Œcallæœ€åçš„postResult()æ–¹æ³•ç›´æ¥åˆ†å‘ç»“æœï¼Œä½†å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œåˆ™ä¼šç›´æ¥è¿›å…¥done()å‡½æ•°ï¼Œdoneå‡½æ•°å¯ä»¥ä¿è¯ï¼Œå¦‚æœæ˜¯å› ä¸ºCancellationExceptionå¼‚å¸¸å‘ç”Ÿæ‰§è¡Œé”™è¯¯ï¼Œä¸€å®šä¼šå›è°ƒonCancelled()æ–¹æ³•ã€‚å¹¶ä¸”call()å’Œdone()æ–¹æ³•è™½ç„¶éƒ½ä¼šå»è°ƒç”¨postResult()æ–¹æ³•ï¼Œä½†æ¡ä»¶ä¸Šäº’æ–¥ï¼Œå³ç»“æœä¸ä¼šåˆ†å‘ä¸¤æ¬¡ã€‚</strong></p>
<p>å¯ä»¥å‚è§è¿™ä¸ª<a href="https://android.googlesource.com/platform/frameworks/base/+/5ba812b9e9c886425a5736c2ae6fbe0fc94afd8b%5E%21/#F0" target="_blank" rel="noopener">ã€Bugã€‘</a></p>
<p>å…³äºCancelæ–¹æ³•çš„å‡ ä¸ªå½±å“ï¼Œå¯ä»¥å‚è§ä¸‹åˆ—è¡¨æ ¼: </p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/AsyncTask-Cancelæ–¹æ³•.png" alt="AsyncTask-Cancelæ–¹æ³•"><br>ä»¥ä¸Šï¼Œç›¸å…³æ–¹æ³•éƒ½åˆ†æå®Œæ¯•ã€‚</p>
<h2 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h2><p>AsyncTaskæœ¬èº«å…¶å®æ˜¯è°ƒåº¦åå°çº¿ç¨‹æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œåº•å±‚æ˜¯ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†åå°çº¿ç¨‹çš„â€”â€”è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¤§é‡çš„AsyncTaskå¹¶ä¸ä¼šæ— é™åˆ¶çš„åˆ›å»ºåå°çº¿ç¨‹ã€‚åœ¨AsyncTaskå†…éƒ¨ï¼Œæœ‰ä¸¤ç§çº¿ç¨‹æ± ï¼Œä¸€ä¸ªæ˜¯é»˜è®¤çš„ï¼Œä¸€ä¸ªæ˜¯ä¸²è¡Œçº¿ç¨‹æ± ã€‚</p>
<h3 id="é»˜è®¤çº¿ç¨‹æ± "><a href="#é»˜è®¤çº¿ç¨‹æ± " class="headerlink" title="é»˜è®¤çº¿ç¨‹æ± "></a>é»˜è®¤çº¿ç¨‹æ± </h3><p>é»˜è®¤çº¿ç¨‹æ± çš„å£°æ˜æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = CPU_COUNT + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR</span><br><span class="line">            = <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE,</span><br><span class="line">                    TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®CPUæ ¸æ•°é‡è®¾ç½®çº¿ç¨‹æ± çš„è¿è¡Œèƒ½åŠ›ï¼Œç¼“å­˜é˜Ÿåˆ—ä¸­æœ€å¤šå­˜å‚¨128ä¸ªä»»åŠ¡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªæ•°é‡åº”è¯¥å¤Ÿç”¨äº†ã€‚ä½†æ˜¯å¼€å‘è€…è¿˜æ˜¯è¦æ³¨æ„ç®¡ç†ï¼Œä»»åŠ¡è¶…è¿‡128 + CPU_COUNT * 2 + 1ï¼ŒAsyncTaskå°±ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯çº¿ç¨‹æ± çš„æœºåˆ¶ã€‚</p>
<h3 id="ä¸²è¡Œçº¿ç¨‹æ± "><a href="#ä¸²è¡Œçº¿ç¨‹æ± " class="headerlink" title="ä¸²è¡Œçº¿ç¨‹æ± "></a>ä¸²è¡Œçº¿ç¨‹æ± </h3><p>ä¸²è¡Œçº¿ç¨‹æ± æ˜¯AsyncTaskè‡ªå·±å®ç°çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</span><br><span class="line">	Runnable mActive;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">		mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					r.run();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					scheduleNext();<span class="comment">//æ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</span><br><span class="line">			scheduleNext();<span class="comment">//æ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">			THREAD_POOL_EXECUTOR.execute(mActive);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒä¼šä¸åœçš„ä»é˜Ÿåˆ—ä¸­æ‹‰å–Runnableå¯¹è±¡ï¼Œä¸¢å…¥é»˜è®¤çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œä½†æ˜¯æ¯æ¬¡åªä¼šæ‰§è¡Œä¸€ä¸ªï¼šexecute()çš„æ—¶å€™ä¼šå»æ£€æµ‹æœ‰æ²¡æœ‰çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œæ²¡æœ‰çš„è¯ä¼šå»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼Œæˆ–è€…åœ¨ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åä¹Ÿä¼šå»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ç»§ç»­æ‰§è¡Œã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ç°ä»»åŠ¡çš„ä¸²è¡Œã€‚</p>
<p>AsyncTaské»˜è®¤åˆ°åº•æ˜¯å¹¶è¡Œè¿˜æ˜¯ä¸²è¡Œçš„ï¼Œå…¶å®æ˜¯ä¸ä¸€å®šçš„ï¼Œä¸€ä¸‹æ˜¯ä¸²è¡Œè¿˜æ˜¯å¹¶è¡Œä¸ç‰ˆæœ¬çš„å…³ç³»:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Asynctask-Execution-Differences.png" alt="Asynctask-Execution-Differences"><br>æœ€ç»ˆé»˜è®¤æ–¹å¼é‡‡ç”¨å¹¶è¡Œè¿˜æ˜¯ä¸²è¡Œï¼Œæ˜¯ä¾æ®targetSdkVersionæ¥çš„ï¼ŒtargetSdkVersion<13çš„æ—¶å€™é»˜è®¤æ˜¯ä¸²è¡Œçš„(å³ä½¿è¿è¡Œçš„å¹³å°å¤§äºç­‰äº13)ï¼Œtargetsdkversion>=13çš„æ—¶å€™é»˜è®¤å°±æ˜¯ä¸²è¡Œçš„ã€‚(ç°åœ¨è¿™äº›é—®é¢˜éƒ½ä¸éœ€è¦æ‹…å¿ƒäº†)ã€‚æˆ‘ä»¬é¡ºä¾¿çœ‹ä¸€ä¸‹å…¶ä½™å‡ ä¸ªæ–¹æ³•çš„æƒ…å†µ:</13çš„æ—¶å€™é»˜è®¤æ˜¯ä¸²è¡Œçš„(å³ä½¿è¿è¡Œçš„å¹³å°å¤§äºç­‰äº13)ï¼Œtargetsdkversion></p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Android-AsyncTask- Execution.png" alt="Android-AsyncTask- Execution"></p>
<blockquote>
<p>PS: <code>AsyncTask.execute(Runnable)</code>æ–¹æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„æ–¹æ³•ï¼Œå®ƒæ‰§è¡Œåœ¨AsyncTaskå†…éƒ¨çš„çº¿ç¨‹æ± ä¸­ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®å°±æ˜¯æŠŠAsyncTaskå½“åšçº¿ç¨‹æ± åœ¨ä½¿ç”¨ã€‚</p>
</blockquote>
<p>å¦‚æœæ˜¯ä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ï¼Œåˆ™AsyncTaskå…¨å±€ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°é—®é¢˜â€”â€”æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çº¿ç¨‹æ± æ¥æ”¹å–„ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>AsyncTaskæœ¬è´¨æ˜¯åŸºäºJavaçš„FutureTaskå’ŒAndroidçš„Handleråšçš„ä¸€å±‚å°è£…ï¼Œæ·»åŠ äº†åå°çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´çš„ä»»åŠ¡è°ƒåº¦ï¼Œç²¾å·§å®ç”¨ï¼Œä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨AsyncTaskçš„å‚è€ƒç‚¹:</p>
<ol>
<li>å¦‚æœæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªAsyncTaskï¼Œæ‰§è¡Œå®ƒçš„æ—¶å€™ä¸éœ€è¦ä¼ é€’å‚æ•°ï¼Œæˆ–è€…åªéœ€è¦é‡è½½<code>AsyncTask.doInBackground()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘åˆ«çš„æ‰‹æ®µï¼Œæ¯”å¦‚<a href="http://www.muzileecoding.com/androidsource/Android-HandlerThread-And-IntentService.html" target="_blank" rel="noopener">HandlerThread</a>ã€‚</li>
<li>AsyncTaskè‡ªèº«æ˜¯æ²¡æœ‰Looperçš„ï¼Œæ‰€ä»¥ä¸èƒ½å®ç°æ¶ˆæ¯çš„ä¼ é€’ï¼Œç†è®ºä¸Šå¯ä»¥é€šè¿‡ä¸€äº›æ–¹æ³•è¿›è¡Œæ”¹é€ ï¼Œä½†å¾ˆæ˜æ˜¾è¿™æ ·åšä¸å€¼å¾—ï¼Œè¿™ä¸ªæ—¶å€™åŒæ ·å¯ä»¥è€ƒè™‘<a href="http://www.muzileecoding.com/androidsource/Android-HandlerThread-And-IntentService.html" target="_blank" rel="noopener">HandlerThread</a>ã€‚</li>
<li>AsyncTaskå’ŒLocal Serviceæ˜¯ä¸€ç»„å¾ˆå¥½çš„æ­é…ã€‚å› ä¸ºServiceçš„æ‰§è¡Œä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹çš„ï¼Œå¦‚æœæ‰§è¡Œä¸€äº›è€—æ—¶ä»»åŠ¡ï¼Œå°±éœ€è¦å¼€å¯èƒŒæ™¯çº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨AsyncTaskæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯æœ€å¥½è‡ªå·±èµ·ä¸€ä¸ªçº¿ç¨‹æ± ã€‚</li>
</ol>
<p>å¤§éƒ¨åˆ†æ—¶å€™AsyncTaskä½¿ç”¨èµ·æ¥éƒ½ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå‡ ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¹Ÿéå¸¸å¥½æ‡‚ã€‚ä½†æ˜¯é€šè¿‡åˆšåˆšçš„åˆ†æï¼Œ<strong>è¦æ³¨æ„çš„æ˜¯onPreExecute()æ–¹æ³•çš„ä½¿ç”¨</strong>ã€‚è¿™ä¸ªæ–¹æ³•å¹¶æ²¡æœ‰é€šè¿‡Handlerå¼ºåˆ¶è°ƒåº¦åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå®ƒæ˜¯å¯èƒ½è¿è¡Œåœ¨åå°çº¿ç¨‹ä¸Šçš„â€”â€”å–å†³äºAsyncTaskçš„executeæ–¹æ³•åœ¨ä»€ä¹ˆçº¿ç¨‹ä¸Šè¢«æ‰§è¡Œã€‚ä½†å°±ç®—è¿™æ ·ä¹Ÿä¸å¿…è¿‡äºæ‹…å¿ƒï¼Œæˆ‘ä»¬ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šä½¿ç”¨AsyncTaskçš„ï¼Œå¹¶ä¸”ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨åˆ°çš„ä¹Ÿä¸å¤šã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªè¯•éªŒ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.footprint.littleshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.AsyncTask;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Looper;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                MyTask myTask = <span class="keyword">new</span> MyTask();</span><br><span class="line">                myTask.execute(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyTask"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(Integer... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isMainThread())</span><br><span class="line">            Log.e(TAG, <span class="string">"ã€doInBackgroundã€‘- Main"</span>);</span><br><span class="line">        <span class="keyword">else</span> Log.e(TAG, <span class="string">"ã€doInBackgroundã€‘- Non-Main"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPreExecute();</span><br><span class="line">        <span class="keyword">if</span> (isMainThread())</span><br><span class="line">            Log.e(TAG, <span class="string">"ã€onPreExecuteã€‘- Main"</span>);</span><br><span class="line">        <span class="keyword">else</span> Log.e(TAG, <span class="string">"ã€onPreExecuteã€‘- Non-Main"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isMainThread())</span><br><span class="line">            Log.e(TAG, <span class="string">"ã€onPostExecuteã€‘- Main"</span>);</span><br><span class="line">        <span class="keyword">else</span> Log.e(TAG, <span class="string">"ã€onPostExecuteã€‘- Non-Main"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isMainThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Looper.myLooper() != <span class="keyword">null</span> &amp;&amp; Looper.myLooper() == Looper.getMainLooper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>-<span class="number">29</span> <span class="number">21</span>:<span class="number">29</span>:<span class="number">41.959</span>     <span class="number">905</span>-<span class="number">2384</span>/com.footprint.littleshell E/MyTaskï¹• ã€onPreExecuteã€‘- Non-Main</span><br><span class="line"><span class="number">02</span>-<span class="number">29</span> <span class="number">21</span>:<span class="number">29</span>:<span class="number">42.389</span>     <span class="number">905</span>-<span class="number">2385</span>/com.footprint.littleshell E/MyTaskï¹• ã€doInBackgroundã€‘- Non-Main</span><br><span class="line"><span class="number">02</span>-<span class="number">29</span> <span class="number">21</span>:<span class="number">29</span>:<span class="number">42.389</span>     <span class="number">905</span>-<span class="number">905</span>/com.footprint.littleshell E/MyTaskï¹• ã€onPostExecuteã€‘- Main</span><br></pre></td></tr></table></figure>
<p>ç»“æœéªŒè¯äº†ä¹‹å‰å…³äºonPreExecute()æ–¹æ³•çš„ç»“è®ºã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Handler æºç åˆ†æ]]></title>
      <url>http://www.timebridge.space/2015/11/23/Android-Handler/</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ã€ç¯å¢ƒã€‘æºç åˆ†æåŸºäº 4.4.2_r1ã€‚</p>
<h2 id="Handlerçš„ä½¿ç”¨"><a href="#Handlerçš„ä½¿ç”¨" class="headerlink" title="Handlerçš„ä½¿ç”¨"></a>Handlerçš„ä½¿ç”¨</h2><p>æ—¥å¸¸å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ç”¨åˆ°Handlerï¼ŒHandlerç”¨äºå‘ä¸€ä¸ªçº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯å¹¶è´Ÿè´£å¤„ç†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨å®ƒå®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦ã€å°†è€—æ—¶ä»»åŠ¡æ”¾åˆ°å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå¹¶åœ¨æ‰§è¡Œå®Œæ¯•åé€šçŸ¥ä¸»çº¿ç¨‹æ›´æ–°UIç­‰åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå°ğŸŒ°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºHandler</span></span><br><span class="line">Handler myHandler = <span class="keyword">new</span> Handler() &#123; </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;   </span><br><span class="line">		<span class="keyword">switch</span> (msg.what) &#123;  </span><br><span class="line">		&#125;   </span><br><span class="line">		<span class="keyword">super</span>.handleMessage(msg);   </span><br><span class="line">	&#125;   </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡Handlerå‘é€æ¶ˆæ¯</span></span><br><span class="line">Message message = <span class="keyword">new</span> Message();      </span><br><span class="line">message.what = <span class="number">1</span>;      </span><br><span class="line">myHandler.sendMessage(message);</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨Handlerçš„ç»å…¸è¿‡ç¨‹ï¼šå‘å‡ºçš„æ¶ˆæ¯ä¼šåœ¨æ—¶é—´åˆ°è¾¾çš„æ—¶å€™è¿›å…¥åˆ°Handlerçš„handleMessageä¸­è¢«å¤„ç†ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥æ¢ç©¶ä¸€ä¸‹Messageä»è¢«åˆ›å»ºåˆ°è¢«å¤„ç†åˆ°åº•ç»å†äº†ä»€ä¹ˆæ ·çš„è¿‡ç¨‹ã€‚<a id="more"></a></p>
<h2 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h2><p>å¦‚ğŸŒ°æ‰€ç¤ºï¼Œæˆ‘ä»¬ä»new Handler()åˆ‡å…¥ï¼Œç„¶åè¿½è¸ªsendMessageæ–¹æ³•ï¼ŒæŸ¥çœ‹Messageå¯¹è±¡å¦‚ä½•è¿›å…¥handleMessageæ–¹æ³•ï¼Œä¸€æ­¥æ­¥å‰–æï¼Œè§£ææ•´ä¸ªæµç¨‹ã€‚</p>
<h3 id="Handlerç‰‡æ®µâ€”â€”Handleråˆ›å»º"><a href="#Handlerç‰‡æ®µâ€”â€”Handleråˆ›å»º" class="headerlink" title="Handlerç‰‡æ®µâ€”â€”Handleråˆ›å»º"></a>Handlerç‰‡æ®µâ€”â€”Handleråˆ›å»º</h3><p>å…ˆçœ‹ä¸€ä¸‹Handlerçš„åˆ›å»ºè¿‡ç¨‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</span><br><span class="line">		<span class="keyword">final</span> Class&lt;? extends Handler&gt; klass = getClass();</span><br><span class="line">		<span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</span><br><span class="line">				(klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</span><br><span class="line">			Log.w(TAG, <span class="string">"The following Handler class should be static or leaks might occur: "</span> + klass.getCanonicalName());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mLooper = Looper.myLooper();</span><br><span class="line">	<span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	mQueue = mLooper.mQueue;<span class="comment">//è·å–æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">	mCallback = callback;</span><br><span class="line">	mAsynchronous = async;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé‡ç‚¹æ˜¯ <strong>mLooper = Looper.myLooper();</strong> ä»¥åŠåé¢ä¸‰è¡Œä»£ç ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œæ–°å»ºä¸€ä¸ªHandlerçš„æ—¶å€™ï¼Œå¦‚æœLooper.myLooperä¸ºnullï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›å¦‚æœä¸ä¸ºnullï¼Œåˆ™è·å–Looperä¸­çš„mQueueã€‚å…¶ä½™ä¸¤ä¸ªå‚æ•°ä¸æ˜¯é‡ç‚¹ï¼Œæš‚ä¸åˆ†æã€‚</p>
<h3 id="Looperç‰‡æ®µâ€”â€”Looperåˆ›å»º"><a href="#Looperç‰‡æ®µâ€”â€”Looperåˆ›å»º" class="headerlink" title="Looperç‰‡æ®µâ€”â€”Looperåˆ›å»º"></a>Looperç‰‡æ®µâ€”â€”Looperåˆ›å»º</h3><p>Androidä¸­æä¾›äº†ç›¸å…³æ­¥éª¤ï¼Œå¯ä»¥ä½¿å¾—ä¸€ä¸ªæ™®é€šThreadä¹Ÿå…·å¤‡æ¶ˆæ¯å¾ªç¯å¤„ç†æœºåˆ¶ï¼ˆå› ä¸ºä¸»çº¿ç¨‹é»˜è®¤åšäº†ä¸€äº›æ“ä½œï¼Œå› æ­¤ä¸å¥½åˆ†æï¼Œæˆ‘ä»¬ä»æ™®é€šçº¿ç¨‹å…¥æ‰‹ï¼Œå¯ä»¥æ›´æ¸…æ¥šçš„çœ‹åˆ°æ•´ä¸ªåˆ›å»ºè¿‡ç¨‹ï¼‰ã€‚ç¤ºä¾‹ä»£ç å¯ä»¥åœ¨Looperæºç (ç±»æ³¨é‡Š)ä¸­æ‰¾åˆ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">     <span class="keyword">public</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          Looper.prepare();</span><br><span class="line"></span><br><span class="line">          mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                 <span class="comment">// process incoming messages here</span></span><br><span class="line">              &#125;</span><br><span class="line">         &#125;;</span><br><span class="line">         Looper.loop();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¶‰åŠåˆ°å¦å¤–ä¸€ä¸ªé‡è¦çš„å¯¹è±¡ï¼š<strong>Looper</strong>ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ <strong>Looper.prepare();</strong> æ–¹æ³•ï¼Œæºç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Initialize the current thread as a looper.</span></span><br><span class="line"><span class="comment"> * This gives you a chance to create handlers that then reference</span></span><br><span class="line"><span class="comment"> * this looper, before actually starting the loop. Be sure to call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #loop()&#125; after calling this method, and end it by calling</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #quit()&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	prepare(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹å¼‚å¸¸ï¼Œå¼‚å¸¸æ¶ˆæ¯çš„å«ä¹‰æ˜¯ï¼šæ¯ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªLooperã€‚è€Œåˆ¤æ–­çš„æ¡ä»¶æ˜¯ï¼Œä»sThreadLocalä¸­è·å–çš„å¯¹è±¡ä¸ä¸ºnullâ€”â€”<a href="http://www.muzileecoding.com/java/Java-threadlocal.html" target="_blank" rel="noopener">ThreadLocal</a>æ§åˆ¶æ¯ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªLooperå®ä¾‹ã€‚<br>å¦‚æœä¹‹å‰æ²¡æœ‰åˆ›å»ºLooperï¼Œåˆ™ä¼šå®ä¾‹åŒ–ä¸€ä¸ªLooperï¼Œçœ‹ä¸€ä¸‹æ„é€ æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯ç§æœ‰çš„</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">	mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</span><br><span class="line">	mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ å‡½æ•°åˆ†ä¸ºä¸¤æ­¥ï¼š1ï¼‰åˆ›å»ºäº†ä¸€ä¸ªMessageQueueï¼›2ï¼‰è·å–å½“å‰çš„çº¿ç¨‹ã€‚æ³¨æ„mQueueè¿™ä¸ªå˜é‡ï¼Œå°±æ˜¯ä¸Šä¸€èŠ‚ä¸­Handlerä»Looperä¸­è·å–çš„æ¶ˆæ¯é˜Ÿåˆ—å¯¹è±¡ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†Handlerã€Looperå’ŒMessageQueueä¸‰ä¸ªå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ã€‚æˆ‘ä»¬çŸ¥é“ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„ç‚¹:</p>
<ol>
<li>new Handler()ä¹‹å‰ï¼Œå¿…é¡»ä¿è¯Looper.myLooper()æ–¹æ³•çš„è¿”å›ä¸ä¸ºnullï¼›</li>
<li>Looperåœ¨æ–°å»ºçš„æ—¶å€™ä¼šå»ºç«‹å¯¹åº”çš„MessageQueueï¼Œå¹¶ä¸”prepare()æ–¹æ³•ä¼šé€šè¿‡ThreadLocalä¿è¯æ¯ä¸€ä¸ªçº¿ç¨‹åªä¼šå®ä¾‹åŒ–ä¸€ä¸ªLooperã€‚</li>
<li>Handleræ—¢ä¼šæŒæœ‰Looperçš„å¼•ç”¨ï¼Œåˆä¼šæŒæœ‰MessageQueueçš„å¼•ç”¨ï¼›</li>
</ol>
<p>ä½†æ˜¯è¿™å‡ ä¸ªç±»ä¹‹é—´çš„å…³ç³»æˆ‘ä»¬å´ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œä¸‹é¢è§£é‡Šã€‚</p>
<h3 id="çº¿ç¨‹ã€Handlerã€Looperçš„è”ç³»"><a href="#çº¿ç¨‹ã€Handlerã€Looperçš„è”ç³»" class="headerlink" title="çº¿ç¨‹ã€Handlerã€Looperçš„è”ç³»"></a>çº¿ç¨‹ã€Handlerã€Looperçš„è”ç³»</h3><p>åœ¨æ¶ˆæ¯æœºåˆ¶é‡Œé¢ï¼ŒLooperåªæ˜¯è´Ÿè´£ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œè€ŒHandleråˆ™æ˜¯è´Ÿè´£å‘é€æ¶ˆæ¯ä»¥åŠå¤„ç†æ¶ˆæ¯çš„ï¼Œé‚£ä¹ˆHandlerå’ŒLooperåˆæ˜¯å¦‚ä½•ç»‘å®šåˆ°ä¸€èµ·çš„å‘¢ï¼Ÿä»Handlerçš„æºç çœ‹ï¼Œå…³é”®ä»£ç æ˜¯:  <strong>mLooper = Looper.myLooper();</strong> ï¼Œæºç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * null if the calling thread is not associated with a Looper.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒæŠŠæ³¨é‡Šä¹ŸCopyè¿‡æ¥äº†ï¼ŒmyLooperæ–¹æ³•æ˜¯ç›´æ¥ä»sThreadLocalä¸­è¯»å–çš„å˜é‡ï¼Œæ³¨é‡Šè¯´åˆ°ï¼šmyLooper()æ–¹æ³•åœ¨å½“å‰æ²¡æœ‰Looperç»‘å®šåˆ°è°ƒç”¨çº¿ç¨‹æ—¶ä¼šè¿”å›nullã€‚æœç´¢æ•´ä¸ªLooperç±»ï¼Œä¼šå‘ç°åªæœ‰å‰é¢æåˆ°çš„prepare()æ–¹æ³•ä¸­æœ‰sThreadLocal.set()è°ƒç”¨ã€‚å³åœ¨ä¸ºä¸€ä¸ªçº¿ç¨‹å®ä¾‹åŒ–Handlerä¹‹å‰ï¼Œå¿…é¡»åœ¨è¯¥çº¿ç¨‹ä¸­è°ƒç”¨Looper.prepare()æ–¹æ³•ï¼šåªæœ‰è¿™æ ·ï¼Œæ‰èƒ½ä¸ºä¸€ä¸ªçº¿ç¨‹å»ºç«‹å¯¹åº”çš„Looperâ€”â€”è¿™è§£é‡Šäº†å‰é¢LooperThreadä»£ç çš„æ„å»ºé€»è¾‘ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡è°ƒç”¨Looper.prepare()æ–¹æ³•ä¸€æ¬¡ï¼Œå°±å¯ä»¥å°†ä¸€ä¸ªLooperå¯¹è±¡ç»‘å®šåˆ°æ–¹æ³•è°ƒç”¨çº¿ç¨‹ä¸Šå»(å³è®¾ç½®åˆ°ThreadLocalä¸­)ã€‚æ–°å»ºHandlerçš„æ—¶å€™ï¼ŒHandlerä¼šç›´æ¥è°ƒç”¨Looper.myLoop()æ–¹æ³•è·å–ç»‘å®šåˆ°çº¿ç¨‹çš„Looperå¹¶é€šè¿‡è¿™ä¸ªLooperè·å–åˆ°å¯¹åº”çš„MessageQueueã€‚</p>
<p>è¿™å°±æ˜¯è¿™å‡ ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»ã€‚</p>
<h3 id="Looperç‰‡æ®µâ€”â€”Looper-loop"><a href="#Looperç‰‡æ®µâ€”â€”Looper-loop" class="headerlink" title="Looperç‰‡æ®µâ€”â€”Looper.loop()"></a>Looperç‰‡æ®µâ€”â€”Looper.loop()</h3><p>LooperThreadæ„å»ºçš„æœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨Loop.loop()æ–¹æ³•ï¼Œå®ƒçš„æºç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run the message queue in this thread. Be sure to call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">	<span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">	<span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">	Binder.clearCallingIdentity();</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">		<span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">		Printer logging = me.mLogging;</span><br><span class="line">			<span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">  				logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</span><br><span class="line">                        msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			msg.target.dispatchMessage(msg);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">				logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">			<span class="comment">// identity of the thread wasn't corrupted.</span></span><br><span class="line">			<span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">			<span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">				Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></span><br><span class="line">                        + Long.toHexString(ident) + <span class="string">" to 0x"</span></span><br><span class="line">                        + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></span><br><span class="line">                        + msg.target.getClass().getName() + <span class="string">" "</span></span><br><span class="line">                        + msg.callback + <span class="string">" what="</span> + msg.what);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			msg.recycle();<span class="comment">//å›æ”¶æ¶ˆæ¯ï¼Œæ³¨æ„è¿™ä¸ªä½ç½®</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼ŒåŒæ ·è¦æ±‚myLooperä¸èƒ½ä¸ºnullï¼ˆæ ¹æ®å‰é¢çš„åˆ†æï¼Œå®ç°è°ƒç”¨Looper.prepareï¼ˆ)æ–¹æ³•å³å¯ï¼‰å¹¶ä»è¿™ä¸ªLooperä¸­æ‹¿åˆ°ç›¸åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¹‹åæˆ‘ä»¬è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯ä¸­æœ€é‡è¦çš„äº‹æƒ…å°±æ˜¯queue.next()æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•æ ¹æ®æ³¨é‡Šï¼šå¯èƒ½ä¼šå¼•èµ·é˜»å¡ã€‚ç›¸å…³çš„å®ç°å¯ä»¥æ·±å…¥åˆ°MessageQueueä¸­ï¼Œè¿™é‡Œæ¶‰åŠåˆ°Nativeä»£ç ï¼Œå…·ä½“çš„ç†è§£ä¸å½±å“åˆ°åŸç†è®²è¿°ï¼Œæš‚ä¸”ä¸è¡¨ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åˆ¤æ–­ï¼šå¦‚æœMessageæ‹¿å‡ºæ¥ä¸ºç©ºï¼Œåˆ™è®¤ä¸ºè¿™ä¸ªMessageQueueå·²ç»è¢«ä¸¢å¼ƒäº†ï¼Œæ•´ä¸ªå¾ªç¯ä¼šè¢«æ‰“ç ´è¿”å›ï¼Œè¯»è€…å¯ä»¥æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p>å†ä¹‹åå°±è¿›å…¥åˆ°msg.target.dispatchMessageæ–¹æ³•ã€‚å³æ¶ˆæ¯çš„åˆ†å‘å’Œå¤„ç†ã€‚</p>
<h3 id="å…³ç³»æ€»ç»“"><a href="#å…³ç³»æ€»ç»“" class="headerlink" title="å…³ç³»æ€»ç»“"></a>å…³ç³»æ€»ç»“</h3><p>è¿™é‡Œæ€»ç»“ä¸€ä¸‹: </p>
<ol>
<li>æˆ‘ä»¬åœ¨è®©ä¸€ä¸ªçº¿ç¨‹å…·å¤‡æ¶ˆæ¯å¾ªç¯è°ƒåº¦èƒ½åŠ›çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨Looper.prepare()ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œå®ƒä¼šä¸ºä¸€ä¸ªçº¿ç¨‹ç»‘å®šä¸€ä¸ªLooperï¼Œä¸”åªèƒ½ç»‘å®šä¸€ä¸ªã€‚åˆ›å»ºLooperçš„åŒæ—¶ï¼ŒLooperä¼šåˆ›å»ºä¸€ä¸ªMessageQueueã€‚ä¹‹ååœ¨çº¿ç¨‹ä¸­åˆ›å»ºHandlerçš„æ—¶å€™ï¼Œä¼šä»Looperä¸­å¼•ç”¨MessageQueueæ”¾åˆ°Handlerå®ä¾‹ä¸­å»ã€‚è‡³æ­¤Handlerã€Looperã€MessageQueueä¸‰ä¸ªç±»çš„å…³ç³»å»ºç«‹ã€‚</li>
<li>å…³ç³»å»ºç«‹ä¹‹åï¼Œè°ƒç”¨Looper.loop()æ–¹æ³•ä¼šè®©Loopè¿è¡Œèµ·æ¥ï¼šä¸æ–­ä»MessageQueueä¸­è·å–handleré€šè¿‡sendMessageå‘é€çš„Messageå¹¶dispatchMessageã€‚è‡³æ­¤ï¼Œæ•´ä¸ªæ¶ˆæ¯å¾ªç¯çš„æ ¸å¿ƒéƒ¨åˆ†æ„å»ºå®Œæ¯•ã€‚</li>
</ol>
<h3 id="æ¶ˆæ¯çš„åˆ†å‘å’Œå¤„ç†"><a href="#æ¶ˆæ¯çš„åˆ†å‘å’Œå¤„ç†" class="headerlink" title="æ¶ˆæ¯çš„åˆ†å‘å’Œå¤„ç†"></a>æ¶ˆæ¯çš„åˆ†å‘å’Œå¤„ç†</h3><p>æ•´ä¸ªæ¶ˆæ¯å¾ªç¯æ ¸å¿ƒéƒ¨åˆ†å·²ç»è¿è¡Œèµ·æ¥ï¼Œå‰©ä¸‹æ¥çš„å°±æ˜¯æˆ‘ä»¬æ—¥å¸¸æœ€é•¿ä½¿ç”¨åˆ°çš„æ¶ˆæ¯çš„å‘é€å’Œå¤„ç†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹æ¶ˆæ¯ä»å‘é€åˆ°å¤„ç†ä¹‹é—´çš„æµç¨‹ã€‚é¦–å…ˆæ˜¯sendMessageæ–¹æ³•æºç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Enqueue a message into the message queue after all pending messages</span></span><br><span class="line"><span class="comment"> * before the absolute time (in milliseconds) &lt;var&gt;uptimeMillis&lt;/var&gt;.</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;The time-base is &#123;<span class="doctag">@link</span> android.os.SystemClock#uptimeMillis&#125;.&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * You will receive it in &#123;<span class="doctag">@link</span> #handleMessage&#125;, in the thread attached</span></span><br><span class="line"><span class="comment"> * to this handler.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uptimeMillis The absolute time at which the message should be</span></span><br><span class="line"><span class="comment"> *         delivered, using the</span></span><br><span class="line"><span class="comment"> *         &#123;<span class="doctag">@link</span> android.os.SystemClock#uptimeMillis&#125; time-base.</span></span><br><span class="line"><span class="comment"> *         </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Returns true if the message was successfully placed in to the </span></span><br><span class="line"><span class="comment"> *         message queue.  Returns false on failure, usually because the</span></span><br><span class="line"><span class="comment"> *         looper processing the message queue is exiting.  Note that a</span></span><br><span class="line"><span class="comment"> *         result of true does not mean the message will be processed -- if</span></span><br><span class="line"><span class="comment"> *         the looper is quit before the delivery time of the message</span></span><br><span class="line"><span class="comment"> *         occurs then the message will be dropped.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">	MessageQueue queue = mQueue;</span><br><span class="line">		<span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</span><br><span class="line">			RuntimeException e = <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</span><br><span class="line">			Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹æºç å°±ä¼šå‘ç°ï¼ŒåŒå&amp;åŠŸèƒ½ç›¸ä¼¼çš„æœ‰å¥½å‡ ä¸ªæ–¹æ³•ï¼Œä½†æœ€ç»ˆéƒ½ä¼šè°ƒç”¨sendMessageAtTimeæ–¹æ³•ï¼Œé¦–å…ˆè·å–mQueueï¼šæ³¨æ„è¿™ä¸ªæ–¹æ³•åœ¨Handleræ–°å»ºçš„æ—¶å€™å°±è·å–äº†ã€‚ä¹‹åè°ƒç”¨äº†ä¸€ä¸ªenqueueMessageæ–¹æ³•ï¼Œæºç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">	msg.target = <span class="keyword">this</span>;</span><br><span class="line">	<span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">		msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œå°†msg.targetèµ‹å€¼ä¸ºæœ¬èº«ï¼Œä¹‹åæ ¹æ®Handleræ–°å»ºæ—¶å€™ä¼ å…¥çš„å‚æ•°(å‰é¢å¿½ç•¥äº†å®ƒ)è®¾ç½®msgå±æ€§ï¼Œä¹‹åå°±è°ƒqueueçš„enqueueMessageå‘é˜Ÿåˆ—ä¸­å‹å…¥æ¶ˆæ¯â€”â€”<strong>å®Œæˆæ¶ˆæ¯çš„å‘é€</strong>ã€‚</p>
<p>è¿™é‡Œå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯<strong>msg.target = this;</strong>ã€‚æŸ¥çœ‹Messageçš„æºç å°±å¯ä»¥çœ‹åˆ°ï¼Œtargetæ˜¯ä¸€ä¸ªHandlerå˜é‡ã€‚è€Œåœ¨å‰é¢è®²è¿°çš„Looper.loop()æ–¹æ³•å®ç°ä¸­ï¼Œå–å‡ºæ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³•æ˜¯msg.target.dispatchMessage(msg);ã€‚å˜¿ï¼è¿™éš¾é“ä¸æ˜¯è°ƒç”¨çš„Handlerçš„dispatchMessageæ–¹æ³•ä¹ˆï¼Ÿçœ‹æºç æœç„¶å‘ç°ä¸€æš:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">		handleCallback(msg);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		handleMessage(msg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤šæˆ‘ä»¬å¹³æ—¶ä¸å¸¸ç”¨çš„æ–¹æ³•:</p>
<p>ã€ 1 ã€‘Messageæ˜¯å¯ä»¥è‡ªå¸¦ä¸€ä¸ªcallbackå˜é‡çš„ï¼ŒæŸ¥çœ‹Meesgaeæºç å¯çŸ¥è¿™æ˜¯ä¸€ä¸ªRunnableå˜é‡ï¼Œå³æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªMessageå®ç°postä¸€ä¸ªRunableå¯¹è±¡çš„åŠŸèƒ½ï¼Œå› ä¸ºhandleCallbackçš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleCallback</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">	message.callback.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šè¯»è€…å¯ä»¥æŸ¥çœ‹Handler.postDelayed(Runnable)æ–¹æ³•ï¼Œå†…éƒ¨æ­£å¼åšäº†è¿™ä¸€å±‚è½¬æ¢ã€‚</p>
<p>ã€ 2 ã€‘å¦‚æœå®ä¾‹åŒ–Handlerçš„æ—¶å€™è®¾ç½®äº†mCallbackå¯¹è±¡ï¼ˆæ—¥å¸¸å¼€å‘å¾ˆå°‘ç”¨ï¼Œä½†çš„ç¡®å­˜åœ¨è¿™ç§ç”¨æ³•ï¼‰ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å°å¼Ÿéƒ½å…ˆäº¤ç»™mCallbackå¤„ç†ï¼ŒmCallbackæ˜¯ä¸€ä¸ªCallBackå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™è¾¹å¯ä»¥é€šè¿‡è¿”å›trueæ¥æ‹¦æˆªhandleMessageçš„æ‰§è¡Œã€‚</p>
<p>ã€ 3 ã€‘ä»¥ä¸Šéƒ½ç»•è¿‡äº†ï¼Œæ‰è½®åˆ°handleMessageæ–¹æ³•æ‰§è¡Œâ€”â€”å…³äºè¿™ä¸ªæ–¹æ³•ï¼Œå°±ä¸å¤šè¯´äº†ï¼Œå†™Handlerçš„æ—¶å€™è‚¯å®šä¼šé‡è½½å®ƒã€‚</p>
<p>åˆ°æ­¤ï¼Œæ¶ˆæ¯çš„å¤„ç†åˆ†æå®Œæ¯•ã€‚</p>
<h2 id="å‰–ææ€»ç»“"><a href="#å‰–ææ€»ç»“" class="headerlink" title="å‰–ææ€»ç»“"></a>å‰–ææ€»ç»“</h2><p>åˆ°è¿™é‡Œï¼Œå¯¹äºæ•´ä¸ªæ¶ˆæ¯å¤„ç†å‘é€ã€å¾ªç¯ã€å‘é€çš„æœºåˆ¶åŸºæœ¬è§£é‡Šæ¸…æ¥šã€‚å‰©ä¸‹ä¸€å—æ¯”è¾ƒæ¨¡ç³Šï¼šMessageQueueçš„åˆ†ææ¯”è¾ƒå°‘ï¼ŒåŸå› æ˜¯è¿™å—æ¶‰åŠåˆ°ä¸€äº›Nativeä»£ç ï¼Œä¸”å¯¹ç†è§£æ•´ä¸ªHandleræœºåˆ¶çš„ç†è§£å½±å“ä¸å¤§ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­æš‚ä¸åˆ†æã€‚</p>
<p>æˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥æ€»ç»“ä¸€ä¸‹å‡ ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/HandleråŸç†å›¾.png" alt="Handleræ¶ˆæ¯æµè½¬å›¾"></p>
<p>è¯¥å›¾é‡ç‚¹å±•ç¤ºäº†å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>Handlerç›´æ¥å‘MessageQueueä¸­å‘é€æ¶ˆæ¯ï¼›</li>
<li>Looperè´Ÿè´£è·å–æ¶ˆæ¯å¹¶ä½œåˆ†å‘ï¼ˆä½†æ˜¯å…·ä½“åˆ†å‘åˆ°å“ªä¸ªHandleræ˜¯ç”±Messageçš„targetå±æ€§å†³å®šçš„ï¼‰ï¼›</li>
<li><strong>ä¸€ä¸ªçº¿ç¨‹åªä¼šæœ‰ä¸€ä¸ªLooperå’Œä¸€ä¸ªMessageQueueï¼Œä¸è®ºè¯¥çº¿ç¨‹æœ‰å¤šå°‘ä¸ªHandlerï¼Œå®ƒä»¬éƒ½å…¬ç”¨è¿™ä¸ªLooperå’ŒMessageQueueï¼›</strong></li>
</ol>
<p>HandlerThreadæ˜¯ä¸²è¡ŒåŒ–æ‰§è¡Œä»»åŠ¡ï¼Œå› æ­¤åœ¨é‡Œé¢æ‰§è¡Œä»»åŠ¡æ˜¯çº¿ç¨‹å®‰å…¨çš„(æŒ‡çš„æ˜¯ä»»åŠ¡ä¹‹é—´ï¼Œè€Œä¸æ˜¯å’Œå…¶ä½™çº¿ç¨‹ä¹‹é—´)ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿéœ€è¦æ³¨æ„å°†è€—æ—¶ä»»åŠ¡å’Œéè€—æ—¶ä»»åŠ¡åŒºåˆ†åœ¨ä¸åŒçš„é˜Ÿåˆ—é‡Œé¢ï¼Œæé«˜æ•ˆç‡ã€‚è¿™ä¸ªç±»è¿˜å¾ˆé€‚åˆæ‰§è¡Œé“¾å¼ä»»åŠ¡ï¼Œæ¯”å¦‚ç¼–è¯‘ä»»åŠ¡ã€‚</p>
<h2 id="ä¸€äº›é—®é¢˜"><a href="#ä¸€äº›é—®é¢˜" class="headerlink" title="ä¸€äº›é—®é¢˜"></a>ä¸€äº›é—®é¢˜</h2><h3 id="ä¸»çº¿ç¨‹å’Œä¸»Handler"><a href="#ä¸»çº¿ç¨‹å’Œä¸»Handler" class="headerlink" title="ä¸»çº¿ç¨‹å’Œä¸»Handler"></a>ä¸»çº¿ç¨‹å’Œä¸»Handler</h3><p>åœ¨æ‰€æœ‰çš„çº¿ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹æ˜¯éå¸¸ç‰¹æ®Šçš„ï¼Œå¼€å‘æ—¶åœ¨ä¸»çº¿ç¨‹ä¸­æ–°å»ºHandlerçš„å®ä¾‹ä¸éœ€è¦èµ°ä¸Šé¢çš„æµç¨‹ï¼Œç›´æ¥åˆ›å»ºå³å¯ï¼Œå®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„è§£é‡Šæ˜¯ï¼Œä¸»çº¿ç¨‹æœ¬èº«å°±å·²ç»å¯åŠ¨Looperäº†ã€‚å…¶å®åœ¨Looperä¸­ï¼Œæ˜¯æœ‰ä¸€ä¸ªä¸“é—¨çš„æ–¹æ³•åšè¿™ä»¶äº‹çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the current thread as a looper, marking it as an</span></span><br><span class="line"><span class="comment"> * application's main looper. The main looper for your application</span></span><br><span class="line"><span class="comment"> * is created by the Android environment, so you should never need</span></span><br><span class="line"><span class="comment"> * to call this function yourself.  See also: &#123;<span class="doctag">@link</span> #prepare()&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	prepare(<span class="keyword">false</span>);</span><br><span class="line">	<span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">		<span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		sMainLooper = myLooper();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„çœ‹æ³¨é‡Šï¼ï¼ï¼è¿™ä¸ªæ–¹æ³•å°±æ˜¯åˆ›å»ºä¸»çº¿ç¨‹çš„Looperçš„ã€‚æ³¨é‡Šä¸­è¯´ï¼Œè¿™ä¸ªåˆ›å»ºæ˜¯ç”±Android Environmentæ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¼€å‘è€…<strong>ä»æ¥ä¸éœ€è¦</strong>æ‰‹åŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚è€Œä¸‹é¢è¿™ä¸ªæ–¹æ³•åˆ™æ˜¯ç”¨äºè·å–ä¸»Looperçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Returns the application's main looper, which lives in the main thread of the application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title">getMainLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">		<span class="keyword">return</span> sMainLooper;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ¶ˆæ¯çš„recycle"><a href="#æ¶ˆæ¯çš„recycle" class="headerlink" title="æ¶ˆæ¯çš„recycle"></a>æ¶ˆæ¯çš„recycle</h3><p>Messageå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€æœ‰è¢«å›æ”¶çš„Messageéƒ½æŒ‚åœ¨è¿™ä¸ªé“¾è¡¨ä¸Šã€‚å…³é”®çš„æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object sPoolSync = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Message sPool;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> sPoolSize = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_POOL_SIZE = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return a new Message instance from the global pool. Allows us to</span></span><br><span class="line"><span class="comment"> * avoid allocating new objects in many cases.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">		<span class="keyword">if</span> (sPool != <span class="keyword">null</span>) &#123;</span><br><span class="line">			Message m = sPool;</span><br><span class="line">			sPool = m.next;</span><br><span class="line">			m.next = <span class="keyword">null</span>;</span><br><span class="line">			m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></span><br><span class="line">			sPoolSize--;</span><br><span class="line">			<span class="keyword">return</span> m;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Message();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (isInUse()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (gCheckRecycle) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"This message cannot be recycled because it "</span></span><br><span class="line">                        + <span class="string">"is still in use."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	recycleUnchecked();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recycleUnchecked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Mark the message as in use while it remains in the recycled object pool.</span></span><br><span class="line">	<span class="comment">// Clear out all other details.</span></span><br><span class="line">	flags = FLAG_IN_USE;</span><br><span class="line">	what = <span class="number">0</span>;</span><br><span class="line">	arg1 = <span class="number">0</span>;</span><br><span class="line">	arg2 = <span class="number">0</span>;</span><br><span class="line">	obj = <span class="keyword">null</span>;</span><br><span class="line">	replyTo = <span class="keyword">null</span>;</span><br><span class="line">	sendingUid = -<span class="number">1</span>;</span><br><span class="line">	when = <span class="number">0</span>;</span><br><span class="line">	target = <span class="keyword">null</span>;</span><br><span class="line">	callback = <span class="keyword">null</span>;</span><br><span class="line">	data = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">		<span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</span><br><span class="line">			next = sPool;</span><br><span class="line">			sPool = <span class="keyword">this</span>;</span><br><span class="line">			sPoolSize++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateCheckRecycle</span><span class="params">(<span class="keyword">int</span> targetSdkVersion)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">		gCheckRecycle = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ¶ˆæ¯æœºåˆ¶ä¸‹é¢å…¶å®ç»´æŠ¤ç€ä¸€ä¸ªæ¶ˆæ¯é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨å……å½“ç€å¯¹è±¡æ± çš„è§’è‰²ï¼Œå› æ­¤å»ºè®®å¤§å®¶ä½¿ç”¨obtain()æ¥â€œåˆ›å»ºâ€æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥é¿å…åˆ›å»ºå¤§é‡çš„Messageå¯¹è±¡ã€‚è¡¥å……ä¸€ç‚¹ï¼šæ¶ˆæ¯ä¼šåœ¨è¢«å‹å…¥é˜Ÿåˆ—æ—¶ç½®ä¸ºFLAG_IN_USEã€‚  </p>
<blockquote>
<p>ã€æ³¨æ„ã€‘åœ¨5.0ä»¥ä¸‹çš„æ—¶å€™ï¼ŒgCheckRecycleå¼€å…³æ˜¯å…³é—­çš„ï¼Œè¿™æ„å‘³ç€å›æ”¶æ—¶ä¸ä¼šå»æ£€æŸ¥Messageæ˜¯å¦åœ¨ä½¿ç”¨ä¸­ã€‚è€Œåœ¨5.0ä»¥ä¸Šå°±ä¼šæ£€æŸ¥ï¼Œæ­¤å¤„å¾ˆå‘çˆ¹çš„æ˜¯ï¼šFLAG_IN_USEæ ‡å¿—ä½çš„é‡ç½®æ˜¯åœ¨obtainçš„æ—¶å€™æ¸…é™¤é‡ç½®çš„ï¼Œåœ¨è¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—åˆ™ä¼šè¢«ç½®ä½ã€‚ä»å‰é¢Looper.loop()æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªæ¶ˆæ¯ä¼šåœ¨dispatchMessageä¹‹åç«‹åˆ»è°ƒç”¨recycleæ–¹æ³•ï¼Œæ­¤æ—¶æ¶ˆæ¯çš„FLAG_IN_USEè¿˜æ²¡æœ‰è¢«é‡ç½®ï¼Œrecycleå¿…ç„¶å¯¼è‡´å¼‚å¸¸æŠ›å‡ºâ€”â€”è¿™åº”è¯¥æ˜¯SDKçš„ä¸€ä¸ªBugã€‚</p>
</blockquote>
<h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><ol>
<li>ä»¥ä¸‹æ–¹æ³•è¢«ä»MessageQueueæš´éœ²åˆ°Handleré‡Œé¢:<code>hasMeesgae()</code>ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å¥½å‡ ä¸ªé‡è½½æ–¹æ³•ï¼Œå¯ä»¥å…³æ³¨ä¸€ä¸‹ï¼Œç”¨äºåˆ¤æ–­é˜Ÿåˆ—ä¸­æœ‰æ²¡æœ‰ç‰¹å®šçš„æ¶ˆæ¯;</li>
<li>Handlerè¿˜æœ‰ä¸€ä¸ªè¿™æ ·çš„æ–¹æ³•: <code>Handler.postAtFrontOfQueue()</code>ï¼Œå¯ä»¥è®©æ¶ˆæ¯æ’é˜Ÿ;</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java ConcurrentHashMapè¡¥å……]]></title>
      <url>http://www.timebridge.space/2015/11/21/Java-ConcurrentHashMap/</url>
      <content type="html"><![CDATA[<p>åŸºäº<a href="https://www.ibm.com/developerworks/cn/java/java-lo-concurrenthashmap/" target="_blank" rel="noopener">ã€Šæ¢ç´¢ ConcurrentHashMap é«˜å¹¶å‘æ€§çš„å®ç°æœºåˆ¶ã€‹</a>åšæ€»ç»“å’Œè¡¥å……ã€‚</p>
<p>å‰æ: IBM çš„è¿™ç¯‡æ–‡ç« æ˜¯åŸºäº JDK 1.6 çš„ï¼Œç°åœ¨JDKå·²ç»åˆ° 1.8ï¼Œè¯»è€…å¯ä»¥åˆ†åˆ«ä¸‹è½½ <a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b27/java/util/concurrent/ConcurrentHashMap.java#ConcurrentHashMap" target="_blank" rel="noopener">1.6</a> å’Œ <a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/util/concurrent/ConcurrentHashMap.java#ConcurrentHashMap" target="_blank" rel="noopener">1.8</a> ä»£ç é˜…è¯»ã€‚</p>
<h2 id="è¡¥å……ä¸€ï¼šConcurrentHashMap-å’Œ-Segmentçš„å»ºç«‹"><a href="#è¡¥å……ä¸€ï¼šConcurrentHashMap-å’Œ-Segmentçš„å»ºç«‹" class="headerlink" title="è¡¥å……ä¸€ï¼šConcurrentHashMap å’Œ Segmentçš„å»ºç«‹"></a>è¡¥å……ä¸€ï¼šConcurrentHashMap å’Œ Segmentçš„å»ºç«‹</h2><p>å…¶å®æ–‡ç« ä¸­å·²ç»è®²è¿°äº†è¯¥è¿‡ç¨‹ï¼Œä¸è¿‡æ¡ç†ä¸æ¸…æ™°ã€‚çœ‹ä¸€ä¸‹ConcurrentHashMapçš„æ„é€ å‡½æ•°ï¼š<a id="more"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (concurrencyLevel &gt; MAX_SEGMENTS)</span><br><span class="line">		concurrencyLevel = MAX_SEGMENTS;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find power-of-two sizes best matching arguments</span></span><br><span class="line">	<span class="keyword">int</span> sshift = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> ssize = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (ssize &lt; concurrencyLevel) &#123;</span><br><span class="line">		++sshift;</span><br><span class="line">		ssize &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	segmentShift = <span class="number">32</span> - sshift;</span><br><span class="line">	segmentMask = ssize - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">this</span>.segments = Segment.newArray(ssize);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">		initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> c = initialCapacity / ssize;</span><br><span class="line">	<span class="keyword">if</span> (c * ssize &lt; initialCapacity)</span><br><span class="line">		++c;</span><br><span class="line">	<span class="keyword">int</span> cap = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (cap &lt; c)</span><br><span class="line">		cap &lt;&lt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.segments.length; ++i)</span><br><span class="line">		<span class="keyword">this</span>.segments[i] = <span class="keyword">new</span> Segment&lt;K,V&gt;(cap, loadFactor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥çœ‹ä»£ç ä»¥åŠæ–‡ç« æ³¨é‡Šå¯èƒ½éƒ½ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œè¯¥æ„é€ å‡½æ•°ä¼ è¿›æ¥ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿæˆ‘å°†æ„é€ å‡½æ•°ä¸­ä»£ç æå‡ºæ¥ï¼Œåšäº†ä¸€ä¸‹å®éªŒï¼Œèµ‹å€¼å’Œè®¡ç®—ç»“æœåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">concurrencyLevel:<span class="number">17</span></span><br><span class="line">initialCapacity:<span class="number">63</span></span><br><span class="line">sshift:<span class="number">5</span></span><br><span class="line">ssize:<span class="number">32</span></span><br><span class="line">segmentShift:<span class="number">27</span></span><br><span class="line">segmentMask:<span class="number">31</span></span><br><span class="line">cap:<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸‹å­å°±å¾ˆæ¸…æ¥šäº†ï¼Œå½“æˆ‘ä»¬è¦æ±‚concurrencyLevelæ˜¯17çš„æ—¶å€™ï¼Œssizeçš„è®¡ç®—ç»“æœæ˜¯32ï¼Œè€Œsssizeæœ€ç»ˆæ˜¯ç”¨äºåˆ›å»ºSegmentæ•°ç»„çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºä¼šæ‰©å±•ï¼ˆè¿™ä¸ªå¾ˆå¸¸è§ï¼Œæ‰©å±•æˆ2çš„å¹‚å€¼ï¼‰ï¼Œä¿è¯å®é™…çš„Segmentæ•°é‡å¤§äºç­‰äºå¼€å‘è€…è®¾å®šçš„å¹¶å‘Levelï¼ˆä¸€ä¸ªSegmentä½œä¸ºä¸€ä¸ªå¹¶å‘Levelçœ‹å¾…ï¼‰ã€‚</p>
<p>è€ŒinitialCapacityå€¼ä¸º63çš„æ—¶å€™ï¼Œcapçš„æœ€ç»ˆè®¡ç®—ç»“æœæ˜¯2ã€‚è¿™æ˜¯å› ä¸ºï¼Œå½“æˆ‘ä»¬åˆ†é…äº†ssizeæ•°é‡çš„Segmentä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†å¼€å‘è€…è®¾å®šçš„initialCapacityåˆ†é…åˆ°Segmentä¸­å»ï¼Œå¾ˆæ˜æ˜¾ï¼Œè‡³å°‘æ¯ä¸ªSegmentå­˜å‚¨2ä¸ªHashEntryæ‰èƒ½æ»¡è¶³63çš„çš„åˆå§‹å®¹é‡è®¾ç½®ï¼Œå› æ­¤è¿™ä¸ªå€¼ç­‰äº2ã€‚</p>
<p>åŸºäºä»¥ä¸Šè®¤è¯†ï¼Œé…åˆæ³¨é‡Šï¼Œå°±ä¸éš¾ç†è§£ä»£ç é€»è¾‘äº†ã€‚ä¸‹é¢è¿™å¹…å›¾å¾ˆé‡è¦:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/ConcurrentHashMapç»“æ„å›¾.jpg" alt="ConcurrentHashMapç»“æ„å›¾"></p>
<p>é€šè¿‡å°†å®¹å™¨åˆ‡åˆ†ä¸ºå¤šä¸ªSegmentï¼Œé™ä½é”çš„ç²’åº¦ï¼Œä»è€Œæé«˜å¹¶å‘æ€§â€”â€”ç°åœ¨Segmentä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œè¯»å†™å¯ä»¥å¹¶å‘ï¼Œå…·ä½“çš„é”æ“ä½œåªæœ‰åˆ°äº†å•ä¸ªSegmentå†…éƒ¨æ‰ä¼šå‘ç”Ÿã€‚</p>
<h2 id="è¡¥å……äºŒï¼šreadValueUnderLock"><a href="#è¡¥å……äºŒï¼šreadValueUnderLock" class="headerlink" title="è¡¥å……äºŒï¼šreadValueUnderLock"></a>è¡¥å……äºŒï¼šreadValueUnderLock</h2><p>è¿™ä¸ªæ–¹æ³•åœ¨ä¸¤ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¸€ä¸ªæ˜¯containsValueï¼Œä¸€ä¸ªæ˜¯getã€‚éƒ½æ˜¯åœ¨è·å–æŸä¸ªHashEntryçš„valueå‘ç°ä¸ºnullä¹‹åå†å»è°ƒç”¨ã€‚æ–‡ç« ä¸­æŠŠå®ƒçš„è§£é‡Šå’Œvolatileæ”¾åœ¨ä¸€èµ·ï¼Œå®¹æ˜“äº§ç”Ÿè¯¯è§£ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šæ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reads value field of an entry under lock. Called if value</span></span><br><span class="line"><span class="comment"> * field ever appears to be null. This is possible only if a</span></span><br><span class="line"><span class="comment"> * compiler happens to reorder a HashEntry initialization with</span></span><br><span class="line"><span class="comment"> * its table assignment, which is legal under memory model</span></span><br><span class="line"><span class="comment"> * but is not known to ever occur.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">V <span class="title">readValueUnderLock</span><span class="params">(HashEntry&lt;K,V&gt; e)</span> </span>&#123;</span><br><span class="line">	lock();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> e.value;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		unlock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æ³¨é‡Šï¼Œå‘ç”Ÿè¿™ç§æƒ…å†µå¾ˆæœ‰å¯èƒ½æ˜¯å› ä¸ºç¼–è¯‘å™¨é‡æ’åºäº†ä¸€ä¸ªHashEntryçš„åˆå§‹åŒ–å’Œèµ‹å€¼è¿‡ç¨‹ã€‚å³åŸæœ¬åº”è¯¥æ˜¯å…ˆåˆå§‹åŒ–å†å­˜å…¥tableï¼Œè€Œå®é™…ä¸Šå´å› ä¸ºé‡æ’åºï¼Œå¯¼è‡´HashEntryæ²¡æœ‰åˆå§‹åŒ–å®Œæˆå°±è¢«å­˜å…¥äº†table(å‘ç”Ÿåœ¨getæ–¹æ³•ä¸­)ã€‚</p>
<p>è€Œåœ¨ä»£ç ä¸­ï¼ŒreadValueUnderLockå’Œputæ–¹æ³•éƒ½æ˜¯ä½¿ç”¨lock()åŒ…å›´çš„ï¼Œå› æ­¤æ ¹æ®happens-beforeåŸåˆ™ä½¿ç”¨readValueUnderLockå¯ä»¥å¼ºåˆ¶å’Œputç¡®ç«‹å…ˆåå…³ç³»ï¼Œç­‰å¾…putå®Œæˆä¹‹åå†å»è·å–ç›¸åº”çš„valueã€‚</p>
<p>æ­£å¦‚æ–‡ç« åé¢æ‰€è¯´:</p>
<blockquote>
<p>åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œæ•£åˆ—è¡¨ä¸€èˆ¬çš„åº”ç”¨åœºæ™¯æ˜¯ï¼šé™¤äº†å°‘æ•°æ’å…¥æ“ä½œå’Œåˆ é™¤æ“ä½œå¤–ï¼Œç»å¤§å¤šæ•°éƒ½æ˜¯è¯»å–æ“ä½œï¼Œè€Œä¸”è¯»æ“ä½œåœ¨å¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯æˆåŠŸçš„ã€‚æ­£æ˜¯åŸºäºè¿™ä¸ªå‰æï¼ŒConcurrentHashMapé’ˆå¯¹è¯»æ“ä½œåšäº†å¤§é‡çš„ä¼˜åŒ–â€”â€”åªæœ‰è¯»åˆ°valueåŸŸçš„å€¼ä¸ºnullæ—¶ï¼Œè¯»çº¿ç¨‹æ‰éœ€è¦åŠ é”åé‡è¯»ï¼Œæå¤§çš„å‡å°‘äº†æŒé”æ—¶é—´ã€‚é€šè¿‡HashEntryå¯¹è±¡çš„ä¸å˜æ€§å’Œç”¨volatileå‹å˜é‡åè°ƒçº¿ç¨‹é—´çš„å†…å­˜å¯è§æ€§ï¼Œä½¿å¾— å¤§å¤šæ•°æ—¶å€™ï¼Œè¯»æ“ä½œä¸éœ€è¦åŠ é”å°±å¯ä»¥æ­£ç¡®è·å¾—å€¼ã€‚è¿™ä¸ªç‰¹æ€§ä½¿å¾—ConcurrentHashMap çš„å¹¶å‘æ€§èƒ½åœ¨åˆ†ç¦»é”çš„åŸºç¡€ä¸Šåˆæœ‰äº†è¿‘ä¸€æ­¥çš„æé«˜ã€‚</p>
</blockquote>
<h2 id="è¡¥å……ä¸‰ï¼šç»“æ„æ€§ä¿®æ”¹çš„æ“ä½œ"><a href="#è¡¥å……ä¸‰ï¼šç»“æ„æ€§ä¿®æ”¹çš„æ“ä½œ" class="headerlink" title="è¡¥å……ä¸‰ï¼šç»“æ„æ€§ä¿®æ”¹çš„æ“ä½œ"></a>è¡¥å……ä¸‰ï¼šç»“æ„æ€§ä¿®æ”¹çš„æ“ä½œ</h2><p>åœ¨æ–‡ç« ä¸­æåˆ°äº†å¯¹æ•£åˆ—è¡¨åšéç»“æ„æ€§ä¿®æ”¹çš„æ“ä½œå’Œå¯¹æ•£åˆ—è¡¨åšç»“æ„æ€§ä¿®æ”¹çš„æ“ä½œã€‚éç»“æ„æ€§ä¿®æ”¹çš„å¯è§æ€§ç”±volatileå­—æ®µå®Œæˆï¼Œè€Œç»“æ„æ€§ä¿®æ”¹çš„æ“ä½œï¼Œå®é™…ä¸Šä½œè€…è®¨è®ºçš„å¹¶æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå› ä¸ºputã€removeã€clearä¸‰ä¸ªæ“ä½œåœ¨å‘ç”Ÿå¯¹é“¾è¡¨çš„ä¿®æ”¹æ—¶ï¼Œéƒ½æ˜¯åœ¨lockçŠ¶æ€ä¸‹è¿›è¡Œçš„ã€‚</p>
<h2 id="è¡¥å……å››ï¼šä¸ºä»€ä¹ˆæ€§èƒ½å¥½ï¼Ÿ"><a href="#è¡¥å……å››ï¼šä¸ºä»€ä¹ˆæ€§èƒ½å¥½ï¼Ÿ" class="headerlink" title="è¡¥å……å››ï¼šä¸ºä»€ä¹ˆæ€§èƒ½å¥½ï¼Ÿ"></a>è¡¥å……å››ï¼šä¸ºä»€ä¹ˆæ€§èƒ½å¥½ï¼Ÿ</h2><p>é™ä½é”çš„ç²’åº¦å’Œé”æŒæœ‰æ—¶é—´ï¼Œå¹¶è€ƒè™‘åˆ°å®é™…çš„ä½¿ç”¨æƒ…å†µï¼Œå¯¹é›†åˆè¯»å–çš„æƒ…å†µè¿›è¡Œäº†ä¼˜åŒ–ï¼Œéå¸¸èµï¼</p>
<p>//TODO ç ”ç©¶JDK 1.8ã€‚JDK1.6ä¸­HashMapé‡‡ç”¨çš„æ˜¯ä½æ¡¶+é“¾è¡¨çš„æ–¹å¼ï¼Œå³æˆ‘ä»¬å¸¸è¯´çš„æ•£åˆ—é“¾è¡¨çš„æ–¹å¼ï¼Œè€ŒJDK1.8ä¸­é‡‡ç”¨çš„æ˜¯ä½æ¡¶+é“¾è¡¨/çº¢é»‘æ ‘çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚å½“æŸä¸ªä½æ¡¶çš„é“¾è¡¨çš„é•¿åº¦è¾¾åˆ°æŸä¸ªé˜€å€¼çš„æ—¶å€™ï¼Œè¿™ä¸ªé“¾è¡¨å°±å°†è½¬æ¢æˆçº¢é»‘æ ‘ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidå•å…ƒæµ‹è¯•(äºŒ)â€”â€”Mock & Stub]]></title>
      <url>http://www.timebridge.space/2015/11/18/Android-unit-test-mock-and-stub/</url>
      <content type="html"><![CDATA[<p>æœ¬æ–‡ç¿»è¯‘æ€»ç»“è‡ªMartin Fowlerï¼ˆä¸çŸ¥é“æ˜¯è°ï¼Ÿï¼ï¼ï¼‰çš„<a href="http://martinfowler.com/articles/mocksArentStubs.html" target="_blank" rel="noopener">ã€ŠMocks Arenâ€™t Stubsã€‹</a></p>
<p>Mockå¯¹è±¡æ˜¯åœ¨XPç¤¾åŒºå‡ºç°çš„ï¼Œåé¢è¶Šæ¥è¶Šå¤šçš„å‡ºç°åœ¨XPçš„å¼€å‘æµ‹è¯•æµç¨‹ä¸­ã€‚Mockå¯¹è±¡çš„æ¦‚å¿µä¸€ç›´å¾ˆæ¨¡ç³Šï¼Œå°¤å…¶ç»å¸¸ä¼šå’Œstubâ€”â€”ä¸€ä¸ªå¸¸è§çš„æµ‹è¯•ç¯å¢ƒè¾…åŠ©æ¦‚å¿µæ··æ·†èµ·æ¥ï¼ŒMartin Fowleråœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ä¹Ÿè®¤ä¸ºå®ƒä»¬ï¼ˆmockå’Œstubï¼‰æ˜¯å·®ä¸å¤šçš„ï¼Œä½†æ˜¯é€šè¿‡å’Œmockå¼€å‘è€…çš„äº¤æµä½¿å¾—Martin Fowleræ„è¯†åˆ°ä¸¤è€…æ˜¯æœ‰åŒºåˆ«çš„ã€‚<a id="more"></a></p>
<p>ä¸¤è€…çš„åŒºåˆ«å…¶å®åŒ…å«ä¸¤éƒ¨åˆ†:</p>
<ul>
<li>å¦‚ä½•éªŒè¯æµ‹è¯•ç»“æœï¼šçŠ¶æ€éªŒè¯(state verification) VS è¡Œä¸ºéªŒè¯(behavior verification)ï¼›</li>
<li>æµ‹è¯•å’Œè®¾è®¡å¦‚ä½•åä½œï¼šç»å…¸å½¢å¼(classical)å’ŒMockå½¢å¼(mockist)ï¼ˆMartin Fowlerçš„åˆ†ç±»ï¼‰ï¼›</li>
</ul>
<h2 id="æ™®é€šæµ‹è¯•"><a href="#æ™®é€šæµ‹è¯•" class="headerlink" title="æ™®é€šæµ‹è¯•"></a>æ™®é€šæµ‹è¯•</h2><p>Martin Fowleråœ¨æ–‡ç« ä¸­ä¸¾äº†ä¸ªğŸŒ°ï¼Œè¿™é‡ŒåŸå°ä¸åŠ¨çš„é˜è¿°ã€‚ğŸŒ°æ˜¯è¿™æ ·çš„ï¼šæˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªOrderå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šä»ä¸€ä¸ªWarehouseå¯¹è±¡ä¸­è·å–èµ„æºï¼ˆç®€å•è¯´å°±æ˜¯Warehouseå¯¹è±¡ä¼šæ ¹æ®Orderå¯¹è±¡åˆ†é…ç‰©èµ„ï¼‰ï¼ŒOrderå¯¹è±¡å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªProductå¯¹è±¡ä»¥åŠæ•°é‡ï¼ŒWarehouseå¯¹è±¡åˆ™åŒ…å«ç€ä¸åŒProductçš„å­˜è´§æ¸…å•ã€‚å½“æˆ‘ä»¬è¦æ±‚Warehouseå¯¹è±¡æ ¹æ®Orderå¯¹è±¡åˆ†é…ç‰©èµ„çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§æƒ…å†µ:</p>
<ol>
<li>ç‰©èµ„æ•°é‡å……è¶³ï¼Œå¯ä»¥æ­£ç¡®åˆ†é…ï¼Œè®¢å•å®Œæˆï¼Œç›¸åº”çš„æ•°é‡è¢«ä»Warehouseå¯¹è±¡çš„å­˜è´§æ¸…å•ä¸­å‡å»ï¼›</li>
<li>ç‰©èµ„æ•°é‡ä¸è¶³ï¼Œè®¢å•ä¸èƒ½å®Œæˆï¼ŒWarehouseçš„å­˜è´§æ¸…å•ä¸å˜åŠ¨ï¼›</li>
</ol>
<p>è¿™ä¸¤ç§è¡Œä¸ºå¯ä»¥è¿›è¡Œä¸€äº›æµ‹è¯•ï¼Œä¸‹é¢æ˜¯ä¸€ç§ä¼ ç»Ÿçš„JUnitæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderStateTester</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String TALISKER = <span class="string">"Talisker"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String HIGHLAND_PARK = <span class="string">"Highland Park"</span>;</span><br><span class="line">	<span class="keyword">private</span> Warehouse warehouse = <span class="keyword">new</span> WarehouseImpl();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		warehouse.add(TALISKER, <span class="number">50</span>);</span><br><span class="line">		warehouse.add(HIGHLAND_PARK, <span class="number">25</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrderIsFilledIfEnoughInWarehouse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">50</span>);</span><br><span class="line">		order.fill(warehouse);</span><br><span class="line">		assertTrue(order.isFilled());</span><br><span class="line">		assertEquals(<span class="number">0</span>, warehouse.getInventory(TALISKER));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrderDoesNotRemoveIfNotEnough</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);</span><br><span class="line">		order.fill(warehouse);</span><br><span class="line">		assertFalse(order.isFilled());</span><br><span class="line">		assertEquals(<span class="number">50</span>, warehouse.getInventory(TALISKER));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæµ‹è¯•æŒ‰ç…§ç»å…¸çš„å››æ­¥è¿›è¡Œï¼š</p>
<ol>
<li><strong>setup</strong>  å³setUpæ–¹æ³•ä¸­æ‰§è¡Œçš„ä»£ç ï¼Œè¿˜æœ‰éƒ¨åˆ†åœ¨testæ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯Orderå’ŒWarehouseå¯¹è±¡çš„å»ºç«‹ï¼›</li>
<li><strong>exercise</strong> order.fillæ˜¯å±äºè¿™ä¸ªé˜¶æ®µçš„ï¼Œå¯¹è±¡å¼€å§‹æ‰§è¡Œä¸€äº›æˆ‘ä»¬éœ€è¦æµ‹è¯•çš„è¡Œä¸ºï¼›</li>
<li><strong>verify</strong> assertä»£ç å±äºéªŒè¯é˜¶æ®µï¼Œæ¥æ£€æµ‹exerciseçš„æ‰§è¡Œç»“æœæ˜¯å¦æ­£ç¡®ï¼›</li>
<li><strong>teardown</strong> è¿™ä¸ªæµ‹è¯•ä¸­æ²¡æœ‰æ˜¾ç¤ºçš„teardowné˜¶æ®µï¼Œåƒåœ¾å›æ”¶å™¨æ‚„æ‚„åœ°æŠŠè¿™äº‹å„¿ç»™å¹²äº†ï¼›</li>
</ol>
<blockquote>
<p>ã€ä¸€å¥è¯ã€‘æµ‹è¯•çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆåˆ›å»ºå¯¹è±¡ï¼Œå‡†å¤‡æ•°æ®(setup)ï¼Œè®©æˆ‘ä»¬æµ‹è¯•çš„å¯¹è±¡åœ¨è¿™ç§ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è¿è¡Œ(exercise)ï¼ŒéªŒè¯ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ(verify)ï¼Œæœ€ç»ˆæ¸…ç†æµ‹è¯•ç¯å¢ƒ(teardown)ã€‚</p>
</blockquote>
<p>åœ¨setupé˜¶æ®µï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡â€”â€”Orderå’ŒWarehouseâ€”â€”Orderæ˜¯æˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ç±»ï¼Œä½†æ˜¯åœ¨è°ƒç”¨fillæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªWarehouseå¯¹è±¡ï¼Œå› æ­¤å¿…é¡»åˆ›å»ºä¸€ä¸ªå®ƒçš„å¯¹è±¡ã€‚Testing-orientedçš„äººå–œæ¬¢ä½¿ç”¨object-under-testæˆ–è€…system-under-testæ¥ç§°å‘¼ä»–ä»¬é›†ä¸­ç²¾åŠ›æµ‹è¯•çš„ç±»ï¼Œåœ¨è¿™é‡Œï¼Œå°±æ˜¯æˆ‘ä»¬çš„Orderç±»ï¼Œä¸¤ä¸ªç§°å‘¼åœ¨Martin Fowlerçœ‹æ¥éƒ½å¾ˆä¸‘é™‹ï¼Œä¸è¿‡Martin Fowlerä»ç„¶æ‰“ç®—åœ¨æ¥ä¸‹æ¥çš„æè¿°ä¸­ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªç§°å‘¼ï¼Œå› ä¸ºå¤§å®¶éƒ½è¿™ä¹ˆç”¨â€”â€”System Under Testï¼Œç¼©å†™ <strong>SUT</strong> ã€‚</p>
<p>æ‰€ä»¥åœ¨è¿™ä¸ªæµ‹è¯•ä¸­æˆ‘ä»¬éœ€è¦ä¸€ä¸ªSUT(Order)å’Œä¸€ä¸ªCollaborator(å¯ç†è§£ä¸ºè¾…åŠ©è€…ã€åä½œè€…ï¼Œè¿™é‡Œä¿æŒåŸæ±åŸå‘³å„¿)(Warehouse)ã€‚éœ€è¦Warehouseæœ‰ä¸¤ä¸ªåŸå› ï¼šä¸€ä¸ªæ˜¯ä¸ºäº†ä½¿å¾—æµ‹è¯•èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ(Order.fillæ–¹æ³•éœ€è¦è°ƒç”¨åˆ°Warehouseçš„æ–¹æ³•)ï¼Œç¬¬äºŒä¸ªæ˜¯ä¸ºäº†éªŒè¯(Order.fillä¼šæ”¹å˜Warehouseçš„å†…éƒ¨çŠ¶æ€ï¼Œå› æ­¤éœ€è¦é€šè¿‡éªŒè¯Warehouseçš„çŠ¶æ€æ¥ç¡®è®¤Orderæ‰§è¡Œçš„æ­£ç¡®æ€§)ã€‚åœ¨æ¥ä¸‹æ¥çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°SUTå’ŒCollaboratorä¹‹é—´æ˜¯æœ‰å¾ˆå¤šä¸åŒçš„(åœ¨è¿™ç¯‡æ–‡ç« çš„ä¹‹å‰ç‰ˆæœ¬ä¸­ï¼ŒMartin Fowleråˆ†åˆ«å°†ä¸¤è€…æˆä¸ºprimary objectå’Œsecondary objectï¼Œå³ä¸»å¯¹è±¡å’Œæ¬¡å¯¹è±¡)ã€‚</p>
<p>ä¸Šé¢çš„æµ‹è¯•ä¸­ä½¿ç”¨çš„æ˜¯çŠ¶æ€éªŒè¯æ–¹å¼ï¼Œå³ï¼šæˆ‘ä»¬é€šè¿‡éªŒè¯SUTå’ŒCollaboratoråœ¨exercisedä¹‹åçš„çŠ¶æ€æ¥ç¡®è®¤æµ‹è¯•çš„ç»“æœï¼Œåé¢æˆ‘ä»¬å°†çœ‹åˆ°ï¼Œmockå¯¹è±¡ç»™å‡ºäº†ä¸€ç§ä¸åŒçš„éªŒè¯æ–¹å¼ã€‚</p>
<h2 id="Mockå¯¹è±¡æµ‹è¯•"><a href="#Mockå¯¹è±¡æµ‹è¯•" class="headerlink" title="Mockå¯¹è±¡æµ‹è¯•"></a>Mockå¯¹è±¡æµ‹è¯•</h2><p>ç°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨mockå¯¹è±¡è¿›è¡Œç›¸åŒçš„æµ‹è¯•ï¼Œåœ¨ä¸‹é¢çš„ä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨jMockæ¡†æ¶æ¥å®Œæˆmockã€‚jMockæ˜¯ä¸€ä¸ªJavaä¸Šçš„mockåº“ï¼Œä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–ç±»ä¼¼çš„åº“(EasyMockã€Mockitoã€powermock)ï¼Œä½†æ˜¯è¿™ä¸ªåº“æ˜¯è¿™é¡¹æŠ€æœ¯çš„åˆ›å§‹äººæ‰€å†™çš„æœ€æ–°åº“(çœ‹å®ƒçš„å®˜ç½‘ï¼Œç›®å‰è‡³å°‘æœ‰5ä½ä¸»è¦è´¡çŒ®è€…ï¼Œæ’åœ¨æœ€å‰é¢çš„æ˜¯Steve Freeman)ï¼Œæ‰€ä»¥é€‰æ‹©å®ƒæ˜¯åˆé€‚çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderInteractionTester</span> <span class="keyword">extends</span> <span class="title">MockObjectTestCase</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String TALISKER = <span class="string">"Talisker"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFillingRemovesInventoryIfInStock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//setup - data</span></span><br><span class="line">		Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">50</span>);</span><br><span class="line">		Mock warehouseMock = <span class="keyword">new</span> Mock(Warehouse.class);</span><br><span class="line">		<span class="comment">//setup - expectations</span></span><br><span class="line">		warehouseMock.expects(once()).method(<span class="string">"hasInventory"</span>)</span><br><span class="line">				.with(eq(TALISKER),eq(<span class="number">50</span>))</span><br><span class="line">				.will(returnValue(<span class="keyword">true</span>));</span><br><span class="line">		warehouseMock.expects(once()).method(<span class="string">"remove"</span>)</span><br><span class="line">				.with(eq(TALISKER), eq(<span class="number">50</span>))</span><br><span class="line">				.after(<span class="string">"hasInventory"</span>);</span><br><span class="line">		<span class="comment">//exercise</span></span><br><span class="line">		order.fill((Warehouse) warehouseMock.proxy());</span><br><span class="line">		<span class="comment">//verify</span></span><br><span class="line">		warehouseMock.verify();</span><br><span class="line">		assertTrue(order.isFilled());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFillingDoesNotRemoveIfNotEnoughInStock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);    </span><br><span class="line">		Mock warehouse = mock(Warehouse.class);</span><br><span class="line">		warehouse.expects(once()).method(<span class="string">"hasInventory"</span>)</span><br><span class="line">				.withAnyArguments()</span><br><span class="line">				.will(returnValue(<span class="keyword">false</span>));</span><br><span class="line">		order.fill((Warehouse) warehouse.proxy());</span><br><span class="line">		assertFalse(order.isFilled());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹testFillingRemovesInventoryIfInStockï¼šsetupé˜¶æ®µå·²ç»æœ‰æ˜æ˜¾çš„ä¸åŒï¼Œå®ƒåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šdataå’Œexpecttionsï¼ˆè§æ³¨é‡Šï¼‰ï¼Œå³è®¾ç½®æ•°æ®å’ŒæœŸå¾…è¡Œä¸ºã€‚dataéƒ¨åˆ†ç”¨äºå»ºç«‹æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„å¯¹è±¡ï¼Œè¿™é‡Œå’Œä¼ ç»Ÿçš„srtupåŒºåˆ«å¹¶ä¸å¤§ï¼ŒåŒºåˆ«åœ¨äºæˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡ï¼ŒSUTæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯Collaboratorå®Œå…¨ä¸ä¸€æ ·â€”â€”å®ƒæ˜¯ä¸€ä¸ªMockå¯¹è±¡ï¼Œä¸€ä¸ªMockçš„Warehouseï¼ï¼å¤©å‘ï¼ï¼æŠ€æœ¯ä¸Šæ¥è¯´å®ƒæ˜¯ä¸€ä¸ªMockç±»çš„å®ä¾‹ã€‚</p>
<p>setupçš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯expecttionséƒ¨åˆ†ï¼Œæ˜¯ç”¨äºåœ¨Mockå¯¹è±¡ä¸Šåˆ›å»ºæœŸå¾…è¡Œä¸ºçš„ï¼Œè¿™ä¸ªéƒ¨åˆ†åœ¨æè¿°äº†SUTåœ¨exercisedé˜¶æ®µï¼Œå“ªäº›æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä»¥åŠè¿”å›ç»“æœæ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚å®é™…çš„æœŸå¾…æè¿°å¯ä»¥æ¯”è¿™ä¸ªæ›´å¤æ‚ï¼Œå‰é¢è¯´çš„æ¯”è¾ƒæŠ½è±¡ï¼Œè¯´ç™½ä¸€ç‚¹ï¼šè¿™é‡Œå¯ä»¥å®šåˆ¶ä¸€äº›è¡Œä¸ºï¼Œè®¾ç½®ä¸€äº›é™åˆ¶ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨æ¬¡æ•°ï¼Œåºåˆ—ï¼Œè¿”å›å€¼ç­‰ï¼Œé€šè¿‡è¿™äº›è®¾ç½®ï¼Œå¯ä»¥æè¿°æµ‹è¯•è€…å¯¹æµ‹è¯•æµç¨‹çš„æœŸå¾…ï¼Œåˆ›å»ºä¸€ä¸ªç¨³å®šçš„ç¯å¢ƒï¼Œä¹Ÿä¾¿äºåæœŸè®¤è¯ã€‚</p>
<p>ä¸€æ—¦expectationså»ºç«‹å¥½ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›å…¥exerciseé˜¶æ®µ(è¿™ä¸ªé˜¶æ®µå¹²å•¥çš„ï¼Ÿçœ‹å‰é¢)ã€‚ä¹‹åæˆ‘ä»¬è¿›å…¥verifyé˜¶æ®µï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼šå’Œä¼ ç»Ÿæµ‹è¯•ä¸€æ ·éªŒè¯SUTï¼Œä½†åŒæ—¶åˆå»éªŒè¯Mockå¯¹è±¡â€”â€”éªŒè¯æˆ‘ä»¬çš„è°ƒç”¨ç¬¦åˆæˆ‘ä»¬çš„expections(å³setupé˜¶æ®µçš„ç¬¬äºŒéƒ¨åˆ†çš„é¢„è®¾)ã€‚</p>
<p>è¿™é‡Œä¸æ™®é€šæµ‹è¯•çš„æœ€å¤§ä¸åŒå°±åœ¨äºæˆ‘ä»¬å¦‚ä½•éªŒè¯SUTå’ŒCollaboratorçš„äº¤äº’ã€‚é€šè¿‡çŠ¶æ€éªŒè¯ï¼Œæˆ‘ä»¬ä½¿ç”¨assertæ¥ç¡®è®¤Warehouseçš„çŠ¶æ€ç¬¦åˆé¢„æœŸï¼Œä½†æ˜¯Mockå¯¹è±¡åˆ™æ˜¯ä½¿ç”¨è¡Œä¸ºéªŒè¯â€”â€”éªŒè¯Orderæ˜¯å¦æ­£ç¡®è°ƒç”¨äº†Warehouseï¼ŒéªŒè¯çš„æ˜¯è°ƒç”¨è¿™ä¸ªè¡Œä¸ºï¼æˆ‘ä»¬é€šè¿‡åœ¨setupé˜¶æ®µå‘Šè¯‰Mockå¯¹è±¡æˆ‘ä»¬æœŸæœ›çš„è°ƒç”¨è¡Œä¸ºæ¥åœ¨æœ€åè®©Mockå¯¹è±¡è¿›è¡ŒéªŒè¯ï¼Œåªæœ‰Orderå¯¹è±¡æ˜¯è¿›è¡ŒassertéªŒè¯ï¼Œå³çŠ¶æ€éªŒè¯çš„ï¼Œå¦‚æœæ•´ä¸ªexerciseé˜¶æ®µæ²¡æœ‰æ”¹å˜Orderå¯¹è±¡çš„çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™é‡Œæ²¡æœ‰ä»»ä½•çš„assertsã€‚</p>
<p>åœ¨ç¬¬äºŒä¸ªæµ‹è¯•(testFillingDoesNotRemoveIfNotEnoughInStock)ä¸­ï¼Œæˆ‘ä»¬åšäº†ä¸€äº›ä¸åŒçš„äº‹æƒ…ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨mockè€Œä¸æ˜¯newæ–¹æ³•æ¥åˆ›å»ºMockå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿«æ·æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥ä¸ç”¨æ˜¾ç¤ºçš„è°ƒç”¨verifyæ–¹æ³•ï¼Œä»»ä½•é€šè¿‡è¿™ç§æ–¹å¼åˆ›å»ºçš„å¯¹è±¡åœ¨æ–¹æ³•æ‰§è¡Œåéƒ½ä¼šè¢«è‡ªåŠ¨éªŒè¯ã€‚</p>
<p>ç¬¬äºŒä¸ªä¸åŒç‚¹åœ¨äºæˆ‘ä»¬é€šè¿‡ä½¿ç”¨withAnyArgumentsæ–¹æ³•æ”¾å®½äº†expectationsçš„é™åˆ¶ã€‚è¿™æ ·åœ¨Orderçš„é€»è¾‘è¢«æ”¹å˜ä¹‹åï¼Œè¿™ä¸ªtestå°±ä¸ä¼šå¤±è´¥ï¼Œä»è€Œå‡è½»äº†ç»´æŠ¤testçš„æˆæœ¬ã€‚å®é™…ä¸Šè¿™é‡Œå¯ä»¥çœç•¥è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œå› ä¸ºæ˜¯é»˜è®¤çš„ã€‚</p>
<blockquote>
<p>ã€PSã€‘Martin Fowleråœ¨æ–‡ç« ä¸­è¿˜ä¸¾äº†ä¸€ä¸ªEasyMockçš„ä¾‹å­ï¼Œä½†æ˜¯é‰´äºä¾‹å­æœ¬èº«å’Œæˆ‘ä»¬ç†è§£æœ¬æ–‡æ ¸å¿ƒé˜è¿°çš„æ¦‚å¿µä¸å¤ªç›¸å…³ï¼Œè€Œæˆ‘è¿™ä¹ˆæ™šäº†ä¹Ÿæ‡’å¾—ç¿»è¯‘ï¼Œå› æ­¤çœç•¥ã€‚</p>
</blockquote>
<h2 id="Mockå’ŒStubä¹‹é—´çš„åŒºåˆ«"><a href="#Mockå’ŒStubä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="Mockå’ŒStubä¹‹é—´çš„åŒºåˆ«"></a>Mockå’ŒStubä¹‹é—´çš„åŒºåˆ«</h2><p>å½“è¿™ä¸¤ä¸ªæ¦‚å¿µåˆšåˆšå‡ºç°çš„æ—¶å€™ï¼Œå¾ˆå¤šäººéƒ½ä¼šå¯¹å®ƒä»¬æ„Ÿåˆ°è¿·æƒ‘ï¼Œåæ¥æ‰é€æ¸äº†è§£åˆ°ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ã€‚æƒ³è¦å½»åº•ç†è§£ä»€ä¹ˆæ˜¯mockï¼Œç†è§£mockå’Œå…¶ä»–test double(ä¸€ä¸ªæœ¯è¯­ï¼Œåé¢è§£é‡Š)çš„åŒºåˆ«æ˜¯å¾ˆé‡è¦çš„ã€‚</p>
<p>å½“æˆ‘ä»¬åšä¸Šé¢é‚£æ ·çš„ä¸€ä¸ªæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¯æ¬¡åªèƒ½é›†ä¸­å…³æ³¨å…¶ä¸­ä¸€ä¸ªå…ƒç´ ç»„ä»¶(unit)ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å•å…ƒæµ‹è¯•ã€‚è€Œé—®é¢˜åœ¨äºåœ¨æˆ‘ä»¬æµ‹è¯•è¿™å•ä¸€ç»„ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å…¶ä»–çš„ç»„ä»¶è¿›è¡Œè¾…åŠ©ï¼Œå°±åƒæµ‹è¯•Orderç±»éœ€è¦Warehouseç±»ä¸€æ ·ã€‚</p>
<p>åœ¨ä¸Šé¢æåˆ°çš„ä¸¤ç§æµ‹è¯•é£æ ¼ä¸­ï¼Œç¬¬ä¸€ç§é£æ ¼ä½¿ç”¨äº†ä¸€ä¸ªçœŸçš„Warehouseå¯¹è±¡ï¼Œç¬¬äºŒç§é£æ ¼åˆ™ä½¿ç”¨äº†ä¸€ä¸ªmockçš„Warehouseå¯¹è±¡ã€‚é€šè¿‡Mockå¯¹è±¡æ˜¯æ¥è¿›è¡Œæµ‹è¯•æ˜¯ä¸ä½¿ç”¨çœŸå®å¯¹è±¡è¿›è¡Œæµ‹è¯•çš„ä¸€ç§æ–¹æ³•ï¼Œå®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šåˆ«çš„æ–¹å¼å¯ä»¥æ›¿ä»£çœŸå®å¯¹è±¡ã€‚</p>
<p>ç”¨äºæè¿°è¿™ç§æƒ…å†µçš„è¯æ±‡å¾ˆå¿«å˜å¾—æ··ä¹±èµ·æ¥â€”â€”å„ç§è¯æ±‡éƒ½è¢«ç”¨åˆ°äº†ï¼šstubã€mockã€fakeã€dummyã€‚åœ¨è¿™é‡Œï¼ŒMartin Fowlerä½¿ç”¨äº†Gerard Meszarosä¹¦ä¸­çš„è¯æ±‡å®šä¹‰ã€‚</p>
<p>Meszarosä½¿ç”¨ <strong>Test Double</strong> æ¥è¡¨ç¤ºæ‰€æœ‰çš„æ›¿ä»£çœŸå®å¯¹è±¡è¿›è¡Œæµ‹è¯•çš„å¯¹è±¡ï¼Œè¿™ä¸ªåè¯æ¥è‡ªç”µå½±ä¸­çš„Stunt Double(ä»–çš„ç›®çš„å°±æ˜¯å–ä¸€ä¸ªæ²¡æœ‰è¢«å¹¿æ³›ä½¿ç”¨çš„åå­—)ã€‚Meszaroséšååˆå®šä¹‰äº†å››ç±»Double:</p>
<ol>
<li><strong>Dummyå¯¹è±¡</strong> æ˜¯é‚£äº›è¢«åˆ°å¤„ä¼ é€’ï¼Œä½†æ˜¯ä»ä¸è¢«ä½¿ç”¨çš„å¯¹è±¡ã€‚é€šå¸¸æ¥è¯´åªæ˜¯ç”¨æ¥å¡«å……å‚æ•°åˆ—è¡¨ï¼›</li>
<li><strong>Fakeå¯¹è±¡</strong> æœ‰å®é™…å®ç°ï¼Œä½†æ˜¯ç»å¸¸ä¼šé‡‡ç”¨ä¸€äº›ç®€å•çš„æ–¹å¼ï¼Œä»è€Œä½¿å¾—å®ƒä»¬ä¸èƒ½åœ¨æœ€ç»ˆçš„äº§å“ä¸­ä½¿ç”¨ï¼›</li>
<li><strong>Stubå¯¹è±¡</strong> å°è£…äº†ä¸€äº›æµ‹è¯•ä¸­éœ€è¦ç”¨åˆ°çš„è°ƒç”¨å“åº”æ•°æ®ã€‚Stubä¹Ÿæœ‰å¯èƒ½ä¼šè®°å½•ä¸€äº›è°ƒç”¨ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸€ä¸ªemail gate stubå°±ä¼šè®°å½•å®ƒå‘é€çš„ä¿¡æ¯ä»¥åŠå‘é€ä¿¡æ¯çš„æ¬¡æ•°ï¼›</li>
<li><strong>Mockå¯¹è±¡</strong> æ˜¯æå‰ç¼–å†™æœ‰è¯¦ç»†çš„å…³äºæ”¶åˆ°è°ƒç”¨æ–¹æ³•çš„expectationsçš„å¯¹è±¡ï¼Œå¥½æ‹—å£ï¼Œè¿˜æ˜¯æ¥å¥äººè¯ï¼šè¿™ä¸ªå¯¹è±¡ç”¨äºæè¿°è‡ªå·±æœŸæœ›å¾—åˆ°ä»€ä¹ˆæ ·å­çš„æ–¹æ³•è°ƒç”¨ï¼Œè¿˜ä¸äº†è§£çš„è¯ï¼Œçœ‹çœ‹å‰é¢JMockç¤ºä¾‹ä¸­çš„Warehouse Mockå¯¹è±¡ï¼Œå®ƒå°±æœ‰expectationsæè¿°ã€‚</li>
</ol>
<p>åœ¨è¿™å‡ ç±»å¯¹è±¡ä¸­ï¼Œåªæœ‰mockå¯¹è±¡éœ€è¦è¡Œä¸ºéªŒè¯ï¼Œå…¶ä½™çš„å‡ ç±»åªèƒ½åšçŠ¶æ€éªŒè¯ã€‚Mockå¯¹è±¡é€šå¸¸åœ¨exerciseé˜¶æ®µä¹Ÿä¼šæ‰®æ¼”ä¸€äº›åˆ«çš„å¯¹è±¡çš„è§’è‰²ï¼Œå› ä¸ºå®ƒéœ€è¦æ˜¯çš„SUTç›¸ä¿¡å®ƒè‡ªå·±æ­£åœ¨å’Œä¸€ä¸ªçœŸæ­£çš„Collaboratoræ‰“äº¤é“â€”â€”ä½†æ˜¯Mockå¯¹è±¡åœ¨setupé˜¶æ®µå’Œverifyé˜¶æ®µå’Œå…¶ä½™å¯¹è±¡æ˜¯ç»å¯¹ä¸åŒçš„ã€‚</p>
<p>ä¸ºäº†æ›´å¥½çš„ç†è§£test doubleï¼Œæˆ‘ä»¬éœ€è¦å»¶ä¼¸ä¸€ä¸‹æˆ‘ä»¬çš„ä¾‹å­ã€‚å¾ˆå¤šäººåªæœ‰åœ¨çœŸå®çš„å¯¹è±¡ç”¨èµ·æ¥ä¸æ–¹ä¾¿çš„æ—¶å€™æ‰ä¼šé€‰æ‹©ä½¿ç”¨test doubleï¼Œä¸€ä¸ªæ›´åŠ ç»å…¸çš„éœ€æ±‚æ˜¯ï¼šæˆ‘ä»¬å¸Œæœ›åœ¨Orderä¸èƒ½å®Œæˆçš„æ—¶å€™å‘ä¸€å°é‚®ä»¶ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨æµ‹è¯•é˜¶æ®µå¹¶ä¸å¸Œæœ›çœŸæ­£çš„å‘é€ä¸€å°é‚®ä»¶å‡ºå»ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¸Œæœ›ä¸ºé‚®ä»¶ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªtest doubleâ€”â€”ä¸€ä¸ªæˆ‘ä»¬å¯ä»¥æ“æ§çš„é‚®ä»¶ç³»ç»Ÿã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°mockå’Œstubçš„åŒºåˆ«ï¼Œå¦‚æœæˆ‘ä»¬ä¸ºé‚®ä»¶è¡Œä¸ºåˆ›å»ºä¸€ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¿™ä¸ªç®€å•çš„stubæ¥å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MailService</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span> <span class="params">(Message msg)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailServiceStub</span> <span class="keyword">implements</span> <span class="title">MailService</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Message&gt; messages = <span class="keyword">new</span> ArrayList&lt;Message&gt;();</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span> <span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">		messages.add(msg);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numberSent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> messages.size();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨Stubä¸Šå¦‚ä¸‹ä½¿ç”¨çŠ¶æ€éªŒè¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderStateTester</span>...</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">void</span> <span class="title">testOrderSendsMailIfUnfilled</span>() </span>&#123;</span><br><span class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);</span><br><span class="line">    MailServiceStub mailer = <span class="keyword">new</span> MailServiceStub();</span><br><span class="line">    order.setMailer(mailer);</span><br><span class="line">    order.fill(warehouse);</span><br><span class="line">    assertEquals(<span class="number">1</span>, mailer.numberSent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶å•¦ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­â€”â€”åªæµ‹è¯•äº†ä¸€ä¸ªæ¶ˆæ¯è¢«å‘é€äº†ï¼Œè€Œæ²¡æœ‰æµ‹è¯•é‚®ä»¶è¢«å‘é€åˆ°äº†æ­£ç¡®çš„äººï¼Œå†…å®¹æ­£ç¡®ä¸å¦ï¼Œä½†æ˜¯è¿™å¹¶ä¸å¦¨ç¢æˆ‘ä»¬è®²è¿°æ¸…æ¥šæˆ‘ä»¬çš„å…³æ³¨ç‚¹ã€‚</p>
<p>ä½¿ç”¨Mockçš„è¯ï¼Œæµ‹è¯•çœ‹ä¸Šå»ä¼šå¾ˆä¸ä¸€æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderInteractionTester</span>...</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">void</span> <span class="title">testOrderSendsMailIfUnfilled</span>() </span>&#123;</span><br><span class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);</span><br><span class="line">    Mock warehouse = mock(Warehouse.class);</span><br><span class="line">    Mock mailer = mock(MailService.class);</span><br><span class="line">    order.setMailer((MailService) mailer.proxy());</span><br><span class="line"></span><br><span class="line">    mailer.expects(once()).method(<span class="string">"send"</span>);</span><br><span class="line">    warehouse.expects(once()).method(<span class="string">"hasInventory"</span>)</span><br><span class="line">      .withAnyArguments()</span><br><span class="line">      .will(returnValue(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">    order.fill((Warehouse) warehouse.proxy());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨äº†ä¸€ä¸ªtest doubleæ¥ä»£æ›¿çœŸæ­£çš„mailæœåŠ¡â€”â€”å‰è€…ä½¿ç”¨çš„æ˜¯Stubï¼Œåè€…ä½¿ç”¨çš„æ˜¯Mockï¼Œè¿™é‡Œå¯ä»¥çœ‹å‡ºåŒºåˆ«â€”â€”å‰è€…è¿›è¡Œçš„æ˜¯çŠ¶æ€éªŒè¯ï¼Œåè€…è¿›è¡Œçš„æ˜¯è¡Œä¸ºéªŒè¯ï¼</p>
<p>Mockå¯¹è±¡æ€»æ˜¯ä½¿ç”¨è¡Œä¸ºéªŒè¯ï¼ŒStbä¹Ÿå¯ä»¥ï¼ŒMeszaroså°†ä½¿ç”¨è¡Œä¸ºéªŒè¯çš„Stubç§°ä¸ºTest Spyï¼ŒåŒºåˆ«å°±åœ¨äºtest doubleå¦‚ä½•è¿è¡Œå’ŒéªŒè¯ã€‚</p>
<h2 id="Classicalå’ŒMockistæµ‹è¯•"><a href="#Classicalå’ŒMockistæµ‹è¯•" class="headerlink" title="Classicalå’ŒMockistæµ‹è¯•"></a>Classicalå’ŒMockistæµ‹è¯•</h2><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç¬¬äºŒä¸ªä¸åŒç‚¹ï¼šclassicalå’ŒMockistä¸¤ç§é£æ ¼ï¼ŒåŒºåˆ«ç‚¹åœ¨äº <strong>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨Mockæˆ–è€…åˆ«çš„double</strong> ã€‚</p>
<p>classicalæµ‹è¯•é©±åŠ¨å¼€å‘è€…ä¸»å¼ å°½å¯èƒ½çš„ä½¿ç”¨çœŸå®çš„å¯¹è±¡ï¼Œåªæœ‰åœ¨ä½¿ç”¨çœŸæ˜¯å¯¹è±¡é‡åˆ°é—®é¢˜çš„æ—¶å€™æ‰ä¼šä½¿ç”¨doubleã€‚æ‰€ä»¥classicalæµ‹è¯•é©±åŠ¨å¼€å‘è€…ä¼šä½¿ç”¨ä¸€ä¸ªçœŸå®çš„Warehouseå¯¹è±¡å’Œä¸€ä¸ªdoubleçš„MailæœåŠ¡å¯¹è±¡ã€‚</p>
<p>Mockistæµ‹è¯•é©±åŠ¨å¼€å‘è€…åˆ™ç›¸åï¼Œä»–ä»¬æ€»æ˜¯ä¼šä½¿ç”¨mockå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬ä¼šä½¿ç”¨ä¸€ä¸ªMockçš„Warehouseã€‚Mockistçš„ä¸€ä¸ªé‡è¦åˆ†æ”¯æ˜¯BDD(Behavior Driven Development)ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</p>
<h2 id="é€‰æ‹©"><a href="#é€‰æ‹©" class="headerlink" title="é€‰æ‹©"></a>é€‰æ‹©</h2><p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œé˜è¿°äº†ä¸¤ç§åŒºåˆ«ï¼šçŠ¶æ€éªŒè¯å’Œè¡Œä¸ºéªŒè¯ï¼ŒClassicalå’ŒMockistã€‚é‚£ä¹ˆåˆ°åº•åº”è¯¥æ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬æ¥è¯´ä¸€ä¸‹çŠ¶æ€éªŒè¯å’Œè¡Œä¸ºéªŒè¯çš„é€‰æ‹©ã€‚</p>
<p>é¦–å…ˆè¦è€ƒè™‘çš„æ˜¯ä¸Šä¸‹æ–‡ç¯å¢ƒï¼šæˆ‘ä»¬é¢å¯¹çš„æ˜¯ä¸€ä¸ªå¾ˆå¥½åˆ›å»ºçš„åä½œå…³ç³»ï¼Œæ¯”å¦‚Orderå’ŒWarehouseï¼Œè¿˜æ˜¯ä¸€ä¸ªå¤æ‚éš¾ç”¨çš„ï¼Œæ¯”å¦‚Orderå’ŒMailæœåŠ¡ï¼Ÿ</p>
<p>å¦‚æœæ˜¯ä¸€ä¸ªç®€å•çš„ï¼Œé‚£ä¹ˆé€‰æ‹©ä¹Ÿæ˜¯ç®€å•çš„ï¼ŒClassicalæµ‹è¯•è€…ä¸ä¼šä½¿ç”¨mockã€stubæˆ–è€…å…¶ä»–ä»»ä½•çš„doubleï¼Œæˆ‘ç›´æ¥ä½¿ç”¨ä¸€ä¸ªçœŸå®çš„Objectå¹¶è¿›è¡ŒçŠ¶æ€éªŒè¯ï¼›è€ŒMockistä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨mockå¯¹è±¡å¹¶è¿›è¡Œè¡Œä¸ºéªŒè¯ã€‚è¿™ä¸ªå¯ä»¥å‚è€ƒå‰é¢çš„ä¾‹å­ï¼Œå› ä¸ºæˆæœ¬å¾ˆå°ï¼Œé€‰æ‹©ä»€ä¹ˆéƒ½å¯ä»¥ï¼Œå› æ­¤æ²¡æœ‰å¤ªå¤šéœ€è¦è€ƒè™‘çš„ã€‚</p>
<p>å¦‚æœæ˜¯ä¸€ä¸ªå¤æ‚çš„åä½œå…³ç³»ï¼Œnameå¯¹äºMockistæ¥è¯´ä¹Ÿæ²¡ä»€ä¹ˆéœ€è¦è€ƒè™‘çš„â€”â€”ä½¿ç”¨mockå’Œè¡Œä¸ºéªŒè¯ã€‚ä½†å¯¹äºClassicalæ¥è¯´ï¼Œå°±éœ€è¦åšå‡ºä¸€äº›é€‰æ‹©äº†ï¼Œä½†é—®é¢˜ä¸å¤§ï¼Œé€šå¸¸æ¥è¯´ä»–ä»¬ä¼šæ ¹æ®å®é™…æƒ…å†µï¼Œé€‰æ‹©æœ€æ–¹é¢å¿«æ·çš„æ–¹å¼ã€‚</p>
<p>æ‰€ä»¥ç»“è®ºæ˜¯ï¼šçŠ¶æ€éªŒè¯å’Œè¡Œä¸ºéªŒè¯å¹¶ä¸æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼ŒçœŸæ­£çš„é—®é¢˜åœ¨äºClassicalå’ŒMockistä¹‹é—´çš„é€‰æ‹©ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆæ—¶å€™ä½¿ç”¨Mockå¯¹è±¡çš„é—®é¢˜ã€‚ä½†æ˜¯çŠ¶æ€å’Œè¡Œä¸ºéªŒè¯ç¡®å®ä¼šå½±å“åˆ°è¿™ä¸ªè®¨è®ºï¼Œåé¢ä¼šé›†ä¸­é˜è¿°ã€‚Martin Fowleråœ¨è¿™é‡ŒæŠ›å‡ºäº†å¦å¤–ä¸€ä¸ªæƒ…å†µï¼šå‡è®¾æµ‹è¯•è€…é‡åˆ°äº†ä¸€ä¸ªéå¸¸éš¾ä»¥è¿›è¡ŒçŠ¶æ€éªŒè¯çš„æƒ…å†µï¼Œå³ä½¿ä»–é¢å¯¹çš„æ˜¯ä¸€ä¸ªç®€å•çš„å†™ä½œå…³ç³»ï¼Œæä½³çš„ä¾‹å­å°±æ˜¯Cacheï¼Œå› ä¸ºä½ ä¸èƒ½ä»ä»–çš„çŠ¶æ€æ¥ç¡®è®¤Cacheæ˜¯å¦å‘½ä¸­æˆ–è€…ä¸å‘½ä¸­ï¼Œè¿™ä¸ªæ—¶å€™è¡Œä¸ºéªŒè¯åè€Œæ˜¯ä¸€ä¸ªéå¸¸æ˜æ™ºçš„é€‰æ‹©ã€‚Martin Fowlerè®¤ä¸ºè¿˜æœ‰å¾ˆå¤šåˆ«çš„ç±»ä¼¼æƒ…å†µã€‚</p>
<p>åœ¨æˆ‘ä»¬è¿›è¡Œå†³ç­–è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è®¨è®ºä¸€ä¸‹æˆ‘ä»¬åšå‡ºå†³ç­–çš„æ—¶å€™éœ€è¦è€ƒè™‘çš„å› ç´ ã€‚</p>
<h3 id="Driving-TDD"><a href="#Driving-TDD" class="headerlink" title="Driving TDD"></a>Driving TDD</h3><p>Mockå¯¹è±¡è¯ç”ŸäºXPç¤¾åŒºï¼Œè€ŒXPçš„ä¸€ä¸ªé‡è¦åŸåˆ™å°±æ˜¯TDDâ€”â€”ç³»ç»Ÿçš„è¿­ä»£è¿›åŒ–æ˜¯ç”±æµ‹è¯•é©±åŠ¨è¿›è¡Œçš„ã€‚å› æ­¤mockistså¼ºè°ƒmockistså¯¹äºè®¾è®¡çš„ä½œç”¨æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œå°¤å…¶æ˜¯ä»–ä»¬å®£ä¼ ä¸€ç§ç§°ä½œéœ€æ±‚é©±åŠ¨çš„å¼€å‘æ–¹å¼ï¼Œåœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œå¼€å‘è€…é¦–å…ˆé€šè¿‡å†™æµ‹è¯•æ¥å¼€å‘ä¸€ä¸ªuser storyï¼Œç†æ¸…æ¥šSUTã€å¯¹collaboratorsçš„expectationsä»¥åŠSUTå’Œcollaboratorä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆåœ°è®¾è®¡å‡ºSUTçš„å¤–å›´æ¥å£ã€‚</p>
<p>ä¸€æ—¦ä½ çš„ç¬¬ä¸€ä¸ªæµ‹è¯•è¿è¡Œèµ·æ¥ï¼Œmockä¸­æºå¸¦çš„expectationså°±ä¸ºä¸‹ä¸€æ­¥çš„å¼€å‘å’Œæµ‹è¯•æä¾›äº†ä¸€ä¸ªå‡ºå‘ç‚¹ã€‚å¼€å‘è€…å¯ä»¥å°†æ¯ä¸€ä¸ªexpectationsè½¬æ¢æˆcollaboratorä¸Šçš„testï¼Œè¿™æ ·å¾ªç¯è¿­ä»£ï¼Œé€æ­¥å¼€å‘å»ºç«‹SUTã€‚è¿™ç§é£æ ¼ä¹Ÿè¢«ç§°ä¸ºoutside-inï¼Œæè¿°çš„éå¸¸åˆ°ä½ã€‚åœ¨åˆ†å±‚ç³»ç»Ÿä¸­è¿™ç§æ–¹å¼å·¥ä½œçš„å¾ˆå¥½ï¼Œé¦–å…ˆä½ å¯ä»¥å¼€å‘UIï¼Œåº•å±‚ä½¿ç”¨Mockå®ç°ï¼Œç„¶åä½ å¯ä»¥ä¸ºæ›´åº•å±‚å†™æµ‹è¯•ï¼Œé€æ­¥å¾€ä¸‹å»¶ä¼¸ï¼Œè¿™æ˜¯ä¸€ä¸ªé«˜åº¦ç»“æ„åŒ–çš„å¼€å‘æ–¹å¼ï¼Œå¾ˆå¤šäººç›¸ä¿¡è¿™å¯¹äºOOå’ŒTDDçš„åˆå­¦è€…éƒ½å¾ˆæœ‰è£¨ç›Šã€‚</p>
<p>ç»å…¸çš„TDDç»™å‡ºçš„æŒ‡å¯¼ç•¥æœ‰ä¸åŒã€‚ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„å¼€å‘æ­¥éª¤ï¼Œä½†æ˜¯æ˜¯ä½¿ç”¨çš„stubï¼Œè€Œä¸æ˜¯mockã€‚è¿™æ ·å½“ä½ éœ€è¦collaboratorçš„ååŠ©çš„æ—¶å€™ï¼Œä½ åªéœ€è¦å°†æµ‹è¯•çš„éœ€è¦çš„è¿”å›ç»“æœç¡¬ç¼–ç è¿›å»å°±å¥½äº†ï¼Œå½“ä½ ç¼–ç åˆ°è¿™ä¸€æ®µçš„æ—¶å€™ï¼Œä½ å¯ä»¥å°†ç»“æœæ›¿æ¢æˆå®é™…è¿è¡Œçš„é€»è¾‘ä»£ç ã€‚</p>
<p>ç»å…¸çš„TDDè¿˜å¯ä»¥åšåˆ«çš„äº‹æƒ…ï¼Œä¸€ä¸ªæµè¡Œçš„å½¢å¼å°±æ˜¯middle-outã€‚åœ¨è¿™ç§é£æ ¼ä¸‹é¢ä½ éœ€è¦è€ƒè™‘ä½ å¼€å‘çš„åŠŸèƒ½ä»¥åŠè¿™ä¸ªåŠŸèƒ½æ‰€éœ€è¦çš„domain(ä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘æ›´åŠ åˆé€‚)ï¼Œä½ å¯ä»¥é¦–å…ˆè·å–åˆ°ä¸€ä¸ªæ»¡è¶³ä½ éœ€æ±‚çš„domainå¯¹è±¡ï¼Œä¸€æ—¦å®ƒå¯ä»¥å·¥ä½œäº†ï¼Œä½ å°±å¯ä»¥åœ¨æ­¤ä¹‹ä¸Šè¿›è¡Œå¼€å‘ã€‚ä½¿ç”¨è¿™ç§é£æ ¼ä¸éœ€è¦ä½ é€ å‡ä»»ä½•ä¸œè¥¿ã€‚å› ä¸ºä¸€å¼€å§‹æˆ‘ä»¬å¯ä»¥å°†ç²¾åŠ›é›†ä¸­åœ¨domainæ¨¡å‹ä¸Šï¼Œå¯ä»¥é˜²æ­¢domainé€»è¾‘æ³„éœ²åˆ°UIæ›´ä¸Šå±‚ï¼Œå› æ­¤å¾ˆå¤šäººå–œæ¬¢è¿™ç§é£æ ¼ã€‚ï¼ˆçœ‹ä¸Šå»åƒæ˜¯ä¸€ç§å˜ç§ï¼‰</p>
<p>æœ‰å¾ˆå¤šçš„æƒ³æ³•éƒ½æ˜¯æƒ³è¦ä¸€å±‚å±‚æ„å»ºåº”ç”¨ï¼Œå¹¶ä¸”ä¸æ˜¯ç›´åˆ°å¦å¤–ä¸€å±‚å®Œæˆæ‰å¼€å‘ä¸‹ä¸€å±‚ã€‚Classicistå’ŒMockistéƒ½æœ‰ç€æ•æ·èƒŒæ™¯å¹¶ä¸”é’çç»†ç²’åº¦çš„è¿­ä»£ï¼Œå› æ­¤ä»–ä»¬éƒ½ä¸ä¼šé€‰æ‹©ä¸€å±‚å±‚å¼€å‘ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸€ä¸ªåŠŸèƒ½çš„å»å¼€å‘ã€‚</p>
<blockquote>
<p>ã€æœ‰è¯è¯´ã€‘ä¸ä½¿ç”¨TDDçš„å›¢é˜Ÿæ˜¯å¦å°±ä¸éœ€è¦è€ƒè™‘è¿™ä¸ªäº†ï¼Ÿä¸è¿‡é€šè¿‡Stubæˆ–è€…Mockçš„æ–¹å¼å®ç°å¿«é€Ÿè¿­ä»£å¼€å‘æ˜¯ä¸€ä¸ªä¸é”™çš„æ€è·¯ï¼Œå¯ä»¥çŸ­æ—¶é—´å†…è®©ç²¾åŠ›é›†ä¸­åœ¨æŸä¸€ä¸ªç‚¹ä¸Šã€‚</p>
</blockquote>
<h3 id="Fixture-Setup"><a href="#Fixture-Setup" class="headerlink" title="Fixture Setup"></a>Fixture Setup</h3><p>ä½¿ç”¨classic TDDï¼Œæµ‹è¯•çš„æ—¶å€™ä¸ä½†éœ€è¦åˆ›å»ºSUTï¼Œè¿˜éœ€è¦åˆ›å»ºæ‰€æœ‰ç›¸å…³çš„collaboratorï¼Œä¾‹å­ä¸­æˆ‘ä»¬åªåˆ›å»ºäº†å¾ˆå°‘å‡ ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯å®é™…çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºå¾ˆå¤šçš„collaboratorï¼Œé€šå¸¸æ¥è¯´è¿™äº›å¯¹è±¡ä¼šéšç€ä¸€ä¸ªtestçš„æ‰§è¡Œè¢«åˆ›å»ºå’Œé”€æ¯ã€‚</p>
<p>Mockistæµ‹è¯•åˆ™ä¸ä¸€æ ·ï¼Œå®ƒåªéœ€è¦åˆ›å»ºSUTå’Œå®ƒçš„ç›´æ¥å…³è”å¯¹è±¡ï¼Œè¿™èƒ½å‡å°‘åˆ›å»ºä¸€äº›å¤æ‚å¯¹è±¡å¸¦æ¥çš„å·¥ä½œé‡ã€‚</p>
<p>å®è·µä¸­classicæµ‹è¯•è€…ä¼šå°½é‡å¤ç”¨å¤æ‚çš„collaboratorï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯å°†è¿™ç±»collaboratoræ”¾åˆ°xUnitçš„setupæ–¹æ³•ä¸­ï¼Œæ›´ä¸ºå¤æ‚çš„collaboratoråˆ™å¯èƒ½éœ€è¦è¢«å¤šä¸ªtestç±»ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨è¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªcollaboratorç”Ÿæˆç±»ã€‚Martin Fowlerå°†è¿™ä¸­ç”Ÿæˆç±»ç§°ä¸ºObject Mothersã€‚ä½¿ç”¨Object Mothersåœ¨å¤§å‹çš„classicæµ‹è¯•ä¸­éå¸¸é‡è¦ï¼Œä½†æ˜¯Object Mothersä¸ºæ•´ä¸ªæµ‹è¯•æ·»åŠ äº†é¢å¤–çš„éœ€è¦ç»´æŠ¤çš„ä»£ç ï¼Œä»»ä½•çš„æ”¹åŠ¨éƒ½ä¼šåœ¨æ•´ä¸ªæµ‹è¯•ä¸­é€ æˆä¸¥é‡çš„å½±å“ã€‚ä¸‹é¢Martin Fowleræ‰€è¯´çš„çœç•¥ã€‚</p>
<p>ä¸¤ç§é£æ ¼ä¹‹é—´æ—¶å¸¸æœ‰æ‰€äº‰è¾©ã€‚Mockistsè§‰å¾—åˆ›å»ºçœŸæ˜¯çš„collaboratorå¤ªè¿‡å¤æ‚ï¼Œä½†æ˜¯classicistsè®¤ä¸ºè¿™äº›collaboratoréƒ½å¯ä»¥å¤ç”¨ï¼Œä½†æ˜¯æ¯æ¬¡æµ‹è¯•éƒ½éœ€è¦åˆ›å»ºMockå¯¹è±¡ã€‚</p>
<blockquote>
<p>ã€æœ‰è¯è¯´ã€‘çœ‹å®é™…æƒ…å†µå§ï¼Œå¯¹ä¸€ä¸ªè¾ƒå®Œå¤‡çš„ç³»ç»Ÿåšæµ‹è¯•ï¼Œåº”è¯¥æ˜¯classicæ–¹å¼æ¯”è¾ƒå¿«é€Ÿï¼Œæ­£å¦‚Martin Fowleræ‰€è¯´ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹åˆ›å»ºå®é™…å¯¹è±¡éƒ½æ˜¯cheapçš„ã€‚ä½†æ˜¯ä¸æ’é™¤éœ€è¦åˆ›å»ºå¤æ‚å¯¹è±¡çš„æƒ…å†µã€‚</p>
</blockquote>
<h3 id="Test-Isolation"><a href="#Test-Isolation" class="headerlink" title="Test Isolation"></a>Test Isolation</h3><p>åœ¨Mockistsæµ‹è¯•æƒ…å†µä¸‹ï¼Œå¦‚æœåœ¨ç³»ç»Ÿä¸­å¼•å…¥äº†ä¸€ä¸ªbugï¼Œé€šå¸¸åªä¼šå¯¼è‡´åŒ…å«è¿™ä¸ªBugçš„SUTæ‰€åœ¨çš„testæ‰§è¡Œå¤±è´¥ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨classicæ–¹å¼ï¼Œåˆ™ä¼šå¯¼è‡´æ‰€æœ‰ä½¿ç”¨åˆ°è¿™ä¸ªbugå¯¹è±¡çš„æµ‹è¯•å¤±è´¥ã€‚</p>
<p>Mockistsè®¤ä¸ºè¿™ç§æƒ…å†µæœ‰å¾ˆå¤§çš„é—®é¢˜ï¼šä¼šå¯¼è‡´æ‰¾åˆ°æ ¹æœ¬çš„é”™è¯¯éœ€è¦å¾ˆå¤šçš„æ—¶é—´ã€‚ä½†æ˜¯classicistsåˆ™ä¸è¿™ä¹ˆè®¤ä¸ºï¼šé€šå¸¸æ¥è¯´ï¼Œå®šä½é—®é¢˜çš„å‘ç”Ÿç‚¹æ˜¯æ¯”è¾ƒç®€å•çš„äº‹æƒ…ï¼Œè€Œä¸”å¦‚æœç»å¸¸æµ‹è¯•çš„è¯ï¼Œä½ æ˜¯çŸ¥é“ä»€ä¹ˆæ”¹åŠ¨å¼•èµ·è¿™ç§é—®é¢˜çš„ï¼ˆPSï¼šç°ä»£çš„IDEä»¥åŠç‰ˆæœ¬æ§åˆ¶å·¥å…·ä½¿å¾—è¿™ä¸ªæ›´åŠ ç®€å•ï¼‰ã€‚</p>
<p>è¿™é‡Œä¸€ä¸ªå¯èƒ½å¾ˆé‡è¦çš„ç‚¹åœ¨äºæµ‹è¯•çš„ç²’åº¦ã€‚classicæµ‹è¯•éœ€è¦ä¸€æ¬¡exerciseå¾ˆå¤šä¸ªçœŸå®å¯¹è±¡ï¼Œç»å¸¸ä¼šå‡ºç°ä¸€ä¸ªå•ç‹¬çš„primary testç”¨äºæµ‹è¯•å¾ˆå¤šæ­Œå¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªã€‚å¦‚æœè¿™ä¸ªteståŒ…å«ç€å¾ˆå¤šä¸ªå¯¹è±¡ï¼Œæ‰¾åˆ°bugçš„åŸå› å°±æ¯”è¾ƒå›°éš¾äº†â€”â€”åŸå› å°±æ˜¯æµ‹è¯•å¤ªç²—ç²’åº¦äº†ã€‚</p>
<p>mockistæµ‹è¯•åˆ™æ¯”è¾ƒä¸å®¹æ˜“å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºé™¤äº†SUTï¼Œå…¶ä½™çš„å¯¹è±¡éƒ½æ˜¯Mockçš„ã€‚è¿™é‡Œæ¯”è¾ƒå¥½çš„åšæ³•æ˜¯ï¼šä¿è¯ä¸ºäº†ä¸€ä¸ªç±»åˆ›å»ºç»†ç²’åº¦çš„æµ‹è¯•ã€‚ä½†æ˜¯æ¯”è¾ƒå¤§å‹é›†ä¸­çš„æµ‹è¯•ä¹Ÿæ˜¯æœ‰å­˜åœ¨æ„ä¹‰çš„ï¼Œä½†æ˜¯åªé™äºæµ‹è¯•å¾ˆå°‘çš„ä¸€äº›å¯¹è±¡ã€‚è€Œä¸”ä¸€æ—¦ä½ å‘ç°å› ä¸ºç²’åº¦å¤ªç²—ï¼Œå¯¼è‡´æµ‹è¯•çš„æ—¶å€™å¾ˆéš¾å®šä½é—®é¢˜ï¼Œä½ å°±åº”è¯¥åˆ›å»ºæ›´ç»†ç²’åº¦çš„æµ‹è¯•åŒºè¿½è¸ªé—®é¢˜ã€‚</p>
<p>å…¶å®ç»å…¸çš„xUnitæµ‹è¯•å¹¶ä¸åªæ˜¯ç®€å•çš„å•å…ƒæµ‹è¯•ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªæœ€å°é›†æˆæµ‹è¯•ã€‚å› æ­¤å¾ˆå¤šäººéƒ½æœŸæœ›å•å…ƒæµ‹è¯•å¯ä»¥å‘ç°ä¸€äº›å•ç‹¬å¯¹æŸä¸ªç±»è¿›è¡Œæµ‹è¯•æ—¶å‘ç°ä¸äº†çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯ç±»ä¹‹é—´äº¤äº’æ—¶çš„é—®é¢˜ã€‚Mockistæµ‹è¯•å°±ç¼ºä¹è¿™æ–¹é¢çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä½ è¿˜å¾—å…³æ³¨ä½ çš„expectationsæ˜¯å¦æœ‰é”™è¯¯ï¼Œä»è€Œå¯¼è‡´ä¸€äº›å®é™…å­˜åœ¨çš„é”™è¯¯æ¼æ‰ã€‚</p>
<p>ä¸ç®¡ä½ ä½¿ç”¨ä»€ä¹ˆé£æ ¼çš„æµ‹è¯•ï¼Œä½ å¿…é¡»ç»¼åˆä½¿ç”¨ç²—ç²’åº¦çš„éªŒæ”¶æµ‹è¯•ï¼ŒMartin Fowleré‡åˆ°è¿‡ä¸€äº›å› ä¸ºéªŒæ”¶æµ‹è¯•å¤ªæ™šè€Œè¿½æ‚”è«åŠçš„æƒ…å†µã€‚</p>
<blockquote>
<p>ã€æœ‰è¯è¯´ã€‘æˆ‘å€¾å‘äºclassicistsæ–¹å¼ï¼Œä¸ºäº†åˆ›å»ºç»†ç²’åº¦çš„æµ‹è¯•ï¼Œæ„Ÿè§‰éœ€è¦èŠ±è´¹çš„ç²¾åŠ›æ˜¯åœ¨å¤ªå¤§ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯çœŸå®å¯¹è±¡ &gt; Stubå¯¹è±¡ &gt; Mockå¯¹è±¡ã€‚</p>
</blockquote>
<p>###Coupling Tests to Implementations<br>å½“ä½¿ç”¨mockistæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æµ‹è¯•çš„æ˜¯SUTæ˜¯å¦å’Œå®ƒçš„collaboratoræ­£å¸¸äº¤äº’ã€‚classicåˆ™åªå…³å¿ƒæœ€ç»ˆçš„çŠ¶æ€ï¼Œè€Œä¸å…³ç³»çŠ¶æ€æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚å› æ­¤mockistæµ‹è¯•å’Œæ–¹æ³•çš„å®ç°è€¦åˆåº¦å°±æ›´é«˜â€”â€”æ›´æ”¹collaboratorçš„è°ƒç”¨é€šå¸¸ä¼šå¯¼è‡´mockistæµ‹è¯•è·‘ä¸è¿‡ã€‚</p>
<p>è¿™ç§è€¦åˆå¼•èµ·äº†ä¸€äº›å…³æ³¨ã€‚æœ€é‡è¦å°±æ˜¯TDDã€‚ä½¿ç”¨mockistæ˜¯çš„ä½ éœ€è¦è€ƒè™‘è¡Œä¸ºçš„å®ç°â€”â€”å®é™…ä¸Šmockistæµ‹è¯•è€…è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªä¼˜ç‚¹ã€‚è€ŒClassicistsè®¤ä¸ºåœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œåªå»è€ƒè™‘å¤–éƒ¨æ¥å£æ˜¯å¾ˆé‡è¦çš„ï¼Œè€Œå…·ä½“çš„å®ç°åº”è¯¥æ”¾åœ¨æµ‹è¯•ä¹‹åå†å»è€ƒè™‘ã€‚</p>
<p>è¿™ç§æƒ…å†µåœ¨ä½¿ç”¨mockå·¥å…·çš„æ—¶å€™å˜å¾—æ›´åŠ ç³Ÿç³•ï¼Œå› ä¸ºmockå·¥å…·é€šå¸¸éœ€è¦ä½ å¾ˆè¯¦ç»†çš„æè¿°æ–¹æ³•çš„è°ƒç”¨å’Œå‚æ•°ï¼Œå³ä½¿ä¸ç‰¹å®šçš„è¿™ä¸ªtestæ— å…³ã€‚jMockå·¥å…·çš„ä¸€ä¸ªç›®æ ‡å°±æ˜¯ä½¿å¾—åœ¨æè¿°expectationçš„æ—¶å€™å˜å¾—æ›´åŠ çµæ´»ï¼Œä½¿å¾—å®ƒ(expectation)åœ¨ä¸å…³å¿ƒçš„åœ°æ–¹å¯ä»¥æè¿°çš„æ›´åŠ å®½æ³›ã€‚</p>
<blockquote>
<p>ã€æœ‰è¯è¯´ã€‘è®ºè€¦åˆçš„è¯ä¸¤è€…éƒ½æœ‰ï¼Œåªæ˜¯å¦‚Martin Fowleræ‰€è¯´ï¼Œmockistä¸ä»…éœ€è¦è€ƒè™‘ä¸€äº›å…·ä½“çš„å®ç°ï¼ˆæ–¹æ³•è°ƒç”¨ï¼‰ï¼Œè¿˜éœ€è¦è€ƒè™‘è¿”å›å€¼ï¼Œè€ŒClassicistsåªè€¦åˆäº†æœ€ç»ˆçš„çŠ¶æ€ï¼Œåè€…ç›¸å¯¹è€Œè¨€æ›´åŠ è½»ä¾¿ã€‚</p>
</blockquote>
<h3 id="Design-Style"><a href="#Design-Style" class="headerlink" title="Design Style"></a>Design Style</h3><p>å¿½ç•¥ã€‚</p>
<blockquote>
<p>ã€æœ‰è¯è¯´ã€‘å¿½ç•¥äº†è¿˜æœ‰è¯è¯´ï¼Ÿæœ‰ã€‚å®é™…ä¸Šè¿™ä¸€å°èŠ‚æ˜¯Martin Fowleræœ€å…³æ³¨çš„éƒ¨åˆ†ï¼Œå³å¯¹æµ‹è¯•æ–¹å¼çš„é€‰æ‹©ä¼šå¦‚ä½•å½±å“ä½ çš„ä»£ç è®¾è®¡ã€‚ä½†æˆ‘è®¤ä¸ºè¿™éœ€è¦å¯¹è¿™ä¸¤ç§ç†å¿µæœ‰è¶³å¤Ÿçš„äº†è§£å’Œå®è·µç»å†æ‰ä¼šæœ‰æ·±åˆ»çš„ç†è§£ï¼Œä»è€Œå»æ€è€ƒMartin Fowlerçš„è¯ã€‚è€Œæˆ‘æœ¬èº«ä¸å…·å¤‡è¿™æ ·çš„æ¡ä»¶ã€‚</p>
</blockquote>
<h2 id="åˆ°åº•è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ"><a href="#åˆ°åº•è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ" class="headerlink" title="åˆ°åº•è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ"></a>åˆ°åº•è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ</h2><p>è¿™ä¸ªé—®é¢˜æ¯”è¾ƒéš¾å›ç­”ï¼ŒMartin Fowleræ˜¯ä¸€ä¸ªclassicæµ‹è¯•è€…ï¼Œä»–è®¤ä¸ºç›®å‰æ²¡æœ‰ä»»ä½•ç†ç”±æ”¹å˜æˆä¸€ä¸ªmockistæµ‹è¯•è€…ã€‚ä»–åœ¨è§‚å¯Ÿåˆ°mockistç¼–ç è€…ä¹‹åï¼Œè¿™ç§æƒ³æ³•å°±æ›´åŠ åšå®šäº†ï¼Œå› ä¸ºåœ¨å†™expectationçš„æ—¶å€™éœ€è¦æ®šç²¾ç«­è™‘å»æ€è€ƒå®ç°å’Œè°ƒç”¨æ–¹å¼æ˜¾å¾—éå¸¸ä¸è‡ªç„¶ã€‚</p>
<p>åŒæ—¶Martin Fowlerä¹Ÿè¯´é“ï¼šåœ¨å¾ˆæ·±å…¥çš„ä½¿ç”¨ä¸€é¡¹æŠ€æœ¯ä¹‹å‰ï¼Œè¯„ä»·å®ƒå¾ˆå›°éš¾ã€‚æ‰€ä»¥å¦‚æœè¯»è€…å¯¹Mockistæœ‰å…´è¶£ï¼Œå¯ä»¥å°è¯•ä¸€æŠŠã€‚</p>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>xUnitæµ‹è¯•æ¡†æ¶å’ŒTDDè¶Šæ¥è¶Šç«çƒ­ï¼Œäººä»¬é€šå¸¸ä¼šä¸æ±‚ç”šè§£çš„å»æ¥å“¦æ¥ä½¿ç”¨ä¸€ä¸ªæ¡†æ¶ï¼Œè€Œä¸çŸ¥é“å…¶èƒŒåè®¾è®¡çš„ç†å¿µå’Œå«ä¹‰ã€‚ä¸ç®¡ä½ ä¸€å¼€å§‹å­¦ä¹ åˆ°ä»€ä¹ˆæ¡†æ¶ï¼Œä»ä¸åŒçš„è§’åº¦å»ç†è§£å®ƒå’Œåˆ«çš„æ¡†æ¶çš„ä¸åŒéƒ½å¾ˆé‡è¦â€”â€”äº†è§£èƒŒåæŒ‡å¯¼å®ƒä»¬çš„ç†å¿µéå¸¸é‡è¦ï¼è¿™ç¯‡æ–‡ç« çš„ç›®çš„å°±æ˜¯æŒ‡å‡ºè¿™äº›ç†å¿µçš„åŒºåˆ«ä»¥åŠå¦‚ä½•åœ¨å®ƒä»¬ä¹‹é—´åšå‡ºæƒè¡¡ã€‚</p>
<h2 id="æˆ‘è¨€"><a href="#æˆ‘è¨€" class="headerlink" title="æˆ‘è¨€"></a>æˆ‘è¨€</h2><p>å½“åˆä¹Ÿæ˜¯å› ä¸ºè¦å¯¹ä¸€ä¸ªAndroidé¡¹ç›®åšå•å…ƒæµ‹è¯•ï¼Œå› æ­¤å¼€å§‹çœ‹ä¸€äº›å•å…ƒæµ‹è¯•æ–¹é¢çš„çŸ¥è¯†ï¼Œä»Googleå®˜ç½‘ä¸Šçœ‹åˆ°äº†å¯¹Mockitoçš„å¼•ç”¨æ¨èï¼Œä»è€Œçœ‹åˆ°å…¶å®˜ç½‘ä¸Šçš„ç¤ºä¾‹ï¼Œè¿›è€Œå¯¹expectationsäº§ç”Ÿäº†ç–‘é—®â€”â€”æˆ‘ä¹‹å‰å¹¶ä¸çŸ¥é“è¿˜æœ‰è¡Œä¸ºéªŒè¯è¿™ç§ä¸œè¥¿ï¼Œå› æ­¤å¯¹æˆ‘è€Œè¨€è¡Œä¸ºéªŒè¯çš„é‚£æ®µä»£ç éå¸¸éš¾ä»¥ç†è§£ï¼Œåœ¨ç¿»é˜…èµ„æ–™çš„æ—¶å€™æ— æ„ä¸­çœ‹åˆ°äº†Martin Fowlerçš„è¿™ç¯‡æ–‡ç« ï¼Œé‚è¯‘ä¹‹ã€‚</p>
<p>è¯»å®Œè¿™ç¯‡æ–‡ç« ï¼Œæœ€å¤§çš„æ”¶è·å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç†è§£äº†è¡Œä¸ºéªŒè¯ &amp; çŠ¶æ€éªŒè¯çš„åŒºåˆ«ï¼›</li>
<li>äº†è§£äº†classicå’Œmockistä¸¤ç§æµ‹è¯•é£æ ¼çš„åŒºåˆ«ï¼›</li>
<li>äº†è§£äº†åœ¨è¿™äº›åŒºåˆ«ä¹‹é—´åšå‡ºå†³ç­–éœ€è¦è€ƒè™‘çš„ä¸€äº›å› ç´ ï¼›</li>
</ol>
<p>æˆ‘å¯¹äºå†³ç­–å› ç´ çš„ä¸€äº›è€ƒè™‘ä¹Ÿå·²ç»é€šè¿‡ã€æœ‰è¯è¯´ã€‘å†™åœ¨ä¸‹é¢äº†ã€‚åæœŸæˆ‘çš„å•å…ƒæµ‹è¯•åº”è¯¥ä¼šä¾§é‡äºã€çŠ¶æ€éªŒè¯+çœŸå®å¯¹è±¡+Stubã€‘çš„æ–¹å¼ï¼Œè¯šå¦‚Martin Fowleræ‰€è¨€ï¼Œmockistçš„æ–¹å¼å¯¹æˆ‘è€Œè¨€éœ€è¦è€ƒè™‘ç»´æŠ¤çš„ä¸œè¥¿å¤ªå¤šã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidå•å…ƒæµ‹è¯•(ä¸€)â€”â€”æµ‹è¯•åˆ†ç±»å’ŒåŸºç¡€]]></title>
      <url>http://www.timebridge.space/2015/11/17/Android-unit-test/</url>
      <content type="html"><![CDATA[<p>ç¿»è¯‘æ€»ç»“ä¸€ç¯‡è®²è¿°Androidå•å…ƒæµ‹è¯•çš„æ–‡ç« ï¼Œæ¯”å®˜ç½‘çš„è®²è¿°æ›´å…·æ¡ç†ã€‚åŒæ—¶æè¿°ä¸€äº›åœ¨å®è·µä¸­é‡åˆ°çš„å‘ã€‚</p>
<p><strong>å®˜ç½‘æ–‡æ¡£å…¥å£</strong>  <a href="http://developer.android.com/intl/zh-cn/training/testing.html" target="_blank" rel="noopener">Best Practices for Testing</a><br><strong>è‹±æ–‡åŸæ–‡åœ°å€</strong>  <a href="http://www.vogella.com/tutorials/AndroidTesting/article.html" target="_blank" rel="noopener">Developing Android unit and instrumentation tests</a></p>
<blockquote>
<p>ã€å»ºè®®ã€‘è¯»è€…æœ€å¥½å…ˆå¤§è‡´çœ‹ä¸€ä¸‹å®˜ç½‘æ–‡æ¡£ï¼Œç†æ¸…æ¥šç›¸å…³æ¦‚å¿µï¼Œç„¶åå†æ¯”å¯¹è‹±æ–‡åŸæ–‡å’Œæœ¬æ–‡çš„ç¿»è¯‘ï¼Œè¾¹é˜…è¯»è¾¹å®è·µã€‚</p>
</blockquote>
<h2 id="ä¸ºä»€ä¹ˆAndroidåº”ç”¨éœ€è¦æµ‹è¯•ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆAndroidåº”ç”¨éœ€è¦æµ‹è¯•ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆAndroidåº”ç”¨éœ€è¦æµ‹è¯•ï¼Ÿ"></a>ä¸ºä»€ä¹ˆAndroidåº”ç”¨éœ€è¦æµ‹è¯•ï¼Ÿ</h2><h3 id="ä¸ºä»€ä¹ˆæµ‹è¯•Androidåº”ç”¨å°¤å…¶é‡è¦ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæµ‹è¯•Androidåº”ç”¨å°¤å…¶é‡è¦ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæµ‹è¯•Androidåº”ç”¨å°¤å…¶é‡è¦ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæµ‹è¯•Androidåº”ç”¨å°¤å…¶é‡è¦ï¼Ÿ</h3><p>androidåº”ç”¨åœ¨ä¸€ç§èµ„æºï¼ˆå†…å­˜ï¼ŒCPUï¼Œç”µé‡ç­‰ï¼‰æœ‰é™çš„æƒ…å†µä¸‹è¿è¡Œï¼Œå¹¶ä¸”è¿è¡Œæƒ…å†µä¾èµ–äºå¤–éƒ¨å› ç´ ï¼Œæ¯”å¦‚æ˜¯å¦è”ç½‘ï¼Œä½¿ç”¨æƒ…å†µç­‰ï¼Œå› æ­¤æµ‹è¯•ä¼˜åŒ–androidåº”ç”¨éå¸¸é‡è¦ï¼Œå¯¹åº”ç”¨è¿›è¡Œé€‚å½“çš„æµ‹è¯•æœ‰åŠ©äºæé«˜åº”ç”¨è´¨é‡ï¼Œå¢å¼ºå¯ç»´æŠ¤æ€§ã€‚<a id="more"></a></p>
<h3 id="Androidæµ‹è¯•ç­–ç•¥"><a href="#Androidæµ‹è¯•ç­–ç•¥" class="headerlink" title="Androidæµ‹è¯•ç­–ç•¥"></a>Androidæµ‹è¯•ç­–ç•¥</h3><p>åœ¨æ‰€æœ‰ä¸åŒé…ç½®çš„è®¾å¤‡ä¸Šæµ‹è¯•ä¸€ä¸ªåº”ç”¨æ˜¯ä¸å¤§å¯èƒ½çš„ï¼Œä¸€èˆ¬æ¥è¯´åªèƒ½åœ¨å…¸å‹çš„è®¾å¤‡ä¸Šè¿›è¡Œæµ‹è¯•â€”â€”æµ‹è¯•çš„æ—¶å€™åº”è¯¥é€‰å–ä¸€ä¸ªå°½å¯èƒ½ä½é…ç½®çš„è®¾å¤‡å’Œå°½å¯èƒ½é«˜é…ç½®çš„è®¾å¤‡è¿›è¡Œæµ‹è¯•ï¼Œæ‰€è°“é…ç½®ï¼Œæ˜¯è¯¸å¦‚å±å¹•åˆ†è¾¨ç‡ï¼Œåƒç´ å¯†åº¦ç­‰ã€‚</p>
<h3 id="Androidçš„æµ‹è¯•æ”¯æŒ"><a href="#Androidçš„æµ‹è¯•æ”¯æŒ" class="headerlink" title="Androidçš„æµ‹è¯•æ”¯æŒ"></a>Androidçš„æµ‹è¯•æ”¯æŒ</h3><p>2015å¹´ç”¨äºAndroidåº”ç”¨çš„æµ‹è¯•å·¥å…·å’Œæ¡†æ¶å¾—åˆ°äº†æå¤§çš„æå‡ã€‚Androidçš„æ•´ä¸ªæµ‹è¯•æ”¯æŒç³»ç»Ÿè¢«æ›´æ–°åˆ°åŸºäºJUnit4ï¼Œå•å…ƒæµ‹è¯•ä»£ç æ—¢å¯ä»¥è¿è¡Œåœ¨JVMä¸Šï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨Androidè®¾å¤‡ä¸Šã€‚åŒæ—¶ï¼ŒGoogleå¼•å…¥äº†æ–°çš„UIæµ‹è¯•æ¡†æ¶â€”â€”Espressoï¼Œä½¿å¾—æµ‹è¯•Androidåº”ç”¨çš„UIå˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p>
<h2 id="å‰ç½®è¦æ±‚"><a href="#å‰ç½®è¦æ±‚" class="headerlink" title="å‰ç½®è¦æ±‚"></a>å‰ç½®è¦æ±‚</h2><p>ä¸‹é¢çš„æè¿°åŸºäºå¦‚ä¸‹å‡è®¾ï¼š</p>
<ol>
<li>è¯»è€…å·²ç»çŸ¥é“å¦‚ä½•åˆ›å»ºä¸€ä¸ªAndroidåº”ç”¨ï¼Œè¯»è€…å¯ä»¥é˜…è¯»<a href="http://www.vogella.com/tutorials/Android/article.html" target="_blank" rel="noopener">Android Tutorial</a>è·å–æ›´è¯¦ç»†çš„æ¶ˆæ¯;</li>
<li>è¯»è€…äº†è§£Androidçš„ç¼–è¯‘ç³»ç»Ÿâ€”â€”Gradleï¼Œè¯»è€…å¯ä»¥é˜…è¯»<a href="http://www.vogella.com/tutorials/AndroidBuild/article.html" target="_blank" rel="noopener">Building Android applications with Gradle Tutorial</a>è¿›è¡ŒåŸºæœ¬äº†è§£;</li>
<li>å¯¹JUnitæµ‹è¯•æ¡†æ¶æœ‰ä¸€å®šçš„äº†è§£ï¼Œè¿™ä¸ªç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œæ¨èä¸€ç¯‡<a href="http://thihy.iteye.com/blog/1771826" target="_blank" rel="noopener">Javaå•å…ƒæµ‹è¯•(Junit+Mock+ä»£ç è¦†ç›–ç‡)</a></li>
</ol>
<h2 id="Androidè‡ªåŠ¨åŒ–æµ‹è¯•"><a href="#Androidè‡ªåŠ¨åŒ–æµ‹è¯•" class="headerlink" title="Androidè‡ªåŠ¨åŒ–æµ‹è¯•"></a>Androidè‡ªåŠ¨åŒ–æµ‹è¯•</h2><h3 id="æµ‹è¯•ä»€ä¹ˆï¼Ÿ"><a href="#æµ‹è¯•ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æµ‹è¯•ä»€ä¹ˆï¼Ÿ"></a>æµ‹è¯•ä»€ä¹ˆï¼Ÿ</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æµ‹è¯•çš„é‡ç‚¹æ˜¯åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œä»¥ä¸‹çš„æµ‹è¯•æ¯”ä¾‹æ˜¯æ¯”è¾ƒåˆç†çš„ï¼š</p>
<ol>
<li>70%~80%çš„å•å…ƒæµ‹è¯•ç”¨æ¥ä¿è¯åº•å±‚ä»£ç çš„ç¨³å®šæ€§ï¼›</li>
<li>20%~30%çš„åŠŸèƒ½æµ‹è¯•ç”¨æ¥ä¿è¯åº”ç”¨çš„ç¡®å¯ä»¥æ­£å¸¸è¿è¡Œï¼›</li>
<li>å°‘é‡çš„åŠŸèƒ½æµ‹è¯•ç”¨äºæµ‹è¯•ä½ çš„åº”ç”¨å’Œåˆ«çš„åº”ç”¨çš„äº¤äº’â€”â€”å¦‚æœæœ‰çš„è¯ï¼›</li>
</ol>
<h3 id="æµ‹è¯•å‰ç½®æ¡ä»¶"><a href="#æµ‹è¯•å‰ç½®æ¡ä»¶" class="headerlink" title="æµ‹è¯•å‰ç½®æ¡ä»¶"></a>æµ‹è¯•å‰ç½®æ¡ä»¶</h3><p>åœ¨Androidæµ‹è¯•ä¸­ä¸ºæ‰€æœ‰çš„æµ‹è¯•å£°æ˜ä¸€ä¸ª <strong>testPreconditions()</strong> æ–¹æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æ‰§è¡Œå¤±è´¥äº†ï¼Œä½ å¯ä»¥ç«‹å³çŸ¥é“å…¶ä»–æµ‹è¯•æ‰€ä¾èµ–çš„å‰ç½®æ¡ä»¶ä¸æ»¡è¶³ï¼ˆæ¢è¨€ä¹‹ï¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•ä¿è¯ä¸ºåç»­çš„æµ‹è¯•æä¾›ä¸€ä¸ªç¨³å®šçš„æµ‹è¯•ç¯å¢ƒï¼‰ã€‚</p>
<h3 id="æµ‹è¯•å•ä¸ªAppæˆ–è€…å¤šä¸ªApp"><a href="#æµ‹è¯•å•ä¸ªAppæˆ–è€…å¤šä¸ªApp" class="headerlink" title="æµ‹è¯•å•ä¸ªAppæˆ–è€…å¤šä¸ªApp"></a>æµ‹è¯•å•ä¸ªAppæˆ–è€…å¤šä¸ªApp</h3><p>æµ‹è¯•å¦å¤–ä¸€ä¸ªé‡è¦è€ƒé‡æ ‡å‡†å°±æ˜¯ä½ æ˜¯å•ç‹¬æµ‹è¯•ä½ è‡ªå·±çš„åº”ç”¨è¿˜æ˜¯æµ‹è¯•ä½ çš„åº”ç”¨å’Œåˆ«çš„åº”ç”¨çš„é›†æˆï¼ˆå³ä¸¤è€…çš„äº¤äº’ï¼‰ã€‚å¦‚æœä½ åªæ˜¯æµ‹è¯•ä½ è‡ªå·±çš„åº”ç”¨ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ä¸€äº›éœ€è¦äº†è§£åº”ç”¨å†…éƒ¨ä¿¡æ¯çš„æµ‹è¯•æ¡†æ¶ï¼ˆæ¯”å¦‚viewIdï¼‰â€”â€”è¿™æ¶‰åŠåˆ°æµ‹è¯•æ¡†æ¶çš„é€‰æ‹©ã€‚</p>
<h2 id="Androidæ™®é€šå•å…ƒå’ŒInstrumentationå•å…ƒæµ‹è¯•"><a href="#Androidæ™®é€šå•å…ƒå’ŒInstrumentationå•å…ƒæµ‹è¯•" class="headerlink" title="Androidæ™®é€šå•å…ƒå’ŒInstrumentationå•å…ƒæµ‹è¯•"></a>Androidæ™®é€šå•å…ƒå’ŒInstrumentationå•å…ƒæµ‹è¯•</h2><h3 id="Androidå•å…ƒæµ‹è¯•ç§ç±»"><a href="#Androidå•å…ƒæµ‹è¯•ç§ç±»" class="headerlink" title="Androidå•å…ƒæµ‹è¯•ç§ç±»"></a>Androidå•å…ƒæµ‹è¯•ç§ç±»</h3><p>Androidå•å…ƒæµ‹è¯•æ˜¯åŸºäºJUnitçš„ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ol>
<li>æœ¬åœ°å•å…ƒæµ‹è¯•â€”â€”æµ‹è¯•è¿è¡Œåœ¨JVMä¸Šï¼›</li>
<li>Instrumentationå•å…ƒæµ‹è¯•â€”â€”æµ‹è¯•éœ€è¦è¿è¡Œåœ¨Androidç³»ç»Ÿä¸Šï¼›</li>
</ol>
<p>æµ‹è¯•çš„æ—¶å€™åº”è¯¥å°½å¯èƒ½ä½¿ç”¨æœ¬åœ°å•å…ƒæµ‹è¯•ï¼Œå› ä¸ºæœ¬åœ°å•å…ƒæµ‹è¯•ç›¸è¾ƒè€Œè¨€æ›´å¿«ï¼ŒInstrumentationå•å…ƒæµ‹è¯•éœ€è¦éƒ¨ç½²åº”ç”¨å¹¶ä¸”åœ¨Androidè®¾å¤‡ä¸Šè¿è¡Œæµ‹è¯•ã€‚</p>
<h3 id="æœ¬åœ°å•å…ƒæµ‹è¯•"><a href="#æœ¬åœ°å•å…ƒæµ‹è¯•" class="headerlink" title="æœ¬åœ°å•å…ƒæµ‹è¯•"></a>æœ¬åœ°å•å…ƒæµ‹è¯•</h3><p>Android Gradleæ”¯æŒåœ¨JVMä¸Šè¿è¡ŒAndroidå•å…ƒæµ‹è¯•ï¼Œä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼ŒGradleåˆ›å»ºäº†ä¸€ä¸ªç‰¹æ®Šç‰ˆæœ¬çš„android.jarï¼ˆä¹Ÿæˆä¸ºAndroid mockable jarï¼‰æ¥æä¾›å•å…ƒæµ‹è¯•éœ€è¦çš„å„ç§å±æ€§ã€æ–¹æ³•ã€ç±»ã€‚è°ƒç”¨è¿™ä¸ªjaråŒ…ä¸­çš„ä»»ä½•å‡½æ•°éƒ½ä¼šå¯¼è‡´å¼‚å¸¸ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœä½ çš„ç±»æ²¡æœ‰è°ƒç”¨ä»»ä½•çš„Android APIæˆ–è€…åªæ˜¯æœ‰å¾ˆç®€å•çš„ä¾èµ–ï¼Œä½ å¯ä»¥æ¯«æ— é™åˆ¶çš„ä½¿ç”¨JUnitæµ‹è¯•æ¡†æ¶ï¼ˆæˆ–è€…åˆ«çš„ä»»ä½•Javaå•å…ƒæµ‹è¯•æ¡†æ¶ï¼‰ã€‚å•å…ƒæµ‹è¯•ä»£ç ä¸­ä»»ä½•å¯¹Androidçš„ä¾èµ–éƒ½åº”è¯¥è¢«æ›¿æ¢æ‰ï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚Mockitoè¿™æ ·çš„Mockæ¡†æ¶ã€‚</p>
<p>åœ¨JVMä¸Šè¿è¡Œæµ‹è¯•caseçš„å¥½å¤„å°±æ˜¯é€Ÿåº¦â€”â€”æ¯”èµ·åœ¨Androidæœºå™¨ä¸Šè¿è¡Œè¦å¿«å¾ˆå¤šå¾ˆå¤šã€‚</p>
<h3 id="ä½¿ç”¨Instrumented-testæµ‹è¯•ä½¿ç”¨äº†Android-APIçš„ç±»"><a href="#ä½¿ç”¨Instrumented-testæµ‹è¯•ä½¿ç”¨äº†Android-APIçš„ç±»" class="headerlink" title="ä½¿ç”¨Instrumented testæµ‹è¯•ä½¿ç”¨äº†Android APIçš„ç±»"></a>ä½¿ç”¨Instrumented testæµ‹è¯•ä½¿ç”¨äº†Android APIçš„ç±»</h3><p>å¦‚æœä½ éœ€è¦æµ‹è¯•ä½¿ç”¨äº†Android APIçš„ä»£ç ï¼Œä½ éœ€è¦åœ¨Androidè®¾å¤‡ä¸Šè¿è¡Œæµ‹è¯•ä»£ç ï¼ˆå› ä¸ºAndroidå·¥å…·ä¸Šmockå‡ºæ¥çš„android.jarå¹¶ä¸æ‰§è¡ŒçœŸæ­£çš„Androidä»£ç ï¼Œè€Œåªæ˜¯ç®€å•çš„æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™ä½¿å¾—æµ‹è¯•çš„æ‰§è¡Œæ¼«é•¿äº†è®¸å¤šã€‚</p>
<h2 id="Androidçš„é¡¹ç›®ç»“æ„å’Œæµ‹è¯•æ–‡ä»¶å¤¹çš„åˆ›å»º"><a href="#Androidçš„é¡¹ç›®ç»“æ„å’Œæµ‹è¯•æ–‡ä»¶å¤¹çš„åˆ›å»º" class="headerlink" title="Androidçš„é¡¹ç›®ç»“æ„å’Œæµ‹è¯•æ–‡ä»¶å¤¹çš„åˆ›å»º"></a>Androidçš„é¡¹ç›®ç»“æ„å’Œæµ‹è¯•æ–‡ä»¶å¤¹çš„åˆ›å»º</h2><h3 id="Androidçš„æµ‹è¯•é¡¹ç›®ç»“æ„"><a href="#Androidçš„æµ‹è¯•é¡¹ç›®ç»“æ„" class="headerlink" title="Androidçš„æµ‹è¯•é¡¹ç›®ç»“æ„"></a>Androidçš„æµ‹è¯•é¡¹ç›®ç»“æ„</h3><p>æ¯”è¾ƒæ¨èçš„æ–¹å¼æ˜¯æŒ‰ç…§çº¦å®šç»„ç»‡sourceä»£ç å’Œæµ‹è¯•ä»£ç ï¼ˆGradleæœ‰è‡ªå·±çš„çº¦å®šï¼‰ï¼Œä½ çš„åº”ç”¨é¡¹ç›®ç»“æ„åº”è¯¥æŒ‰ç…§ä¸‹é¢çš„æ–‡ä»¶å¤¹ç»“æ„è¿›è¡Œç»„ç»‡:</p>
<ul>
<li>app/src/main/java - æ”¾ç½®é¡¹ç›®çš„æºç </li>
<li>app/src/test/java - æ”¾ç½®è¿è¡Œåœ¨JVMä¸Šçš„å•å…ƒæµ‹è¯•ä»£ç </li>
<li>app/src/androidTest/java - æ”¾ç½®éœ€è¦è¿è¡Œåœ¨Androidè®¾å¤‡ä¸Šçš„æµ‹è¯•ä»£ç </li>
</ul>
<p>å¦‚æœä½ æŒ‰ç…§è¿™ä¸ªçº¦å®šæ¥ï¼Œé‚£ä¹ˆAndroidçš„ç¼–è¯‘ç³»ç»Ÿï¼ˆGradleï¼‰ä¼šè‡ªåŠ¨å°†å¯¹åº”çš„æµ‹è¯•ä»£ç è¿è¡Œåœ¨JVMå’ŒAndroidè®¾å¤‡ä¸Šã€‚</p>
<p>Gradleä¸Šå¯ä»¥é…ç½®è¿™å‡ ä¸ªæ–‡ä»¶å¤¹ï¼Œè¯»è€…åœ¨ä¸ç†Ÿæ‚‰Gradleçš„æƒ…å†µä¸‹å¹¶ä¸”æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä¿®æ”¹è¿™ä¸ªçº¦å®šã€‚</p>
<h2 id="ç¼–å†™æœ¬åœ°å•å…ƒæµ‹è¯•å¹¶ä¸”è¿è¡Œ"><a href="#ç¼–å†™æœ¬åœ°å•å…ƒæµ‹è¯•å¹¶ä¸”è¿è¡Œ" class="headerlink" title="ç¼–å†™æœ¬åœ°å•å…ƒæµ‹è¯•å¹¶ä¸”è¿è¡Œ"></a>ç¼–å†™æœ¬åœ°å•å…ƒæµ‹è¯•å¹¶ä¸”è¿è¡Œ</h2><p>å…ˆä¸Šå›¾ï¼Œè®©è¯»è€…æœ‰ä¸ªå¤§è‡´çš„äº†è§£:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Androidæœ¬åœ°å•å…ƒæµ‹è¯•.png" alt="Androidæœ¬åœ°å•å…ƒæµ‹è¯•é¡¹ç›®ç»“æ„"></p>
<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>åœ¨Androidä¸Šæˆ‘ä»¬ä½¿ç”¨æœ¯è¯­å•å…ƒæµ‹è¯•æ¥è¡¨ç¤ºé‚£äº›è¿è¡Œåœ¨æœ¬åœ°JVMä¸Šçš„æµ‹è¯•ä»£ç ã€‚å•å…ƒæµ‹è¯•åº”å½“è¢«ç”¨æ¥éªŒè¯ä¸€ä¸ªActivityçš„çŠ¶æ€ä»¥åŠå®ƒä¸å…¶ä½™ç»„ä»¶çš„äº¤äº’ï¼Œå‰ææ˜¯åœ¨ç‹¬ç«‹çš„ç¯å¢ƒä¸‹ï¼ˆä¸ç³»ç»Ÿå…¶ä½™éƒ¨åˆ†æ²¡æœ‰è”ç³»ï¼‰ï¼Œå®ƒä¸€èˆ¬ç”¨æ¥æµ‹è¯•ä»£ç çš„ä¸€å°éƒ¨åˆ†ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªç±»æˆ–è€…ä¸€ä¸ªç»„ä»¶ï¼Œä¸”ä¸ä¾èµ–ç³»ç»Ÿæˆ–è€…ç½‘ç»œèµ„æºç­‰å¤–éƒ¨ç¯å¢ƒã€‚ä¸¾ä¸ªæ —å­ï¼Œå‡è®¾åœ¨Activityä¸Šæœ‰ä¸€ä¸ªbuttonæ˜¯ç”¨æ¥å¯åŠ¨å¦å¤–ä¸€ä¸ªActivityçš„ï¼Œå•å…ƒæµ‹è¯•åº”è¯¥è¢«ç”¨æ¥æµ‹è¯•å¯åŠ¨Activityå¯¹åº”çš„intentæ˜¯å¦æ­£ç¡®ï¼Œè€Œä¸æ˜¯é‚£ä¸ªActivityæ˜¯å¦è¢«å¯åŠ¨ã€‚</p>
<p>å¦‚å‰é¢æ‰€è¿°ï¼Œå•å…ƒæµ‹è¯•çš„æ‰§è¡ŒåŸºäºä¸€ä¸ªè¢«ä¿®æ”¹çš„android.jaråŒ…ï¼Œæ‰€æœ‰çš„finalä¿®é¥°ç¬¦éƒ½è¢«ç§»é™¤æ‰äº†ï¼Œè¿™ä½¿å¾—ä½¿ç”¨mockåº“æˆä¸ºç°å®â€”â€”å¦‚æœä½ éœ€è¦ä¾èµ–Androidå¹³å°ï¼Œä½ å°±ä½¿ç”¨mockçš„æ¡†æ¶æ¥ä»£æ›¿é‚£äº›è°ƒç”¨ã€‚</p>
<blockquote>
<p>å®è·µä¸­å‘ç°è¿™ä¸€ç‚¹æå¤§çš„é™åˆ¶äº†æœ¬åœ°å•æµ‹çš„åº”ç”¨ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸šåŠ¡ä½¿ç”¨äº†SparseArrayï¼Œå¯¼è‡´é€»è¾‘å®Œå…¨ä¸å¯ä¾§ï¼Œå› ä¸ºMockå‡ºæ¥çš„å¯¹è±¡å®Œå…¨ä¸å…·å¤‡SparseArrayåŠŸèƒ½ã€‚</p>
</blockquote>
<h3 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h3><p>å¼€å‘è€…å®˜ç½‘ä¸Šå»ºè®®åœ¨build.gradleä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    // Unit testing dependencies</span><br><span class="line">    testCompile 'junit:junit:4.12'</span><br><span class="line">    // Set this dependency if you want to use Mockito</span><br><span class="line">    testCompile 'org.mockito:mockito-core:1.10.19'</span><br><span class="line">    // Set this dependency if you want to use Hamcrest matching</span><br><span class="line">    testCompile 'org.hamcrest:hamcrest-library:1.1'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªåŒ…çš„ä½œç”¨æ³¨é‡Šä¸­éƒ½å·²ç»æ ‡å‡ºã€‚æ³¨æ„ï¼ï¼ï¼è¿™é‡Œåƒä¸‡ä¸è¦å†™æˆcompileï¼Œç„¶åå»Fileâ€”â€”&gt;Project Structureâ€”â€”&gt;é€‰ä¸­Moduleâ€”â€”&gt;Dependenciesé‡Œé¢ï¼Œå†å°†è¿™ä¸‰ä¸ªåº“çš„Scopeæ”¹ä¸ºTest Compileï¼Œå®è·µä¸­ï¼Œè¿™æ ·æ“ä½œè¿™é‡Œä¼šå˜æˆandroidTestCompileã€‚æ€»ä¹‹ï¼Œè¯·ç¡®ä¿è¿™é‡Œæ˜¯testCompileã€‚</p>
<h3 id="ä»£ç ä½ç½®"><a href="#ä»£ç ä½ç½®" class="headerlink" title="ä»£ç ä½ç½®"></a>ä»£ç ä½ç½®</h3><p>æˆ‘çš„Android Studioç‰ˆæœ¬æ˜¯1.3.2ï¼Œæ–°å»ºçš„Androidé¡¹ç›®ä¸‹é¢è‡ªå¸¦androidTestç›®å½•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰testç›®å½•ã€‚æŒ‰ç…§å‰é¢æ‰€è®²è¿°çš„ç›®å½•ç»“æ„çº¦å®šï¼Œæˆ‘ä»¬å°†é¡¹ç›®è§†å›¾åˆ‡æ¢åˆ°Projectä¸‹é¢ï¼Œåœ¨srcç›®å½•ä¸‹é¢æ–°å»ºä¸€ä¸ªtestç›®å½•ã€‚è¯»è€…æ³¨æ„ä¸Šå›¾ä¸­çš„1ï¼Œ2ï¼Œ3ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¦å¤–è¯»è€…åº”è¯¥ç‚¹å‡»5ï¼Œè°ƒå‡ºâ€Build Variantsâ€è§†å›¾ï¼Œç„¶åå°†Test Artifactè®¾ç½®ä¸ºUnit Testã€‚</p>
<h3 id="ä»£ç ç¼–å†™"><a href="#ä»£ç ç¼–å†™" class="headerlink" title="ä»£ç ç¼–å†™"></a>ä»£ç ç¼–å†™</h3><p>è¿™é‡Œç»™å‡ºä¸€ä¸ªå®ä¾‹ï¼Œè¯»è€…å¯ä»¥ç›´æ¥Copyæµ‹è¯•ä¸€æŠŠ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_First</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String test = <span class="string">"aa"</span>;</span><br><span class="line">        assertEquals(test, <span class="string">"aa"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Second</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String test = <span class="string">"aa"</span>;</span><br><span class="line">        assertEquals(test, <span class="string">"aa"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Third</span><span class="params">()</span></span>&#123;</span><br><span class="line">        assertEquals(NumberUtils.calculateSum(<span class="number">100</span>), <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†™å®Œç±»ä¹‹åï¼Œè¯·æ‰“å¼€Runâ€”â€”&gt;Edit Configurationsè§†å›¾ï¼Œç„¶åç¡®ä¿æ•´ä¸ªè§†å›¾æ˜¯å¦‚ä¸‹æ˜¾ç¤ºçš„:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Androidå•å…ƒæµ‹è¯•é…ç½®.png" alt="Androidå•å…ƒæµ‹è¯•é…ç½®"></p>
<p>ä¹‹æ‰€ä»¥è¦æ³¨æ„è¿™é‡Œï¼Œæ˜¯å› ä¸ºæˆ‘ç¬¬ä¸€æ¬¡é…ç½®çš„æ—¶å€™ï¼Œä¸çŸ¥é“å› ä¸ºä»€ä¹ˆåŸå› ï¼Œå†™äº†ä¸€ä¸ªå•å…ƒæµ‹è¯•caseï¼Œå´é…ç½®æˆäº†Instrumentæµ‹è¯•caseï¼Œå¯¼è‡´æ¯æ¬¡è¿è¡Œcaseçš„æ—¶å€™éƒ½ä¼šè¦æ±‚å¯åŠ¨Androidè®¾å¤‡ï¼Œç„¶åæŠ¥ä¸‹é¢çš„é”™è¯¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Running tests</span><br><span class="line">Test running startedTest running failed: </span><br><span class="line">Instrumentation run failed due to &apos;java.lang.RuntimeException&apos;</span><br><span class="line">Empty test suite.</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªé—®é¢˜å›°æ‰°äº†æˆ‘å¾ˆä¹…ã€‚å› æ­¤è¯»è€…ä¸€å®šè¦æ³¨æ„ã€‚</p>
<h3 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h3><p>æœ€åæ˜¯è¿è¡Œï¼Œæˆ‘ä»¬åªéœ€è¦å³å‡»ä½ éœ€è¦è¿è¡Œçš„æµ‹è¯•Classï¼Œé€‰æ‹©â€Run FirstTestâ€å³å¯è¿è¡Œï¼Œç„¶ååœ¨å›¾ä¸­7çš„éƒ¨åˆ†å¯ä»¥çœ‹åˆ°æµ‹è¯•æ‰§è¡Œçš„ç»“æœã€‚6åœˆå‡ºçš„æŒ‰é’®å¯ä»¥ç‚¹å‡»ï¼ŒæŸ¥çœ‹æ‰§è¡Œçš„å…¨éƒ¨caseæˆ–è€…æ‰§è¡Œå¤±è´¥çš„caseã€‚</p>
<p>æµ‹è¯•æŠ¥å‘Šåœ¨<code>app/build/reports/tests/debug/</code>ä¸‹é¢ã€‚</p>
<h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>åœ¨å†™æœ¬åœ°å•æµ‹çš„æ—¶å€™ï¼Œä¼šé‡åˆ°<code>android.jar</code>æŸä¸ªæ–¹æ³•æ²¡æœ‰è¢«Mockçš„æƒ…å†µï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å¦‚ä¸‹é…ç½®:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  // ...</span><br><span class="line">  testOptions &#123; </span><br><span class="line">    unitTests.returnDefaultValues = true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®©Gradleç³»ç»Ÿä¸ºè¯¥æ–¹æ³•è¿”å›é»˜è®¤å€¼ã€‚</p>
<h2 id="Instrumentationâ€”â€”Androidåº•å±‚æµ‹è¯•API"><a href="#Instrumentationâ€”â€”Androidåº•å±‚æµ‹è¯•API" class="headerlink" title="Instrumentationâ€”â€”Androidåº•å±‚æµ‹è¯•API"></a>Instrumentationâ€”â€”Androidåº•å±‚æµ‹è¯•API</h2><h3 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>Androidæµ‹è¯•APIæä¾›äº†ä¸€äº›æ·±å…¥Androidç»„ä»¶å’Œåº”ç”¨æœ¬èº«å£°æ˜å‘¨æœŸçš„é’©å­å‡½æ•°ã€‚è¿™äº›é’©å­å‡½æ•°ç§°ä¸ºInstrumentation APIâ€”â€”å®ƒä»¬å…è®¸ä½ æ§åˆ¶ç”Ÿå‘½å‘¨æœŸå’Œç”¨æˆ·äº¤äº’äº‹ä»¶ã€‚</p>
<p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼ŒAndroidåº”ç”¨åªèƒ½å¯¹çœŸæ­£çš„ç”Ÿå‘½å‘¨æœŸå’Œç”¨æˆ·äº¤äº’äº‹ä»¶åšå‡ºååº”ï¼Œæ¯”å¦‚ï¼šå¦‚æœAndroidåˆ›å»ºäº†ä¸€ä¸ªActivityï¼Œé‚£ä¹ˆonCreate()æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œæˆ–è€…ç”¨æˆ·ç‚¹å‡»äº†ä¸€ä¸ªæŒ‰é’®ï¼Œä¸€ä¸ªæŒ‰é”®ï¼Œé‚£ä¹ˆç›¸åº”çš„ç›‘å¬æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚ä½†æ˜¯é€šè¿‡Instrumentationï¼Œä½ å¯ä»¥åœ¨æµ‹è¯•ä»£ç ä¸­æ§åˆ¶è¿™äº›äº‹ä»¶ã€‚</p>
<p>åªæœ‰åŸºäºInstrumentationçš„æµ‹è¯•ä»£ç æ‰èƒ½åœ¨æµ‹è¯•ç¯å¢ƒä¸‹å‘ä½ çš„åº”ç”¨å‘é€äº‹ä»¶ã€‚ä¸¾ä¸ªæ —å­ï¼šä½ å¯ä»¥åœ¨æµ‹è¯•ä¸­è°ƒç”¨getActivity()æ–¹æ³•æ¥å”¤èµ·ä¸€ä¸ªActivityå¹¶è·å¾—ä¸€ä¸ªActivityçš„å®ä¾‹ï¼Œç„¶åä½ å¯ä»¥è°ƒç”¨finish()æ–¹æ³•ç»“æŸå®ƒï¼Œç„¶åå†è°ƒç”¨getActivity()ï¼Œè¿™æ ·ä½ å°±å¯ä»¥æµ‹è¯•ä¸€ä¸ªActivityèƒ½å¦æ­£ç¡®æ¢å¤çŠ¶æ€ã€‚</p>
<h3 id="Androidç³»ç»Ÿå¦‚ä½•æ‰§è¡Œæµ‹è¯•"><a href="#Androidç³»ç»Ÿå¦‚ä½•æ‰§è¡Œæµ‹è¯•" class="headerlink" title="Androidç³»ç»Ÿå¦‚ä½•æ‰§è¡Œæµ‹è¯•"></a>Androidç³»ç»Ÿå¦‚ä½•æ‰§è¡Œæµ‹è¯•</h3><p>InstrumentationTestRunneræ˜¯Androidå•å…ƒæµ‹è¯•çš„åŸºç¡€æ‰§è¡Œå™¨ï¼ˆRunnerï¼Œè¿™ä¸ªæ¦‚å¿µæ¥è‡ªJUnitï¼Œå‰é¢æ¨èçš„æ–‡ç« ä¸­æœ‰æåŠï¼‰ï¼Œè¿™ä¸ªæµ‹è¯•æ‰§è¡Œå™¨ä¼šåŠ è½½æ‰€æœ‰çš„æµ‹è¯•æ–¹æ³•ï¼Œé€šè¿‡Instrumentation APIæ¥å’ŒAndroidç³»ç»Ÿäº¤äº’ã€‚</p>
<p>å¦‚æœä½ ä¸ºAndroidåº”ç”¨å¯åŠ¨äº†ä¸€ä¸ªæµ‹è¯•ï¼ŒAndroidç³»ç»Ÿä¼šç«‹åˆ»ç»ˆæ­¢è¢«æµ‹è¯•åº”ç”¨çš„è¿›ç¨‹ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚å®ƒä¸ä¼šå¯åŠ¨åº”ç”¨ï¼Œè¿™æ˜¯æµ‹è¯•æ–¹æ³•çš„èŒè´£â€”â€”æµ‹è¯•æ–¹æ³•æ§åˆ¶åº”ç”¨ç»„ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>æµ‹è¯•æ‰§è¡Œå™¨åœ¨åˆå§‹åŒ–ç•Œé¢çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šè°ƒç”¨Applicationå’ŒActivityçš„onCreate()æ–¹æ³•ã€‚ï¼ˆå¯ä»¥è®¤ä¸ºInstrumentation APIæä¾›äº†ä¸€ä¸ªåŠŸèƒ½è®©æµ‹è¯•ä»£ç æ‰®æ¼”ç³»ç»Ÿçš„è§’è‰²ï¼‰ã€‚</p>
<h3 id="Instrumentationæ¡†æ¶çš„ä½¿ç”¨"><a href="#Instrumentationæ¡†æ¶çš„ä½¿ç”¨" class="headerlink" title="Instrumentationæ¡†æ¶çš„ä½¿ç”¨"></a>Instrumentationæ¡†æ¶çš„ä½¿ç”¨</h3><p>æœ‰äº†è¿è¡Œåœ¨JVMä¸Šçš„Androidå•å…ƒæµ‹è¯•å’Œç±»ä¼¼Espressoè¿™æ ·æµè¡Œçš„UIæµ‹è¯•æ¡†æ¶ï¼Œå¼€å‘è€…å¾ˆå°‘éœ€è¦ç›´æ¥è°ƒç”¨Instrumentation APIã€‚</p>
<h2 id="Instrumented-unit-testing"><a href="#Instrumented-unit-testing" class="headerlink" title="Instrumented unit testing"></a>Instrumented unit testing</h2><h3 id="åœ¨Androidä¸Šä½¿ç”¨Instrumented-unit-testing"><a href="#åœ¨Androidä¸Šä½¿ç”¨Instrumented-unit-testing" class="headerlink" title="åœ¨Androidä¸Šä½¿ç”¨Instrumented unit testing"></a>åœ¨Androidä¸Šä½¿ç”¨Instrumented unit testing</h3><p>Instrumented unit testingæ˜¯è¿è¡Œåœ¨AndroidçœŸå®è®¾å¤‡æˆ–è€…æ¨¡æ‹Ÿå™¨ä¸Šçš„æµ‹è¯•ä»£ç ï¼Œè€Œä¸æ˜¯JVMä¸Šã€‚è¿™äº›æµ‹è¯•ä»£ç å¯ä»¥è·å–çœŸå®è®¾å¤‡çš„èµ„æºï¼Œä»¥ä¾¿äºæµ‹è¯•é‚£äº›ä¸èƒ½è¢«mockæ¡†æ¶ç®€å•mockå‡ºæ¥çš„åŠŸèƒ½æ¨¡å—ã€‚</p>
<p><a href="https://github.com/mockito/mockito" target="_blank" rel="noopener">Mockitoæ¡†æ¶</a>å¯ä»¥è¢«ç”¨æ¥æ¨¡æ‹Ÿéƒ¨åˆ†çš„Androidç³»ç»Ÿç¯å¢ƒï¼ˆè¯»è€…å¯ä»¥æŸ¥çœ‹å®ƒçš„release noteï¼Œ1.9.5ç‰ˆæœ¬å³æ”¯æŒè¿™ä¸ªåŠŸèƒ½ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯googleå®˜æ–¹æ¨èçš„mockå·¥å…·ã€‚</p>
<h3 id="Instrumentationæµ‹è¯•ä»£ç çš„ä½ç½®"><a href="#Instrumentationæµ‹è¯•ä»£ç çš„ä½ç½®" class="headerlink" title="Instrumentationæµ‹è¯•ä»£ç çš„ä½ç½®"></a>Instrumentationæµ‹è¯•ä»£ç çš„ä½ç½®</h3><p>å¦‚å‰é¢æ‰€è¿°ï¼ŒInstrumentationæµ‹è¯•ä»£ç åº”è¯¥æ”¾ç½®åœ¨app/src/androidTest/javaç›®å½•ä¸‹é¢ã€‚</p>
<h3 id="åœ¨Gradleä¸­é…ç½®ä¾èµ–"><a href="#åœ¨Gradleä¸­é…ç½®ä¾èµ–" class="headerlink" title="åœ¨Gradleä¸­é…ç½®ä¾èµ–"></a>åœ¨Gradleä¸­é…ç½®ä¾èµ–</h3><p>å’Œæœ¬åœ°å•å…ƒæµ‹è¯•ä¸€æ ·ï¼Œä½¿ç”¨Instrumentationæµ‹è¯•ä¹Ÿå¿…é¡»æ·»åŠ ä¸€äº›ä¾èµ–ï¼ŒåŒæ—¶è¿˜å¿…é¡»æ·»åŠ é»˜è®¤çš„Android Instrumentationæµ‹è¯•æ‰§è¡Œå™¨é…ç½®:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">defaultConfig &#123;</span><br><span class="line">       ..... more stuff</span><br><span class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// Unit testing dependencies</span></span><br><span class="line">    androidTestCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    <span class="comment">// Set this dependency if you want to use the Hamcrest matcher library</span></span><br><span class="line">    androidTestCompile <span class="string">'org.hamcrest:hamcrest-library:1.3'</span></span><br><span class="line">    <span class="comment">// more stuff, e.g., Mockito</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç›¸å…³çš„ç±»"><a href="#ç›¸å…³çš„ç±»" class="headerlink" title="ç›¸å…³çš„ç±»"></a>ç›¸å…³çš„ç±»</h3><p>å…ˆæ¥çœ‹Contextæµ‹è¯•ç±»çš„é‡è¦åŸºç¡€ç±»â€”â€”AndroidTestCaseã€‚è¿™ä¸ªç±»æœ€ç»ˆçš„åŠŸèƒ½å°±æ˜¯æä¾›äº†getContext()åŠŸèƒ½ï¼Œåœ¨å®é™…æµ‹è¯•ä¸­ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯å¯ä»¥å½“åšæµ‹è¯•Appå¯¹è±¡çš„Contextä½¿ç”¨çš„ã€‚è¿™ä¸ªç±»çš„å­ç±»å¦‚ä¸‹:</p>
<ol>
<li>ApplicationTestCase;</li>
<li>ProviderTestCase;</li>
<li>ServiceTestCase</li>
<li>CustomTabsIntentCase;</li>
<li>LoaderTestCase;</li>
</ol>
<p>å¾ˆå®¹æ˜“å‘ç°ï¼Œå››å¤§ç»„ä»¶æœ‰ä¸¤ä¸ªç»„ä»¶åœ¨è¿™é‡Œæœ‰å¯¹åº”çš„æµ‹è¯•Caseç±»ï¼Œé‚£ä¹ˆæœ€é‡è¦çš„Activityå‘¢ï¼Ÿå®é™…ä¸Šç¡®å®æœ‰ActivityTestCaseç±»ï¼Œä½†è¿™ä¸ªç±»ä¸å±äºAndroidTestCaseç»§æ‰¿æ ‘ï¼Œå®ƒçš„çˆ¶ç±»æ˜¯InstrumentationTestCaseï¼Œç›´æ¥å­ç±»æ˜¯:</p>
<ol>
<li>ActivityInstrumentationTestCase</li>
<li>ActivityInstrumentationTestCase2</li>
<li>ActivityUnitTestCase</li>
</ol>
<p>å…¶ä¸­ç¬¬ä¸€ä¸ªç±»å·²ç»è¢«åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨çš„éƒ½æ˜¯ActivityInstrumentationTestCase2è¿™ä¸ªç±»ã€‚åé¢ä¸¤ä¸ªç±»å°±æ˜¯<a href="http://developer.android.com/intl/zh-cn/training/activity-testing/preparing-activity-testing.html" target="_blank" rel="noopener">å®˜ç½‘æ•™ç¨‹</a>çš„è®²è¿°é‡ç‚¹ã€‚</p>
<p>ä»¥ä¸Šæ‰€æœ‰çš„ç±»éƒ½æ˜¯junit.framework.TestCaseçš„å­ç±»ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/å•æµ‹ç±»ç»§æ‰¿å…³ç³».png" alt="Androidå•å…ƒæµ‹è¯•é…ç½®"></p>
<h4 id="ActivityUnitTestCaseå’ŒActivityInstrumentationTestCase2çš„åŒºåˆ«"><a href="#ActivityUnitTestCaseå’ŒActivityInstrumentationTestCase2çš„åŒºåˆ«" class="headerlink" title="ActivityUnitTestCaseå’ŒActivityInstrumentationTestCase2çš„åŒºåˆ«"></a>ActivityUnitTestCaseå’ŒActivityInstrumentationTestCase2çš„åŒºåˆ«</h4><p>ä¸¤è€…éƒ½èƒ½è¿›è¡Œç®€å•çš„UIæµ‹è¯•ï¼Œæ¯”å¦‚UIå…ƒç´ çš„å¸ƒå±€ã€æ˜¾ç¤ºå†…å®¹å’Œç‚¹å‡»åŠ¨ä½œï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MediumTest</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClickMeButton_clickButtonAndExpectInfoText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String expectedInfoText = mClickFunActivity.getString(R.string.info_text);</span><br><span class="line">    TouchUtils.clickView(<span class="keyword">this</span>, mClickMeButton);</span><br><span class="line">    assertTrue(View.VISIBLE == mInfoTextView.getVisibility());</span><br><span class="line">    assertEquals(expectedInfoText, mInfoTextView.getText());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä¸¤è€…çš„ä¾§é‡ç‚¹ä¸ä¸€æ ·ã€‚</p>
<p>ActivityUnitTestCaseåˆ›å»ºçš„Activityä¼šå°½é‡å°‘çš„å’Œç³»ç»Ÿæœ‰è”ç³»ï¼Œæ‰€æœ‰çš„ä¾èµ–éƒ½å¯ä»¥é€šè¿‡Mockæˆ–è€…åˆ«çš„æ–¹å¼æ³¨å…¥è¿›å»ï¼Œä½ çš„æµ‹è¯•å¯¹è±¡Activityä¼šåœ¨çœŸå®çš„ç³»ç»Ÿä¸Šè¿è¡Œï¼Œå¹¶ä¸”ä¸ä¼šå’Œåˆ«çš„Activityäº§ç”Ÿäº¤äº’ã€‚ä»¥ä¸‹æ–¹æ³•éƒ½ä¸åº”è¯¥è¢«è°ƒç”¨ï¼Œå¤§éƒ¨åˆ†éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸:</p>
<ol>
<li>createPendingResult(int, Intent, int)</li>
<li>startActivityIfNeeded(Intent, int)</li>
<li>startActivityFromChild(Activity, Intent, int)</li>
<li>startNextMatchingActivity(Intent)</li>
<li>getCallingActivity()</li>
<li>getCallingPackage()</li>
<li>createPendingResult(int, Intent, int)</li>
<li>getTaskId()</li>
<li>isTaskRoot()</li>
<li>moveTaskToBack(boolean)</li>
</ol>
<p>è¿™äº›æ–¹æ³•éƒ½æ˜¯å’Œç¯å¢ƒè¿›è¡Œäº¤äº’çš„ï¼Œéœ€è¦å®Œæ•´çš„ä¸Šä¸‹æ–‡ã€‚è€Œ</p>
<ol>
<li>startActivity</li>
<li>startActivityForResult</li>
</ol>
<p>è¿™ä¸¤ä¸ªè°ƒç”¨æ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œå¯ä»¥ä½¿ç”¨getStartedActivityIntent()å’ŒgetStartedActivityRequest()æ¥è·å–è°ƒç”¨å‚æ•°ã€‚</p>
<ol>
<li>finish</li>
<li>finishActivity</li>
<li>finishFromChild</li>
</ol>
<p>è¿™äº›è°ƒç”¨ä¹Ÿä¸ä¼šæœ‰ä»»ä½•çš„æ•ˆæœï¼ŒåŒæ ·æœ‰æ–¹æ³•isFinishCalled()å’ŒgetFinishedActivityRequest()æ¥è·å–è°ƒç”¨å‚æ•°ã€‚</p>
<p>é€šè¿‡ä»¥ä¸Šæ–¹å¼ï¼Œä¸€ä¸ªActivityUnitTestCaseå¯ä»¥æµ‹è¯•ä¸€äº›å’Œå…¶ä½™ç»„ä»¶çš„â€œMockäº¤äº’â€ã€‚</p>
<p>ä½†å¦‚æœä½ éœ€è¦è¿›è¡ŒåŠŸèƒ½æµ‹è¯•ï¼Œåˆ™å»ºè®®ä½¿ç”¨ActivityInstrumentationTestCase2ã€‚ActivityInstrumentationTestCase2ä¹Ÿæ˜¯å»ºç«‹åœ¨çœŸå®çš„ç³»ç»ŸåŸºç¡€ä¸Šçš„ï¼Œè°ƒç”¨çš„æ˜¯InstrumentationTestCase.launchActivity()æ–¹æ³•ï¼Œä½ å¯ä»¥ç›´æ¥æ“çºµActivityã€‚å•å…ƒæµ‹è¯•ä¸€èˆ¬ä¸å¤ªé€‚åˆç”¨æ¥æµ‹è¯•å¤æ‚çš„UIäº¤äº’åŠ¨ä½œï¼Œè€ŒActivityInstrumentationTestCase2åˆ™éå¸¸é€‚åˆï¼Œæ¯”å¦‚è°ƒç”¨é”®ç›˜å‘EditTextä¸­è¾“å…¥æ–‡å­—ï¼ŒçœŸå®çš„å‘èµ·ä¸€ä¸ªActivityå¹¶æ£€æµ‹æ•°æ®çš„ä¼ è¾“ã€‚å…·ä½“å¯ä»¥è§å®˜æ–¹æ¡ˆä¾‹ï¼š<a href="http://developer.android.com/intl/zh-cn/training/activity-testing/activity-functional-testing.html" target="_blank" rel="noopener">Creating Functional Tests</a>ã€‚å¤§åé¼é¼çš„robotiumå°±æ˜¯åŸºäºè¿™ä¸ªç±»æ¥å®ç°çš„ã€‚</p>
<h4 id="å·¥å…·ç±»"><a href="#å·¥å…·ç±»" class="headerlink" title="å·¥å…·ç±»"></a>å·¥å…·ç±»</h4><ol>
<li>MoreAssertsç±»åŒ…å«æ›´å¤šå¼ºå¤§çš„æ–­è¨€æ–¹æ³•ï¼Œå¦‚assertContainsRegex(String, String)ï¼Œå¯ä»¥ä½œæ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…ã€‚</li>
<li>ViewAssertsç±»åŒ…å«å…³äºAndroid Viewçš„æœ‰ç”¨æ–­è¨€æ–¹æ³•ï¼Œå¦‚assertHasScreenCoordinates(View, View, int, int)ï¼Œå¯ä»¥æµ‹è¯•Viewåœ¨å¯è§†åŒºåŸŸçš„ç‰¹å®šXã€Yä½ç½®ã€‚è¿™äº›Assertç®€åŒ–äº†UIä¸­å‡ ä½•å›¾å½¢å’Œå¯¹é½æ–¹å¼çš„æµ‹è¯•ã€‚</li>
</ol>
<h3 id="è¿è¡ŒInstrumentationæµ‹è¯•"><a href="#è¿è¡ŒInstrumentationæµ‹è¯•" class="headerlink" title="è¿è¡ŒInstrumentationæµ‹è¯•"></a>è¿è¡ŒInstrumentationæµ‹è¯•</h3><p>æ‰§è¡Œå‘½ä»¤ <strong>gradlew build connectedCheck</strong>  å°±å¯ä»¥äº†ã€‚</p>
<p>é™¤äº†å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯ç›´æ¥ä»Android Studioæ‰§è¡Œã€‚å›åˆ°æœ€ä¸Šé¢é‚£å¼ å›¾ï¼Œåœ¨4éƒ¨åˆ†ï¼Œå³Test Artifacté‡Œé¢ï¼Œè¿˜æœ‰ä¸€ä¸ªé€‰æ‹©æ˜¯â€Android Instrumentation Testsâ€ï¼Œåˆ‡æ¢åˆ°è¿™ä¸ªæ¨¡å¼ï¼Œç„¶åé€‰ä¸­éœ€è¦æ‰§è¡Œçš„ç±»ï¼Œé€‰æ‹©Runå³å¯ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è®©è¯»è€…åˆæ­¥äº†è§£Androidå•å…ƒæµ‹è¯•çš„åˆ†ç±»ä»¥åŠåŸºæœ¬çš„æµ‹è¯•çŸ¥è¯†ã€‚</p>
<p>ä»å®é™…ä½¿ç”¨æ•ˆæœæ¥çœ‹ï¼Œæœ¬åœ°æ™®é€šå•å…ƒæµ‹è¯•å’ŒInstrumentationå•å…ƒæµ‹è¯•äº’ç›¸è¡¥è¶³ï¼ŒåŸºæœ¬æ»¡è¶³äº†ä¸å››å¤§ç»„ä»¶æ— å…³çš„æµ‹è¯•ï¼Œä½†æ˜¯ä»ç„¶æœ‰å¾ˆå¤šçš„æƒ…å†µä¸èƒ½Cover:</p>
<ol>
<li>æœ¬åœ°æ™®é€šå•å…ƒæµ‹è¯•åªèƒ½Coverä¸å¹³å°æ— å…³çš„ä»£ç ï¼›</li>
<li>Instrumentationæµ‹è¯•è™½ç„¶æä¾›äº†Contextï¼Œä½†æ˜¯æµ‹è¯•ç»“æœå¾ˆå¤šä¾èµ–äºå®é™…çš„è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”æ‰§è¡Œç»“æœæ˜¯åæ˜ åœ¨UIä¸Šçš„ï¼Œå› æ­¤æ•ˆæœæœ‰é™ï¼›</li>
</ol>
<p>ä¸¾å‡ ä¸ªğŸŒ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸å®é™…ç¼–è¯‘ç¯å¢ƒç›¸å…³</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSdkVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Build.VERSION.class.getField(<span class="string">"SDK_INT"</span>).getInt(<span class="keyword">null</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸Appæœ¬èº«ç›¸å…³</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppName</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> getAppName(context, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸è®¾å¤‡ç›¸å…³</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasFeature</span><span class="params">(Context context, String feature)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> context.getPackageManager().hasSystemFeature(feature);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»“æœåæ˜ åœ¨UIä¸Š</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hideSoftKeyboard</span><span class="params">(@NonNull View view)</span> </span>&#123;</span><br><span class="line">	InputMethodManager imm = (InputMethodManager) view.getContext().getSystemService(Context.INPUT_METHOD_SERVICE);</span><br><span class="line">	imm.hideSoftInputFromWindow(view.getWindowToken(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè¿™äº›ä¾‹å­åœ¨å®¢æˆ·ç«¯å¾ˆéš¾å®ŒæˆUTï¼Œå› æ­¤å®ƒä»¬æ˜¯ä¸åº”è¯¥ä½¿ç”¨UTçš„ï¼Œå¿…è¦æ€§ä¹Ÿä¸æ˜¯å¾ˆå¤§ã€‚</p>
<p>ç»¼ä¸Šï¼ŒUTåœ¨å®¢æˆ·ç«¯çš„ä½¿ç”¨èŒƒå›´å’Œæ•ˆæœæ˜¯å¾ˆæœ‰é™çš„ã€‚å®¢æˆ·ç«¯å¼€å‘äººå‘˜åº”å½“ç†ŸçŸ¥è¿™å‡ ç±»æµ‹è¯•æ‰‹æ®µï¼ˆå¦å¤–ä¸€ç§æ˜¯UIè‡ªåŠ¨åŒ–æµ‹è¯•ï¼‰ï¼Œåœ¨å¿…è¦çš„æ—¶å€™æ ¹æ®éœ€æ±‚ï¼Œæ¯”å¦‚å¿…ä¸å¯å…çš„å¤æ‚é€»è¾‘å¤„ï¼Œä½¿ç”¨ç›¸åº”çš„æµ‹è¯•ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¿è¯å®¢æˆ·ç«¯çš„ç¨³å®šæ€§ã€‚</p>
<p>åæœŸå¾…è¡¥å……çš„ç›¸å…³çŸ¥è¯†ï¼š</p>
<ol>
<li>Mockitoçš„ä½¿ç”¨ï¼›</li>
<li>Android Testing Support Libraryæä¾›çš„ä¸€äº›æ–°åŠŸèƒ½ï¼›</li>
<li>Androidä¸Šå¯¹Activityã€Serviceã€ContentProviderã€Applicationç­‰ç»„ä»¶çš„æµ‹è¯•æ”¯æŒï¼›</li>
<li>UIè‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ï¼›</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java æ³¨è§£]]></title>
      <url>http://www.timebridge.space/2015/11/15/Java-annotation/</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ³¨è§£çš„åŸºæœ¬çŸ¥è¯†æ¦‚å¿µç•¥å»ä¸è¡¨ï¼Œè¯»è€…åº”è¯¥çŸ¥é“ï¼š</p>
<ol>
<li>å››ä¸ªå…ƒæ³¨è§£ï¼š @Retention @Target @Document @Inheritedï¼›</li>
<li>å¯¹æœ€å¸¸ç”¨çš„æ³¨è§£è§£ææ–¹å¼æœ‰æ‰€äº†è§£ï¼›</li>
</ol>
<p>Retentionè¡¨ç¤ºæ³¨è§£ç•™å­˜çš„é˜¶æ®µï¼Œæœ‰ä¸‰ä¸ªå€¼ï¼šSOURCEï¼ŒCLASSï¼ŒRUNTIMEã€‚æœ€å¸¸è§çš„æ˜¯RUNTIMEï¼Œè¿™ç±»æ³¨è§£å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼è¿›è¡Œè§£æã€‚ä½†æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è¯´çš„æ˜¯SOURCEå’ŒCLASSæ³¨è§£çš„è§£æã€‚<a id="more"></a></p>
<h2 id="APT"><a href="#APT" class="headerlink" title="APT"></a>APT</h2><p>APTï¼Œå³annotation processing toolï¼Œæ˜¯Sunå…¬å¸ä¸“é—¨å¼€å‘ç”¨æ¥å¤„ç†æ³¨è§£çš„ã€‚å’Œjavacä¸€æ ·ï¼Œaptç›´æ¥å¯¹Javaæºæ–‡ä»¶è¿›è¡Œå¤„ç†ã€‚aptå·¥ä½œçš„æ—¶å€™éœ€è¦ä½¿ç”¨ä¸€ä¸ªAnnotationProcessorFactoryæ¥å¤„ç†å®ƒæ‰€é‡åˆ°çš„Annotationï¼Œå³APTéœ€è¦ä¸ºæ¯ä¸€ä¸ªå®ƒæ‰€é‡åˆ°çš„æ³¨è§£æ‰¾åˆ°å¯¹åº”çš„æ³¨è§£å¤„ç†å™¨ã€‚</p>
<p>æ³¨æ„ï¼Œåœ¨ä½¿ç”¨aptå¤„ç†æ³¨è§£çš„æ—¶å€™ï¼Œä¸èƒ½ä½¿ç”¨åå°„ï¼Œå› ä¸ºä½ æ˜¯åœ¨å¤„ç†æºä»£ç è€Œä¸æ˜¯ç¼–è¯‘ä¹‹åçš„ç±»ã€‚Mirrorç±»è¡¥è¶³äº†è¿™ä¸€ç‚¹ã€‚</p>
<p>åœ¨ã€ŠThinking In Javaã€‹ä¸­ï¼Œä½œè€…åœ¨â€œAnnotationsâ€è¿™ä¸€ç« æœ€åå±•ç¤ºäº†ä¸€ä¸ªExtractInterfaceç¼–è¯‘æ—¶æ³¨è§£æ¡ˆä¾‹ï¼Œæ¡ˆä¾‹å¾ˆç®€å•è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»å¹¶Codingï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š</p>
<ol>
<li>å®šä¹‰æ³¨è§£ï¼›</li>
<li>å®šä¹‰ä¸€ä¸ªç±»ï¼Œä½¿ç”¨æ³¨è§£ï¼›</li>
<li>å®ç°AnnotationProcessoræ¥å£ï¼Œè¯¥æ¥å£æœ‰ä¸€ä¸ªprocessæ–¹æ³•ï¼Œå¤„ç†æ³¨è§£çš„è¿‡ç¨‹éƒ½åœ¨è¿™é‡Œï¼ˆæœ€é‡è¦çš„å°±æ˜¯å†™.javaæ–‡ä»¶åˆ›å»ºæ–°ç±»ï¼‰</li>
<li>æœ€é‡è¦çš„æ˜¯å®ç°AnnotationProcessorFactoryæ¥å£ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸­ä¼šå»ºç«‹æ³¨è§£å’Œæ³¨è§£å¤„ç†å™¨çš„å¯¹åº”å…³ç³»ã€‚</li>
<li>æ‰§è¡Œaptå‘½ä»¤ï¼Œå‘Šè¯‰aptä½¿ç”¨å“ªä¸€ä¸ªFactoryï¼Œè§£æå“ªä¸€ä¸ªæºç çš„æ³¨è§£</li>
</ol>
<p>ä¸‹é¢ç»™ä¸€ä¸‹AnnotationProcessorFactoryçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterfaceExtractorProcessorFactory</span> <span class="keyword">implements</span> <span class="title">AnnotationProcessorFactory</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> AnnotationProcessor <span class="title">getProcessorFor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			Set&lt;AnnotationTypeDeclaration&gt; atds,</span></span></span><br><span class="line"><span class="function"><span class="params">			AnnotationProcessorEnvironment env)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> InterfaceExtractorProcessor(env);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">supportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.singleton(<span class="string">"annotations.ExtractInterface"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">supportedOptions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤å¤§è‡´å¦‚ä¸‹ï¼š<br>apt -factory annotations.InterfaceExtractorProcessorFactory Multiplier.java -s ../annotations</p>
<p>PSï¼šåœ¨æˆ‘Macä¸Šæ­»æ´»è¿è¡Œä¸å‡ºæ¥ï¼ŒæŠ¥æ‰¾ä¸åˆ°InterfaceExtractorProcessorFactoryé”™è¯¯ï¼Œåœ¨ç½‘ä¸Šæœäº†ä¸€åœˆéƒ½æ²¡æœ‰æ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚ä¸è¿‡çœ‹å¾ˆå¤šçš„blogï¼Œæœ‰å¾ˆå¤šã€ŠThinking In Javaã€‹è¯»è€…éƒ½åº”è¯¥è¿è¡ŒæˆåŠŸã€‚</p>
<h2 id="ç¼–è¯‘æ—¶æ³¨è§£æ¡†æ¶"><a href="#ç¼–è¯‘æ—¶æ³¨è§£æ¡†æ¶" class="headerlink" title="ç¼–è¯‘æ—¶æ³¨è§£æ¡†æ¶"></a>ç¼–è¯‘æ—¶æ³¨è§£æ¡†æ¶</h2><p>æœ‰å¾ˆå¤šçš„æ¡†æ¶éƒ½æ˜¯ç¼–è¯‘æ—¶æ³¨è§£çš„ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å»æ‰§è¡Œaptå‘½ä»¤ï¼Œé‚£ä¹ˆè¿™äº›æ¡†æ¶æ˜¯æ€ä¹ˆå®ç°è¿ä½œçš„å‘¢ï¼Ÿ</p>
<p><a href="http://www.cnblogs.com/avenwu/p/4173899.html" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ¡ˆä¾‹ï¼Œä½œè€…ç»™å‡ºäº†æºç ï¼Œè¯»è€…å¯ä»¥ä¸‹è½½è¿è¡Œã€‚æˆ‘åœ¨Androidé¡¹ç›®ä¸­è¿è¡Œè¿™ä¸ªæ¡ˆä¾‹æ˜¯æˆåŠŸçš„ã€‚ï¼ˆPSï¼š<a href="http://blog.csdn.net/lmj623565791/article/details/43452969" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>æ˜¯ä¸€ä¸ªè¡¥å……ï¼‰ã€‚</p>
<p>é‡ç‚¹åœ¨äºç›®å½•ç»“æ„ä¸­çš„resourcesç›®å½•ã€‚</p>
<p>æˆ‘å°†æ¡ˆä¾‹ä¸­çš„æ³¨è§£å¤„ç†ç±»æ”¹é€ å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;<span class="string">"com.avenwu.annotation.PrintMe"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">"Factory"</span>;</span><br><span class="line">    <span class="keyword">private</span> String qualifiedClassName = <span class="string">"com.dianping.littleshell"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">        Messager messager = processingEnv.getMessager();</span><br><span class="line">        <span class="keyword">for</span> (TypeElement te : annotations) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Element e : env.getElementsAnnotatedWith(te)) &#123;</span><br><span class="line">                messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">"Printing: "</span> + e.toString());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    JavaFileObject f = processingEnv.getFiler().</span><br><span class="line">                            createSourceFile(qualifiedClassName + <span class="string">".LittleShell"</span> + SUFFIX);</span><br><span class="line">                    processingEnv.getMessager().printMessage(Diagnostic.Kind.NOTE,</span><br><span class="line">                            <span class="string">"Creating "</span> + f.toUri());</span><br><span class="line">                    Writer w = f.openWriter();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        PrintWriter pw = <span class="keyword">new</span> PrintWriter(w);</span><br><span class="line">                        pw.println(<span class="string">"package "</span> + qualifiedClassName + <span class="string">";"</span>);</span><br><span class="line">                        pw.println(<span class="string">"public class LittleShellFactory&#123;"</span>);</span><br><span class="line">                        pw.println(<span class="string">"    public void print() &#123;"</span>);</span><br><span class="line">                        pw.println(<span class="string">"        System.out.println(\"Hello boss!\");"</span>);</span><br><span class="line">                        pw.println(<span class="string">"    &#125;"</span>);</span><br><span class="line">                        pw.println(<span class="string">"&#125;"</span>);</span><br><span class="line">                        pw.flush();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        w.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                    processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR,</span><br><span class="line">                            x.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰“åŒ…æ”¾å…¥Androidé¡¹ç›®ä¸­è¿è¡Œï¼Œç¼–è¯‘ä¹‹åå‘ç°ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/æ³¨è§£ç”Ÿæˆç±».png" alt="æ³¨è§£å¤„ç†"></p>
<p>åœ¨ç¼–è¯‘ä¹‹åçš„ç¡®ç”Ÿæˆäº†ä¸€ä¸ª.javaç±»ï¼Œå¹¶ä¸”å·²ç»ç¼–è¯‘ã€‚é‚£ä¹ˆè¿™ä¸ªç±»å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿæˆ–è€…èƒ½å¦åœ¨å®é™…è¿è¡Œç¯å¢ƒä¸‹è·å–å‘¢ï¼Ÿæˆ‘å°è¯•äº†ä¸€æŠŠï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.footprint.littleshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.avenwu.annotation.PrintMe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Handler().postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, test(), Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PrintMe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = Class.forName(<span class="string">"com.dianping.littleshell.LittleShellFactory"</span>);</span><br><span class="line">            <span class="keyword">if</span>(cls != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Method method = cls.getMethod(<span class="string">"print"</span>);</span><br><span class="line">                method.invoke(cls.newInstance());</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"AAAAAAAA"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"BBBBBBBBB"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"CCCCCCCCC"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"DDDDDDDDD"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"EEEEEEEEE"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"FFFFFFFFF"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"GGGGGGGGG"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ï¼ˆé¢ï¼Œæ²¡æœ‰androidæœºå™¨ï¼ŒGenymotionåäº†ï¼Œç¯å¢ƒçœŸæ˜¯è‰°è¾›ï¼‰å£è¿°è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p>æ§åˆ¶å°çš„ç¡®æ‰“å°å‡ºäº†â€Hello boss!â€ï¼ŒToastæ˜¾ç¤ºçš„æ˜¯â€AAAAAAAAâ€ï¼Œå³é€šè¿‡åå°„å¯ä»¥è·å–è¯¥ç±»ï¼Œä¹Ÿå°±è¯æ˜äº†æ³¨è§£äº§ç”Ÿçš„ç±»æœ€ç»ˆè¢«æ‰“åŒ…åˆ°äº†apkä¸­ã€‚</p>
<p>è¯•éªŒä¸­è¿˜å‘ç°ï¼šåŒ…åæ˜¯ä»»æ„çš„ï¼Œå¦‚ä¸Šï¼Œä¸€å¼€å§‹æˆ‘ä½¿ç”¨çš„æ˜¯com.footprint.littltshellï¼Œåé¢æ”¹æˆcom.dianping.littleshellï¼Œä¸¤è€…éƒ½æ²¡æœ‰é—®é¢˜ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€åæ¨èä¸€ç¯‡çŒ›æ–‡:<a href="http://hannesdorfmann.com/annotation-processing/annotationprocessing101/" target="_blank" rel="noopener">ANNOTATION PROCESSING 101</a>ï¼Œä½œè€…å†™çš„éå¸¸è¯¦ç»†ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼Œè¯»è€…æœ‰å…´è¶£å¯ä»¥ç ”ç©¶ç¢ç£¨ä¸€ä¸‹ã€‚</p>
<blockquote>
<p>PSï¼šåšå®¢è®²è¿°äº†TypeMirrorsçš„ç”¨æ³•å’ŒJavaWriterå·¥å…·ï¼Œå¹¶ä¸”æåŠäº†Butter Knifeè¿™ä¸ªæ³¨è§£å¼€æºæ¡†æ¶ï¼Œé¡¹ç›®ä½¿ç”¨mavenç®¡ç†ï¼Œæ•´ä½“ç»“æ„éƒ½å¾ˆä¸é”™ï¼Œå€¼å¾—è¯»è€…å­¦ä¹ ã€‚</p>
</blockquote>
<p>ä¸è¿‡å»ºè®®å…ˆæŠŠä¸Šé¢çš„ç¤ºä¾‹æ¼”ç»ƒä¸€éã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android Appä»£ç ä¼˜åŒ–]]></title>
      <url>http://www.timebridge.space/2015/10/28/Android-App-code-optimization/</url>
      <content type="html"><![CDATA[<p>ä»‹ç»å‡ ä¸ªå¯ç”¨äºæé«˜Androidå¹³å°ä»£ç è´¨é‡çš„å·¥å…·ã€‚</p>
<h2 id="NO-1-StrictMode"><a href="#NO-1-StrictMode" class="headerlink" title="NO.1 StrictMode"></a>NO.1 StrictMode</h2><p><a href="http://developer.android.com/intl/zh-cn/reference/android/os/StrictMode.html" target="_blank" rel="noopener">å®˜ç½‘ä»‹ç»</a>åœ¨æ­¤ã€‚<br>æ¨èé˜…è¯»æ–‡ç« ï¼š<a href="http://android-performance.com/android/2014/04/24/android-strict-mode.html" target="_blank" rel="noopener">StrictMode è¯¦è§£</a> &amp; <a href="http://droidyue.com/blog/2015/09/26/android-tuning-tool-strictmode/" target="_blank" rel="noopener">Androidæ€§èƒ½è°ƒä¼˜åˆ©å™¨StrictMode</a></p>
<p><strong>StrictModeæœ‰ä¸¤å¤§ç±»ç­–ç•¥ï¼šç›‘æ§çº¿ç¨‹å’ŒVMã€‚</strong> çº¿ç¨‹æ–¹é¢ï¼Œä¸»è¦ç”¨äºæ£€æµ‹ä¸€äº›åœ¨ä¸»çº¿ç¨‹æ„å¤–è¿›è¡Œçš„è€—æ—¶ç½‘ç»œæ“ä½œå’Œç£ç›˜è¯»å†™æ“ä½œï¼ŒåŒæ—¶ä¹Ÿæä¾›æ–¹æ³•ç”¨äºæ£€æµ‹å¼€å‘è€…éœ€è¦ç›‘æ§çš„è€—æ—¶ä»£ç å—ã€‚VMæ–¹é¢ä¸»æ”»å†…å­˜æ³„éœ²ï¼šåŒ…æ‹¬Activityã€SQLiteç­‰ã€‚<a id="more"></a>ç¤ºä¾‹ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (DEVELOPER_MODE) &#123;</span><br><span class="line">		StrictMode.setThreadPolicy(<span class="keyword">new</span> StrictMode.ThreadPolicy.Builder()</span><br><span class="line">                        .detectAll()</span><br><span class="line">                        .penaltyLog()</span><br><span class="line">                        .build());</span><br><span class="line">		StrictMode.setVmPolicy(<span class="keyword">new</span> StrictMode.VmPolicy.Builder()</span><br><span class="line">                        .detectLeakedSqlLiteObjects()</span><br><span class="line">                        .detectLeakedClosableObjects()</span><br><span class="line">                        .penaltyLog()</span><br><span class="line">                        .penaltyDeath()</span><br><span class="line">                        .build());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ‡è®°æ¯”è¾ƒæ…¢çš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StrictMode.noteSlowCall(<span class="string">"slowCallInCustomThread"</span>);</span><br></pre></td></tr></table></figure>
<p>è¢«noteSlowCallæ ‡è®°çš„æ–¹æ³•ï¼Œå¦‚æœæ‰§è¡Œè¿‡æ…¢åˆ™ä¼šè§¦å‘StrictModeæŠ¥è­¦ï¼Œè¿™ä¸ªæ–¹æ³•åªæœ‰ç”¨åœ¨ä¸»çº¿ç¨‹è°ƒç”¨çš„æ–¹æ³•ä¸­æ—¶ï¼Œæ‰ä¼šæœ‰æ•ˆæœï¼ˆå®è·µè¯æ˜ï¼‰ã€‚</p>
<p>æœ‰æ—¶å€™æœ‰äº›ç‰¹æ®Šcaseå¯ä»¥ç»•è¿‡ï¼Œä¸éœ€è¦æ£€æµ‹ï¼Œæ¯”å¦‚ä¸»çº¿ç¨‹æ˜¯å¯ä»¥è¿›è¡Œä¸€äº›å¿«é€Ÿç®€çŸ­çš„ç£ç›˜è¯»å†™æ“ä½œçš„ï¼Œæ­¤æ—¶å¯ä»¥å¦‚ä¸‹Coding:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">StrictMode.ThreadPolicy old = StrictMode.getThreadPolicy();</span><br><span class="line">StrictMode.setThreadPolicy(<span class="keyword">new</span> StrictMode.ThreadPolicy.Builder(old)</span><br><span class="line">    .permitDiskWrites()</span><br><span class="line">    .build());</span><br><span class="line"><span class="comment">// æ–¹æ³•è°ƒç”¨</span></span><br><span class="line">doCorrectStuffThatWritesToDisk();</span><br><span class="line">StrictMode.setThreadPolicy(old);</span><br></pre></td></tr></table></figure>
<p>PSï¼šåœ¨å¼€å‘è€…é€‰é¡¹é‡Œé¢ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¯ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œå¦‚æœä¸»çº¿ç¨‹ä¸­æœ‰æ‰§è¡Œæ—¶é—´é•¿çš„æ“ä½œï¼Œå±å¹•åˆ™ä¼šé—ªçƒã€‚</p>
<h2 id="NO-2-Findbugs"><a href="#NO-2-Findbugs" class="headerlink" title="NO.2 Findbugs"></a>NO.2 Findbugs</h2><p><a href="http://findbugs.sourceforge.net/users.html" target="_blank" rel="noopener">å®˜ç½‘ä»‹ç»</a>åœ¨æ­¤ã€‚<br>å®ƒä¼šç»™ä»£ç åšä¸€ä¸ªå…¨é¢çš„æ‰«æï¼Œæ ¹æ®è§„åˆ™å»åˆ¤æ–­ä»£ç ä¸­çš„ä¸€äº›ä¸è§„èŒƒå’Œæ½œåœ¨é—®é¢˜ï¼Œæ¯”å¦‚å¤šçº¿ç¨‹é—®é¢˜ã€‚</p>
<p>å®ƒçš„ç»“æœå¯ä»¥ä»¥xmlå’Œhtmlå±•ç¤ºå‡ºæ¥ã€‚</p>
<h2 id="NO-3-PMD"><a href="#NO-3-PMD" class="headerlink" title="NO.3 PMD"></a>NO.3 PMD</h2><p><a href="http://pmd.sourceforge.net/pmd-5.1.1/" target="_blank" rel="noopener">å®˜ç½‘ä»‹ç»</a>åœ¨æ­¤ã€‚<br>å’ŒFindbugså·®ä¸å¤šï¼Œä¹Ÿæ˜¯ä»£ç é™æ€æ‰«æå·¥å…·ï¼Œå¹¶ä¸”ä¸¤è€…æœ‰ä¸€äº›é‡å¤çš„åŠŸèƒ½ã€‚PMDçš„å®šåˆ¶æ€§æ¯”è¾ƒå¼ºï¼Œè€Œä¸”æœ‰éƒ¨åˆ†åŠŸèƒ½æ˜¯ä¸“é—¨ç”¨äºæ£€æµ‹Androidé¡¹ç›®ï¼ˆè™½ç„¶å¾ˆå¼±ï¼‰ï¼š</p>
<ol>
<li>CallSuperFirst: åº”è¯¥åœ¨æ–¹æ³•ç¬¬ä¸€è¡Œè°ƒç”¨superæ–¹æ³•ï¼›</li>
<li>CallSuperLast: åº”è¯¥åœ¨æ–¹æ³•æœ€åä¸€è¡Œè°ƒç”¨superæ–¹æ³•ï¼›</li>
<li>DoNotHardCodeSDCard: ä¸åº”è¯¥ç¡¬ç¼–ç SDCardçš„è·¯å¾„ï¼›</li>
</ol>
<p>åŒæ ·ï¼Œå®ƒçš„ç»“æœä¹Ÿå¯ä»¥ä»¥xmlå’Œhtmlå±•ç¤ºã€‚</p>
<h2 id="NO-4-CheckStyle"><a href="#NO-4-CheckStyle" class="headerlink" title="NO.4 CheckStyle"></a>NO.4 CheckStyle</h2><p><a href="http://checkstyle.sourceforge.net/" target="_blank" rel="noopener">å®˜ç½‘ä»‹ç»</a>åœ¨æ­¤ã€‚<br>æ£€æŸ¥ä»£ç é£æ ¼çš„å·¥å…·ã€‚CheckStyleæ’ä»¶ä½¿ç”¨éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰å…·ä½“çš„ä»£ç é£æ ¼ï¼Œå¯ä»¥å‚è€ƒStackOverFlowä¸Šçš„<a href="http://stackoverflow.com/questions/9339804/where-can-i-find-checkstyle-config-for-android-coding-style" target="_blank" rel="noopener">è¿™ç¯‡å¸–å­</a>ï¼Œé‡Œé¢æœ‰è¯¸å¦‚<a href="https://github.com/square/picasso/blob/master/checkstyle.xml" target="_blank" rel="noopener">Picasso</a>ã€<a href="http://checkstyle.sourceforge.net/google_style.html" target="_blank" rel="noopener">Google</a>ç­‰å®šä¹‰çš„CheckStyleå¯ä»¥å‚è€ƒã€‚</p>
<p>Findbugså’ŒPMDåœ¨gradleä¸­çš„é…ç½®éƒ½éå¸¸æ–¹ä¾¿ï¼Œå¯ä»¥å‚è€ƒ<a href="https://gist.github.com/rciovati/8461832" target="_blank" rel="noopener">GitHubä¸Šè¿™ä¸ªé…ç½®</a>ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<a href="https://github.com/noveogroup/android-check" target="_blank" rel="noopener">è¿™ä¸ªæ’ä»¶</a>ï¼Œå®ƒé›†æˆäº†checkstyleã€findbugså’Œpmdä¸‰ä¸ªå·¥å…·ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android6.0æƒé™é—®é¢˜]]></title>
      <url>http://www.timebridge.space/2015/10/28/Android-6-quan-xian-wen-ti/</url>
      <content type="html"><![CDATA[<p>å»ºè®®é˜…è¯»<a href="http://inthecheesefactory.com/blog/things-you-need-to-know-about-android-m-permission-developer-edition/en" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>å’Œ<a href="http://developer.android.com/intl/zh-cn/training/permissions/requesting.html#perm-check" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼ŒAndroidè¦å‘iOSé æ‹¢ï¼Œå®è¡Œè¿è¡Œæ—¶æƒé™æ§åˆ¶å•¦ï¼åœ¨å¾ˆä¹…ä»¥å‰ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨AndoridManifest.xmlæ–‡ä»¶ä¸­å£°æ˜ç¨‹åºè¿è¡Œæ‰€éœ€è¦çš„æƒé™ï¼Œç”¨æˆ·åœ¨å®‰è£…çš„æ—¶å€™ä¸€æ¬¡åŒæ„å°±å¯ä»¥äº†ã€‚</p>
<p>åœ¨Android Mä¸­ï¼Œæƒé™è¢«åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç±»æ˜¯æ™®é€šæƒé™ï¼Œä¸ä¼šæ¶‰åŠåˆ°ç”¨æˆ·éšç§ï¼Œä¸€ç±»æ˜¯é«˜å±æƒé™ï¼Œåœ¨ä½¿ç”¨æƒé™çš„æ—¶å€™éœ€è¦ç”¨æˆ·åŒæ„ã€‚å½“ç„¶ç”¨æˆ·ä¹Ÿèƒ½åœ¨è®¾ç½®ä¸­å–æ¶ˆåº”ç”¨çš„æŸä¸ªæƒé™ã€‚<br><a id="more"></a><br>å› æ­¤Appéœ€è¦è€ƒè™‘åˆ°ç”¨æˆ·æ‹’ç»æƒé™çš„é€»è¾‘æƒ…å†µï¼Œéœ€è¦å¯¹æ­¤åšå‡ºé€‚é…ã€‚è‡³äºå¦‚ä½•é€‚é…ï¼Œå¦‚ä½•ç”³è¯·æƒé™ï¼Œä¸¤ç¯‡æ–‡ç« éƒ½è®²å¾—å¾ˆæ¸…æ¥šã€‚</p>
<p>è¿™é‡Œä¸»è¦è®²ä¸€ä¸‹å…¶ä¸­ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼šshouldShowRequestPermissionRationale()ã€‚æ ¹æ®å®˜ç½‘æè¿°ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å‘ç”¨æˆ·æä¾›ä¸€ä¸ªexplanationçš„ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¾æ®ä»€ä¹ˆè¿”å›å‘¢ï¼Ÿ</p>
<ol>
<li>å¦‚æœappä¹‹å‰è¦æ±‚è·å–æŸä¸ªæƒé™ï¼Œä½†æ˜¯è¢«æ‹’ç»äº†ï¼Œè¿™ä¸ªappä¼šè¿”å›trueï¼ˆè¿™ç§æƒ…å†µä¸‹ï¼ŒAndroidè®¤ä¸ºç”¨æˆ·ä¸ç†è§£åº”ç”¨è·å–è¯¥æƒé™çš„ç›®çš„ï¼Œå› æ­¤éœ€è¦è§£é‡Šï¼‰ï¼›</li>
<li>å¦‚æœç”¨æˆ·åœ¨æ‹’ç»çš„æ—¶å€™é€‰æ‹©äº†â€Donâ€™t ask againâ€ï¼ˆä¸å†è¯¢é—®ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šè¿”å›falseï¼ˆç”¨æˆ·ç†è§£ç›®çš„ï¼Œå¹¶ä¸”æ–­ç„¶æ‹’ç»ï¼‰ï¼›</li>
<li>å¦‚æœè®¾å¤‡æœ¬èº«å°±ç¦æ­¢è¿™ä¸ªåº”ç”¨è·å–è¯¥æƒé™ï¼Œè¿”å›falseï¼ˆæ— å…³ç”¨æˆ·ç†è§£ä¸å¦ï¼Œç”¨æˆ·æ— æ³•å¯¹æƒé™çš„è®¸å¯ä½œå‡ºä»»ä½•äº‹æƒ…ï¼‰ï¼›</li>
</ol>
<p>å› æ­¤å®é™…ä¸ŠAndroidçš„æ•´ä¸ªæƒé™æ§åˆ¶åˆ†ä¸¤ä¸ªé€»è¾‘ï¼š1ï¼‰åˆ¤æ–­æƒé™æ˜¯éƒ½è¢«æˆäºˆï¼›2ï¼‰åˆ¤æ–­è·å–æƒé™æ˜¯å¦éœ€è¦æä¾›explanationã€‚å› æ­¤å…¶å®˜ç½‘çš„è·å–æƒé™çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Here, thisActivity is the current activity</span></span><br><span class="line"><span class="keyword">if</span> (ContextCompat.checkSelfPermission(thisActivity,</span><br><span class="line">                Manifest.permission.READ_CONTACTS)</span><br><span class="line">        != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Should we show an explanation?</span></span><br><span class="line">    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(thisActivity,</span><br><span class="line">            Manifest.permission.READ_CONTACTS)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Show an expanation to the user *asynchronously* -- don't block</span></span><br><span class="line">        <span class="comment">// this thread waiting for the user's response! After the user</span></span><br><span class="line">        <span class="comment">// sees the explanation, try again to request the permission.</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// No explanation needed, we can request the permission.</span></span><br><span class="line"></span><br><span class="line">        ActivityCompat.requestPermissions(thisActivity,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;Manifest.permission.READ_CONTACTS&#125;,</span><br><span class="line">                MY_PERMISSIONS_REQUEST_READ_CONTACTS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// MY_PERMISSIONS_REQUEST_READ_CONTACTS is an</span></span><br><span class="line">        <span class="comment">// app-defined int constant. The callback method gets the</span></span><br><span class="line">        <span class="comment">// result of the request.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ³¨æ„ï¼šå†…éƒ¨çš„ifâ€¦elseâ€¦ä¸¤ä¸ªé€»è¾‘ç‚¹éƒ½åº”è¯¥å»è¯·æ±‚æƒé™ï¼</p>
<p>é‚£ä¹ˆå¦‚æœç”¨æˆ·åœ¨æ‹’ç»çš„æ—¶å€™é€‰äº†â€Donâ€™t ask againâ€ï¼ˆä¸å†è¯¢é—®ï¼‰ï¼Œå†è°ƒç”¨ActivityCompat.requestPermissionsè·å–æƒé™ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿä¼šä»¥PERMISSION_DENIEDè¿”å›å€¼ç›´æ¥è¿›å…¥å›è°ƒã€‚</p>
<p>ä»¥ä¸Šã€‚æ•´ä¸ªæƒé™æ§åˆ¶é€»è¾‘ä¸Šå¯ä»¥èµ°é€šã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ConcurrentModificationException]]></title>
      <url>http://www.timebridge.space/2015/10/26/Java-ConcurrentModificationException/</url>
      <content type="html"><![CDATA[<p>Javaä¸­çš„ ConcurrentModificationException æ˜¯ Fail-Fast çš„ä¸€ç§è¡¨ç°ï¼Œè¿™é‡Œæœ‰<a href="http://javapapers.com/core-java/fail-fast-vs-fail-safe/" target="_blank" rel="noopener">ä¸€ç¯‡æ–‡ç« </a>æ¢è®¨ Fail-Fast å’Œ Fail-Safe è°æ›´å¥½ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ä»¥ Java ä¸­ ArrayList çš„ Iterator (å®ƒæœ‰å¥½å‡ ä¸ª Iteratorï¼Œè¿™ä¸ªæœ€ç®€å•ï¼Œä½†èƒ½æ¦‚æ‹¬é—®é¢˜)å®ç°ä¸ºä¾‹ï¼Œçœ‹çœ‹ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿ ConcurrentModificationException ã€‚ä»¥ä¸‹ä¸º ArrayList çš„ Iterator å®ç°æºç ï¼š<a id="more"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> cursor;       <span class="comment">// index of next element to return</span></span><br><span class="line">	<span class="keyword">int</span> lastRet = -<span class="number">1</span>; <span class="comment">// index of last element returned; -1 if no such</span></span><br><span class="line">	<span class="keyword">int</span> expectedModCount = modCount;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> cursor != size;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		checkForComodification();<span class="comment">//ç¬¬ä¸€ç§</span></span><br><span class="line">		<span class="keyword">int</span> i = cursor;</span><br><span class="line">		<span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">		Object[] elementData = ArrayList.<span class="keyword">this</span>.elementData;</span><br><span class="line">		<span class="keyword">if</span> (i &gt;= elementData.length)</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">		cursor = i + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">return</span> (E) elementData[lastRet = i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">		checkForComodification();<span class="comment">//ç¬¬ä¸€ç§</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ArrayList.<span class="keyword">this</span>.remove(lastRet);</span><br><span class="line">			cursor = lastRet;</span><br><span class="line">			lastRet = -<span class="number">1</span>;</span><br><span class="line">			expectedModCount = modCount;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> E&gt; consumer)</span> </span>&#123;</span><br><span class="line">		Objects.requireNonNull(consumer);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> size = ArrayList.<span class="keyword">this</span>.size;</span><br><span class="line">		<span class="keyword">int</span> i = cursor;</span><br><span class="line">		<span class="keyword">if</span> (i &gt;= size) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> Object[] elementData = ArrayList.<span class="keyword">this</span>.elementData;</span><br><span class="line">		<span class="keyword">if</span> (i &gt;= elementData.length) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();<span class="comment">//ç¬¬äºŒç§</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (i != size &amp;&amp; modCount == expectedModCount) &#123;</span><br><span class="line">			consumer.accept((E) elementData[i++]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// update once at end of iteration to reduce heap write traffic</span></span><br><span class="line">		cursor = i;</span><br><span class="line">		lastRet = i - <span class="number">1</span>;</span><br><span class="line">		checkForComodification();<span class="comment">//ç¬¬ä¸€ç§</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkForComodification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹å‡ ç§æƒ…å†µä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼š</p>
<ol>
<li>next()å’Œremove()æ–¹æ³•ä¸€å¼€å§‹ä¼šè°ƒç”¨checkForComodification()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯æ¯”è¾ƒmodCountå’ŒexpectedModCountï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Ÿå‰è€…ä»£è¡¨é›†åˆæœ¬èº«çš„æ–¹æ³•ä¿®æ”¹é›†åˆçš„æ¬¡æ•°ï¼šè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ArrayListçš„æºç ï¼Œåœ¨removeã€addã€trimç­‰æ–¹æ³•ä¸­éƒ½å¯ä»¥çœ‹åˆ°modCountè¢«++ã€‚è€ŒexpectedModCountåˆ™åœ¨ä¸€å¼€å§‹å°±èµ‹å€¼ä¸ºmodCountï¼Œè€Œåœ¨Iteratorä¸­çš„removeæ–¹æ³•ä¸­ï¼Œåˆè¢«èµ‹å€¼ä¸ºmodCountï¼Œç”±æ­¤å¯è§ï¼Œå¦‚æœä½¿ç”¨é›†åˆçš„removeã€addç­‰æ–¹æ³•ä¿®æ”¹é›†åˆå…ƒç´ ï¼Œåˆ™å¿…ç„¶å¼•èµ·modCountå¢åŠ ï¼Œå¯¼è‡´modCount != expectedModCountæˆç«‹ï¼Œåœ¨ä¸‹æ¬¡è°ƒç”¨next()æˆ–è€…remove()æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºConcurrentModificationExceptionï¼Œè¿™é‡Œè¦æ³¨æ„æ˜¯ä¸‹æ¬¡ï¼šå¦‚æœä¿®æ”¹ä¹‹åä¸è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±ä¸ä¼šcheckForComodificationï¼Œä¹Ÿå°±ä¸ä¼šå¼•å‘å¼‚å¸¸ã€‚è€ŒIteratoræœ¬èº«çš„remove()æ–¹æ³•åœ¨æ‰§è¡Œå®Œæ¯•åå› ä¸ºä¼šé‡æ–°èµ‹å€¼expectedModCountï¼Œå› æ­¤åç»­æ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ã€‚</li>
<li>ç¬¬äºŒç±»æ˜¯ä¸€ç§åˆ¤æ–­ï¼Œä»ä»£ç çœ‹ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºæ˜¯ä¸€ç§é›†åˆè¶Šç•Œï¼šcursor(æŒ‡å‘ä¸‹ä¸€ä¸ªè¿”å›å€¼)æŒ‡å‘çš„å…ƒç´ ä¸å­˜åœ¨ï¼Œéœ€è¦removeçš„å…ƒç´ ä¸å­˜åœ¨ç­‰ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Ÿæ¯”è¾ƒæ˜æ˜¾çš„ä¸€ç‚¹æ˜¯ï¼šæ‰€æœ‰çš„removeã€addæ–¹æ³•éƒ½æ²¡æœ‰åŒæ­¥æªæ–½ï¼Œå› æ­¤åœ¨å¤šçº¿ç¨‹ä¸­å¾ˆå®¹æ˜“å‘ç”Ÿè¿™ç§æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹åœ¨æŒ‰åºéå†ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹åœ¨éšæœºåˆ é™¤æ•°æ®ï¼Œå¯¼è‡´è¶Šç•Œé”™è¯¯ï¼›</li>
</ol>
<p>ä»¥ä¸Šï¼Œä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨ArrayListçš„Iteratorçš„æ—¶å€™æŠ›å‡ºConcurrentModificationExceptionï¼Œå¯ä»¥è®¤ä¸ºIteratoråœ¨æ£€æµ‹åˆ°ä»»ä½•å¯èƒ½å‘ç”Ÿçš„é”™è¯¯æˆ–è€…ä¸ä¸€è‡´çš„æƒ…å†µçš„æ—¶å€™ï¼Œéƒ½åº”è¯¥æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚</p>
<p>ä½†æ˜¯æ­£å¦‚Java APIä¸­æ‰€æåˆ°çš„:</p>
<blockquote>
<p>â€œNote that the fail-fast behavior of an iterator cannot be guaranteed as it is, generally speaking, impossible to make any hard guarantees in the presence of unsynchronized concurrent modification. Fail-fast iterators throw ConcurrentModificationException on a best-effort basis. Therefore, it would be wrong to write a program that depended on this exception for its correctness: the fail-fast behavior of iterators should be used only to detect bugs.â€</p>
</blockquote>
<p>è¿™äº›æ–¹æ³•å¹¶æ²¡æœ‰åšå¥½åŒæ­¥å·¥ä½œï¼Œåªèƒ½è¯´æ˜¯ä¸€ç§è¾…åŠ©é¢„é˜²ï¼Œå³ä½¿æ˜¯Iteratoræœ¬èº«çš„æ–¹æ³•ä¹Ÿæ˜¯æ²¡æœ‰åšåŒæ­¥çš„ï¼Œè¿™å°±åŸ‹ä¸‹ä¸€äº›éšæ‚£ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š<br>Iteratorçš„removeæ–¹æ³•ä¸­æœ‰ä¸€è¡Œä»£ç <strong>expectedModCount = modCount;</strong>è¿™è¡Œä»£ç æ˜¯é‡æ–°èµ‹å€¼expectedModCountï¼Œå‡è®¾è¿™ä¸ªIteratorè¢«ä¸€ä¸ªçº¿ç¨‹Aè·å–ï¼Œå¹¶æ‰§è¡Œåˆ°è¿™ä¸€è¡Œï¼Œçº¿ç¨‹Aè¢«åˆ‡æ¢ï¼Œåˆ™æ— è®ºåˆ«çš„çº¿ç¨‹è°ƒç”¨ä»€ä¹ˆæ–¹æ³•æ·»åŠ é›†åˆå…ƒç´ ï¼Œå½“æ‰§è¡Œå›åˆ°çº¿ç¨‹Açš„æ—¶å€™ï¼Œéƒ½ä¸ä¼šå¯¼è‡´åç»­å‘ç”Ÿé—®é¢˜ï¼Œå› ä¸ºexpectedModCountä¼šè¢«é‡æ–°èµ‹å€¼ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[EventBusæ‚è°ˆ]]></title>
      <url>http://www.timebridge.space/2015/10/20/EventBus/</url>
      <content type="html"><![CDATA[<p>å…³äºEventBusæºç çš„è§£æï¼Œå·²ç»æœ‰å¾ˆå¤šæ–‡ç« ï¼Œæ¯”å¦‚<a href="http://a.codekk.com/detail/Android/Trinea/EventBus%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" target="_blank" rel="noopener">EventBus æºç è§£æ</a>ã€‚æ­¤å¤„å°±ä¸èµ˜è¿°äº†ï¼Œæˆ‘çš„ä»£ç é˜…è¯»æ ‡æ³¨åœ¨<a href="https://github.com/BigFootprint/AndroidSourceReader/tree/master/EventBus" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p>
<p>ä¸‹é¢éšä¾¿èŠä¸€ä¸‹ã€‚</p>
<p>Androidå¼€å‘ä¸€ç›´åœ¨è¯´MVCæ¨¡å¼ï¼ŒCè¿™å—åœ¨å®¢æˆ·ç«¯Appä¸Šå·²ç»ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼ŒMå’ŒVä¸¤å—å•ç‹¬åˆ†ç¦»æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚Må±‚æœ¬èº«ä¹Ÿå¯ä»¥æ¯”è¾ƒå®¹æ˜“çš„è¿›è¡Œæ¶æ„ç»„ç»‡ï¼Œä½†æ˜¯æ•´ä½“åœ¨æ‹†çš„æ—¶å€™ä¼šå‡ºç°ä¸¤ä¸ªé—®é¢˜ï¼š<a id="more"></a></p>
<ol>
<li>Vå¯¹Mçš„å˜åŒ–ç›‘å¬å®ç°æ¯”è¾ƒå¤æ‚ã€‚åœ¨Androidä¸­ï¼Œè¦ä¹ˆä½¿ç”¨å›è°ƒ(éœ€è¦å£°æ˜æ¥å£ï¼Œå¹¶æ·»åŠ ç›‘å¬)ï¼Œè¦ä¹ˆä½¿ç”¨å¹¿æ’­(éœ€è¦å£°æ˜å¹¿æ’­ç›‘å¬å™¨ï¼Œæœ€é‡è¦çš„æ˜¯ä¼ è¾“çš„æ•°æ®åªèƒ½é€šè¿‡Intentï¼Œä¼´éšçš„æ˜¯å£°æ˜ä¸€å †static finalå˜é‡)ï¼Œä¸¤ç§å®ç°æˆæœ¬éƒ½æ¯”è¾ƒé«˜ï¼Œé‡å¤å·¥ä½œå¾ˆå¤šï¼›</li>
<li>Væœ¬èº«çš„æ‹†åˆ†æ¯”è¾ƒå›°éš¾ã€‚è®¸å¤šå¤æ‚çš„é¡µé¢ï¼Œä¸å¯èƒ½å°†æ‰€æœ‰çš„Viewæ“ä½œéƒ½å†™åœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œå› æ­¤ä¼šç‹¬ç«‹å‡ºä¸€äº›Custom View(è¿™ä¸ªä¸€èˆ¬æ¯”è¾ƒå¥½å¤„ç†)å’ŒFragmentï¼Œè€ŒFragmentä¹‹é—´çš„é€šè®¯æ˜¯ä¸€ä»¶éå¸¸éº»çƒ¦çš„äº‹æƒ…ï¼šéœ€è¦é€šè¿‡Activityä¸­è½¬(å¾—åˆ¤æ–­Activityæ˜¯å¦ä¸ºç©º)æˆ–è€…å¹¿æ’­è¿›è¡Œã€‚å®é™…ä¸Šï¼ŒActivityä¹‹é—´çš„é€šè®¯ä¹Ÿå­˜åœ¨ç›¸ä¼¼çš„é—®é¢˜ã€‚</li>
</ol>
<p>è¿™äº›é—®é¢˜çš„å‡ºç°åœ¨å‘¼å”¤ä¸€ä¸ªä¸œè¥¿çš„å‡ºç°â€”â€”ä¸€ç§æ›´é«˜æ•ˆçš„ä»£ç é—´é€šè®¯æ–¹å¼ã€‚è¿™å°±æ˜¯ä½¿ç”¨EventBusçš„æœ€ä½³ç†ç”±ã€‚</p>
<p>EventBuså¯ä»¥ä½¿å¾—åœ¨ä»£ç ä¸Šçœ‹ä¸Šå»æ¯«æ— å…³ç³»(åªæœ‰éœ€è¦ä¼ é€çš„ä¿¡æ¯å¯¹è±¡)çš„ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´èƒ½å¤Ÿå®Œæˆä¿¡æ¯ä¼ é€’ï¼Œå¹¶ä¸”ä»£ç ç®€çŸ­é«˜æ•ˆã€‚</p>
<p>EventBusæä¾›çš„ä¸€äº›é«˜çº§ç‰¹æ€§ï¼šæ¯”å¦‚Priority(å¯ä»¥ç”¨äºäº‹ä»¶æ‹¦æˆª)ã€Sticky(æƒ³äº†ä¸€ä¸‹ï¼Œå¦‚æœAé¡µé¢è·³è½¬åˆ°Bé¡µé¢ï¼ŒAé¡µé¢åŒæ—¶åˆåœ¨ç­‰å¾…Bé¡µé¢çš„ä¿¡æ¯ï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨stickyäº‹ä»¶ï¼Œå› ä¸ºAé¡µé¢å¯èƒ½ä¼šå› ä¸ºå†…å­˜ä¸è¶³è€Œè¢«æ€æ‰ï¼Œä½¿ç”¨Stickyåˆ™å¯ä»¥åœ¨Aé¡µé¢æ¢å¤çš„æ—¶å€™å†åº¦è·å–åˆ°äº‹ä»¶)ï¼Œå¯ä»¥ä¸ºä¸€äº›ç‰¹æ®Šåœºæ™¯æä¾›ä¾¿åˆ©ã€‚</p>
<p>ç„¶è€ŒEventBuså¹¶ä¸æ˜¯æ¯«æ— ç¼ºç‚¹çš„ï¼Œ<strong>æœ€ä¸å¥½çš„ä¸€ç‚¹</strong>æ˜¯:<br>EventBusåœ¨äº‹ä»¶ç±»å‹ä»¥åŠç›‘å¬è€…çš„å®ç°ä¸Šè€ƒè™‘åˆ°äº†ç»§æ‰¿ï¼Œä½†å³ä¾¿ä¸è€ƒè™‘ï¼Œä¹Ÿä¼šæœ‰ä¸€ä¸ªæ¯”è¾ƒéº»çƒ¦çš„åœ°æ–¹â€”â€”å¤ªå¤šçš„EventBusä¼šå¯¼è‡´ç¨‹åºé€»è¾‘ä¸æ¸…æ™°ã€‚ä¸¾ä¸ªæ —å­ï¼ŒåŸå…ˆActivityå’ŒFragmentä¹‹é—´é€šè®¯ï¼Œå¯èƒ½æ˜¯Fragmentç›´æ¥è°ƒç”¨getActivity()åå¼ºè½¬ç±»å‹ï¼Œç„¶åè°ƒç”¨æŸä¸ªæ–¹æ³•ï¼Œç°åœ¨å¯èƒ½ç›´æ¥postä¸€ä¸ªäº‹ä»¶ï¼Œä¸¤ç«¯ä»£ç ç›¸æ¯”è¾ƒï¼Œæ˜æ˜¾å‰è€…æ›´è½»æ˜“èƒ½çœ‹å‡ºFragmentåœ¨å’Œè°ã€ä»€ä¹ˆæ–¹æ³•é€šä¿¡ï¼Œå†è€…ï¼Œå¦‚æœæŸä¸ªonEventæ–¹æ³•æ˜¯å‡ºç°åœ¨Activityçš„çˆ¶ç±»ä¸­ï¼Œæ•´ä½“ä»£ç çœ‹ä¸Šå»å°±æ›´åŠ éšæ™¦ï¼Œå¯è¯»æ€§å˜å·®ã€‚</p>
<p>å› æ­¤ä½¿ç”¨æ—¶æ³¨æ„é€‚é‡ï¼Œå¹¶é€‚å½“æ·»åŠ æ³¨é‡Šã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è§‚å½±ã€Šèšäººã€‹]]></title>
      <url>http://www.timebridge.space/2015/10/18/yi-ren/</url>
      <content type="html"><![CDATA[<p>è¯„åˆ†ï¼š8.0ã€‚ç‚¹è¯„ä¸Š19.9å…ƒï¼Œ3Dé•¿ï¼Œæ•ˆæœä¸é”™ã€‚</p>
<h1 id="èµ"><a href="#èµ" class="headerlink" title="èµ"></a>èµ</h1><p>æ•´ä½“æ•…äº‹æƒ…èŠ‚æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ç²¾å½©çš„åœ°æ–¹ï¼Œä½†æ•´ä¸ªå½±ç‰‡æƒ³è±¡åŠ›å¾ˆä¸°å¯Œï¼Œæœ‰å‡ ä¸ªåœºæ™¯å¾ˆæœ‰éœ‡æ’¼åŠ›:</p>
<ol>
<li>æœ—ç¬¬ä¸€æ¬¡åœ¨æµ´ç¼¸é‡Œé¢å˜æˆèšäººï¼Œè¢«æ”¾æ°´å†²åˆ·ï¼›</li>
<li>æœ—å˜æˆèšäººä»æ°´ç®¡é‡Œé¢æ½œå…¥çš®å§†å…¬å¸;</li>
<li>æœ—åœ¨æœ€åä¸ºäº†æ‰“è´¥è¾¾ä¼¦è¿›å…¥æ¬¡åŸå­çº§ï¼Œä¸æ–­ç¼©å°;</li>
<li>å½“ç„¶è¿˜æœ‰æœ—å’Œå„ç§èš‚èšä»¬ä¸€èµ·äº²å¯†æ¥è§¦çš„åœºæ™¯;</li>
</ol>
<p>å½±ç‰‡çš„æœ€åè®©äººä¸ç¦æƒ³èµ·æ˜Ÿé™…ç©¿è¶Šï¼Œæˆ‘è¿˜ä»¥ä¸ºæœ—ä¼šæŠŠçš®å§†æ•™æˆçš„å¤«äººä»æ¬¡åŸå­çº§å¸¦å›åˆ°ç°å®ç”Ÿæ´»ä¸­ã€‚<a id="more"></a></p>
<p>å¦å¤–å½±ç‰‡ä¸­ç¬‘ç‚¹ä¹Ÿè›®å¤šã€‚çœ‹å®Œç”µå½±è§‰å¾—æœ‰å¿…è¦ç†ä¸€ä¸‹æ¼«å¨ç”µå½±å®‡å®™äº†ã€‚</p>
<h1 id="æ‰¹"><a href="#æ‰¹" class="headerlink" title="æ‰¹"></a>æ‰¹</h1><p>å½±ç‰‡ä¸­æœ‰å‡ ä¸ªåœ°æ–¹åº”è¯¥æœ‰æ¼æ´:</p>
<ol>
<li>çš®å§†æ•™æˆçš„å¥³å„¿éœæ™®åœ¨å’Œæœ—ç»ƒä¹ æ‹³å‡»çš„æ—¶å€™è¯´é“:èšäººä¸€æ‹³å‡ºå‡»çš„åŠ›æ°”ç›¸å½“äºä¸€ä¸ª90kg(æ•°å­—è®°ä¸æ¸…äº†)çš„ç”·äººå‡ºæ‹³çš„åŠ›é‡ï¼Œå› æ­¤é‡äº†ä¼šæ‰“æ­»äººã€‚é‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºï¼ša)çš®å§†æ•™æˆçš„å‘ç°åªæ˜¯æŠŠäººç¼©å°ï¼Œè´¨é‡åº”è¯¥æ²¡å˜ï¼›å¦å¤–ä»æœ—å’Œèš‚èšç»ƒä¹ äº¤æµä»¥åŠåæœŸå¹¶è‚©ä½œæˆ˜çš„åœºæ™¯çœ‹ï¼šb)ç¼©å°çš„æœ—åº”è¯¥å’Œä¸€ä¸ªèšŠå­çš„å¤§å°å·®ä¸å¤šã€‚è€Œå½±ç‰‡ä¸­å¤šæ¬¡å‡ºç°ç¼©å°çš„æœ—æŠŠäººæ€ç¿»åœ¨åœ°çš„æƒ…æ™¯ï¼ŒæŒ‰ç…§å‰é¢çš„aå’Œbå‡è®¾ï¼Œè¿™ä¸ªæƒ…æ™¯å°±æœ‰é—®é¢˜äº†ï¼šä»¥èšŠå­çš„ä½“ç§¯åœ¨äººä½“çš®è‚¤ä¸Šæ–½åŠ ä¸€ä¸ªèƒ½å¤Ÿæ€ç¿»äººçš„åŠ›é‡ï¼Œéš¾é“ä¸æ˜¯åº”è¯¥å’Œå­å¼¹ä¸€æ ·ç©¿é€?</li>
<li>åŒæ ·æ˜¯åŸºäºå‰é¢çš„aå‡è®¾ï¼Œæ°´ç®¡ä¸­æœ—ä¹˜åèš‚èšä»¬ç»„æˆçš„èšèˆŸå‰è¿›ä»¥åŠé€šè¿‡èš‚èšä»¬æ­å»ºçš„é“¾æ¡è¿›å…¥ç®¡é“å°±ä¸èƒ½è§£é‡Šäº†;</li>
<li>å½±ç‰‡å‰é¢å‡ºç°äº†çš®å§†ç²’å­ä¸€è¯´ï¼Œè¿™ç§ç²’å­æ˜¯å¯ä»¥ç¼©å°åŸå­ä¹‹é—´çš„è·ç¦»çš„(çš®å§†æ•™æˆåŸè¯)ï¼Œé‚£ä¹ˆä»…ä»…é ç¼©çŸ­åŸå­é—´çš„è·ç¦»ï¼Œå¦‚ä½•è¿›å…¥æ¬¡åŸå­çº§å‘¢ï¼Ÿé™¤éçš®å§†ç²’å­èƒ½å¤Ÿæ”¹å˜åŸå­çš„ä½“ç§¯ï¼Œç¼©å°è‡³å¤¸å…‹ç”šè‡³æ›´å°çš„ç²’å­ä¹‹ä¸‹?è¿™æ ·ï¼Œå¾ˆå¤šäº‹æƒ…å°±ä¸å¥½è§£é‡Šäº†;</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[GitBook ç¯å¢ƒæ­å»º]]></title>
      <url>http://www.timebridge.space/2015/10/17/GitBook-huan-jing-da-jian/</url>
      <content type="html"><![CDATA[<p>å…³äºå¦‚ä½•æ­å»ºGitBookçš„æœ¬åœ°ç¯å¢ƒä»¥åŠä¸€äº›ç®€å•çš„é…ç½®ï¼Œå¯ä»¥å‚è€ƒ<a href="http://www.chengweiyang.cn/gitbook/gitbook.com/config/domain.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚å·²ç»è®²çš„å¾ˆå…¨é¢äº†ã€‚</p>
<p>GitBookçš„å®˜ç½‘åœ¨<a href="https://github.com/GitbookIO/gitbook" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚<a id="more"></a></p>
<p>ä¸è¿‡å¯èƒ½æ˜¯å› ä¸ºæ–‡ç« å¤ªè€çš„ç¼˜æ•…ï¼Œæœ‰äº›æˆªå›¾å’Œå®é™…çš„æ“ä½œç•Œé¢å·²ç»ä¸ä¸€æ ·äº†ã€‚æ¯”å¦‚<a href="http://www.chengweiyang.cn/gitbook/gitbook.com/config/domain.html" target="_blank" rel="noopener">ç»‘å®šåŸŸå</a>è¿™ä¸€ç« ï¼Œå…¥å£å’Œé…ç½®é¡µé¢å·²ç»å˜æˆè¿™æ ·:</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/GitBookåŸŸåé…ç½®å…¥å£.png" alt="GitBookåŸŸåé…ç½®å…¥å£"></p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/GitBookåŸŸåé…ç½®ç•Œé¢.png" alt="GitBookåŸŸåé…ç½®ç•Œé¢"></p>
<p>æ·»åŠ å®ŒæˆåŸŸåï¼Œé…ç½®å¥½DNSä¹‹åï¼Œå°±å¯ä»¥è®¿é—®äº†ã€‚</p>
<p><a href="http://colobu.com/2014/10/09/gitbook-quickstart/" target="_blank" rel="noopener">è¿™é‡Œ</a>è¿˜æœ‰ä¸€ç¯‡æ–‡ç« å¯ä»¥å‚è€ƒã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[é‚£äº›å¹´è®¡åˆ’çœ‹çš„ç”µå½±]]></title>
      <url>http://www.timebridge.space/2015/10/17/Movie/</url>
      <content type="html"><![CDATA[<h3 id="å¾…çœ‹åŒº"><a href="#å¾…çœ‹åŒº" class="headerlink" title="å¾…çœ‹åŒº"></a>å¾…çœ‹åŒº</h3><p>ã€Šä¼Šä¸½èç™½é•‡ã€‹ã€Šè¿·å¤±ä¸œäº¬ã€‹ã€Šæ—¥å‡ºä¹‹å‰ã€‹ã€Šæ—¥è½ä¹‹å‰ã€‹ã€Šæ‹çˆ±å‡æœŸã€‹ã€Šç»ƒä¹ æ›²ã€‹ã€Šå¤©ä½¿çˆ±ç¾ä¸½ã€‹ã€Šå·´é»ï¼Œæˆ‘çˆ±ä½ ã€‹ã€Šæ‘©æ‰˜æ—¥è®°ã€‹ã€Šæ‰˜æ–¯å¡çº³è‰³é˜³ä¸‹ã€‹ ã€Šäº‘ä¸­æ¼«æ­¥ã€‹ã€ŠèŠæ¬¡éƒçš„å¤å¤©ã€‹ã€ŠæŸä¸ªæ—…äººçš„æ—¥è®°ã€‹ã€Šåˆå¤œå·´å¡ç½—é‚£ã€‹</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidçš„æ•°æ®æ¢å¤(äºŒ)]]></title>
      <url>http://www.timebridge.space/2015/10/17/Android-de-shu-ju-hui-fu-yi/</url>
      <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨Androidä¸Šï¼Œä¼šæœ‰ä»¥ä¸‹åŸå› å¯¼è‡´éœ€è¦ä¿å­˜å’Œæ¢å¤å½“å‰é¡µé¢çš„æ•°æ®ï¼š  </p>
<ol>
<li>ä¸€ä¸ªActivityé€€åˆ°åå°ï¼šæ¯”å¦‚è·³è½¬åˆ°å¦å¤–ä¸€ä¸ªActivityï¼Œæˆ–è€…æŒ‰Homeé”®é€€åˆ°åç«¯;</li>
<li>ç³»ç»Ÿé…ç½®å˜åŒ–ï¼Œå¦‚ï¼šå±å¹•æ—‹è½¬(åœ¨ç”¨æˆ·æ„è¯†é‡Œåªæ˜¯å±å¹•æ—‹è½¬ï¼Œå®é™…ä¸ŠActivityæ˜¯è¢«æ€æ‰åé‡å»º);</li>
</ol>
<p>ç¬¬ä¸€ç§æƒ…å†µåªæœ‰åœ¨å†…å­˜ä¸è¶³ï¼Œåå°Activityç¡®å®è¢«ç³»ç»Ÿå›æ”¶æ‰çš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ•°æ®æ¢å¤ï¼Œå¦‚æœActivityæ­£å¸¸å­˜åœ¨äºå†…å­˜ä¸­ï¼Œåˆ™ä¸éœ€è¦æ•°æ®æ¢å¤ï¼Œä½†ä¸€å®šä¼šåšæ•°æ®ä¿å­˜ã€‚ç¬¬äºŒç§æƒ…å†µæ˜¯å› ä¸ºåœ¨ç”¨æˆ·çœ¼é‡Œåªæ˜¯ç•Œé¢æ—‹è½¬äº†ä¸€ä¸‹ï¼Œè€Œå®é™…ä¸ŠActivityæ˜¯è¢«é”€æ¯é‡å»ºçš„ï¼Œè¿™ä¸ªæ—¶å€™åšæ•°æ®æ¢å¤æ˜¯åˆç†è€Œä¸”åº”å½“çš„ã€‚<a id="more"></a></p>
<h2 id="æ•°æ®å¦‚ä½•ä¿å­˜"><a href="#æ•°æ®å¦‚ä½•ä¿å­˜" class="headerlink" title="æ•°æ®å¦‚ä½•ä¿å­˜"></a>æ•°æ®å¦‚ä½•ä¿å­˜</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‰ä¸ªæ–¹æ³•è¿›è¡ŒActivityçš„æ•°æ®æ¢å¤ä¸ä¿å­˜ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span>  </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span>  </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span></span></span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬é€šè¿‡ç¬¬ä¸€ä¸ªæ–¹æ³•çš„outStateå‚æ•°ä¿å­˜æ•°æ®ï¼Œåé¢ä¸¤ä¸ªæ–¹æ³•çš„savedInstanceStateå‚æ•°è·å–ä¿å­˜çš„æ•°æ®ã€‚onRestoreInstanceStateæ–¹æ³•åœ¨onStartåé¢onResumeå‰é¢æ‰§è¡Œã€‚</p>
<p>å…³äºä»¥ä¸Šä¸¤ç‚¹ï¼Œå¼€å‘è€…å®˜ç½‘ä¸Šéƒ½æœ‰æ¯”è¾ƒå®Œå–„çš„æè¿°ï¼Œè¯»è€…å¯ä»¥ä»”ç»†é˜…è¯»ï¼š<a href="http://developer.android.com/training/basics/activity-lifecycle/recreating.html" target="_blank" rel="noopener">ã€åŸæ–‡é“¾æ¥ã€‘</a></p>
<p>è¿™ä¸€éƒ¨åˆ†ç¨æœ‰ç»éªŒçš„å¼€å‘è€…éƒ½æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæœ¬æ–‡é‡ç‚¹è®²è¿°çš„æ˜¯<strong>Viewå¦‚ä½•å»ä¿å­˜æ¢å¤æ•°æ®</strong>ã€‚</p>
<h2 id="ViewçŠ¶æ€å¦‚ä½•ä¿å­˜"><a href="#ViewçŠ¶æ€å¦‚ä½•ä¿å­˜" class="headerlink" title="ViewçŠ¶æ€å¦‚ä½•ä¿å­˜"></a>ViewçŠ¶æ€å¦‚ä½•ä¿å­˜</h2><p>ä¸€ä¸ªActivityå±•ç¤ºç»™ç”¨æˆ·çš„é™¤äº†æ•°æ®ï¼Œå°±æ˜¯Viewï¼Œæ‰€ä»¥å½“æˆ‘ä»¬åšæ¢å¤çš„æ—¶å€™ï¼Œä¸ä»…éœ€è¦æ¢å¤é‡è¦æ•°æ®ï¼Œä¹Ÿéœ€è¦å°½å¯èƒ½çš„æ¢å¤Viewçš„çŠ¶æ€ã€‚</p>
<p>æ—¥å¸¸å¼€å‘ä¸­æˆ‘ä»¬ä¸€èˆ¬æ˜¯é€šè¿‡onSaveInstanceStateå»ä¿å­˜Viewçš„çŠ¶æ€(æ¯”å¦‚EditTexçš„è¾“å…¥å†…å®¹)ï¼Œæ¢å¤çš„æ—¶å€™å°†æ•°æ®è¯»å‡ºè®¾ç½®åˆ°Viewä¸­å»ï¼Œä½†è¿™ç§æ–¹å¼ç²—æš´æœ‰ç”¨ä½†ä¸ä¼˜é›…ï¼Œä¸¾ä¸ªğŸŒ°ï¼šæˆ‘å°è£…äº†ä¸€ä¸ªCustomViewï¼Œå…¶ä¸­åŒ…å«ç€ä¸€ä¸ªEditTextï¼Œå¦‚æœæŒ‰ç…§å‰é¢çš„æ–¹å¼å»åšæ¢å¤åˆ™EditTextä¸€å®šè¦æš´éœ²ç»™å¤–éƒ¨ï¼Œå¦åˆ™Activityå°±ä¸èƒ½è·å–å¹¶è®¾ç½®å€¼ï¼Œè¿™ç ´åäº†ç»„ä»¶çš„å°è£…æ€§ã€‚</p>
<p>å…¶å®Androidå†…éƒ¨æ˜¯æœ‰ä¸€å¥—ViewçŠ¶æ€ä¿å­˜å’Œæ¢å¤æœºåˆ¶çš„ï¼Œä¸éœ€è¦é€šè¿‡Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å»å®ç°ã€‚é˜…è¯»å®˜æ–¹æ–‡æ¡£çš„è¯»è€…å¯ä»¥æ³¨æ„ä¸€ç‚¹ï¼Œæ–‡ä¸­æåˆ°äº†EditTextçŠ¶æ€çš„ä¿å­˜æ¡ä»¶ï¼šéœ€è¦æœ‰ä¸€ä¸ªå”¯ä¸€çš„idã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹Viewçš„æ•°æ®ä¿å­˜æœºåˆ¶ï¼Œä»ä¸­æ‰¾å‡ºå›ç­”å‰é¢é—®é¢˜çš„ç­”æ¡ˆã€‚</p>
<blockquote>
<p>ã€Noteã€‘å»ºè®®æ‰“å¼€Android Studioï¼Œä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¯”è¾ƒå¤šï¼Œç›´æ¥é˜…è¯»æºç å¯¹ç…§é˜…è¯»æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚</p>
</blockquote>
<h3 id="Activityçš„onSaveInstanceState-æ–¹æ³•"><a href="#Activityçš„onSaveInstanceState-æ–¹æ³•" class="headerlink" title="Activityçš„onSaveInstanceState()æ–¹æ³•"></a>Activityçš„onSaveInstanceState()æ–¹æ³•</h3><p>Viewè¯´åˆ°åº•æ˜¯å±äºActivityçš„ï¼ŒonSaveInstanceStateæ˜¯æ•´ä¸ªActivityä¿å­˜æ•°æ®çš„å‡ºå‘ç‚¹ï¼Œæˆ‘ä»¬ä»è¿™é‡Œå…¥æ‰‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</span><br><span class="line">	outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</span><br><span class="line">	Parcelable p = mFragments.saveAllState();</span><br><span class="line">	<span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">		outState.putParcelable(FRAGMENTS_TAG, p);</span><br><span class="line">	&#125;</span><br><span class="line">	getApplication().dispatchActivitySaveInstanceState(<span class="keyword">this</span>, outState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚ä»£ç æ‰€ç¤ºï¼Œç¬¬äºŒè¡Œå°†æ•´ä¸ªWindowçš„çŠ¶æ€ä¿å­˜åœ¨ä¸€ä¸ªBundleä¸­ï¼Œå°†å€¼ä¿å­˜åˆ°ontStateä¸­å»ï¼Œçœ‹ä¸Šå»å¾ˆæœ‰å¯èƒ½ä¸Viewç›¸å…³ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ã€‚</p>
<p>3-6è¡Œåˆ™æ˜¯è§¦å‘Fragmentæ•°æ®ä¿å­˜çš„ï¼ˆä¸‹ä¸€ç¯‡åšæ–‡ä¸»é¢˜ï¼‰ã€‚å…³äºWindnowçš„è§£é‡Šï¼Œå¯ä»¥æŸ¥çœ‹è¿™ç¯‡åšå®¢ï¼š<a href="http://www.cnblogs.com/lqminn/archive/2013/05/01/3050776.html" target="_blank" rel="noopener">ã€Androidã€‘Androidç•Œé¢ä»é‡Œè‡³å¤–æµ…æï¼ˆä¸€ï¼‰</a></p>
<h3 id="Windowçš„saveHierarchyState-æ–¹æ³•"><a href="#Windowçš„saveHierarchyState-æ–¹æ³•" class="headerlink" title="Windowçš„saveHierarchyState()æ–¹æ³•"></a>Windowçš„saveHierarchyState()æ–¹æ³•</h3><p>äº†è§£ä¹‹åï¼Œæˆ‘ä»¬å®šä½åˆ°PhoneWindowä¸­çš„saveHierarchyStateæ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Bundle <span class="title">saveHierarchyState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Bundle outState = <span class="keyword">new</span> Bundle();</span><br><span class="line">	<span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line"> 		<span class="keyword">return</span> outState;</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	SparseArray&lt;Parcelable&gt; states = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</span><br><span class="line"> 	mContentParent.saveHierarchyState(states);</span><br><span class="line"> 	outState.putSparseParcelableArray(VIEWS_TAG, states);</span><br><span class="line"> 	....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ­¤å¤„çœç•¥äº†éƒ¨åˆ†ä»£ç ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•è§¦å‘äº†mContentParentçš„saveHierarchyStateçš„æ–¹æ³•ã€‚mContentParentåˆæ˜¯ä½•æ–¹ç¥åœ£ï¼ŸæŸ¥çœ‹å…¶å£°æ˜å‘ç°ï¼šå®ƒæ˜¯ä¸€ä¸ªViewGroupã€‚æ¯”å¯¹<a href="http://www.cnblogs.com/lqminn/archive/2013/05/01/3050776.html" target="_blank" rel="noopener">ã€Androidã€‘Androidç•Œé¢ä»é‡Œè‡³å¤–æµ…æï¼ˆä¸€ï¼‰</a>ä¸­çš„å›¾ï¼Œè¿™ä¸ªmContentParentåˆåœ¨ä»€ä¹ˆä½ç½®å‘¢ï¼Ÿè¯»è€…å¯ä»¥é˜…è¯»ä¸€ä¸‹PhoneWindowé‡Œé¢çš„setContentViewæ–¹æ³•ï¼Œå…¶å®è¿™ä¸ªmContentParentå°±æ˜¯å›¾ä¸­DecorViewä¸‹çš„LinearLayoutï¼Œå³æˆ‘ä»¬setContentViewçš„çˆ¶å®¹å™¨ã€‚</p>
<p>ç„¶åæˆ‘ä»¬çœ‹åˆ°æ–¹æ³•å£°æ˜äº†ä¸€ä¸ªSparseArrayå¯¹è±¡ï¼Œå­˜å‚¨çš„æ˜¯Parcelableï¼Œè¿™ä¸ªSparseArrayå¯¹è±¡è¢«ä¼ é€’ç»™äº†ViewGroupçš„saveHierarchyStateæ–¹æ³•ï¼Œä¹‹åè¿™ä¸ªSparseArrayå¯¹è±¡åˆè¢«å­˜å‚¨åˆ°äº†outBundleä¸­å»äº†ï¼Œé‚£ä¹ˆé—®é¢˜å°±åœ¨äºsaveHierarchyStateè¿™ä¸ªæ–¹æ³•åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</p>
<h3 id="ViewGroupçš„saveHierarchyState-æ–¹æ³•"><a href="#ViewGroupçš„saveHierarchyState-æ–¹æ³•" class="headerlink" title="ViewGroupçš„saveHierarchyState()æ–¹æ³•"></a>ViewGroupçš„saveHierarchyState()æ–¹æ³•</h3><p>æ ‡é¢˜è™½ç„¶æ˜¯ViewGroupçš„saveHierarchyState()æ–¹æ³•ï¼Œä½†ViewGroupæœ¬èº«å…¶å®å¹¶æ²¡æœ‰saveHierarchyStateæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç»§æ‰¿äºå®ƒçš„çˆ¶ç±»â€”â€”Viewã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveHierarchyState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</span><br><span class="line">	dispatchSaveInstanceState(container);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mID != NO_ID &amp;&amp; (mViewFlags &amp; SAVE_DISABLED_MASK) == <span class="number">0</span>) &#123;</span><br><span class="line">		mPrivateFlags &amp;= ~PFLAG_SAVE_STATE_CALLED;</span><br><span class="line">		Parcelable state = onSaveInstanceState();</span><br><span class="line">		<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SAVE_STATE_CALLED) == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Derived class did not call super.onSaveInstanceState()"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// Log.i("View", "Freezing #" + Integer.toHexString(mID)</span></span><br><span class="line">			<span class="comment">// + ": " + state);</span></span><br><span class="line">			container.put(mID, state);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå®ƒè°ƒç”¨äº†dispatchSaveInstanceStateæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•åˆ™è°ƒç”¨æœ¬èº«çš„onSaveInstanceStateæ–¹æ³•è·å–ä¸€ä¸ªParcelableå¯¹è±¡ï¼Œé€šè¿‡Viewçš„idå°†è¿™ä¸ªå¯¹è±¡å­˜å‚¨åˆ°SparseArrayé‡Œé¢å»äº†ã€‚è€ŒViewGroupé‡Œé¢é‡å†™äº†dispatchSaveInstanceStateæ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span></span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.dispatchSaveInstanceState(container);</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</span><br><span class="line">	<span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">		View c = children[i];</span><br><span class="line">		<span class="keyword">if</span> ((c.mViewFlags &amp; PARENT_SAVE_DISABLED_MASK) != PARENT_SAVE_DISABLED) &#123;</span><br><span class="line">			c.dispatchSaveInstanceState(container);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç å¾ˆå¥½ç†è§£ï¼šå®ƒä¸ä½†ä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œè¿˜éå†æ‰€æœ‰çš„å­Viewï¼Œè°ƒç”¨ä»–ä»¬çš„dispatchSaveInstanceStateæ–¹æ³•å»ä¿å­˜æ•°æ®ã€‚</p>
<h3 id="Viewæ•°æ®ä¿å­˜æ€»ç»“"><a href="#Viewæ•°æ®ä¿å­˜æ€»ç»“" class="headerlink" title="Viewæ•°æ®ä¿å­˜æ€»ç»“"></a>Viewæ•°æ®ä¿å­˜æ€»ç»“</h3><p>ç»¼ä¸Šï¼ŒViewæœ¬èº«çš„æ•°æ®ä¿å­˜æœºåˆ¶æ˜¯è¿™æ ·çš„: <strong>Activityä¼šè§¦å‘æ ¹ViewGroupå°†è¯¥å‘½ä»¤ä¼ è¾¾ç»™æ‰€æœ‰çš„å­Viewï¼ŒåŒæ—¶ä¼ é€’ä¸€ä¸ªSparseArrayç»™å®ƒä»¬ã€‚Viewè°ƒç”¨è‡ªå·±çš„onSaveInstanceState()å°†è‡ªå·±çš„çŠ¶æ€ä»¥<id, state="">æ–¹å¼å­˜å‚¨åˆ°SparseArrayä¸­å»ï¼Œæœ€ç»ˆSparseArrayä¼šè¢«ä¿å­˜åˆ°outStateä¸­ã€‚</id,></strong></p>
<p>ç°åœ¨è§£ç­”å‰é¢è¯´åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼šidå”¯ä¸€çš„å¿…è¦æ€§ã€‚å¹³æ—¶ç¼–ç ä¸­idä»…ç”¨äºå®šä½Viewï¼Œæ‰€ä»¥å¦‚æœèƒ½å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå³ä½¿Idé‡å¤ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚ä½†æ˜¯åœ¨ä¿å­˜çŠ¶æ€çš„æ—¶å€™ï¼Œå› ä¸ºKeyå°±æ˜¯idï¼Œå¦‚æœidé‡å¤ï¼Œé‚£ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿä¿å­˜çš„æ—¶å€™æ•°æ®ä¼šè¢«è¦†ç›–ï¼Œæ¢å¤çš„æ—¶å€™ç›¸åŒidçš„Viewä¼šè¢«ä»¥åŒæ ·çš„æ•°æ®æ¢å¤ï¼Œå¾ˆå¤šäººéƒ½é‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼ŒåŸå› å°±åœ¨äºæ­¤ã€‚</p>
<h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p>è¿™é‡Œé€šè¿‡ä»¥TextViewä¸ºğŸŒ°çœ‹ä¸€ä¸‹å®é™…çš„æƒ…å†µ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Parcelable superState = <span class="keyword">super</span>.onSaveInstanceState();</span><br><span class="line">	<span class="comment">// Save state if we are forced to</span></span><br><span class="line">	<span class="keyword">boolean</span> save = mFreezesText;</span><br><span class="line">	<span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (mText != <span class="keyword">null</span>) &#123;</span><br><span class="line">		start = getSelectionStart();</span><br><span class="line">		end = getSelectionEnd();</span><br><span class="line">		<span class="keyword">if</span> (start &gt;= <span class="number">0</span> || end &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// Or save state if there is a selection</span></span><br><span class="line">			save = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (save) &#123;</span><br><span class="line">		SavedState ss = <span class="keyword">new</span> SavedState(superState);</span><br><span class="line">		<span class="comment">// XXX Should also save the current scroll position!</span></span><br><span class="line">		ss.selStart = start;</span><br><span class="line">		ss.selEnd = end;</span><br><span class="line">		<span class="keyword">if</span> (mText <span class="keyword">instanceof</span> Spanned) &#123;</span><br><span class="line">			Spannable sp = <span class="keyword">new</span> SpannableStringBuilder(mText);</span><br><span class="line">			<span class="keyword">if</span> (mEditor != <span class="keyword">null</span>) &#123;</span><br><span class="line">				removeMisspelledSpans(sp);</span><br><span class="line">				sp.removeSpan(mEditor.mSuggestionRangeSpan);</span><br><span class="line">			&#125;</span><br><span class="line">			ss.text = sp;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ss.text = mText.toString();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (isFocused() &amp;&amp; start &gt;= <span class="number">0</span> &amp;&amp; end &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			ss.frozenWithFocus = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		ss.error = getError();</span><br><span class="line">		<span class="keyword">return</span> ss;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> superState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç æ‰€ç¤ºï¼ŒTextViewå°±é€šè¿‡è¿™ä¸ªæ–¹æ³•ä¿å­˜äº†å®ƒæ˜¾ç¤ºçš„textï¼Œä¸è¿‡å¼€å‘è€…å¯ä»¥é€šè¿‡è®¾ç½®mFreezesTextæ§åˆ¶å¦è¦ä¿å­˜ã€‚è¯»è€…æœ‰å…´è¶£è¿˜å¯ä»¥å»çœ‹çœ‹ScrollViewè¿™ä¸ªæ–¹æ³•çš„å®ç°ã€‚</p>
<p>##æ€»ç»“<br><strong>æ•°æ®æ¢å¤çš„è¿‡ç¨‹å’Œæ•°æ®ä¿å­˜çš„æµç¨‹ç±»ä¼¼ï¼Œæ­¤å¤„ç•¥å»ä¸è¡¨ã€‚</strong></p>
<p>ä»å¼€å‘ç»éªŒæ¥çœ‹ï¼ŒAndroidä¸Šå›æ”¶èµ„æºå‘ç”Ÿçš„æ¯”è¾ƒé¢‘ç¹ï¼Œåšå¥½çŠ¶æ€ä¿å­˜æ¢å¤å·¥ä½œå¯¹äºæå‡ç”¨æˆ·ä½“éªŒæœ‰å¾ˆå¤§å¸®åŠ©ã€‚æ–‡ç« ä¸»è¦é˜è¿°äº†ViewçŠ¶æ€ä¿å­˜æ¢å¤çš„è¿‡ç¨‹ï¼Œæœ‰åŠ©äºå¼€å‘è€…æ›´å¥½çš„åˆ©ç”¨è¯¥æœºåˆ¶: </p>
<ol>
<li>æ³¨æ„idé—®é¢˜â€”â€”ç²—æš´çš„æ–¹å¼é—®é¢˜ä¹Ÿä¸å¤§ï¼Œä½†æ˜¯å¦‚æœç²—æš´å·²ç»å¼•èµ·äº†è®¾è®¡æˆ–è€…å®ç°é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘Viewçš„å†…å»ºæœºåˆ¶ï¼Œå‡ºç°é—®é¢˜çš„æ—¶å€™ï¼Œidçš„é‡å¤ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªè€ƒè™‘æ–¹å‘;</li>
<li>å¦‚æœæƒ³å†™ä¸€ä¸ªCustomViewå¹¶ä¸”æƒ³ä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡é‡è½½onSaveInstanceState()æ–¹æ³•å®ç°ï¼Œæ¢å¤ä¹Ÿæœ‰å“åº”çš„æ–¹å¼ï¼Œç®€å•ä¼˜é›…ä¸”ä¸ä¾èµ–äºä½¿ç”¨è€…;</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Volleyæ‚è°ˆ]]></title>
      <url>http://www.timebridge.space/2015/10/17/Volley-za-tan/</url>
      <content type="html"><![CDATA[<p>å…³äºVolleyæ¡†æ¶çš„åŸºæœ¬ä»‹ç»ï¼Œå¯ä»¥çœ‹ä¸‹é¢å‡ ç¯‡æ–‡ç« ï¼š</p>
<ol>
<li><a href="http://blog.csdn.net/t12x3456/article/details/9221611" target="_blank" rel="noopener">Android ç½‘ç»œé€šä¿¡æ¡†æ¶Volleyç®€ä»‹(Google IO 2013)</a></li>
<li><a href="http://www.codekk.com/open-source-project-analysis/detail/Android/grumoon/Volley%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" target="_blank" rel="noopener">Volley æºç è§£æ</a></li>
<li><a href="https://developer.android.com/training/volley/index.html" target="_blank" rel="noopener">Transmitting Network Data Using Volley</a></li>
</ol>
<p>çœ‹å®Œè¿™å‡ ç¯‡åšå®¢ï¼Œå¯¹Volleyåº”è¯¥æœ‰ç›¸å½“çš„äº†è§£ï¼Œå› æ­¤å…³äºå…¶åŸºæœ¬ä»‹ç»ä»¥åŠä¼˜ç¼ºç‚¹çš„è®ºè¿°ï¼Œçœç•¥ã€‚ä¸‹é¢è®¨è®ºå‡ ä¸ªVolleyåšçš„ä¸é”™çš„æ–¹é¢ã€‚<a id="more"></a></p>
<h2 id="ä¸€ã€èŒè´£åˆ‡åˆ†"><a href="#ä¸€ã€èŒè´£åˆ‡åˆ†" class="headerlink" title="ä¸€ã€èŒè´£åˆ‡åˆ†"></a>ä¸€ã€èŒè´£åˆ‡åˆ†</h2><h3 id="1-1-çºµå‘åˆ‡åˆ†"><a href="#1-1-çºµå‘åˆ‡åˆ†" class="headerlink" title="1.1 çºµå‘åˆ‡åˆ†"></a>1.1 çºµå‘åˆ‡åˆ†</h3><p>å³å¯¹æ•´ä¸ªè¯·æ±‚æµç¨‹çš„åˆ‡åˆ†ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</p>
<ol>
<li>RequestQueueè´Ÿè´£è¯·æ±‚çš„æ‰§è¡Œå’Œå–æ¶ˆç­‰æ“ä½œï¼›</li>
<li>Dispatcherè´Ÿè´£åˆ†å‘ç›¸åº”çš„è¯·æ±‚ï¼›</li>
<li>ResponseDeliveryè´Ÿè´£Responseçš„åˆ†å‘ï¼šåœ¨å¾ˆå¤šç½‘ç»œæ¡†æ¶å®ç°ä¸­ï¼Œè¿™éƒ¨åˆ†å¹¶ä¸æ˜¯ç‹¬ç«‹å‡ºæ¥çš„ã€‚è¿™ä¸ªæ¥å£å®šä¹‰äº†ä¸‰ä¸ªAPIï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªç”¨åˆ°äº†ï¼Œè¿™é‡Œç‹¬ç«‹å‡ºæ¥ä¼šä½¿å¾—æ•´ä¸ªResponseçš„å¤„ç†æ›´åŠ æ¸…æ™°ï¼›</li>
</ol>
<p>è¿™ä¸‰ä¸ªéƒ¨åˆ†æ¶‰åŠåˆ°ä¸€ä¸ªè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸã€‚æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/volley-request.png" alt="Volleyè¯·æ±‚æµç¨‹å›¾"></p>
<p>ä¸‹é¢æ˜¯æˆ‘è‡ªå·±ç»˜åˆ¶çš„ä¸€ä¸ªæ›´åŠ è¯¦ç»†çš„æµç¨‹å›¾ï¼š</p>
<p><img src="http://7xktd8.com1.z0.glb.clouddn.com/Volleyæµç¨‹å›¾.png" alt="Volleyè¯·æ±‚è¯¦ç»†æµç¨‹å›¾"></p>
<h3 id="1-2-æ¨ªå‘åˆ‡åˆ†"><a href="#1-2-æ¨ªå‘åˆ‡åˆ†" class="headerlink" title="1.2 æ¨ªå‘åˆ‡åˆ†"></a>1.2 æ¨ªå‘åˆ‡åˆ†</h3><p>é’ˆå¯¹ä¸Šé¢ä¸‰ä¸ªéƒ¨åˆ†çš„ç»†è‡´åˆ‡åˆ†ï¼Œä¸»è¦ä½“ç°åœ¨ç¬¬äºŒæ­¥ï¼ŒåŒ…æ‹¬ï¼š</p>
<ol>
<li>Requestçš„é‡è¯•éƒ¨åˆ†ç‹¬ç«‹å‡ºæ¥æˆä¸ºäº†ç±»RetryPolicyï¼Œæ•´ä¸ªé…ç½®ä¸€ä¸‹å­çµæ´»èµ·æ¥ï¼Œå…·ä½“å¯ä»¥å‚è§:DefaultRetryPolicyï¼ˆæ³¨æ„è¿™é‡Œçš„æ¥å£è®¾è®¡ï¼‰ï¼›</li>
<li>è¯·æ±‚å‘é€æ–¹å¼åšäº†æ‹†åˆ†ï¼ˆä¸»è¦æ˜¯å› ä¸ºHttpURLConnectionçš„Bugï¼‰:å®šä¹‰HttpStackæ¥å£ã€‚æœ€ç»ˆè¿™éƒ¨åˆ†ç­–ç•¥è¢«å°è£…åœ¨Networké‡Œé¢ï¼Œç”±Networkç»Ÿä¸€å®ŒæˆRequestçš„å‘é€æ‰§è¡Œï¼›</li>
<li>ç¼“å­˜å’Œç½‘ç»œè¯·æ±‚çš„æ‹†åˆ†:CacheDispatcherå’ŒNetworkDispatcherã€‚ä¸è¿‡è¿™é‡Œæœ‰ä¸ªè›®æœ‰æ„æ€çš„ç‚¹:ä¸€èˆ¬OOè®¾è®¡æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªDispatcheræ‰€æ“çºµçš„é˜Ÿåˆ—è‚¯å®šæ˜¯å±äºDispatcherçš„ä¸€ä¸ªå±æ€§ï¼Œç„¶åç”±Dispatcherå‘å¤–æš´éœ²æ“çºµé˜Ÿåˆ—çš„æ¥å£ï¼Œè¿™æ ·æœ‰åˆ©äºå°è£…ã€‚ä½†æ˜¯åœ¨Volleyé‡Œé¢ï¼Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—ç›´æ¥æš´éœ²åœ¨RequestQueueä¸­ï¼Œä¸¤ä¸ªDispatcherä¹‹é—´çš„äº¤äº’ä¹Ÿå¹¶ä¸æ˜¯ç›´æ¥å¼•ç”¨å¯¹æ–¹ï¼Œè€Œæ˜¯é€šè¿‡ç›´æ¥æ“ä½œRequestQueueæ¥å®ç°ã€‚è™½ç„¶ç ´åäº†å°è£…ï¼Œä½†æ˜¯ä»å®ç°è®²å´æ›´åŠ ç®€å•ï¼ˆè¿‡åº¦å°è£…ï¼Ÿï¼‰ï¼›</li>
</ol>
<h2 id="äºŒã€Logè°ƒè¯•"><a href="#äºŒã€Logè°ƒè¯•" class="headerlink" title="äºŒã€Logè°ƒè¯•"></a>äºŒã€Logè°ƒè¯•</h2><p>Volleyçš„Logæœºåˆ¶åšçš„æ˜¯æ¯”è¾ƒNiceçš„ï¼šVolleyè‡ªå·±å®ç°äº†Logï¼Œå¹¶ä¸”åœ¨Requestç±»ä¸­æ–°å»ºäº†Logç±»çš„å®ä¾‹ï¼ŒRequestçš„Logä¸Requestå®ä¾‹ç»‘å®šï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼Œåªè¦Requestå­˜åœ¨ï¼Œéƒ½å¯ä»¥è§‚å¯Ÿä¸€ä¸ªRequestå®Œæ•´çš„Logï¼Œå¹¶ä¸”é€šè¿‡Logç¡®è®¤ä»–çš„çŠ¶æ€ä¸ç”Ÿå‘½å‘¨æœŸã€‚ä¸ä¸€èˆ¬ç®€å•çš„Logç›¸æ¯”ï¼Œå°¤å…¶æ˜¯åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œæ˜¾å¾—æ›´åŠ æ¸…æ¥šã€‚</p>
<h2 id="ä¸‰ã€ç»†èŠ‚"><a href="#ä¸‰ã€ç»†èŠ‚" class="headerlink" title="ä¸‰ã€ç»†èŠ‚"></a>ä¸‰ã€ç»†èŠ‚</h2><p>1) ByteArrayPoolï¼šç”¨äºå¤„ç†è¯·æ±‚è¿”å›æ•°æ®æ—¶åˆ†é…Byte[]ï¼ŒèŠ‚çœèµ„æºï¼Œç›¸ä¿¡å¯¹æ•´ä½“çš„æ€§èƒ½å’Œç¨³å®šæ€§éƒ½æœ‰è¾ƒå¤§çš„æå‡ï¼›<br>2) Requestçš„è®¾è®¡ï¼šæš´éœ²äº†ä¸¤ä¸ªæ¥å£ï¼šdeliverResponseå’ŒparseNetworkResponseï¼Œè¿™ä¸¤ä¸ªæ¥å£æš´éœ²å‡ºæ¥èƒ½å¤Ÿè®©å¼€å‘è€…å¯ä»¥å®šåˆ¶è‡ªå·±çš„è¯·æ±‚ç±»å‹ï¼ˆä»£è¡¨æœ‰StringRequestå’ŒJSONRequestï¼‰ï¼ŒåŒæ—¶æœ€åçš„åˆ†å‘ï¼ˆå›è°ƒï¼‰ä¹Ÿå¯ä»¥å®šåˆ¶ï¼Œä½†æ˜¯å¥‡æ€ªçš„æ˜¯è¿™é‡Œæœ‰ç‚¹é”™ä¹±ç ´ç¢ï¼šæ­£å¸¸çš„è¯·æ±‚å›è°ƒæ˜¯å¯ä»¥è¿›è¡Œåˆ†å‘çš„ï¼Œä½†æ˜¯è¯·æ±‚é”™è¯¯å›è°ƒåˆ™æ˜¯å†™æ­»çš„ã€‚å¦‚æœéœ€è¦åƒæ­£å¸¸å›è°ƒä¸€æ ·å¯ä»¥é€šçŸ¥åˆ°å¤šä¸ªç›‘å¬è€…ï¼Œå°±éœ€è¦å†åšä¸€å±‚å¼€å‘ï¼Œä¸çˆ½ï¼›<br>3ï¼‰RetryPolicyä½œä¸ºç‹¬ç«‹çš„ç±»è®¾è®¡ï¼Œä½¿å¾—é‡è¯•æœºåˆ¶å˜å¾—å¼‚å¸¸çµæ´»ï¼ˆå¼€å‘è€…å¯ä»¥è‡ªå·±å®ç°RetryPolicyï¼Œä½†æ˜¯éœ€è¦æ³¨æ„å®ç°ä¸€å®šè¦å‚ç…§DefaultRetryPolicyï¼Œå°¤å…¶æ˜¯retryæ–¹æ³•ï¼‰ã€‚è¿™é‡Œçš„é‡è¯•å®ç°çš„æ¯”è¾ƒç²¾å·§ï¼ˆä½†æ˜¯ä¹Ÿéš¾ä»¥çœ‹æ‡‚ï¼‰ï¼šå…·ä½“çš„å®ç°å¯ä»¥æŸ¥çœ‹BasicNetworkçš„performRequestæ–¹æ³•ï¼Œè¿™é‡Œçš„whileå¾ªç¯åªæœ‰åœ¨è·å¾—æ­£ç¡®è¿”å›å€¼æˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™æ‰ä¼šè¢«æ‰“æ–­ï¼Œå¦åˆ™ä¼šä¸åœå°è¯•ï¼›<br>4ï¼‰RequestFutureçš„å®ç°ä¹Ÿå¾ˆæœ‰æ„æ€ï¼šè¿™ä¸ªç±»æ˜¯å®ç°åŒæ­¥è¯·æ±‚çš„ï¼Œé‡Œé¢æœ‰å°‘è®¸å…³äºå¤šçº¿ç¨‹çš„çŸ¥è¯†ï¼›<br>5ï¼‰NoCacheï¼šè¿™ä¸ªç±»æ˜¯å®ç°æ— ç¼“å­˜æœºåˆ¶çš„ï¼Œä¸ºä¸æ”¯æŒæŸä¸€ç§åŠŸèƒ½æä¾›äº†ä¸€ä¸ªå®ç°æ–¹å¼ï¼ˆå¾ˆæ¸…æ™°ï¼Œå¾ˆèµï¼‰ï¼›  </p>
<h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><p>æ­£å¦‚å…¶åœ¨Developerä¸­æè¿°çš„ä¸€æ ·ï¼ŒVolleyæ¡†æ¶æœ‰å¾ˆå¤šä¼˜ç§€çš„ç‰¹æ€§ã€‚é™¤äº†ä¸Šé¢æ‰€æè¿°çš„ä¸€äº›ç»†èŠ‚ï¼Œå¯¹Httpæ ‡å‡†åè®®çš„å®ç°éƒ½åšå¾—ä¸é”™ï¼Œæ•´ä¸ªæ¡†æ¶éå¸¸ä¸“æ³¨ä¸”çµæ´»ï¼Œçœ‹å…¶æºç ï¼Œå—ç›ŠåŒªæµ…ã€‚åé¢ä¼šç»§ç»­è¡¥å……ä¸€äº›ç»†èŠ‚ç‚¹ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Fragmentçš„äº‹åŠ¡å®ç°ç»†èŠ‚åˆ†æ]]></title>
      <url>http://www.timebridge.space/2015/10/17/Fragment-de-shi-wu-shi-xian-xi-jie-fen-xi/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong>Note:</strong> æœ¬æ–‡é€‚åˆå¯¹ Fragment çš„ç”¨æ³•æ¯”è¾ƒç†Ÿæ‚‰çš„è¯»è€…ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getSupportFragmentManager().beginTransaction()</span><br><span class="line">	                .add(R.id.container, LCFragment.newInstance(<span class="string">"I am new!"</span>)).addToBackStack(<span class="keyword">null</span>).commit();</span><br></pre></td></tr></table></figure>
<p>å¯¹äºç¨æœ‰ç»éªŒçš„Androidå¼€å‘è€…è€Œè¨€ï¼Œä¸Šé¢çš„ä»£ç éƒ½åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œé€šè¿‡è¿™æ®µä»£ç æˆ‘ä»¬å¯ä»¥å‘æŸä¸ªViewGroupä¸­æ·»åŠ ä¸€ä¸ªFragmentã€‚å¯¹äºè¿™æ®µä»£ç ï¼Œæˆ‘æœ‰ä»¥ä¸‹ä¸ªå¥½å¥‡ç‚¹: </p>
<ol>
<li>beginTransaction()åº”è¯¥æ˜¯å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™ä¸ªäº‹åŠ¡æ˜¯ä»€ä¹ˆå«ä¹‰?</li>
<li>addToBackStackæ˜¯å°†è¿™ä¸ªå˜åŒ–æ·»åŠ åˆ°å †æ ˆä¸­å»ï¼Œæˆ‘ä»¬çŸ¥é“Fragmentè¿˜å¯ä»¥Popå †æ ˆï¼Œä»è€Œæ¢å¤å›åˆ°commitä¹‹å‰çš„çŠ¶æ€ï¼Œè¿™æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li>
</ol>
<p>æœ¬æ–‡é€šè¿‡æºç åˆ†æï¼Œè§£æFragmentçš„å·¥ä½œåŸç†ï¼Œé¡ºä¾¿è§£é‡Šæ¸…æ¥šä»¥ä¸Šä¸‰ä¸ªé—®é¢˜ã€‚<a id="more"></a></p>
<blockquote>
<p><strong>PS:</strong> Fragmentæ˜¯3.0ä¹‹åæ‰æ·»åŠ çš„ï¼Œä¸ºäº†æ”¯æŒ3.0ä¹‹å‰çš„åº”ç”¨å¼€å‘ï¼Œgoogleæä¾›äº†supportåŒ…ï¼Œæœ¬æ–‡çš„æºç åˆ†ææ˜¯åŸºäºsupport-v4ç‰ˆæœ¬è¿›è¡Œçš„ã€‚</p>
</blockquote>
<h2 id="å…¥å£å‡½æ•°getSupportFragmentManager"><a href="#å…¥å£å‡½æ•°getSupportFragmentManager" class="headerlink" title="å…¥å£å‡½æ•°getSupportFragmentManager()"></a>å…¥å£å‡½æ•°getSupportFragmentManager()</h2><p>æˆ‘ä»¬æ“ä½œFragmentéƒ½æ˜¯é€šè¿‡FragmentManageræ¥æ‰§è¡Œçš„ï¼Œåœ¨FragmentActivityä¸­æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œå‘ç°å®ƒè¿”å›çš„æ˜¯FragmentManagerImplçš„ä¸€ä¸ªå®ä¾‹ï¼Œæˆ‘ä»¬ç›´æ¥å®šä½åˆ°FragmentManagerç±»ï¼ŒFragmentManagerImplä½œä¸ºå®ƒçš„ä¸€ä¸ªå†…éƒ¨ç±»å­˜åœ¨ã€‚è¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„åˆ‡å…¥ç‚¹ã€‚</p>
<h3 id="é‚£äº›å¸¦æœ‰ç–‘é—®çš„å‡½æ•°ä»¥åŠä¸å¸¸è§çš„API"><a href="#é‚£äº›å¸¦æœ‰ç–‘é—®çš„å‡½æ•°ä»¥åŠä¸å¸¸è§çš„API" class="headerlink" title="é‚£äº›å¸¦æœ‰ç–‘é—®çš„å‡½æ•°ä»¥åŠä¸å¸¸è§çš„API"></a>é‚£äº›å¸¦æœ‰ç–‘é—®çš„å‡½æ•°ä»¥åŠä¸å¸¸è§çš„API</h3><ol>
<li><strong>public abstract Fragment findFragmentById(@IdRes int id);</strong><br>è¯»è€…åº”è¯¥çŸ¥é“ä¸¤ç‚¹:1)å¦‚æœä¸€ä¸ªFragmentåœ¨æ·»åŠ çš„é€‚åˆæ²¡æœ‰æŒ‡å®šidï¼Œåˆ™ä»–çš„idå°±ç­‰äºå®ƒçš„containerIdï¼›2ï¼‰ä¸€ä¸ªViewGroupå¯ä»¥æ·»åŠ å¤šä¸ªFragmentã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ä¸ªæ–¹æ³•åªè¿”å›äº†ä¸€ä¸ªFragmentï¼Œåœ¨å¤šä¸ªFragmentæ‹¥æœ‰åŒæ ·çš„Idçš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯å“ªä¸€ä¸ªï¼Ÿ</li>
<li><strong>POP_BACK_STACK_INCLUSIVE</strong><br>è¿™ä¸ªå‚æ•°è¯»è€…å¯ä»¥é˜…è¯»æ³¨é‡Šï¼Œæˆ–è€…è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™å…ˆè¿›è¡Œäº†è§£ï¼Œæ–‡ç« åé¢ä¼šè®²è¿°ã€‚</li>
<li><strong>public abstract void putFragment(Bundle bundle, String key, Fragment fragment);</strong><br>è¿™ä¸ªå‡½æ•°å¾ˆå°‘ç”¨ï¼Œå…¶æ³¨é‡Šä¸­è¯´â€Put a reference to a fragment in a Bundle.â€ï¼ŒæŸ¥çœ‹Fragmentçš„å®ç°ï¼Œå¾ˆå®¹æ˜“å‘ç°Fragmentæœ¬èº«å¹¶æ²¡æœ‰å®ç°Parcelableæ¥å£ï¼Œnameå®ƒæ˜¯å¦‚ä½•å®ç°å°†Fragmentä¿å­˜åˆ°Bundleçš„å‘¢?</li>
</ol>
<p>è¿™äº›é—®é¢˜å°†åœ¨åé¢çš„åˆ†æä¸­ä¸€ä¸€è§£ç­”ã€‚</p>
<h2 id="äº‹åŠ¡å‡½æ•°beginTransaction"><a href="#äº‹åŠ¡å‡½æ•°beginTransaction" class="headerlink" title="äº‹åŠ¡å‡½æ•°beginTransaction()"></a>äº‹åŠ¡å‡½æ•°beginTransaction()</h2><p>ä»FragmentManagerImplæ‰¾åˆ°è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªBackStackRecordå®ä¾‹ã€‚è¿™ä¸ªç±»å®ç°äº†æ¥å£FragmentTransactionï¼ŒæŸ¥çœ‹æ¥å£å£°æ˜ï¼Œå¾ˆå®¹æ˜“å°±å‘ç°è¿™ä¸ªæ¥å£ä¸­çš„æ–¹æ³•å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„æ“ä½œFragmentçš„æ–¹æ³•ï¼Œæ¯”å¦‚add, remove, è¿˜æœ‰å¾ˆé‡è¦çš„commit()å’ŒcommitAllowingStateLoss()æ–¹æ³•ã€‚è¿™ä¸ªç±»è¿˜å®ç°äº†Runnableæ¥å£ï¼Œå…·ä½“ä½œç”¨åé¢è®²è¿°ã€‚</p>
<h3 id="BackStackRecordç±»"><a href="#BackStackRecordç±»" class="headerlink" title="BackStackRecordç±»"></a>BackStackRecordç±»</h3><p>ç²—ç•¥çš„çœ‹ä¸€ä¸‹BackStackRecordç±»ä»£ç çš„å®ç°ï¼Œå¯ä»¥å¾ˆå®¹æ˜“å‘ç°ï¼Œå®ƒå®šä¹‰äº†8ç§æ“ä½œä»¥åŠä¸€ä¸ªOpå†…éƒ¨ç±»ã€‚</p>
<h4 id="Opç±»å®ç°"><a href="#Opç±»å®ç°" class="headerlink" title="Opç±»å®ç°"></a>Opç±»å®ç°</h4><p>è¿™ä¸ªç±»ç”¨äºå°†Addï¼ŒRemoveç­‰è¿™æ ·çš„æ–¹æ³•è½¬æ¢æˆä¸€ä¸ªä¸ªæ“ä½œå‘½ä»¤ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Op</span> </span>&#123;</span><br><span class="line">	Op next;</span><br><span class="line">	Op prev;</span><br><span class="line">	<span class="keyword">int</span> cmd;</span><br><span class="line">	Fragment fragment;</span><br><span class="line">	<span class="keyword">int</span> enterAnim;</span><br><span class="line">	<span class="keyword">int</span> exitAnim;</span><br><span class="line">	<span class="keyword">int</span> popEnterAnim;</span><br><span class="line">	<span class="keyword">int</span> popExitAnim;</span><br><span class="line">	ArrayList&lt;Fragment&gt; removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»ç±»å±æ€§çœ‹ï¼Œå¯ä»¥çŸ¥é“è¿™ä¸ªç±»è®°å½•äº†å‘½ä»¤ç±»å‹ï¼Œä»¥åŠæ‰§è¡Œå‘½ä»¤æ—¶çš„åŠ¨ç”»(åˆ†ä¸ºpushå’ŒpopåŠ¨ç”»)ï¼Œä»¥åŠæ¶‰åŠåˆ°çš„ç›¸å…³çš„Fragment(æ¯”å¦‚replaceæ–¹æ³•ï¼Œå°±æ¶‰åŠä¸¤ä¸ªFragment)ï¼Œå¦å¤–ä»æœ€å‰é¢ä¸¤ä¸ªå±æ€§çœ‹ï¼ŒOpå°†æˆä¸ºä¸€ä¸ªåŒå‘é“¾è¡¨çš„èŠ‚ç‚¹ï¼šå®é™…ä¸Šå°±åœ¨è¿™ä¸ªç±»å£°æ˜çš„ä¸‹é¢å‡ è¡Œï¼ŒBackStackRecordå°±å£°æ˜äº†mHeadå’ŒmTailä¸¤ä¸ªå˜é‡ï¼Œä½è¯äº†é“¾è¡¨çš„çŒœæµ‹ã€‚</p>
<h4 id="æ“ä½œæ–¹æ³•ç¤ºä¾‹è§£é‡Š"><a href="#æ“ä½œæ–¹æ³•ç¤ºä¾‹è§£é‡Š" class="headerlink" title="æ“ä½œæ–¹æ³•ç¤ºä¾‹è§£é‡Š"></a>æ“ä½œæ–¹æ³•ç¤ºä¾‹è§£é‡Š</h4><p>ä»å®šä¹‰çš„å‘½ä»¤æ¥çœ‹ï¼ŒFragmentManageræ”¯æŒ8ç§æ“ä½œï¼Œæˆ‘ä»¬é€‰æ‹©ä¸€ç§ç®€å•çš„çœ‹(ä¸»è¦æ˜¯ä»£ç ç®€çŸ­ï¼Œæ¯”è¾ƒå¥½è´´)â€”â€”removeã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FragmentTransaction <span class="title">remove</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">	Op op = <span class="keyword">new</span> Op();</span><br><span class="line">	op.cmd = OP_REMOVE;</span><br><span class="line">	op.fragment = fragment;</span><br><span class="line">	addOp(op);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç å¾ˆç®€å•ï¼Œæ— éœ€è¿‡å¤šè§£é‡Šï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹addOpæ–¹æ³•çš„å®ç°:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addOp</span><span class="params">(Op op)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mHead == <span class="keyword">null</span>) &#123;</span><br><span class="line">		mHead = mTail = op;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		op.prev = mTail;</span><br><span class="line">		mTail.next = op;</span><br><span class="line">		mTail = op;</span><br><span class="line">	&#125;</span><br><span class="line">	op.enterAnim = mEnterAnim;</span><br><span class="line">	op.exitAnim = mExitAnim;</span><br><span class="line">	op.popEnterAnim = mPopEnterAnim;</span><br><span class="line">	op.popExitAnim = mPopExitAnim;</span><br><span class="line">	mNumOp++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ®µä»£ç å½»åº•è¯æ˜äº†é“¾è¡¨çš„çŒœæƒ³â€”â€”æ–°æ·»åŠ çš„Opè¢«åŠ å…¥äº†ä¸€ä¸ªé“¾è¡¨ä¸­ã€‚å…¶ä½™çš„æ“ä½œä¹Ÿç±»ä¼¼ï¼Œä¼šè¢«è½¬æ¢æˆä¸€ä¸ªOpå‘½ä»¤ï¼Œæ·»åŠ åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­ã€‚</p>
<h4 id="Commit-æ–¹æ³•"><a href="#Commit-æ–¹æ³•" class="headerlink" title="Commit()æ–¹æ³•"></a><code>Commit()</code>æ–¹æ³•</h4><p>commitå’ŒcommitAllowingStateLoss()ä¸¤ä¸ªæ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨commitInternalæ–¹æ³•ï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸ä¸€æ ·ï¼Œå…¶å®ç°å¦‚ä¸‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">commitInternal</span><span class="params">(<span class="keyword">boolean</span> allowStateLoss)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mCommitted) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"commit already called"</span>);</span><br><span class="line">	mCommitted = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (mAddToBackStack) &#123;</span><br><span class="line">		mIndex = mManager.allocBackStackIndex(<span class="keyword">this</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mIndex = -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	mManager.enqueueAction(<span class="keyword">this</span>, allowStateLoss);</span><br><span class="line">	<span class="keyword">return</span> mIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œcommitä¹‹åè¿”å›çš„å‚æ•°æ˜¯è°ƒç”¨FragmentManagerçš„allocBackStackIndexåè¿”å›çš„å€¼(å…ˆä¸æ¢ç´¢ï¼Œç¨ç­‰è½¬åˆ°FragmentManageråå†è§£é‡Š)ï¼Œä¹‹åè°ƒç”¨FragmentManagerçš„enqueueActionæ–¹æ³•ï¼Œå°†è‡ªå·±ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ä»enqueueActionè¿™ä¸ªæ–¹æ³•åå­—çœ‹ï¼Œå¾ˆå®¹æ˜“å°±èƒ½çŒœåˆ°æ„æ€:å°†è‡ªå·±å‹å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåšä»€ä¹ˆå‘¢ï¼Ÿç­‰å¾…æ‰§è¡Œã€‚</p>
<h4 id="run-æ–¹æ³•"><a href="#run-æ–¹æ³•" class="headerlink" title="run()æ–¹æ³•"></a><code>run()</code>æ–¹æ³•</h4><p>å‰é¢è¯´åˆ°BackStackRecordå®ç°äº†Runnable()æ¥å£ï¼Œä½œç”¨ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®è¿™é‡Œå’Œçº¿ç¨‹æ²¡æœ‰å…³ç³»ï¼Œåªæ˜¯ä¸ºäº†å®ç°è°ƒç”¨ç±»çš„ç»Ÿä¸€æ–¹æ³•æ¥æ‰§è¡Œä¸€ä¸ªåŠ¨ä½œï¼Œè¿™ä¸ªç”¨æ³•å’ŒHandlerçš„post(Runnable)æ–¹æ³•ä¸€æ ·ï¼Œè¯»è€…å¯ä»¥å…ˆæŸ¥é˜…ä¸€ä¸‹FragmentManagerçš„enqueueActionæ–¹æ³•ç­¾åï¼Œå®ƒæ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯Runnableï¼Œè€ŒéBackStackRecordç±»å‹ã€‚</p>
<p>çœ‹ä¸€ä¸‹runæ–¹æ³•å®ç°çš„æ ¸å¿ƒ:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Op op = mHead;</span><br><span class="line"><span class="keyword">while</span> (op != <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="keyword">int</span> enterAnim = state != <span class="keyword">null</span> ? <span class="number">0</span> : op.enterAnim;</span><br><span class="line">	<span class="keyword">int</span> exitAnim = state != <span class="keyword">null</span> ? <span class="number">0</span> : op.exitAnim;</span><br><span class="line">	<span class="keyword">switch</span> (op.cmd) &#123;</span><br><span class="line">		<span class="keyword">case</span> OP_ADD: &#123;</span><br><span class="line">			Fragment f = op.fragment;</span><br><span class="line">			f.mNextAnim = enterAnim;</span><br><span class="line">			mManager.addFragment(f, <span class="keyword">false</span>);</span><br><span class="line">			&#125; <span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//....å…¶ä½™å‘½ä»¤</span></span><br><span class="line">		<span class="keyword">default</span>: &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown cmd: "</span> + op.cmd);</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	op = op.next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mAddToBackStack) &#123;<span class="comment">//åŠ å…¥å †æ ˆ</span></span><br><span class="line">	mManager.addBackStackState(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„é“¾è¡¨æ‰«æï¼Œè¿™é‡Œä»¥OP_ADDå‘½ä»¤ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæœ€ç»ˆå®ç°çš„æ—¶å€™ï¼Œæ˜¯è°ƒç”¨äº†FragmentManagerçš„addFragmentæ–¹æ³•ï¼Œè¯»è€…å¯ä»¥æŸ¥çœ‹åˆ«çš„æ–¹æ³•ï¼Œå¾ˆå®¹æ˜“å°±å‘ç°å…¶ä½™çš„å‘½ä»¤å®ç°ä¹Ÿæ˜¯ç±»ä¼¼ã€‚å†çœ‹æ–¹æ³•æ•´ä½“ï¼Œå°±æ˜¯ä¸€ä¸ªéå†æ‰«æé“¾è¡¨ï¼Œæ‰§è¡ŒèŠ‚ç‚¹Opçš„è¿‡ç¨‹ã€‚</p>
<p>å› æ­¤æ€»ç»“å¦‚ä¸‹ï¼š <strong>ä¸€æ¬¡beginTransaction()æ–¹æ³•ä¼šå¼€å¯ä¸€ä¸ªBackStackRecordå®ä¾‹ï¼Œåç»­å¯¹Fragmentçš„æ“ä½œ(é“¾å¼ç¼–ç¨‹)ä¼šè½¬åŒ–æˆOpèŠ‚ç‚¹ä»¥é“¾è¡¨å½¢å¼å­˜å‚¨åœ¨BackStackRecordä¸­ï¼Œcommit()ä¹‹åå°±äº¤ç»™FragmentManagerè°ƒåº¦æ‰§è¡Œï¼Œè€Œæ‰§è¡Œçš„æ—¶å€™ï¼Œå°±æ˜¯éå†é“¾è¡¨çš„Opå‘½ä»¤ï¼Œå°†å‘½ä»¤æ˜ å°„åˆ°FragmentManagerçš„å‡½æ•°ä¸Šï¼Œæ“ä½œFragmentã€‚</strong></p>
<p>è¯»è€…æ³¨æ„åˆ°è¿™ä¸ªå‡½æ•°çš„æœ€åä¸‰è¡Œä»£ç ï¼Œè¿™é‡Œæ ¹æ®mAddToBackStackåˆ¤æ–­æ˜¯å¦å°†è‡ªå·±æ·»åŠ åˆ°BackStackä¸­å»ï¼ŒmAddToBackStackä»€ä¹ˆæ—¶å€™ä¼šä¸ºtrueå‘¢ï¼Ÿæœç´¢ä¸€ä¸‹ä»£ç å°±ä¼šå‘ç°:è°ƒç”¨addToBackStackä¹‹åå°±ä¼šä¸ºtrueã€‚è€Œä¸”å¾ˆå®¹æ˜“å¾—å‡ºç»“è®ºï¼šåªè¦åœ¨commit()ä¹‹å‰è°ƒç”¨å°±å¯ä»¥ï¼Œä¸ä¸€å®šåœ¨æ“ä½œæœ€åè°ƒç”¨ã€‚ä½†æ˜¯ä¸ºäº†æ˜“è¯»ï¼Œåœ¨æ‰€æœ‰æ“ä½œä¹‹åã€commitä¹‹å‰è°ƒç”¨æ¯”è¾ƒå¥½ã€‚(è¿˜æœ‰ä¸ªç±»ä¼¼çš„æ–¹æ³•disallowAddToBackStackï¼Œä¸€æ—¦è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œå†æ‰ç”¨addToBackStackå°±ä¼šæŠ›å¼‚å¸¸)</p>
<p>FragmentManagerImplä¸­çš„addBackStackStateæ–¹æ³•å®ç°å¦‚ä¸‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addBackStackState</span><span class="params">(BackStackRecord state)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mBackStack == <span class="keyword">null</span>) &#123;</span><br><span class="line">		mBackStack = <span class="keyword">new</span> ArrayList&lt;BackStackRecord&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	mBackStack.add(state);</span><br><span class="line">	reportBackStackChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰çš„äº‹åŠ¡éƒ½è¢«å°è£…ä¸ºä¸€ä¸ªBackStackRecordå¯¹è±¡å­˜å‚¨åˆ°â€æ ˆâ€ä¸­(æ­¤å¤„æ ˆæ˜¯ç”¨Listæ¨¡æ‹Ÿçš„)ã€‚</p>
<h3 id="BackStackRecordçš„æ‰§è¡Œ"><a href="#BackStackRecordçš„æ‰§è¡Œ" class="headerlink" title="BackStackRecordçš„æ‰§è¡Œ"></a>BackStackRecordçš„æ‰§è¡Œ</h3><p>å‰é¢è®²åˆ°ï¼Œcommitä¹‹åï¼Œä¼šæŠŠBackStackRecordå‹å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­å»ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueAction</span><span class="params">(Runnable action, <span class="keyword">boolean</span> allowStateLoss)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!allowStateLoss) &#123;</span><br><span class="line">		checkStateLoss();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mDestroyed || mActivity == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Activity has been destroyed"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (mPendingActions == <span class="keyword">null</span>) &#123;</span><br><span class="line">			mPendingActions = <span class="keyword">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		mPendingActions.add(action);</span><br><span class="line">		<span class="keyword">if</span> (mPendingActions.size() == <span class="number">1</span>) &#123;</span><br><span class="line">			mActivity.mHandler.removeCallbacks(mExecCommit);</span><br><span class="line">			mActivity.mHandler.post(mExecCommit);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨FragmentManagerä¸­æœ‰ä¸€ä¸ªListç»´æŠ¤ç€æ‰€æœ‰å¾…æ‰§è¡Œçš„Runnableå¯¹è±¡ï¼Œå½“ç„¶ä¹ŸåŒ…å«BackStackRecordå¯¹è±¡ï¼Œæ¯æ¬¡æ‰§è¡ŒenqueueActionï¼Œéƒ½ä¼šå¾€Listä¸­åŠ å…¥ä¸€ä¸ªenqueueActionï¼Œå¦‚æœæ·»åŠ ä¹‹åListçš„å¤§å°ä¸º1(è¡¨æ˜ä¹‹å‰Listä¸­æ˜¯ç©ºçš„)ï¼Œé‚£ä¹ˆä¼šåœ¨ä¸»Activityçš„Handlerä¸­å‘ä¸€æ¡å…¨æ–°çš„mExecCommitå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œåªæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼šexecPendingActionsã€‚</p>
<p>è¿™ä¸ªå‡½æ•°ä¼šåšä»€ä¹ˆå‘¢ï¼Ÿè¯»è€…çœ‹ä¸€ä¸‹ä»£ç (æ¯”è¾ƒé•¿ï¼Œä¸è´´äº†)ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å°†Listä¸­çš„Runnableå¯¹è±¡éƒ½ç§»å…¥mTmpActionsæ•°ç»„ä¸­ï¼Œæ¸…ç©ºListï¼Œæ¸…ç©ºHandlerä¸­çš„mExecCommitå‘½ä»¤â€”â€”è¡¨ç¤ºä¸»çº¿ç¨‹ä¸Šå®Œæ•´çš„å¯¹å¾…æ‰§è¡Œçš„Runnableå¯¹è±¡è¿›è¡Œäº†ä¸€æ¬¡æ‰§è¡Œæ“ä½œï¼›</li>
<li>è°ƒç”¨æ¯ä¸ªRunnableå¯¹è±¡çš„run()æ–¹æ³•æ‰§è¡Œ(è¿˜è®°å¾—BackStackRecordçš„run()æ–¹æ³•å—ï¼Ÿ)ã€‚</li>
</ol>
<p>é€»è¾‘éå¸¸ç®€å•ã€‚è¿™æ ·ä¸€æ¬¡æ‰§è¡Œå®Œæˆï¼Œå°±å¯ä»¥å®Œæˆä¸€æ¬¡äº‹åŠ¡æäº¤äº†ã€‚ä¸€äº›æ–¹æ³•æ¯”å¦‚popBackStackéƒ½è¢«æ‰“ä¸Šäº†asynchronousçš„æ ‡è®°ï¼Œå°±æ˜¯è¿™ä¸ªåŸå› ï¼šå®ƒä»¬ä¸æ˜¯ç«‹åˆ»æ‰§è¡Œçš„ï¼Œéƒ½æ˜¯å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªActionï¼Œç­‰å¾…ä¸»çº¿ç¨‹å»è°ƒåº¦æ‰§è¡Œ(è¯•æƒ³ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œå…¶ä½™çš„ä¸€äº›æ“ä½œï¼Œåˆ™è¿™äº›äº‹åŠ¡å¿…é¡»ç­‰å¾…å®ƒä»¬æ‰§è¡Œå®Œæˆä¹‹åæ‰æœ‰æœºä¼šæ‰§è¡Œ)ã€‚</p>
<p>åœ¨FragmentManagerä¸­ä¹Ÿæœ‰ä¸€ç»„æ–¹æ³•ï¼Œå®ƒä»¬åé¢è·Ÿç€Immediateï¼Œè¡¨æ˜æ˜¯ç«‹å³æ‰§è¡Œçš„ã€‚é‚£æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°å¦å¤–ä¸€ä¸ªå‡½æ•°:executePendingTransactionsã€‚è¿™ä¸ªå‡½æ•°å…¶å®æ˜¯ç›´æ¥è°ƒç”¨äº†execPendingActionsï¼Œè€Œæ²¡æœ‰ç»è¿‡Handlerï¼Œå› æ­¤å¯ä»¥ç«‹å³æ‰§è¡Œï¼Œå¼€å‘äººå‘˜åœ¨å¤–éƒ¨ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥å‡½æ•°ã€‚æ­£å¦‚æ–¹æ³•æ³¨é‡Šä¸­æ‰€å†™çš„ï¼šè¿™ä¸ªæ–¹æ³•åªèƒ½ä»ä¸»çº¿ç¨‹è°ƒç”¨ã€‚</p>
<h2 id="å›é€€â€”â€”äº‹åŠ¡å‡ºæ ˆ"><a href="#å›é€€â€”â€”äº‹åŠ¡å‡ºæ ˆ" class="headerlink" title="å›é€€â€”â€”äº‹åŠ¡å‡ºæ ˆ"></a>å›é€€â€”â€”äº‹åŠ¡å‡ºæ ˆ</h2><p>å‰é¢è®²è¿°äº†FragmentManagerå¦‚ä½•æ‰§è¡Œäº‹åŠ¡ä»¥åŠå­˜å‚¨äº‹åŠ¡çš„ã€‚é‚£å…·ä½“çš„å›é€€å‘¢ï¼Ÿ</p>
<h3 id="äº‹åŠ¡å‡ºæ ˆ"><a href="#äº‹åŠ¡å‡ºæ ˆ" class="headerlink" title="äº‹åŠ¡å‡ºæ ˆ"></a>äº‹åŠ¡å‡ºæ ˆ</h3><p>FragmentActiivtyä¸­å†™äº†ä¸€ä¸ªæ–¹æ³•ï¼Œç»†èŠ‚å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">this</span>.mFragments.popBackStackImmediate()) &#123;</span><br><span class="line">		<span class="keyword">this</span>.finish();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åŸæ¥å›é€€é”®é»˜è®¤çš„è¡Œä¸ºå°±æ˜¯å…³é—­å½“å‰ç•Œé¢ï¼Œè¿™é‡Œåšäº†ä¸€å±‚æ‹¦æˆªï¼šæŸ¥çœ‹popBackStackImmediateæ–¹æ³•çš„è¿”å›å€¼ã€‚</p>
<h3 id="popBackStackStateæ–¹æ³•"><a href="#popBackStackStateæ–¹æ³•" class="headerlink" title="popBackStackStateæ–¹æ³•"></a>popBackStackStateæ–¹æ³•</h3><p>popBackStackStateæ–¹æ³•æœ€ç»ˆè°ƒç”¨äº†popBackStackStateæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æä¸ºé‡è¦ï¼Œå¯ä»¥ä»ä¸­å¾—å‡ºå¯¹ä¹‹å‰ä¸€äº›å‚æ•°è¯¦ç»†çš„è§£é‡Šï¼Œä¸‹é¢åˆ†ç‰‡æ®µè§£é‡Šï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (name == <span class="keyword">null</span> &amp;&amp; id &lt; <span class="number">0</span> &amp;&amp; (flags &amp; POP_BACK_STACK_INCLUSIVE) == <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">int</span> last = mBackStack.size() - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (last &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">final</span> BackStackRecord bss = mBackStack.remove(last);</span><br><span class="line">	SparseArray&lt;Fragment&gt; firstOutFragments = <span class="keyword">new</span> SparseArray&lt;Fragment&gt;();</span><br><span class="line">	SparseArray&lt;Fragment&gt; lastInFragments = <span class="keyword">new</span> SparseArray&lt;Fragment&gt;();</span><br><span class="line">	bss.calculateBackFragments(firstOutFragments, lastInFragments);</span><br><span class="line">	bss.popFromBackStack(<span class="keyword">true</span>, <span class="keyword">null</span>, firstOutFragments, lastInFragments);</span><br><span class="line">	reportBackStackChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é¦–å…ˆï¼Œæ‰§è¡Œè¿™ä¸ªIfçš„æ¡ä»¶æ˜¯nameå’Œidå€¼éƒ½éæ³•å¹¶ä¸”Flag POP_BACK_STACK_INCLUSIVEæ²¡æœ‰è¢«è®¾ç½®æ‰ä¼šå»æ‰§è¡Œï¼Œå³é»˜è®¤è¡Œä¸ºï¼Œæ˜¯å¼¹å‡ºæœ€ä¸Šå±‚ä¸€ä¸ªã€‚ä»æ–¹æ³•ç‰‡æ®µå¯ä»¥çœ‹å‡ºï¼Œå–å‡ºmBackStackä¸­çš„æœ€åä¸€ä¸ªäº‹åŠ¡æ“ä½œè®°å½•ï¼Œè°ƒç”¨calculateBackFragmentsæ–¹æ³•ã€‚</p>
<p>calculateBackFragmentsæ–¹æ³•çš„ç›®çš„æ˜¯æŸ¥çœ‹å“ªäº›Fragmentéœ€è¦è¢«ç§»é™¤ã€å“ªäº›éœ€è¦è¢«æ·»åŠ (ä¸ä¹‹å‰çš„Opå‘½ä»¤ç›¸åï¼Œæ¯”å¦‚ä¹‹å‰æ˜¯Addï¼Œç°åœ¨å°±åº”è¯¥è¢«è®¡å…¥ç§»é™¤é˜Ÿåˆ—)ï¼Œä¼ å…¥å‚æ•°æ˜¯ä¸¤ä¸ªSparseArrayï¼Œæ‰§è¡Œä¸­æ¶‰åŠåˆ°ä¸¤ä¸ªå‡½æ•°setLastInå’ŒsetFirstOutï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ²¡æœ‰ç‰¹åˆ«çš„é€»è¾‘ï¼Œå°±æ˜¯ä»¥containerIdä¸ºé”®å€¼å°†éœ€è¦æ·»åŠ å’Œç§»é™¤çš„fragmentä¿å­˜åˆ°SparseArrayä¸­ã€‚</p>
<blockquote>
<p><strong>Note:</strong> ä»¥containerIdä¸ºé”®å€¼ä¼šæœ‰é—®é¢˜ï¼ŒåŸå› åŒæ ·æ˜¯æ¥è‡ªäºä¸€ä¸ªcontainerä¸­ä¼šå­˜åœ¨å¤šä¸ªFragmentã€‚æ¯”å¦‚setFirstOutå®ç°çš„æ—¶æ—¶å€™ï¼Œä¼šåˆ¤æ–­fç§»é™¤é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨ä»¥containerä¸ºé”®å€¼çš„fragmentï¼Œæ²¡æœ‰çš„è¯æ‰ä¼šå»ç§»é™¤ã€‚è¿™æ„å‘³ç€ï¼šä¸€æ¬¡äº‹åŠ¡å›é€€æ˜¯ä¸èƒ½ä»ä¸€ä¸ªcontainerä¸­ç§»é™¤ä¸¤ä¸ªFragmentçš„ã€‚ä½†æ˜¯åœ¨æ·»åŠ çš„æ—¶å€™å´å¯ä»¥ï¼Œä¸¤ç›¸çŸ›ç›¾ã€‚<br>ä¸è¿‡ä¸ç”¨æ‹…å¿ƒå›é€€æ ˆä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸ºå®é™…ä¸Šå¹¶ä¸æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªSparseArrayæ¥è¿›è¡Œå›é€€çš„ï¼Œè¿™ä¸ªè®¡ç®—ç»“æœæœ€ç»ˆæ˜¯ä¸ºäº†å¾—åˆ°transitionStyleå’Œtransitionï¼Œè¿™è¾¹æ˜¯å¦å¤–ä¸€æ¡çº¿ï¼Œä¸åšç»†è®²ã€‚</p>
</blockquote>
<h4 id="popFromBackStackæ–¹æ³•å®ç°"><a href="#popFromBackStackæ–¹æ³•å®ç°" class="headerlink" title="popFromBackStackæ–¹æ³•å®ç°"></a>popFromBackStackæ–¹æ³•å®ç°</h4><p>è®¡ç®—å¥½ä¹‹åï¼Œå°±ä¼šè°ƒç”¨BackStackRecordçš„popFromBackStackæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å‰é¢å°åŠæ®µæ˜¯è®¡ç®—transitionStyleå’Œtransitionï¼Œåé¢åŠæ®µå°±æ¯”è¾ƒæœ‰æ„æ€äº†:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TransitionState <span class="title">popFromBackStack</span><span class="params">(<span class="keyword">boolean</span> doStateMove, TransitionState state,</span></span></span><br><span class="line"><span class="function"><span class="params">	SparseArray&lt;Fragment&gt; firstOutFragments, SparseArray&lt;Fragment&gt; lastInFragments)</span> </span>&#123;</span><br><span class="line">    Op op = mTail;</span><br><span class="line">	<span class="keyword">while</span> (op != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> popEnterAnim = state != <span class="keyword">null</span> ? <span class="number">0</span> : op.popEnterAnim;</span><br><span class="line">		<span class="keyword">int</span> popExitAnim= state != <span class="keyword">null</span> ? <span class="number">0</span> : op.popExitAnim;</span><br><span class="line">		<span class="keyword">switch</span> (op.cmd) &#123;</span><br><span class="line">		<span class="keyword">case</span> OP_ADD: &#123;</span><br><span class="line">			Fragment f = op.fragment;</span><br><span class="line">			f.mNextAnim = popExitAnim;</span><br><span class="line">			mManager.removeFragment(f,</span><br><span class="line">			FragmentManagerImpl.reverseTransit(transition), transitionStyle);</span><br><span class="line">			&#125; <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> OP_REMOVE: &#123;</span><br><span class="line">			Fragment f = op.fragment;</span><br><span class="line">			f.mNextAnim = popEnterAnim;</span><br><span class="line">			mManager.addFragment(f, <span class="keyword">false</span>);</span><br><span class="line">			&#125; <span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//....</span></span><br><span class="line">		<span class="keyword">default</span>: &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown cmd: "</span> + op.cmd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		op = op.prev;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (mIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		mManager.freeBackStackIndex(mIndex);</span><br><span class="line">		mIndex = -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ®µä»£ç å€’å™éå†ä¹‹å‰çš„Opé“¾è¡¨ï¼Œä»¥ç›¸åçš„æ–¹å¼æ‰§è¡ŒOpé“¾è¡¨ã€‚ä¹‹å‰è¯´åˆ°BackStackRecordä¸­å®šä¹‰äº†8ä¸­Fragmentæ“ä½œï¼Œè¿™8ç§æ“ä½œéƒ½æœ‰äº’é€†æ€§ï¼Œæ¯”å¦‚OP_ADDå’ŒOP_REMOVEå°±æ˜¯ç›¸åçš„ï¼ŒOP_HIDEå’ŒOP_SHOWä¹Ÿæ˜¯ç›¸åçš„ï¼Œè€ŒOP_REPLACEåˆ™æ˜¯ä¸€ä¸ªOP_ADDå’Œä¸€ç»„OP_REMOVEçš„ç»„åˆã€‚å› æ­¤ä»è¿™ä¸ªæ–¹æ³•çš„å®ç°çœ‹ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªé€†è¿‡ç¨‹ï¼Œæ¯”å¦‚ä¹‹å‰çš„Opå‘½ä»¤æ‰§è¡Œçš„æ˜¯OP_ADDï¼Œè¿™é‡Œåªéœ€è¦å°†è¿™ä¸ªOpä¸­è®°å½•çš„Fragmentç§»é™¤å°±å¥½äº†ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ€»èƒ½é¡ºåˆ©çš„å›é€€æ ˆã€‚</p>
<h4 id="popBackStackStateæ–¹æ³•ååŠæ®µ"><a href="#popBackStackStateæ–¹æ³•ååŠæ®µ" class="headerlink" title="popBackStackStateæ–¹æ³•ååŠæ®µ"></a>popBackStackStateæ–¹æ³•ååŠæ®µ</h4><p>ç»§ç»­å›åˆ°popBackStackStateæ–¹æ³•ï¼Œå‰é¢åªè®²äº†ä¸€åŠï¼Œè¿˜æœ‰ä¸€ä¸ªIfåˆ†æ”¯æ²¡æœ‰è®²è¿°ï¼Œæ‰§è¡Œæ¡ä»¶æ˜¯ï¼šnameæˆ–è€…idä¸ä¸ºnullå…¶ä¸­ä¸€ä¸ªæœ‰æ•ˆæˆ–è€…è®¾ç½®äº†Flag POP_BACK_STACK_INCLUSIVEã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ç¨‹åºæ˜¯å¦‚ä½•è§£é‡ŠPOP_BACK_STACK_INCLUSIVEè¿™ä¸ªFlagçš„ï¼Œå…·ä½“ç»†èŠ‚ä¸è§£é‡Šï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼šå¯¹äºpopBackStackæ–¹æ³•ï¼Œå¦‚æœint(flag)ä¸ºPOP_BACK_STACK_INCLUSIVEï¼Œåˆ™åœ¨è¿™ä¸ªnameæˆ–è€…idæ ‡è¯†çš„BackStackRecordä»¥ä¸Šçš„BackStackRecordåŒ…æ‹¬è‡ªèº«éƒ½ä¼šè¢«å¼¹å‡ºï¼Œå¦åˆ™ï¼Œè‡ªèº«ä¸ä¼šè¢«å¼¹å‡ºï¼Œåªæœ‰è¯¥Fragmentä»¥ä¸Šçš„Fragemntä¼šè¢«å¼¹å‡ºã€‚</p>
<p>nameçš„å«ä¹‰å¾ˆæ¸…æ¥šï¼Œå› ä¸ºaddToBackStackå°±è¦æ±‚ä¼ å…¥ä¸€ä¸ªStringï¼Œä½†æ˜¯idå‘¢ï¼Ÿè¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€è¡Œä»£ç :<br><strong>if (id &gt;= 0 &amp;&amp; id == bss.mIndex)</strong><br>æ˜¯çš„ï¼ŒmIndexå…¶å®æ˜¯BackStackRecordåœ¨æ ˆä¸­çš„ä½ç½®ï¼é‚£ä¹ˆè¿™ä¸ªmIndexæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„å‘¢ï¼Ÿæˆ‘ä»¬å›é€€åˆ°commitInternalä¸­ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•å®ç°ä¸­æ‰¾åˆ°ï¼Œåœ¨æäº¤ä¸€ä¸ªäº‹åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœéœ€è¦æ·»åŠ åˆ°äº‹åŠ¡å›é€€æ ˆï¼Œåˆ™ä¼šè°ƒç”¨FragmentManagerçš„allocBackStackIndexæ–¹æ³•å»åˆ†é…ä¸€ä¸ªIndexã€‚è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¹Ÿæ¯”è¾ƒæœ‰æ„æ€ã€‚ä¸ºäº†é˜²æ­¢è¯»è€…åˆ†å¿ƒï¼Œæ­¤å¤„ä¸æ‹“å±•è®²è¿°ï¼Œè¯»è€…åªéœ€è¦çŸ¥é“mIndexæ˜¯BackStackRecordåœ¨æ ˆä¸­çš„ä½ç½®å°±å¥½ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å‘äº‹åŠ¡æ ˆä¸­æ·»åŠ äº‹åŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªStringä½œä¸ºæ­¤æ¬¡æ·»åŠ çš„æ ‡è®°ï¼Œå½“æˆ‘ä»¬å›é€€çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ ‡è®°æŒ‡å®šå›é€€åˆ°æŸä¸ªå†å²çŠ¶æ€ï¼Œæˆ–è€…ï¼Œç›´æ¥é€šè¿‡ä½ç½®å»æŒ‡å®šã€‚</p>
<p>idæ˜¯å”¯ä¸€çš„ï¼Œä¸€ä¸ªä½ç½®ä¸Šåªèƒ½å­˜å‚¨ä¸€ä¸ªBackStackRecordï¼Œä½†æ˜¯nameå´ä¸å”¯ä¸€ï¼Œå¤šä¸ªBackStackRecordå¯ä»¥æŒ‡å®šåŒä¸€ä¸ªBackStackRecordï¼Œå¦‚æœæˆ‘æŒ‡å®šä¸€ä¸ªnameå»å¼¹å‡ºï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿå¼¹å‡ºæ ˆçš„æ—¶å€™ï¼Œé¦–å…ˆæ‰¾åˆ°nameæˆ–è€…idåŒ¹é…çš„é‚£ä¸ªBackStackRecordï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œé€€å‡ºæ“ä½œã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå¹¶ä¸”è®¾ç½®äº†POP_BACK_STACK_INCLUSIVEï¼Œä¼šç»§ç»­å‘ä¸‹æœç´¢ï¼Œç›´åˆ°æœ€åä¸€ä¸ªnameæˆ–è€…idåŒ¹é…çš„BackStackRecordæ‰ä¼šç»“æŸã€‚æ¥ä¸‹å»åé¢çš„å¤„ç†å°±å’Œä¹‹å‰çš„ç±»ä¼¼äº†ã€‚</p>
<p>ä»¥ä¸Šï¼Œæ˜¯äº‹åŠ¡å›é€€æ—¶çš„é€»è¾‘ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç»¼ä¸Šæ‰€è¿°ï¼Œç°åœ¨å¯ä»¥è§£ç­”ä¸€å¼€å§‹æå‡ºçš„é—®é¢˜ã€‚ç¬¬3ä¸ªé—®é¢˜åˆ™åœ¨å‰é¢å·²ç»è¯¦ç»†æè¿°ã€‚</p>
<p>ç¬¬1ä¸ªé—®é¢˜ï¼šFragmentçš„äº‹åŠ¡å’Œæ•°æ®åº“ä¸­çš„äº‹åŠ¡æ˜¯ä¸¤ä¸ªæ¦‚å¿µã€‚è™½ç„¶å®é™…ä¸Šå®ƒä¹Ÿæ˜¯å¤šä¸ªåŸå­æ“ä½œ(Op)çš„ç»„åˆï¼Œä½†æ˜¯å¹¶ä¸å­˜åœ¨å…¶ä¸­ä¸€ä¸ªOpå¤±è´¥ä¹‹åï¼Œå›é€€å…¶ä½™Opçš„æ§åˆ¶ä¿è¯ï¼Œè¿™ä¸ªäº‹åŠ¡ç›®çš„æ˜¯ä¸ºäº†ç»„åˆä¸€å †é›¶æ•£çš„æ“ä½œï¼Œä»¥ä¾¿äºåœ¨ä¸€æ¬¡æäº¤ä¸­å®Œæˆå¤æ‚çš„Fragmentåˆ‡æ¢ã€‚è€Œå¯¹äºæ•°æ®åº“è€Œè¨€ï¼Œäº‹åŠ¡å¤±è´¥ä¹‹åæ˜¯éœ€è¦å›é€€åˆ°æ‰§è¡Œä¹‹å‰çš„æ ·å­çš„ï¼ŒFragmentçš„äº‹åŠ¡å¤±è´¥å¯ä»¥è®¤ä¸ºç•Œé¢é€€å‡ºï¼Œå®ƒæ²¡æœ‰æŒä¹…åŒ–ä¿å­˜ä»»ä½•æ•°æ®ï¼Œä¹Ÿæ²¡æœ‰åç»­çš„æ“ä½œä¼šå—æ­¤æ¬¡äº‹åŠ¡å¤±è´¥çš„å½±å“ï¼Œå› æ­¤ä¸éœ€è¦åšå‡ºä¿è¯ã€‚</p>
<p>å…³äºFragmentçš„äº‹åŠ¡ï¼Œè¿˜æœ‰ä¸€äº›ç»†èŠ‚æ²¡æœ‰å»è§£è¯»ï¼Œä½†æ˜¯å¤§è‡´çš„é€»è¾‘åœ¨æ­¤ã€‚è¯»è€…å¦‚æœ‰è¡¥å……ï¼Œæ¬¢è¿å›å¤ï¼Œå¦‚å‘ç°ç–‘é—®ï¼Œæ¬¢è¿æ–§æ­£ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Androidçš„æ•°æ®æ¢å¤(äºŒ)]]></title>
      <url>http://www.timebridge.space/2015/10/17/Android-de-shu-ju-hui-fu-er/</url>
      <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ€è¿‘åŒäº‹åœ¨å¼€å‘ä¸­ä½¿ç”¨åˆ°FragmentStatePagerAdapterï¼Œåœ¨æ•°æ®æ¢å¤çš„æ—¶å€™å‡ºç°äº†éå¸¸å¥‡æ€ªçš„ç°è±¡ï¼Œå› æ­¤ç ”ç©¶äº†ä¸€ä¸‹Fragmentçš„æ•°æ®æ¢å¤æœºåˆ¶ã€‚</p>
<p><em>æœ¬æ–‡ä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜</em></p>
<ol>
<li>Fragmentå¦‚ä½•è¿›è¡Œæ•°æ®æ¢å¤å’Œä¿å­˜ï¼Ÿ</li>
<li>Fragmentåˆ°åº•æ˜¯å•¥ï¼Ÿ</li>
<li>Fragmentçš„ä½¿ç”¨æ³¨æ„äº‹é¡¹</li>
</ol>
<h2 id="Fragmentå¦‚ä½•è¿›è¡Œæ•°æ®æ¢å¤å’Œä¿å­˜"><a href="#Fragmentå¦‚ä½•è¿›è¡Œæ•°æ®æ¢å¤å’Œä¿å­˜" class="headerlink" title="Fragmentå¦‚ä½•è¿›è¡Œæ•°æ®æ¢å¤å’Œä¿å­˜"></a>Fragmentå¦‚ä½•è¿›è¡Œæ•°æ®æ¢å¤å’Œä¿å­˜</h2><p>å’ŒActiivtyä¸€æ ·ï¼ŒFragmentä¹Ÿæœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸”ä¸Activityçš„ç”Ÿå‘½å‘¨æœŸç´§å¯†ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸€èˆ¬ä¸€ä¸ªé¡µé¢è¦åšæ•°æ®ä¿å­˜å’Œæ¢å¤éƒ½ä¼šæ¶‰åŠåˆ°Fragmentï¼Œæˆ‘ä»¬åœ¨<a href="http://muzileecoding.com/blog/2015/08/01/androidde-shu-ju-hui-fu/" target="_blank" rel="noopener">Androidçš„æ•°æ®æ¢å¤ï¼ˆä¸€ï¼‰</a>ä¸­è§£é‡Šäº†Activityæ˜¯å¦‚ä½•ä¿å­˜çŠ¶æ€çš„ï¼Œé‚£ä¹ˆFragmentæ˜¯å¦ä¸€æ ·å‘¢ï¼Ÿ<a id="more"></a></p>
<p><a href="http://muzileecoding.com/blog/2015/08/01/androidde-shu-ju-hui-fu/" target="_blank" rel="noopener">Androidçš„æ•°æ®æ¢å¤ï¼ˆä¸€ï¼‰</a>ä¸­è¯´åˆ°: onSaveInstanceStateæ–¹æ³•æ˜¯æ•´ä¸ªActivityä¿å­˜æ•°æ®çš„å‡ºå‘ç‚¹ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</span><br><span class="line">	outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</span><br><span class="line">	Parcelable p = mFragments.saveAllState();</span><br><span class="line">	<span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">		outState.putParcelable(FRAGMENTS_TAG, p);</span><br><span class="line">	&#125;</span><br><span class="line">	getApplication().dispatchActivitySaveInstanceState(<span class="keyword">this</span>, outState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç çš„3-6è¡Œå°±æ¶‰åŠåˆ°Fragmentçš„æ•°æ®ä¿å­˜ã€‚æˆ‘ä»¬çœ‹åˆ°mFragmenté€šè¿‡saveAllStateæ–¹æ³•è¿”å›ä¸€ä¸ªParcelableå¯¹è±¡ï¼Œå¹¶æœ€ç»ˆå­˜å…¥outStateä¸­å»äº†ï¼ŒmFragmentsæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å£°æ˜ç±»å‹ä¸ºï¼šFragmentManagerImplã€‚é¡¾åæ€ä¹‰ï¼Œæ˜¯FragmentManagerçš„å®ç°ç±»å‹ã€‚</p>
<blockquote>
<p>ã€Noteã€‘è¯»è€…è¯·æ‰“å¼€Android Studioï¼ŒæŸ¥çœ‹FragmentManagerçš„æºç ï¼Œç‰ˆæœ¬æ˜¯support-v4ã€‚</p>
</blockquote>
<p>ç”±äºFragmentManagerçš„ä»£ç éå¸¸é•¿ï¼Œè€Œä¸”ç›¸äº’ä¹‹é—´è”ç³»æ¯”è¾ƒç´§å¯†ï¼Œå› æ­¤å°†æ ‡æ³¨è¿‡çš„ä»£ç ä¼ åˆ°äº†æœåŠ¡å™¨ï¼š<a href="http://7xktd8.com1.z0.glb.clouddn.com/FragmentManager.java" target="_blank" rel="noopener">FragmentManager.java</a>ã€ <a href="http://7xktd8.com1.z0.glb.clouddn.com/Fragment.java" target="_blank" rel="noopener">Fragment.java</a>ã€‚<br>è¯»è€…å¯ä»¥ç»“åˆæºç ä»¥åŠæ ‡æ³¨è¿›è¡Œç†è§£ã€‚å»ºè®®å°±ä»FragmentManager.saveAllState()å‡½æ•°å…¥æ‰‹ã€‚</p>
<blockquote>
<p>ã€Noteã€‘ä»£ç å¾ˆå¤šéå¸¸é•¿ï¼Œæœ‰éƒ¨åˆ†ç±»ä¹Ÿæ²¡æœ‰è´´å‡ºæ¥ï¼Œä½†è¿™ä¸¤ä¸ªç±»å·²ç»å¯ä»¥è®©è¯»è€…çŸ¥é“Fragmentçš„ä¿å­˜è¿‡ç¨‹äº†ã€‚</p>
</blockquote>
<p>è¿™é‡Œé‡ç‚¹é˜è¿°å‡ ä»¶äº‹æƒ…:</p>
<ol>
<li>ä¸€ä¸ªActivityå¯¹åº”ç€ä¸€ä¸ªFragmentManagerï¼Œæ¯ä¸€ä¸ªè¢«æ·»åŠ çš„Fragmentéƒ½ä¼šè¢«è®°å½•åœ¨mActiveä¸­ï¼Œæ˜¾ç¤ºç§»é™¤çš„æ—¶å€™ä¼šå°†è¯¥ä½ç½®è®°å½•ä¸ºnullï¼ŒmAddedåˆ™è®°å½•ç€å½“å‰æ·»åŠ åˆ°å®¹å™¨é‡Œé¢çš„Fragment(mActiveè®°å½•è¿™æ‰€æœ‰è¢«addçš„Fragmentï¼ŒmAddedåˆ™è®°å½•ç€æ‰€æœ‰è¢«addå’Œattachçš„Fragmentï¼Œattachåçš„Fragmentä¼šè¢«FragmentManagerç®¡ç†ï¼Œä½†ä¸ä¼šåœ¨ViewTreeä¸­);</li>
<li>ä¿å­˜çŠ¶æ€çš„æ—¶å€™ï¼ŒçŠ¶æ€ä¿å­˜æ˜¯ä¼šéå†mActiveé‡Œé¢çš„Fragmentï¼ŒåŒæ—¶ä¹Ÿä¼šä»¥ä¸‹æ ‡å½¢å¼ä¿å­˜mAddedé‡Œé¢çš„å…ƒç´ ï¼Œæ‰€æœ‰æ“ä½œè®°å½•çš„BackStackRecordä¹Ÿä¼šè¢«ä¿å­˜ä¸‹æ¥ï¼šç›®çš„æ˜¯å¯ä»¥æ¢å¤æ‰€æœ‰Activeçš„Fragmentçš„çŠ¶æ€ä»¥åŠä¹‹å‰æ‰€åšçš„TransactionåŠ¨ä½œã€‚æ•°æ®éƒ½è¢«ä¿å­˜åœ¨FragmentManagerStateä¸­(æ­¤å¤„åˆ†æçš„æ—¶å€™å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œä»ä»£ç çœ‹ï¼ŒmActiveçš„å…ƒç´ æ˜¯mAddedå…ƒç´ çš„å­é›†ï¼Œå½“ä¸€ä¸ªfragment detachã€attachã€detachä¸€éä¹‹åï¼Œä¿å­˜mAddedä¸‹æ ‡å°±ä¼šcrash);</li>
<li>æ¢å¤çš„æ—¶å€™åˆ™æŒ‰ç…§ä¿å­˜çš„æ•°æ®é€æ­¥æ¢å¤ï¼Œå¾ˆé‡è¦çš„ä¸€ä¸ªåŠ¨ä½œæ˜¯åœ¨Activityçš„onCreateæ–¹æ³•ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å¦‚ä¸‹è°ƒç”¨ï¼š  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (savedInstanceState != <span class="keyword">null</span>) &#123;</span><br><span class="line">		Parcelable p = savedInstanceState.getParcelable(FRAGMENTS_TAG);</span><br><span class="line">		mFragments.restoreAllState(p, mLastNonConfigurationInstances != <span class="keyword">null</span></span><br><span class="line">		                    ? mLastNonConfigurationInstances.fragments : <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">mFragments.dispatchCreate();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ç¬¬3è¡Œä¼šrestoreä¿å­˜çš„Fragmentçš„çŠ¶æ€ï¼Œä½¿å˜é‡èµ‹å€¼ã€‚ç¬¬6è¡Œåˆ™ä¼šé€šçŸ¥æ‰€æœ‰çš„Fragmentè¿›è¡ŒonCreate()ã€‚æ³¨æ„restoreAllStateè¿™ä¸ªå‡½æ•°ç¬¬äºŒä¸ªå‚æ•°çš„åˆ¤æ–­ï¼Œæ¢å¤Fragmentå‘ç”Ÿåœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼š1)Configå˜åŒ–ï¼Œæœ€ç»å…¸æ˜¯å±å¹•æ—‹è½¬ï¼›2)saveInstanceStateå‘ç”Ÿçš„æ—¶å€™ã€‚å¦‚æœæ˜¯å‰è€…å°±å¯ä»¥ä»mLastNonConfigurationInstancesä¸­æ‹¿å‡ºä¿å­˜çš„fragmentså¯¹è±¡ï¼Œå¦åˆ™å°±æ˜¯nullï¼›</p>
<ol>
<li>Fragmentæ¢å¤ä¹‹åå¹¶ä¸ä¼šæ›¿ä»£ä½ æ–°å»ºçš„Fragmentï¼Œå³ï¼šå¦‚æœä½ åœ¨containeré‡Œé¢åŠ å…¥äº†FragmentAï¼Œä¹‹åè¿™ä¸ªFragmentAå®ä¾‹è¢«æ¢å¤é‡å»ºï¼Œè€Œä½ åœ¨Activityçš„onCreateæ–¹æ³•ä¸­æ²¡æœ‰åšä»»ä½•æ£€æµ‹å†æ¬¡æ–°å»ºFragmentAçš„å®ä¾‹å¹¶æ·»åŠ è¿›å…¥containerï¼Œåˆ™ä¼šå¯¼è‡´containeræœ‰ä¸¤ä¸ªFragmentAçš„å®ä¾‹;</li>
</ol>
<h2 id="Fragmentåˆ°åº•æ˜¯å•¥"><a href="#Fragmentåˆ°åº•æ˜¯å•¥" class="headerlink" title="Fragmentåˆ°åº•æ˜¯å•¥"></a>Fragmentåˆ°åº•æ˜¯å•¥</h2><p>è¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦çœ‹FragmentManagerä¸­moveToStateæ–¹æ³•çš„ä¸‹åˆ—ä»£ç ç‰‡æ®µï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">f.mView = f.performCreateView(f.getLayoutInflater(f.mSavedFragmentState), container, f.mSavedFragmentState);</span><br><span class="line"><span class="keyword">if</span> (f.mView != <span class="keyword">null</span>) &#123;</span><br><span class="line">	f.mInnerView = f.mView;</span><br><span class="line">	f.mView = NoSaveStateFrameLayout.wrap(f.mView);</span><br><span class="line">	<span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</span><br><span class="line">		Animation anim = loadAnimation(f, transit, <span class="keyword">true</span>, transitionStyle);</span><br><span class="line">		<span class="keyword">if</span> (anim != <span class="keyword">null</span>) &#123;</span><br><span class="line">			f.mView.startAnimation(anim);</span><br><span class="line">		&#125;</span><br><span class="line">		container.addView(f.mView);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (f.mHidden) </span><br><span class="line">		f.mView.setVisibility(View.GONE);</span><br><span class="line">	f.onViewCreated(f.mView, f.mSavedFragmentState);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	f.mInnerView = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç¬¬1è¡Œå°±æ˜¯å›è°ƒFragmentçš„onCreateViewæ–¹æ³•ï¼Œæ‰€ä»¥f.mViewå°±æ˜¯æˆ‘ä»¬åœ¨onCreateViewä¸­è¿”å›çš„Viewï¼Œè€Œç¬¬10è¡Œåˆ™å°†f.mViewæ·»åŠ åˆ°containerä¸­å»ã€‚ç¬¬14è¡Œå›è°ƒFragmentçš„onViewCreatedæ–¹æ³•ã€‚åˆ°è¿™é‡Œå°±å¾ˆæ¸…æ¥šï¼šFragmentå°±æ˜¯ä¸€ä¸ªåŒ…è£…äº†ç”Ÿå‘½å‘¨æœŸçš„Viewï¼ŒçœŸæ­£æ˜¾ç¤ºçš„æœºåˆ¶è¿‡ç¨‹å’ŒViewä¸€è‡´ã€‚è¯»è€…è¿˜å¯ä»¥é€šè¿‡FragmentManager.hideFragmentæ–¹æ³•éªŒè¯ä¸€ä¸‹è¿™ä¸ªç»“è®ºã€‚</p>
<h2 id="Fragmentçš„ä½¿ç”¨æ³¨æ„äº‹é¡¹"><a href="#Fragmentçš„ä½¿ç”¨æ³¨æ„äº‹é¡¹" class="headerlink" title="Fragmentçš„ä½¿ç”¨æ³¨æ„äº‹é¡¹"></a>Fragmentçš„ä½¿ç”¨æ³¨æ„äº‹é¡¹</h2><p>Fragmentåªæ˜¯ä¸€ä¸ªå¸¦æœ‰ç”Ÿå‘½å‘¨æœŸçš„Viewã€‚å†™ä»£ç çš„æ—¶å€™é¦–å…ˆéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼š<br>å¾€Containerä¸­æ·»åŠ Fragmentçš„æ—¶å€™ï¼Œéœ€è¦å»æ£€æµ‹è¯¥Fragmentæ˜¯å¦å­˜åœ¨ï¼Œæ–¹æ³•æ˜¯getFragmentByIdå’ŒgetFragmentByTagï¼Œå¦åˆ™åœ¨æ•°æ®æ¢å¤çš„æ—¶å€™ï¼Œå°±ä¼šé€ æˆå¤šä¸ªç›¸åŒçš„Fragmentè¢«åˆ›å»ºã€‚</p>
<p>å…¶æ¬¡ï¼Œè¯»è€…å¯ä»¥æ³¨æ„ä¸€ä¸‹FragmentStateè¿™ä¸ªç±»ï¼ˆç”¨äºä¿å­˜Fragmentçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä»¥åŠé‡è¦å‚æ•°ï¼Œæ¯”å¦‚mIndexï¼ŒmFragmentIdï¼ŒmContainerIdï¼ŒmClassNameç­‰ï¼‰ï¼Œè¿™ä¸ªç±»é‡Œé¢è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼šmArgumentsã€‚è¿™ä¸ªå°±æ˜¯è®¾ç½®Fragmentå‚æ•°æ ‡å‡†åšæ³•æ—¶æ‰€ç”¨åˆ°çš„ï¼Œè¯·è§<a href="http://developer.android.com/reference/android/app/Fragment.html" target="_blank" rel="noopener">Developers</a>ä¸Šçš„æ ‡å‡†å†™æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DetailsFragment <span class="title">newInstance</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">	DetailsFragment f = <span class="keyword">new</span> DetailsFragment();</span><br><span class="line">	<span class="comment">// Supply index input as an argument.</span></span><br><span class="line">	Bundle args = <span class="keyword">new</span> Bundle();</span><br><span class="line">	args.putInt(<span class="string">"index"</span>, index);</span><br><span class="line">	f.setArguments(args);</span><br><span class="line">	<span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Ÿæˆ–è€…è¯´ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™æ˜¯æ ‡å‡†çš„ï¼Ÿå› ä¸ºé€šè¿‡Fragment.setArgumentsæ–¹æ³•è®¾ç½®çš„bundleå‚æ•°åœ¨æ•°æ®ä¿å­˜çš„æ—¶å€™æ˜¯ä¼šè¢«ä¿å­˜ä¸‹æ¥çš„ï¼Œæ¢å¤ä¹‹åè¿˜èƒ½è·å–ã€‚è€Œæ™®é€šçš„å¸¦å‚æ„é€ å‡½æ•°å¹¶ä¸èƒ½åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€è¿‘å¼€å‘çš„æ—¶å€™å’ŒåŒäº‹é‡åˆ°ä¸å°‘Fragmentçš„ç›¸å…³é—®é¢˜ï¼Œå› æ­¤ç¨å¾®åšäº†ä¸€ä¸‹ç ”ç©¶ã€‚Fragmenté‡Œé¢è¿˜æœ‰å¾ˆå¤šä¸œè¥¿æ²¡æœ‰ä»”ç»†å‚ç ”ï¼Œåé¢æœ‰æ—¶é—´ä¼šè¿›ä¸€æ­¥æŒ–æ˜ã€‚ä¸‹ä¸€ç¯‡åšå®¢ä¼šä»¥FragmentStatePagerAdapterä¸ºä¸»é¢˜ï¼Œå› ä¸ºåœ¨è¿™ä¸ªä¸Šé¢ä¹Ÿé‡åˆ°å¾ˆå‘çš„é—®é¢˜ã€‚<br>ä»¥ä¸Šã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è§‚å½±ã€Šçƒˆæ—¥ç¼å¿ƒã€‹]]></title>
      <url>http://www.timebridge.space/2015/10/17/lie-ri-zhuo-xin/</url>
      <content type="html"><![CDATA[<p>å…¬å¸ä¸€æ–‡è‰ºé’å¹´å¾®ä¿¡ä¸ŠåŠ›è<a href="http://movie.douban.com/subject/24719063/?source=new_aladdin" target="_blank" rel="noopener">ã€Šçƒˆæ—¥ç¼å¿ƒã€‹</a>ï¼ŒçŒ«çœ¼è¯„åˆ†8.0ï¼Œè±†ç“£è¯„åˆ†8.0ï¼Œå‘¨æœ«æ— èŠï¼Œé—²æ¥å»çœ‹ã€‚</p>
<p>æ•…äº‹è®²è¿°çš„æ˜¯ä¸‰ä¸ªå¹´è½»äººï¼Œâ€œæ€å®³â€äº†ä¸€å®¶äº”å£ï¼Œåœ¨å¤–èº²é¿ä¸ƒå¹´ã€‚ä¸ƒå¹´é—´ä¸€ä¸ªæˆäº†æ¸”åœºçš„å·¥äººï¼ˆé™ˆæ¯”è§‰ï¼‰ï¼Œä¸€ä¸ªæˆäº†å‡ºç§Ÿè½¦å¸æœºï¼ˆæ¨è‡ªé“ï¼‰ï¼Œä¸€ä¸ªåˆ™æˆäº†åè­¦ï¼ˆå°ä¸°ï¼‰ã€‚åæ¥è­¦å±€æ¥äº†æ–°çš„è­¦é•¿ï¼ˆä¼Šï¼‰ï¼Œåœ¨æ‰§å‹¤ä¸­é€æ¸å’Œå°ä¸°èµ°è¿‘ï¼Œä¼Šåˆšå‡ºé“ç”±å¸ˆå‚…å¸¦é¢†åŠç†çš„ç¬¬ä¸€å®—æ¡ˆä»¶å°±æ˜¯è¿™èµ·ç­é—¨æ¡ˆï¼Œä¸ƒå¹´æœªç ´ï¼Œåœ¨æ¥è§¦ä¸­ï¼Œä¼Šé€æ¸å‘ç°çº¿ç´¢ï¼Œæ€€ç–‘èµ·å°ä¸°ï¼Œå°ä¸°äº¦æœ‰æ‰€è­¦è§‰ï¼Œä¸‰å…„å¼Ÿå•†é‡ä¹‹åæ‰“ç®—å…ˆè·‘è·¯ï¼Œä½†ä»–ä»¬â€œé¢†å…»â€çš„å¼ƒå©´å°¾å·´ï¼ˆå°¾å·´å…¶å®æ˜¯è¢«æ€å¥³å­©çš„å¥³å„¿ï¼‰æ­¤æ—¶å´éœ€è¦åšæ‰‹æœ¯ï¼Œé€¼ä¸å¾—å·²ä¸‰äººç•™ä¸‹æ¥å‡‘é’±ã€‚<a id="more"></a>å°ä¸°åœ¨ä¼Šåˆšæ¥çš„æ—¶å€™å°±æ•é”çš„å¯Ÿè§‰åˆ°ä¸å®‰ï¼Œå› æ­¤æ¬å‡ºäº†è­¦å±€çš„å®¿èˆï¼Œç„¶ç§Ÿæˆ¿çš„æˆ¿ä¸œæ˜¯ä¸ªBTï¼Œåœ¨æˆ¿å†…è£…äº†çªƒå¬å™¨ï¼Œå°ä¸°æ¯æ¬¡å’Œæ¨è‡ªé“çš„è°ˆè¯éƒ½è¢«çªƒå¬å¹¶è¢«è®°å½•ã€‚é‡Œé¢è¿˜æœ‰ä¸€ä¸ªæ’æ›²ï¼Œå°±æ˜¯ä¼Šçš„å¦¹å¦¹åœ¨ä¸€èµ·æŠ¢åŠ«ä¸­æ„å¤–ç»“è¯†äº†æ¨è‡ªé“ï¼Œæ¨è‡ªé“ä¸ºæŠ“æ•æŠ¢åŠ«çŠ¯è¢«ç äº†ä¸€åˆ€ï¼Œè‡ªæ­¤ä¼Šçš„å¦¹å¦¹å°±å–œæ¬¢ä¸Šäº†æ¨è‡ªé“ã€‚å°ä¸°ä¸ºæ´—è„±è‡ªå·±çš„å«Œç–‘ï¼Œä¼ªè£…æˆGayï¼Œå¹¶æŠŠä¸‰å…„å¼Ÿä¹Ÿæè¿°æˆGayï¼Œä¼Šå¦¹å¦¹å¾—çŸ¥æ­¤äº‹åæ€¥äºæ±‚è¯ï¼Œå¹¶æ„å¤–å¾—çŸ¥ç­é—¨æ¡ˆçš„çœŸç›¸ï¼Œåæ‰“ç®—å»æ‰¾æ¨è‡ªé“ï¼ˆç§å¥”ï¼Ÿï¼‰ï¼Œä¼Šè·Ÿéšå¦¹å¦¹æ¥åˆ°ä»–ä»¬çš„å‡ºç§Ÿå±‹ï¼Œæ„å¤–å‘ç°çªƒå¬å™¨å’Œç¬”è®°æœ¬ï¼Œå¹¶å¾—çŸ¥æ•´ä¸ªäº‹æƒ…çš„çœŸç›¸ã€‚åœ¨éšåä¸€æ¬¡æŠ“æ•é€šç¼‰çŠ¯çš„è¿‡ç¨‹ä¸­ï¼Œä¼Šåœ¨ç”Ÿæ­»å…³å¤´åŠå°ä¸°å»è‡ªé¦–ï¼Œä¹‹åå°ä¸°å’Œæ¨è‡ªé“è¢«æŠ“ï¼Œå¹¶å°†å°¾å·´æ‰˜ä»˜ç»™ä¼Šå’Œå…¶å¦¹å¦¹ã€‚å°ä¸°å’Œæ¨è‡ªé“è¢«å®‰ä¹æ­»ï¼Œé™ˆæ¯”è§‰é€ƒè„±ã€‚ä½†äº‹æƒ…çœŸç›¸å´ä¸æ˜¯å¦‚æ­¤ï¼ŒéšåæŠ“æ•çš„ä¸€ä¸ªæ€äººçŠ¯æ‰¿è®¤å½“æ—¶ç­é—¨æ¡ˆä»¶ä¸­ï¼Œä»–æ€å®³äº†æ­»äººï¼Œä»–ä»¬ä¸‰äººåªæ€å®³äº†é‚£ä¸ªå¥³çš„ã€‚æœ€åçš„ç»“å°¾ä»¥é™ˆæ¯”è§‰è·³æµ·è‡ªå°½ç»“æŸã€‚<br><!-- more --><br>æ–‡å­—æè¿°æ€»æ˜¯è‹ç™½çš„ï¼Œè¿™éƒ¨ç”µå½±è¡¨é¢å¹³æ·¡ï¼Œæ—¢æ²¡æœ‰æƒŠå¿ƒåŠ¨é­„çš„çº¿ç´¢åˆ†æï¼Œä¹Ÿæ²¡è§è¡€è…¥çš„æªæˆ˜ç”»é¢ï¼Œä½†å†…åœ¨æ³¢æ¶›æ±¹æ¶Œï¼Œçœ‹çš„è¿‡ç¨‹ä¸­æ€»æ˜¯ä¸ç”±è‡ªä¸»çš„æƒ³èµ·ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹ã€‚</p>
<p>ç”µå½±çš„ä¸»é¢˜æ˜¯å°ä¸°è¯´è¿‡çš„ä¸€å¥è¯ï¼šä¸–ç•Œä¸Šæ²¡æœ‰ä»€ä¹ˆåäººï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½äººã€‚è¿™ä¸‰ä¸ªäººçŠ¯äº†åæ¶ä¸èµ¦çš„ç½ªè¡Œï¼Œä¹Ÿæ˜¯åˆ«äººçœ¼ä¸­çš„å¥½äººï¼Œä»–ä»¬ç©¶ç«Ÿæ˜¯å¥½æ˜¯åï¼Œä¸€æ—¶ä¹‹é—´éš¾ä»¥å†³æ–­ã€‚</p>
<p>æ•…äº‹ä¸€å¼€å§‹è¿™ä¸‰ä¸ªå¹´è½»äººå°±èƒŒè´Ÿç€â€œè°‹æ€â€çš„ç½ªæ¶ï¼Œé™ˆæ¯”è§‰åœ¨é€ƒè·‘ä¸­è¿˜ä¸å¹¸åˆºçäº†è‡ªå·±çš„å³çœ¼ï¼Œä¸ƒå¹´åçš„å½¢è±¡æ›´æ˜¯ä¸€ä¸ªå‚»å­ï¼Œæœ‰ä¸€ç§æ¶æœ‰æ¶æŠ¥çš„æš—ç¤ºåœ¨å…¶ä¸­ï¼Œä½†æ˜¯æ•…äº‹çš„ä¸»ä½“éƒ¨åˆ†å´åœ¨ä¸ç´§ä¸æ…¢çš„å™è¿°è¿™ä¸‰ä¸ªäººçš„å–„è‰¯ï¼šå°ä¸°åšäº†åè­¦ï¼Œåœ¨æ‰§å‹¤çš„è¿‡ç¨‹ä¸­éå¸¸çš„æ•é”ï¼Œä¹Ÿéå¸¸å‹‡æ•¢ï¼Œå°½èŒå°½è´£ï¼Œä¼Šä¸€ç›´å¾ˆçœ‹ä¸­ä»–ï¼Œä¸é¡¾è·¯é€”é¥è¿œï¼Œå®šæœŸå»çœ‹å°¾å·´ï¼›æ¨è‡ªé“åœ¨å¼€è½¦çš„æ—¶å€™é‡åˆ°äº†åŠ«åŒªï¼Œé¢å¯¹è­¦å¯Ÿçš„ç›˜é—®ï¼Œä»–æ”¾èµ°äº†ä¸‰ä¸ªåŠ«åŒªï¼Œ4000å…ƒç°é‡‘ä¹Ÿè¢«å¸¦èµ°äº†ï¼Œè€Œåœ¨ä¹°çƒŸè·¯ä¸Šé‡åˆ°åŠ«åŒªåˆ™å¥‹ä¸é¡¾èº«ï¼Œå¼€è½¦ç›´è¿½ï¼Œæœ€åè¢«ç ä¸€åˆ€ï¼›é™ˆæ¯”è§‰ä¸€ç›´åœ¨æ¸”åœºç»†å¿ƒç…§çœ‹å°¾å·´ï¼Œåœ¨åŒ»é™¢ç…§é¡¾å¥¹ã€‚ä¸€é¢æ˜¯ä¼Šä¸æ–­çš„å‘ç°çº¿ç´¢ï¼Œè°‹æ€çš„ç½ªåå§‹ç»ˆç¼­ç»•åœ¨å‰§æƒ…ä¸­ï¼Œä¸€é¢æ˜¯ä¸‰ä¸ªäººç®€ç®€å•å•ï¼Œå–„è‰¯çš„æ—¥å¸¸ç”Ÿæ´»ï¼Œæœ€åå‡åæ˜¯åœ¨å°ä¸°è¢«æŠ“å‰ï¼š</p>
<blockquote>
<p>ä¼Šé—®å°ä¸°:ä¸ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šåšé‚£ç§äº‹ï¼Ÿå°ä¸°å›ç­”:æˆ‘ä¹Ÿæƒ³è¿‡ã€‚</p>
</blockquote>
<p>ä¸€ç§æ·¡ç„¶ï¼Œä¸€ç§æ— å¥ˆã€‚å…¶å®ä»–ä»¬ä¹Ÿä¸çŸ¥é“è‡ªå·±çš„äººç”Ÿæ€ä¹ˆå°±å˜æˆäº†è¿™æ ·ï¼Œä¸‰ä¸ªäººç¡®å®ç»å†äº†é‚£åœºè°‹æ€æ¡ˆï¼Œå¹¶å®³æ­»äº†ä¸€ä¸ªå¥³å­©ï¼Œä½†è‡ªæ­¤åçš„ä¸ƒå¹´ä»–ä»¬å®ˆç€å°¾å·´ï¼Œæ‚‰å¿ƒç…§æ–™ï¼Œå¦‚æœä¸æ˜¯ä¼Šå‡ºç°ï¼Œä»–ä»¬ä¸‰äººè¿˜æ˜¯ä¼šç»§ç»­è¿™æ ·ç”Ÿæ´»ä¸‹å»ï¼Œç„¶ä¼Šçš„å‡ºç°å’ŒBTæˆ¿ä¸œå´æ˜­ç¤ºç€å¤©ç½‘æ¢æ¢ç–è€Œä¸æ¼ï¼Œæœ€ç»ˆè¿™çº¸è¿˜æ˜¯åŒ…ä¸ä½ç«ï¼Œä¸‰äººåœ¨æœ€åéƒ½é€‰æ‹©äº†ä»¥æ­»äº¡çš„ä»£ä»·ä¸ºå°¾å·´åˆ›é€ ä¸€ä¸ªè½»æ¾çš„æœªæ¥ã€‚</p>
<p>ç”µå½±è¿˜æœ‰ä¸€ä¸ªä¸æ˜æ˜¾çš„ä¸»é¢˜ï¼Œä½†è¿™ä¸ªä¸»é¢˜å´æ›´åŠ æœ‰åŠ›ï¼šäººç”Ÿçš„é€‰æ‹©ã€‚å°ä¸°åœ¨é€ƒè·‘åé€‰æ‹©å›å»æŠ±å›å¥³å©´ï¼Œä¸‰äººåœ¨ä¸ƒå¹´ä¸­é€‰æ‹©é»˜é»˜åšå®ˆå°¾å·´ï¼Œå¹¶åœ¨å¾—çŸ¥å°¾å·´éœ€è¦æ‰‹æœ¯æ—¶æ”¾å¼ƒé€ƒè·‘çš„æœ€ä½³æ—¶æœºï¼Œä¼Šé€‰æ‹©åœ¨çŸ¥æ™“ä¸‹å±çŸ¥æ³•çŠ¯æ³•çš„æ—¶å€™â€œåŒ…åº‡â€ï¼Œæ¨è‡ªé“å’Œå°ä¸°åœ¨æœ€åé€‰æ‹©è‡ªé¦–å¹¶è®¤ç½ªä»¥ç»™å°¾å·´ä¸€ä¸ªè½»æ¾çš„æœªæ¥ï¼Œé™ˆæ¯”è§‰æœ€åè¿˜æ˜¯é€‰æ‹©è·³å´–è‡ªå°½ã€‚å¦‚æœè¯´ä¸‰ä¸ªäººåœ¨ä¸€å¼€å§‹é€‰æ‹©æ€å®³å¥³å­©æ˜¯é”™çš„ï¼Œé‚£ä»–ä»¬ä¹‹åçš„é€‰æ‹©éƒ½æ˜¯å¯¹çš„ï¼Œä¹Ÿæ­£å› ä¸ºè¿™äº›é€‰æ‹©ï¼Œä»–ä»¬å±•ç°å‡ºå–„è‰¯çš„ä¸€é¢ã€‚åœ¨å°ä¸°è¢«æŠ“ä¹‹åï¼Œä¼Šå»ç›‘ç‹±çœ‹æœ›ä»–ï¼Œå°ä¸°è¯´ï¼šæˆ‘ç°åœ¨å¯ä»¥è¯´è‡ªå·±æ˜¯ä¸€ä¸ªå¥½çˆ¸çˆ¸äº†ã€‚å°¾å·´æ˜¯ä»–ä»¬çš„ç½ªæ¶ï¼Œä¹Ÿæ˜¯ä»–ä»¬çš„å–„è‰¯ï¼Œå¥½çˆ¸çˆ¸ä¸ä»…æ˜¯å¥½çˆ¸çˆ¸ï¼Œä¹Ÿæ˜¯ä»–ä»¬çƒˆç«ç¼å¿ƒã€è‡ªæˆ‘æ•‘èµåçš„é‡æ–°åšäººã€‚</p>
<p>ç”µå½±ç»“å°¾æ¯”è¾ƒæœ‰æ„æ€ï¼Œåœ¨ä»–ä»¬å®‰ä¹æ­»ä¹‹åï¼Œå‰§æƒ…é™¡ç„¶ä¸€è½¬ï¼Œå‡ºç°äº†çœŸæ­£çš„å‡¶æ‰‹ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ç¼–å‰§æƒ³å‘Šè¯‰è§‚ä¼—ï¼šå–„è‰¯ä¸”æ‚”è¿‡çš„äººä¸è¯¥æ­»ã€‚</p>
<p>è™½ç„¶åœ¨è§‚å½±ä¸­ä¸€ç›´æƒ³èµ·ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹ï¼Œä½†å°±åƒå›½äººå’Œå¤–å›½äººç¼–å†™çš„æŠ€æœ¯ä¹¦å¯¹æ¯”èµ·æ¥ä¸€æ ·ï¼Œä¸€ä¸ªæ¸…æ™°å†…æ•›ï¼Œè¯»èµ·æ¥è½»æ¾ï¼Œä¸€ä¸ªç›¸å¯¹è€Œè¨€æ‚ä¹±è´ªå¤šï¼Œè¯»èµ·æ¥ä¼¼æœ‰æ‰€æ‚Ÿå´æ‘¸ä¸æ¸…æŠ“ä¸ç€ã€‚å°½ç®¡å¦‚æ­¤ï¼Œç¡®å®ä¸å¤±ä¸ºä¸€éƒ¨å¥½ç”µå½±ã€‚</p>
<blockquote>
<p>PS1:ç‹çä¸¹çš„å½¢è±¡æ€ä¹ˆæ€»æ˜¯ç•¥ç–¯ç™«çš„â€¦.<br>PS2:ç§Ÿæˆ¿å­æˆ¿ä¸œè¿˜æ˜¯å¾ˆé‡è¦çš„<br>PS3:ä»¥å‰å¬ä¾¯æ·è€å¸ˆè®²è¯¾ï¼Œè§‰å¾—å°æ¹¾è…”å¾ˆå¥½å¬ï¼Œè¿™éƒ¨å‰§é‡Œé¢æ€ä¹ˆå°±è§‰å¾—å°æ¹¾è…”è¿™ä¹ˆæ¶å¿ƒï¼Ÿéš¾é“æ˜¯å› ä¸ºGayå¯¼è‡´å°æ¹¾è…”å¬ä¸Šå»å¨˜å¨˜è…”ï¼Ÿ<br>PS4:é‚“è¶…ç¡®å®æ˜¯å®åŠ›æ´¾ï¼Œæ¼”æŠ€æ æ çš„ï¼Œèµä¸€ä¸ª</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Markdownå¸¸ç”¨è¯­æ³•]]></title>
      <url>http://www.timebridge.space/2015/10/17/Markdown-chang-yong-yu-fa/</url>
      <content type="html"><![CDATA[<p>Markdownæ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼Œå¯ä»¥æ–¹ä¾¿çš„è½¬åŒ–ä¸ºHTMLï¼Œæ¯”å¦‚æœ¬æ–‡å°±æ˜¯ä»¥Markdownç¼–å†™ï¼Œæœ€ç»ˆè½¬åŒ–ä¸ºç½‘é¡µå±•ç°åœ¨è¯»è€…é¢å‰ã€‚è¿™ç§æ ‡è®°è¯­è¨€ç›¸å¯¹äºHTMLæ¥è¯´åŠŸèƒ½æœ‰é™ï¼Œä½†æ˜¯å¯¹äºä¸“å¿ƒå†™æ–‡ç« çš„äººæ¥è¯´ï¼Œå´éå¸¸è¶³å¤Ÿ(Markdownå…¼å®¹HTML)ã€‚ç›®å‰Githubï¼ŒStackOverFlowä»¥åŠå¾ˆå¤šçš„åšå®¢ç½‘ç«™ã€é™æ€åšå®¢ç³»ç»Ÿï¼ˆOctopress, Hexoâ€¦ï¼‰éƒ½æ”¯æŒMarkdownè¯­è¨€ï¼Œå› æ­¤å¯¹äºæœ‰å…´è¶£çš„è¯»è€…æ¥è¯´ï¼Œå­¦ä¹ markdownä¸ä»…æˆæœ¬å°ï¼Œè€Œä¸”å®ç”¨æ€§å¾ˆå¤§ã€‚<a id="more"></a></p>
<p>æœ¬æ–‡ä¸»è¦æ˜¯æ˜¯æ•´ç†ä¸€äº›æˆ‘å¸¸ç”¨åˆ°çš„ä¸”ä¸å®¹æ˜“è®°ä½çš„Markdownè¯­æ³•ã€‚è¿™é‡Œå…ˆæ¨èä¸€ä¸ªMacä¸‹çš„Markdownå†™ä½œå·¥å…·ï¼šMouã€‚è€Œæœ¬æ–‡åˆ™æ˜¯åœ¨å¦å¤–ä¸€ä¸ªç¼–è¾‘å™¨â€MacDownâ€ä¸‹ç¼–å†™å®Œæˆï¼ŒMacDownåŸºäºMouï¼Œä¸¤ä¸ªæˆ‘éƒ½ç”¨è¿‡ï¼Œéƒ½æŒºä¸é”™ã€‚Windowsä¸‹ä¹Ÿæœ‰ç›¸åº”çš„ç¼–è¾‘å™¨ï¼Œè¯»è€…å¯ä»¥å®‰è£…ä¸€æšã€‚</p>
<p>ä¸‹é¢å†…å®¹éšæ—¶æ›´æ–°ã€‚</p>
<p>###åˆ—è¡¨<br>æ— é¡»åˆ—è¡¨å‰é¢åŠ ä¸Š*ï¼Œ+ï¼Œ-éƒ½å¯ä»¥è¡¨ç¤ºï¼Œæ¯”å¦‚ï¼š</p>
<pre><code>*  AAAA
*  BBBB
*  CCCC
</code></pre><p>å±•ç¤ºå‡ºæ¥å¦‚ä¸‹ï¼š</p>
<ul>
<li>AAAA</li>
<li>BBBB</li>
<li>CCCC</li>
</ul>
<p>æœ‰åºåˆ—è¡¨åˆ™ç›´æ¥ä»¥æ•°å­—è¡¨ç¤ºï¼š  </p>
<pre><code>*  AAAA
*  BBBB
*  CCCC
</code></pre><p>å±•ç¤ºå‡ºæ¥å¦‚ä¸‹ï¼š</p>
<ol>
<li>AAAA</li>
<li>BBBB</li>
<li>CCCC</li>
</ol>
<p>ä½†æ˜¯æ³¨æ„ï¼šåˆ—è¡¨å’Œå‰é¢æ–‡æ®µä¹‹é—´éœ€è¦åŠ ä¸Šä¸€ä¸ªç©ºè¡Œï¼Œå¦åˆ™Mackdownè¯­æ³•ä¸èƒ½è¯†åˆ«ã€‚</p>
<p>###åˆ†å‰²çº¿<br>å¯ä»¥è¿™æ ·å†™ï¼ˆè¿˜æœ‰åˆ«çš„è¯­æ³•ï¼Œä½†æ˜¯å­¦ä¼šä¸€ç§å°±å¤Ÿå•¦ï¼‰ï¼š  </p>
<pre><code>***
</code></pre><p> å±•ç¤ºå‡ºæ¥å¦‚ä¸‹:</p>
<hr>
<p>###ä»£ç <br>ä»£ç å—æœ‰ä¸¤ç§å†™æ³•:<br>1ï¼‰é€‰ä¸­ä»£ç å—ï¼ŒæŒ‰Tabé”®ï¼Œå¦‚ä¸‹:</p>
<pre><code>AAA
BBB
</code></pre><p>å±•ç¤ºå‡ºæ¥å¦‚ä¸‹:</p>
<pre><code>AAA
BBB
</code></pre><p>è¿˜æœ‰ä¸€ç§å°±æ˜¯å¦‚ä¸‹å†™:  </p>
<pre><code>â€‹<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">main</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">â€‹</span><br></pre></td></tr></table></figure>
</code></pre><p>æ•ˆæœåˆ™æ˜¯è¿™æ ·çš„:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">main</span><span class="params">()</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>###å›¾ç‰‡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![å°é¢](http://7xktd8.com1.z0.glb.clouddn.com/cover.png)</span><br></pre></td></tr></table></figure></p>
<p>å®é™…æ•ˆæœå°±æ˜¯:<br><img src="http://7xktd8.com1.z0.glb.clouddn.com/cover.png" alt="å°é¢"></p>
<p>###é“¾æ¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[æœ¨å­æçš„åšå®¢](http://www.muzileecoding.com/)</span><br></pre></td></tr></table></figure></p>
<p>å®é™…æ•ˆæœæ˜¯:<br><a href="http://www.muzileecoding.com/" target="_blank" rel="noopener">æœ¨å­æçš„åšå®¢</a></p>
<p>###è¡¨æ ¼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|æ–‡ç«  | ä½œè€… |</span><br><span class="line">|:---|:--- |</span><br><span class="line">|Markdownå¸¸ç”¨è¯­æ³•|æœ¨å­æ|</span><br></pre></td></tr></table></figure></p>
<p>å®é™…æ•ˆæœæ˜¯:</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ–‡ç« </th>
<th style="text-align:left">ä½œè€…</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Markdownå¸¸ç”¨è¯­æ³•</td>
<td style="text-align:left">æœ¨å­æ</td>
</tr>
</tbody>
</table>
]]></content>
    </entry>
    
  
  
</search>
